

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "#GTMTips: Build A Custom Universal Analytics Client For Server-side Tagging | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/07\/custom-universal-analytics-client.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/gtm-tips\/build-custom-universal-analytics-client-server-side-tagging\/",
  "datePublished": "2020-08-12T07:03:00\u002b03:00",
  "dateModified": "2020-08-12T07:03:00\u002b03:00",
  "description": "Build a new Universal Analytics Client to be used with Google Tag Manager\u0027s Server container. The Client sends the request to Google and rewrites the _ga cookie in a Set-Cookie response header.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>#GTMTips: Build A Custom Universal Analytics Client For Server-side Tagging | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
    
    <meta name="description" content="Build a new Universal Analytics Client to be used with Google Tag Manager&#39;s Server container. The Client sends the request to Google and rewrites the _ga cookie in a Set-Cookie response header.">
    <meta property="og:description" content="Build a new Universal Analytics Client to be used with Google Tag Manager&#39;s Server container. The Client sends the request to Google and rewrites the _ga cookie in a Set-Cookie response header.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="#GTMTips: Build A Custom Universal Analytics Client For Server-side Tagging">
    <meta property="og:url" content="https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="#GTMTips: Build A Custom Universal Analytics Client For Server-side Tagging">
    <meta name="twitter:description" content="Build a new Universal Analytics Client to be used with Google Tag Manager&#39;s Server container. The Client sends the request to Google and rewrites the _ga cookie in a Set-Cookie response header.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/07/custom-universal-analytics-client.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/07/custom-universal-analytics-client.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      #GTMTips: Build A Custom Universal Analytics Client For Server-side Tagging
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-08-12T07:03:00&#43;03:00">
        
  August 12, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/gtm-tips">GTM Tips</a>
    
  


      | <a href="https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/#commento">Comments</a>
      
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>You can utilize <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/"><em>Server-side tagging</em></a> in <a href="https://tagmanager.google.com/">Google Tag Manager</a> to build your own custom Universal Analytics proxy.</p>
<p>This proxy comes in the shape of a new <strong>Client</strong> <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom template</a>, which takes the incoming <code>/collect</code> requests and sends them to Google Analytics. While doing so, it also returns the <code>_ga</code> cookie in a <code>Set-Cookie</code> header, thus preventing Safari&rsquo;s <a href="https://www.cookiestatus.com/safari/">Intelligent Tracking Prevention</a> from capping its expiration to just 7 days.</p>
<blockquote>
<p>You might also be interested in reading what <a href="https://www.simoahava.com/analytics/fpid-cookie-google-analytics-server-side-tagging/">Google&rsquo;s own solution</a> is for migrating from JavaScript cookies to those set in HTTP headers.</p>
</blockquote>
<p>I&rsquo;ve also created a video that is <em>similar</em> though a bit more advanced than this written tutorial.</p>
<blockquote>
<p><strong>NOTE!</strong> The video has one important omission. When creating the <strong>Client</strong> template, make sure to update the &ldquo;Sends HTTP Requests&rdquo; permission to include &ldquo;Allow Google Domains&rdquo;. Otherwise the proxying of analytics.js doesn&rsquo;t work.</p>
</blockquote>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/_c4JEfSkP6U?enablejsapi=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>If the video doesn&rsquo;t work, you can watch it <a href="https://youtu.be/_c4JEfSkP6U">here</a>.</p>
<h2 id="tip-117-build-a-universal-analytics-client">Tip 117: Build a Universal Analytics Client</h2>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/custom-universal-analytics-client.jpg" title="Custom Universal Analytics Client">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/custom-universal-analytics-client.jpg#ZgotmplZ" alt="Custom Universal Analytics Client">
  
    </a>
  
  
</div>


<p>To get things working, you need a couple of things:</p>
<ul>
<li>A fully functional <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">Server-side tagging</a> setup.</li>
<li>A Client running in the Server container (we&rsquo;ll build this now).</li>
<li>A Universal Analytics tag in the Server container (I&rsquo;ll instruct this as well).</li>
<li>Modifications to <em>all</em> the Universal Analytics tags firing in the web container (yes, I&rsquo;ll help with this as well).</li>
</ul>
<p>You will use <em>regular Universal Analytics tags</em> in the web container, but you&rsquo;ll set their <a href="https://www.simoahava.com/gtm-tips/send-google-analytics-requests-custom-endpoint/">Transport URL</a> field to point to your Server endpoint. These tags will only be used for sending the data to the Server container rather than directly to Google Analytics.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/transport-url-example.jpg" title="Transport URL example">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/transport-url-example.jpg#ZgotmplZ" alt="Transport URL example">
  
    </a>
  
  
</div>


<p>Next, <strong>all</strong> the Universal Analytics tags in the web container will need the following modification in their Fields to Set (using a <a href="https://www.simoahava.com/analytics/google-analytics-settings-variable-in-gtm/">Google Analytics Settings variable</a> is recommended).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/cookieupdate-field-false.jpg" title="cookieUpdate field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/cookieupdate-field-false.jpg#ZgotmplZ" alt="cookieUpdate field">
  
    </a>
  
  
</div>


<p>This field prevents the Universal Analytics JavaScript from refreshing the <code>_ga</code> cookie. You want to do this because the whole purpose of the <code>Set-Cookie</code> header we&rsquo;ll configure in the Server container is to prevent the web browser from setting the <code>_ga</code> cookie with JavaScript. All JavaScript-set cookies are prevented by Safari from having a longer expiration than 7 days.</p>
<blockquote>
<p>Remember, this field must be set in <strong>all</strong> Universal Analytics tags. Even a single tag without this will rewrite the cookie when it fires and thus will negate any benefit you derived from the custom Client.</p>
</blockquote>
<p>Finally, the proxy itself.</p>
<h3 id="build-the-client">Build the Client</h3>
<p>To build the proxy, you need a new <strong>Client template</strong>, built in the Server container. In the Server container UI, browse to <strong>Templates</strong> and click to create a new <strong>Client</strong> template.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/client-template-new.jpg" title="New Client Template">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/client-template-new.jpg#ZgotmplZ" alt="New Client Template">
  
    </a>
  
  
</div>


<p>In the first tab, give the template a name and a brief description. If you want, you can also add an icon image.</p>
<p>For this particular template, you can skip the <strong>Fields</strong> tab. We don&rsquo;t need the Client to support any customization.</p>
<p>In <strong>Code</strong>, copy-paste the following:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> claimRequest = require(<span style="color:#a50">&#39;claimRequest&#39;</span>);
<span style="color:#00a">const</span> extractEventsFromMpv1 = require(<span style="color:#a50">&#39;extractEventsFromMpv1&#39;</span>);
<span style="color:#00a">const</span> getCookie = require(<span style="color:#a50">&#39;getCookieValues&#39;</span>);
<span style="color:#00a">const</span> getRemoteAddress = require(<span style="color:#a50">&#39;getRemoteAddress&#39;</span>);
<span style="color:#00a">const</span> getRequestHeader = require(<span style="color:#a50">&#39;getRequestHeader&#39;</span>);
<span style="color:#00a">const</span> isRequestMpv1 = require(<span style="color:#a50">&#39;isRequestMpv1&#39;</span>);
<span style="color:#00a">const</span> returnResponse = require(<span style="color:#a50">&#39;returnResponse&#39;</span>);
<span style="color:#00a">const</span> runContainer = require(<span style="color:#a50">&#39;runContainer&#39;</span>);
<span style="color:#00a">const</span> setCookie = require(<span style="color:#a50">&#39;setCookie&#39;</span>);
<span style="color:#00a">const</span> setPixelResponse = require(<span style="color:#a50">&#39;setPixelResponse&#39;</span>);
<span style="color:#00a">const</span> setResponseHeader = require(<span style="color:#a50">&#39;setResponseHeader&#39;</span>);

<span style="color:#aaa;font-style:italic">// Get User-Agent and IP from incoming request
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> ua = getRequestHeader(<span style="color:#a50">&#39;user-agent&#39;</span>);
<span style="color:#00a">const</span> ip = getRemoteAddress();

<span style="color:#aaa;font-style:italic">// Check if request is Measurement Protocol
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">if</span> (isRequestMpv1()) {
  <span style="color:#aaa;font-style:italic">// Claim the request
</span><span style="color:#aaa;font-style:italic"></span>  claimRequest();
  
  <span style="color:#00a">const</span> events = extractEventsFromMpv1();
  <span style="color:#00a">const</span> max = events.length - <span style="color:#099">1</span>;
  events.forEach((event, i) =&gt; {
    <span style="color:#aaa;font-style:italic">// Unless the event had IP and user-agent overrides, manually
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// override them with the IP and user-agent from the request
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// That way the GA collect call will appear to have originated
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// from the user&#39;s browser / device.
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">if</span>(!event.ip_override &amp;&amp; ip) event.ip_override = ip;
    <span style="color:#00a">if</span>(!event.user_agent &amp;&amp; ua) event.user_agent = ua;
    
    <span style="color:#aaa;font-style:italic">// Pass the event to a virtual container
</span><span style="color:#aaa;font-style:italic"></span>    runContainer(event, () =&gt; {
      
      <span style="color:#00a">if</span> (i === max) {
        
        <span style="color:#aaa;font-style:italic">// Rewrite the _ga cookie to avoid Safari expiration.
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">const</span> ga = getCookie(<span style="color:#a50">&#39;_ga&#39;</span>);
        <span style="color:#00a">if</span> (ga &amp;&amp; ga.length) {
          setCookie(<span style="color:#a50">&#39;_ga&#39;</span>, ga[<span style="color:#099">0</span>], {
            domain: <span style="color:#a50">&#39;auto&#39;</span>,
            <span style="color:#a50">&#39;max-age&#39;</span>: <span style="color:#099">63072000</span>,
            path: <span style="color:#a50">&#39;/&#39;</span>,
            secure: <span style="color:#00a">true</span>,
            sameSite: <span style="color:#a50">&#39;lax&#39;</span>
          });
        }
        setPixelResponse();
        
        <span style="color:#aaa;font-style:italic">// Make sure no CORS errors pop up with the response
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">const</span> origin = getRequestHeader(<span style="color:#a50">&#39;Origin&#39;</span>);
		<span style="color:#00a">if</span> (origin) {
          setResponseHeader(<span style="color:#a50">&#39;Access-Control-Allow-Origin&#39;</span>, origin);
          setResponseHeader(<span style="color:#a50">&#39;Access-Control-Allow-Credentials&#39;</span>, <span style="color:#a50">&#39;true&#39;</span>);
        }
        returnResponse();
      }
    });
  });
}
</code></pre></div>
<p>Once the APIs have loaded, the Client pulls in the source&rsquo;s IP address and User-Agent string with this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="color:#00a">const</span> ua = getRequestHeader(<span style="color:#a50">&#39;user-agent&#39;</span>);
<span style="color:#00a">const</span> ip = getRemoteAddress();
</code></pre></div>
<p>Next, the <a href="https://developers.google.com/tag-manager/serverside/api#isrequestmpv1"><code>isRequestMpv1</code></a> API is utilized to automatically check if the incoming HTTP request is a Measurement Protocol (v1, i.e. Universal Analytics) request. If it is, then the Client <strong>claims</strong> the request, and thus prevents other Clients from processing it.</p>
<p>The rest of the Client is concerned with iterating through all the events in the request, parsing them automatically into the required event schema (using the <code>extractEventsFromMpv1</code> API), and running the container with all the events in the batch.</p>
<blockquote>
<p>Typically there will be just one event in each batch.</p>
</blockquote>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">if</span> (!event.ip_override &amp;&amp; ip) event.ip_override = ip;
<span style="color:#00a">if</span> (!event.user_agent &amp;&amp; ua) event.user_agent = ua;
</code></pre></div>
<p>The two lines of code above have a very important function. They take the <em>user&rsquo;s</em> IP address and User-Agent string and pass them to the event data object so that the Universal Analytics tag can then add them into the outgoing request to Google. If you didn&rsquo;t set these, the IP address and User-Agent string would be set to those of the Server container itself, which is not very useful.</p>
<p>Once all the events have been processed by the container, the following code block is run:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> ga = getCookie(<span style="color:#a50">&#39;_ga&#39;</span>);
<span style="color:#00a">if</span> (ga &amp;&amp; ga.length) {
  setCookie(<span style="color:#a50">&#39;_ga&#39;</span>, ga[<span style="color:#099">0</span>], {
    domain: <span style="color:#a50">&#39;auto&#39;</span>,
    <span style="color:#a50">&#39;max-age&#39;</span>: <span style="color:#099">63072000</span>,
    path: <span style="color:#a50">&#39;/&#39;</span>,
    secure: <span style="color:#00a">true</span>,
    sameSite: <span style="color:#a50">&#39;lax&#39;</span>
  });
}
</code></pre></div>
<p>This piece of code checks the incoming HTTP request for a cookie named <code>_ga</code>. If it finds one, it rewrites the cookie with a <code>Set-Cookie</code> header, thus converting it to an HTTP cookie and helping solve expiration issues with Safari&rsquo;s ITP.</p>
<p><code>setPixelResponse()</code> automatically configures the response back to the source of the request to resemble a 1x1 GIF image with cache-busting headers. Finally, <code>returnResponse()</code> is invoked to signal that the Client has completed its work and can respond back to the source of the initial request.</p>
<h3 id="set-the-permissions">Set the permissions</h3>
<p>While in the template editor, visit the <strong>Permissions</strong> tab.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/permissions-tab.jpg" title="Permissions tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/permissions-tab.jpg#ZgotmplZ" alt="Permissions tab">
  
    </a>
  
  
</div>


<p>Set the permissions as follows:</p>
<ul>
<li><strong>Accesses response</strong>: Any</li>
<li><strong>Reads cookie value(s)</strong>: <code>_ga</code></li>
<li><strong>Reads request</strong>: Any</li>
<li><strong>Sets a cookie</strong>: Set as in the image above.</li>
</ul>
<p>Once you&rsquo;re done with the permissions, you can <strong>Save</strong> the template and exit the template editor.</p>
<h3 id="create-the-client-trigger-and-tag">Create the Client, trigger, and tag</h3>
<p>Next, go to <strong>Clients</strong> and click the <strong>New</strong> button to create a new Client.</p>
<p>Choose your new Client template from the list of available Client types. Next, set the <strong>Priority</strong> field to a high value. It&rsquo;s important that this value is higher than <em>any other</em> Universal Analytics Client you might have in the container.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/new-client-settings.jpg" title="New client settings">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/new-client-settings.jpg#ZgotmplZ" alt="New client settings">
  
    </a>
  
  
</div>


<p>Give the Client a descriptive name (you&rsquo;ll need this shortly), and then <strong>save</strong> this Client.</p>
<p>Then, go to the <strong>Tags</strong> UI and click the <strong>New</strong> button to create a new Tag.</p>
<p>Choose <strong>Google Analytics: Universal Analytics</strong> as the tag type. There&rsquo;s no need to configure this tag in any way.</p>
<p>Under <strong>Triggers</strong>, click the trigger area to select a trigger.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/universal-analytics-tag.jpg" title="Universal Analytics">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/universal-analytics-tag.jpg#ZgotmplZ" alt="Universal Analytics">
  
    </a>
  
  
</div>


<p>In the overlay, click the blue <strong>+</strong> button in the top right corner to create a new trigger.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/trigger-configuration.jpg" title="Trigger configuration">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/trigger-configuration.jpg#ZgotmplZ" alt="Trigger configuration">
  
    </a>
  
  
</div>


<p>Set the trigger to look like the above. It just needs the single condition. The name you&rsquo;re checking against is the name you just gave the new Client.</p>
<blockquote>
<p>If you don&rsquo;t see <strong>Client Name</strong> in the list of available variables, it means you haven&rsquo;t enabled it as a <strong>Built-in variable</strong> yet. Select <strong>Choose Built-in Variable</strong> from the drop-down, and pick Client Name from the overlay that appears.</p>
</blockquote>
<p>Once done, save the trigger. Then, save the tag.</p>
<p>You now have the <strong>Client</strong>, the <strong>trigger</strong>, and the <strong>tag</strong>.</p>
<p>You are ready to test the whole setup!</p>
<h3 id="preview-and-test">Preview and test</h3>
<p>Click the <strong>Preview</strong> button in the Server container. A new tab should open with the Server container&rsquo;s <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/#preview-and-debug">Preview panel</a>.</p>
<p>In your <strong>web container</strong>, similarly click the <strong>Preview</strong> button.</p>
<p>Now you should have both your web container and the Server container in Preview mode.</p>
<p>Next, browse to your site and do something to fire one of the Universal Analytics tags you designed for server-side collection. Once the tag fires, check the Preview panel of your Server container. You should see something like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/page-view-in-preview.jpg" title="page_view in preview">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/page-view-in-preview.jpg#ZgotmplZ" alt="page_view in preview">
  
    </a>
  
  
</div>


<p>If you see it, and there are no errors in the Errors tab, it should work!</p>
<p>You can debug further by selecting the <strong>Universal Analytics</strong> tag itself and then clicking the <strong>Outgoing HTTP Requests</strong> box. This opens the details for the request to Google Analytics.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/outgoing-http-request.jpg" title="Outgoing HTTP request">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/outgoing-http-request.jpg#ZgotmplZ" alt="Outgoing HTTP request">
  
    </a>
  
  
</div>


<p>Check the Real Time report in your Google Analytics view (you <em>have</em> created a separate property for your Server-side tagging hits, right?), and make sure data is flowing in.</p>
<p>Finally, check the cookies in your browser. The <code>_ga</code> cookie should have the value of <strong>Secure</strong> set to <code>true</code> and the value of <strong>SameSite</strong> set to <code>Lax</code>. If that&rsquo;s what you see, the cookie rewrite worked!</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/samesite-secure-cookie.jpg" title="SameSite and secure cookie">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/samesite-secure-cookie.jpg#ZgotmplZ" alt="SameSite and secure cookie">
  
    </a>
  
  
</div>


<h2 id="summary">Summary</h2>
<p>There&rsquo;s a lot of new stuff here, so I wouldn&rsquo;t be surprised if this is difficult to set up. However, if you follow this guide diligently, and make sure there are no rogue tags firing without <code>cookieUpdate</code>, the Client should do its job nicely.</p>
<p>If you run into issues, let me know in the comments and we can take a look together.</p>
<p>Server-side tagging is the new paradigm for Google&rsquo;s tagging solutions. I can see a lot of amazing things you can do with it in the future, but right now you can also utilize it for improving the quality of your data incrementally with solutions such as this one.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/gtmtips/">gtmtips</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/cookie/">cookie</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/universal-analytics/">universal analytics</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/fpid-cookie-google-analytics-server-side-tagging/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/send-google-analytics-requests-custom-endpoint/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Build%20A%20Custom%20Universal%20Analytics%20Client%20For%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/fpid-cookie-google-analytics-server-side-tagging/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/send-google-analytics-requests-custom-endpoint/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Build%20A%20Custom%20Universal%20Analytics%20Client%20For%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Build%20A%20Custom%20Universal%20Analytics%20Client%20For%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/build-custom-universal-analytics-client-server-side-tagging/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

