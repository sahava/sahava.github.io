

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "#GTMTips: Utilize App Engine Headers In Server-side Tagging | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/08\/app-engine-headers.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/gtm-tips\/utilize-app-engine-headers-server-side-tagging\/",
  "datePublished": "2020-08-26T09:00:17\u002b03:00",
  "dateModified": "2020-08-26T09:00:17\u002b03:00",
  "description": "App Engine automatically geolocates the IP addresses of the incoming requests, and assigns the values to HTTP headers in the requests. You can pull these values from the headers and utilize them in your Server container tags.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>#GTMTips: Utilize App Engine Headers In Server-side Tagging | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
    
    <meta name="description" content="App Engine automatically geolocates the IP addresses of the incoming requests, and assigns the values to HTTP headers in the requests. You can pull these values from the headers and utilize them in your Server container tags.">
    <meta property="og:description" content="App Engine automatically geolocates the IP addresses of the incoming requests, and assigns the values to HTTP headers in the requests. You can pull these values from the headers and utilize them in your Server container tags.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="#GTMTips: Utilize App Engine Headers In Server-side Tagging">
    <meta property="og:url" content="https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="#GTMTips: Utilize App Engine Headers In Server-side Tagging">
    <meta name="twitter:description" content="App Engine automatically geolocates the IP addresses of the incoming requests, and assigns the values to HTTP headers in the requests. You can pull these values from the headers and utilize them in your Server container tags.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/08/app-engine-headers.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/08/app-engine-headers.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      #GTMTips: Utilize App Engine Headers In Server-side Tagging
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-08-26T09:00:17&#43;03:00">
        
  August 26, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/gtm-tips">GTM Tips</a>
    
  


      | <a href="https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/#commento">Comments</a>
      
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>When you create a <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">Server container</a> in <a href="https://tagmanager.google.com/">Google Tag Manager</a>, GTM creates an <a href="https://cloud.google.com/appengine">App Engine</a> deployment in the Google Cloud Platform for you.</p>
<p>App Engine is a <strong>managed serverless platform</strong>, which basically means it&rsquo;s a (set of) virtual machine(s) running in the cloud, with some extra bells and whistles added to make managing it easier.</p>
<p>A potentially useful thing that App Engine does is decorate all incoming HTTP requests with some HTTP headers that can be used in the app. These headers include <strong>geolocation</strong> headers, based on the IP address of the machine that sent the hits.</p>
<p>As with geolocation always, accuracy varies wildly, but App Engine will make a best-effort attempt to determine the <a href="https://en.wikipedia.org/wiki/ISO_3166-2">country</a>, city, <a href="https://en.wikipedia.org/wiki/ISO_3166-2:FI">region</a>, and latitude/longitude of the city where the IP address was geolocated to.</p>
<p>In this article, I&rsquo;ll show you how to grab these header values and pass them to the tags firing in the Server container.</p>
<blockquote>
<p>This article was inspired and influenced by discussions with the Google engineers and developers working on Server-side tagging, Adam Halbardier in particular.</p>
</blockquote>
<h2 id="tip-119-use-app-engines-headers-to-geolocate-the-request-source">Tip 119: Use App Engine&rsquo;s headers to geolocate the request source</h2>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/app-engine-headers.jpg" title="App Engine headers">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/app-engine-headers.jpg#ZgotmplZ" alt="App Engine headers">
  
    </a>
  
  
</div>


<p>The initiative to write this article came while working with the <a href="https://www.simoahava.com/gtm-tips/get-true-ip-anonymization-server-side-tagging/"><code>ip_override</code> and <code>user_agent</code></a> overrides in another article. As it turns out, <strong>App + Web</strong> does not currently support overriding a user&rsquo;s IP address in the outgoing request to Google servers, which means that App + Web sees all requests as originating from your Server container. This is good for privacy but bad for geolocation.</p>
<p>Luckily, you can utilize these <a href="https://cloud.google.com/appengine/docs/flexible/python/reference/request-headers">request headers</a> to parse what App Engine has determined to be the geographical location (down to the accuracy of the <strong>city</strong>) of the incoming request:</p>
<ul>
<li>
<p><code>X-Appengine-Country</code> - <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">ISO 3166-1 alpha-2</a> country code, such as <code>FI</code> for Finland and <code>US</code> for the USA.</p>
</li>
<li>
<p><code>X-Appengine-Region</code> - <a href="https://en.wikipedia.org/wiki/ISO_3166-2">ISO 3166-2</a> region code whose value and encoding depends on the country. For example, my region is <strong>Uusimaa</strong>, and the region code is <code>18</code>. A request from California would show up with region code <code>ca</code>.</p>
</li>
<li>
<p><code>X-Appengine-City</code> - Name of the city (if available) where the request originated from. There is no canonical or standardized list of values here.</p>
</li>
<li>
<p><code>X-Appengine-Citylatlong</code> - Comma-separated latitude and longitude of the city where the request originated from. For Espoo (my city), it would look like this: <code>60.204813,24.652052</code>.</p>
</li>
</ul>
<p>To grab these, you need to create new <strong>User-defined variables</strong> in the Server container, where each variable is of type <strong>Request Header</strong>, and set to the value of one of these headers. Like so:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/geo-headers.jpg" title="Geo headers">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/geo-headers.jpg#ZgotmplZ" alt="Geo headers">
  
    </a>
  
  
</div>


<p>You can then add them to your tags as overridden fields. Here&rsquo;s an example where I enhance my server-side App + Web tag.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/app-web-tag.jpg" title="App &#43; Web tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/app-web-tag.jpg#ZgotmplZ" alt="App &#43; Web tag">
  
    </a>
  
  
</div>


<p>And this is what it looks like in App + Web.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/app-web-report.jpg" title="App&#43;Web report">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/app-web-report.jpg#ZgotmplZ" alt="App&#43;Web report">
  
    </a>
  
  
</div>


<blockquote>
<p>You can also add geolocation information to your Universal Analytics tags by utilizing the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#geoid"><code>&amp;geoId</code></a> Measurement Protocol parameter. This way you could geolocate the user without Google collecting the IP address. However, you would need to map the geolocation data provided by App Engine to the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/geoid"><strong>criteria ID</strong> parameter Google Analytics uses</a>, which is a bit of a chore without a Lookup Table variable.</p>
</blockquote>
<p>Anyway, I have no doubt that proper IP override will be introduced in App + Web tags soon, but you can continue sending this information as metadata, as it might be useful to see if App Engine&rsquo;s and App + Web&rsquo;s geolocation results differ.</p>
<blockquote>
<p>NOTE! I don&rsquo;t know how App Engine resolves geolocation, nor do I know how App + Web does it either. Most likely they use a proprietary service, but there is a notable lack of documentation about this. <a href="https://cloud.google.com/appengine/docs/flexible/python/reference/request-headers">This document</a> merely states that the WHOIS database is <strong>not</strong> used for geolocation.</p>
</blockquote>
<p>Let me know what you think about this simple trick in the comments!</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/gtmtips/">gtmtips</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/container-notifications-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/get-true-ip-anonymization-server-side-tagging/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Utilize%20App%20Engine%20Headers%20In%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/container-notifications-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/get-true-ip-anonymization-server-side-tagging/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Utilize%20App%20Engine%20Headers%20In%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=%23GTMTips:%20Utilize%20App%20Engine%20Headers%20In%20Server-side%20Tagging%20https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

