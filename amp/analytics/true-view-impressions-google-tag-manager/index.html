

  
    
  


  

<!doctype html>



<html âš¡ lang="en-us" class="no-js">
    <head>

      <meta charset="utf-8">
        <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script><script async custom-element="amp-accordion" src="https://cdn.ampproject.org/v0/amp-accordion-0.1.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script><script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script><script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script><script async custom-element="amp-twitter" src="https://cdn.ampproject.org/v0/amp-twitter-0.1.js"></script><script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>

<script async src="https://cdn.ampproject.org/v0.js"></script>


<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
<style amp-custom>
  .type-simmer {
      padding: 8px;
      background: rgba(179,138,197,0.2);
      box-shadow: 2px 2px 1px #ccc;
      border-radius: 5px;
  }
    /*! normalize.css v5.0.0 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none}.clearfix:after,.clearfix:before{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.hidden{text-indent:-9999px;visibility:hidden;display:none}.inner{position:relative;width:80%;max-width:710px;margin:0 auto}.vertical{display:table-cell;vertical-align:middle}.site-wrapper{position:relative;z-index:10;min-height:100%;background:#fff;-webkit-transition:-webkit-transform .5s ease;transition:-webkit-transform .5s ease;transition:transform .5s ease;transition:transform .5s ease,-webkit-transform .5s ease}html{font-size:62.5%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body,html{height:100%;max-height:100%}body{font-family:Merriweather,serif;letter-spacing:.01rem;font-size:1.8rem;line-height:1.75em;color:#3a4145;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;text-rendering:geometricPrecision}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{-webkit-font-feature-settings:"dlig" 1,"liga" 1,"lnum" 1,"kern" 1;-moz-font-feature-settings:"dlig" 1,"liga" 1,"lnum" 1,"kern" 1;-o-font-feature-settings:"dlig" 1,"liga" 1,"lnum" 1,"kern" 1;color:#2e2e2e;line-height:1.15em;margin:0 0 .4em;font-family:Open Sans,sans-serif;text-rendering:geometricPrecision}h1{font-size:5rem;letter-spacing:-2px;text-indent:-3px}h2{font-size:3.6rem;letter-spacing:-1px}h3{font-size:3rem}h4{font-size:2.5rem}h5,h6{font-size:2rem}a,a:active,a:hover,a:visited{color:#4a4a4a;-webkit-transition:color .3s ease;transition:color .3s ease}a:active,a:hover{color:#111}dl,ol,p,ul{-webkit-font-feature-settings:"liga" 1,"onum" 1,"kern" 1;-moz-font-feature-settings:"liga" 1,"onum" 1,"kern" 1;-o-font-feature-settings:"liga" 1,"onum" 1,"kern" 1;margin:0 0 1.75em;text-rendering:geometricPrecision}ol,ul{padding-left:3rem}ol ol,ol ul,ul ol,ul ul{margin:0 0 .4em;padding-left:2em}dl dt{float:left;width:180px;overflow:hidden;clear:left;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd,dl dt{margin-bottom:1em}dl dd{margin-left:200px}li{margin:.4em 0}li li{margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:3.2em 0;padding:0}blockquote{-webkit-box-sizing:border-box;box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:.4em solid #4a4a4a}blockquote p{margin:.8em 0;font-style:italic}blockquote small{display:inline-block;margin:.8em 0 .8em 1.5em;font-size:.9em;color:#ccc}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:400}mark{background-color:#ffc336}code,tt{padding:1px 3px;font-size:.85em;white-space:pre-wrap;border:1px solid #e3edf3;border-radius:2px}code,pre,tt{font-family:Inconsolata,monospace,sans-serif;background:#f7fafb}pre{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0 0 1.75em;border:1px solid #e3edf3;width:100%;padding:10px;font-size:.9em;white-space:pre;overflow:auto;border-radius:3px}pre code,pre tt{font-size:inherit;white-space:pre-wrap;background:transparent;border:none;padding:0}kbd{display:inline-block;margin-bottom:.4em;padding:1px 8px;border:1px solid #ccc;color:#666;text-shadow:#fff 0 1px 0;font-size:.9em;font-weight:700;background:#f4f4f4;border-radius:4px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 1px 0 0 #fff inset;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 1px 0 0 #fff}table{-webkit-box-sizing:border-box;box-sizing:border-box;margin:1.75em 0;width:100%;max-width:100%;background-color:transparent}table td,table th{padding:8px;line-height:20px;text-align:left;vertical-align:top;border-top:1px solid #efefef}table th{color:#000}table caption+thead tr:first-child td,table caption+thead tr:first-child th,table colgroup+thead tr:first-child td,table colgroup+thead tr:first-child th,table thead:first-child tr:first-child td,table thead:first-child tr:first-child th{border-top:0}table tbody+tbody{border-top:2px solid #efefef}table table table{background-color:#fff}table tbody>tr:nth-child(odd)>td,table tbody>tr:nth-child(odd)>th{background-color:#f6f6f6}table.plain tbody>tr:nth-child(odd)>td,table.plain tbody>tr:nth-child(odd)>th{background:transparent}.fluid-width-video-wrapper,iframe{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe{margin:0}.main-header{position:relative;display:table;width:100%;height:100vh;margin-bottom:5rem;text-align:center;background:#222 no-repeat 50%;background-size:cover;overflow:hidden}.main-header.cover{background-image:url("https://www.simoahava.com/images/maisema.jpg")}.main-header.list-cover{background-image:url("/")}.main-header .inner{width:80%}.main-header a.bloglogo{text-decoration:none}.main-header a.bloglogo .icon-facebook,.main-header a.bloglogo .icon-github,.main-header a.bloglogo .icon-google-plus,.main-header a.bloglogo .icon-instagram,.main-header a.bloglogo .icon-linkedin,.main-header a.bloglogo .icon-pinterest,.main-header a.bloglogo .icon-twitter{color:#fff;font-size:2em}.main-nav{position:relative;padding:35px 40px;margin:0 0 30px}.main-nav a{text-decoration:none;font-family:Open Sans,sans-serif}.scroll-down{display:block;position:absolute;z-index:100;bottom:45px;left:50%;font-size:1.5em;text-align:center;-webkit-animation:bounce 4s 2s infinite;animation:bounce 4s 2s infinite}.scroll-down:hover{color:#fff;-webkit-animation:none;animation:none}.home-template .main-header:after{display:block;content:" ";width:150px;height:130px;border-radius:100%;position:absolute;bottom:0;left:50%;margin-left:-75px;background:radial-gradient(ellipse at center,rgba(0,0,0,.15) 0,transparent 70%,transparent 100%)}.archive-template .main-header:after,.archive-template .scroll-down,.no-cover.main-header:after,.no-cover .scroll-down{display:none}.blog-logo{display:block;float:left}.blog-logo img{display:block;padding:1px 0 5px;width:auto}.blog-logo img,.menu-button{-webkit-box-sizing:border-box;box-sizing:border-box;height:38px}.menu-button{display:inline-block;float:right;padding:0 15px;border:1px solid #bfc8cd;opacity:1;color:#9eabb3;text-align:center;font-size:12px;text-transform:uppercase;line-height:35px;white-space:nowrap;border-radius:3px;background:rgba(0,0,0,.1);-webkit-transition:all .5s ease;transition:all .5s ease}.menu-button:focus{outline:0}.menu-button .fa-bars{font-size:12px;margin-right:6px}.main-nav.overlay{position:absolute;top:0;left:0;right:0;height:70px;border:none;background:-webkit-gradient(linear,left top,left bottom,from(rgba(0,0,0,.2)),to(transparent));background:linear-gradient(180deg,rgba(0,0,0,.2) 0,transparent)}.no-cover .main-nav.overlay,.no-cover .menu-button{background:none}.main-nav.overlay a{color:#fff}.main-nav.overlay .menu-button{border-color:hsla(0,0%,100%,.6)}.cover .main-nav.overlay a.menu-button:hover{color:#222;border-color:#fff;background:#fff}.menu-button:hover,.no-cover .main-nav.overlay .menu-button:hover{border-color:#555;color:#555}.page-title{margin:10px 0;font-size:5rem;letter-spacing:-1px;font-weight:700;font-family:Open Sans,sans-serif;color:#fff}.page-description{margin:0;font-size:2rem;line-height:1.5em;font-weight:400;font-family:Merriweather,serif;letter-spacing:.01rem;color:hsla(0,0%,100%,.8)}.no-cover.main-header{min-height:160px;max-height:40vh;background:#f5f8fa}.no-cover .page-title{color:rgba(0,0,0,.8)}.no-cover .page-description{color:rgba(0,0,0,.5)}.no-cover .main-nav.overlay .menu-button{color:rgba(0,0,0,.4);border-color:rgba(0,0,0,.3)}.main-header-content .page-title{-webkit-animation:fade-in-down .6s;animation:fade-in-down .6s;-webkit-animation-delay:.2s;animation-delay:.2s}.main-header-content .page-description{-webkit-animation:fade-in-down .9s;animation:fade-in-down .9s;-webkit-animation-delay:.1s;animation-delay:.1s}.post{position:relative;width:80%;max-width:710px;margin:4rem auto;padding-bottom:4rem;border-bottom:1px solid #ebf2f6;word-wrap:break-word;-ms-hyphens:auto;-webkit-hyphens:auto;hyphens:auto}.post-header{padding-bottom:10px}.post:after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;-webkit-box-shadow:#fff 0 0 0 5px;box-shadow:0 0 0 5px #fff}body:not(.post-template) .post-title{font-size:3.6rem}.post-title a{text-decoration:none}.post-excerpt p{margin:0;font-size:.9em;line-height:1.7em}.read-more{font-size:.8em;text-decoration:none;font-style:italic}.post-meta{display:block;margin:1.75rem 0 0;font-family:Open Sans,sans-serif;font-size:1.5rem;line-height:2.2rem;color:#9eabb3}.author-thumb{width:24px;height:24px;float:left;margin-right:9px;border-radius:100%}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.user-meta{position:relative;padding:.3rem 40px 0 100px;min-height:77px}.post-date{display:inline-block;margin-left:8px;padding-left:12px;border-left:1px solid #d5dbde;text-transform:uppercase;font-size:1.3rem;white-space:nowrap}.user-image{position:absolute;top:0;left:0}.user-name{display:block;font-weight:700}.user-bio{display:block;max-width:440px;font-size:1.4rem;line-height:1.5em}.publish-meta{position:absolute;top:0;right:0;padding:4.3rem 0 4rem;text-align:right}.publish-heading{display:block;font-weight:700}.publish-date{display:block;font-size:1.4rem;line-height:1.5em}figure.no-margin{margin:0}figure.center{margin-left:auto;margin-right:auto}.amp-image-lightbox-caption{text-align:center;font-size:.8em}@media only screen and (min-width:501px){figure.polaroid:after,figure.polaroid:before{content:"";position:absolute;z-index:-2;bottom:10px;width:50%;height:20%;max-width:480px;-webkit-box-shadow:0 15px 10px rgba(0,0,0,.7);box-shadow:0 15px 10px rgba(0,0,0,.7)}figure.polaroid:after{right:10px;left:auto;-webkit-transform:rotate(3deg);transform:rotate(3deg)}figure.polaroid:before{left:10px;right:auto;-webkit-transform:rotate(-3deg);transform:rotate(-3deg)}figure.polaroid{width:450px;position:relative;padding:15px;border:none;background:#fff;-webkit-box-shadow:0 1px 4px rgba(0,0,0,.3),0 0 40px rgba(0,0,0,.1) inset;box-shadow:0 1px 4px rgba(0,0,0,.3),inset 0 0 40px rgba(0,0,0,.1);border-radius:4px;margin-bottom:1.5em;max-width:100%}figure.polaroid div[fallback]{border:none;margin:0;padding:0}figure.polaroid amp-img{display:block;outline:1px solid #ccc;padding:0;margin:0}figure.polaroid figcaption{font-size:1.3em;font-weight:400;font-family:Kaushan Script,cursive;text-align:right;padding:.8em .5em .4em}}@media only screen and (max-width:501px){figure.polaroid{background:#fff;border-radius:1px;margin-bottom:1em}figure.polaroid figcaption{font-size:.8em;font-style:italic;text-align:center;border-top:1px solid #d3d3d3;border-bottom:1px solid #d3d3d3;margin-top:.5em;padding:.2em}}.main-header.cover .main-header-content .social-link a,.main-header.cover .main-header-content .social-link a:active,.main-header.cover .main-header-content .social-link a:hover,.main-header.cover .main-header-content .social-link a:visited,.scroll-down a,.scroll-down a:active,.scroll-down a:hover,.scroll-down a:visited{text-decoration:none;font-size:2em}.main-header.cover .main-header-content .social-link a:active,.main-header.cover .main-header-content .social-link a:hover,.scroll-down a:active,.scroll-down a:hover{color:#fff}.main-header.no-cover .main-header-content .social-link a,.main-header.no-cover .main-header-content .social-link a:active,.main-header.no-cover .main-header-content .social-link a:hover,.main-header.no-cover .main-header-content .social-link a:visited{text-decoration:none;font-size:2em;color:#a2a2a2}.main-header.no-cover .main-header-content .social-link a:active,.main-header.no-cover .main-header-content .social-link a:hover{color:#000}.post-template .post-header{margin-bottom:3.4rem}.post-template .post-title{margin-bottom:0}.post-template .post-meta{margin:0}.post-template .post-date{padding:0;margin:0;border:none}.post-template .content{overflow:hidden}.post-template .post{margin-top:0;border-bottom:none;padding-bottom:0}.post-template .post:after{display:none}.post-content{text-align:justify}.post-footer{position:relative;margin:6rem 0 0;padding:6rem 0 0;border-top:1px solid #ebf2f6}.post-footer h4{font-size:1.8rem;margin:0}.post-footer p{margin:1rem 0;font-size:1.4rem;line-height:1.75em}.author-meta{padding:0;margin:0;list-style:none;font-size:1.4rem;line-height:1;font-style:italic}.author-meta,.author-meta a{color:#9eabb3}.author-meta a:hover{color:#111}.post-footer .author{margin-right:180px}.post-footer h4 a{color:#2e2e2e;text-decoration:none}.post-footer h4 a:hover{text-decoration:underline}.post-footer .share{position:absolute;top:6rem;right:0;width:180px}.post-footer .share a{font-size:1.8rem;display:inline-block;margin:1rem 1.6rem 1.6rem 0;color:#bbc7cc;text-decoration:none}.post-footer .share a:hover{color:#50585d}.post-head.main-header{height:65vh;min-height:180px}.no-cover.post-head.main-header{height:85px;min-height:0;margin-bottom:0;background:transparent}.author-head.main-header,.tag-head.main-header{height:40vh;min-height:180px}.no-cover.author-head.main-header{height:10vh;min-height:100px;background:transparent}.author-profile{padding:0 15px 5rem;border-bottom:1px solid #ebf2f6;text-align:center}.author-profile:after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;-webkit-box-shadow:#fff 0 0 0 5px;box-shadow:0 0 0 5px #fff}.author-image{-webkit-box-sizing:border-box;box-sizing:border-box;display:block;position:absolute;top:-56px;left:50%;margin-left:-40px;width:80px;height:80px;border-radius:100%;overflow:hidden;padding:6px;background:#fff;z-index:2;-webkit-box-shadow:#e7eef2 0 0 0 1px;box-shadow:0 0 0 1px #e7eef2}.author-image .img{position:relative;display:block;width:100%;height:100%;background-size:cover;background-position:50%;border-radius:100%;background-image:url("https://www.simoahava.com/images/simo.png")}.author-profile .author-image{position:relative;left:auto;top:auto;width:120px;height:120px;padding:3px;margin:-100px auto 0;-webkit-box-shadow:none;box-shadow:none}.author-title{margin:1.5rem 0 1rem}.author-bio{font-size:1.8rem;line-height:1.5em;font-weight:200;color:#50585d;letter-spacing:0;text-indent:0}.author-meta{margin:1.6rem 0}.author-profile .author-meta{margin:2rem 0;font-family:Merriweather,serif;letter-spacing:.01rem;font-size:1.7rem}.author-meta span{display:inline-block;margin:0 2rem 1rem 0;word-wrap:break-word}.author-meta a{text-decoration:none}.archive-template .author-profile .author-meta{display:none}@-webkit-keyframes fade-in-down{0%{opacity:0;transform:translateY(-10px);-webkit-transform:translateY(-10px);-ms-transform:translateY(-10px)}to{opacity:1;transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0)}}@keyframes fade-in-down{0%{opacity:0;transform:translateY(-10px);-webkit-transform:translateY(-10px);-ms-transform:translateY(-10px)}to{opacity:1;transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0)}}@-webkit-keyframes bounce{0%,10%,25%,40%,50%{transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0)}20%{transform:translateY(-10px);-webkit-transform:translateY(-10px);-ms-transform:translateY(-10px)}30%{transform:translateY(-5px);-webkit-transform:translateY(-5px);-ms-transform:translateY(-5px)}}@keyframes bounce{0%,20%,50%,80%,to{transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0)}40%{transform:translateY(-10px);-webkit-transform:translateY(-10px);-ms-transform:translateY(-10px)}60%{transform:translateY(-5px);-webkit-transform:translateY(-5px);-ms-transform:translateY(-5px)}}#sidebar{background:rgba(0,0,0,.7);text-align:left;overflow-y:auto;font-family:Open Sans,Verdana,sans-serif;font-weight:700;font-size:11px;color:#909090;width:400px}#sidebar .nav-title{position:absolute;top:45px;left:30px;font-size:1.5em;font-weight:100;text-transform:uppercase;color:#fff}#sidebar .nav-section{color:#d8d8d8}#sidebar .nav-close{position:absolute;top:38px;right:25px;width:20px;height:20px;padding:0;font-size:10px}#sidebar .nav-close:focus{outline:0}#sidebar .nav-close:after,#sidebar .nav-close:before{content:"";position:absolute;top:0;width:20px;height:1px;background:#969696;top:15px;-webkit-transition:background .15s ease;transition:background .15s ease}#sidebar .nav-close:before{-webkit-transform:rotate(45deg);transform:rotate(45deg)}#sidebar .nav-close:after{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}#sidebar .nav-close:hover:after,#sidebar .nav-close:hover:before{background:#fff}#sidebar amp-accordion .nav-section{margin:.4em 0 .2em;background:none;border:none;font-size:2rem}#sidebar amp-accordion section[expanded] .nav-section .fa{width:1ch}#sidebar amp-accordion section[expanded] .nav-section .section-open{display:inline-block}#sidebar amp-accordion section[expanded] .nav-section .section-close{display:none}#sidebar amp-accordion section:not([expanded]) .nav-section .section-open{display:none}#sidebar amp-accordion section:not([expanded]) .nav-section .section-close{display:inline-block}#sidebar ul{padding:90px 9% 5%;list-style:none;counter-reset:item}#sidebar li:before{display:block;float:right;padding-right:4%;padding-left:5px;text-align:right;font-size:1.2rem;vertical-align:bottom;color:#b8b8b8;content:counter(item,lower-roman);counter-increment:item}#sidebar li{margin:0}#sidebar li a{text-decoration:none;line-height:1.4;font-size:1.4rem;display:block;padding:.6rem 4%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}#sidebar li a:after{display:inline-block;content:" ...............................................................";color:hsla(0,0%,100%,.2);margin-left:5px}#sidebar .nav-current:before{color:#fff}#sidebar .nav-current a:after{content:" ";border-bottom:1px solid hsla(0,0%,100%,.5);width:100%;height:1px}#sidebar a,#sidebar a:active,#sidebar a:hover,#sidebar a:visited{color:#b8b8b8}#sidebar a:active,#sidebar a:hover,#sidebar li.nav-current a{color:#fff}.subscribe-button{-webkit-box-sizing:border-box;box-sizing:border-box;display:block;position:absolute;bottom:30px;left:30px;right:30px;height:38px;padding:0 20px;text-align:center;font-size:12px;font-family:Open Sans,sans-serif;text-transform:uppercase;text-decoration:none;line-height:35px;border-radius:3px;background:#fff;-webkit-transition:all .3s ease;transition:all .3s ease}.subscribe-button:before{font-size:9px;margin-right:6px}.pagination{position:relative;width:80%;max-width:710px;margin:4rem auto;font-family:Open Sans,sans-serif;font-size:1.3rem;color:#9eabb3;text-align:center}.pagination a{color:#9eabb3;-webkit-transition:all .2s ease;transition:all .2s ease}.newer-posts,.older-posts{position:absolute;display:inline-block;padding:0 15px;border:1px solid #bfc8cd;text-decoration:none;border-radius:4px;-webkit-transition:border .3s ease;transition:border .3s ease}.older-posts{right:0}.page-number{display:inline-block;padding:2px 0;min-width:100px}.newer-posts{left:0}.newer-posts:hover,.older-posts:hover{color:#889093;border-color:#98a0a4}.extra-pagination{display:none;border-bottom:1px solid #ebf2f6}.extra-pagination:after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;-webkit-box-shadow:#fff 0 0 0 5px;box-shadow:0 0 0 5px #fff}.extra-pagination .pagination{width:auto}.archive-template .main-header{max-height:30vh}.archive-template .extra-pagination{display:block}.site-footer{position:relative;margin:8rem 0 0;padding:.5rem 15px;font-family:Open Sans,sans-serif;font-size:1rem;line-height:1.75em;color:#bbc7cc}.site-footer a{color:#bbc7cc;text-decoration:none;font-weight:700}.site-footer a:hover{color:#50585d}.poweredby{float:right;text-align:right}.copyright,.poweredby{display:block;width:45%}.copyright{float:left}@media only screen and (max-width:900px){blockquote{margin-left:0}.main-header{-webkit-box-sizing:border-box;box-sizing:border-box;height:auto;min-height:240px;height:60vh;padding:15% 0}.home-template .main-header:after,.scroll-down{display:none}.archive-template .main-header{min-height:180px;padding:10% 0}.blog-logo img{padding:4px 0}.page-title{font-size:4rem;letter-spacing:-1px}.page-description{font-size:1.8rem;line-height:1.5em}.post{font-size:.95em}body:not(.post-template) .post-title{font-size:3.2rem}hr{margin:2.4em 0}ol,ul{padding-left:2em}h1{font-size:4.5rem;text-indent:-2px}h2{font-size:3.6rem}h3{font-size:3.1rem}h4{font-size:2.5rem}h5{font-size:2.2rem}h6{font-size:1.8rem}.author-profile{padding-bottom:4rem}.author-profile .author-bio{font-size:1.6rem}.author-meta span{display:block;margin:1.5rem 0}.author-profile .author-meta span{font-size:1.6rem}.post-head.main-header{height:45vh}.author-head.main-header,.tag-head.main-header{height:30vh}.no-cover.post-head.main-header{height:55px;padding:0}.no-cover.author-head.main-header{padding:0}}@media only screen and (max-width:500px){.main-header{margin-bottom:15px;height:40vh}.no-cover.main-header{height:30vh}.archive-template .main-header{max-height:20vh;min-height:160px;padding:10% 0}.main-nav{margin-bottom:2rem}.blog-logo,.main-nav{padding:5px}.blog-logo img{height:30px}.menu-button{padding:0 5px;border-radius:0;border-color:transparent;color:#2e2e2e;background:transparent}.menu-button:hover{color:#2e2e2e;border-color:transparent;background:none}body.nav-opened .menu-button{background:none;border:transparent}.main-nav.overlay a:hover{color:#fff;border-color:transparent;background:transparent}.no-cover .main-nav.overlay{background:none}.no-cover .main-nav.overlay .menu-button{border:none}.main-nav.overlay .menu-button{border-color:transparent}.nav-title{top:25px}.nav-close{position:absolute;top:18px}.nav ul{padding:60px 9% 5%}.inner,.pagination{width:auto;margin:2rem auto}.post{width:auto;margin:2rem 16px;padding-bottom:2rem;line-height:1.65em}.post-template .post-header{margin-bottom:2rem}.post-template .post-date{display:inline-block}hr{margin:1.75em 0}dl,ol,p,ul{font-size:.95em;margin:0 0 2.5rem}.page-title{font-size:3rem}.post-excerpt p{font-size:.85em}.page-description{font-size:1.6rem}h1,h2,h3,h4,h5,h6{margin:0 0 .3em}h1{font-size:2.8rem;letter-spacing:-1px}h2{font-size:2.4rem;letter-spacing:0}h3{font-size:2.1rem}h4{font-size:1.9rem}h5,h6{font-size:1.8rem}body:not(.post-template) .post-title{font-size:2.5rem}.post-template .post{padding-bottom:0;margin-bottom:0}.post-template .site-footer{margin-top:0}.post-meta{font-size:1.3rem;margin-top:1rem}.post-footer{padding:5rem 0 3rem;text-align:center}.post-footer .author{margin:0 0 2rem;padding:0 0 1.6rem;border-bottom:1px dashed #ebf2f6}.post-footer .share{position:static;width:auto}.post-footer .share a{margin:1.4rem .8rem 0}.author-meta li{float:none;margin:0;line-height:1.75em}.author-meta li:before{display:none}.newer-posts,.older-posts{position:static;margin:10px 0}.page-number{display:block}.site-footer{margin-top:3rem}.author-profile{padding-bottom:2rem}.post-head.main-header{height:30vh}.author-head.main-header,.tag-head.main-header{height:20vh}.author-profile .author-image{margin-top:-70px}.author-profile .author-meta span{font-size:1.4rem}.archive-template .main-header .page-description{display:none}}header.post-header{line-height:1.1em}.post-content amp-img{max-width:100%;height:auto;border:1px solid #777;-webkit-box-shadow:5px 5px 2px rgba(0,0,0,.4);box-shadow:5px 5px 2px rgba(0,0,0,.4);margin-bottom:20px}.social-link a{color:#dfdfdf}pre.chroma{text-align:left}.badge-primary{color:#fff;background-color:#007bff}.badge{display:inline-block;padding:.25em .4em;font-size:80%;font-weight:700;line-height:1;text-align:center;white-space:nowrap;vertical-align:middle;border-radius:.25rem}
    

</style>

        <link rel="canonical" href="https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

        

        <link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,700,700i|Open+Sans:400,700|Kaushan+Script" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

        <meta name="theme-color" content="#ffffff" />

        
        <title>True View Ecommerce Impressions With Google Tag Manager | Simo Ahava's blog</title>
        



  

<meta property="og:title" content="True View Ecommerce Impressions With Google Tag Manager" />
<meta name="description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager." />
<meta property="og:description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.simoahava.com/amp/analytics/true-view-impressions-google-tag-manager/" />

      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg">
    


    
        <meta property="article:published_time" content="2019-01-21T09:36:08Z"/>
    
    
        <meta property="article:modified_time" content="2019-01-21T09:36:08Z"/>
    




    


    <meta property="og:site_name" content="Simo Ahava&#39;s blog :: Simo Ahava is a Google Developer Expert for Google Analytics and Google Tag Manager. This is a blog all about web analytics development." />









    
        
        
            
        
        
        
    
    
    
        
            <meta property="article:section" content="Analytics" />
        
    
    
        
            <meta property="article:tag" content="google tag manager" />
        
            <meta property="article:tag" content="customtask" />
        
            <meta property="article:tag" content="enhanced ecommerce" />
        
    







    
        <meta name="twitter:card" content="summary"/>
    

    
        
        
            
        
        
        
    



<meta itemprop="name" content="True View Ecommerce Impressions With Google Tag Manager">
<meta itemprop="description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.">
<meta itemprop="datePublished" content="2019-01-21T11:36:08&#43;02:00" />
<meta itemprop="dateModified" content="2019-01-21T11:36:08&#43;02:00" />
<meta itemprop="wordCount" content="3648">



<meta itemprop="keywords" content="google tag manager,customtask,enhanced ecommerce," />
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Simo Ahava\u0027s blog :: Simo Ahava is a Google Developer Expert for Google Analytics and Google Tag Manager. This is a blog all about web analytics development.",
    
    "url": "https:\/\/www.simoahava.com\/amp\/"
}
</script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "True View Ecommerce Impressions With Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/01\/true-view-impressions-google-tag-manager.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/amp\/analytics\/true-view-impressions-google-tag-manager\/",
  "datePublished": "2019-01-21T11:36:08\u002b02:00",
  "dateModified": "2019-01-21T11:36:08\u002b02:00",
  "description": "Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>












    </head>
<body>

<amp-analytics config="https://www.googletagmanager.com/amp.json?id=GTM-5BH2HM&gtm.url=SOURCE_URL" data-credentials="include"></amp-analytics>
  <amp-sidebar id="sidebar" layout="nodisplay" side="right">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close" on="tap:sidebar.close" role="button" tabindex="1">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/categories/gtm-tips/">GTM Tips</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/about-simo-ahava/">About</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/tools/">Tools</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/blog-statistics/">Blog Statistics</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/upcoming-talks/">Upcoming Talks</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/custom-templates/">Templates</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/amp/newsletter/">Newsletter</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
                <a href="https://www.simoahava.com/">Full (non-AMP) site</a>
            </li>
        
        <amp-accordion>
        
            <section>
                <h3 class="nav-section">
                    <i class="fa fa-caret-down section-open" aria-hidden="true"></i>
                    <i class="fa fa-caret-right section-close" aria-hidden="true"></i>
                    Categories
                </h3>
                <div>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/analytics/">analytics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/content-management/">content-management</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/digital-marketing/">digital-marketing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/google-cloud/">google-cloud</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/gtm-tips/">gtm-tips</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/personal/">personal</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/privacy/">privacy</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/seo/">seo</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/web-design/">web-design</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/categories/web-development/">web-development</a></li>
                
                </div>
            </section>
        
            <section>
                <h3 class="nav-section">
                    <i class="fa fa-caret-down section-open" aria-hidden="true"></i>
                    <i class="fa fa-caret-right section-close" aria-hidden="true"></i>
                    Tags
                </h3>
                <div>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ab-testing/">ab-testing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/accelerated-mobile-pages/">accelerated-mobile-pages</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/adblocker/">adblocker</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/add-on/">add-on</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/adwords/">adwords</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/agile/">agile</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/amazon/">amazon</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/amp/">amp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/analytics/">analytics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/android/">android</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/api/">api</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/app/">app</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/app&#43;web/">app&#43;web</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/app-engine/">app-engine</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/approval/">approval</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/apps/">apps</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/apps-script/">apps-script</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/array/">array</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/attribution/">attribution</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/audience-design/">audience-design</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/audit/">audit</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/auto-event-tracking/">auto-event-tracking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/auto-link-domains/">auto-link-domains</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/aws/">aws</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/basketball/">basketball</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/beforeunload/">beforeunload</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/best-practices/">best-practices</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/big-data/">big-data</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/bigquery/">bigquery</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/blogger/">blogger</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/bounce-rate/">bounce-rate</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/built-in-variables/">built-in-variables</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/calculated-metrics/">calculated-metrics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/callback/">callback</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/campaign-tracking/">campaign-tracking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/celebration/">celebration</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/change-history/">change-history</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/chrome/">chrome</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/chrome-extension/">chrome-extension</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/click-tracking/">click-tracking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/click-variables/">click-variables</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/clickstream/">clickstream</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/client-id/">client-id</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/clientid/">clientid</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cloud-functions/">cloud-functions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cms/">cms</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cname/">cname</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/conferences/">conferences</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/consent/">consent</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/consent-mode/">consent-mode</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/container/">container</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/container-export/">container-export</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/container-snippet/">container-snippet</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content/">content</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-blocker/">content-blocker</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-engagement/">content-engagement</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-grouping/">content-grouping</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-management/">content-management</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-management-system/">content-management-system</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-security-policy/">content-security-policy</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/content-strategy/">content-strategy</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/context/">context</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/conversion/">conversion</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cookie/">cookie</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cookiedomain/">cookiedomain</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cookies/">cookies</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/creative/">creative</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cross-domain/">cross-domain</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/cross-domain-tracking/">cross-domain-tracking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/csp/">csp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/css/">css</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/css-selectors/">css-selectors</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom/">custom</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-dimension/">custom-dimension</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-dimensions/">custom-dimensions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-html/">custom-html</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-html-tag/">custom-html-tag</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-html-tags/">custom-html-tags</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-javascript/">custom-javascript</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-metrics/">custom-metrics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/custom-templates/">custom-templates</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/customtask/">customtask</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/dan-wilkerson/">dan-wilkerson</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/dashboard/">dashboard</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/data-collection/">data-collection</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/data-layer/">data-layer</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/data-layer-variable/">data-layer-variable</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/data-model/">data-model</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/data-quality/">data-quality</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/datalayer/">datalayer</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/debug/">debug</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/debugging/">debugging</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/definition-of-success/">definition-of-success</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/developer/">developer</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/development/">development</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/digital-marketing/">digital-marketing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/document.write/">document.write</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/dom/">dom</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/duplicate/">duplicate</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/dynamic-content/">dynamic-content</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/easter-egg/">easter-egg</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ecommerce/">ecommerce</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/education/">education</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/element-visibility/">element-visibility</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/engagement/">engagement</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/enhanced-ecommerce/">enhanced-ecommerce</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/environments/">environments</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/errors/">errors</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/event/">event</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/event-listener/">event-listener</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/event-listeners/">event-listeners</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/eventcallback/">eventcallback</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/events/">events</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/excel/">excel</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/exceptions/">exceptions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/experimentation/">experimentation</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/exploit/">exploit</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/extension/">extension</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/facebook/">facebook</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/false/">false</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/fields-to-set/">fields-to-set</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/firebase/">firebase</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/firing-rules/">firing-rules</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/folders/">folders</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/form/">form</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/form-tracking/">form-tracking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/format-value/">format-value</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/forms/">forms</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ga-spy/">ga-spy</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ga4/">ga4</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gcp/">gcp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gdpr/">gdpr</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google/">google</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-analytics/">google-analytics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-analytics-4/">google-analytics-4</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-analytics-settings/">google-analytics-settings</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-cloud/">google-cloud</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-cloud-platform/">google-cloud-platform</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-optimize/">google-optimize</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-sheets/">google-sheets</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-tag-manager/">google-tag-manager</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/google-trends/">google-trends</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/googletagmanager/">googletagmanager</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/governance/">governance</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtag/">gtag</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtag.js/">gtag.js</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtm-sonar/">gtm-sonar</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtm-tools/">gtm-tools</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtm360/">gtm360</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/gtmtips/">gtmtips</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/guest-post/">guest-post</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/guide/">guide</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/hack/">hack</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/history/">history</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/history-change-trigger/">history-change-trigger</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/history-listener/">history-listener</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/hugo/">hugo</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/iframe/">iframe</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/intelligent-tracking-prevention/">intelligent-tracking-prevention</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/internal-traffic/">internal-traffic</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ios/">ios</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ip/">ip</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/it-department/">it-department</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/itp/">itp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/javascript/">javascript</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/jquery/">jquery</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/klipfolio/">klipfolio</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/learning/">learning</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/lighthouse/">lighthouse</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/links/">links</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/listeners/">listeners</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/local/">local</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/localstorage/">localstorage</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/lookup-table/">lookup-table</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/macros/">macros</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/marketer/">marketer</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/marketing/">marketing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/measurement-protocol/">measurement-protocol</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/meta-description/">meta-description</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/metrics/">metrics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/migration/">migration</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/mixcloud/">mixcloud</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/mobile/">mobile</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/modern-cms/">modern-cms</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/modular-architecture/">modular-architecture</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/monitor/">monitor</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/navigation/">navigation</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/netbooster/">netbooster</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/new-ui/">new-ui</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/node.js/">node.js</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/nodejs/">nodejs</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/non-technical/">non-technical</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/open-source/">open-source</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/opt-out/">opt-out</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/owasp/">owasp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/page-load-time/">page-load-time</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/page-timings/">page-timings</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/parameter-reporting/">parameter-reporting</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/penguin/">penguin</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/performance/">performance</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/permissions/">permissions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/persistence/">persistence</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/personal/">personal</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/personal-experience/">personal-experience</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/php/">php</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/pii/">pii</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/pitch/">pitch</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/plugins/">plugins</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/poetry/">poetry</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/postmessage/">postmessage</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/ppc/">ppc</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/preview/">preview</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/preview-mode/">preview-mode</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/privacy/">privacy</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/process/">process</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/public-speaking/">public-speaking</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/query-string/">query-string</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/queue-time/">queue-time</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/r/">r</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/race-condition/">race-condition</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/reaktor/">reaktor</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/recaptcha/">recaptcha</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/referral/">referral</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/regular-expression/">regular-expression</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/release/">release</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/resources/">resources</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/rules/">rules</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/safari/">safari</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/sales/">sales</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/samesite/">samesite</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/schema/">schema</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/score-card/">score-card</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/scroll-depth/">scroll-depth</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/search/">search</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/search-api/">search-api</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/search-engine-optimization/">search-engine-optimization</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/search-trends/">search-trends</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/security/">security</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/selection/">selection</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/seo/">seo</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/seo-report/">seo-report</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/serp/">serp</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/server-side-tagging/">server-side-tagging</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/session/">session</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/sessions/">sessions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/single-page-apps/">single-page-apps</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/site-search/">site-search</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/site-speed/">site-speed</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/slack/">slack</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/snippet/">snippet</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/snowplow/">snowplow</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/social-interactions/">social-interactions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/soundcloud/">soundcloud</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/spa/">spa</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/splash-page/">splash-page</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/static-site/">static-site</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/still-running/">still-running</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/storage/">storage</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/support/">support</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/swift/">swift</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/syntax-highlight/">syntax-highlight</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tag-management-solution/">tag-management-solution</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tag-management-solutions/">tag-management-solutions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tag-sequencing/">tag-sequencing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tag-templates/">tag-templates</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tags/">tags</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tasks/">tasks</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/technique/">technique</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/test/">test</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/testing/">testing</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/timer/">timer</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/timings/">timings</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tips/">tips</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tools/">tools</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tracker/">tracker</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/tracker-object/">tracker-object</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/training/">training</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/trigger/">trigger</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/trigger-groups/">trigger-groups</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/triggers/">triggers</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/troubleshoot/">troubleshoot</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/undefined/">undefined</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/universal-analytics/">universal-analytics</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/user-id/">user-id</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/user-interface/">user-interface</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/user-permissions/">user-permissions</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/user-timings/">user-timings</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/v2/">v2</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/variable/">variable</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/variable-templates/">variable-templates</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/variables/">variables</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/videos/">videos</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/visibility/">visibility</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/wcag/">wcag</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/weather/">weather</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/web-design/">web-design</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/web-development/">web-development</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/webkit/">webkit</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/website-redesign/">website-redesign</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/workflow/">workflow</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/workspaces/">workspaces</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/youtube/">youtube</a></li>
                
                    <li class="nav-opened" role="presentation"><a href="https://www.simoahava.com/amp/tags/zones/">zones</a></li>
                
                </div>
            </section>
        
        </amp-accordion>
    </ul>
</amp-sidebar>

<div class="site-wrapper">



    <header class="main-header post-head no-cover">
    <nav class="main-nav clearfix">


    <a class="menu-button" on="tap:sidebar.toggle" role="button"><i class="fa fa-bars" aria-hidden="true"></i><span class="menu-button-label">Menu</span></a>


  </nav>
</header>



<main class="content" role="main">

  <article class="post type-post">

    <header class="post-header">
        <h1 class="post-title">True View Ecommerce Impressions With Google Tag Manager</h1>
        <small>Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.</small>

        <section class="post-meta">
            


    




    <amp-img class="author-thumb" src="https://www.simoahava.com/images/simo.png" layout="fixed" width="24" height="24" alt="Author image"></amp-img>

Simo Ahava

in
    
        <a href="https://www.simoahava.com/amp/categories/analytics">Analytics</a>
    


on
    
        <a href="https://www.simoahava.com/amp/tags/google-tag-manager">#google tag manager</a>
    
        , <a href="https://www.simoahava.com/amp/tags/customtask">#customtask</a>
    
        , <a href="https://www.simoahava.com/amp/tags/enhanced-ecommerce">#enhanced ecommerce</a>
    


<time class="post-date" datetime="2019-01-21T11:36:08&#43;02:00">
    21 January 2019
</time>



        </section>
    </header>

    <section class="post-content">
      
        
        
          <blockquote>
<p><strong>Last updated 9 October 2020</strong>: <code>customTask</code> updated to a more stable version.</p>
</blockquote>
<p>I&rsquo;m a big fan of <a href="https://www.simoahava.com/amp/analytics/enhanced-ecommerce-guide-for-google-tag-manager/">Enhanced Ecommerce</a> in <a href="https://analytics.google.com/">Google Analytics</a>. In fact, I think it&rsquo;s the <strong>only</strong> valid way to deploy Ecommerce tracking today, especially when using <a href="https://tagmanager.google.com/">Google Tag Manager</a>. The ability to use a <a href="https://www.simoahava.com/amp/analytics/enhanced-ecommerce-guide-for-google-tag-manager/#send-the-data-to-google-analytics-using-a-custom-javascript-variable">Custom JavaScript variable</a> and the possibility to tackle the <em>full</em> ecommerce funnel are some of the benefits of using Enhanced Ecommerce.</p>
<p>However, tracking certain view-based events, <strong>impressions</strong> in particular, has a significant problem when it comes to how Google Analytics processes events. In a nutshell, when implemented by the book, <strong>impressions are sent for all the product impressions on the page when the page is loaded</strong>. In other words, you are collecting hits from impressions the user <em>might not actually have seen</em>.</p>
<p>This also compounds into a number of problems:</p>
<ul>
<li>
<p>Google Analytics has a maximum <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/limits-quotas#universal_properties">hits per session</a> of 500. And this is a hard limit. Anything past 500 will simply <strong>not be recorded</strong> in the session (though if you&rsquo;re using the paid GA360 you&rsquo;ll still be billed for them!). If you send each impression separately, or even if you send them in batches but don&rsquo;t discard the ones the user never saw, you might be approaching or going past this quota limit.</p>
</li>
<li>
<p>The <a href="https://www.simoahava.com/amp/analytics/automatically-reduce-google-analytics-payload-length/">maximum payload length</a> is <strong>8192 bytes</strong> for any GA request. This is easily surpassed if you&rsquo;re sending 50-60 impressions in a single hit.</p>
</li>
</ul>
<p>In this article, I want to tackle both of these problems by introducing a way of tracking <strong>only those impressions that were viewable in the browser viewport</strong>.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/true-view-impressions-google-tag-manager.jpg" title="true view impressions google tag manager">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/true-view-impressions-google-tag-manager.jpg" layout="responsive" alt="true view impressions google tag manager" height="2078" width="2408"></amp-img>
  
    </a>
  

<p>This solution is written for <strong>Google Tag Manager</strong>, as it utilizes a number of features that are built natively into the platform.</p>
<p>I&rsquo;m also going to use <a href="https://www.simoahava.com/amp/analytics/customtask-the-guide/"><code>customTask</code></a>, because I want to write the whole solution <a href="https://www.simoahava.com/amp/analytics/trigger-javascript-without-using-custom-html-tag/">without using a Custom HTML tag</a>.</p>
<!-- raw HTML omitted -->

        
        <article class="post type-simmer">
    <header class="post-header">
        <h2 class="post-title"><a href="https://www.simoahava.com/amp/newsletter/">The Simmer Newsletter</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
	Follow <a href="https://www.teamsimmer.com/newsletter/">this link</a> to subscribe to the <strong>Simmer Newsletter</strong>! Stay up-to-date with the latest content from Simo Ahava and the <a href="https://www.teamsimmer.com/">Simmer online course platform</a>.
      </p>
      </section>
</article>

        
          <h2 id="how-it-works">How it works</h2>
<p>The solution relies on the <a href="https://www.simoahava.com/amp/analytics/element-visibility-trigger-google-tag-manager/"><strong>Element Visibility trigger</strong></a> to identify impressions in the viewport and push them into a <strong>batch queue</strong>. A <a href="https://www.simoahava.com/amp/gtm-tips/timer-trigger/"><strong>Timer trigger</strong></a> is also used to purge the batch queue in case the user is inactive. Finally, if a user <strong>clicks</strong> on an impression, all the items in the batch queue are sent, as are they if the user leaves the page.</p>
<p>A <strong>batch queue</strong> is what we&rsquo;ll use to group the viewed impressions together into units of certain size, so that the request to GA is neither too crowded (risking going past the payload length limit) or too sparse (risking having too many hits in the session).</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/batched-impressions.jpg" title="Impressions in batches">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/batched-impressions.jpg" layout="responsive" alt="Impressions in batches" height="1718" width="1768"></amp-img>
  
    </a>
  

<p>Here&rsquo;s a simple flow of how the solution works:</p>
<ol>
<li>
<p>When the page is first loaded, an inventory of impression objects is built by identifying an <code>ecommerce.impressions</code> object in the <code>dataLayer</code>.</p>
</li>
<li>
<p>Every single product impression on the page itself will need to have an identifying attribute that links the product impression with the corresponding object in the <code>ecommerce.impressions</code> array in <code>dataLayer</code>. This should be something like <code>data-productid=&quot;impression1&quot;</code> where <code>impression1</code> is the ID of the impression.</p>
</li>
<li>
<p>The <strong>Element Visibility</strong> trigger waits for items with this <code>data-productid</code> to become visible on the page, adding each into a batch array of viewed impressions.</p>
</li>
<li>
<p>When the array length reaches the batch maximum you define, the impressions in the batch array are sent to GA and then deleted from the array (so that you don&rsquo;t end up sending them again).</p>
</li>
<li>
<p>If the user <strong>clicks</strong> a product impression on the page, a Product Click event is sent with that impression data together with <strong>all</strong> the items in the current batch queue.</p>
</li>
<li>
<p>Every 60 seconds (configurable), the batch queue is also emptied and sent to GA to avoid the impressions from being stuck in the queue for a long period of time if the user is inactive.</p>
</li>
<li>
<p>When the user leaves the current page, a custom <a href="https://www.simoahava.com/amp/analytics/fire-trigger-when-user-about-to-leave-page/"><code>beforeunload</code> listener</a> will also send any impressions left in the batch queue.</p>
</li>
</ol>
<p>The end result is that as impressions are viewed by the visitor, items are added to the batch queue and sent whenever the queue fills up. There are safeguards (timer, <code>beforeunload</code>) which ensure that items are never forgotten in the queue.</p>
<p>It&rsquo;s not trivial to set up, so let&rsquo;s get to it.</p>

        
          <h2 id="what-you-need">What you need</h2>
<p>First of all, you need a fairly solid understanding of what Enhanced Ecommerce impressions are, how they are (traditionally) tracked, and how they appear in your GA reports. This guide will <strong>not</strong> go over the basics. Check out my <a href="https://www.simoahava.com/amp/analytics/enhanced-ecommerce-guide-for-google-tag-manager/">Enhanced Ecommerce guide</a>, as well as Google&rsquo;s <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/enhanced-ecommerce">official support documentation</a> for more information.</p>
<p>For the solution to work &ldquo;out-of-the-box&rdquo;, you will need a <strong>properly formatted</strong> <code>ecommerce.impressions</code> object in the <code>dataLayer</code> deployed into the page template preferably <strong>before the GTM container snippet</strong>. This is what you should already have if you&rsquo;ve implemented Enhanced Ecommerce impressions <a href="https://developers.google.com/tag-manager/enhanced-ecommerce#product-impressions">by the book</a>.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/impressions-in-datalayer.jpg" title="Enhanced Ecommerce impressions in dataLayer">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/impressions-in-datalayer.jpg" layout="responsive" alt="Enhanced Ecommerce impressions in dataLayer" height="756" width="1778"></amp-img>
  
    </a>
  

<p>It&rsquo;s possible to modify the code so it works with objects with a different composition, and it&rsquo;s also possible to modify it to work with impressions scraped from the page. However, this guide will not tackle these edge cases. If you want to make these modifications yourself, feel free to do so (let me know in the comments if you need help).</p>
<p>Another thing you&rsquo;ll need is a way to tag all the HTML elements that contain impressions with the custom attribute that will link the impression to the corresponding <code>dataLayer</code> object. For example, this is what the first seven products on the page would look like if using the <code>impressions</code> data from the screenshot above:</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/data-productid-html.jpg" title="data-productid">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/data-productid-html.jpg" layout="responsive" alt="data-productid" height="466" width="1398"></amp-img>
  
    </a>
  

<p>As you can see, the value in <code>data-productid</code> corresponds with the individual <code>id</code> values in the <code>ecommerce.impressions</code> object.</p>
<p>You could add these dynamically using a Custom HTML tag and some DOM manipulation magic, but I do recommend doing this <strong>correctly</strong> from the start. Adding the attributes directly into template code prevent any race conditions from emerging, such as the Element Visibility trigger not identifying the items to which you dynamically added the new attributes.</p>
<p>Once you have the <code>dataLayer</code> object and the data attributes in place, you can get to work on the Google Tag Manager tags, triggers, and variables.</p>

        
          <h2 id="create-the-variables">Create the variables</h2>
<p>We&rsquo;re going to need a handful of variables. Two <strong>Lookup Table</strong> variables will handle some of the event tag logic. A <strong>Custom JavaScript</strong> variable for the <code>customTask</code> will be where most of the magic happens. Then, we&rsquo;ll also need a <strong>Custom JavaScript</strong> variable to handle the Enhanced Ecommerce object compilation.</p>
<p>There are many moving parts here, so let&rsquo;s get to work.</p>
<h3 id="lookup---get-impression-label">{{Lookup - Get Impression Label}}</h3>
<p>This <strong>Lookup Table variable</strong> will be used to populate the <strong>Event Label</strong> field of the tag we&rsquo;ll create label. As the label, i&rsquo;m using either &ldquo;Impression View&rdquo; or &ldquo;Impression Click&rdquo;, depending on what type of event caused the tag to fire. As you can guess, the tag will fire for both impressions views and clicks.</p>
<p>This is what the Lookup Table variable should look like:</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/lookup-impression-label.jpg" title="Lookup - impression label">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/lookup-impression-label.jpg" layout="responsive" alt="Lookup - impression label" height="822" width="1856"></amp-img>
  
    </a>
  

<h3 id="lookup---get-impression-interaction">{{Lookup - Get Impression Interaction}}</h3>
<p>This <strong>Lookup Table variable</strong> will return either <code>true</code> or <code>false</code>, depending on whether the hit was <em>non-interaction</em> or not. We&rsquo;ll create all <strong>impression views</strong> as non-interactive, and the <strong>product impression click</strong> will be interactive.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/lookup-impression-interaction.jpg" title="Lookup - impression noninteractive">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/lookup-impression-interaction.jpg" layout="responsive" alt="Lookup - impression noninteractive" height="812" width="1848"></amp-img>
  
    </a>
  

<h3 id="js---function---true-view-impression-handler">{{JS - Function - True view impression handler}}</h3>
<p>This is the main driving force of the solution. It&rsquo;s a <a href="https://www.simoahava.com/amp/analytics/customtask-the-guide/"><code>customTask</code></a> variable, designed to build the batch queue, to create the <code>beforeunload</code> handler, to allow hits to fire (when the batch queue is full or a product is clicked), and to block GA hits from being dispatched (if the impression was simply added to the queue).</p>
<p>Here&rsquo;s what the code in the <strong>Custom JavaScript</strong> variable should look like:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Configure the following
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">maxBatch</span>           <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
      <span class="nx">batchVariableName</span>  <span class="o">=</span> <span class="s1">&#39;_impressions_batch&#39;</span><span class="p">,</span>
      <span class="nx">productIdAttribute</span> <span class="o">=</span> <span class="s1">&#39;data-productid&#39;</span><span class="p">;</span>
  
  <span class="c1">// Do not touch anything below this
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">targetElement</span> <span class="o">=</span> <span class="p">{{</span><span class="nx">Click</span> <span class="nx">Element</span><span class="p">}},</span>
      <span class="nx">event</span>         <span class="o">=</span> <span class="p">{{</span><span class="nx">Event</span><span class="p">}};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">&#39;BODY&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetElement</span> <span class="o">=</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customModel</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Set up the beforeunload listener only when the tag is first run.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;beforeunload&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">dataLayer</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
          <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;sendFinalBatch&#39;</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="kd">var</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">batch</span>      <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">||</span> <span class="p">[],</span>
        <span class="nx">impressionId</span><span class="p">,</span> 
        <span class="nx">ost</span><span class="p">;</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.elementVisibility&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">impressionId</span> <span class="o">=</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">);</span>
      <span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">impressionId</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">batch</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">maxBatch</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;sendFinalBatch&#39;</span><span class="p">,</span> <span class="s1">&#39;gtm.timer&#39;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">batch</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">shouldFire</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ost</span> <span class="o">=</span> <span class="nx">customModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sendHitTask&#39;</span><span class="p">);</span>
      <span class="nx">customModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;sendHitTask&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sendModel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ost</span><span class="p">(</span><span class="nx">sendModel</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="nx">customModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;sendHitTask&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>First, modify the three variables in the beginning of the returned <code>function</code>.</p>
<ul>
<li>
<p>Set <code>maxBatch</code> to the maximum length of the batch queue. The default value of <code>10</code> is probably enough in most cases.</p>
</li>
<li>
<p>Set <code>batchVariableName</code> to what the global variable that stores the batch queue should be named. The default value is, again, probably OK, but you&rsquo;ll want to rename it in the rare case that a global variable named <code>_impressions_batch</code> already exists and is in use.</p>
</li>
<li>
<p>Set <code>productIdAttribute</code> to the HTML attribute name that stores the ID with each product HTML block on the page. The default value is <code>data-productid</code>, which means that the HTML structures that contain each product impression should have the attribute <code>data-productid=&quot;some_product_id&quot;</code> in one of the elements (preferably an element that wraps the entire impression).</p>
</li>
</ul>
<p>Let me tear this code apart and show you what each individual part does.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">&#39;BODY&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">targetElement</span> <span class="o">=</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This is a simple iterator which climbs up the element tree from the clicked element until it finds the element with the aforementioned product ID attribute.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;beforeunload&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">dataLayer</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">event</span><span class="o">:</span> <span class="s1">&#39;sendFinalBatch&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>When the <code>customTask</code> is fired for the first time on the page, a <code>beforeunload</code> listener is created. The idea is that when the user leaves the current page, the <code>beforeunload</code> event that is automatically dispatched triggers a <code>window.dataLayer.push()</code> call that we can then use to send the remaining items in the batch queue.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">batch</span>      <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">||</span> <span class="p">[],</span>
    <span class="nx">impressionId</span><span class="p">,</span> 
    <span class="nx">ost</span><span class="p">;</span>
</code></pre></div>
<p>By default, the <code>customTask</code> blocks the Google Analytics request from firing (<code>shouldFire = false</code>). Also, here we create the batch queue if one doesn&rsquo;t already exist.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.elementVisibility&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">impressionId</span> <span class="o">=</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">);</span>
  <span class="nx">batch</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">impressionId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">batch</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">maxBatch</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>If the tag was fired due to a visibility event, the product ID that triggered the event will be pushed into the batch queue. If the batch queue thus reaches its maximum length, <code>customTask</code> will allow the hit to fire.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">([</span><span class="s1">&#39;sendFinalBatch&#39;</span><span class="p">,</span> <span class="s1">&#39;gtm.timer&#39;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">batch</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    
<span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">shouldFire</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>
<p>If the trigger event was <code>sendFinalBatch</code> (i.e. the user is trying to leave the page) or <code>gtm.timer</code> (i.e. 60 seconds have passed since the previous timer event or page load) AND if the batch queue has items in it, the hit will be allowed to fire, thus clearing the batch queue and sending all the items within to GA.</p>
<p>If the trigger event was a click, meaning the user clicked a product impression, the GA request will be allowed to complete as well.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">shouldFire</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ost</span> <span class="o">=</span> <span class="nx">customModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;sendHitTask&#39;</span><span class="p">);</span>
  <span class="nx">customModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;sendHitTask&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sendModel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ost</span><span class="p">(</span><span class="nx">sendModel</span><span class="p">);</span>
    <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">});</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">customModel</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">customModel</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>If the GA hit is allowed to fire, the first part of the <code>if</code> clause will do just that. After the hit has been sent, the batch queue is cleared of all items.</p>
<p>If the GA hit was blocked, then the <code>else</code> clause will clear the model object thus effectively preventing the Google Analytics hit from being dispatched.</p>
<h3 id="js---get-true-view-object">{{JS - Get True View object}}</h3>
<p>This variable builds the Enhanced Ecommerce object when the tag fires. It&rsquo;s used to build both the impression <strong>view</strong> object and the impression <strong>click</strong> object.</p>
<p>So, create a <strong>Custom JavaScript</strong> variable, and put the following code within:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Configure the following:
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">maxBatch</span>           <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
      <span class="nx">batchVariableName</span>  <span class="o">=</span> <span class="s1">&#39;_impressions_batch&#39;</span><span class="p">,</span>
      <span class="nx">productIdAttribute</span> <span class="o">=</span> <span class="s1">&#39;data-productid&#39;</span><span class="p">;</span> 
  
  <span class="c1">// Do not touch anything below this
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">targetElement</span> <span class="o">=</span> <span class="p">{{</span><span class="nx">Click</span> <span class="nx">Element</span><span class="p">}},</span>
      <span class="nx">event</span>         <span class="o">=</span> <span class="p">{{</span><span class="nx">Event</span><span class="p">}},</span>
      <span class="nx">batch</span>         <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">batchVariableName</span><span class="p">],</span>
      <span class="nx">impressions</span>   <span class="o">=</span> <span class="nx">google_tag_manager</span><span class="p">[{{</span><span class="nx">Container</span> <span class="nx">ID</span><span class="p">}}].</span><span class="nx">dataLayer</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;ecommerce.impressions&#39;</span><span class="p">),</span>
      <span class="nx">ecomObj</span>       <span class="o">=</span> <span class="p">{</span><span class="nx">ecommerce</span><span class="o">:</span> <span class="p">{}};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">&#39;BODY&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetElement</span> <span class="o">=</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">latestImpression</span> <span class="o">=</span> <span class="nx">impressions</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">impression</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">impression</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">targetElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">productIdAttribute</span><span class="p">);</span>
  <span class="p">}).</span><span class="nx">shift</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">impressionsArr</span> <span class="o">=</span> <span class="nx">batch</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">impressions</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">impression</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">impression</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">shift</span><span class="p">();</span>
  <span class="p">});</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.elementVisibility&#39;</span><span class="p">){</span>
    <span class="nx">impressionsArr</span><span class="p">[</span><span class="nx">maxBatch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">latestImpression</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">ecomObj</span><span class="p">.</span><span class="nx">impressions</span> <span class="o">=</span> <span class="nx">impressionsArr</span><span class="p">;</span> 

  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;gtm.click&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ecomObj</span><span class="p">.</span><span class="nx">click</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">actionField</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">list</span><span class="o">:</span> <span class="nx">latestImpression</span><span class="p">.</span><span class="nx">list</span>
      <span class="p">},</span>
      <span class="nx">products</span><span class="o">:</span> <span class="p">[</span><span class="nx">latestImpression</span><span class="p">]</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">ecommerce</span><span class="o">:</span> <span class="nx">ecomObj</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>As you can see, you&rsquo;ll need to configure the <strong>exact</strong> same settings (<code>maxBatch</code>, <code>batchVariableName</code>, <code>productIdAttribute</code>) in the beginning of this script as you had to in the <a href="https://www.simoahava.com/amp/analytics/true-view-impressions-google-tag-manager/#js-function-true-view-impression-handler">previous Custom JavaScript variable</a>. It&rsquo;s important that these match <strong>exactly</strong> to the settings you configured earlier, so double-check to make sure they are the same.</p>
<p>Other than that, the purpose of the JavaScript is to compile the impression product IDs in the batch queue to the corresponding Enhanced Ecommerce objects. If the event was a click, then the impression that was clicked will be sent as the Product Click target.</p>

        
          <h2 id="create-the-triggers">Create the triggers</h2>
<p>We&rsquo;ll need a whopping <strong>four</strong> triggers all attached to the tag.</p>
<p>An <strong>Element Visibility</strong> trigger will handle building the batch queue from product impression views.</p>
<p>A <strong>Custom Event</strong> trigger will fire the tag when the user is trying to leave the page.</p>
<p>A <strong>Timer</strong> trigger will send the items in the batch queue periodically.</p>
<p>A <strong>Click</strong> trigger will fire the tag when the user clicks a product impression.</p>
<h3 id="the-element-visibility-trigger">The Element Visibility trigger</h3>
<p>The Element Visibility trigger will fire whenever a <strong>new</strong> product impression becomes visible. It will only fire once per element, which ensures that those elements for which an impression hit has already been sent won&rsquo;t get another impression sent while the user is on the page.</p>
<p>The Element Visibility trigger will be set to fire when any element with the give <strong>product ID attribute</strong> becomes visible. It&rsquo;s important that you use the <strong>same attribute name</strong> you used in the two Custom JavaScript variables created above. If the attribute name was, for example, <code>data-productid</code>, the CSS selector you&rsquo;d need to configure in the Element Visibility trigger should be <code>[data-productid]</code>. Check <a href="https://www.simoahava.com/amp/gtm-tips/10-useful-css-selectors/">this</a> if you need a refresher on CSS selectors.</p>
<p>Anyway, make sure the trigger looks like something like this (with the change in the CSS selector if needed):</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/visibility-trigger.jpg" title="Visibility trigger">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/visibility-trigger.jpg" layout="responsive" alt="Visibility trigger" height="1194" width="1842"></amp-img>
  
    </a>
  

<p>You can change the percentage of the element that needs to be visible if you wish.</p>
<h3 id="the-custom-event-trigger">The Custom Event trigger</h3>
<p>The Custom Event trigger is simple. It fires whenever the <code>beforeunload</code> listener (created in <a href="https://www.simoahava.com/amp/analytics/true-view-impressions-google-tag-manager/#js-function-true-view-impression-handler">the <code>customTask</code> variable</a>) is triggered by the user trying to leave the page.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/custom-event-trigger.jpg" title="Custom Event trigger">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/custom-event-trigger.jpg" layout="responsive" alt="Custom Event trigger" height="616" width="1844"></amp-img>
  
    </a>
  

<h3 id="the-timer-trigger">The Timer trigger</h3>
<p>The Timer trigger will dispatch the items in the queue when it goes off. It&rsquo;s a good backup to have, because otherwise you run the risk of items being left in the queue indefinitely, only to be dispatched when the user triggers another visibility event some time in the future. This might lead to hermit sessions, where the only hits are these impression view hits. Not very useful.</p>
<p>You can freely modify the settings of the trigger. Having it fire continuously isn&rsquo;t that big a deal. The Google Analytics tag will always fire, yes, but the <code>customTask</code> will make sure that no hit is actually built unless the batch queue actually has items in it.</p>
<p>As you can see, I also make sure that the timer trigger only fires on valid pages by checking if a Data Layer variable for the key <code>ecommerce.impressions</code> is not <code>undefined</code>. This way the trigger will only activate on pages where there&rsquo;s the possibility of viewing impressions. You can change the condition to something else if it makes more sense.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/timer-trigger.jpg" title="Timer trigger">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/timer-trigger.jpg" layout="responsive" alt="Timer trigger" height="932" width="1840"></amp-img>
  
    </a>
  

<h3 id="the-click-trigger">The Click trigger</h3>
<p>The Click trigger has a simple purpose. It fires when a product impression is clicked, thus sending a Product Click payload to Google Analytics (along with any impressions that might have been in the batch queue).</p>
<p>Remember to change the CSS selector to match the HTML attribute you use to encode the product ID for every product impression element on the page.</p>
<p>If you&rsquo;re curious about the <code>[data-productid], [data-productid] *</code> syntax, take a look at <a href="https://www.simoahava.com/amp/analytics/use-wildcard-css-selectors-with-all-elements-triggers/">this article</a>.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/click-trigger.jpg" title="Click trigger">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/click-trigger.jpg" layout="responsive" alt="Click trigger" height="488" width="1842"></amp-img>
  
    </a>
  


        
          <h2 id="create-the-tag">Create the tag</h2>
<p>Finally, the tag itself. Now that you have all the necessary variables and triggers created, it&rsquo;s just a question of putting them all together in the tag.</p>
<p>Feel free to modify what you send with <strong>Event Category</strong>, <strong>Event Action</strong>, and <strong>Event Label</strong>.</p>
<p>Make sure you have the <code>transport</code> field set to <code>beacon</code>, since you&rsquo;ll want those <code>beforeunload</code> hits to be sent <a href="https://www.simoahava.com/amp/analytics/fire-trigger-when-user-about-to-leave-page/#set-the-transport-field-in-google-analytics-tags">even if the page has already been unloaded</a>.</p>
<ul>
<li>
<p><strong>Tag Type</strong>: Universal Analytics</p>
</li>
<li>
<p><strong>Track Type</strong>: Event</p>
</li>
<li>
<p><strong>Category</strong>: Ecommerce</p>
</li>
<li>
<p><strong>Action</strong>: Impressions</p>
</li>
<li>
<p><strong>Label</strong>: {{Lookup - Get Impression Label}}</p>
</li>
<li>
<p><strong>Non-Interaction Hit</strong>: {{Lookup - Get Impression Interaction}}</p>
</li>
<li>
<p><strong>Enable overriding settings in this tag</strong>: Checked</p>
</li>
<li>
<p><strong>Tracking ID</strong>: UA-XXXXXX-Y</p>
</li>
<li>
<p><strong>Fields to Set</strong>:<br>
&ndash; <strong>Field Name</strong>: <code>customTask</code>, <strong>Value</strong>: {{JS - Function - True view impression handler}}<br>
&ndash; <strong>Field Name</strong>: <code>transport</code>, <strong>Value</strong>: <code>beacon</code></p>
</li>
<li>
<p><strong>Enable Enhanced Ecommerce Features</strong>: True<br>
&ndash; <strong>Read Data from Variable</strong>: {{JS - Get True View object}}</p>
</li>
</ul>


    <a href="https://www.simoahava.com/amp/images/2019/01/impression-event-tag-1.jpg" title="Impression event tag">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/impression-event-tag-1.jpg" layout="responsive" alt="Impression event tag" height="1856" width="1844"></amp-img>
  
    </a>
  

<p>Finally, add all four triggers created in the previous chapter to this tag.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/impression-event-tag-2.jpg" title="Impression event tag 2">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/impression-event-tag-2.jpg" layout="responsive" alt="Impression event tag 2" height="694" width="1834"></amp-img>
  
    </a>
  

<p>And you&rsquo;re all set! Then it&rsquo;s time to test things out.</p>

        
          <h2 id="how-to-test">How to test</h2>
<p>It&rsquo;s important <strong>not</strong> to rely on Google Tag Manager&rsquo;s debug mode to test this out. Why? Because even if it says that a Google Analytics tag has fired, it&rsquo;s <code>customTask</code> that governs whether the request was completed or not.</p>
<p>So, I recommend you install David Vallejo&rsquo;s excellent <a href="https://chrome.google.com/webstore/detail/gtmga-debug/ilnpmccnfdjdjjikgkefkcegefikecdc?hl=en">GTM/GA Debug</a> extension. It shows you what hits are actually sent to Google Analytics, and it has an excellent Enhanced Ecommerce tab for seeing exactly what impressions are dispatched.</p>
<h3 id="test-the-batch-queue-first">Test the batch queue first</h3>
<p>When a page with impression loads, test how your batch queue works.</p>
<p>You should see one <code>gtm.elementVisibility</code> event in the Debug mode panel for every product impression you see in the viewport of the page. These events should not dispatch the hit to GA <strong>until you reach the same number of visibility events as the maximum queue size</strong>.</p>
<p>So if you&rsquo;ve configured the <code>maxBatch</code> in the Custom JavaScript variables to 10, then the first nine <code>gtm.elementVisibility</code> events should do nothing, but the tenth one should fire an Impressions hit with ten impressions within. And after that, every tenth visibility event should send another batch, etc.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/impression-views-test.jpg" title="Impression views test">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/impression-views-test.jpg" layout="responsive" alt="Impression views test" height="1040" width="1862"></amp-img>
  
    </a>
  

<h3 id="test-with-a-timer">Test with a timer</h3>
<p>Next, make sure you have some Element Visibility triggers fired after the previous batch has been sent, but not enough to send another batch. In other words, you want the queue to contain some impressions, but not enough to trigger a batch dispatch.</p>
<p>Then, wait for the Timer trigger to go off. It will fire as soon as the interval is reached. In this guide, I&rsquo;m using a 60 second interval, so within one minute of the page load the trigger should fire. When the trigger fires, it should send the items in the batch queue as an impression hit. The number of impressions should be less than what would be sent if the queue filled up.</p>
<p>For example, here the batch queue limit has been reached twice, sending two sets of three impressions to Google Analytics. The third impression hit with just one impression is due to the timer trigger sending the remaining impression.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/timer-test.jpg" title="Timer test">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/timer-test.jpg" layout="responsive" alt="Timer test" height="1040" width="1708"></amp-img>
  
    </a>
  

<h3 id="test-a-product-click">Test a product click</h3>
<p>Again, scroll until the queue has items but not enough to fill the queue up to its maximum length. Then, click one product impression. What you should see is an Enhanced Ecommerce hit with the Product Click details of the impression that was clicked, <strong>and a list of impression views that were in the queue</strong>.</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/click-test.jpg" title="Click trigger test">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/click-test.jpg" layout="responsive" alt="Click trigger test" height="624" width="2350"></amp-img>
  
    </a>
  

<h3 id="test-the-beforeunload-listener">Test the <code>beforeunload</code> listener</h3>
<p>Finally, scroll until the queue has items but not enough to fill the queue. Then, click a link away from the current page (not a product impression!). Using the GTM/GA Debug extension, you should see the hits for the previous page including an impression view hit with some impressions (less than the maximum queue length):</p>


    <a href="https://www.simoahava.com/amp/images/2019/01/beforeunload-test.jpg" title="Beforeunload test">
  
    <amp-img src="https://www.simoahava.com/amp/images/2019/01/beforeunload-test.jpg" layout="responsive" alt="Beforeunload test" height="516" width="1966"></amp-img>
  
    </a>
  


        
          <h2 id="final-words">Final words</h2>
<p>This is a fairly simple implementation. The &ldquo;catch&rdquo; is that it doesn&rsquo;t use a Custom HTML tag. Everything is handled through a single Universal Analytics tag, utilizing the power of <code>customTask</code> to get the work done.</p>
<p>It&rsquo;s not perfect. Without a Custom HTML tag, you&rsquo;ll need to use the default Timer trigger which leaves a lot to be desired. For example, optimally I&rsquo;d want to create a custom timer that would let me reset it whenever the batch queue is cleared and the first new item is added. That way the timer would not fire needlessly on the page. This isn&rsquo;t really doable in the <code>customTask</code> - you would need a Custom HTML tag to do it.</p>
<p>And why not use a Custom HTML tag? For one, this is a fun exercise to do. The other reason is that GTM has a fairly robust thing going on with the Element Visibility trigger, and I want to make use of it without polluting the page with numerous Custom HTML tags; one for every product impression found by the Element Visibility trigger.</p>
<p>Some might also consider the prerequisites unreasonable. Being forced to have an Enhanced Ecommerce <code>dataLayer</code> object AND the HTML elements decorated with custom data attributes might seem like too much work. It&rsquo;s a lot of work, but not <strong>too much</strong> work. Tracking impressions reliably by utilizing the Element Visibility trigger requires a strong link between the items on the page and those in the <code>dataLayer</code>. You could build your own custom system to support DOM scraping and custom <code>dataLayer</code> object compositions, but I&rsquo;ll leave that to your capable hands.</p>
<p>Anyway, I hope you found this guide inspiring. Let me know in the comments what you think!</p>

        
      
    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="https://www.simoahava.com/amp/"></a>
    </figure>
    

    
    
    
        
    
    

    <section class="author">
      <h4>Simo Ahava</h4>
      
        <p>Husband | Father | Analytics developer</p>
      
      <div class="author-meta">
        <span class="author-location icon-location">Espoo, Finland</span>
        <span class="author-link icon-link"><a href="https://www.simoahava.com/">https://www.simoahava.com/</a></span>
      </div>
    </section>


    
    <div class="social">

<amp-social-share type="twitter"
  width="60"
  height="44"> </amp-social-share>





<amp-social-share type="linkedin"
                  width="60"
                  height="44"></amp-social-share>


    <amp-social-share type="facebook"
                      width="60"
                      height="44"></amp-social-share>

</div>


    
  </footer>
</article>

</main>
</div>

</body>
</html>

