

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Create A Cookie Rewrite Web Service Using The Google Cloud Platform | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/06\/safari-cookies.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/google-cloud\/create-cookie-rewrite-web-service-google-cloud\/",
  "datePublished": "2019-06-12T07:00:00\u002b03:00",
  "dateModified": "2019-06-12T07:00:00\u002b03:00",
  "description": "Create a simple web service on Google Cloud App Engine, which digests POST requests and uses the data to return new cookies in a Set-Cookie header.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Create A Cookie Rewrite Web Service Using The Google Cloud Platform | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
    
    <meta name="description" content="Create a simple web service on Google Cloud App Engine, which digests POST requests and uses the data to return new cookies in a Set-Cookie header.">
    <meta property="og:description" content="Create a simple web service on Google Cloud App Engine, which digests POST requests and uses the data to return new cookies in a Set-Cookie header.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Create A Cookie Rewrite Web Service Using The Google Cloud Platform">
    <meta property="og:url" content="https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Create A Cookie Rewrite Web Service Using The Google Cloud Platform">
    <meta name="twitter:description" content="Create a simple web service on Google Cloud App Engine, which digests POST requests and uses the data to return new cookies in a Set-Cookie header.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/06/safari-cookies.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/06/safari-cookies.jpg">
    


    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Create A Cookie Rewrite Web Service Using The Google Cloud Platform
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-06-12T07:00:00&#43;03:00">
        
  June 12, 2019

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/google-cloud">Google Cloud</a>
    
  


      | <a href="https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <blockquote>
<p><strong>Last updated 11 September 2020</strong>: Added <a href="#step-4-map-the-custom-domain-to-the-endpoint">important note</a> about how the custom domain should be mapped with A/AAAA DNS records rather than a CNAME record.</p>
</blockquote>
<p>Ah, Safari&rsquo;s <a href="https://webkit.org/blog/category/privacy/">Intelligent Tracking Prevention</a> - the gift that <a href="https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">keeps on giving</a>. Having almost milked this cow for all it&rsquo;s worth, I was sure there would be little need to revisit the topic. Maybe, I thought, it would be better to just sit back and watch the world burn.</p>
<p>But then Mr. <a href="https://www.linkedin.com/in/charlesfarina">Charles Farina</a>, a good friend and so amicable he&rsquo;s practically Canadian, tempted me into testing out a quick proof-of-concept web service that would give us back our first party cookies.</p>
<p>As it turns out, it&rsquo;s not all that time-consuming to do and it works pretty nicely. Want proof? Visit this site with Safari, and check the expiration of the <code>_ga</code> cookie. Cool, huh?</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/safari-cookies.jpg" title="Cookies in Safari">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/safari-cookies.jpg#ZgotmplZ" alt="Cookies in Safari" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1860 354'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In this article, I&rsquo;ll show you how to set it up.</p>
<p>The article will focus on the <code>_ga</code> cookie used by Google Analytics, but the same method can be used for any first-party cookie set by JavaScript libraries running on your site.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/cmRrSeR51tc?enablejsapi=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>You can also follow the steps outlined in this article by watching the <a href="https://www.youtube.com/watch?v=cmRrSeR51tc">video</a> above.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[–hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#but-why">But why?</a></li>
    <li><a href="#how-does-it-work">How does it work?</a></li>
    <li><a href="#what-youll-need">What you&rsquo;ll need</a></li>
    <li><a href="#step-1-set-up-google-cloud">Step 1: Set up Google Cloud</a></li>
    <li><a href="#step-2-clone-the-github-repository">Step 2: Clone the GitHub repository</a></li>
    <li><a href="#step-3-create-and-deploy-the-app-engine-application">Step 3: Create and deploy the App Engine application</a></li>
    <li><a href="#step-4-map-the-custom-domain-to-the-endpoint">Step 4: Map the custom domain to the endpoint</a></li>
    <li><a href="#step-5-test-in-the-browser">Step 5: Test in the browser</a></li>
    <li><a href="#step-6-modify-google-analytics-tags">Step 6: Modify Google Analytics tags</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#i-dont-see-any-requests-to-trackermywebservicecom">I don&rsquo;t see any requests to tracker.mywebservice.com</a></li>
        <li><a href="#i-see-a-request-to-trackermywebservicecom-but-it-fails">I see a request to tracker.mywebservice.com but it fails</a></li>
        <li><a href="#i-see-the-set-cookie-header-but-the-cookie-expiration-doesnt-change">I see the Set-Cookie header but the cookie expiration doesn&rsquo;t change</a></li>
        <li><a href="#i-have-problems-setting-up-the-app-engine-application-or-something-else">I have problems setting up the App Engine application or something else</a></li>
      </ul>
    </li>
    <li><a href="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="but-why">But why?</h2>
<p>With ITP 2.1, Safari caps first party cookies written with JavaScript to a <a href="https://webkit.org/blog/8613/intelligent-tracking-prevention-2-1/">maximum 7-day expiration</a>. The <a href="https://analytics.google.com/">Google Analytics</a> library writes its cookie with JavaScript. Ergo, on Safari, the Google Analytics cookie persists user data for only 7 days at a time, meaning if the user visits the site with more than 7 days between visits, they will be considered a new user in their return visit.</p>
<p>With <a href="https://webkit.org/blog/8828/intelligent-tracking-prevention-2-2/">ITP 2.2</a>, expiration of some cookies is set to 24 hours.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2019/06/itp-2-2.jpg" title="From https://webkit.org/blog/8828/intelligent-tracking-prevention-2-2/">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/itp-2-2.jpg#ZgotmplZ" alt="From https://webkit.org/blog/8828/intelligent-tracking-prevention-2-2/" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1562 584'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">From https://webkit.org/blog/8828/intelligent-tracking-prevention-2-2/</span>
  
</div>


<p>However, Safari does <strong>not</strong> (currently) cap cookies set with the <code>Set-Cookie</code> HTTP header. Why? Because creating a setup that makes use of the <code>Set-Cookie</code> header requires developer resources and is always a <strong>deliberate</strong> decision how to handle first-party persistence.</p>
<p>ITP&rsquo;s main beef is against third-party JavaScript libraries executing code that repurposes first-party storage for something other than first-party data collection (namely, <a href="https://webkit.org/blog/8613/intelligent-tracking-prevention-2-1/">cross-site tracking</a>).</p>
<p>So when you have a site deliberately building or using a web service which requires the extension of resources to things like the creation of new DNS records, I guess Safari thinks that by doing all this work, you&rsquo;re accepting responsibility for any of the scummy things that can be done on top of such a setup.</p>
<p>But I don&rsquo;t care about any of that. I just want to tackle the problem itself and then share the solution.</p>

                
                  <h2 id="how-does-it-work">How does it work?</h2>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/process-diagram.jpg" title="Process">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/process-diagram.jpg#ZgotmplZ" alt="Process" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2976 1494'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>I&rsquo;ve been at this blog for more than six years now, and my skills at drawing a process diagram or flowchart are just getting worse and worse. Sorry about the mess above.</p>
<p>Here&rsquo;s how the setup works:</p>
<ol>
<li>
<p>When the user loads a page, a Google Analytics tracker is generated with the first GA event.</p>
</li>
<li>
<p>This tracker checks if the browser has the <code>_ga</code> cookie. If not, a new one is generated.</p>
</li>
<li>
<p>If the URL has <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cross-domain">cross-domain linker parameters</a> and the tracker has the <code>allowLinker:true</code> field, then the tracker will use those parameters to update the <code>_ga</code> cookie.</p>
</li>
<li>
<p>Since this cookie is generated with JavaScript, it&rsquo;s susceptible to ITP 2.1. Thus, in the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/sending-hits#hitcallback"><code>hitCallback</code></a> of the Page View tag, the web service is called with a request to return a cookie named <code>_ga</code> with the value from the cookie generated by analytics.js.</p>
</li>
<li>
<p>The web service returns this in the <code>Set-Cookie</code> header, and thus the <code>_ga</code> cookie is updated as an HTTP cookie, ignoring the impact of ITP 2.1 and ITP 2.2.</p>
</li>
</ol>
<p>The only way the above works smoothly is by adding the new (and poorly documented) <code>cookieUpdate</code> field to the tag settings. This field ensures that the tracker does <strong>not</strong> update the expiration of the cookie if one is found. This is instrumental, as otherwise each time a tracker is initialized the cookie is updated from an HTTP cookie back to a JavaScript cookie.</p>

                
                  <h2 id="what-youll-need">What you&rsquo;ll need</h2>
<p>For the solution to work, you&rsquo;ll need the following:</p>
<ol>
<li>
<p>A <strong>credit card</strong>, since you won&rsquo;t be able to efficiently create a Google Cloud Project without using a billing account.</p>
</li>
<li>
<p>A domain for which you have full access to <strong>DNS settings</strong>. This domain must share the same root/parent as the domain from where you&rsquo;ll be sending requests to the web service. So if your site is at <strong><a href="http://www.website.com">www.website.com</a></strong>, the domain you&rsquo;ll set up as the web service must be a subdomain of (or the actual domain) <strong>website.com</strong>.</p>
</li>
<li>
<p>Necessary access to modify the settings of every single Google Analytics tag that fires on the site.</p>
</li>
</ol>
<p>The domain mapping is important. Since the web service uses the <code>Set-Cookie</code> header to set the cookie, it can only do so in a first-party context if the header sets the cookie on a hostname shared by both the domain from where the request is originating (e.g. <strong><a href="http://www.website.com">www.website.com</a></strong>) and the domain you have mapped to the web service (e.g. <strong>tracker.website.com</strong>).</p>

                
                  <h2 id="step-1-set-up-google-cloud">Step 1: Set up Google Cloud</h2>
<p>First, visit <a href="https://console.cloud.google.com/billing">Billing management</a> with your favorite Google ID and create a new Billing Account for your Google Cloud organization or project. If you already have billing accounts setup, you can skip this step. You&rsquo;ll need to add your credit card details for situations where you blow past the free quotas. Don&rsquo;t worry! You can add <a href="https://cloud.google.com/billing/docs/how-to/budgets">budgets</a> to your billing account to avoid surprises.</p>
<p>Next, visit <a href="https://console.cloud.google.com/cloud-resource-manager">the Google Cloud console</a> with the same login, and click to <strong>Create project</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/create-cloud-project.jpg" title="Create new project">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/create-cloud-project.jpg#ZgotmplZ" alt="Create new project" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1492 1116'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Give the project a name and make sure to <strong>EDIT</strong> the ID so that it&rsquo;s easier to remember / handle. You&rsquo;ll be prompted to add a billing account to the project, so choose the one you just created, or whatever account you want to use.</p>
<p>Next, visit <a href="https://console.cloud.google.com/apis/api/cloudbuild.googleapis.com/overview">https://console.cloud.google.com/apis/api/cloudbuild.googleapis.com/overview</a> and click <strong>Enable API</strong> to enable the Cloud Build API. We&rsquo;ll need this to upload our configurations to the cloud.</p>
<p>Finally, go to <a href="https://cloud.google.com/sdk/install">https://cloud.google.com/sdk/install</a> and follow the steps. You&rsquo;ll want to install the Google Cloud SDK so that you can run most of the necessary commands from the command line.</p>
<p>After installing the SDK, run <code>gcloud init</code> in your terminal or command-line program. This will initialize the Google Cloud SDK for you, and it will let you choose which project to activate (choose the one you created earlier in this chapter).</p>

                
                  <h2 id="step-2-clone-the-github-repository">Step 2: Clone the GitHub repository</h2>
<p>First, make sure you have the <code>git</code> client <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">installed</a>. I&rsquo;m using the command-line client in these examples, but feel free to use a GUI (graphical user interface) client if you wish.</p>
<p>Once the <code>git</code> client is installed, run <code>git clone https://github.com/sahava/cookie-bouncer-service.git</code> in a directory of your choice to clone the source code to your computer.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/git-clone-done.jpg" title="git clone done">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/git-clone-done.jpg#ZgotmplZ" alt="git clone done" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2212 434'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Let&rsquo;s recap.</p>
<ul>
<li>
<p>You have created a <strong>Google Cloud Platform</strong> project, linked to a <strong>Billing account</strong> with the <strong>Cloud Build API</strong> enabled.</p>
</li>
<li>
<p>You have installed the Google Cloud SDK, and you have initialized it with the same login you used to create the Google Cloud project, and you&rsquo;ve configured it to set your new project as the active project.</p>
</li>
<li>
<p>You have cloned the GitHub repository.</p>
</li>
</ul>

                
                  <h2 id="step-3-create-and-deploy-the-app-engine-application">Step 3: Create and deploy the App Engine application</h2>
<p>Your next step is to create an <strong>App Engine</strong> application. <a href="https://cloud.google.com/appengine/">App Engine</a> is Google&rsquo;s fully managed, serverless application platform. It&rsquo;s like a light-weight virtual machine environment, where Google handles things like scaling and instance generation for you.</p>
<p>The web service we&rsquo;ll create in this exercise will run on the App Engine Standard environment.</p>
<p>While in the folder where you cloned the Git repository, run the following command:</p>
<p><code>gcloud app create</code></p>
<p>This will initiate the App Engine creation process. It will ask you for a <strong>region</strong>, so choose one that is geographically close to your location, and make sure it supports the <strong>standard</strong> environment.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/app-create.jpg" title="App Engine create app">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/app-create.jpg#ZgotmplZ" alt="App Engine create app" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1484 936'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Next, open the file <code>app.js</code> for editing, and find the lines containing <code>const allowedHosts = [...]</code>. In this array, you need to add all the hostnames <strong>from which</strong> you expect to call the web service. Remember, they must share the root domain with all the custom domains you&rsquo;ll map to the web service. For example, on my site I only intend to call the web service from <code>https://www.gtmtools.com</code> and any of its pages, so I would simply add:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> allowedHosts = [
  <span style="color:#a50">&#39;https://www.gtmtools.com&#39;</span>
];
</code></pre></div>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/app-js-config.jpg" title="App.js config">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/app-js-config.jpg#ZgotmplZ" alt="App.js config" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1242 752'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>If I also wanted to map something like <code>service.simoahava.com</code> to the App Engine service (yes, you can add multiple domains), I could also add <code>https://www.simoahava.com</code> to the list of allowed origins.</p>
<p>Next, run:</p>
<p><code>gcloud app deploy</code></p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/gcloud-app-deploy.jpg" title="gcloud app deploy">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/gcloud-app-deploy.jpg#ZgotmplZ" alt="gcloud app deploy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1400 846'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>It will deploy the App Engine application using the source code from the repository. <strong>Note!</strong> You <strong>must</strong> be in the folder with the <code>app.yaml</code> file from the repository for this command to work.</p>
<p>Soon it will tell you that everything is running. You can then type <code>gcloud app browse</code> to automatically open a browser window in the application root. If it works, you should see a warning that GET requests are not supported.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/get-works.jpg" title="GET request doesn&#39;t work">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/get-works.jpg#ZgotmplZ" alt="GET request doesn&#39;t work" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1144 412'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The reason it complains about GET is because the endpoint isn&rsquo;t configured to handle GET requests. It&rsquo;s only meant to handle POST requests.</p>
<p>You&rsquo;re almost done with the web service. The one piece of the puzzle that&rsquo;s missing is to map the web service to your custom domain, so that it can set cookies on your site with the <code>Set-Cookie</code> header.</p>

                
                  <h2 id="step-4-map-the-custom-domain-to-the-endpoint">Step 4: Map the custom domain to the endpoint</h2>
<p>Browse to <a href="https://console.cloud.google.com/appengine/settings/domains">https://console.cloud.google.com/appengine/settings/domains</a> and make sure you&rsquo;ve got your App Engine project selected.</p>
<p>Click <strong>Add a custom domain</strong> to get the domain verification process started.</p>
<p>From the <strong>Select the domain you want to use</strong>, choose <strong>Verify a new domain</strong>, and type the domain name into the respective field. Click <strong>Verify</strong>.</p>
<blockquote>
<p><strong>NOTE!</strong> It&rsquo;s important that you <strong>verify</strong> the subdomain that you want to use, rather than add a new subdomain to an already verified &ldquo;naked&rdquo; domain. The difference is that with the first option you need to set A/AAAA DNS records, and with the second option you need to set a CNAME record. With <a href="https://bugs.webkit.org/show_bug.cgi?id=215201">upcoming changes</a> to Safari, it&rsquo;s important that <strong>you do not use a CNAME record for this</strong>, as it negates the benefit of the entire solution.</p>
</blockquote>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/verify-new-domain.jpg" title="Verify new domain">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/verify-new-domain.jpg#ZgotmplZ" alt="Verify new domain" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1294 970'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>It will shuttle you off to something that looks very much like Google Search Console&rsquo;s domain verification screen. You&rsquo;ll need to verify that you own the domain you are trying to map to App Engine.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/verify-domain.jpg" title="Verify domain in GSC">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/verify-domain.jpg#ZgotmplZ" alt="Verify domain in GSC" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1570 846'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>For example, I&rsquo;m using <a href="https://www.godaddy.com/">GoDaddy</a> as my service provider, so it&rsquo;s easy to just follow the instructions and add the necessary <strong>TXT record</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/txt-record.jpg" title="TXT record">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/txt-record.jpg#ZgotmplZ" alt="TXT record" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1802 486'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once you&rsquo;ve done the change, you&rsquo;ll need to wait for the DNS record to propagate. Sometimes it happens really fast, sometimes it can take hours. So just stay in the verification page, and click <strong>Verify</strong> every now and then to see if the TXT records have been updated.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/add-tracker-gtmtools.jpg" title="Add domain">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/add-tracker-gtmtools.jpg#ZgotmplZ" alt="Add domain" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 894 474'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once the domain is verified, you can click forward in the steps to add a custom domain to the App Engine project. Google will issue a free SSL certificate for the domain, securing the endpoint itself behind HTTPS.</p>
<p>In the last step, <strong>Update your DNS records to enable security</strong>, it will list you a number of <code>A</code> and <code>AAAA</code> records you&rsquo;ll need to add to your DNS settings for the host you want to map to App Engine. For example, in my example of <code>tracker.gtmtools.com</code>, I get the following records:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/add-dns-records.jpg" title="Add DNS records">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/add-dns-records.jpg#ZgotmplZ" alt="Add DNS records" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1270 940'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In GoDaddy, I&rsquo;ve now added them as instructed:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/godaddy-records.jpg" title="Configure A AAAA records">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/godaddy-records.jpg#ZgotmplZ" alt="Configure A AAAA records" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2084 1230'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Now, again, it&rsquo;s a question of just waiting for the records to propagate. Once everything works, typically well within 24 hours of making the changes, you should be able to visit <code>https://tracker.yourdomain.com</code>, i.e. the custom domain you just mapped, and it should return the similar GET error you saw when visiting the App Engine endpoint directly.</p>

                
                  <h2 id="step-5-test-in-the-browser">Step 5: Test in the browser</h2>
<p>Now it&rsquo;s time to do a quick browser test. Browse to one of the domains that you configured in <code>app.js</code> in the <code>allowedHosts</code> array (see <a href="#step-3-create-and-deploy-the-app-engine-application">this chapter</a> for a refresher). Use the Safari browser.</p>
<p>Then, open the <strong>JavaScript Console</strong> - that&rsquo;s CMD-OPT-C on a Mac, but you can also find it in the <a href="http://osxdaily.com/2011/11/03/enable-the-develop-menu-in-safari/">Develop menu</a>.</p>
<p>In the console, copy-paste this code. You need to change the value of the <code>endpoint</code> variable to the web service domain you configured in the App Engine domain mappings, and you need to change the value of the <code>domain</code> variable to match the root domain your site and the endpoint have in common.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> endpoint = <span style="color:#a50">&#39;https://tracker.gtmtools.com&#39;</span>;
<span style="color:#00a">const</span> domain = <span style="color:#a50">&#39;gtmtools.com&#39;</span>;
<span style="color:#00a">const</span> xhr = <span style="color:#00a">new</span> XMLHttpRequest();
xhr.open(<span style="color:#a50">&#39;POST&#39;</span>, endpoint);
xhr.setRequestHeader(<span style="color:#a50">&#39;Content-Type&#39;</span>, <span style="color:#a50">&#39;application/json&#39;</span>);
xhr.withCredentials = <span style="color:#00a">true</span>;
xhr.send(JSON.stringify({name: <span style="color:#a50">&#39;testCookie&#39;</span>, value: <span style="color:#a50">&#39;testValue&#39;</span>, options: {domain: domain, maxAge: <span style="color:#099">1000</span>*<span style="color:#099">60</span>*<span style="color:#099">60</span>*<span style="color:#099">24</span>*<span style="color:#099">365</span>*<span style="color:#099">2</span>}}));
</code></pre></div>
<p>This generates a POST request to the endpoint you have configured, and it instructs the web service to return a cookie named <code>testCookie</code> with value <code>testValue</code>, written on the root domain. Since you don&rsquo;t provide an expiration, the cookie will have an expiration of two years.</p>
<p>If all worked out, you should see the POST request come back with a response saying the cookie was processed. Also, the response should have a proper <code>Set-Cookie</code> header. Finally, the cookie should appear in the Storage section of Safari&rsquo;s developer console.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/it-works-1.jpg" title="HTTP response">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/it-works-1.jpg#ZgotmplZ" alt="HTTP response" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2294 638'%3E%3C/svg%3E">
  
    </a>
  
  
</div>





<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/it-works-2.jpg" title="HTTP headers">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/it-works-2.jpg#ZgotmplZ" alt="HTTP headers" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2098 470'%3E%3C/svg%3E">
  
    </a>
  
  
</div>





<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/it-works-3.jpg" title="Cookie in storage">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/it-works-3.jpg#ZgotmplZ" alt="Cookie in storage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2040 488'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>So <strong>that&rsquo;s how you create first-party cookies with no expiration limitations in Safari post-ITP-2.1!</strong>.</p>
<p>But let&rsquo;s check out the final step - how to enable this in Google Analytics.</p>

                
                  <h2 id="step-6-modify-google-analytics-tags">Step 6: Modify Google Analytics tags</h2>
<p>To make the <code>_ga</code> cookie work with the web service, you need to do two things.</p>
<ol>
<li>
<p>Add the <code>cookieUpdate</code> field with value <code>false</code> to <strong>every single Google Analytics tag firing on the page</strong>. This is absolutely necessary. If there&rsquo;s even a single GA tag that doesn&rsquo;t have this field (and shares the cookie settings with your tags that DO have the field), the JavaScript cookie will keep on overwriting the cookie set in the HTTP response.</p>
</li>
<li>
<p>Add a <code>hitCallback</code> field and variable to your Page View tag (or whatever tag fires on every single page) that handles the actual logic.</p>
</li>
</ol>
<p>The first step is easy. Just use a <a href="https://www.simoahava.com/analytics/google-analytics-settings-variable-in-gtm/">Google Analytics Settings variable</a> or, alternatively, add the field manually to every single tag.</p>
<p>The key is to browse to <strong>More Settings</strong> -&gt; <strong>Fields to Set</strong>, and add a new field with:</p>
<p>Field name: <code>cookieUpdate</code><br>
Value: <code>false</code></p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/cookie-update-false.jpg" title="Cookie Update field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/cookie-update-false.jpg#ZgotmplZ" alt="Cookie Update field" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1822 604'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>If you&rsquo;re using <strong>analytics.js</strong>, you set the field on the tracker like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">ga(<span style="color:#a50">&#39;create&#39;</span>, <span style="color:#a50">&#39;UA-12345-1&#39;</span>, {cookieUpdate: <span style="color:#00a">false</span>});
</code></pre></div>
<p>And if you&rsquo;re using <strong>gtag.js</strong>, it&rsquo;s like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">gtag(<span style="color:#a50">&#39;config&#39;</span>, <span style="color:#a50">&#39;UA-12345-1&#39;</span>, {
  cookie_update: <span style="color:#00a">false</span>
});
</code></pre></div>
<p>Once that is done, the next step is to create the <code>hitCallback</code> function. I&rsquo;ll show you how to do it in Google Tag Manager, but something similar could easily be done with <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/sending-hits#hitcallback">analytics.js</a> and <a href="https://developers.google.com/analytics/devguides/collection/gtagjs/sending-data#implement_event_callback_functions">gtag.js</a> - it&rsquo;s just JavaScript, after all.</p>
<p>In GTM, create a new <strong>Custom JavaScript variable</strong>.</p>
<blockquote>
<p>What? Why not use <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom templates</a>? Well, unfortunately they don&rsquo;t support creating POST requests yet. You could reconfigure the endpoint to work with GET requests, but POST is more suitable for handling structured data.</p>
</blockquote>
<p>In the Custom JavaScript variable, add this code:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">return</span> <span style="color:#00a">function</span>() {
    <span style="color:#aaa;font-style:italic">// Change these
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> endpoint = <span style="color:#a50">&#39;https://tracker.gtmtools.com&#39;</span>;
    <span style="color:#00a">var</span> domain = <span style="color:#a50">&#39;gtmtools.com&#39;</span>;
    
    <span style="color:#aaa;font-style:italic">// If your GA cookie name is something different than the default _ga, change this accordingly
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> gaCookieName = <span style="color:#a50">&#39;_ga&#39;</span>;
    
    <span style="color:#aaa;font-style:italic">// From https://www.w3schools.com/js/js_cookies.asp
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">function</span> getCookie(cname){<span style="color:#00a">var</span> name=cname+<span style="color:#a50">&#34;=&#34;</span>;<span style="color:#00a">var</span> decodedCookie=<span style="color:#0aa">decodeURIComponent</span>(<span style="color:#0aa">document</span>.cookie);<span style="color:#00a">var</span> ca=decodedCookie.split(<span style="color:#a50">&#34;;&#34;</span>);<span style="color:#00a">for</span>(<span style="color:#00a">var</span> i=<span style="color:#099">0</span>;i&lt;ca.length;i++){<span style="color:#00a">var</span> c=ca[i];<span style="color:#00a">while</span>(c.charAt(<span style="color:#099">0</span>)==<span style="color:#a50">&#34; &#34;</span>){c=c.substring(<span style="color:#099">1</span>)}<span style="color:#00a">if</span>(c.indexOf(name)==<span style="color:#099">0</span>){<span style="color:#00a">return</span> c.substring(name.length,c.length)}}<span style="color:#00a">return</span><span style="color:#a50">&#34;&#34;</span>}
    
    <span style="color:#aaa;font-style:italic">// Don&#39;t touch anything below
</span><span style="color:#aaa;font-style:italic"></span>	
	<span style="color:#aaa;font-style:italic">// Using getCookie() because we need to fetch the cookie value when the variable is executed, not when its added to the tag
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> gaCookie = getCookie(gaCookieName);
	
    <span style="color:#00a">var</span> safariApiPoll = {{Cookie - _safari_api_poll}};
    
    <span style="color:#aaa;font-style:italic">// Only run if GA cookie is set and if Safari hasn&#39;t been polled in the last 6 days
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">if</span> (!gaCookie || safariApiPoll) { 
      <span style="color:#00a">return</span>; 
    }

    <span style="color:#00a">var</span> data = JSON.stringify([{
      name: <span style="color:#a50">&#39;_ga&#39;</span>, 
      value: gaCookie,
      options: {
        path: <span style="color:#a50">&#39;/&#39;</span>, 
        domain: domain, 
        maxAge: <span style="color:#099">1000</span> * <span style="color:#099">60</span> * <span style="color:#099">60</span> * <span style="color:#099">24</span> * <span style="color:#099">365</span> * <span style="color:#099">2</span>
      }
    }]);
	<span style="color:#00a">var</span> xhr = <span style="color:#00a">new</span> XMLHttpRequest();
	xhr.open(<span style="color:#a50">&#39;POST&#39;</span>, endpoint, <span style="color:#00a">true</span>);
	xhr.setRequestHeader(<span style="color:#a50">&#39;Content-Type&#39;</span>, <span style="color:#a50">&#39;application/json&#39;</span>);
	xhr.withCredentials = <span style="color:#00a">true</span>;
	xhr.send(data);
    <span style="color:#0aa">document</span>.cookie = <span style="color:#a50">&#39;_safari_api_poll=true; domain=&#39;</span> + domain + <span style="color:#a50">&#39;; path=/; max-age=&#39;</span> + <span style="color:#099">60</span>*<span style="color:#099">60</span>*<span style="color:#099">24</span>*<span style="color:#099">6</span>;
  }
}
</code></pre></div>
<p>Remember to change the <code>endpoint</code> and <code>domain</code> to match the service endpoint and the root domain, respectively.</p>
<p>Give the variable name such as <strong>{{hitCallback - Cookie rewrite}}</strong>.</p>
<p>The <code>hitCallback</code> function does two things.</p>
<ol>
<li>
<p>If the <code>_ga</code> cookie has been set, and if it&rsquo;s been more than <strong>6 days</strong> since the web service was last polled, it requests the web service to write a new cookie named <code>_ga</code>, using the value of the actual <code>_ga</code> cookie written by Google Analytics.</p>
</li>
<li>
<p>It sets a new cookie with a 6 day expiration to avoid polling the web service any more than necessary.</p>
</li>
</ol>
<p>The reason we have the 6-day-expiration cookie is to prevent the API from being constantly polled by your tags. Since the API sets a cookie with a two-year-long expiration, it&rsquo;s OK to only poll it once every six days.</p>
<p><em>There&rsquo;s a complicated logic here, so bear with me.</em></p>
<p>There&rsquo;s no way to know using JavaScript what the expiration of the <code>_ga</code> cookie is. Thus, we need to poll the API every now and then to make sure the cookie stays written without a short expiration.</p>
<p>The maximum length of time we can persist information about when the API was last polled is 7 days. Why? Because this information is stored in a cookie written with JavaScript. The 6 days is just a precaution - you could easily modify the <code>max-age</code> parameter to make the cookie last a while longer.</p>
<p>And if you don&rsquo;t mind the API being polled constantly, feel free to remove this cookie check or to make it poll the API once a day, for example.</p>
<p><strong>Anyway</strong>. Next you&rsquo;ll need to create two <strong>First Party Cookie</strong> variables:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/ga-cookie.jpg" title="_ga Cookie">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/ga-cookie.jpg#ZgotmplZ" alt="_ga Cookie" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1156 912'%3E%3C/svg%3E">
  
    </a>
  
  
</div>





<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/safari-api-poll-cookie.jpg" title="_safari_api_poll_cookie">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/safari-api-poll-cookie.jpg#ZgotmplZ" alt="_safari_api_poll_cookie" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1204 914'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Finally, you need to find your Page View tag (or whatever tag fires consistently on every page), and scroll down to its <strong>More Settings</strong> -&gt; <strong>Fields to Set</strong> (check &ldquo;Enable overriding settings in this tag&rdquo; first). Add a new field:</p>
<p>Field name: <code>hitCallback</code><br>
Value: <code>{{hitCallback - Cookie rewrite}}</code></p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/pageview-hitcallback.jpg" title="hitCallback in the tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/pageview-hitcallback.jpg#ZgotmplZ" alt="hitCallback in the tag" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1798 624'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Now that you&rsquo;re all set, it&rsquo;s time to test!</p>
<p>Take the container to Preview mode, and visit the site with Safari. You should see a request to <code>tracker.domain.com</code> in the <strong>Network</strong> tab, and you should see your <code>_ga</code> cookie with a full two-year-long expiration. Reload the page and you should see no more requests to the web service, nor should the expiration of the <code>_ga</code> cookie change.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/06/cookies-storage.jpg" title="Cookies in storage">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/06/cookies-storage.jpg#ZgotmplZ" alt="Cookies in storage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2716 410'%3E%3C/svg%3E">
  
    </a>
  
  
</div>



                
                  <h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="i-dont-see-any-requests-to-trackermywebservicecom">I don&rsquo;t see any requests to tracker.mywebservice.com</h3>
<p>Make sure you configure the <code>hitCallback</code> variable correctly and that you add it to the tag.</p>
<h3 id="i-see-a-request-to-trackermywebservicecom-but-it-fails">I see a request to tracker.mywebservice.com but it fails</h3>
<p>Check the JavaScript console. There should be details about why the request failed. Most likely you&rsquo;ve misconfigured the <code>allowedHosts</code> array in <code>app.js</code>, and thus the cross-origin request isn&rsquo;t going through.</p>
<h3 id="i-see-the-set-cookie-header-but-the-cookie-expiration-doesnt-change">I see the Set-Cookie header but the cookie expiration doesn&rsquo;t change</h3>
<p>Make sure the <code>domain</code> is correct - it needs to be a root domain shared by your website and the web service.</p>
<p>Make sure you&rsquo;ve set the <code>cookieUpdate</code> field to <code>false</code> in <strong>all</strong> your GA tags.</p>
<h3 id="i-have-problems-setting-up-the-app-engine-application-or-something-else">I have problems setting up the App Engine application or something else</h3>
<p>Leave a question in the comments and I&rsquo;ll try to help you out.</p>

                
                  <h2 id="final-thoughts">Final thoughts</h2>
<p>I hope you find this exercise useful - it should give you some idea about what the technical steps are for creating some type of cookie routing service.</p>
<p>There are other ways to handle this, listed in <a href="https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/#technical-implications-and-solutions">this article</a>. However, the beauty of an API service like this is that it&rsquo;s as scalable as you like (or as your budget allows).</p>
<p>Using App Engine Standard environment isn&rsquo;t too expensive. For example, the modest amount of hits my site is generating for the API (around 7000 requests per day) is well within the free quota. App Engine charges based on instance hours, and you&rsquo;re given 28 instance hours for free per day. I&rsquo;m barely hitting 25 with this load.</p>
<p>Naturally, there are ways to optimize this even further. For example, you could check if the user&rsquo;s browser is Safari and only use the API then. Similarly, you could extend the API poll cookie from six days to far longer expirations by setting THAT cookie with the web service, too. Though it might create some sort of temporal cosmic paradox, I don&rsquo;t know.</p>
<p>Regardless, let me know in the comments what you think of this solution!</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-analytics/">google analytics</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/itp/">itp</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-cloud/">google cloud</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/app-engine/">app engine</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/send-page-visibility-state-to-ga/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/create-facebook-pixel-custom-tag-template/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Create%20A%20Cookie%20Rewrite%20Web%20Service%20Using%20The%20Google%20Cloud%20Platform%20https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/send-page-visibility-state-to-ga/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/create-facebook-pixel-custom-tag-template/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Create%20A%20Cookie%20Rewrite%20Web%20Service%20Using%20The%20Google%20Cloud%20Platform%20https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Create%20A%20Cookie%20Rewrite%20Web%20Service%20Using%20The%20Google%20Cloud%20Platform%20https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

