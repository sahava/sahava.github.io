

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Audit Multiple Sites With Lighthouse And Write Results To BigQuery | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2018\/12\/lighthouse.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/google-cloud\/lighthouse-bigquery-google-cloud-platform\/",
  "datePublished": "2018-12-18T09:03:08\u002b02:00",
  "dateModified": "2018-12-18T09:03:08\u002b02:00",
  "description": "Set up a simple GCP Cloud Function that uses Lighthouse to periodically audit a set of URLs and writes the audit results to BigQuery and Google Cloud Storage.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Audit Multiple Sites With Lighthouse And Write Results To BigQuery | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/google-cloud/lighthouse-bigquery-google-cloud-platform/">
    
    <meta name="description" content="Set up a simple GCP Cloud Function that uses Lighthouse to periodically audit a set of URLs and writes the audit results to BigQuery and Google Cloud Storage.">
    <meta property="og:description" content="Set up a simple GCP Cloud Function that uses Lighthouse to periodically audit a set of URLs and writes the audit results to BigQuery and Google Cloud Storage.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Audit Multiple Sites With Lighthouse And Write Results To BigQuery">
    <meta property="og:url" content="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Audit Multiple Sites With Lighthouse And Write Results To BigQuery">
    <meta name="twitter:description" content="Set up a simple GCP Cloud Function that uses Lighthouse to periodically audit a set of URLs and writes the audit results to BigQuery and Google Cloud Storage.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2018/12/lighthouse.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2018/12/lighthouse.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Audit Multiple Sites With Lighthouse And Write Results To BigQuery
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2018-12-18T09:03:08&#43;02:00">
        
  December 18, 2018

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/google-cloud">Google Cloud</a>
    
  


      | <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#commento">Comments</a>
      
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p><a href="https://cloud.google.com/">Google Cloud Platform</a> is very, very cool. It&rsquo;s a fully capable, enterprise-grade, scalable cloud ecosystem which lets even total novices get started with building their first cloud applications. I wrote a long guide for installing <a href="https://www.simoahava.com/analytics/install-snowplow-on-the-google-cloud-platform/">Snowplow on the GCP</a>, and you might want to read that if you want to see how you can build your own analytics tool using some nifty open-source modules.</p>
<p>But this guide will not be about <a href="https://snowplowanalytics.com/">Snowplow</a>. Rather, it will tackle Google&rsquo;s own open-source performance audit tool: <a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a>.</p>
<p>With this guide, <strong>you&rsquo;ll be able to build your own Google Cloud project, using Lighthouse to audit any number of sites you like, and write the results into storage and a BigQuery table</strong>!</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/lighthouse.jpg" title="Lighthouse">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/lighthouse.jpg#ZgotmplZ" alt="Lighthouse" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1413 462'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You can try Lighthouse in your Chrome browser right now. Just follow the instructions <a href="https://developers.google.com/web/tools/lighthouse/#devtools">here</a> to see how you can enable the <strong>Audit</strong> tool in DevTools.</p>
<p>One of the limitations of the DevTools feature is that you can only run it on one site at a time, and only through your web browser. I wanted to build something that lets me audit a whole bunch of sites, and automate it as well. For that reason, I wrote an <strong>extremely</strong> simple <a href="https://nodejs.org/en/">Node.js</a> app, <a href="https://github.com/sahava/multisite-lighthouse">multisite-lighthouse</a> which fulfils these requirements. Simply by editing a configuration file and then running the script, you can run an audit against multiple sites, and the results will be written in a local folder.</p>
<p>So that was fun. But then I got a bit more ambitious. Would it be possible to run this app in a <em>serverless</em> cloud environment, and have the results be written in a database or storage somewhere, where they can be queried and fetched at leisure?</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/bigquery.jpg" title="BigQuery output">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/bigquery.jpg#ZgotmplZ" alt="BigQuery output" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1349 394'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Well, sure! In this guide, I&rsquo;ll walk you through how to run a Node.js application in a GCP <a href="https://cloud.google.com/functions/">Cloud Function</a>, which writes the results into a <a href="https://cloud.google.com/bigquery/">BigQuery</a> table, and stores the reports into a <a href="https://cloud.google.com/storage/">Cloud Storage</a> bucket. Oh, and it&rsquo;s practically free.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[â€“hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#how-it-works">How it works</a></li>
    <li><a href="#preparations">Preparations</a>
      <ul>
        <li><a href="#install-command-line-tools">Install command line tools</a></li>
        <li><a href="#set-up-a-new-google-cloud-platform-project-with-billing">Set up a new Google Cloud Platform project with Billing</a></li>
      </ul>
    </li>
    <li><a href="#set-things-up-in-gcp">Set things up in GCP</a>
      <ul>
        <li><a href="#enable-the-services">Enable the services</a></li>
        <li><a href="#create-the-bigquery-dataset">Create the BigQuery dataset</a></li>
        <li><a href="#create-the-gcs-bucket">Create the GCS bucket</a></li>
        <li><a href="#set-up-the-scheduled-job">Set up the scheduled job</a></li>
      </ul>
    </li>
    <li><a href="#build-and-configure-the-application">Build and configure the application</a>
      <ul>
        <li><a href="#clone-the-repo-and-install-dependencies">Clone the repo and install dependencies</a></li>
        <li><a href="#modify-the-configuration-file">Modify the configuration file</a></li>
      </ul>
    </li>
    <li><a href="#deploy-the-function-and-test">Deploy the function and test</a>
      <ul>
        <li><a href="#deploy-the-cloud-function">Deploy the Cloud Function</a></li>
        <li><a href="#test-with-pubsub">Test with Pub/Sub</a></li>
        <li><a href="#check-logs">Check logs</a></li>
        <li><a href="#check-bigquery">Check BigQuery</a></li>
        <li><a href="#check-cloud-storage">Check Cloud Storage</a></li>
      </ul>
    </li>
    <li><a href="#things-to-note">Things to note</a>
      <ul>
        <li><a href="#cloud-scheduler">Cloud Scheduler</a></li>
        <li><a href="#manually-trigger-the-audit">Manually trigger the audit</a></li>
        <li><a href="#cloud-functions-dont-have-the-best-performance">Cloud Functions don&rsquo;t have the best performance</a></li>
        <li><a href="#updating-the-configuration-file-is-a-bit-annoying">Updating the configuration file is a bit annoying</a></li>
        <li><a href="#other-ideas">Other ideas</a></li>
      </ul>
    </li>
    <li><a href="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="how-it-works">How it works</h2>
<p>First, check out my mad Powerpoint-driven design skills:</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2018/12/process-diagram.jpg">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/process-diagram.jpg#ZgotmplZ" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1414 839'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Let&rsquo;s step through what goes on here.</p>
<ol>
<li>
<p>The <a href="https://cloud.google.com/functions/"><strong>Cloud Function</strong></a> is a piece of <a href="https://cloud.google.com/functions/docs/concepts/nodejs-8-runtime"><strong>Node.js</strong></a> code running in the Google Cloud. It&rsquo;s called &ldquo;serverless&rdquo; because the setup is fully self-contained. The environment itself takes care of running the code <strong>and</strong> the infrastructure necessary to do so.</p>
</li>
<li>
<p>The <strong>Cloud Function</strong> is triggered by a message pushed into a <a href="https://cloud.google.com/pubsub/docs/overview"><strong>Pub/Sub</strong></a> topic. Pub/Sub is short for Publish/Subscribe, which means you can <strong>publish</strong> messages into a topic, which will then alert any <strong>subscribers</strong> of that topic. In other words, it can be used as a simple real-time messaging queue, where published messages can trigger services within the Google Cloud.</p>
</li>
<li>
<p>The message itself can be published by you <strong>manually</strong>, by using the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> in your local terminal, or by other applications which have been authorized to communicate with the topic. A nice use case would be to have your site&rsquo;s build pipeline trigger the audit as soon as the new release of the site has been deployed.</p>
</li>
<li>
<p>The message can also be published by <a href="https://cloud.google.com/scheduler/"><strong>Cloud Scheduler</strong></a>, which is a Google Cloud service that lets you schedule certain actions such as the publishing of a Pub/Sub message. You can set the scheduler to trigger your Cloud Function every night, or every week, or every month, for example.</p>
</li>
<li>
<p>When the Cloud Function is triggered, it fires up an instance of the <strong>Google Chrome</strong> browser in headless mode, using a piece of software called <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a>.</p>
</li>
<li>
<p>The <a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> audit tool is run in this browser instance, and it will perform the audit on any URLs you have defined in a special configuration file.</p>
</li>
<li>
<p>Once the audit is complete, the results are written into <a href="https://cloud.google.com/storage/"><strong>Google Cloud Storage</strong></a>, which functions as a file archive in the cloud, allowing you to store and fetch items from it at will (and at low cost).</p>
</li>
<li>
<p>The results are also written into a <a href="https://cloud.google.com/bigquery/"><strong>BigQuery</strong></a> table. BigQuery is a scalable data warehouse, where records are stored in table format (as opposed to a more traditional relational database). Due to its flat nature, it&rsquo;s fast, scalable, and extremely responsive. We don&rsquo;t need its full potential in this project, but having the data stored in BigQuery opens up opportunities in e.g. <a href="https://datastudio.google.com/">Google Data Studio</a> for visualization of the results.</p>
</li>
</ol>
<p>The <strong>cost</strong>? Next to nothing. With just one or two URLs you&rsquo;re facing practically <strong>zero cost</strong>. At most, it will be a handful of cents per month thanks to Google Cloud Storage.</p>

                
                  <h2 id="preparations">Preparations</h2>
<p>To be able to follow this guide, you&rsquo;ll need to install some tools and create a Google Cloud Platform project.</p>
<h3 id="install-command-line-tools">Install command line tools</h3>
<p>First, install the following command line tools:</p>
<ol>
<li>
<p><a href="https://nodejs.org/en/download/">Node.js and npm</a>.</p>
</li>
<li>
<p><a href="https://cloud.google.com/sdk/">Google Cloud SDK</a>.</p>
</li>
<li>
<p><a href="https://git-scm.com/downloads">Git</a>.</p>
</li>
</ol>
<p>To verify you have these up and running, run the following commands in your terminal (example from OS X):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ node -v
v11.0.0

$ npm -v
6.4.1

$ gcloud -v
Google Cloud SDK 228.0.0

$ git --version
git version 2.19.2</code></pre></div>
<p>Naturally, you might see some other version numbers, and that&rsquo;s OK. Just try to work with recent releases.</p>
<h3 id="set-up-a-new-google-cloud-platform-project-with-billing">Set up a new Google Cloud Platform project with Billing</h3>
<p>The other thing you&rsquo;ll need to do is <strong>create a GCP project</strong>, and you&rsquo;ll need to <strong>enable billing</strong> for this project. The things you build with this guide will most likely <strong>cost you absolutely nothing</strong>, or, at worst, just a handful of cents a month. But you still need to provide a credit card to enable some of the services we&rsquo;ll need.</p>
<p>To set up a new project, you can follow <a href="https://www.simoahava.com/analytics/install-snowplow-on-the-google-cloud-platform/#step-1-set-up-a-new-project">Step 1</a> and <a href="https://www.simoahava.com/analytics/install-snowplow-on-the-google-cloud-platform/#step-2-enable-billing">Step 2</a> in my Snowplow + GCP guide.</p>
<p>Once you&rsquo;ve created the project, make sure you copy its <strong>Project ID</strong> - you&rsquo;ll need it when walking through this guide.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/gcp-project-id.jpg" title="GCP Project ID">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/gcp-project-id.jpg#ZgotmplZ" alt="GCP Project ID" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 771 298'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once you&rsquo;ve got the command line tools running and the GCP project created, it&rsquo;s time to get to work!</p>

                
                  <h2 id="set-things-up-in-gcp">Set things up in GCP</h2>
<p>We&rsquo;ll need to enable some <strong>services</strong> in your Google Cloud Platform project. Also, we&rsquo;ll need <strong>create a BigQuery dataset</strong>, a <strong>storage bucket</strong> in Cloud Storage, and we&rsquo;ll need to configure a <strong>Cloud Scheduler</strong> job to run the audits periodically.</p>
<h3 id="enable-the-services">Enable the services</h3>
<p>First, make sure you&rsquo;ve got the correct project selected while in your <a href="https://console.cloud.google.com/home/dashboard">GCP console dashboard</a>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/temp-test-simo.jpg" title="GCP Project selected">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/temp-test-simo.jpg#ZgotmplZ" alt="GCP Project selected" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 706 288'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Then, go to <a href="https://console.cloud.google.com/apis/library/cloudfunctions.googleapis.com">https://console.cloud.google.com/apis/library/cloudfunctions.googleapis.com</a> and click the blue <strong>ENABLE</strong> button to enable the <strong>Cloud Functions API</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/enable-cf-api.jpg" title="Enable CF API">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/enable-cf-api.jpg#ZgotmplZ" alt="Enable CF API" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 885 372'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once enabled, go to <a href="https://console.cloud.google.com/apis/library/cloudscheduler.googleapis.com">https://console.cloud.google.com/apis/library/cloudscheduler.googleapis.com</a> and click the blue <strong>ENABLE</strong> button to enable the <strong>Cloud Scheduler API</strong>.</p>
<p>The other services we&rsquo;ll need (<strong>BigQuery API</strong>, <strong>Cloud Storage API</strong>, and <strong>Pub/Sub API</strong>) are already enabled in your project.</p>
<h3 id="create-the-bigquery-dataset">Create the BigQuery dataset</h3>
<p>Now, browse to <a href="https://console.cloud.google.com/bigquery">https://console.cloud.google.com/bigquery</a>, and click your project ID in the list of availabe projects.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/create-new-dataset.jpg" title="Create dataset">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/create-new-dataset.jpg#ZgotmplZ" alt="Create dataset" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 964 281'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>We need to create a <strong>dataset</strong> which will soon contain a <strong>table</strong> where the audit results will be loaded to.</p>
<p>Type <code>lighthouse</code> as the dataset ID, like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/new-dataset-id.jpg" title="Dataset ID">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/new-dataset-id.jpg#ZgotmplZ" alt="Dataset ID" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 647 240'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You can set the location of the dataset to somewhere in your geographical vicinity, if you wish. Once done, click <strong>Create dataset</strong>.</p>
<h3 id="create-the-gcs-bucket">Create the GCS bucket</h3>
<p>We&rsquo;ll need to create a <strong>bucket</strong> in Google Cloud Storage. You can think of it like a storage drive, where the bucket represents a specific root directory to which the audit reports will be written.</p>
<p>We&rsquo;ll also use the bucket to handle <strong>state</strong> in the Cloud Function. This is necessary to prevent unintentional retries from writing your data over and over again into BigQuery and storage.</p>
<p>Browse to <a href="https://console.cloud.google.com/storage/browser">https://console.cloud.google.com/storage/browser</a> and click <strong>Create bucket</strong>.</p>
<p>You&rsquo;ll need to edit some options.</p>
<ol>
<li>
<p><strong>Name</strong>: Give the bucket a name that&rsquo;s <em>globally</em> unique. <code>&lt;yourname&gt;-lighthouse-reports</code> should work nicely. You&rsquo;ll need this name when configuring the application, so you might as well make note of it now.</p>
</li>
<li>
<p><strong>Default storage class</strong>: Choose an applicable storage class. The storage class determines how much it costs to store and query the data. You&rsquo;ll be doing a little bit of fetching and a little bit of storing, so the Regional option is typically a good one to go with.</p>
</li>
<li>
<p><strong>Location</strong>, choosing the location will impact costs and latency, so find one that suits you best. Honestly, the costs will be so low you might as well just take the one which is geographically closest to you.</p>
</li>
</ol>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/gcs-bucket-settings.jpg" title="Google Cloud Storage bucket">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/gcs-bucket-settings.jpg#ZgotmplZ" alt="Google Cloud Storage bucket" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 596 608'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once happy with the settings, click <strong>Create</strong>.</p>
<h3 id="set-up-the-scheduled-job">Set up the scheduled job</h3>
<p>Finally, browse to <a href="https://console.cloud.google.com/cloudscheduler">https://console.cloud.google.com/cloudscheduler</a> and click <strong>Create job</strong>. We&rsquo;ll use the Cloud Scheduler to fire up our Cloud Function periodically.</p>
<p>In the first screen, you&rsquo;ll need to choose a region. You might as well choose one that&rsquo;s geographically close to you. Click <strong>Next</strong> when ready.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/scheduler-region.jpg" title="Scheduler-region">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/scheduler-region.jpg#ZgotmplZ" alt="Scheduler-region" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 803 528'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Next, after some deliberation, you&rsquo;ll need to give your job a name. Just use something descriptive.</p>
<p>Then, you need to establish the <strong>frequency</strong> of the job. Cloud Scheduler uses UNIX&rsquo; <code>cron</code> format, which can be a bit of a mystery, but it does have a nice logic to it. You can read how it works <a href="https://cloud.google.com/scheduler/docs/configuring/cron-job-schedules">here</a>, but here are some examples you can input into the field.</p>
<ol>
<li>
<p>Every day at 04:00 AM (daily): <code>0 4 * * *</code></p>
</li>
<li>
<p>Every Monday at 04:00 AM (weekly): <code>0 4 * * 1</code></p>
</li>
<li>
<p>First day of every month at 04:00 AM (monthly): <code>0 4 1 * *</code></p>
</li>
</ol>
<p>Next, choose a <strong>Timezone</strong> with which the &ldquo;04:00 AM&rdquo; part is calculated.</p>
<p>Then, choose <strong>Pub/Sub</strong> as the <strong>Target</strong> of the job.</p>
<p>Type <code>launch-lighthouse</code> into the <strong>Topic</strong> field, and <code>all</code> into the <strong>Payload</strong> field. Don&rsquo;t worry, these settings will become more apparent as we trod along.</p>
<p>In the end, the setup should look something like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/cloud-scheduler-job.jpg" title="Cloud Scheduler Job">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/cloud-scheduler-job.jpg#ZgotmplZ" alt="Cloud Scheduler Job" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 498 632'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Once ready, click <strong>Create</strong>.</p>
<p>Good job! That&rsquo;s it for the <strong>Google Cloud Platform</strong> preparations. Now we&rsquo;ll need to actually <strong>build the application</strong> itself.</p>

                
                  <h2 id="build-and-configure-the-application">Build and configure the application</h2>
<p>In this part of the guide, you&rsquo;ll install application source from my <strong>GitHub repo</strong>, update its <strong>configuration</strong>, and <strong>deploy it</strong> to GCP&rsquo;s Cloud Function environment.</p>
<h3 id="clone-the-repo-and-install-dependencies">Clone the repo and install dependencies</h3>
<p>Open your terminal (or other command line) application, browse to a directory you&rsquo;re comfortable to work with, and type the following command:</p>
<p><code>git clone https://github.com/sahava/multisite-lighthouse-gcp.git</code></p>
<p>This will download and install the source files from <a href="https://github.com/sahava/multisite-lighthouse-gcp">my GitHub repo</a> into the directory <code>multisite-lighthouse-gcp/</code> in the folder where you ran the command.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/git-clone.jpg" title="Git clone">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/git-clone.jpg#ZgotmplZ" alt="Git clone" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 529 133'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Next, type <code>cd multisite-lighthouse-gcp</code> and press enter. You should now be in the folder with the source files.</p>
<p>Now, type <code>npm install</code> to install the <strong>dependencies</strong> of the project:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/npm-install-done.jpg" title="npm install done">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/npm-install-done.jpg#ZgotmplZ" alt="npm install done" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1154 718'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This will take a while, depending on your internet connection. The dependencies include some heavy pieces of software (such as <code>puppeteer</code>, which I use to launch a headless Google Chrome instance for the audits). Once it&rsquo;s done, you should see a note that a bunch of packages were successfully installed.</p>
<h3 id="modify-the-configuration-file">Modify the configuration file</h3>
<p>While in the <code>multisite-lighthouse-gcp</code> directory, the next thing you&rsquo;ll need to do is edit the <code>config.json</code> file. So open the file with the text editor of your choice. This is what the default configuration looks like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#1e90ff;font-weight:bold">&#34;source&#34;</span>: [
    {
      <span style="color:#1e90ff;font-weight:bold">&#34;url&#34;</span>: <span style="color:#a50">&#34;https://www.google.com/&#34;</span>,
      <span style="color:#1e90ff;font-weight:bold">&#34;id&#34;</span>: <span style="color:#a50">&#34;googlesearch&#34;</span>
    },{
      <span style="color:#1e90ff;font-weight:bold">&#34;url&#34;</span>: <span style="color:#a50">&#34;https://www.ebay.com/&#34;</span>,
      <span style="color:#1e90ff;font-weight:bold">&#34;id&#34;</span>: <span style="color:#a50">&#34;ebay&#34;</span>
    }
  ],
  <span style="color:#1e90ff;font-weight:bold">&#34;projectId&#34;</span>: <span style="color:#a50">&#34;multisite-lighthouse-gcp&#34;</span>,
  <span style="color:#1e90ff;font-weight:bold">&#34;pubsubTopicId&#34;</span>: <span style="color:#a50">&#34;launch-lighthouse&#34;</span>,
  <span style="color:#1e90ff;font-weight:bold">&#34;datasetId&#34;</span>: <span style="color:#a50">&#34;lighthouse&#34;</span>,
  <span style="color:#1e90ff;font-weight:bold">&#34;minTimeBetweenTriggers&#34;</span>: <span style="color:#099">300000</span>,
  <span style="color:#1e90ff;font-weight:bold">&#34;gcs&#34;</span>: {
    <span style="color:#1e90ff;font-weight:bold">&#34;bucketName&#34;</span>: <span style="color:#a50">&#34;lighthouse-reports&#34;</span>
  },
  <span style="color:#1e90ff;font-weight:bold">&#34;lighthouseFlags&#34;</span>: {
    <span style="color:#1e90ff;font-weight:bold">&#34;output&#34;</span>: [<span style="color:#a50">&#34;html&#34;</span>, <span style="color:#a50">&#34;csv&#34;</span>],
    <span style="color:#1e90ff;font-weight:bold">&#34;emulatedFormFactor&#34;</span>: <span style="color:#a50">&#34;desktop&#34;</span>
  }
}</code></pre></div>
<p>Please see the following list of fields and possible values, and edit the configuration file accordingly.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Values</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td>{url, id}</td>
<td>Yes</td>
<td>An array of objects, each object representing one URL to audit. Type the full URL into the <code>url</code> field, and give a unique, descriptive <code>id</code> value into the respective field. For each additional URL you want to audit, add another object into the array.</td>
</tr>
<tr>
<td><code>projectId</code></td>
<td><code>temp-test-simo</code></td>
<td>Yes</td>
<td>The <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#set-up-a-new-google-cloud-platform-project-with-billing"><strong>Project ID</strong></a> of your Google Cloud Platform project.</td>
</tr>
<tr>
<td><code>pubsubTopicId</code></td>
<td><code>launch-lighthouse</code></td>
<td>Yes</td>
<td>Set this to <code>launch-lighthouse</code>. It&rsquo;s the name of the Pub/Sub <strong>topic</strong> that will be used to trigger the audits.</td>
</tr>
<tr>
<td><code>datasetId</code></td>
<td><code>lighthouse</code></td>
<td>Yes</td>
<td>The <strong>Dataset ID</strong> of the dataset you <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#create-the-bigquery-dataset">just created</a> in BigQuery.</td>
</tr>
<tr>
<td><code>minTimeBetweenTriggers</code></td>
<td><code>300000</code></td>
<td>Yes</td>
<td>The minimum time in milliseconds to wait before a Pub/Sub trigger can start the Cloud Function for any given ID. This is to add some <em>idempotency</em> to the function (more on this below).</td>
</tr>
<tr>
<td><code>gcs</code></td>
<td>{bucketName}</td>
<td>Yes</td>
<td>The name of the Google Cloud Storage bucket <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#create-the-gcs-bucket">you created earlier</a>.</td>
</tr>
<tr>
<td><code>lighthouseFlags</code></td>
<td>See <a href="https://github.com/GoogleChrome/lighthouse#cli-options">here</a>.</td>
<td>No</td>
<td>If you want to store the reports in Google Cloud Storage, set the <code>output</code> field to have an array of the formats you want to write the reports in. Available values are <code>&quot;csv&quot;</code>, <code>&quot;json&quot;</code>, and <code>&quot;html&quot;</code>. For each value in this array, a report will be written for every URL audited.</td>
</tr>
</tbody>
</table>
<p>The only optional field is <code>lighthouseFlags</code>. If you don&rsquo;t set <code>lighthouseFlags.output</code> to an array of available filetypes, no reports will be written to Google Cloud Storage. The other field provided by default is <code>emulatedFormFactor</code>, which specifies that the performance audit should emulate a desktop browser.</p>
<p>The <code>minTimeBetweenTriggers</code> flag is used to add a wait time before you can audit any given ID again. The Cloud Functions service doesn&rsquo;t guarantee that a function is run just once per trigger. This means that any code that&rsquo;s run should aim to be <em>idempotent</em>; that is, multiple executions of the code in a short amount of time should not result in additional state changes (e.g. BigQuery loads).</p>
<p>I ended up using a simple stateful mechanism in Google Cloud Storage. A file named <code>states.json</code> is written into the root of the GCS bucket, and this contains timestamps for when each trigger last activated its respective event. If this activation was less than 300 seconds ago (or whatever you specify in the configuration file), the function will abort.</p>
<p>Once done with the configuration, save the changes you made.</p>

                
                  <h2 id="deploy-the-function-and-test">Deploy the function and test</h2>
<p>You&rsquo;re almost done! Now you&rsquo;ll need to just <strong>deploy</strong> the function, and then run a <strong>simple test</strong>.</p>
<p>The Cloud Function itself is the <code>launchLighthouse()</code> method you can find if you browse the source code of <code>index.js</code>. This function is what your Pub/Sub trigger will launch when your Cloud Scheduler job goes off, or when you manually instruct the trigger to fire.</p>
<p>The Cloud Function will run in Google Cloud&rsquo;s serverless environment, launching instances of headless Google Chrome to perform the audits on the URLs you provide in the configuration file. The results will then be written into a BigQuery table, as well as stored into the GCS bucket if you so wish.</p>
<h3 id="deploy-the-cloud-function">Deploy the Cloud Function</h3>
<p>While in the <code>multisite-lighthouse-gcp</code> folder, type the following command:</p>
<p><code>gcloud auth login</code></p>
<p>This should open up a browser window where you need to enter your Google ID credentials. Make sure you <strong>log in with the same Google ID you use to manage your Google Cloud Platform project with</strong>! You&rsquo;ll see that Google Cloud SDK wants to access a bunch of things in your name, so click <strong>Allow</strong> to let it do just that.</p>
<p>It&rsquo;s Google - what evil could they do?</p>
<p>If successful, you should see this screen:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/gcloud-auth-login.jpg" title="gcloud auth login">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/gcloud-auth-login.jpg#ZgotmplZ" alt="gcloud auth login" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1147 487'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Now, open your terminal window again, and type the following command in the <code>multisite-lighthouse-gcp</code> folder:</p>
<p><code>gcloud config set project &lt;projectId&gt;</code></p>
<p>Type your GCP <strong>Project ID</strong> in lieu of <code>&lt;projectID&gt;</code>, and press enter.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/set-project.jpg" title="Set project">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/set-project.jpg#ZgotmplZ" alt="Set project" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 895 276'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Now that you&rsquo;ve authenticated against Google Cloud, and now that you&rsquo;ve switched the project to your GCP project, it&rsquo;s time to finally deploy the function with (type it all in one line):</p>
<p><code>gcloud functions deploy launchLighthouse --trigger-topic launch-lighthouse --memory 2048 --timeout 540 --runtime=nodejs8</code></p>
<p>If you want to run the function in a specific region, you can add <code>--region=&lt;some GCP region&gt;</code>, e.g. <code>--region=europe-west1</code> to the command.</p>
<p>It will take a minute or two for the function to be deployed to the cloud. Once done, you should see this as a result:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/function-deployed.jpg" title="Function deployed">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/function-deployed.jpg#ZgotmplZ" alt="Function deployed" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 856 336'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The deploy should fail in an error if you have mistakes in the configuration file <code>config.json</code>, so make sure you follow the <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#modify-the-configuration-file">instructions above</a> for how to configure the function.</p>
<p>The initial deployment creates the <code>launch-lighthouse</code> <a href="https://console.cloud.google.com/cloudpubsub/topicList">Pub/Sub topic and subscriptions</a> automatically.</p>
<p>So now that the Pub/Sub topic has been created, you can actually test the whole thing.</p>
<h3 id="test-with-pubsub">Test with Pub/Sub</h3>
<p>The Cloud Scheduler will send the message <code>all</code> to the Pub/Sub topic <code>launch-lighthouse</code> using the schedule you defined earlier. The topic <code>all</code> will, in turn, trigger the Cloud Function you just deployed as many times as it takes to audit all the URLs in the <code>source</code> field of the configuration.</p>
<p>You can test this in two ways.</p>
<ol>
<li>
<p>You can browse to <a href="https://console.cloud.google.com/cloudscheduler">https://console.cloud.google.com/cloudscheduler</a> and click <strong>Run now</strong> next to the schedule job.</p>
</li>
<li>
<p>You can use the command line to publish the <code>all</code> message.</p>
</li>
</ol>
<p>Since the first is so easy, I&rsquo;ll show you how to do the second.</p>
<p>Open the terminal, and make sure you have your Google Cloud Platform set with:</p>
<p><code>gcloud config set project &lt;projectId&gt;</code></p>
<p>Just remember to replace <code>&lt;projectId&gt;</code> with your actual project ID.</p>
<p>Now, run:</p>
<p><code>gcloud pubsub topics publish launch-lighthouse --message all</code></p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/pubsub-message-all.jpg" title="Pub/Sub message">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/pubsub-message-all.jpg#ZgotmplZ" alt="Pub/Sub message" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 63'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You should see a <code>messageIds</code> response - that means the message was published successfully.</p>
<h3 id="check-logs">Check logs</h3>
<p>Now, browse to <a href="https://console.cloud.google.com/functions/list">https://console.cloud.google.com/functions/list</a>, where you should see details about your Cloud Function, hopefully with a green checkmark next to its name.</p>
<p>Click the action menu at the end of the row, and choose <strong>View logs</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/view-logs-cf.jpg" title="View CF logs">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/view-logs-cf.jpg#ZgotmplZ" alt="View CF logs" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1181 315'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You&rsquo;ll see a bunch of log results here. Here are the entries you should see (in approximately, but not definitely, this order):</p>
<table>
<thead>
<tr>
<th>Message</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Function execution started</td>
<td>The Cloud Function starts. If you sent the message <code>all</code>, it now sends a <strong>new</strong> Pub/Sub message for all the IDs in your configuration file, thus starting new Cloud Functions by itself (one for each <code>source</code> entry in the config).</td>
</tr>
<tr>
<td>{id}: Sending init PubSub message</td>
<td>This is the initialization message for source ID {id}.</td>
</tr>
<tr>
<td>{id}: Init PubSub message sent</td>
<td>The initialization message was sent successfully.</td>
</tr>
<tr>
<td>Function execution took N ms, finished with status: &lsquo;ok&rsquo;</td>
<td>The Cloud Function triggered with <code>all</code> has now completed its task.</td>
</tr>
<tr>
<td>Function execution started</td>
<td>The Cloud Function triggered by the initialization message now starts.</td>
</tr>
<tr>
<td>{id}: Received message to start with URL {url}</td>
<td>Message to start audit received.</td>
</tr>
<tr>
<td>{id}: Starting browser for {url}</td>
<td>A headless browser is started for the audit.</td>
</tr>
<tr>
<td>{id}: Browser started for {url}</td>
<td>The browser startup is successful.</td>
</tr>
<tr>
<td>{id}: Starting lighthouse for {url}</td>
<td>Beginning the actual audit.</td>
</tr>
<tr>
<td>{id}: Lighthouse done for {url}</td>
<td>Lighthouse audit complete.</td>
</tr>
<tr>
<td>{id}: Browser closed for {url}</td>
<td>Browser instance shut down.</td>
</tr>
<tr>
<td>{id}: Writing {output} report to bucket {bucketName}</td>
<td>If you&rsquo;ve defined the <code>output</code> Lighthouse flag, then a report for each filetype listed in <code>output</code> will now be written into your GCS bucket.</td>
</tr>
<tr>
<td>{id}: Writing log to bucket {bucketName}</td>
<td>The full log of the audit is written to storage, too.</td>
</tr>
<tr>
<td>{id}: BigQuery job with ID {UUID} starting for {url}</td>
<td>The BigQuery job starts and signals the end of the Cloud Function.</td>
</tr>
<tr>
<td>Function execution took N ms, finished with status &lsquo;ok&rsquo;</td>
<td>Function complete.</td>
</tr>
</tbody>
</table>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/log-sample.jpg" title="Sample of the log">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/log-sample.jpg#ZgotmplZ" alt="Sample of the log" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1329 659'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>If you had multiple URLs defined in the <code>source</code> of the configuration file, then you&rsquo;ll see parallel entries for all the URLs. Each URL is treated in its own Cloud Function, so there will be a lot of overlap in the logs.</p>
<p>If you see permission errors then they are almost certainly because you&rsquo;ve either forgotten to enable the required services, or because you haven&rsquo;t filled in the <a href="https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/#modify-the-configuration-file">configuration file</a> correctly.</p>
<h3 id="check-bigquery">Check BigQuery</h3>
<p>Now, browse to <a href="https://console.cloud.google.com/bigquery">https://console.cloud.google.com/bigquery</a>. Here, click open your project in the left navigation, and choose the dataset you created. You should see a new table under it, named <code>reports</code>. Click it.</p>
<p>In the main console, you should now see a bunch of column definitions. Above those definitions is the link titled <strong>Preview</strong>, so go ahead and click it. This will &ldquo;Preview&rdquo; the BigQuery data stored in the data, and thus not cost you a penny.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/bigquery-check.jpg" title="BigQuery check">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/bigquery-check.jpg#ZgotmplZ" alt="BigQuery check" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1342 483'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Feel free to scroll around the columns.</p>
<p>Do note that the BigQuery schema <strong>only contains those audits that have a &ldquo;weight&rdquo; in determining the total score</strong>. I did this purely out of convenience. I might update the schema at some point to simply contain all the audit fields, but this made more sense to start with.</p>
<h3 id="check-cloud-storage">Check Cloud Storage</h3>
<p>Browse to <a href="https://console.cloud.google.com/storage/browser">https://console.cloud.google.com/storage/browser</a> and click the bucket name you created earlier. You might see some <code>.appspot.com</code> buckets there, too. Don&rsquo;t worry - they were created automatically when you deployed your Cloud Function.</p>
<p>You should now see new folders within the bucket - each named after an <code>id</code> value in your configuration file&rsquo;s <code>source</code> array. You&rsquo;ll also see the <code>states.json</code> file, which makes sure your function only runs when it&rsquo;s supposed to.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/folders-in-bucket.jpg" title="Folders in bucket">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/folders-in-bucket.jpg#ZgotmplZ" alt="Folders in bucket" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 967 393'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Click one of the folders to see the contents.</p>
<p>If you defined an <code>output</code> array in the Lighthouse flags of the configuration file, you will now see a file prefixed with <code>report_</code> for each file type you added to the array. Remember, there were three possible reports Lighthouse can provide you: CSV, HTML, and JSON.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2018/12/storage-logs.jpg" title="Storage logs">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2018/12/storage-logs.jpg#ZgotmplZ" alt="Storage logs" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 975 426'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You&rsquo;ll also see a JSON file prefixed with <code>log_</code>, which will contain the full audit object for you to peruse.</p>
<p>Feel free to download the files and explore them. The HTML report is especially interesting (and visually pleasing) to read.</p>

                
                  <h2 id="things-to-note">Things to note</h2>
<h3 id="cloud-scheduler">Cloud Scheduler</h3>
<p>Don&rsquo;t forget that you have a <strong>Cloud Scheduler</strong> running! Periodically, it will push the <code>all</code> message into your Pub/Sub topic, thus auditing each URL in your <code>source</code> list, writing the results into BigQuery, and storing the logs in Cloud Storage.</p>
<h3 id="manually-trigger-the-audit">Manually trigger the audit</h3>
<p>You can always trigger the audit manually with</p>
<p><code>gcloud pubsub topics publish launch-lighthouse --message all</code></p>
<p>or, if you want to trigger an audit for a specific ID only, the command is</p>
<p><code>gcloud pubsub topics publish launch-lighthouse --message &lt;id&gt;</code></p>
<p>where <code>&lt;id&gt;</code> is the ID of the URL you set in the <code>source</code> array of the configuration file.</p>
<h3 id="cloud-functions-dont-have-the-best-performance">Cloud Functions don&rsquo;t have the best performance</h3>
<p>Unfortunately, running the headless browser in the Cloud Function is not the most efficient thing in the world. In fact, the <strong>Performance</strong> report (which is, for many, the most interesting one), will most likely under-report the load times quite severely.</p>
<p>There&rsquo;s not much to do about this currently. Cloud Functions simply do not have the CPU power required to perform complex or expensive tasks like this.</p>
<p>This has been identified by the developers (see <a href="https://github.com/GoogleChrome/puppeteer/issues/3120">here</a>), and it&rsquo;s possible that in the near future either Cloud Functions, Puppeteer, or Google Chrome will enable the processes to run smoother and faster.</p>
<h3 id="updating-the-configuration-file-is-a-bit-annoying">Updating the configuration file is a bit annoying</h3>
<p>Due to how the configuration file has been bundled with the Cloud Function itself, any update to the configuration file requires you to <strong>redeploy</strong> the Cloud Function itself. This is annoying, since deployment always takes a couple of minutes.</p>
<p>I&rsquo;m probably going to update the application so that the configuration file is stored in a Google Cloud Storage bucket. That way when you want to update the file, all you need to do is upload it to the bucket using the Google Cloud Console user interface. And that&rsquo;s really fast.</p>
<h3 id="other-ideas">Other ideas</h3>
<p>You can follow the <a href="https://github.com/sahava/multisite-lighthouse-gcp">GitHub project</a> to see where things are heading. Especially the <a href="https://github.com/sahava/multisite-lighthouse-gcp/issues">Issues</a> page should be of interest, since it&rsquo;s essentially a to-do list for me.</p>

                
                  <h2 id="final-thoughts">Final thoughts</h2>
<p>This was a fun exercise, and I hope you managed to complete it following the guide above. If not, please let me know in the comments where you had trouble.</p>
<p>I&rsquo;m not too happy with the fact that Chrome is just too slow when run through a Cloud Function. It&rsquo;s possible that the whole thing is quite useless until the browser&rsquo;s performance in the sandbox is improved. I might have to add the option of using an AppEngine or Kubernetes Engine instance instead. This way you could scale the environment as much as you like to improve the accuracy of the performance audit. Naturally, this will incur some costs not present in the current setup.</p>
<p>On the other hand, I love the fact that the data is being collected in BigQuery, since I can create a nice dashboard with Data Studio that shows the performance progress of the URLs I&rsquo;ve selected for auditing.</p>
<p>Cloud Functions themselves are simply wonderful. Total game-changers. Running serverless applications with almost no cost at all, and triggering them in different ways (HTTP requests, Pub/Sub triggers) has huge potential for the future. Thanks to some background service magic, it&rsquo;s so refreshing not having to worry about authentication and access control levels - the Cloud Function has all the required access levels for performing a wide variety of tasks.</p>
<p>Check the Cloud Function documentation for inspiration: <a href="https://cloud.google.com/functions/docs/tutorials/">https://cloud.google.com/functions/docs/tutorials/</a>.</p>
<p>As always, please let me know in comments if you have questions about this setup, or if you have suggestions for improvement.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-cloud/">google cloud</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/cloud-functions/">cloud functions</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/bigquery/">bigquery</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/nodejs/">nodejs</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/lighthouse/">lighthouse</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/how-to-unset-a-user-scoped-custom-dimension-in-google-analytics/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/use-click-variables-with-element-visibility-trigger/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Audit%20Multiple%20Sites%20With%20Lighthouse%20And%20Write%20Results%20To%20BigQuery%20https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/how-to-unset-a-user-scoped-custom-dimension-in-google-analytics/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/use-click-variables-with-element-visibility-trigger/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Audit%20Multiple%20Sites%20With%20Lighthouse%20And%20Write%20Results%20To%20BigQuery%20https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Audit%20Multiple%20Sites%20With%20Lighthouse%20And%20Write%20Results%20To%20BigQuery%20https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/google-cloud/lighthouse-bigquery-google-cloud-platform/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

