

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Measure Ad Blocker Impact With Server-side GTM | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2021\/09\/blocker-data.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/measure-ad-blocker-impact-server-side-gtm\/",
  "datePublished": "2021-09-27T09:10:11\u002b03:00",
  "dateModified": "2021-09-27T09:10:11\u002b03:00",
  "description": "How to measure ad and content blocker impact with server-side Google Tag Manager and Google Analytics 4.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Measure Ad Blocker Impact With Server-side GTM | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/measure-ad-blocker-impact-server-side-gtm/">
    
    <meta name="description" content="How to measure ad and content blocker impact with server-side Google Tag Manager and Google Analytics 4.">
    <meta property="og:description" content="How to measure ad and content blocker impact with server-side Google Tag Manager and Google Analytics 4.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Measure Ad Blocker Impact With Server-side GTM">
    <meta property="og:url" content="https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Measure Ad Blocker Impact With Server-side GTM">
    <meta name="twitter:description" content="How to measure ad and content blocker impact with server-side Google Tag Manager and Google Analytics 4.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
	  <meta property="og:image" content="https://www.simoahava.com/images/2021/09/measure-ad-blocker-impact-server-side-gtm.jpg">
      <meta name="twitter:image" content="https://www.simoahava.com/images/2021/09/measure-ad-blocker-impact-server-side-gtm.jpg">
    


    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
    <div class="figure nocaption">
      <img class="cover" src="https://www.simoahava.com/images/2021/09/measure-ad-blocker-impact-server-side-gtm.jpg">
    </div>
  
  

    <h1>
      Measure Ad Blocker Impact With Server-side GTM
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-09-27T09:10:11&#43;03:00">
        
  September 27, 2021

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>For many, it seems, one of the most important justifications for <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">server-side Google Tag Manager</a> is its resilience to <strong>ad and content blockers</strong>. After all, by virtue of serving the container JavaScript <em>from your own domain</em>, you escape many of the heuristic devices today&rsquo;s blocker technologies employ.</p>
<p>Well, I&rsquo;ve gone on record over and over again to say how this is <strong>poor justification</strong> for using server-side GTM. By circumventing the user&rsquo;s <em>wish</em> to block scripts, you are disrespecting them and forcing their browser to download scripts that they wanted to avoid downloading in the first place.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Since it’s server-side, you might be tempted to use it for circumventing browser block lists, tracking protections, consents, etc. <br><br>Yes, you can do all this. But you don’t have to be a dick. Always err in the side of max. respect for user privacy. 5/6</p>&mdash; Simo Ahava (@SimoAhava) <a href="https://twitter.com/SimoAhava/status/1222459724807004160?ref_src=twsrc%5Etfw">January 29, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>However, this is not another article lamenting this disconnect between data-hungry analysts and their unsuspecting site visitors.</p>
<p>Instead, I want to take the technology that allows you to <strong>circumvent</strong> and instead use it to <strong>detect</strong>.</p>
<p>While ad and content blockers should be allowed to run their course, I do think it&rsquo;s absolutely vital that their impact be measured. That way you can calculate just how many of your analytics and ad requests are blocked due to these tools.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/blocker-data.jpg" title="Blocker data">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/blocker-data.jpg#ZgotmplZ" alt="Blocker data" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1102 720'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You can even use the detection technology to conditionally block your server-side tags! That way you can truly act according to the user&rsquo;s wishes <em>and</em> keep those data streams between the browser and the server container alive.</p>
<blockquote>
<p>By the way, if you&rsquo;re interested in knowing more about ad and content blockers in general, I recommend you listen to <a href="https://www.teamsimmer.com/2021/07/13/ad-blockers-with-pete-snyder/">this Technical Marketing Handbook podcast episode</a>, where I interviewed <strong>Pete Snyder</strong> of Brave about this very topic.</p>
</blockquote>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="measuring-blocker-impact">Measuring blocker impact</h2>
<p>Let&rsquo;s start with a major caveat (first of many):</p>
<blockquote>
<p>This is a <strong>proof of concept</strong>. What I&rsquo;m showing you here are some of the components you need to create the detection system, but most of the work needs to be done client-side (where the detection happens), so you need to adjust these ideas to make sense for what <strong>your</strong> site runs on.</p>
</blockquote>
<p>In this article, I&rsquo;ll show you how I&rsquo;m measuring three different things:</p>
<ul>
<li>The ratio of homepage views where <strong>ads</strong> were blocked.</li>
<li>The ratio of homepage views where <strong>Google Analytics</strong> was blocked.</li>
<li>The ratio of homepage views where <strong>Google Tag Manager</strong> was blocked.</li>
</ul>
<p>There are additional caveats related to each of these measurements, but I&rsquo;ll tackle those when they come up.</p>
<p>Note that to understand everything that&rsquo;s happening here, you need a fairly good grasp of <strong>server-side tagging</strong>. If you haven&rsquo;t set it up yet, I recommend you take a look at <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">my article on the topic</a>.</p>

                
                  <h2 id="custom-client-template">Custom Client template</h2>
<p>I&rsquo;m using a custom <a href="https://gist.github.com/sahava/5d981c3cdee08ecff93c29e7c455530e">Client template</a> in the Server container to pick up requests for the ad blocker <em>bait file</em> as well as for the pixel that is used to generate an <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/#event-model">event data object</a>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/ad-blocker-client.jpg" title="Ad blocker client">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/ad-blocker-client.jpg#ZgotmplZ" alt="Ad blocker client" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 808'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The bait file contains instructions for the browser to generate an element with the ID <code>GxsCRdhiJi</code>. This is the element you need to search for to see if the file was blocked or not.</p>

                
                  <h2 id="client-side-script">Client-side script</h2>
<p>Most of the magic needs to be done client-side.</p>
<p>In the page template of my site, I&rsquo;m running the following script in the page HTML. Yes, you need to do this outside Google Tag Manager, because if GTM is blocked then you won&rsquo;t be able to measure the impact due to the client-side script being blocked, too.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">(<span style="color:#00a">function</span>() {
  <span style="color:#aaa;font-style:italic">// Set these to the endpoints configured in the Client template
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">var</span> baitPath = <span style="color:#a50">&#39;https://sgtm.simoahava.com/ads-min.js&#39;</span>;
  <span style="color:#00a">var</span> pixelPath = <span style="color:#a50">&#39;https://sgtm.simoahava.com/4dchk&#39;</span>;
  
  <span style="color:#aaa;font-style:italic">// Prevent the script from running outside the home page
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">if</span> (<span style="color:#0aa">document</span>.location.pathname !== <span style="color:#a50">&#39;/&#39;</span>) <span style="color:#00a">return</span>;
  
  <span style="color:#aaa;font-style:italic">// Inject the bait file
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">var</span> el = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;script&#39;</span>);
  el.src = baitPath;
  <span style="color:#0aa">document</span>.body.appendChild(el);
  
  <span style="color:#00a">var</span> gaBlocked = <span style="color:#00a">false</span>;
  
  <span style="color:#aaa;font-style:italic">// Run the detections at page load to avoid race conditions
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">window</span>.addEventListener(<span style="color:#a50">&#39;load&#39;</span>, <span style="color:#00a">function</span>() {
    <span style="color:#aaa;font-style:italic">// Send a HEAD request for the Universal Analytics library to see if it&#39;s blocked
</span><span style="color:#aaa;font-style:italic"></span>    fetch(<span style="color:#a50">&#39;https://www.google-analytics.com/analytics.js&#39;</span>, {method: <span style="color:#a50">&#39;HEAD&#39;</span>, mode: <span style="color:#a50">&#39;no-cors&#39;</span>})
      .<span style="color:#00a">catch</span>(<span style="color:#00a">function</span>() {
        <span style="color:#aaa;font-style:italic">// If the load failed, assume GA was blocked
</span><span style="color:#aaa;font-style:italic"></span>        gaBlocked = <span style="color:#00a">true</span>;
      })
      .<span style="color:#00a">finally</span>(<span style="color:#00a">function</span>() {
        <span style="color:#aaa;font-style:italic">// Build the GA4 parameters, add additional parameters at your leisure
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">var</span> params = {
          ads_blocked: !<span style="color:#0aa">document</span>.querySelector(<span style="color:#a50">&#39;#GxsCRdhiJi&#39;</span>), <span style="color:#aaa;font-style:italic">// Detect if the bait file was blocked
</span><span style="color:#aaa;font-style:italic"></span>          gtm_blocked: !(<span style="color:#0aa">window</span>.google_tag_manager &amp;&amp; <span style="color:#0aa">window</span>.google_tag_manager.dataLayer), <span style="color:#aaa;font-style:italic">// Detect if gtm.js was blocked
</span><span style="color:#aaa;font-style:italic"></span>          ga_blocked: gaBlocked <span style="color:#aaa;font-style:italic">// Detect if analytics.js was blocked
</span><span style="color:#aaa;font-style:italic"></span>        };
        
        <span style="color:#aaa;font-style:italic">// Build the pixel request with a unique, random Client ID
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">var</span> cid = <span style="color:#0aa">Math</span>.floor((<span style="color:#0aa">Math</span>.random() * <span style="color:#099">1000000</span>) + <span style="color:#099">1</span>) + <span style="color:#a50">&#39;_&#39;</span> + <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime();
        <span style="color:#00a">var</span> img = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;img&#39;</span>);
        img.style = <span style="color:#a50">&#39;width: 1; height: 1; display: none;&#39;</span>;
        img.src = pixelPath + <span style="color:#a50">&#39;?client_id=&#39;</span> + cid + <span style="color:#a50">&#39;&amp;&#39;</span> + <span style="color:#0aa">Object</span>.keys(params).reduce(<span style="color:#00a">function</span>(acc, cur) { <span style="color:#00a">return</span> acc.concat(cur + <span style="color:#a50">&#39;=&#39;</span> + params[cur]);}, []).join(<span style="color:#a50">&#39;&amp;&#39;</span>);
        <span style="color:#0aa">document</span>.body.appendChild(img);
      });
  });
})();
</code></pre></div>
<p>I only want to run this script on the home page, and because I&rsquo;m so lazy at editing my templates, I simply exit the function if the current page path isn&rsquo;t the root of the site.</p>
<p>For <code>baitPath</code> and <code>pixelPath</code>, configure the corresponding settings you added to the Client template. The default values are <code>/ads-min.js</code> for the bait file path, and <code>/4dchk</code> for the pixel path.</p>
<p>In the following chapters, I&rsquo;ll tell you how I&rsquo;m measuring ad blocker use, Google Analytics blocking, and Google Tag Manager blocking.</p>

                
                  <h2 id="measuring-ad-blockers">Measuring ad blockers</h2>
<p>To measure the impact of <strong>ad blockers</strong>, I&rsquo;m using an age-old heuristic system to detect if the browser is blocking ads.</p>
<p>The browser sends a request to the Server container, where the <a href="https://gist.github.com/sahava/5d981c3cdee08ecff93c29e7c455530e">Client template</a> picks it up. The request needs to be for a file that is most commonly blocked by ad blockers, such as <strong>ads-min.js</strong>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...
<span style="color:#00a">var</span> baitPath = <span style="color:#a50">&#39;https://sgtm.simoahava.com/ads-min.js&#39;</span>;
<span style="color:#00a">var</span> el = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;script&#39;</span>);
el.src = baitPath;
<span style="color:#0aa">document</span>.body.appendChild(el);
...
</code></pre></div>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/ads-min-blocked.jpg" title="ads-min.js blocked">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/ads-min-blocked.jpg#ZgotmplZ" alt="ads-min.js blocked" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1442 288'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The purpose of the file is to create a dummy HTML element on the page with a specific ID (<code>GxsCRdhiJi</code> if you&rsquo;re using the default template). If the element doesn&rsquo;t exist when you query it, it means that the download failed for some reason or other, one of which could be due to ad blockers.</p>
<blockquote>
<p><strong>Caveat</strong>: We don&rsquo;t know why the download failed. It could be due to an ad blocker, but it could also be due to a network error or something else. So there&rsquo;s always some uncertainty in this regard.</p>
</blockquote>
<p>Note also that filter lists such as <a href="https://disconnect.me/trackerprotection">Disconnect.me</a>, used in e.g. Mozilla Firefox and Microsoft Edge, pattern match against the domain name, which makes detecting them with a custom solution very difficult to do.</p>

                
                  <h2 id="measuring-ga-blockers">Measuring GA blockers</h2>
<p>To measure whether Google Analytics is blocked or not, I&rsquo;m using a very simple method. I run a <code>fetch()</code> call for the Universal Analytics JavaScript library. If that request fails, I&rsquo;ll chalk it up to GA being blocked.</p>
<p>The request is sent with the HEAD method to prevent exerting browser resources, and it&rsquo;s sent with the <code>no-cors</code> mode to avoid CORS issues.</p>
<p>Here&rsquo;s what the request looks like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...
fetch(<span style="color:#a50">&#39;https://www.google-analytics.com/analytics.js&#39;</span>, {method: <span style="color:#a50">&#39;HEAD&#39;</span>, mode: <span style="color:#a50">&#39;no-cors&#39;</span>})
  .<span style="color:#00a">catch</span>(() =&gt; {
    <span style="color:#aaa;font-style:italic">// GA is blocked
</span><span style="color:#aaa;font-style:italic"></span>  });
...
</code></pre></div>
<blockquote>
<p><strong>Caveat</strong>: Again, we don&rsquo;t know if it&rsquo;s a blocker that prevents GA from loading. Also, in e.g. Firefox, even in Private Windows, Google Analytics is allowed to load, but its main methods are <strong>shimmed</strong> to prevent it from working. This particular approach would not be able to detect that type of blocking.</p>
</blockquote>

                
                  <h2 id="measuring-gtm-blockers">Measuring GTM blockers</h2>
<p>For GTM, we&rsquo;re taking an <em>even</em> simpler approach. At window loaded time, we&rsquo;ll check if the <code>window.google_tag_manager</code> interface has been created and that it also has the nested object <code>window.google_tag_manager.dataLayer</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...
gtm_blocked: !(<span style="color:#0aa">window</span>.google_tag_manager &amp;&amp; <span style="color:#0aa">window</span>.google_tag_manager.dataLayer)
...
</code></pre></div>
<blockquote>
<p><strong>Caveat</strong>: All the aforementioned caveats apply, again. And it&rsquo;s important to remember that on e.g. Firefox, the global <code>window.google_tag_manager</code> interface <em>is</em> created, but since <code>dataLayer.push</code> is shimmed, GTM itself won&rsquo;t work.</p>
</blockquote>

                
                  <h2 id="sending-the-pixel-request-to-the-server-container">Sending the pixel request to the Server container</h2>
<p>Once you have your Booleans for whether or not these three vectors are being blocked, it&rsquo;s time to put everything together.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#0aa">window</span>.addEventListener(<span style="color:#a50">&#39;load&#39;</span>, <span style="color:#00a">function</span>() {
  fetch(<span style="color:#a50">&#39;https://www.google-analytics.com/analytics.js&#39;</span>, {method: <span style="color:#a50">&#39;HEAD&#39;</span>, mode: <span style="color:#a50">&#39;no-cors&#39;</span>})
    .<span style="color:#00a">catch</span>(<span style="color:#00a">function</span>() {
      gaBlocked = <span style="color:#00a">true</span>;
    })
    .<span style="color:#00a">finally</span>(<span style="color:#00a">function</span>() {
      <span style="color:#00a">var</span> params = {
        ads_blocked: !<span style="color:#0aa">document</span>.querySelector(<span style="color:#a50">&#39;#GxsCRdhiJi&#39;</span>),
        gtm_blocked: !(<span style="color:#0aa">window</span>.google_tag_manager &amp;&amp; <span style="color:#0aa">window</span>.google_tag_manager.dataLayer),
        ga_blocked: gaBlocked
      };
      <span style="color:#00a">var</span> cid = <span style="color:#0aa">Math</span>.floor((<span style="color:#0aa">Math</span>.random() * <span style="color:#099">1000000</span>) + <span style="color:#099">1</span>) + <span style="color:#a50">&#39;_&#39;</span> + <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime();
      <span style="color:#00a">var</span> img = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;img&#39;</span>);
      img.style = <span style="color:#a50">&#39;width: 1; height: 1; display: none;&#39;</span>;
      img.src = pixelPath + <span style="color:#a50">&#39;?client_id=&#39;</span> + cid + <span style="color:#a50">&#39;&amp;&#39;</span> + <span style="color:#0aa">Object</span>.keys(params).reduce(<span style="color:#00a">function</span>(acc, cur) { <span style="color:#00a">return</span> acc.concat(cur + <span style="color:#a50">&#39;=&#39;</span> + params[cur]);}, []).join(<span style="color:#a50">&#39;&amp;&#39;</span>);
      <span style="color:#0aa">document</span>.body.appendChild(img);
    });
});
</code></pre></div>
<p>The pixel request waits for the window to completely load <strong>and</strong> for the Google Analytics <code>fetch()</code> request to complete. This way any possible asynchronous race conditions won&rsquo;t spoil the measurement.</p>
<p>In the <code>params</code> object, you can add any parameters you wish to end up in the event data object. If you <em>don&rsquo;t</em> provide the <code>page_location</code> parameter, you&rsquo;ll need to add it to the tag (see below). You can also provide a custom <code>event_name</code> parameter, and the Client template will default to <code>page_view</code> if you don&rsquo;t.</p>
<p>The <code>client_id</code> is automatically generated as a unique, random value for each request.</p>
<blockquote>
<p><strong>Caveat</strong>: This means that we&rsquo;re not measuring <strong>users</strong> who use blockers but rather <strong>individual hits</strong> and whether they&rsquo;re blocked or not. I wanted to ignore <strong>users</strong> simply because I don&rsquo;t want to start setting cookies or fingerprinting just for the purpose of this exercise.</p>
</blockquote>
<p>Finally, a pixel request is sent to your server container, which grabs it and creates an Event Data Object with the parameters:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/event-data-object.jpg" title="Event Data Object">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/event-data-object.jpg#ZgotmplZ" alt="Event Data Object" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2166 1222'%3E%3C/svg%3E">
  
    </a>
  
  
</div>



                
                  <h2 id="setup-the-ga4-tag">Setup the GA4 tag</h2>
<p>In the Server container, you can then configure a GA4 tag to fire when this particular event data object is generated. For this purpose, <strong>I recommend you create a new data stream just for this data</strong>. That way you don&rsquo;t pollute your marketing analytics data with this ad blocker coverage.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/ga4-tag.jpg" title="GA4 tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/ga4-tag.jpg#ZgotmplZ" alt="GA4 tag" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1804 1500'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>As you can see, I&rsquo;m redacting the visitor&rsquo;s IP address (I consider that to be a required setting in ALL GA4 measurement).</p>
<p>Remember to add your data stream Measurement ID to the tag. You don&rsquo;t need to add any of the custom parameters from the pixel request – they will automatically be sent to GA4 just by virtue of being in the event data object.</p>
<p>Finally, here&rsquo;s what the trigger looks like:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/server-custom-trigger.jpg" title="Server custom trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/server-custom-trigger.jpg#ZgotmplZ" alt="Server custom trigger" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1810 678'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In Google Analytics 4, remember to configure the custom parameters as custom dimensions.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/custom-dimensions-ga4.jpg" title="GA4 custom dimensions">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/custom-dimensions-ga4.jpg#ZgotmplZ" alt="GA4 custom dimensions" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1866 606'%3E%3C/svg%3E">
  
    </a>
  
  
</div>



                
                  <h2 id="test-the-setup">Test the setup</h2>
<p>Once everything is in place, you can check the Server container preview mode while loading the homepage of your site.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/ads-min-4dchk.jpg" title="ads-min.js and 4dchk">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/ads-min-4dchk.jpg#ZgotmplZ" alt="ads-min.js and 4dchk" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1938 984'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You should see a request for <code>/ads-min.js</code> followed shortly by a request for the <code>/4dchk</code> pixel.</p>
<p>In Google Analytics 4, you should see your events land in the Real Time report.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/page-view-event.jpg" title="Page View event">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/page-view-event.jpg#ZgotmplZ" alt="Page View event" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 844 894'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<blockquote>
<p>Note that everything else in GA4 should be pretty much flatlining. As you&rsquo;re not using the recommended SDKs, you&rsquo;re also not measuring user activity and engagement correctly. But we don&rsquo;t care about that – we just care about the events.</p>
</blockquote>
<p>You can then compile them into whatever reports you wish using the <strong>Explore</strong> section of Google Analytics 4 or even <strong>Google BigQuery</strong> if you&rsquo;ve configured the export for this data stream.</p>
<p>Remember to also test with a variety of blockers! For example, this is what it looks like in the browser&rsquo;s network requests when I load the homepage with the Brave browser:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/all-blocked.jpg" title="All blocked">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/all-blocked.jpg#ZgotmplZ" alt="All blocked" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2158 388'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>As you can see, all three parameters have the value <code>true</code>, indicating that on Brave, everything is blocked.</p>
<p>In Firefox Private Windows, however:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/09/firefox-private.jpg" title="Firefox private windows">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/09/firefox-private.jpg#ZgotmplZ" alt="Firefox private windows" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1094 216'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Nothing is blocked!</p>
<p>Well, I&rsquo;m using <code>ads-min.js</code> as the bait file, and the filter list that Firefox uses (<a href="https://disconnect.me/trackerprotection">Disconnect.me</a>) doesn&rsquo;t match against file names but rather against tracking domains themselves. And while GA and GTM aren&rsquo;t technically <em>blocked</em>, their main methods are <em>shimmed</em>, meaning they won&rsquo;t work in Firefox.</p>
<blockquote>
<p><strong>Shimming</strong> means that the methods exist to avoid pages from breaking due to reference errors, but they are overwritten in a way that prevents them from doing what they were intended to do.</p>
</blockquote>

                
                  <h2 id="summary">Summary</h2>
<p>You might have noticed how many caveats there were listen in the article. That&rsquo;s because detecting ad and content blockers <em>is hard</em>.</p>
<p>Blockers are designed in a way to make them as unobtrusive as possible, and while they rarely succeed in being transparent, they do make it difficult to detect and adjust in code.</p>
<p>I&rsquo;m sure there are more sophisticated ways to detect different blocking mechanisms than those I introduced in this article, but the purpose of this article wasn&rsquo;t to show you how to <em>detect</em> blockers but rather how to <em>measure</em> their impact.</p>
<p>With a Google Tag Manager Server container, you have an inexpensive API endpoint that&rsquo;s relatively easy to set up. It runs on your own domain, so the ad blocker detector itself isn&rsquo;t blocked by, well, ad blockers.</p>
<p>It&rsquo;s a nice use case for a Server container, again.</p>
<p>With this method, you could selectively block your Server tags from firing if the user is using an ad blocker. Of course, this wouldn&rsquo;t help with the use cases where the user uses blockers to simply prevent <em>any</em> extraneous scripts from firing in their browser. It&rsquo;s up to you to decide how far you want to take your respect for the user&rsquo;s wishes.</p>
<p>If you&rsquo;re curious, in my tests I found the following:</p>
<ul>
<li><strong>~7%</strong> of page loads happened where <strong>Google Tag Manager</strong> was blocked.</li>
<li><strong>~10%</strong> of page loads happened where <strong>Google Analytics</strong> was blocked.</li>
<li><strong>~18%</strong> of page loads happened where <strong>ads-min.js</strong> and thus, by proxy, <em>ads</em> were blocked.</li>
</ul>
<p>Please let me know in the comments if you have questions about this setup or comments about ad / content blocking in general.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/ad-blocker/">ad blocker</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/google-ads-remarketing-gtm-server-containers/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Measure%20Ad%20Blocker%20Impact%20With%20Server-side%20GTM%20https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/google-ads-remarketing-gtm-server-containers/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Measure%20Ad%20Blocker%20Impact%20With%20Server-side%20GTM%20https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Measure%20Ad%20Blocker%20Impact%20With%20Server-side%20GTM%20https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/measure-ad-blocker-impact-server-side-gtm/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

