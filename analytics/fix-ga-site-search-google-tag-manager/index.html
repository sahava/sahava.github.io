

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Fix GA Site Search With Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2014\/07\/search-report.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/fix-ga-site-search-google-tag-manager\/",
  "datePublished": "2014-07-30T06:22:41\x2b00:00",
  "dateModified": "2014-07-30T06:22:41\x2b00:00",
  "description": "How to fix Google Analytics site search tracking on your website, if it has features that make it difficult to track internal site search via Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Fix GA Site Search With Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/fix-ga-site-search-google-tag-manager/">
    
    <meta name="description" content="How to fix Google Analytics site search tracking on your website, if it has features that make it difficult to track internal site search via Google Tag Manager.">
    <meta property="og:description" content="How to fix Google Analytics site search tracking on your website, if it has features that make it difficult to track internal site search via Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Fix GA Site Search With Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Fix GA Site Search With Google Tag Manager">
    <meta name="twitter:description" content="How to fix Google Analytics site search tracking on your website, if it has features that make it difficult to track internal site search via Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2014/07/search-report.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2014/07/search-report.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Fix GA Site Search With Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2014-07-30T06:22:41Z">
        
  July 30, 2014

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/#commento">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>Analyzing what people write in your <a href="https://support.google.com/analytics/answer/1012264?hl=en">site search field</a> is pretty much one of the smartest things you can do for your website tracking. If certain terms pop up over and over again in internal search reports, it means that your site is not providing the answers people are looking for, meaning you have an excellent opportunity to provide supply for the demand!</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/search-report.jpg" title="Search Reports in GA">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/search-report.jpg#ZgotmplZ" alt="Search Reports in GA">
  
    </a>
  
  
</div>


<p>However, not all site search applications are trackable out-of-the-box. In this post, I go over three scenarios, and I provide three solutions for tackling internal site search problems in <a href="http://www.google.com/tagmanager">Google Tag Manager</a>.</p>
<p><strong>1) No query parameter in URL</strong></p>
<p>Google Analytics&rsquo; site search settings require a query parameter in the URL, e.g. <code>https://www.simoahava.com/search?q=analytics</code>. Often, however, the site search tool does not apply a query parameter to the URL. Rather, the keyword might be as a typical URL folder, like <code>https://www.simoahava.com/search/analytics</code>.</p>
<p>This is pretty commonplace. You might have seen this phenomenon in <a href="https://www.drupal.org/documentation/modules/search">Drupal</a> websites. It's easy to fix with a URL macro and the <strong>page</strong> field in your pageview tag.</p>
<p><strong>2) No search term in URL</strong></p>
<p>This is a bit more difficult, since you can't use the URL anymore. This means that the URL stays the same (or has some generic search path), and you need to look into on-page elements for information on what the user searched for. Some DOM scraping and the <strong>page</strong> field should do the trick.</p>
<p><strong>3) Nothing on the page to use</strong></p>
<p>This is the most difficult scenario to handle, since there's nothing on the page for you to latch on to. Perhaps the search term isn't iterated (stupid), or it's not contained in a DOM element (stupid, stupid). This time, we'll try to get the value of the search field in the form submit event, and pass that as a virtual pageview.</p>
<h2 id="1-no-query-parameter-in-url">1) No query parameter in URL</h2>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/search-without-parameter.jpg" title="Site search without query parameter">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/search-without-parameter.jpg#ZgotmplZ" alt="Site search without query parameter">
  
    </a>
  
  
</div>


<p>I see this pretty often. You have a search tool but it doesn't utilize a query parameter for the search term. Rather, it displays the keyword in a virtual folder in the URI. Nothing wrong with that, though every CMS should let you choose how the search terms are displayed in the URL.</p>
<p>This is what you're going to do:</p>
<ol>
<li>
<p>In your ordinary pageview tag, you click open the <strong>Fields to set</strong> setting, and you add a new field with <strong>page</strong> as the field name. Field value would be the reference to a Custom JavaScript Macro <code>{{search path}}</code>.</p>
</li>
<li>
<p>This macro will look for the search term in the URL</p>
</li>
<li>
<p>If it finds a search term, it will return the modified document path with the search term as a query parameter</p>
</li>
<li>
<p>If no search term is found, the macro returns false, meaning the document path will not be modified, and the pageview will fire normally</p>
</li>
</ol>
<p>That's the beauty of GTM, again. Since the macro returns false for non-search pageviews, you'll just need the one, single, normal, ordinary pageview tag to cover all the searches as well. No need for extra tags, woohoo!</p>
<p>So, let's say that the site search term is displayed like it's displayed on <a href="http://www.drupal.org">www.drupal.org</a>: /search/site/<strong>keyword</strong>. The <code>{{search path}}</code> macro should first check if the URI starts with /search/site/, and if it does, it should return whatever comes after, properly modified into a proper path.</p>
<p>Here's the code for the <code>{{search path}}</code> macro:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">var</span> regex = <span style="color:#099">/^\/search\/site\/(.*)/</span>;
  <span style="color:#00a">if</span>(regex.test({{url path}})) {
    <span style="color:#00a">return</span> <span style="color:#a50">&#34;/search/site?q=&#34;</span> + regex.exec({{url path}})[<span style="color:#099">1</span>];
  }
  <span style="color:#00a">return</span>;
}
</code></pre></div>
<p>The regular expression looks at the <code>{{url path}}</code> macro (which stores the current URI of the page), and if the path starts with /search/site/, it returns a modified version of the URI with the search term appended as the value of the query parameter <strong>q</strong>. Change this parameter to reflect whatever you want to have in your Google Analytics view's site search settings.</p>
<p>Finally, just edit your pageview tag, add a new field to <strong>Fields to set</strong>, set <strong>page</strong> as the field name, and add your macro as its value. That's all there is to it!</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/document-path-in-tag1.jpg" title="Page in the Fields To Set">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/document-path-in-tag1.jpg#ZgotmplZ" alt="Page in the Fields To Set">
  
    </a>
  
  
</div>


<p>Don't forget to do some Preview &amp; Debugging, and also check with a debugger like <a href="http://webanalyticssolutionprofiler.com/">WASP</a> to see if the path gets sent correctly for search terms (and correctly for all other pages as well!).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/document-path.jpg" title="Check with WASP">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/document-path.jpg#ZgotmplZ" alt="Check with WASP">
  
    </a>
  
  
</div>


<h2 id="2-no-search-term-in-url">2) No search term in URL</h2>
<p>OK, this one is a bit trickier. In this case, there's no search term in the URL for you to use. This solution requires that the search term is explicitly presented in an HTML element we can grab onto. The best way is to have it in a <code>span</code> or <code>div</code> with a unique ID attribute. Since it's the best way, it's the one I'll be using in this example, with a <code>&lt;span&gt;</code> element as the wrapper. Feel free to get creative with the DOM if your search term is hidden deeper in the page.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/search-term-in-dom.jpg" title="Search Term in an HTML element on the page">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/search-term-in-dom.jpg#ZgotmplZ" alt="Search Term in an HTML element on the page">
  
    </a>
  
  
</div>


<p>For this to work, this is what happens:</p>
<ol>
<li>
<p>In your ordinary pageview tag, you click open the <strong>Fields to set</strong> setting, and you add a new field with <strong>page</strong> as the field name. Field value would be the reference to a Custom JavaScript Macro <code>{{search path}}</code></p>
</li>
<li>
<p>This macro will look for the search term in the HTML element with the ID you specify, using a new DOM Element Macro <code>{{search term}}</code></p>
</li>
<li>
<p>If it finds a search term, the <code>{{search path}}</code> macro will return the modified document path with the search term as a query parameter</p>
</li>
<li>
<p>If no search term is found, the macro returns false, meaning the Document Path will not be modified, and the pageview will fire normally</p>
</li>
</ol>
<p>First, let's create the DOM Element Macro <code>{{search term}}</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/dom-element.jpg" title="DOM Element Macro with site search term">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/dom-element.jpg#ZgotmplZ" alt="DOM Element Macro with site search term">
  
    </a>
  
  
</div>


<p>Replace the <strong>Element ID</strong> field with whatever your page is using.</p>
<p>Next, we'll need to edit the Custom JavaScript Macro <code>{{search path}}</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">if</span>({{search term}} &amp;&amp; {{search term}} !== <span style="color:#a50">&#39;null&#39;</span>) {
    <span style="color:#00a">return</span> <span style="color:#a50">&#34;/search/site?q=&#34;</span> + {{search term}};
  }
  <span style="color:#00a">return</span>;
}
</code></pre></div>
<p>So first we check if an element with the ID you specify exists. If it does, the macro returns <code>&quot;/search/site?q=&lt;keyword&gt;&quot;</code> as the document path, same as in the previous example. If no such element is found, the macro returns false, and the original document path (i.e. the URI of the page the visitor is on) is sent.</p>
<p>The final step is the same as before: edit your pageview tag, add a new field to the <strong>Fields to set</strong>, set the field name to <strong>page</strong>, and add this <code>{{search path}}</code> macro as the field value.</p>
<p>Oh, and don't forget to preview, debug, and test, test, test.</p>
<h2 id="3-nothing-on-the-page-to-use">3) Nothing on the page to use</h2>
<p>This is bleak, but it happens. There's absolutely <em>nothing</em> in the document object model that you can use to grab the search term. The URL is blank, there's no search term printed on the page, no fairies whispering in your ear, NOTHING. I know, it sucks. Fire your developer. Just kidding. No, seriously, fire them. Yeah, I'm just kidding.</p>
<p>I've chosen to fix this using <a href="https://www.simoahava.com/analytics/form-tracking-google-tag-manager/">form tracking</a>. It basically requires that your search field has some unique identifier you can grab hold of in the submit event. I hope you have a proper ID for the field (or at least a CLASS or NAME!). I'm using ID here, again, but feel free to modify the script to get the value of the page.</p>
<p>The thing is, you'll need to send a virtual pageview with the form submission, and it will have the search term in the Document Path as in the previous examples. However, if you send a new pageview with the search, you'll be double-counting your search views, since you'll be sending a pageview for when the search page loads as well! You don't want that. That's why this case is a bit more complex, as you'll be using a <em>browser cookie</em> to carry the search term into the search page pageview, so you can then use that as the document path.</p>
<p>Here's what's happening:</p>
<ol>
<li>
<p>Have a Form Submit Listener tag firing on all pages</p>
</li>
<li>
<p>Create a new Custom HTML Tag which fires upon <strong><code>{{event}}</code> equals gtm.formSubmit</strong>, i.e. when a form is submitted</p>
</li>
<li>
<p>In this tag verify that a search was made, and retrieve the search term using a DOM Element Macro <code>{{search field value}}</code></p>
</li>
<li>
<p>In the tag, save this search term in a new browser cookie named &ldquo;keyword&rdquo;</p>
</li>
<li>
<p>Create a new 1st Party Cookie Macro <code>{{cookie search term}}</code>, which retrieves this cookie value</p>
</li>
<li>
<p>In the <code>{{search path}}</code> Custom JavaScript Macro, check if cookie exists; if it does, use that as the virtual page path</p>
</li>
<li>
<p>Utilize <code>{{search path}}</code> as the value of a new field in the <strong>Fields to set</strong> settings of the Tag. Set the field name to <strong>page</strong> and the macro as the field value.</p>
</li>
<li>
<p>Create a new Custom JavaScript Macro <code>{{searchCallback}}</code>, which deletes the cookie in the callback function of the pageview tag</p>
</li>
</ol>
<p>PHEW!</p>
<p>First, the Form Submit Listener. This is easy, just create a new tag of type Form Submit Listener, and have it fire on all pages.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/form-submit-listener.jpg" title="Form Submit Listener tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/form-submit-listener.jpg#ZgotmplZ" alt="Form Submit Listener tag">
  
    </a>
  
  
</div>


<p>After that, create the DOM Element Macro <code>{{search field value}}</code>. Be sure to change the <strong>Element ID</strong> setting to the ID of the form field your webpage uses in site search.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/dom-form-search-value.jpg" title="DOM Element Macro for field value">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/dom-form-search-value.jpg#ZgotmplZ" alt="DOM Element Macro for field value">
  
    </a>
  
  
</div>


<p>Next, create a new Custom HTML Tag which fires upon <strong><code>{{event}}</code> equals gtm.formSubmit</strong>. Have the following code within:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
  <span style="color:#00a">if</span>({{search field value}} &amp;&amp; {{search field value}} !== <span style="color:#a50">&#39;null&#39;</span>) {
    <span style="color:#0aa">document</span>.cookie = <span style="color:#a50">&#34;keyword=&#34;</span>+{{search field value}}+<span style="color:#a50">&#34;;path=/&#34;</span>;
  }
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>Here we look for an HTML element with the ID &ldquo;search-field&rdquo;, and with a VALUE attribute. If this is found, then the content of this attribute is set into a new cookie named &ldquo;keyword&rdquo;. This is, in fact, whatever was typed into the search field at the time of form submission.</p>
<p>(<strong>NOTE!</strong> If there are multiple forms on a page, you might want to enhance this tag with a check that it was actually the search form that was submitted. It's possible that another form is submitted with text in the search field, and this script would then falsely interpret this event as a submission of the site search form.)</p>
<p>Next, create a new 1st Party Cookie Macro, which retrieves the value from the &ldquo;keyword&rdquo; cookie. Call this <code>{{cookie search term}}</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/cookie-macro-keyword.jpg" title="1st Party Cookie Macro for keyword">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/cookie-macro-keyword.jpg#ZgotmplZ" alt="1st Party Cookie Macro for keyword">
  
    </a>
  
  
</div>


<p>Next, modify the Custom JavaScript Macro <code>{{search path}}</code> to look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">if</span>({{cookie search term}}) {
    <span style="color:#00a">return</span> <span style="color:#a50">&#34;/search/site?q=&#34;</span> + {{cookie search term}};
  }
  <span style="color:#00a">return</span>;
}
</code></pre></div>
<p>So, first we check if the cookie exists. If it does, then its value is returned as a properly formatted Document Path for the pageview tag.</p>
<p>Finally, create a new Custom JavaScript Macro <code>{{searchCallback}}</code>, which looks like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">if</span>({{cookie search term}}) {
    <span style="color:#00a">return</span> <span style="color:#00a">function</span>() {
      <span style="color:#0aa">document</span>.cookie = <span style="color:#a50">&#34;keyword=;path=/;expires=Thu, 01-Jan-70 00:00:01 GMT&#34;</span>;
    }
  }
  <span style="color:#00a">return</span>;
}
</code></pre></div>
<p>This looks for the &ldquo;keyword&rdquo; cookie, and if one is found, then the cookie is deleted. This is extremely important, since you don't want to keep on sending the virtual pageview with every single page load! Cookies are deleted by setting their expiration date to the past.</p>
<p>Put these all together in your pageview tag, utilizing the <strong>Fields to set</strong> with both <strong>hitCallback</strong> and <strong>page</strong> populated accordingly.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/07/pageview-tag-with-changes1.jpg" title="Pageview tag with changes">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/07/pageview-tag-with-changes1.jpg#ZgotmplZ" alt="Pageview tag with changes">
  
    </a>
  
  
</div>


<p>Why have the cookie deletion in the hitCallback and not in the macro which returns the document path? Well, two reasons:</p>
<ol>
<li>
<p>A macro shouldn't be used to set anything. The callback macro is obviously an exception, since it RETURNS a function which sets something.</p>
</li>
<li>
<p>There's some weird race condition in play, and if you refer to the 1st Party Cookie macro in the same script which also deletes the cookie, the macro returns an undefined. I'll have to research this phenomenon a bit more.</p>
</li>
</ol>
<p>This was way more difficult than the other methods, and let's face it: If you need to resort to the form submission, you should probably flog your developer first. Make them create a site search engine that actually works with analytics, since it really is one of the best things you can measure.</p>
<h2 id="conclusions">Conclusions</h2>
<p>I was long overdue a traditional tutorial post, so I hope you've enjoyed this one. I'm still working on the JavaScript for GTM: Part 2 (<a href="https://www.simoahava.com/analytics/javascript-101-gtm-part-1/">check Part 1 here</a>), but now I'm also dreaming about the mini-vacation that starts tomorrow.</p>
<p>However, if this post raises any questions, if you have other ideas for tracking site search, or if you have a problem you need help with, feel free to drop a line below in the comments! Nothing like a JavaScript challenge to make summer more fun.</p>
<p>Have a great, warm, relaxing summer, my friends! Live life to the fullest, and dream of JavaScript and all things wonderful.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/guide/">Guide</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">JavaScript</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/site-search/">site search</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/internalize-google-analytics-v1-0/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/javascript-101-gtm-part-1/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Fix%20GA%20Site%20Search%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/internalize-google-analytics-v1-0/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/javascript-101-gtm-part-1/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Fix%20GA%20Site%20Search%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Fix%20GA%20Site%20Search%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/fix-ga-site-search-google-tag-manager/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

