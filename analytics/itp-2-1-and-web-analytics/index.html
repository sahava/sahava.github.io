

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "ITP 2.1 And Web Analytics | Simo Ahava's blog",
  "image": "https://www.simoahava.com/images/2019/02/itp-2-1-web-analytics.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.simoahava.com/images/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/",
  "datePublished": "2019-02-28T10:52:16+02:00",
  "dateModified": "2019-02-28T10:52:16+02:00",
  "description": "An overview of Safari's Intelligent Tracking Prevention 2.1 release and the potential impact it has on web analytics going forward.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.53 with theme Tranquilpeak 0.4.3-BETA">
    <title>ITP 2.1 And Web Analytics | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    <script src="//de.cdn-v3.conductrics.com/ac-GeQBKxGTiA/v3/agent-api/js/f-TNZdDPOknZ/dt-8BnrVvfJuB1PwktQxXXgVK2OikZ9WR?apikey=api-WDrqMnckreSqejZgDAMu" type="text/javascript"></script>

    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PZ7GMV9');</script>
    
    <script src="//simoahava.disqus.com/count.js" id="dsq-count-scr" async></script>
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/itp-2-1-and-web-analytics/">
    
    <meta name="description" content="An overview of Safari&#39;s Intelligent Tracking Prevention 2.1 release and the potential impact it has on web analytics going forward.">
    <meta property="og:description" content="An overview of Safari&#39;s Intelligent Tracking Prevention 2.1 release and the potential impact it has on web analytics going forward.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="ITP 2.1 And Web Analytics">
    <meta property="og:url" content="/analytics/itp-2-1-and-web-analytics/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="ITP 2.1 And Web Analytics">
    <meta name="twitter:description" content="An overview of Safari&#39;s Intelligent Tracking Prevention 2.1 release and the potential impact it has on web analytics going forward.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/02/itp-2-1-web-analytics.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/02/itp-2-1-web-analytics.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      ITP 2.1 And Web Analytics
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-02-28T10:52:16&#43;02:00">
        
  February 28, 2019

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/#disqus_thread">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              

<blockquote>
<p>Updated <strong>2 March 2019</strong> with additional <a href="#technical-implications-and-solutions">solutions</a>.</p>
</blockquote>

<p>On 21st February 2019, <a href="https://webkit.org/">WebKit</a> announced the release of the latest iteration of Safari&rsquo;s <strong>Intelligent Tracking Prevention</strong> (ITP), known as <a href="https://webkit.org/blog/8613/intelligent-tracking-prevention-2-1/">ITP 2.1</a>. For a while now, Safari has been targeting cross-site tracking with ITP, first starting with <a href="https://webkit.org/blog/7675/intelligent-tracking-prevention/">cookies in third-party contexts</a>, then <a href="https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/">tightening the noose</a> after a number of workarounds emerged, and finally with the latest iteration targeting cookies that were moved from a third-party context to a first-party context.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/02/itp-2-1-web-analytics.jpg" title="ITP 2.1 and web analytics">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/itp-2-1-web-analytics.jpg#ZgotmplZ" alt="ITP 2.1 and web analytics">
  
    </a>
  
  
</div>



<p>ITP 2.1 has one specific feature that will make us web analytics folks tremble in our boots:</p>

<blockquote>
<p>With ITP 2.1, all persistent client-side cookies, i.e. persistent cookies created through document.cookie, are capped to a <strong>seven day expiry</strong>.</p>
</blockquote>

<p>From <a href="https://webkit.org/blog/8613/intelligent-tracking-prevention-2-1/">the WebKit blog</a>, emphasis mine.</p>

<p>This means that any <strong>JavaScript library</strong> wanting to store a cookie in the web browser will have that cookie capped to a seven day lifetime. After seven days since cookie creation, the cookie will expire and will be removed from the browser.</p>

<p>In this article, I want to explore the implications this has on web analytics, and what we can do to avoid losing the integrity of our data.</p>

<h2 id="brief-introduction-to-itp">Brief introduction to ITP</h2>

<p>In the following chapters, I will use these two terms:</p>

<ul>
<li><p><strong>Third-party context</strong> means that a resource is requested from a domain external from the one the user is currently on (i.e. they don&rsquo;t <strong>share</strong> the same <a href="https://godoc.org/golang.org/x/net/publicsuffix">eTLD + 1</a>), and this request tries to access cookies set on this external domain. Since the domain differs from the one the user is on (has to be a different root domain, basically), the interaction with this external domain happens in a <strong>third-party context</strong>.</p></li>

<li><p><strong>First-party context</strong> means that a resource is requested from the current (parent) domain (eTLD + 1) the user is on. Since the user is in the same domain environment, any requests made happen in a <strong>first-party context</strong>.</p></li>
</ul>

<h3 id="itp-1-0">ITP 1.0</h3>

<p>When Safari <a href="https://webkit.org/blog/7675/intelligent-tracking-prevention/">first introduced</a> Intelligent Tracking Prevention, its mission was fairly clear. Safari wanted to prevent domains classified as having tracking capabilities from tracking users across different sites using <strong>third-party cookies</strong>.</p>

<p>A classic example is how advertising technology services might build an audience profile of their users by observing on which sites the user visits. This is done by having those sites call the AdTech domain with a pixel request or something similar, and a third-party cookie stored on the AdTech domain will thus be able to build a profile of the user based on the sites where the pixel was requested on.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/02/ad-tech-third-party.jpg" title="Ad Tech third party cookie">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/ad-tech-third-party.jpg#ZgotmplZ" alt="Ad Tech third party cookie">
  
    </a>
  
  
</div>



<p>ITP made this more difficult by requiring that users actually <strong>interact</strong> with the third-party domain in a first-party context in order for the domain to be allowed to harvest their data in a third-party context. If there was no <strong>meaningful interaction</strong> such as loading the page and clicking on a button, a machine learning algorithm would classify the domain as having cross-site tracking capabilities, and as a result <strong>partition</strong> the cookies on that domain, preventing them from being used for cross-site tracking.</p>

<p>Remember: ITP&rsquo;s main <em>modus operandi</em> is <strong>preventing cross-site tracking</strong>. It&rsquo;s Intelligent <strong>Tracking</strong> Prevention, not Intelligent <strong>Cookie</strong> Prevention.</p>

<p>Naturally, for AdTech this is awkward. The whole point of pixel tracking is that it&rsquo;s transparent and unobtrusive. What would you think if you were suddenly redirected to e.g. <strong>doubleclick.net</strong> and asked if it&rsquo;s ok that Google continues to build an audience profile out of your web browsing behavior?</p>




<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2019/02/itp-original-tracking-prevention-timeline.jpg" title="From https://webkit.org/blog/7675/intelligent-tracking-prevention/">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/itp-original-tracking-prevention-timeline.jpg#ZgotmplZ" alt="From https://webkit.org/blog/7675/intelligent-tracking-prevention/">
  
    </a>
  
   
    <span class="caption">From https://webkit.org/blog/7675/intelligent-tracking-prevention/</span>
  
</div>



<p>But, third-party cookies can also be used for <strong>non-tracking purposes</strong>, such as maintaining a single sign-on (SSO) session. This is why the original ITP introduced a 24-hour grace period during which time the SSO cookie could be used in a third-party context. After that, the cookies should be stored in a first-party context or, preferably, by moving to <strong>HTTP cookies</strong> (more on this later) to avoid these issues altogether.</p>

<p>The cookies would be <strong>partitioned</strong> for 30 days. This meant that cookies used for tracking purposes get a unique storage double-keyed to the domain requesting the cookie (the first-party domain), and the domain setting the cookie (third-party domain). So, for example, a third-party cookie set by <strong>google.com</strong> while on <strong>simoahava.com</strong> would only be accessible when browsing simoahava.com. If the user went to <strong>johnahava.com</strong>, a separate cookie store would be created for that origin.</p>

<p>Partitioning the cookies this way meant that third-party cookies could still be used for things like login state management. Since the partitions are unique to each origin combination, cross-site tracking would effectively be neutered.</p>

<p>If the user visited the tracking domain within 30 days of the last interaction, both the 24-hour grace period and the 30-day partition timer would be reset.</p>

<p>If the 30-day limit expired without interaction with the tracking domain, all cookies would be purged from the tracking domain.</p>

<p>ITP 1.0 wasn&rsquo;t very impactful for us <a href="https://analytics.google.com/">Google Analytics</a> users. GA works in a first-party context, so ITP&rsquo;s updates did not concern us.</p>

<h3 id="itp-1-1-and-storage-access-api">ITP 1.1 and Storage Access API</h3>

<p>With <a href="https://webkit.org/blog/8142/intelligent-tracking-prevention-1-1/"><strong>ITP 1.1</strong></a> and the <a href="https://webkit.org/blog/8124/introducing-storage-access-api/">Storage Access API</a>, ITP made some concessions to third-party services serving embedded content, such as social logins or video services. It would be weird to have the user visit these services in a first-party context, because the whole purpose of embedding content is to do it smoothly while staying on the same site. The <strong>Storage Access API</strong> was the solution, where embedded content would be given access to the cookies stored on the third-party domain as long as the embed followed certain rules:</p>




<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2019/02/storage-access-embed.jpg" title="From https://webkit.org/blog/8124/introducing-storage-access-api/">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/storage-access-embed.jpg#ZgotmplZ" alt="From https://webkit.org/blog/8124/introducing-storage-access-api/">
  
    </a>
  
   
    <span class="caption">From https://webkit.org/blog/8124/introducing-storage-access-api/</span>
  
</div>



<p>The Storage Access API did not prompt the user for anything - this was the major concession from WebKit.</p>

<p>Since the Storage Access API allowed access to the third-party domain&rsquo;s own, non-partitioned cookies, the <em>partitioned</em> cookies preserved for things like login state management were demoted to <em>session cookies</em>, so they would get purged once the browser was closed. This meant that the Storage Access API was the main way to access persistent data in a third-party context.</p>

<p>Still no issues with first-party web analytics, phew!</p>

<h3 id="itp-2-0">ITP 2.0</h3>

<p>Mid-2018, WebKit introduced <a href="https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/"><strong>ITP 2.0</strong></a>.</p>

<p>ITP 2.0 removed the 24-hour grace period altogether. Now cookies would be partitioned immediately after creation, if the domain was classified as having cross-site tracking capabilities.</p>




<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2019/02/itp-2-diagram.jpg" title="From https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/itp-2-diagram.jpg#ZgotmplZ" alt="From https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/">
  
    </a>
  
   
    <span class="caption">From https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/</span>
  
</div>



<p>Another major thing ITP 2.0 did was make Storage Access API prompt-based. Instead of allowing embedded content to access cookies set in a third-party context by virtue of following the rules established in the previous chapter, Safari would now explicitly prompt the user for access to the third-party context. If the user gave access, the consent would persist and the 30-day timeline would be refreshed.</p>

<p>In other words, the <strong>Storage Access API</strong> was now the main way for domains classified as having cross-site tracking capabilities to access their cookies when embedded or requested in a third-party context.</p>

<p>First-party web analytics is still safe. But not for long.</p>

<h2 id="itp-2-1">ITP 2.1</h2>

<p><a href="https://webkit.org/blog/8613/intelligent-tracking-prevention-2-1/">ITP 2.1</a> was announced of February 21st, 2019, and it will come to effect as soon as <strong>iOS 12.2</strong> and <strong>Safari 12.1</strong> come out of beta. I&rsquo;ve heard rumors this would be sometime in March before the <a href="https://www.imore.com/apple-march-2019-event-preview">Apple event</a>.</p>

<p>ITP 2.1 removes partitioned cookies altogether. Now if a domain classified as having cross-site tracking capabilities needs to have access to its cookies in a third-party context, the <strong>Storage Access API</strong> <em>must</em> be used, even if used for things like login state management. The main purpose of this change is to reduce the amount of memory overhead that partitioned (session) cookies introduce on any given site.</p>

<p>But by far the biggest change in ITP 2.1, one that has <strong>direct consequences on first-party web analytics</strong> are the new measures placed on <strong>first-party cookies</strong> set with client-side JavaScript.</p>

<p>No longer is ITP just attacking AdTech companies who rely on cross-site tracking to build audience profiles. Now cookies set with <code>document.cookie</code> will also be targeted to prevent them from being harvested on different subdomains than the one on which they were set.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/02/first-party-cookies.jpg" title="First party cookies">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/first-party-cookies.jpg#ZgotmplZ" alt="First party cookies">
  
    </a>
  
  
</div>



<p>As in the above example, any one of the subdomains of <strong>simoahava.com</strong> can write a first-party cookie on that root domain, after which <strong>any</strong> subdomain of simoahava.com can access that cookie. This is nothing new - this is how cookies set on a root domain have always worked.</p>

<p>However, ITP now targets cookies set with JavaScript&rsquo;s <code>document.cookie</code> because it has become apparent that vendors have replaced cross-site tracking in a third-party context with cross-site tracking in a first-party context.</p>

<p>The impact on web analytics is brutal, depending of course on Safari share of your traffic. Take the following example:</p>

<ul>
<li><p><strong>Day 1</strong>: User visits www.simoahava.com, the <code>_ga</code> cookie is written on simoahava.com. It is set at a 7-day expiry (rather than the 2 years that analytics.js defaults to).</p></li>

<li><p><strong>Day 3</strong>: User visits blog.simoahava.com. The <code>_ga</code> cookie is found on simoahava.com, so its value is available to blog.simoahava.com, and the 7-day expiry is reset.</p></li>

<li><p><strong>Day 13</strong>: User visits www.simoahava.com. The <code>_ga</code> cookie has expired, so a new Client ID is generated in a new <code>_ga</code> cookie, and the visitor is <strong>treated as a new user</strong> in Google Analytics.</p></li>
</ul>

<p>Google Analytics uses <code>document.cookie</code> to set the cookie in the browser. It really has no other choice. It&rsquo;s a vendored JavaScript library, downloaded from Google&rsquo;s servers, so it has no capability of setting e.g. HTTP cookies on simoahava.com, since they would be set in a third-party context.</p>

<p>Funnily enough, ITP 2.1 removes support for the <strong>Do Not Track</strong> signal in Safari, denoting the end to this miserable experiment in WebKit. Had more sites respected DNT when determining should visitors be tracked or not, perhaps we wouldn&rsquo;t have seen ITP 2.1 in its current shape.</p>

<p>But because sites can&rsquo;t be trusted to handle privacy and tracking prevention on their own, Safari must now take the reins and do it for them.</p>

<h2 id="technical-implications-and-solutions">Technical implications and solutions</h2>

<p>First of all, ITP 2.1 really only impacts <strong>browser cookies</strong> set with <code>document.cookie</code>. It will <strong>not</strong> impact other DOM storage (such as <code>localStorage</code>), because those are same-origin only, so lacking the capability of working across sub-domains. Similarly, it will <strong>not</strong> impact cookies set with HTTP responses, i.e. using the <code>Set-Cookie</code> header in the HTTP response.</p>

<p>HTTP cookies require a server-side script (or an edge cache / serverless solution) to modify the HTTP response, so it&rsquo;s a deliberate decision from the site owner to set the cookies in the first-party context rather than a JavaScript library downloaded from a CDN being able to, at whim, set and get any first-party cookies it wants to. I suppose this is why they are not (yet) impacted by ITP.</p>

<h3 id="localstorage-for-same-domain-browsing">localStorage for same-domain browsing</h3>

<p>Many suggested using <code>localStorage</code> to persist these anonymous identifiers used by Google Analytics, for example. Instead of dropping a cookie named <code>_ga</code>, use <code>window.localStorage.setItem()</code> instead.</p>

<p>I was excited about this option, and even <a href="https://www.simoahava.com/analytics/use-localstorage-client-id-persistence-google-analytics/">wrote an article</a> that describes this possibility in detail.</p>

<p>However, the main issue is that <code>localStorage</code> is same-origin only. The storage in www.simoahava.com will not be available on blog.simoahava.com.</p>

<p>Thus the only thing that <code>localStorage</code> actually solves is not having the 7-day expiration cap on data stored on a single domain. Since all my web traffic happens on www.simoahava.com, the <code>localStorage</code> is a good option for me, since it persists the Client ID nicely (though with <a href="https://www.simoahava.com/analytics/use-localstorage-client-id-persistence-google-analytics/#caveats">some caveats</a> nevertheless).</p>

<h3 id="localstorage-for-cross-subdomain-browsing">localStorage for cross-subdomain browsing</h3>

<blockquote>
<p>Thanks to <a href="https://www.linkedin.com/in/eike-pierstorff-77a4a166/">Eike Pierstorff</a> and <a href="https://twitter.com/fujii0">Fujii Hironori</a> for suggesting this solution.</p>
</blockquote>

<p>An alternative option to same-domain <code>localStorage</code> is to create a <strong>store</strong> on a page in one of your subdomains, and then load that page in an <code>iframe</code> element, utilizing the  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage"><code>postMessage</code> API</a> to get and set persistent cookie values on your site.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/02/postmessage-localstorage-store.jpg" title="localStorage postMessage store">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/02/postmessage-localstorage-store.jpg#ZgotmplZ" alt="localStorage postMessage store">
  
    </a>
  
  
</div>



<p>Since the <code>localStorage</code> store shares the same parent domain <a href="https://godoc.org/golang.org/x/net/publicsuffix">eTLD + 1</a> with the pages making the requests through the iframe, the interaction happens in a first-party context, and the <code>localStorage</code> store can be accessed without the Storage Access API. Also, in <strong>third-party contexts</strong>, <code>localStorage</code> is <strong>transient</strong> in Safari, meaning it is purged after the browser is closed. In first-party context this is not the case.</p>

<p>The process would look like this.</p>

<ol>
<li><p>The page wanting to access the store would load the tracker page in an iframe, and send a message to it requesting a stored Client ID.</p></li>

<li><p>The iframe checks if it has the Client ID stored. If it does, it returns it in a message back to the origin page. If it doesn&rsquo;t, it returns a string indicating this.</p></li>

<li><p>On the origin page, a listener listens for the response. If the response has a Client ID, that is used in the trackers running on the page. If the response has a &ldquo;null&rdquo; indicator, the origin page builds the Client ID, and finally sends it with another message back into the iframe for storage.</p></li>
</ol>

<p>Here&rsquo;s what the parent page script would look like:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Create iframe
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">el</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;iframe&#39;</span>);
<span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://www.maindomain.com/tracker.html&#39;</span>;
<span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;style&#39;</span>, <span style="color:#e6db74">&#39;width:0;height:0;border:0;border:none&#39;</span>);
document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">el</span>);

<span style="color:#75715e">// Add listener to get the stored Client ID
</span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">origin</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;https://www.maindomain.com&#39;</span>) { <span style="color:#66d9ef">return</span>; }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">data</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;null&#39;</span>) { <span style="color:#a6e22e">generateTracker</span>(<span style="color:#66d9ef">null</span>); }
  <span style="color:#66d9ef">else</span> { <span style="color:#a6e22e">generateTracker</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">data</span>); }
});

<span style="color:#75715e">// Send request to get the Client ID
</span><span style="color:#75715e"></span><span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">contentWindow</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#e6db74">&#39;get&#39;</span>, <span style="color:#e6db74">&#39;https://www.maindomain.com&#39;</span>);

<span style="color:#75715e">// Send message to set the Client ID after the tracker has generated one
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">trackerGeneratedCallback</span>(<span style="color:#a6e22e">clientId</span>) {
  <span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">contentWindow</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#a6e22e">clientId</span>, <span style="color:#e6db74">&#39;https://www.maindomain.com&#39;</span>);
}
</code></pre></div>

<p>Here, the iframe is generated, after which a message is sent to the iframe to get the Client ID. A listener on the page then waits for the iframe to respond. If the iframe responds with a <code>'null'</code> message, a new tracker is generated (<code>generateTracker</code>) with its default Client ID generation mechanism.</p>

<p>If the iframe responds with the stored Client ID, then a new tracker is generated with this stored Client ID instead.</p>

<p>If the tracker <strong>did</strong> generate a new Client ID, then the <code>trackerGeneratedCallback</code> is called afterwards, and this sends the Client ID to the tracker page for storage.</p>

<p>And this is what the iframe page would look like:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">html</span>&gt;
&lt;<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;robots&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;noindex,nofollow&#34;</span>&gt;
&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#75715e">// Check the request comes from *.maindomain.com
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">hostNameRegex</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^https:\/\/([^.]+\.)maindomain\.com/</span>;
  
  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">processMessage</span>(<span style="color:#a6e22e">event</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">hostnameRegex</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">origin</span>)) {
      <span style="color:#66d9ef">return</span>;
    }
    
    <span style="color:#75715e">// If request is to get the clientId, send it as a message back to the source page
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// or send &#39;null&#39; if no Client ID is found.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;get&#39;</span>) {
      <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">postMessage</span>(window.<span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;ga_client_id&#39;</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;null&#39;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">origin</span>);
      <span style="color:#66d9ef">return</span>;
    }
    
    <span style="color:#75715e">// Otherwise, set the Client ID in localStorage using the message content
</span><span style="color:#75715e"></span>    window.<span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;ga_client_id&#39;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span>);
    <span style="color:#66d9ef">return</span>,
  }
  
  <span style="color:#75715e">// Add a listener to listen for postMessage messages
</span><span style="color:#75715e"></span>  window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">processMessage</span>);
&lt;/<span style="color:#f92672">script</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;</code></pre></div>

<p>This way you could persist any client-side cookie values in the <code>localStorage</code> store of the domain where the iframe rests. This example is just for an arbitrary Client ID, but you could extend it for any value passed in the message.</p>

<p>Just remember the idiosyncracies of each platform. With Google Analytics, for example, additional measures need to be taken to handle cross-domain tracking, cookie expiration, etc.</p>

<h3 id="set-cookie-headers-in-a-server-side-script">Set-Cookie headers in a server-side script</h3>

<p>Instead of setting the <code>_ga</code> cookie with <code>document.cookie</code>, you could instead set it with the HTTP response. For example, if running a <strong>node.js</strong> Express server, you could have the following lines in your code:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
  <span style="color:#75715e">// Check for existing cookie and use that if found
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">ga</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">cookies</span>[<span style="color:#e6db74">&#39;_ga&#39;</span>];
  
  <span style="color:#75715e">// Check for linker and use that if valid
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>[<span style="color:#e6db74">&#39;_ga&#39;</span>]) {
    <span style="color:#a6e22e">ga</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getClientIdFromLinker</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>[<span style="color:#e6db74">&#39;_ga&#39;</span>]) <span style="color:#f92672">||</span> <span style="color:#a6e22e">ga</span>;
  }
  
  <span style="color:#75715e">// Otherwise generate a new Client ID
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">ga</span>) {
    <span style="color:#a6e22e">ga</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">generateGAClientId</span>();
  }
  
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">cookie</span>(<span style="color:#e6db74">&#39;_ga&#39;</span>, <span style="color:#a6e22e">ga</span>, {<span style="color:#a6e22e">domain</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;simoahava.com&#39;</span>, <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">expires</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">365</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>), });
  
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">render</span>(<span style="color:#e6db74">&#39;index&#39;</span>);
});
</code></pre></div>

<p>In this example, when the home page is requested from the server, its cookies are parsed. If the <code>_ga</code> cookie is found, its value is stored as a local variable. Then, if the request also has the cross-domain linker parameter, the parameter validity is verified (using e.g. my <a href="https://gist.github.com/sahava/f3718f981bb01768c0eba714ee94e2d2">Gist</a>) and if it&rsquo;s a valid parameter, the local variable is overwritten with the Client ID from the linker.</p>

<p>Finally, if the <code>_ga</code> cookie didn&rsquo;t exist and if the cross-domain linker was missing or broken, a new Client ID is generated.</p>

<p>And in the HTTP response, the <code>_ga</code> cookie is set with this value, and its expiration is reset to two years.</p>

<p>This type of server-side setup should be trivial to do in almost any web server environment (<a href="http://peter.nikolow.me/safari-itp-2-1-demo/">PHP/Apache</a>, React, Node.js, IIS, etc.). But you do need access to the web server and how it handles requests to be able to do this.</p>

<h3 id="set-cookie-headers-in-an-edge-cache">Set-Cookie headers in an edge cache</h3>

<p>If you&rsquo;re using a service such as <a href="https://www.cloudflare.com/">Cloudflare</a>, which caches your server content on &ldquo;the edge&rdquo;, you might also be able to run JavaScript to intercept and handle the HTTP requests between the browser and Cloudflare. On Cloudflare, this technology is called <a href="https://www.cloudflare.com/products/cloudflare-workers/">Cloudflare Workers</a>. Amazon has a similar solution called <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-the-edge.html">Lambda@Edge</a>.</p>

<p>The idea is that when the HTTP request for content comes in, a script running in the edge &ldquo;rewrites&rdquo; any cookies in the HTTP header with <code>Set-Cookie</code>, thus avoiding ITP 2.1 limitations.</p>

<p>Dustin Recko tackled this in a <a href="https://omr.ruhr/google-analytics-itp-2-1-prevention-http-set-cookie-snippet-182092779d40">recent article on ITP 2.1</a>.</p>

<p>Since many sites are already leveraging Cloudflare or Amazon&rsquo;s Cloudfront, this would be a fairly lightweight way to handle the cookie routing.</p>

<h3 id="shared-web-service-referenced-with-a-cname-record">Shared web service referenced with a CNAME record</h3>

<blockquote>
<p>Thanks to <a href="https://www.linkedin.com/in/larsgundersen/">Lars Gundersen</a> for nudging me about this idea.</p>
</blockquote>

<p>This is super interesting. Apparently, it&rsquo;s what <a href="https://helpx.adobe.com/analytics/kb/adobe-analytics-anditp.html">Adobe</a> has already been doing for a while.</p>

<p>The logic is similar to the <a href="#set-cookie-headers-in-a-server-side-script">server-side cookie router</a> and/or the <a href="#localstorage-for-cross-subdomain-browsing"><code>localStorage</code> store</a> described above. But instead of hosting the content on your own domain, you would create the endpoint in a virtual machine running in the Google Cloud, for example, and then create a <a href="https://en.wikipedia.org/wiki/CNAME_record">CNAME record</a> in your DNS to point <code>tracker.mydomain.com</code> to that virtual machine.</p>

<p>Then, when a page is loaded, the first thing it does is call this endpoint (<code>tracker.mydomain.com</code>). The endpoint would grab the cookies from the HTTP headers and use <code>Set-Cookie</code> in the response to write the cookies on <code>mydomain.com</code>, thus avoiding the ITP 2.1 ban on client-side cookies.</p>

<p>Alternatively, you could have <code>tracker.html</code> running in the service, and you&rsquo;d load <code>tracker.mydomain.com/tracker.html</code>) in an iframe, and use that as the <code>localStorage</code> store.</p>

<p>Naturally, this incurs some extra costs, because you would have to route a lot of calls to this cloud endpoint to make sure all the relevant cookies get their expiration extended. This is why, I guess, Adobe offers it as a service.</p>

<p>I&rsquo;d be curious to see if this is something Google is looking at, too. Seems like it would be a somewhat elegant way to handle the problem with the <code>_ga</code> cookie. They could create a service where the GA hit is not sent to <code>google-analytics.com/collect</code> but rather to <code>tracker.mydomain.com/collect</code>. The endpoint would then use <code>Set-Cookie</code> to set the <code>_ga</code> cookie on <strong>mydomain.com</strong>, and it would then forward the original request to GA.</p>

<p>I verified with <a href="https://twitter.com/johnwilander">John Wilander</a> (a WebKit engineer working on ITP) that this should be OK:</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">You’re asking two questions. Let me respond to them separately:<br>1) Same eTLD+1 is same-site, i.e. same “party.” ITP doesn’t look at subdomains.</p>&mdash; John Wilander (@johnwilander) <a href="https://twitter.com/johnwilander/status/1101726191457689600?ref_src=twsrc%5Etfw">March 2, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<h3 id="server-side-proxying">Server-side proxying</h3>

<p>There have been an array of suggestions using terms like <strong>server-side proxying</strong> or <strong>server-side analytics</strong>, but I think these have misunderstood what ITP 2.1 does.</p>

<p>If there is no authentication against a backend, the user&rsquo;s browser is identified with an anonymous identifier set in a cookie. No matter what type of analytics server is used - third-party or first-party - it&rsquo;s this browser cookie that tells the service the user is the same as the one who visited some other page 5 minutes ago.</p>

<p>Changing the endpoint from <code>www.google-analytics.com/collect</code> to <code>proxy.simoahava.com/collect</code>, or changing from <code>www.google-analytics.com/collect</code> to <code>snowplow.simoahava.com/track</code> doesn&rsquo;t change this dynamic. There&rsquo;s no way to really align requests sent from a browser with requests sent by the same browser without having this identifier binding those two together somehow.</p>

<p>And if that cookie is set with <code>document.cookie</code>, it will fall under the 7-day expiration schedule, meaning two requests spread more than 7 days apart will not be able to enjoy the same cookie value any more.</p>

<h2 id="final-thoughts">Final thoughts</h2>

<p>I have many thoughts on this topic. Many, indeed. So let me list them here:</p>

<h3 id="this-is-a-good-thing">This is a good thing&hellip;</h3>

<p>I think anything that questions the validity of browser cookies is a welcome disruption.</p>

<p>It&rsquo;s not just those set with <code>document.cookie</code>. An overwhelming amount of sensitive information is still stored in cookies that do not use the <code>HttpOnly</code> and <code>Secure</code> attributes. See <a href="https://github.com/mikewest/http-state-tokens">this piece by Mike West from Google</a> if you want to be depressed (and there&rsquo;s some cool suggestions for going forward, too).</p>

<p>Anything that makes life even more difficult for AdTech gets a solid thumbs up from me. Turning third-party data leeching into a consent-based prompt via Storage Access API is a great way to give users the reins.</p>

<p>For sites with authentication, this makes it even more prudent to incentivize a login. If a user logs in to the service, no cookies are even needed, since a persistent User ID could be used as the user&rsquo;s identifier sent to analytics platforms (as long as the user&rsquo;s consent for this is requested and as long as the tracking only happens when they&rsquo;re logged in).</p>

<h3 id="but-perhaps-the-baby-was-thrown-out-with-the-bathwater">&hellip;but perhaps the baby was thrown out with the bathwater</h3>

<p>I can&rsquo;t help thinking that <em>benevolent</em> first-party analytics gets hit with collateral damage here.</p>

<p>I had some exchanges in Twitter with the WebKit engineer working on ITP (<a href="https://twitter.com/johnwilander">John Wilander</a>), and this is one of the things he responded to me with:</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Only document.cookie cookies are affected by the 7-day cap in ITP 2.1. Cross-site tracking is bad for people and for the web. Therefore, ITP will evolve to protect users from being tracked.</p>&mdash; John Wilander (@johnwilander) <a href="https://twitter.com/johnwilander/status/1100872846727733249?ref_src=twsrc%5Etfw">February 27, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>I totally agree with cross-site tracking being <em>generally</em> bad. But there are ways to do web analytics without malicious intent. It would have made more sense to prevent cookies from being access across sub-domains, thus forcing sites to append linker parameters to internal links, but expiring all <code>document.cookie</code> setters with a 7-day cap is pretty drastic.</p>

<p>Having Google Analytics running on your site does not make you a bad person - you are using it to optimize the performance and usability of your site, and for creating better landing pages and marketing campaigns. But now that the cookie is capped at 7 days, you basically lose all ability to build cohorts of users who only visit your site once a month, for example, unless you invest in setting HTTP cookies instead.</p>

<p>John&rsquo;s later tweet clarified this:</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Things would be easier if third-parties stayed third-parties. But since site owners bring in third-parties into their first-party context, ITP has to deal with it. Hopefully, we can get to a place where devs help prevent cross-site tracking.</p>&mdash; John Wilander (@johnwilander) <a href="https://twitter.com/johnwilander/status/1100993814456483841?ref_src=twsrc%5Etfw">February 28, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>So it does seem that ITP is taking blanket measures to best target the bad actors in the industry.</p>

<h3 id="and-this-is-definitely-not-the-last-of-it">And this is definitely not the last of it</h3>

<p>It&rsquo;s not just ITP. Firefox will <a href="https://www.fastcompany.com/90299092/mozilla-most-innovative-companies-2019">also start blocking cross-site third-party trackers</a>, no doubt taking a leaf out of ITP&rsquo;s book. They&rsquo;ve already had a very <a href="https://support.mozilla.org/en-US/kb/content-blocking">strong-armed approach</a> to blocking trackers (though in private browsing mode only, for now), so this doesn&rsquo;t come as a big surprise.</p>

<p>As workarounds for ITP are invented, new iterations of ITP will be introduced. Until now, each iteration has made ITP stricter. Even if they made a concession (Storage Access API without user prompt), they seem to not hesitate to pull it back in a later version.</p>

<p>I don&rsquo;t think they&rsquo;ll let go of the 7-day cookie expiration for <code>document.cookie</code>. I think it&rsquo;s up to vendors now to figure out how to overcome this.</p>

<p>Adobe introduced their own ways of <a href="https://helpx.adobe.com/analytics/kb/adobe-analytics-anditp.html">tackling ITP</a> but with the ban on <code>document.cookie</code> it remains to be see how they&rsquo;ll react to ITP 2.1.</p>

<h3 id="going-forward">Going forward</h3>

<p>To sum up this article, here&rsquo;s the key takeaways:</p>

<ol>
<li><p>If you are tracking just root domains, and do not need cross-subdomain tracking to work without explicit linker parameters, you can use the <a href="https://www.simoahava.com/analytics/use-localstorage-client-id-persistence-google-analytics/"><code>localStorage</code> workaround</a>. See <a href="#localstorage-isn-t-a-solid-workaround">this chapter</a> for more information.</p></li>

<li><p>If you think Safari has a big enough share of your traffic to seriously impact your data quality, you should look into writing the <code>_ga</code> cookie using HTTP cookies. See <a href="https://www.simoahava.com/#set-cookie-headers-could-work-for-now">here</a> for a recap.</p></li>

<li><p>Follow <a href="https://twitter.com/johnwilander">John Wilander</a> on Twitter.</p></li>

<li><p>Await an official announcement from Google (or whatever your favorite analytics vendor is) on how they intend to tackle ITP&rsquo;s stranglehold on cookies written with <code>document.cookie</code>.</p></li>
</ol>

<p>For a geeky tech dude like me, we&rsquo;re living in some pretty cool and exciting times. Having to figure out workarounds for this concentrated attack on cookies by (most) web browsers is inspiring!</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/web-development/">web development</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/analytics/">analytics</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/privacy/">privacy</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/itp/">itp</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/use-localstorage-client-id-persistence-google-analytics/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=ITP%202.1%20And%20Web%20Analytics%20https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <span id="disqus"></span>
<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/use-localstorage-client-id-persistence-google-analytics/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=ITP%202.1%20And%20Web%20Analytics%20https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=ITP%202.1%20And%20Web%20Analytics%20https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/itp-2-1-and-web-analytics/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://www.simoahava.com/js/script.js"></script>




  
    
      <script>
        





        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'simoahava';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

