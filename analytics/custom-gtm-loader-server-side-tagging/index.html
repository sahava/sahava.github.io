

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Custom GTM Loader For Server-side Tagging | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2021\/05\/gtm-loader.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/custom-gtm-loader-server-side-tagging\/",
  "datePublished": "2021-05-11T07:11:32\u002b03:00",
  "dateModified": "2021-05-11T07:11:32\u002b03:00",
  "description": "Introducing the GTM Loader server-side tagging Client template. With this Client, you can load the Google Tag Manager container with any request path you like.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Custom GTM Loader For Server-side Tagging | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/custom-gtm-loader-server-side-tagging/">
    
    <meta name="description" content="Introducing the GTM Loader server-side tagging Client template. With this Client, you can load the Google Tag Manager container with any request path you like.">
    <meta property="og:description" content="Introducing the GTM Loader server-side tagging Client template. With this Client, you can load the Google Tag Manager container with any request path you like.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Custom GTM Loader For Server-side Tagging">
    <meta property="og:url" content="https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Custom GTM Loader For Server-side Tagging">
    <meta name="twitter:description" content="Introducing the GTM Loader server-side tagging Client template. With this Client, you can load the Google Tag Manager container with any request path you like.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
	  <meta property="og:image" content="https://www.simoahava.com/images/2021/05/custom-gtm-loader-server-side-tagging.jpg">
      <meta name="twitter:image" content="https://www.simoahava.com/images/2021/05/custom-gtm-loader-server-side-tagging.jpg">
    


    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
    <div class="figure nocaption">
      <img class="cover" src="https://www.simoahava.com/images/2021/05/custom-gtm-loader-server-side-tagging.jpg">
    </div>
  
  

    <h1>
      Custom GTM Loader For Server-side Tagging
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-05-11T07:11:32&#43;03:00">
        
  May 11, 2021

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <blockquote>
<p><strong>Last updated: 2 September 2021</strong>. Added details about how Preview containers won&rsquo;t work if you override the Container ID.</p>
</blockquote>
<p>While <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">server-side tagging</a> already has a wonderful built-in Client for <a href="https://www.simoahava.com/analytics/google-tag-manager-web-container-client-server-side-tagging/">proxying the Google Tag Manager container</a> via your own first-party domain, it&rsquo;s not perfect.</p>
<p>The main issues are that it doesn&rsquo;t let you delimit access on a per-origin basis, so requests for the allowlisted container IDs can be sent from anywhere, and that it doesn&rsquo;t let you freely choose the path via which the container ID is loaded.</p>
<p>To address these issues, I&rsquo;m happy to reveal that I&rsquo;ve written a <strong>new Client template</strong> for Server containers, named <strong>GTM Loader</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/gtm-loader.jpg" title="GTM Loader">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/gtm-loader.jpg#ZgotmplZ" alt="GTM Loader" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1804 1148'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The main features of this template are:</p>
<ul>
<li>Freely choose which request path the Client responds to. You can keep the default <code>/gtm.js</code>, or you can go for something more imaginative, such as <code>/green-dragons</code>.</li>
<li>Always load a container of a specific ID, regardless of what (if anything) is in the <code>?id=</code> parameter of the request.</li>
<li>Only allow requests from specific origins.</li>
</ul>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[–hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#get-the-template">Get the template</a></li>
    <li><a href="#create-a-new-client">Create a new Client</a></li>
    <li><a href="#configure-the-client">Configure the Client</a>
      <ul>
        <li><a href="#request-path">Request Path</a></li>
        <li><a href="#override-container-id">Override Container ID</a></li>
        <li><a href="#allowed-origins">Allowed Origins</a></li>
      </ul>
    </li>
    <li><a href="#how-it-works">How it works</a>
      <ul>
        <li><a href="#validate-the-request">Validate the request</a></li>
        <li><a href="#fetch-the-preview-container">Fetch the preview container</a></li>
        <li><a href="#fetch-the-live-container">Fetch the live container</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>
<p>Read on for more information!</p>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="get-the-template">Get the template</h2>
<p>As the <a href="https://tagmanager.google.com/gallery/">Community Template Gallery</a> doesn&rsquo;t distribute Client templates yet, you&rsquo;ll need to manually import the template file.</p>
<p>First, fetch the raw <code>template.tpl</code> file from the GitHub repo by following <a href="https://raw.githubusercontent.com/gtm-templates-simo-ahava/gtm-loader/main/template.tpl">this link</a> and saving the page as <code>template.tpl</code> in your computer.</p>
<p>Then, in your <strong>Server</strong> container, go to <strong>Templates</strong> and click <strong>New</strong> in the box for Client templates.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/new-client-template.jpg" title="New Client Template">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/new-client-template.jpg#ZgotmplZ" alt="New Client Template" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2470 916'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In the <strong>overflow menu</strong> in the top-right corner of the screen, choose <strong>Import</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/import-template.jpg" title="Import template">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/import-template.jpg#ZgotmplZ" alt="Import template" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1036 708'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Locate the <code>template.tpl</code> file from your container, wait for the editor to refresh with the GTM Loader template, and then click <strong>Save</strong> to save the template.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/save-template.jpg" title="Save template">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/save-template.jpg#ZgotmplZ" alt="Save template" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1944 940'%3E%3C/svg%3E">
  
    </a>
  
  
</div>



                
                  <h2 id="create-a-new-client">Create a new Client</h2>
<p>Head on over to <strong>Clients</strong> in your container, and click <strong>New</strong> to create a new Client.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/new-client.jpg" title="New client">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/new-client.jpg#ZgotmplZ" alt="New client" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2524 568'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>From the list of available Clients, choose the <strong>GTM Loader</strong> Client.</p>
<p>You should be ready now to customize the new Client!</p>

                
                  <h2 id="configure-the-client">Configure the Client</h2>
<p>Here&rsquo;s what the Client looks like with all the available fields in display:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/05/template-ready-for-editing.jpg" title="Client ready for editing">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/05/template-ready-for-editing.jpg#ZgotmplZ" alt="Client ready for editing" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1802 1138'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="request-path">Request Path</h3>
<p>Set this to a path (include the leading slash). You can also just keep the default <code>/gtm.js</code> if you wish.</p>
<p>The Client will be listening for requests to this path, and if an <strong>exact match</strong> is made, the Client will claim the request and work its wonders.</p>
<p>For example, if you set the path to <code>/google_tag_manager.js</code> as in the screenshot above, then a request to <strong>https://&lt;your server-side domain&gt;/google_tag_manager.js?id=GTM-ABCDEFG</strong> will load the Google Tag Manager container with ID <strong>GTM-ABCDEFG</strong> unless you also have the <strong>Override Container ID</strong> setting checked (more on this below).</p>
<p>Remember that it&rsquo;s <strong>exact match</strong>! The request must be with a path that exactly matches the setting you configure in this Client.</p>
<h3 id="override-container-id">Override Container ID</h3>
<blockquote>
<p><strong>Important!</strong> If you override the Container ID, <strong>Preview</strong> containers will not be loaded. This is because Tag Assistant looks at the <strong>id</strong> query parameter in the container request to know which debug container to load. If this is missing from the request, the Preview container cannot be loaded.</p>
</blockquote>
<p>If you check this setting, you can then add a valid Google Tag Manager container ID to the respective field.</p>
<p>This setting means that <em>regardless of what is in the <code>?id=</code> parameter</em>, a container with the configured ID will be returned.</p>
<p>When you have this setting checked, you can actually drop the <code>?id=</code> parameter from the request altogether, as the container with the configured ID will be loaded in all cases.</p>
<h3 id="allowed-origins">Allowed Origins</h3>
<p>In this field, you can add a comma-separated list of <strong>origins</strong> from which requests will only be respected.</p>
<p>For example, if you add <code>https://www.teamsimmer.com,https://www.simoahava.com</code> to the field, then only requests from those two origins will be able to fetch the container.</p>
<p>Remember that the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin#syntax">origin</a> is the scheme (<code>http</code> or <code>https</code>) plus <code>://</code> plus hostname plus port. So basically everything up to the request path.</p>
<p>You can also add <code>*</code> to this field, in which case the Client will claim the request regardless of where it originated from.</p>
<p>If you need to manually provide the origin (e.g. when working with an embedded resource or when testing), you can add <code>&amp;origin=&lt;origin&gt;</code> to the request URL. For example, to load the container even when I&rsquo;m not on <code>https://www.simoahava.com</code> and I&rsquo;ve set that into the Allowed Origins field, I can browse to this:</p>
<p><strong>https://&lt;your server-side domain&gt;/google_tag_manager.js?id=GTM-ABCDEFG&amp;origin=https://www.simoahava.com</strong></p>

                
                  <h2 id="how-it-works">How it works</h2>
<p>A Client created with the template listens for requests that are dispatched to the request path defined in the Client settings.</p>
<h3 id="validate-the-request">Validate the request</h3>
<p>When a request like that is received, the Client does two checks:</p>
<ol>
<li>Is the <strong>Override Container ID</strong> setting checked and a valid GTM container ID has been configured, OR is there a valid GTM container ID as the value of the <code>id</code> query parameter in the request?</li>
<li>Is the value of <strong>Allowed Origins</strong> the wildcard (<code>*</code>) OR does the request come from an allowed origin OR does it have an allowed origin as the value of the <code>origin</code> query parameter in the request?</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#aaa;font-style:italic">// If the incoming request matches the request configured in the Client
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">if</span> (requestPath === data.requestPath) {
  
  <span style="color:#aaa;font-style:italic">// If the request is for a valid GTM container ID
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">if</span> (!containerId.match(<span style="color:#a50">&#39;^GTM-.+$&#39;</span>)) <span style="color:#00a">return</span>;
  
  <span style="color:#aaa;font-style:italic">// If the request comes from a valid origin
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">if</span> (!validateOrigin()) <span style="color:#00a">return</span>;
  
  ...
}
</code></pre></div>
<p>If both resolve to <code>true</code>, the request is claimed.</p>
<h3 id="fetch-the-preview-container">Fetch the preview container</h3>
<p>If the request is for a <strong>preview</strong> container, meaning it has the <code>gtm_debug</code>, <code>gtm_auth</code>, and <code>gtm_preview</code> query parameters, the Client acts as a transparent proxy.</p>
<p>It simply forwards the request to GTM servers with all the headers and parameters intact, and returns the result back to the request source.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> fetchPreviewContainer = () =&gt; {
  sendHttpGet(
    httpEndpoint  + 
              <span style="color:#a50">&#39;&amp;id=&#39;</span> + containerId + 
              <span style="color:#a50">&#39;&amp;gtm_auth=&#39;</span> + gtm_auth + 
              <span style="color:#a50">&#39;&amp;gtm_debug=&#39;</span> + gtm_debug + 
              <span style="color:#a50">&#39;&amp;gtm_preview=&#39;</span> + gtm_preview, 
    (statusCode, headers, body) =&gt; {
      sendResponse(body, headers, statusCode);
    }, {timeout: <span style="color:#099">1500</span>}
  );
};
</code></pre></div>
<p>Importantly, when a preview container is fetched, the result <strong>is not cached</strong>. This is vital to make preview useful, as otherwise the user would need to wait for the cache to expire before the refreshed preview container becomes available.</p>
<h3 id="fetch-the-live-container">Fetch the live container</h3>
<p>When a <strong>live</strong> container is fetched, on the other hand, the process changes quite a bit.</p>
<p>The template uses <code>templateDataStorage</code>, which is <a href="https://developers.google.com/tag-manager/serverside/api#templatedatastorage">an API</a> designed to persist information across requests in the Server container.</p>
<p>When a request for the live container comes in, the Client checks if there already is a cached version of the library <strong>and</strong> if the resource was cached less than <strong>7.5 minutes ago</strong>. In this case, the cached library (and any cached headers) are returned to the request source.</p>
<blockquote>
<p>This way the Client saves resources by <strong>not having to fetch the resource from Google servers anymore</strong>.</p>
</blockquote>
<p>Why 7.5 minutes cache duration? Well, that&rsquo;s <strong>half</strong> of the <strong>browser cache time</strong> for the GTM library itself (15 minutes). This way the browser cache still has the final say on how long to cache the resource, but unlike a browser cache, <strong>all users</strong> benefit from the server-side cache even if the user has never downloaded the resource before.</p>
<p>If the resource is not cached or if the cache has expired, then the container is fetched from Google servers.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> fetchLiveContainer = () =&gt; {
  <span style="color:#00a">const</span> now = getTimestampMillis();
  
  <span style="color:#aaa;font-style:italic">// Set timeout to 7.5 minutes
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">const</span> storageTimeout = now - cacheMaxTimeInMs;
  
  <span style="color:#aaa;font-style:italic">// If the cache has expired fetch library from Google servers and write response to cache
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">if</span> (!templateDataStorage.getItemCopy(storedJs) || 
      templateDataStorage.getItemCopy(storedTimeout) &lt; storageTimeout) {
    sendHttpGet(
      httpEndpoint + <span style="color:#a50">&#39;&amp;id=&#39;</span> + containerId, 
      (statusCode, headers, body) =&gt; {
        <span style="color:#00a">if</span> (statusCode === <span style="color:#099">200</span>) {
          templateDataStorage.setItemCopy(storedJs, body);
          templateDataStorage.setItemCopy(storedHeaders, headers);
          templateDataStorage.setItemCopy(storedTimeout, now);
        }
        sendResponse(body, headers, statusCode);
      }, {timeout: <span style="color:#099">1500</span>}
    );
  <span style="color:#aaa;font-style:italic">// Otherwise, pull the item from cache and do not make a request to Google servers
</span><span style="color:#aaa;font-style:italic"></span>  } <span style="color:#00a">else</span> {
    sendResponse(
      templateDataStorage.getItemCopy(storedJs),
      templateDataStorage.getItemCopy(storedHeaders),
      <span style="color:#099">200</span>
    );
  }
};
</code></pre></div>
<p>So <code>templateDataStorage</code> functions as an additional layer of caching here, reducing server response latency and network egress costs.</p>

                
                  <h2 id="summary">Summary</h2>
<p>Why create a template like this when the <a href="https://www.simoahava.com/analytics/google-tag-manager-web-container-client-server-side-tagging/">built-in web container client</a> works just fine?</p>
<p>Cynics could say that this is an improved way to circumvent ad blockers. And they&rsquo;d be right! This <strong>does</strong> make it easier to circumvent ad blockers, as their heuristics target not just the <code>googletagmanager.com</code> domain but also the <code>gtm.js</code> file and the <code>GTM-...</code> container ID.</p>
<p>However, I designed the template to introduce additional flexibility to moving Google Tag Manager to a first-party context. Being able to optimize for request paths and query parameters seems like an obvious enhancement. The <code>templateDataStorage</code> setup adds an additional layer of cost optimization.</p>
<p>But there&rsquo;s also the twist that maybe ad blockers targeting Google Tag Manager are throwing the baby out with the bathwater. GTM itself is not a tracking tool, and many use it for purposes completely unrelated to tracking or data collection.</p>
<p>Having said that, if I were to design an ad blocker today, I would probably block GTM as well, as it&rsquo;s more than likely that the bathwater is so dirty it must be chucked regardless of the collateral damage it causes.</p>
<p>So it&rsquo;s a tough balance to make. The only things I can recommend are these:</p>
<ul>
<li>You should approach server-side tagging with <strong>best intentions at heart</strong>.</li>
<li>Do your best to <strong>improve</strong> rather than erode <strong>transparency</strong>.</li>
<li>Be <strong>honest and respectful</strong> to your site visitors.</li>
<li>Make sure these mechanisms are <strong>documented</strong> somewhere so that if someone were to audit the data flows on the site and the server, your tags would not obstruct this important work.</li>
</ul>
<p>This way we&rsquo;ll all have a good time with server-side tagging.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/proxy/">proxy</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/consent-settings-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/recaptcha-v3-server-side-tagging/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Custom%20GTM%20Loader%20For%20Server-side%20Tagging%20https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/consent-settings-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/recaptcha-v3-server-side-tagging/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Custom%20GTM%20Loader%20For%20Server-side%20Tagging%20https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Custom%20GTM%20Loader%20For%20Server-side%20Tagging%20https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/custom-gtm-loader-server-side-tagging/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
    
    <script>
      !function(){
	    var baitPath = 'https://sgtm.simoahava.com/ads-min.js';
	  var pixelPath = 'https://sgtm.simoahava.com/4dchk';
	  var e=document.createElement("script");e.src=baitPath,document.body.appendChild(e);var t=!1;fetch("https://www.google-analytics.com/analytics.js",{method:"HEAD",mode:"no-cors"}).catch(function(){t=!0}),window.addEventListener("load",function(){var e={adb_blocked:!document.querySelector("#ECKckuBYwZaP"),gtm_blocked:!(window.google_tag_manager&&window.google_tag_manager.dataLayer),ga_blocked:t},o=Math.floor(1e6*Math.random()+1)+"_"+(new Date).getTime(),a=document.createElement("img");a.style="width: 1; height: 1; display: none;",a.src=pixelPath+"?client_id="+o+"&"+Object.keys(e).reduce(function(t,o){return t.concat(o+"="+e[o])},[]).join("&"),document.body.appendChild(a)})}();
    </script>
      

    
  </body>
</html>

