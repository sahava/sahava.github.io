

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "The Container Snippet: GTM Secrets Revealed | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2014\/03\/google-instructions.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/container-snippet-gtm-secrets-revealed\/",
  "datePublished": "2014-03-18T07:17:31\u002b00:00",
  "dateModified": "2014-03-18T07:17:31\u002b00:00",
  "description": "Deciphering the Google Tag Manager JavaScript container snippet. This guide will show you row-by-row what the container snippet does.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>The Container Snippet: GTM Secrets Revealed | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/container-snippet-gtm-secrets-revealed/">
    
    <meta name="description" content="Deciphering the Google Tag Manager JavaScript container snippet. This guide will show you row-by-row what the container snippet does.">
    <meta property="og:description" content="Deciphering the Google Tag Manager JavaScript container snippet. This guide will show you row-by-row what the container snippet does.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="The Container Snippet: GTM Secrets Revealed">
    <meta property="og:url" content="https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="The Container Snippet: GTM Secrets Revealed">
    <meta name="twitter:description" content="Deciphering the Google Tag Manager JavaScript container snippet. This guide will show you row-by-row what the container snippet does.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2014/03/google-instructions.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2014/03/google-instructions.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://mastodon.social/@ahava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      The Container Snippet: GTM Secrets Revealed
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2014-03-18T07:17:31Z">
        
  March 18, 2014

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>First of all, I&rsquo;m sorry for the wacky title. Sometimes I just want to amuse myself. Nevertheless, this post <em>is</em> about the <a href="http://www.google.com/tagmanager">Google Tag Manager</a> container snippet. There&rsquo;s nothing secretive about it, but I&rsquo;m betting many people have no clue what the snippet really does. That&rsquo;s the revelatory part.</p>
<p>If you&rsquo;ve never wondered what the snippet does, then shame on you! Remember, you own your page template. It&rsquo;s yours. Any code that you write there is your responsibility. You wouldn&rsquo;t let a complete stranger come to your house and paint your walls without permission, would you? So why copy-paste some code that you have no idea what it does? Because Google told you to?</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/google-instructions.jpg" title="Google&#39;s Instructions for Container Snippet">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/03/google-instructions.jpg#ZgotmplZ" alt="Google&#39;s Instructions for Container Snippet" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 698 73'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Well, you can trust Google (stop laughing!). There&rsquo;s nothing nefarious about the container snippet. Regardless, I wrote this post to tell you what it does, so that you can sleep better at night. Or you might learn something new about JavaScript (never a bad thing).</p>
<p>Note that this text should be understandable to JavaScript novices as well, but if you feel daunted at any time, you can just skip ahead to the last chapter. Within is a short recap of what the container snippet does.</p>
<p>So sit back (but lean forward), and enjoy another one of life&rsquo;s great mysteries unravelled.</p>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="the-container-snippet">The container snippet</h2>
<p>You should know what the container snippet is by now. It&rsquo;s the piece of code that Google Tag Manager <a href="https://developers.google.com/tag-manager/quickstart">requires that you add to your page template</a>, right after the opening <code>&lt;body&gt;</code> tag. You know, this (from my site):</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/container-snippet.jpg" title="Container snippet">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2014/03/container-snippet.jpg#ZgotmplZ" alt="Container snippet" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 615 78'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>(I left out the <code>&lt;noscript&gt;</code> part, because this post is just about the JavaScript snippet.)</p>
<p>Let&rsquo;s face it, the snippet code looks gibberish. This is because the JavaScript (that&rsquo;s right, it&rsquo;s JavaScript) is <em>minified</em>. Minification is the process of truncating the script to the smallest possible size without losing any data. This means removing whitespace (spaces and line breaks), and reducing variable and function names to single- or double-character length. Minification is done because every single character adds to the page size, and thus to the page load time. The benefit with something as small as the container snippet is negligible, but it is still observed as a best practice.</p>
<p>Because I want this post to add some value, allow me to perform a little makeover to the snippet.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span> <span style="color:#1e90ff">type</span>=<span style="color:#a50">&#34;text/javascript&#34;</span>&gt;
(<span style="color:#00a">function</span> (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({
        <span style="color:#a50">&#39;gtm.start&#39;</span>: <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime(),
        event: <span style="color:#a50">&#39;gtm.js&#39;</span>
    });
    <span style="color:#00a">var</span> f = d.getElementsByTagName(s)[<span style="color:#099">0</span>],
        j = d.createElement(s),
        dl = l != <span style="color:#a50">&#39;dataLayer&#39;</span> ? <span style="color:#a50">&#39;&amp;l=&#39;</span> + l : <span style="color:#a50">&#39;&#39;</span>;
    j.async = <span style="color:#00a">true</span>;
    j.src =
        <span style="color:#a50">&#39;//www.googletagmanager.com/gtm.js?id=&#39;</span> + i + dl;
    f.parentNode.insertBefore(j, f);
})(<span style="color:#0aa">window</span>, <span style="color:#0aa">document</span>, <span style="color:#a50">&#39;script&#39;</span>, <span style="color:#a50">&#39;dataLayer&#39;</span>, <span style="color:#a50">&#39;GTM-P8XR&#39;</span>);
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>That&rsquo;s better! It&rsquo;s the same code but with some basic formatting. Much easier to read and understand, right?</p>

                
                  <h2 id="positioning-the-container-snippet">Positioning the container snippet</h2>
<p>You might have wondered why Google so forcefully recommends that you place the container snippet just after the opening <code>&lt;body&gt;</code> tag. There are two good reasons to do so.</p>
<p>First, if you add the <code>&lt;noscript/&gt;</code> tag as well (as you should), this should always be in the body of the document. The tag (which is shown for browsers without JavaScript enabled) contains an iFrame which loads the GTM library. If you add the <code>&lt;noscript/&gt;</code> tag into the head of your document, it can perform pretty wildly with some browsers. You <em>could</em> experiment with leaving the <code>&lt;noscript/&gt;</code> in the body, and placing the JavaScript in the <head/>, but I haven&rsquo;t tested it and certainly don&rsquo;t recommend it.</p>
<p>The second reason is simple: to maximize data collection, the snippet should be the first thing loaded when the body of the page is rendered. Because the library is loaded asynchronously, there&rsquo;s no reason to delay it at all. So have it load as the first thing when the body is rendered, so that you don&rsquo;t risk losing any data due to sluggish DOM elements delaying the page load.</p>
<h3 id="lines-2-and-15">Lines 2 and 15</h3>
<p>We can skip lines 1 and 16, since they&rsquo;re just the HTML SCRIPT tag, wrapping the JavaScript block.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">(<span style="color:#00a">function</span> (w, d, s, l, i) {
...
})(<span style="color:#0aa">window</span>, <span style="color:#0aa">document</span>, <span style="color:#a50">&#39;script&#39;</span>, <span style="color:#a50">&#39;dataLayer&#39;</span>, <span style="color:#a50">&#39;GTM-P8XR&#39;</span>);
</code></pre></div>
<p>To understand the first line, we have to look at the last line as well. This is an example of a <em>self-invoking / self-executing anonymous function</em>, or <em>immediately-invoked function expression</em>. There&rsquo;s <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">some debate on the semantics</a> of which term you should choose, but for this purpose it&rsquo;s just that: semantics.</p>
<p>Basically, line 2 of the snippet declares an anonymous function (it has no name) with <em>five parameters</em>. These parameters are served via the function call at the end of the function block, which has, as it should, <em>five arguments</em>.</p>
<p>The whole idea behind an immediately-invoked function expression is to <strong>call the function as soon as it has been declared</strong>. That&rsquo;s what lines 2 and 15 of the snippet are about. Line 2 declares a function which is called in line 15, as soon as the function code has been parsed by your browser.</p>
<p>The arguments that are sent with the function call, and turned into parameters in the declaration (the parameters are in parentheses), are as follows:</p>
<ul>
<li>
<p><strong>window (w)</strong> - the <em>window</em> object represents the open window in the user&rsquo;s browser and everything in it (the document object model, or DOM, for example)</p>
</li>
<li>
<p><strong>document (d)</strong> - the <em>document</em> object is the top node in the DOM tree; it contains the entire HTML document</p>
</li>
<li>
<p><strong>&lsquo;script&rsquo; (s)</strong> - this string is used to load the <strong>gtm.js</strong> library (more on this later)</p>
</li>
<li>
<p><strong>&lsquo;dataLayer&rsquo; (l)</strong> - this string is used to give a name to the dataLayer object; you can rename the object used by GTM by changing this value</p>
</li>
<li>
<p><strong>&lsquo;GTM-P8XR&rsquo; (i)</strong> - this is your container ID, which you&rsquo;ll get from Google Tag Manager</p>
</li>
</ul>
<h3 id="line-3">Line 3</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">w[l] = w[l] || [];
</code></pre></div>
<p>If you remember what the parameters and arguments were, this line translates to:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#0aa">window</span>[<span style="color:#a50">&#39;dataLayer&#39;</span>] = <span style="color:#0aa">window</span>[<span style="color:#a50">&#39;dataLayer&#39;</span>] || [];
</code></pre></div>
<p>Here, the function looks for an object named <strong>dataLayer</strong> (or something else if you renamed it in the function arguments) in the window object, which contains all the objects on the page. If it finds one, it leaves it be. If it doesn&rsquo;t find one, it declares it as an empty <em>array</em>.</p>
<p>This is important, because sometimes you&rsquo;ll see this <em>explicit declaration</em> of the dataLayer object in the page template before the container snippet:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span> <span style="color:#1e90ff">type</span>=<span style="color:#a50">&#34;text/javascript&#34;</span>&gt;
    dataLayer = [];
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>Explicit declaration of dataLayer is useful if you need some dataLayer variables to be available at the earliest possible moment in your GTM tags. For example, if your page view tag requires some dataLayer variable to exist (for a custom dimension, perhaps), it&rsquo;s better to declare it in the page template <em>before</em> the container snippet:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
    dataLayer = [{<span style="color:#a50">&#39;author&#39;</span>: <span style="color:#a50">&#39;Simo Ahava&#39;</span>}];
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>This explicit declaration is what the code on line 3 of the container snippet is looking for. If the explicit declaration is found, it is left as it is. If it hasn&rsquo;t been declared, the <strong>container snippet creates the dataLayer object for you</strong>.</p>
<p>This brings me to an important point.</p>
<p>If you do not declare the dataLayer object explicitly, do <strong>NOT</strong> declare it in your GTM tags or after the container snippet. The container creates the dataLayer array for you, and if you try to declare it later on, you&rsquo;ll end up <strong>erasing the original dataLayer, created and used by GTM</strong>. After dataLayer has been created, your only interaction with it should be by using the <a href="https://developers.google.com/tag-manager/devguide#events"><strong>push()</strong> method</a> of the array (<em>dataLayer.push({&lsquo;property&rsquo;: &lsquo;value&rsquo;});</em>).</p>
<h3 id="lines-4-through-7">Lines 4 through 7</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">w[l].push({
    <span style="color:#a50">&#39;gtm.start&#39;</span>: <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime(),
    event: <span style="color:#a50">&#39;gtm.js&#39;</span>
});
</code></pre></div>
<p>This is a very important part of the container snippet functionality.</p>
<p>When the code reaches this point, a <strong>dataLayer.push()</strong> call is done. Within the curly brackets is an <em>object literal</em>. Object literals are JavaScript objects, which contain any number of key-value (or property-value or variable-value) pairs, often in JSON (JavaScript Object Notation). These objects are wrapped in curly brackets, and pushed to the end of the dataLayer array.</p>
<p>If most of the previous paragraph is gibberish to you, I don&rsquo;t blame you.</p>
<p>To put it simply, with a <strong>dataLayer.push()</strong>, you&rsquo;re <em>pushing</em> an object with properties to the end of the dataLayer queue. These properties can then be accessed in GTM.</p>
<p>This first push, on lines 4 through 7 of the container snippet, contains an object with the following properties:</p>
<ul>
<li>
<p>Key 1: <strong>&lsquo;gtm.start&rsquo;</strong> - Value 1: <strong>New Date.getTime()</strong></p>
</li>
<li>
<p>Key 2: <strong>event</strong> - Value 2: <strong>&lsquo;gtm.js&rsquo;</strong></p>
</li>
</ul>
<p>So <a href="https://www.simoahava.com/analytics/google-tag-manager-playing-rules/">if you&rsquo;ve ever wondered</a> when tags with <strong>{{event}} equals gtm.js</strong> or <strong>{{url}} matches regex .</strong>* get fired, it&rsquo;s at this point.</p>
<p>The <strong>gtm.start</strong> property receives the current time (in milliseconds since Jan 1, 1970) as its value. Brian Kuhn of Google explained that this is used for calculating gtm.js load time and the cache hit rate of the request, so don&rsquo;t worry about it.</p>
<h3 id="lines-8-through-10">Lines 8 through 10</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">var</span> f = d.getElementsByTagName(s)[<span style="color:#099">0</span>],
    j = d.createElement(s),
    dl = l != <span style="color:#a50">&#39;dataLayer&#39;</span> ? <span style="color:#a50">&#39;&amp;ampamp;l=&#39;</span> + l : <span style="color:#a50">&#39;&#39;</span>;
</code></pre></div>
<p>Let&rsquo;s open this up again, using the parameters and arguments we&rsquo;re already familiar with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">var</span> f = <span style="color:#0aa">document</span>.getElementsByTagName(<span style="color:#a50">&#39;script&#39;</span>)[<span style="color:#099">0</span>],
    j = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;script&#39;</span>),
    dl = <span style="color:#a50">&#39;dataLayer&#39;</span> != <span style="color:#a50">&#39;dataLayer&#39;</span> ? <span style="color:#a50">&#39;&amp;ampamp;l=&#39;</span> + <span style="color:#a50">&#39;newDataLayer&#39;</span> : <span style="color:#a50">&#39;&#39;</span>;
</code></pre></div>
<p>The first line stores the first SCRIPT element on the page in variable <strong>f</strong>.</p>
<p>The second line creates a new SCRIPT element, and stores it in variable <strong>j</strong>.</p>
<p>The third line does one of two possible things. If you haven&rsquo;t touched the default name of the dataLayer object (i.e. &lsquo;dataLayer&rsquo;), just an empty string is stored in variable <strong>dl</strong>. However, if you&rsquo;ve chosen to rename the dataLayer (e.g. &lsquo;newDataLayer&rsquo;), the string &lsquo;&amp;ampamp;l=newDataLayer&rsquo; is stored in variable <strong>dl</strong>. &amp;ampamp; is the same as the ampersand (&amp;), but it has been encoded because some platforms can&rsquo;t process non-encoded ASCII characters.</p>
<p>These variables will be used in the next lines.</p>
<h3 id="lines-11-through-13">Lines 11 through 13</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">j.async = <span style="color:#00a">true</span>;
j.src =
    <span style="color:#a50">&#39;//www.googletagmanager.com/gtm.js?id=&#39;</span> + i + dl;
</code></pre></div>
<p>And let&rsquo;s beautify this one as well:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">j.async = <span style="color:#00a">true</span>;
j.src = <span style="color:#a50">&#39;//www.googletagmanager.com/gtm.js?id=GTM-P8XR&#39;</span>;
</code></pre></div>
<p>Remember, in the last chapter you just created a new SCRIPT element and stored it in variable <strong>j</strong>? In these lines you add some attributes to it. The container ID is retrieved from function parameter <strong>i</strong>, and it was originally passed as an argument in the self-invoking function call (you remember this!). Go look if you don&rsquo;t believe me.</p>
<p>Note that the last line might look different if you chose to rename your dataLayer. In that case, it would actually be the equivalent of this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">j.src = <span style="color:#a50">&#39;//www.googletagmanager.com/gtm.js?id=GTM-P8XR&amp;l=newDataLayer&#39;</span>;
</code></pre></div>
<p>This means that if you renamed your dataLayer object, this new name is passed as the value of query parameter <strong>l</strong> with the request to load the gtm.js library from GTM servers.</p>
<p>Anyway, the whole point of these lines is to make the SCRIPT element you stored into variable <strong>j</strong> look something like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span> <span style="color:#1e90ff">type</span>=<span style="color:#a50">&#34;text/javascript&#34;</span> <span style="color:#1e90ff">async</span> <span style="color:#1e90ff">src</span>=<span style="color:#a50">&#34;//www.googletagmanager.com/gtm.js?id=GTM-P8XR&#34;</span>&gt;&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>So basically you&rsquo;ve just created a SCRIPT tag which loads the external <strong>gtm.js</strong> library with your container ID (and your renamed dataLayer, if you did so) as query parameters.</p>
<h3 id="line-14">Line 14</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">f.parentNode.insertBefore(j, f);
</code></pre></div>
<p>Remember a few chapters back when variable <strong>f</strong> was defined as the first SCRIPT tag of the document? This line does the following:</p>
<ul>
<li>
<p>Look for the first SCRIPT tag on the page</p>
</li>
<li>
<p>Just before that, insert the new SCRIPT tag which loads <strong>gtm.js</strong> (from the previous chapter)</p>
</li>
</ul>
<p>So the code on line 14 of the container snippet makes sure that the GTM loader is the first SCRIPT tag on the page.</p>
<p>And there you go! Read ahead for a short summary of what just happened.</p>

                
                  <h2 id="conclusions">Conclusions</h2>
<p>Here&rsquo;s a short recap of what the container snippet does:</p>
<ol>
<li>
<p>Declares an anonymous function with five parameters (the name of the dataLayer object and your container ID, among others)</p>
</li>
<li>
<p>Creates the dataLayer array, if you didn&rsquo;t do so explicitly before the container snippet</p>
</li>
<li>
<p>Pushes the first event, <strong>gtm.js</strong>, into dataLayer, along with the time the push was done</p>
</li>
<li>
<p>Creates a new SCRIPT tag, which loads the external <strong>gtm.js</strong> JavaScript library with your container ID (and custom dataLayer object name) as parameters</p>
</li>
<li>
<p>Adds this new SCRIPT to the page template, so that it&rsquo;s the first SCRIPT tag on the page</p>
</li>
<li>
<p>After the function is declared, the function is automatically executed</p>
</li>
</ol>
<p>In the end, it&rsquo;s a pretty simple piece of code. All it actually does is create (or verify) the dataLayer object, push the first event (named &lsquo;gtm.js&rsquo;) into dataLayer, and load the external gtm.js library which processes your container.</p>
<p>And that&rsquo;s the story of the container snippet.</p>
<p>Next up: reverse engineering the entire gtm.js library (JUST KIDDING!).</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/container-snippet/">container snippet</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">JavaScript</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/macro-magic-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=The%20Container%20Snippet:%20GTM%20Secrets%20Revealed%20https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/macro-magic-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=The%20Container%20Snippet:%20GTM%20Secrets%20Revealed%20https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=The%20Container%20Snippet:%20GTM%20Secrets%20Revealed%20https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

