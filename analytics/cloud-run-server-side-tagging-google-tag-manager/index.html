

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Cloud Run With Server-side Tagging In Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2023\/10\/cloud-run-auto-provision.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/cloud-run-server-side-tagging-google-tag-manager\/",
  "datePublished": "2023-10-25T07:37:11\u002b03:00",
  "dateModified": "2023-10-25T07:37:11\u002b03:00",
  "description": "An overview of how to setup server-side tagging in Google Tag Manager using the Cloud Run service.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Cloud Run With Server-side Tagging In Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/cloud-run-server-side-tagging-google-tag-manager/">
    
    <meta name="description" content="An overview of how to setup server-side tagging in Google Tag Manager using the Cloud Run service.">
    <meta property="og:description" content="An overview of how to setup server-side tagging in Google Tag Manager using the Cloud Run service.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Cloud Run With Server-side Tagging In Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Cloud Run With Server-side Tagging In Google Tag Manager">
    <meta name="twitter:description" content="An overview of how to setup server-side tagging in Google Tag Manager using the Cloud Run service.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
	  <meta property="og:image" content="https://www.simoahava.com/images/2023/10/cloud-run-server-side-tagging.jpg">
      <meta name="twitter:image" content="https://www.simoahava.com/images/2023/10/cloud-run-server-side-tagging.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" loading="lazy" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
    <div class="figure nocaption">
      <img class="cover" src="https://www.simoahava.com/images/2023/10/cloud-run-server-side-tagging.jpg" width="750" height="422" alt="Cloud Run With Server-side Tagging In Google Tag Manager">
    </div>
  
  

    <h1>
      Cloud Run With Server-side Tagging In Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-10-25T07:37:11&#43;03:00">
        
  October 25, 2023

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/#commento"><comentario-count path="/analytics/cloud-run-server-side-tagging-google-tag-manager/" 
                  placeholder="..."
                  error-text="N/A "
                  zero-text="0 "
                  prefix=""
                  suffix=" "></comentario-count>Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>In a recent update to <a href="https://developers.google.com/tag-platform/tag-manager/server-side/overview">server-side tagging in Google Tag Manager</a>, Google switched the <strong>default</strong> deployment of a server-side tagging backend from <a href="https://developers.google.com/tag-platform/tag-manager/server-side/app-engine-setup">Google App Engine</a> to <a href="https://developers.google.com/tag-platform/tag-manager/server-side/cloud-run-setup-guide">Google Cloud Run</a>.</p>
<p>Now, when you create a new container and choose the <strong>automatically provisioned tagging server</strong> option, this service will be created in Google Cloud Run instead of in Google App Engine.</p>



<div style="aspect-ratio: 1468 / 712;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/cloud-run-auto-provision.jpg" title="Cloud Run automatic provisioning">
  
    <img class="fig-img" height="712" width="1468" loading="lazy" src="https://www.simoahava.com/images/2023/10/cloud-run-auto-provision.jpg#ZgotmplZ" alt="Cloud Run automatic provisioning">
  
    </a>
  
  
</div>


<p>While I&rsquo;ve written <a href="https://www.simoahava.com/gtmtips/setup-google-tag-manager-server-cloud-run/">about Cloud Run before</a>, this update gives me an opportunity to review what actually happens when you provision a Cloud Run environment, how you can upgrade it, and how you can add enhancements such as <strong>multi-region load balancing</strong> to it (with ease, I might add!).</p>
<p><strong>If you&rsquo;re a student of Simmer&rsquo;s <a href="https://www.teamsimmer.com/all-courses/server-side-tagging-in-google-tag-manager/">Server-side Tagging In Google Tag Manager</a> online course</strong>, you&rsquo;ll be happy to know that the course content has a <em>lot</em> of updated content regarding the Cloud Run setup. I recommend enrolling in case you haven&rsquo;t yet – the course walks you through the nuts and bolts of server-side tagging in a way that a blog post could never replicate.</p>
<p>For an overview of what&rsquo;s different between Cloud Run and App Engine, I recommend you read through my <a href="https://www.simoahava.com/gtmtips/setup-google-tag-manager-server-cloud-run/">original post on the topic</a>.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[–hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#automatic-provisioning-of-the-tagging-server">Automatic provisioning of the tagging server</a></li>
    <li><a href="#upgrade-the-tagging-server">Upgrade the tagging server</a>
      <ul>
        <li><a href="#update-the-tagging-server-version">Update the tagging server version</a></li>
      </ul>
    </li>
    <li><a href="#copy-and-create-a-new-service">Copy and create a new service</a>
      <ul>
        <li><a href="#update-the-container-configuration-string">Update the container configuration string</a></li>
        <li><a href="#tagging-server-vs-preview-server">Tagging server vs. Preview server</a></li>
      </ul>
    </li>
    <li><a href="#manually-create-the-servers">Manually create the servers</a>
      <ul>
        <li><a href="#create-the-preview-server">Create the preview server</a></li>
        <li><a href="#create-the-tagging-server">Create the tagging server</a></li>
      </ul>
    </li>
    <li><a href="#map-a-custom-domain">Map a custom domain</a></li>
    <li><a href="#edit-the-load-balancer-to-include-more-tagging-servers">Edit the load balancer to include more tagging servers</a>
      <ul>
        <li><a href="#add-geolocation-headers-to-the-traffic">Add geolocation headers to the traffic</a></li>
        <li><a href="#test-that-everything-works">Test that everything works</a></li>
      </ul>
    </li>
    <li><a href="#migrate-from-app-engine">Migrate from App Engine</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="automatic-provisioning-of-the-tagging-server">Automatic provisioning of the tagging server</h2>
<p>When you follow the <strong>automatic provisioning steps</strong>, the process is very similar to what happened with App Engine.</p>
<p>You&rsquo;ll first need to choose (or create) a <a href="https://cloud.google.com/billing/docs/concepts">Google Cloud Billing account</a>, after which Google Tag Manager will <em>automatically</em> run through all the build scripts in the background.</p>



<div style="aspect-ratio: 1474 / 746;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/server-created.jpg" title="server creation started">
  
    <img class="fig-img" height="746" width="1474" loading="lazy" src="https://www.simoahava.com/images/2023/10/server-created.jpg#ZgotmplZ" alt="server creation started">
  
    </a>
  
  
</div>


<p>After a short(ish) wait, you&rsquo;ll be informed that a server environment has been created for you, and your server-side container has been updated with all the relevant information to immediately start working with server-side Google Tag Manager.</p>



<div style="aspect-ratio: 1466 / 994;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/server-finally-created.jpg" title="server creation ready">
  
    <img class="fig-img" height="994" width="1466" loading="lazy" src="https://www.simoahava.com/images/2023/10/server-finally-created.jpg#ZgotmplZ" alt="server creation ready">
  
    </a>
  
  
</div>


<p>If you now follow the link to your cloud project and <a href="https://console.cloud.google.com/run">browse to the Cloud Run page</a>, this is what you&rsquo;ll see:</p>



<div style="aspect-ratio: 2528 / 472;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/cloud-run-services.jpg" title="Cloud Run services">
  
    <img class="fig-img" height="472" width="2528" loading="lazy" src="https://www.simoahava.com/images/2023/10/cloud-run-services.jpg#ZgotmplZ" alt="Cloud Run services">
  
    </a>
  
  
</div>


<p><strong>Two</strong> services have been created for you in the <strong>us-central1</strong> (that&rsquo;s in the United States) cloud region:</p>
<ul>
<li><code>server-side-tagging</code> – this is the <strong>tagging server</strong>, which collects all the traffic to your server-side endpoint.</li>
<li><code>server-side-tagging-preview</code> – this is the <strong>preview server</strong> to which the tagging server forwards the requests that were collected while you were previewing the server container.</li>
</ul>
<p>Both of these services are running a minimal setup:</p>
<ul>
<li><strong>512 MiB</strong> memory</li>
<li><strong>1 vCPU</strong> (virtual CPU)</li>
<li><strong>0 minimum instances</strong></li>
<li><strong>1 maximum instance</strong></li>
</ul>
<p>This is fine for the Preview server – you&rsquo;ll never need to upgrade it to something more powerful. But if you want to run the tagging server in a production-ready capacity, you&rsquo;ll want to edit it and <strong>deploy a new revision</strong> with more instances in use (more about this below).</p>
<p>The <strong>memory</strong> and <strong>CPU</strong> should be fine with the default values – server-side GTM will never really require more power from the individual instances.</p>
<p>Importantly, the services are set in <code>us-central1</code>, but unlike App Engine, you can simply <strong>copy and create new services</strong> in a different region, subsequently deleting these original services once the new ones are up and running (more on this below, too).</p>
<p>This is one of the biggest benefits of Cloud Run vs. App Engine: you can add <em>as many tagging servers</em> as you like, all in different regions. You can then put all of them behind an <strong>external application load balancer</strong> to have the traffic automatically distributed to the tagging server closest to the visitor geographically. Yes, more on this below, too!</p>
<blockquote>
<p>My recommendation is thus to always run the automatic provisioning setup <em>even if you don&rsquo;t want to actually run the server in <code>us-central1</code></em>. The automatic setup generates a server template you can then copy when you want to create the server(s) with different settings. However, I&rsquo;ve also added instructions below on how to manually generate the servers if you don&rsquo;t want to or can&rsquo;t run through the automatic provisioning steps.</p>
</blockquote>

                
                  <h2 id="upgrade-the-tagging-server">Upgrade the tagging server</h2>
<p>Let&rsquo;s start with a simple step. How do you upgrade the tagging server to production-ready capacity?</p>
<p>You need to click the tagging server in the list of services:</p>



<div style="aspect-ratio: 1472 / 378;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/click-tagging-service.jpg" title="Click tagging service">
  
    <img class="fig-img" height="378" width="1472" loading="lazy" src="https://www.simoahava.com/images/2023/10/click-tagging-service.jpg#ZgotmplZ" alt="Click tagging service">
  
    </a>
  
  
</div>


<p>Next, click <strong>Edit and deploy new revision</strong> to edit the service.</p>



<div style="aspect-ratio: 1472 / 300;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/edit-redeploy-revision.jpg" title="edit and redeploy">
  
    <img class="fig-img" height="300" width="1472" loading="lazy" src="https://www.simoahava.com/images/2023/10/edit-redeploy-revision.jpg#ZgotmplZ" alt="edit and redeploy">
  
    </a>
  
  
</div>


<p>Now, scroll down to the <strong>Auto-scaling</strong> options. If you want to follow Google&rsquo;s recommendations, set the minimum instances to <strong>2</strong> and maximum to <strong>10</strong>.</p>



<div style="aspect-ratio: 1094 / 246;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/min-max.jpg" title="auto-scaling options for cloud run instances">
  
    <img class="fig-img" height="246" width="1094" loading="lazy" src="https://www.simoahava.com/images/2023/10/min-max.jpg#ZgotmplZ" alt="auto-scaling options for cloud run instances">
  
    </a>
  
  
</div>


<blockquote>
<p>Having a minimum of 2 is just plain common sense to avoid things like <strong>resource exhaustion</strong> problems denying you of any active instances, or <strong>cold boot times</strong> increasing your latency unbearably. A maximum of 10 means that that&rsquo;s the <strong>upper limit</strong> of what your setup <strong>might</strong> scale to if <strong>enough</strong> traffic comes in. You&rsquo;ll only pay for the instances that are actually in use.</p>
</blockquote>
<p>Once ready, scroll all the way down and click the <strong>Deploy</strong> button to create a new revision and update the deployment.</p>
<p>The deployment is done so that traffic is diverted to the new revision only after it&rsquo;s up and running. This means that there should be <strong>no downtime</strong> at all for your server endpoint.</p>
<h3 id="update-the-tagging-server-version">Update the tagging server version</h3>
<p>If you ever see a notice in the Google Tag Manager user interface that there&rsquo;s a new version of the tagging server and you need to <a href="https://developers.google.com/tag-platform/tag-manager/server-side/cloud-run-setup-guide?provisioning=manual#update_the_tagging_server_version">upgrade your deployment</a>, all you need to do is go through the steps above and click <strong>Deploy</strong> to deploy a new revision.</p>



<div style="aspect-ratio: 1802 / 914;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/update-tagging-server.jpg" title="Update the tagging server">
  
    <img class="fig-img" height="914" width="1802" loading="lazy" src="https://www.simoahava.com/images/2023/10/update-tagging-server.jpg#ZgotmplZ" alt="Update the tagging server">
  
    </a>
  
  
</div>


<p>You don&rsquo;t have to make any changes, the redeployment will fetch the latest server container image version from Google&rsquo;s repository and update your servers with it. You need to do this for <strong>all</strong> the tagging servers in your setup (if you&rsquo;re running everything behind a load balancer).</p>

                
                  <h2 id="copy-and-create-a-new-service">Copy and create a new service</h2>
<p>In case you want to quickly create a new <strong>tagging server</strong> or <strong>preview server</strong>, the absolutely easiest way to do so is to take an existing server (such as the one created by the automatic provisioning setup), <strong>copy</strong> it, and deploy it as a new service.</p>
<p>To do this, select the server you want to copy from the list of Cloud Run services and hit the <strong>Copy</strong> button in the top bar.</p>



<div style="aspect-ratio: 2736 / 624;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/copy-tagging-server.jpg" title="Copy tagging server">
  
    <img class="fig-img" height="624" width="2736" loading="lazy" src="https://www.simoahava.com/images/2023/10/copy-tagging-server.jpg#ZgotmplZ" alt="Copy tagging server">
  
    </a>
  
  
</div>


<p>Here, make sure you update the following:</p>
<ul>
<li><strong>Service name</strong>: set this to a name that you haven&rsquo;t already used</li>
<li><strong>Region</strong>: choose a cloud region for this server</li>
<li><strong>Auto-scaling</strong>: choose the appropriate minimum and maximum instances for the server</li>
<li><strong>Authentication</strong>: check <strong>Allow unauthenticated invocations</strong></li>
</ul>
<p>You can keep everything else with the default values. If you <em>do</em> want to make some changes, here are the ones you are probably most interested in:</p>
<h3 id="update-the-container-configuration-string">Update the container configuration string</h3>
<p>Under <strong>Environment variables</strong>, you can change the value of <code>CONTAINER_CONFIG</code> to point to a different Server container. To find the container configuration string for any given Server container, you need to click the container ID in the top bar of the Server container.</p>



<div style="aspect-ratio: 2172 / 746;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/container-configuraiton-string.jpg" title="container configuration">
  
    <img class="fig-img" height="746" width="2172" loading="lazy" src="https://www.simoahava.com/images/2023/10/container-configuraiton-string.jpg#ZgotmplZ" alt="container configuration">
  
    </a>
  
  
</div>


<p>Set this as the value of the <code>CONTAINER_CONFIG</code> environment variable to have the Cloud Run server point to the correct Server container.</p>
<h3 id="tagging-server-vs-preview-server">Tagging server vs. Preview server</h3>
<p>If you want to change a tagging server to a preview server or vice versa, you need to update the environment variables again.</p>
<p>A <strong>Preview</strong> server needs the variable <code>RUN_AS_PREVIEW_SERVER</code> set to the value <code>true</code>. It should <em>not</em> have the <code>PREVIEW_SERVER_URL</code> variable set. This is what a Preview server configuration looks like:</p>



<div style="aspect-ratio: 972 / 394;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/preview-server-env.jpg" title="Preview server env">
  
    <img class="fig-img" height="394" width="972" loading="lazy" src="https://www.simoahava.com/images/2023/10/preview-server-env.jpg#ZgotmplZ" alt="Preview server env">
  
    </a>
  
  
</div>


<p>A <strong>Tagging</strong> server needs the variable <code>PREVIEW_SERVER_URL</code> set to the Cloud Run URL of the preview server. You can find this URL by opening the Cloud Run service for the preview server, and the URL right at the top of the dashboard:</p>



<div style="aspect-ratio: 2034 / 404;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/preview-server-url.jpg" title="Preview server URL">
  
    <img class="fig-img" height="404" width="2034" loading="lazy" src="https://www.simoahava.com/images/2023/10/preview-server-url.jpg#ZgotmplZ" alt="Preview server URL">
  
    </a>
  
  
</div>


<p>Set this URL as the value of the environment variable, and make sure that <code>RUN_AS_PREVIEW_SERVER</code> is <em>not</em> set. This is what the environment variables for the tagging server should look like:</p>



<div style="aspect-ratio: 982 / 396;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/tagging-server-env.jpg" title="Tagging server env">
  
    <img class="fig-img" height="396" width="982" loading="lazy" src="https://www.simoahava.com/images/2023/10/tagging-server-env.jpg#ZgotmplZ" alt="Tagging server env">
  
    </a>
  
  
</div>



                
                  <h2 id="manually-create-the-servers">Manually create the servers</h2>
<p>If you didn&rsquo;t run through the automatic provisioning steps, you&rsquo;ll need to <strong>manually</strong> create the preview server and any tagging servers you want to associate with it.</p>
<p>To do this, you need to start with the preview server.</p>
<h3 id="create-the-preview-server">Create the preview server</h3>
<p>Go to <a href="https://console.cloud.google.com/run">Cloud Run</a> and click <strong>CREATE SERVICE</strong>.</p>
<p>Set the <strong>Container image URL</strong> to <code>gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable</code> and give the server a name. I recommend the following syntax:</p>
<p><code>server-side-tagging-&lt;geo&gt;-preview</code> where <code>geo</code> is the geographic region.</p>
<p>On that note, choose the Cloud Region accordingly, too.</p>
<blockquote>
<p>This is just for the Preview server so not that significant. But choose whatever region makes most sense to you.</p>
</blockquote>



<div style="aspect-ratio: 1086 / 670;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/first-settings-preview.jpg" title="First settings for preview server">
  
    <img class="fig-img" height="670" width="1086" loading="lazy" src="https://www.simoahava.com/images/2023/10/first-settings-preview.jpg#ZgotmplZ" alt="First settings for preview server">
  
    </a>
  
  
</div>


<p>Set CPU allocation to <strong>CPU is always allocated</strong>.</p>
<p>Set Auto-scaling to <strong>0 minimum instances</strong> and <strong>1 maximum instances</strong>. Do <em>not</em> stray from these values for the Preview server or it might not work correctly!</p>
<p>Keep Ingress control with <strong>All</strong>, and tick <strong>Allow unauthenticated invocations</strong> for Authentication.</p>



<div style="aspect-ratio: 1080 / 1178;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/next-preview-settings.jpg" title="Next preview settings">
  
    <img class="fig-img" height="1178" width="1080" loading="lazy" src="https://www.simoahava.com/images/2023/10/next-preview-settings.jpg#ZgotmplZ" alt="Next preview settings">
  
    </a>
  
  
</div>


<p>Expand Container, Networking, Security, and set the Request timeout to <strong>60 seconds</strong>.</p>



<div style="aspect-ratio: 1104 / 624;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/request-timeout.jpg" title="Request timeout">
  
    <img class="fig-img" height="624" width="1104" loading="lazy" src="https://www.simoahava.com/images/2023/10/request-timeout.jpg#ZgotmplZ" alt="Request timeout">
  
    </a>
  
  
</div>


<p>Under Environment variables, set these two variables:</p>
<ol>
<li><code>RUN_AS_PREVIEW_SERVER</code> set to the value <code>true</code></li>
<li><code>CONTAINER_CONFIG</code> set to the value of the container configuration string from your Server container (see above)</li>
</ol>



<div style="aspect-ratio: 972 / 394;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/preview-server-env.jpg" title="Preview server env">
  
    <img class="fig-img" height="394" width="972" loading="lazy" src="https://www.simoahava.com/images/2023/10/preview-server-env.jpg#ZgotmplZ" alt="Preview server env">
  
    </a>
  
  
</div>


<p>Under Health checks, click to <strong>Add health check</strong>, and set it with these settings:</p>
<ol>
<li><strong>Health check type</strong>: Start-up check</li>
<li><strong>Probe type</strong>: TCP</li>
<li><strong>Port</strong>: 8080</li>
<li><strong>Initial delay</strong>: 0 seconds</li>
<li><strong>Period</strong>: 240 seconds</li>
<li><strong>Failure threshold</strong>: 1</li>
<li><strong>Timeout</strong>: 240 seconds</li>
</ol>
<p>Click <strong>UPDATE</strong> to save the health check.</p>



<div style="aspect-ratio: 746 / 350;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/health-check.jpg" title="Health check">
  
    <img class="fig-img" height="350" width="746" loading="lazy" src="https://www.simoahava.com/images/2023/10/health-check.jpg#ZgotmplZ" alt="Health check">
  
    </a>
  
  
</div>


<p>Once done, click <strong>DEPLOY</strong> to deploy the service.</p>
<h3 id="create-the-tagging-server">Create the tagging server</h3>
<p>To create the tagging server, it&rsquo;s really easy to do once you have the preview server in place.</p>
<p>First, open the <strong>preview server</strong> and copy the preview server URL to someplace where you have it handy (or just have the preview server open in a different tab).</p>



<div style="aspect-ratio: 2034 / 404;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/preview-server-url.jpg" title="Preview server URL">
  
    <img class="fig-img" height="404" width="2034" loading="lazy" src="https://www.simoahava.com/images/2023/10/preview-server-url.jpg#ZgotmplZ" alt="Preview server URL">
  
    </a>
  
  
</div>


<p>Next, choose the preview server from the list of services and click <strong>Copy</strong> in the Cloud Run top bar.</p>



<div style="aspect-ratio: 1912 / 422;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/copy-preview-server.jpg" title="Copy preview server">
  
    <img class="fig-img" height="422" width="1912" loading="lazy" src="https://www.simoahava.com/images/2023/10/copy-preview-server.jpg#ZgotmplZ" alt="Copy preview server">
  
    </a>
  
  
</div>


<p>Here, update the <strong>Service name</strong> – again, this is my recommendation:</p>
<p><code>server-side-tagging-&lt;geo&gt;</code>, where <code>geo</code> is the geographic region.</p>
<p>Next, choose the cloud region for the server.</p>



<div style="aspect-ratio: 1078 / 686;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/tagging-server-new.jpg" title="Tagging server new">
  
    <img class="fig-img" height="686" width="1078" loading="lazy" src="https://www.simoahava.com/images/2023/10/tagging-server-new.jpg#ZgotmplZ" alt="Tagging server new">
  
    </a>
  
  
</div>


<p>Update <strong>Auto-scaling</strong> – if you want to just run a test deployment, keep minimum and maximum as <strong>0</strong> and <strong>1</strong> respectively, but if you want to move straight to a production-ready setup, switch to a minimum of <strong>2</strong> and a maximum of <strong>10</strong>.</p>



<div style="aspect-ratio: 1066 / 214;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/min2-max10.jpg" title="minimum 2 maximum 10">
  
    <img class="fig-img" height="214" width="1066" loading="lazy" src="https://www.simoahava.com/images/2023/10/min2-max10.jpg#ZgotmplZ" alt="minimum 2 maximum 10">
  
    </a>
  
  
</div>


<p>Check <strong>Allow unauthenticated invocations</strong> and then expand <strong>Container, Networking, Security</strong>.</p>
<p>Here, update the <strong>Environment variables</strong> to have the following (and nothing else):</p>
<ul>
<li><code>PREVIEW_SERVER_URL</code>: point this to the URL of the preview server</li>
<li><code>CONTAINER_CONFIG</code>: point this to the Server container (it should already do so because you copied the preview server)</li>
</ul>



<div style="aspect-ratio: 982 / 396;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/tagging-server-env.jpg" title="Tagging server env">
  
    <img class="fig-img" height="396" width="982" loading="lazy" src="https://www.simoahava.com/images/2023/10/tagging-server-env.jpg#ZgotmplZ" alt="Tagging server env">
  
    </a>
  
  
</div>


<p>Click <strong>CREATE</strong> to create the deployment.</p>

                
                  <h2 id="map-a-custom-domain">Map a custom domain</h2>
<blockquote>
<p><strong>IMPORTANT!</strong> Cloud Run Integrations have been <strong>deprecated</strong> and the instructions in this topic no longer apply. To map a custom domain, the best option is to use an <strong>external application load balancer</strong> by following <a href="https://cloud.google.com/load-balancing/docs/https/setup-global-ext-https-serverless">this guide</a>. You can also enroll in the <a href="https://www.teamsimmer.com/all-courses/server-side-tagging-in-google-tag-manager/">Simmer Course</a>, where we cover this topic extensively.</p>
</blockquote>
<p>To map a custom domain <em>and</em> to make life easier when you want to start adding additional services behind a Load Balancer, you should use the new <strong>Custom Domains Integration</strong> available in Cloud Run.</p>
<blockquote>
<p>Note, at the time of writing the integration is still in &ldquo;Preview&rdquo; stage, which might mean that it can change a bit when it&rsquo;s released as a stable feature.</p>
</blockquote>
<p>You only need to create this integration <strong>once</strong> per service cluster you intend to use. So if you&rsquo;ve already created tagging servers for different geographic regions, choose just <strong>one</strong> of them to add this integration to.</p>
<p>This integration automatically creates an <strong>external application load balancer</strong> for you, which you can then map your custom domain to using a single DNS A record. It&rsquo;s <em>much</em> simpler than the awkward TXT/CNAME/A setup you used to have to do with App Engine!</p>
<p>To create the integration, open a <strong>tagging server</strong> of your choice and click the <strong>Integrations</strong> tab.</p>



<div style="aspect-ratio: 1984 / 392;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/add-integration.jpg" title="Add integration">
  
    <img class="fig-img" height="392" width="1984" loading="lazy" src="https://www.simoahava.com/images/2023/10/add-integration.jpg#ZgotmplZ" alt="Add integration">
  
    </a>
  
  
</div>


<p>Click <strong>Add integration</strong>, and then choose <strong>Custom domains - Google Cloud load balancing</strong>.</p>



<div style="aspect-ratio: 1464 / 1412;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/new-custom-domain-integration.jpg" title="new custom domain integration">
  
    <img class="fig-img" height="1412" width="1464" loading="lazy" src="https://www.simoahava.com/images/2023/10/new-custom-domain-integration.jpg#ZgotmplZ" alt="new custom domain integration">
  
    </a>
  
  
</div>


<p>If prompted to do so, make sure you <strong>enable</strong> any APIs that the integration requires you to enable.</p>
<p>Here, you can now map <strong>one or more</strong> subdomains to your Cloud Run services. Choose subdomains that share the main domain name with the website(s) that will be sending traffic to the server.</p>



<div style="aspect-ratio: 982 / 534;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/custom-domain-list.jpg" title="Custom domain list">
  
    <img class="fig-img" height="534" width="982" loading="lazy" src="https://www.simoahava.com/images/2023/10/custom-domain-list.jpg#ZgotmplZ" alt="Custom domain list">
  
    </a>
  
  
</div>


<p>Once ready, click <strong>Submit</strong> to start the process. You can see the list of resources that will be automatically created for you when the process is completed.</p>
<p>Shortly into the process, you should see a new box titled <strong>Connect to custom domain</strong> with one DNS record per domain you&rsquo;ve mapped to the endpoint.</p>



<div style="aspect-ratio: 1064 / 514;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/dns-records.jpg" title="DNS records">
  
    <img class="fig-img" height="514" width="1064" loading="lazy" src="https://www.simoahava.com/images/2023/10/dns-records.jpg#ZgotmplZ" alt="DNS records">
  
    </a>
  
  
</div>


<p>Add these domain records to your DNS registrar as soon as possible. The integration will attempt to provision an SSL certificate for your domains, and it won&rsquo;t be able to do so until the mappings are complete.</p>
<p>Once you&rsquo;ve added the DNS records, you&rsquo;ll need to wait anywhere from minutes to hours to finally have the SSL certificate provisioned for your custom domain(s).</p>
<p>When the DNS changes have propagated and the SSL certificate has been provisioned, you&rsquo;ll see this:</p>



<div style="aspect-ratio: 1064 / 500;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/custom-domains-integration-done.jpg" title="Custom domains integration is complete">
  
    <img class="fig-img" height="500" width="1064" loading="lazy" src="https://www.simoahava.com/images/2023/10/custom-domains-integration-done.jpg#ZgotmplZ" alt="Custom domains integration is complete">
  
    </a>
  
  
</div>


<p>Congratulations – you have now mapped your custom domains(s) to point to your tagging server. You can now update the server container URL in your Google Tag Manager Server container settings as well as in any tags and scripts that send data to your server-side endpoint.</p>
<p>Next step is to expand the load balancer to include your other backends, too!</p>

                
                  <h2 id="edit-the-load-balancer-to-include-more-tagging-servers">Edit the load balancer to include more tagging servers</h2>
<p>Once you have the load balancer in place for your custom domain, you can expand its purpose to be an <em>actual</em> load balancer for your tagging services.</p>
<p>For example, here&rsquo;s an example setup of mine:</p>



<div style="aspect-ratio: 1518 / 322;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/tagging-service-cluster.jpg" title="Tagging service cluster">
  
    <img class="fig-img" height="322" width="1518" loading="lazy" src="https://www.simoahava.com/images/2023/10/tagging-service-cluster.jpg#ZgotmplZ" alt="Tagging service cluster">
  
    </a>
  
  
</div>


<p>I have <strong>three</strong> tagging servers: one for the US (<code>server-side-tagging</code>), one for Asia (<code>server-side-tagging-as</code>), and one for Europe (<code>server-side-tagging-eu</code>).</p>
<p>All three of these are mapped to a single preview server running in the US (<code>server-side-tagging-preview</code>).</p>
<p>I&rsquo;ve created a <strong>custom domain integration</strong> for the <code>server-side-tagging</code> server, to which my custom domain of <strong>sgtm.teamsimmer.com</strong> is now pointing.</p>



<div style="aspect-ratio: 1050 / 802;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/custom-domain-integration.jpg" title="Custom domain integration">
  
    <img class="fig-img" height="802" width="1050" loading="lazy" src="https://www.simoahava.com/images/2023/10/custom-domain-integration.jpg#ZgotmplZ" alt="Custom domain integration">
  
    </a>
  
  
</div>


<p>But because the load balancer is only added to the <code>server-side-tagging</code> service, it means that 100% of the traffic to <strong>sgtm.teamsimmer.com</strong> domain is routed to the <code>us-central1</code> server.</p>
<p>I now want to include my Asia and Europe servers in the mix, too, so that visitors closer to those regions would have their traffic routed to the tagging servers geographically closer to them.</p>
<p>To do that, go to <a href="https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers">Load Balancing</a> in the Google Cloud console.</p>



<div style="aspect-ratio: 1450 / 556;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/load-balancing-view.jpg" title="Load balancing">
  
    <img class="fig-img" height="556" width="1450" loading="lazy" src="https://www.simoahava.com/images/2023/10/load-balancing-view.jpg#ZgotmplZ" alt="Load balancing">
  
    </a>
  
  
</div>


<blockquote>
<p>Your load balancer comprises a <strong>Frontend</strong> (the IP address your custom domain is pointing to) and a <strong>Backend</strong> that maps the services the load balancer should forward traffic to.</p>
</blockquote>
<p>Here, navigate to the <strong>Backends</strong> tab, because we&rsquo;ll need to update the existing <strong>Backend service</strong> to also include our two additional tagging servers.</p>
<p>Click the backend service that was created by the custom domains integration.</p>



<div style="aspect-ratio: 1184 / 408;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/click-backend-service.jpg" title="click backend service">
  
    <img class="fig-img" height="408" width="1184" loading="lazy" src="https://www.simoahava.com/images/2023/10/click-backend-service.jpg#ZgotmplZ" alt="click backend service">
  
    </a>
  
  
</div>


<p>Next, click <strong>Edit</strong> in the top bar to edit the backend service.</p>



<div style="aspect-ratio: 1088 / 420;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/backends-available.jpg" title="Backends available">
  
    <img class="fig-img" height="420" width="1088" loading="lazy" src="https://www.simoahava.com/images/2023/10/backends-available.jpg#ZgotmplZ" alt="Backends available">
  
    </a>
  
  
</div>


<p>Here, you&rsquo;ll see a list of all the backends added to this service. There should be just one – a <strong>serverless network endpoint group</strong> pointing to the tagging server in Cloud Run where you added the custom domains integration.</p>
<p>You need to add new backends – <strong>one per tagging server</strong> that you want to also include in the load balancer (you do <em>not</em> need to create a backend for the Preview server!).</p>
<p>Click <strong>Add a backend</strong>, and in the list of <strong>Serverless network endpoint groups</strong> choose <strong>Create serverless network endpoint group</strong>.</p>
<p>Give a name for the NEG, and set its <strong>Region</strong> to the <em>exact</em> same region as the Cloud Run tagging server you want to add to the balancer.</p>



<div style="aspect-ratio: 1130 / 1270;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/add-neg.jpg" title="Add a network endpoint group">
  
    <img class="fig-img" height="1270" width="1130" loading="lazy" src="https://www.simoahava.com/images/2023/10/add-neg.jpg#ZgotmplZ" alt="Add a network endpoint group">
  
    </a>
  
  
</div>


<p>Once you&rsquo;ve chosen the region, choose <strong>Cloud Run</strong> as the NEG type, and then select the tagging server from the list of available Cloud Run services. Click <strong>Create</strong> when ready.</p>
<p>Do this for all the tagging servers you want to add to the load balancer. Once ready, you should see something like this:</p>



<div style="aspect-ratio: 1070 / 578;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/all-backends-added.jpg" title="All backends have been added">
  
    <img class="fig-img" height="578" width="1070" loading="lazy" src="https://www.simoahava.com/images/2023/10/all-backends-added.jpg#ZgotmplZ" alt="All backends have been added">
  
    </a>
  
  
</div>


<p>Now, scroll down and check <strong>Enable logging</strong>. It&rsquo;s a good idea to have the load balancer log requests. It&rsquo;s a useful feature, because it lets you monitor traffic through the backends.</p>
<h3 id="add-geolocation-headers-to-the-traffic">Add geolocation headers to the traffic</h3>
<p>If you wish, you can also have the load balancer <strong>automatically geolocate</strong> the user and add this information as custom request headers to all HTTP requests that go through the load balancer. This would mimic <a href="https://www.simoahava.com/gtm-tips/utilize-app-engine-headers-server-side-tagging/">how App Engine automatically geolocates</a> the user, too.</p>
<p>To do this, scroll down the <strong>backend service</strong> settings, expand <strong>Advanced configurations</strong>, and find <strong>Custom request headers</strong>. Add <em>at least</em> these two:</p>
<p><code>X-Gclb-Country</code>: <code>{client_region}</code>
<code>X-Gclb-Region</code>: <code>{client_region_subdivision}</code></p>
<p>These headers are required if you want to support <a href="https://developers.google.com/tag-platform/tag-manager/server-side/enable-region-specific-settings">region-specific behavior</a> in your Server container for Google tags.</p>



<div style="aspect-ratio: 986 / 356;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/custom-request-headers.jpg" title="Custom request headers">
  
    <img class="fig-img" height="356" width="986" loading="lazy" src="https://www.simoahava.com/images/2023/10/custom-request-headers.jpg#ZgotmplZ" alt="Custom request headers">
  
    </a>
  
  
</div>


<p>For additional request headers you might find useful, check out <a href="https://cloud.google.com/load-balancing/docs/https/custom-headers#variables">this list</a>.</p>
<p>Once you are ready, click <strong>Update</strong> to update the backend.</p>
<p>If you now go back to the <strong>Load balancers</strong> tab, you should see your load balancer pointing to <strong>3 network endpoint groups</strong> (or however many tagging servers you added to the backend service).</p>



<div style="aspect-ratio: 2430 / 294;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/network-endpoint-groups-added.jpg" title="Network endpoint groups">
  
    <img class="fig-img" height="294" width="2430" loading="lazy" src="https://www.simoahava.com/images/2023/10/network-endpoint-groups-added.jpg#ZgotmplZ" alt="Network endpoint groups">
  
    </a>
  
  
</div>


<h3 id="test-that-everything-works">Test that everything works</h3>
<p>If you now open the Server container Preview mode and check any incoming requests, you should see the custom request headers added automatically:</p>



<div style="aspect-ratio: 1518 / 508;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/headers-in-gtm-preview.jpg" title="Headers in GTM preview">
  
    <img class="fig-img" height="508" width="1518" loading="lazy" src="https://www.simoahava.com/images/2023/10/headers-in-gtm-preview.jpg#ZgotmplZ" alt="Headers in GTM preview">
  
    </a>
  
  
</div>


<p>Furthermore, if you go to <a href="https://console.cloud.google.com/logs/">Logs Explorer</a> in Google Cloud, you can expand an incoming HTTP request log to see which backend it was sent to:</p>



<div style="aspect-ratio: 1654 / 700;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2023/10/cloud-run-balancer-logs.jpg" title="Logs">
  
    <img class="fig-img" height="700" width="1654" loading="lazy" src="https://www.simoahava.com/images/2023/10/cloud-run-balancer-logs.jpg#ZgotmplZ" alt="Logs">
  
    </a>
  
  
</div>


<p>In the example above, I sent the request from Finland, so it was routed to the <code>server-side-tagging-eu</code> service to keep the geographical distance between myself and the server as short as possible.</p>

                
                  <h2 id="migrate-from-app-engine">Migrate from App Engine</h2>
<p>Migrating from App Engine to Cloud Run is very easy.</p>
<p>First, build your Cloud Run setup to completion following the steps in this article.</p>
<p>Then, once you&rsquo;re ready, you can <a href="https://cloud.google.com/appengine/docs/standard/managing-projects-apps-billing#disabling_an_application">disable the App Engine application</a>.</p>
<p><strong>Note!</strong> If you want to migrate the subdomain from App Engine to your new Cloud Run load balancer, there <em>might</em> be downtime as the load balancer provisions the SSL certificate for your setup. So do this at your own risk. If you want everything to go smoothly, you can reserve a <strong>new</strong> domain name for the Cloud Run setup.</p>
<p>Remember – do <strong>not</strong> disable the App Engine application until everything is working as intended in Cloud Run. Even after that, it&rsquo;s a good idea to have the App Engine application running for a day or two to catch any cached traffic that might still be flowing in.</p>

                
                  <h2 id="summary">Summary</h2>
<p>This article has been a walkthrough of what to expect when moving to the new, <strong>recommended</strong> deployment of server-side tagging in Google Tag Manager, using Google Cloud Run as the new backend.</p>
<p>I didn&rsquo;t discuss costs – you can check out <a href="https://developers.google.com/tag-platform/tag-manager/server-side/cloud-run-setup-guide?provisioning=manual#cloud_run_cost">Google&rsquo;s own documentation</a> for that, but because Cloud Run is computation-as-needed, the costs might be more difficult to guesstimate in advance than it was with App Engine.</p>
<p>So is there still a reason to use App Engine? Sure! If you want <strong>automatic compression</strong>, <strong>automatic geolocation</strong>, and in many ways a more hassle-free experience, you can stick with App Engine. It&rsquo;s not going away (hopefully anytime soon).</p>
<p>But Cloud Run has lots of advantages:</p>
<ul>
<li>You can create multiple services, all in different regions.</li>
<li>Mapping custom domains and creating load balancers is very easy with the new integration.</li>
<li>You have more flexibility over instances, and you only pay for requests that are actually processed.</li>
<li>It&rsquo;s &ldquo;the future&rdquo; of Google Cloud&rsquo;s serverless application stack.</li>
</ul>
<p>I recommend creating a Cloud Run setup with the minimum loadout. That way you can test to see how complicated the process actually is, and you can scale up slowly and with control to not introduce any surprise costs.</p>
<p>If you want a more guided walkthrough of how to work with Cloud Run, consider enrolling in Simmer&rsquo;s <a href="https://www.teamsimmer.com/all-courses/server-side-tagging-in-google-tag-manager/">Server-side Tagging In Google Tag Manager</a> online course.</p>
<p>What are your thoughts on this, recommended deployment? Have you given Cloud Run a spin yet?</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/cloud-run/">cloud run</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/join-ga4-google-ads-data-in-google-bigquery/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/google-tag-template-in-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Cloud%20Run%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <a name="commento"></a>
<comentario-comments></comentario-comments>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2026 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/join-ga4-google-ads-data-in-google-bigquery/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/google-tag-template-in-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Cloud%20Run%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Cloud%20Run%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cloud-run-server-side-tagging-google-tag-manager/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script defer src="https://comentario.simoahava.com/comentario.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>



    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

