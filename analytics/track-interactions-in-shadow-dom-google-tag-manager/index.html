

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Track Interactions In The Shadow DOM Using Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/05\/shadow-dom.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/track-interactions-in-shadow-dom-google-tag-manager\/",
  "datePublished": "2020-05-11T09:55:16\u002b03:00",
  "dateModified": "2020-05-11T09:55:16\u002b03:00",
  "description": "Tracking events that take place in a shadow DOM is tricky, bceause you need to inspect the path of the event rather than just process the event target. This article guides you in creating a custom listener for tracking events within shadow DOMs (where possible).",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Track Interactions In The Shadow DOM Using Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
    
    <meta name="description" content="Tracking events that take place in a shadow DOM is tricky, bceause you need to inspect the path of the event rather than just process the event target. This article guides you in creating a custom listener for tracking events within shadow DOMs (where possible).">
    <meta property="og:description" content="Tracking events that take place in a shadow DOM is tricky, bceause you need to inspect the path of the event rather than just process the event target. This article guides you in creating a custom listener for tracking events within shadow DOMs (where possible).">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Track Interactions In The Shadow DOM Using Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Track Interactions In The Shadow DOM Using Google Tag Manager">
    <meta name="twitter:description" content="Tracking events that take place in a shadow DOM is tricky, bceause you need to inspect the path of the event rather than just process the event target. This article guides you in creating a custom listener for tracking events within shadow DOMs (where possible).">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/05/shadow-dom.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/05/shadow-dom.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" loading="lazy" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Track Interactions In The Shadow DOM Using Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-05-11T09:55:16&#43;03:00">
        
  May 11, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/#commento"><comentario-count path="/analytics/track-interactions-in-shadow-dom-google-tag-manager/" 
                  placeholder="..."
                  error-text="N/A"
                  zero-text="0"
                  prefix=""
                  suffix=" "></comentario-count>Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>The <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM"><strong>shadow DOM</strong></a> is a way to add HTML structures to the web page so that they remain isolated from the rest of the document object model (DOM). It&rsquo;s a popular concept with <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components">web components</a>, as it allows for <em>encapsulation</em> of web structures so that they aren&rsquo;t affected by style declarations of the parent tree, for example.</p>



<div style="aspect-ratio: 1376 / 344;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/shadow-dom.jpg" title="shadow DOM">
  
    <img class="fig-img" height="344" width="1376" loading="lazy" src="https://www.simoahava.com/images/2020/05/shadow-dom.jpg#ZgotmplZ" alt="shadow DOM">
  
    </a>
  
  
</div>


<p>However, being such a &ldquo;hidden&rdquo; structure, anything that happens in the shadow DOM is also hidden from Google Tag Manager&rsquo;s listeners. Or, the click <em>does</em> get registered, but the event target (<strong>{{Click Element}}</strong>) is the node on the parent structure that <em>hosts</em> the shadow DOM rather than the element that was clicked <em>within</em> the shadow DOM.</p>



<div style="aspect-ratio: 1376 / 344;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/shadow-dom-click.jpg" title="shadow DOM clicked">
  
    <img class="fig-img" height="344" width="1376" loading="lazy" src="https://www.simoahava.com/images/2020/05/shadow-dom-click.jpg#ZgotmplZ" alt="shadow DOM clicked">
  
    </a>
  
  
</div>


<p>In this example, GTM would populate the click variables so that the click appeared to land on the <code>&lt;div class=&quot;postShorten-wrap&quot;&gt;</code> when it actually landed on the element within <code>#shadow-root</code>. Similarly, because the shadow DOM&rsquo;s contents are hidden from the parent structure, the <a href="https://www.simoahava.com/analytics/matches-css-selector-operator-in-gtm-triggers/">matches CSS selector</a> predicate can&rsquo;t be used to see what&rsquo;s inside the clicked element.</p>
<p>We can work around this! We can&rsquo;t use GTM&rsquo;s built-in triggers as they don&rsquo;t let us access the <code>event</code> object itself. But we can use a <a href="https://www.simoahava.com/analytics/simple-custom-event-listeners-gtm/">custom event listener</a>.</p>
<blockquote>
<p>For more details on how event handling within the shadow DOM works, take a look at <a href="https://dev.to/open-wc/composed-true-considered-harmful-5g59">this excellent article on the topic</a>.</p>
</blockquote>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="how-event-handling-works-with-the-shadow-dom">How event handling works with the shadow DOM</h2>
<p>Event listeners within the shadow DOM work just like event listeners on regular DOM structures. An event is registered, and it populates a path through the layers of the site during the <a href="https://javascript.info/bubbling-and-capturing"><code>capture</code> and <code>bubble</code> phases</a>.</p>
<p>Some events bubble up towards the top of the DOM tree, some stay on the node where the event was registered.</p>
<p>The main difference with the shadow DOM is that events that start making their way up only cross the shadow DOM boundary if they have the property <code>composed</code> set to <code>true</code>.</p>
<p>Most events have <code>composed</code> set to <code>true</code>. Typically, the exceptions are events that are not based on UI interactions. Like these:</p>
<ul>
<li><code>load</code></li>
<li><code>unload</code></li>
<li><code>abort</code></li>
<li><code>error</code></li>
</ul>
<p>For events that have <code>composed</code> set to <code>true</code>, we can attach a custom event listener on the <code>document</code> node, for example, and the events that take place within the shadow DOM will propagate to our listener (assuming they also <strong>bubble</strong>, or the listener has been set to detect the <strong>capture</strong> phase instead).</p>
<p>However, we are still faced with the problem introduced in the beginning of this article. All events that take place in the shadow DOM are auto-delegated to the parent of the <code>#shadow-root</code>. This isn&rsquo;t very helpful. The shadow DOM could be a huge, sprawling thing, so we need <em>precision</em>.</p>
<p>Luckily, we can use the <code>Event.composedPath()</code> method to get an array that represents the <em>path</em> the event took as it bubbled up. The very first member in the array is the item that was <em>actually</em> clicked (unless the shadow DOM was <code>closed</code>, but we&rsquo;ll get back to that in a minute).</p>
<p>We can use this information to build our listener.</p>

                
                  <h2 id="the-listener">The listener</h2>
<p>In Google Tag Manager, create a <strong>Custom HTML tag</strong>, and type or copy-paste the following code.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
  (<span style="color:#00a">function</span>() {
    <span style="color:#aaa;font-style:italic">// Set to the event you want to track
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> eventName = <span style="color:#a50">&#39;click&#39;</span>,
    <span style="color:#aaa;font-style:italic">// Set to false if you don&#39;t want to use capture phase
</span><span style="color:#aaa;font-style:italic"></span>        useCapture = <span style="color:#00a">true</span>,
    <span style="color:#aaa;font-style:italic">// Set to false if you want to track all events and not just those in shadow DOM
</span><span style="color:#aaa;font-style:italic"></span>        trackOnlyShadowDom = <span style="color:#00a">true</span>;

    <span style="color:#00a">var</span> callback = <span style="color:#00a">function</span>(event) {
      <span style="color:#00a">if</span> (<span style="color:#a50">&#39;composed&#39;</span> <span style="color:#00a">in</span> event &amp;&amp; <span style="color:#00a">typeof</span> event.composedPath === <span style="color:#a50">&#39;function&#39;</span>) {
        <span style="color:#aaa;font-style:italic">// Get the path of elements the event climbed through, e.g.
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// [span, div, div, section, body]
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">var</span> path = event.composedPath();
        
        <span style="color:#aaa;font-style:italic">// Fetch reference to the element that was actually clicked
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">var</span> targetElement = path[<span style="color:#099">0</span>];
        
        <span style="color:#aaa;font-style:italic">// Check if the element is WITHIN the shadow DOM (ignoring the root)
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">var</span> shadowFound = path.length ? path.filter(<span style="color:#00a">function</span>(i) {
          <span style="color:#00a">return</span> !targetElement.shadowRoot &amp;&amp; !!i.shadowRoot;
        }).length &gt; <span style="color:#099">0</span> : <span style="color:#00a">false</span>;
        
        <span style="color:#aaa;font-style:italic">// If only shadow DOM events should be tracked and the element is not within one, return
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">if</span> (trackOnlyShadowDom &amp;&amp; !shadowFound) <span style="color:#00a">return</span>;
        
        <span style="color:#aaa;font-style:italic">// Push to dataLayer
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#0aa">window</span>.dataLayer.push({
          event: <span style="color:#a50">&#39;custom_event_&#39;</span> + event.type,
          custom_event: {
            element: targetElement,
            elementId: targetElement.id || <span style="color:#a50">&#39;&#39;</span>,
            elementClasses: targetElement.className || <span style="color:#a50">&#39;&#39;</span>,
            elementUrl: targetElement.href || targetElement.action || <span style="color:#a50">&#39;&#39;</span>,
            elementTarget: targetElement.target || <span style="color:#a50">&#39;&#39;</span>,
            originalEvent: event,
            inShadowDom: shadowFound
          }
        });
      }
    };
    
    <span style="color:#0aa">document</span>.addEventListener(eventName, callback, useCapture);
  })();
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>You can attach a <strong>Page View</strong> trigger to this tag. After that, every single click on pages where the listener is active will be pushed into <code>dataLayer</code> with an object content that looks like this:</p>



<div style="aspect-ratio: 1522 / 448;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/datalayer-object.jpg" title="Data Layer object">
  
    <img class="fig-img" height="448" width="1522" loading="lazy" src="https://www.simoahava.com/images/2020/05/datalayer-object.jpg#ZgotmplZ" alt="Data Layer object">
  
    </a>
  
  
</div>


<p>In this case, the click fell on a <code>&lt;div&gt;</code> with very few attributes, but which was contained in the shadow Dom (as <code>isShadowDom</code> is <code>true</code>).</p>
<p>You can then create a Custom Event trigger for <code>custom_event_click</code>:</p>



<div style="aspect-ratio: 1850 / 772;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/custom-event-trigger.jpg" title="Custom Event trigger">
  
    <img class="fig-img" height="772" width="1850" loading="lazy" src="https://www.simoahava.com/images/2020/05/custom-event-trigger.jpg#ZgotmplZ" alt="Custom Event trigger">
  
    </a>
  
  
</div>


<p>And you can create Data Layer variables for the individual items in the pushed object like this:</p>



<div style="aspect-ratio: 1582 / 936;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/data-layer-variable.jpg" title="Data Layer Variable">
  
    <img class="fig-img" height="936" width="1582" loading="lazy" src="https://www.simoahava.com/images/2020/05/data-layer-variable.jpg#ZgotmplZ" alt="Data Layer Variable">
  
    </a>
  
  
</div>


<p>By switching <code>eventName</code> to, say, <code>submit</code>, you can listen for form submissions instead.</p>
<p>If you want to avoid having the script push a message with <em>every single event instance</em>, you can add checks within the callback that verify the event target was a specific type of element. For example, to only push to dataLayer if the click landed on a link, you could do something like this:</p>
<pre><code class="language-javacsript" data-lang="javacsript">var callback = function(event) {
  ...
  var targetElement = path[0];
  if (targetElement.matches(&#39;a, a *&#39;)) {
    // Run the dataLayer.push() here
  }
  ...
...</code></pre>
<blockquote>
<p>Note! Though it was just an example, you should be aware that <code>.matches()</code> won&rsquo;t work in IE, and you&rsquo;ll need to use <code>.msMatchesSelector()</code>.</p>
</blockquote>

                
                  <h2 id="what-about-non-composed-events">What about non-composed events?</h2>
<p>What if you want to track events that don&rsquo;t have the <code>composed</code> flag set to <code>true</code>? If you remember, those events will not propagate past the shadow DOM boundaries. Similarly, if you use the script above, they will also have the <code>inShadowDom</code> flag set to <code>false</code>, as they are practically oblivious to the fact that they are in a shadow DOM (Matrix-style).</p>
<p>So, you&rsquo;ll have to do event handling without the power of delegation. In other words, you&rsquo;ll need to add the listeners directly to the elements.</p>
<p>For example, if you wanted to track a <code>load</code> event for a <code>&lt;script&gt;</code> within the shadow DOM, the script would look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
  (<span style="color:#00a">function</span>() {
    <span style="color:#aaa;font-style:italic">// Set to the event you want to track
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> eventName = <span style="color:#a50">&#39;load&#39;</span>;
    <span style="color:#aaa;font-style:italic">// useCapture is irrelevant as we&#39;ll be tracking the element itself
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">//  useCapture = true,
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// trackOnlyShadowDom is irrelevant as we&#39;ll be only tracking an element in the shadow DOM
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">//  trackOnlyShadowDom = true;
</span><span style="color:#aaa;font-style:italic"></span>
    <span style="color:#00a">var</span> callback = <span style="color:#00a">function</span>(event) {
      <span style="color:#00a">if</span> (<span style="color:#a50">&#39;composed&#39;</span> <span style="color:#00a">in</span> event &amp;&amp; <span style="color:#00a">typeof</span> event.composedPath === <span style="color:#a50">&#39;function&#39;</span>) {
        <span style="color:#aaa;font-style:italic">// Irrelevant in this solution, as we are tracking the element itself
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// var path = event.composedPath();
</span><span style="color:#aaa;font-style:italic"></span>        
        <span style="color:#aaa;font-style:italic">// Irrelevant.
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// var targetElement = path[0];
</span><span style="color:#aaa;font-style:italic"></span>        
        <span style="color:#00a">var</span> targetElement = event.target;
        
        <span style="color:#aaa;font-style:italic">// Irrelevant.
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// var shadowFound = path.length ? path.filter(function(i) {
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">//   return !targetElement.shadowRoot &amp;&amp; !!i.shadowRoot;
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// }).length &gt; 0 : false;
</span><span style="color:#aaa;font-style:italic"></span>        
        <span style="color:#aaa;font-style:italic">// Irrelevant
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#aaa;font-style:italic">// if (trackOnlyShadowDom &amp;&amp; !shadowFound) return;
</span><span style="color:#aaa;font-style:italic"></span>        
        <span style="color:#aaa;font-style:italic">// Push to dataLayer
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#0aa">window</span>.dataLayer.push({
          event: <span style="color:#a50">&#39;custom_event_&#39;</span> + event.type,
          custom_event: {
            element: targetElement,
            elementId: targetElement.id || <span style="color:#a50">&#39;&#39;</span>,
            elementClasses: targetElement.className || <span style="color:#a50">&#39;&#39;</span>,
            elementUrl: targetElement.href || targetElement.action || <span style="color:#a50">&#39;&#39;</span>,
            elementTarget: targetElement.target || <span style="color:#a50">&#39;&#39;</span>,
            originalEvent: event,
            inShadowDom: <span style="color:#00a">true</span>
          }
        });
      }
    };
    
    <span style="color:#aaa;font-style:italic">// This is where the script sets the listener on the actual element in the shadow root
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// The script checks if the container exists in the standard DOM, then it checks if the container
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// is the shadow root, and finally it checks if the shadow DOM has the script element.
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> shadowContainer = <span style="color:#0aa">document</span>.querySelector(<span style="color:#a50">&#39;.shadowDomContainer&#39;</span>);
    <span style="color:#00a">if</span> (!!shadowContainer &amp;&amp; !!shadowContainer.shadowRoot) {
      <span style="color:#00a">var</span> scriptTarget = shadowContainer.shadowRoot.querySelector(<span style="color:#a50">&#39;script#someId&#39;</span>);
      <span style="color:#00a">if</span> (!!scriptTarget) scriptTarget.addEventListener(eventName, callback);
    }
  })();
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>Here the <code>addEventListener</code> call at the end is quite a bit more complex than the generic one we used before. You first need to find the node to which the shadow DOM is embedded (the <strong>shadow root</strong>). Then, accessing its <code>shadowRoot</code> property, you are allowed to query for elements within the shadow DOM (assuming the shadow DOM is <code>open</code>).</p>
<p>After the usual checks for whether the element exists, you can then add your listener directly to the element, and it will invoke the callback as soon as it registers the event.</p>

                
                  <h2 id="what-about-a-closed-shadow-dom">What about a closed shadow DOM?</h2>
<p>If the shadow DOM is created in <code>closed</code> mode, you are basically unable to do anything with the <code>shadowRoot</code>. If you try to access it with DOM methods, the <code>shadowRoot</code> property will simply return <code>null</code>, and similarly the <code>composedPath()</code> returns an array of elements that stops with the shadow root node.</p>
<p>Thus, on a superficial level, there&rsquo;s really nothing you can do to track the precise interactions within the shadow DOM.</p>
<p>However, there is a workaround.</p>
<p>When the shadow DOM is created, if the developers store a reference to it in a global variable, you can interact with it, and you can add listeners to the elements in the document fragment if you wish.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#aaa;font-style:italic">// Create a shadow DOM
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">var</span> container = <span style="color:#0aa">document</span>.querySelector(<span style="color:#a50">&#39;.someContainer&#39;</span>);
<span style="color:#0aa">window</span>._shadowRoot = container.attachShadow({mode: <span style="color:#a50">&#39;closed&#39;</span>});
</code></pre></div>
<p>In the sample above, the global variable <code>_shadowRoot</code> maintains a reference to the shadow DOM, and thus you can use methods like <code>window._shadowRoot.addEventListener(...)</code> to manipulate and interact with elements within the shadow DOM.</p>
<p>It does require some cooperation with the developers, and you&rsquo;d also need to justify why the mode is set to <code>closed</code> in the first place if the developers add an opening by way of a global variable.</p>

                
                  <h2 id="summary">Summary</h2>
<p>Hopefully this article has been instructive. I have a gut feeling that the shadow DOM is somewhat of a mystery to many web analytics developers simply because it&rsquo;s not the most common way to add elements to the web page.</p>
<p>However, it offers powerful tools for encapsulation and separation of concerns, and especially in lieu of clumsy iframe embeds it might make a lot of sense from a web development point of view.</p>
<p>The pointers in this article should give you the tools for identifying yet another potential issue with Google Tag Manager&rsquo;s built-in listeners, and it should help you tackle it with the power of some custom scripting.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">javascript</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/event-listeners/">event listeners</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/use-all-events-trigger-more-control/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Track%20Interactions%20In%20The%20Shadow%20DOM%20Using%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <script defer src="https://comentario.simoahava.com/comentario.js"></script>
<a name="commento"></a>
<comentario-comments></comentario-comments>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2025 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/use-all-events-trigger-more-control/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Track%20Interactions%20In%20The%20Shadow%20DOM%20Using%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Track%20Interactions%20In%20The%20Shadow%20DOM%20Using%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>



    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

