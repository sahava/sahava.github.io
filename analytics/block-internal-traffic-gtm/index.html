

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    

<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Block Internal Traffic With Google Tag Manager | Simo Ahava's blog",
  "image": "https://www.simoahava.com/images/2014/03/custom-dimension.png",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.simoahava.com/images/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https://www.simoahava.com/analytics/block-internal-traffic-gtm/",
  "datePublished": "2014-03-14T11:30:08+00:00",
  "dateModified": "2014-03-14T11:30:08+00:00",
  "description": "Guide and tips for how to block internal traffic from Google Analytics using Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.31 with theme Tranquilpeak 0.4.3-BETA">
    <title>Block Internal Traffic With Google Tag Manager | Simo Ahava's blog</title>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PZ7GMV9');</script>
    
    <script src="//simoahava.disqus.com/count.js" id="dsq-count-scr" async></script>
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/block-internal-traffic-gtm/">
    
    <meta name="description" content="Guide and tips for how to block internal traffic from Google Analytics using Google Tag Manager.">
    <meta property="og:description" content="Guide and tips for how to block internal traffic from Google Analytics using Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Block Internal Traffic With Google Tag Manager">
    <meta property="og:url" content="/analytics/block-internal-traffic-gtm/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Block Internal Traffic With Google Tag Manager">
    <meta name="twitter:description" content="Guide and tips for how to block internal traffic from Google Analytics using Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2014/03/custom-dimension.png">  
      <meta property="og:image" content="https://www.simoahava.com/images/2014/03/custom-dimension.png">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Block Internal Traffic With Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2014-03-14T11:30:08Z">
        
  March 14, 2014

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/block-internal-traffic-gtm/#disqus_thread">Comments</a> <span id="linkedincount"></span>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              

<p>You&rsquo;ve probably come across a <a href="http://www.seerinteractive.com/blog/best-ways-to-exclude-internal-traffic-in-google-analytics">number</a> of <a href="http://andygibson.us/2013/09/filter-internal-traffic-using-custom-variables/">guides</a> or posts talking about why it&rsquo;s necessary to block so-called <em>internal traffic</em> from your web analytics reports. The reasons are pretty solid: internal traffic does not emulate normal visitor behavior, it rarely contributes to conversions (skewing up your conversion rate), it inflates page views, and it wreaks havoc on your granular, page-by-page data.</p>

<p>Internal traffic is vaguely described as &ldquo;your employees&rdquo;, &ldquo;people really close to your brand&rdquo;, &ldquo;your marketing department&rdquo;, &ldquo;your web editors&rdquo;, and so on. Basically, it should be a term which covers <em>traffic that does not adequately represent trending visitor behavior on your site</em>. Most often, this is &ldquo;internal&rdquo;, in that it is traffic by people who generate the content. It can also be your proof-readers (wives, husbands, best friends), beta testers (wives, husbands, best friends), outreach marketers (wives, husb&hellip; you get my drift).</p>

<p>In this post, I&rsquo;ll introduce two methods to annotate this kind of internal traffic using (mostly) Google Tag Manager. The underlying premise is that your internal traffic comes from such a diverse number of sources that it&rsquo;s impossible to filter it using Google Analytics&rsquo; own filters. Another possibility is that you&rsquo;ve decided to <a href="https://support.google.com/analytics/answer/2763052?hl=en">anonymize IP data</a> sent to Google Analytics servers, which means that even if you&rsquo;d just have a certain range of IPs, you couldn&rsquo;t use Google Analytics&rsquo; filters, since the last octet has been censored (more about this later).</p>

<p>By the way, I use the term <em>annotate</em> instead of <em>block</em> (except in the search engine friendly title, GUILTY!), because whether or not you actually want to block the data or just segment it is up to you. You could also follow <a href="http://www.lunametrics.com/blog/2014/03/11/goodbye-to-exclude-filters-google-analytics/">Lunametrics&rsquo; excellent guide</a> on preventing the data from being sent to Google Analytics in the first place, but I wanted to follow a more reconciliatory route, offering a way for you to still incorporate internal traffic in your reports, if you so choose. And this route is, of course, a <strong>custom dimension</strong>.</p>

<h2 id="the-premise">The premise</h2>

<p>I will introduce two methods: 1) Visit to URL, and 2) IP extraction. Both have their pros and cons.</p>

<p>If the people you want included in your <em>internal traffic</em> are constantly on the move, use a variety of devices on the road, or are hard to pin down just by using an IP address range, you should use the first method. This way you&rsquo;ll also leave these people an out. You see, sometimes your employees are also your customers or normal site visitors, which means that their behavior should be included in your actual traffic reports.</p>

<p>IP extraction requires that you have specific IP address ranges in mind which you want to block. This is best for traffic which originates from stationary places, like office buildings or office networks.</p>

<p>Whichever you choose, you&rsquo;ll need to set up a <strong>custom dimension</strong> first, which will store your data. It&rsquo;s really simple, and Google has <a href="https://support.google.com/analytics/answer/2709829?hl=en">a great guide</a> on how to get started.</p>

<p>If you want to provide your internal traffic an out, you should create a <strong>session-scope</strong> custom dimension. This way internal traffic is annotated separately from one session to the next.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/custom-dimension.png" title="Create custom dimension either session or user scope">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/custom-dimension.png#ZgotmplZ" alt="Create custom dimension either session or user scope">
  
    </a>
  
  
</div>



<p>If, however, you want the annotation to stick &ldquo;for life&rdquo;, you should create a <strong>user-scope</strong> custom dimension (<em>user</em> is the same as <em>device</em>). This way the annotation will persist from session to session, even if the IP extraction fails or the user doesn&rsquo;t visit your designated &ldquo;internal traffic&rdquo; URL.</p>

<h2 id="method-1-visit-to-url">Method 1: Visit to URL</h2>

<p>I really like this method, since it&rsquo;s completely client-side, it doesn&rsquo;t require any custom functions or external API calls to retrieve the IP address, and it provides an out for your employees or users, if they wish to be treated as external traffic.</p>

<p>One thing that it does require, however, is that your internal traffic remembers to use the URL every single time they visit your site (unless they don&rsquo;t want to be treated separately). Since you&rsquo;re using a session-scope dimension here, it&rsquo;s ok if the internal traffic URL is not the <em>landing page</em> of the visit. A session-scope custom dimension hit is applied retroactively to all hits in the session, so as long as the custom dimension is sent with a single hit during the session, it will suffice to annotate all hits in the session.</p>

<p>I prefer to use a <strong>URL query parameter</strong> as the trigger that tags the visitor as internal traffic. This means that:</p>

<ol>
<li><p>You need to make sure that your server accepts query parameters in URL addresses</p></li>

<li><p>You should canonicalize all pages to the parameter-less version, so that search engines won&rsquo;t index your internal traffic page by accident (use <code>&lt;link rel=&quot;canonical&quot; href=&quot;http://url-of-page-without-query-parameters&quot;/&gt;</code>)</p></li>

<li><p>You should configure your Google Analytics view so that this query parameter is stripped from reports (because it doesn&rsquo;t add any value content-wise)</p></li>
</ol>

<p>For this example, I&rsquo;ve chosen the query <strong>internal=true</strong> as the trigger. So if you navigate to the homepage, you&rsquo;d need to use <code>http://www.mydomain.com/?internal=true</code> to be tagged as internal traffic.</p>

<p>Here&rsquo;s how you use the query parameter as a custom dimension in your tags.</p>

<ol>
<li><p>Create a new macro (Macro Name: <strong>Internal URL</strong>, Macro Type: <strong>URL</strong>, Component Type: <strong>Query</strong>)</p></li>

<li><p>In the field <em>Query Key</em>, add <strong>internal</strong></p></li>
</ol>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/internal-url.png" title="Internal traffic URL macro">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/internal-url.png#ZgotmplZ" alt="Internal traffic URL macro">
  
    </a>
  
  
</div>



<p>When called, this macro looks at your URL, tries to find the query parameter &ldquo;internal&rdquo;, and if it does, it returns its value (&ldquo;true&rdquo;). If no parameter is found, it returns an <em>undefined</em> which suits us just fine.</p>

<p>Next, you&rsquo;ll need to send this along with your page view tag.</p>

<ol>
<li><p>Open your page tracking tag</p></li>

<li><p>Go to <strong>More Settings</strong> &gt;&gt; <strong>Custom Dimensions</strong></p></li>

<li><p>Add the index number of your custom dimension in the appropriate slot</p></li>

<li><p>Add <strong>{{Internal URL}}</strong> into the <em>Dimension</em> field</p></li>
</ol>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/custom-dimension-pageview.png" title="Internal URL Custom dimension">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/custom-dimension-pageview.png#ZgotmplZ" alt="Internal URL Custom dimension">
  
    </a>
  
  
</div>



<p>And <strong><em>that&rsquo;s it</em></strong>! The beauty of Google Tag Manager macros is that you don&rsquo;t need a separate page view tag for undefined custom dimensions. You can just use this one macro. If the query parameter &ldquo;internal&rdquo; is found, its value (&ldquo;true&rdquo;) is sent as a custom dimension along with your page view hit. However, if no such parameter is found, <em>no custom dimension is sent</em>, so you don&rsquo;t have to worry about overwriting your data with an empty custom dimension or something.</p>

<p>Finally, check with a debugger like <a href="http://webanalyticssolutionprofiler.com/">WASP</a> that your custom dimension is actually being sent over.</p>

<h3 id="pro-tip-use-a-url-rewrite">Pro tip, use a URL rewrite</h3>

<p>If you or your internal traffic users find that using a URL query parameter is tedious, you should set up a 301 server-side redirection, and use either a vanity URL or a subdomain to handle the redirection. So if <code>http://www.mydomain.com/?internal=true</code> is just too difficult to manage, make it so that <code>http://www.mydomain.com/office</code> or <code>office.mydomain.com</code> redirect the user to the home page with the query parameter in place (or both!). If you have an Apache server, you could try something like this for the subdomain redirect (check with IT first!):</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ApacheConf" data-lang="ApacheConf">RewriteEngine <span style="color:#66d9ef">on</span>
RewriteCond %{HTTP_HOST} ^office\.mydomain\.com$
RewriteRule ^$ http://www.mydomain.com/?internal=true [R=301,L]</code></pre></div>

<h2 id="method-2-ip-extraction">Method 2: IP extraction</h2>

<p>A popular way to separate internal traffic from external traffic is to use the client&rsquo;s IP address. The most common method is to use Google Analytics&rsquo; standard features to filter out any IP addresses that are within a specified range. Because this is so &ldquo;standard&rdquo;, I won&rsquo;t go into it (you can read the <a href="https://support.google.com/analytics/answer/1034840?hl=en">official words here</a>).</p>

<p>This guide is for <em>annotating</em> internal traffic, not for filtering it, so you&rsquo;ll be checking the client&rsquo;s IP address against a specified range, and if there&rsquo;s a match, you&rsquo;ll send this information via custom dimension.</p>

<p>(<strong>Pro tip</strong>: This is especially useful if you have <strong>IP anonymization</strong> set up. In Google Analytics, IP anonymization censors the last octet of the client&rsquo;s IP (111.222.333.<strong>XXX</strong>) and sets it to 0 (111.222.333.<strong>0</strong>). This is what&rsquo;s sent to Google Analytics servers, ensuring a higher level of security, if you don&rsquo;t want the geeks at Mountain View looking at your visitors&rsquo; IP addresses.)</p>

<p>To extract the client IP, you have a number of choices. The accuracy will vary greatly, since if the visitor is using a proxy, for example, it&rsquo;s not really their IP that&rsquo;s retrieved but the proxy&rsquo;s. In this guide, I&rsquo;ll introduce you to a simple PHP value retrieval, and also how to retrieve the IP with JavaScript using an external API call.</p>

<h3 id="retrieve-and-process-the-ip-with-php">Retrieve and process the IP with PHP</h3>

<p>This is one way to do it, and it should work if you have a site which is parsed with PHP (WordPress, Drupal, etc.). In your page template, before your container snippet, you create the dataLayer object with <strong>window.dataLayer = window.dataLayer || [];</strong>. Use this to enter the client IP into the dataLayer object as it is created. This way it will be ready when the container is set up and your page views are sent:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">||</span> [];
  window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
    <span style="color:#e6db74">&#34;ipaddress&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;?php echo $IPADDRESS ?&gt;&#34;</span>
  });</code></pre></div>

<p>This will retrieve the IP address using the designated PHP variable, and it will store it in the data layer variable <strong>ipaddress</strong>.</p>

<p>This is a great way to extract the IP address, since you don&rsquo;t have to wait for an external API to resolve the address. <a href="http://techtalk.virendrachandak.com/getting-real-client-ip-address-in-php-2/">Here&rsquo;s a more thorough guide</a> on retrieving the IP with a PHP call.</p>

<p>Next, create a Data Layer Variable Macro through which you can process the IP:</p>

<ol>
<li><p>Create new macro (Macro Name: <strong>Retrieve IP</strong>, Macro Type: <strong>Data Layer Variable</strong>)</p></li>

<li><p>Set <strong>ipaddress</strong> as the Data Layer Variable Name</p></li>

<li><p>Set <strong>none</strong> as the Default Value</p></li>
</ol>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/retrieve-ip-dlv.png" title="Retrieve IP macro DLV">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/retrieve-ip-dlv.png#ZgotmplZ" alt="Retrieve IP macro DLV">
  
    </a>
  
  
</div>



<p>(Why the default value, you ask? Well I like dealing with declared entities, so that I won&rsquo;t have to check for <em>undefined</em> every single time I want to process a variable.)</p>

<p>Next, you&rsquo;ll need a Custom HTML tag in which you&rsquo;ll process the IP address. The aim is to push a data layer variable &ldquo;internal&rdquo;: &ldquo;true&rdquo;, if the IP matches a given address or range.</p>

<ul>
<li><p>Create new Custom HTML Tag</p></li>

<li><p>Add the following code within:</p></li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Retrieve</span> <span style="color:#a6e22e">IP</span>}}; <span style="color:#75715e">// Retrieves the IP from the data layer
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Comment following three lines if you want to use the IP range method
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;111.222.333.444&#34;</span>) {
    <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({<span style="color:#e6db74">&#34;internal&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;true&#34;</span>});
  }

  <span style="color:#75715e">// To use the following IP range check, comment the previous three lines
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// of code and uncomment the following lines
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//  var ipRange = ipaddress.split(&#34;.&#34;);
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//  var lastOctet = parseInt(ipRange.pop());
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//  if(lastOctet &gt;= 1 &amp;&amp; lastOctet &lt;= 100) {
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//    dataLayer.push({&#34;internal&#34;: &#34;true&#34;});
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//  }
</span><span style="color:#75715e"></span>  
  <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({<span style="color:#e6db74">&#34;event&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ipComplete&#34;</span>});
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<ul>
<li>Add Firing Rule to tag: <strong>{{event}} equals gtm.js</strong></li>
</ul>

<p>You have two choices in the code above. Either you do an exact match (if your office has just one IP address), or you check against a range. In the range check, I check if the last octet (111.222.333.<strong>XXX</strong>) is between 1 and 100, so remember to modify this to match the range you want to check for. And if you have multiple IP addresses you want to include in the check, just modify the if-clause to your liking. You can (and should) also use regular expression pattern matching, if the variations get more diverse.</p>

<p>Whatever you do, this should push the data layer variable &ldquo;internal&rdquo;: &ldquo;true&rdquo; if the IP address matches a given pattern. Finally, you push a trigger event &ldquo;ipComplete&rdquo;, which is what will fire your page view tag, with which the custom dimension is also passed along.</p>

<p>The Firing Rule here is <strong>{{event}} equals gtm.js</strong> to ensure that the code is run at the earliest possible opportunity, to avoid delaying the page view call any more than necessary.</p>

<h3 id="retrieve-and-process-the-ip-with-javascript">Retrieve and process the IP with JavaScript</h3>

<p>If you can&rsquo;t use PHP or server-side scripting, you can use JavaScript. Well, you can&rsquo;t <em>technically</em> resolve the client IP using just JavaScript. You need to request the IP from an external resource such as <a href="http://hostip.info">Hostip.info</a> or <a href="http://www.geoplugin.com">GeoPlugin</a>. This means that this approach is a bit more suspect, because you have to trust the request endpoint to serve you with the correct data every time. Nevertheless, if you can&rsquo;t retrieve the IP server-side, this is what you should try.</p>

<p>I use Hostip.info in my example, but there are a number of APIs out there that you can use. I suggest you find an API that allows you to retrieve the data with an asynchronous AJAX request (you could also use an XMLHttpRequest), and which returns the data as a JSON object that you can then parse. This way your contraption won&rsquo;t go up in flames, taking most of your website along in its carnival of destruction, if the endpoint chooses to change the way it distributes.</p>

<p>I&rsquo;ve added the AJAX call to the Custom HTML Tag where I&rsquo;ll be doing the pattern matching as well.</p>

<p><strong>NOTE!</strong> This script requires that you have loaded <a href="https://developers.google.com/speed/libraries/devguide#jquery">jQuery</a> before this script is run. So make sure the library is loaded first.</p>

<ul>
<li><p>Create new Custom HTML Tag</p></li>

<li><p>Add the following code in the tag:</p></li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">matchIP</span>(<span style="color:#a6e22e">ipaddress</span>) {
    <span style="color:#75715e">// Comment following three lines if you want to use the IP range method
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;111.222.333.444&#34;</span>) {
      <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({<span style="color:#e6db74">&#34;internal&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;true&#34;</span>});
    }

    <span style="color:#75715e">// To use the following IP range check, comment the previous three lines
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// of code and uncomment the following lines
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  var ipRange = ipaddress.split(&#34;.&#34;);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  var lastOctet = parseInt(ipRange.pop());
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  if(lastOctet &gt;= 1 &amp;&amp; lastOctet &lt;= 100) {
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//    dataLayer.push({&#34;internal&#34;: &#34;true&#34;});
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  }
</span><span style="color:#75715e"></span>  }
  
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
  <span style="color:#66d9ef">try</span> {
    <span style="color:#a6e22e">jQuery</span>.<span style="color:#a6e22e">ajax</span>({
      <span style="color:#a6e22e">type</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;GET&#34;</span>,
      <span style="color:#a6e22e">dataType</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;json&#34;</span>,
      <span style="color:#a6e22e">url</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://api.hostip.info/get_json.php&#34;</span>,
      <span style="color:#66d9ef">async</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
      <span style="color:#a6e22e">success</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>) {
        <span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">ip</span>;      
      },<span style="color:#a6e22e">error</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">errorData</span>) {
        <span style="color:#a6e22e">ipaddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>;
      },<span style="color:#a6e22e">complete</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">matchIP</span>(<span style="color:#a6e22e">ipaddress</span>);
      }
    });
  } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>) {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Oops, something went wrong: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">message</span>);
  }
  <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({<span style="color:#e6db74">&#34;event&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ipComplete&#34;</span>});
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<ul>
<li>Set Firing Rule for tag <strong>{{event}} equals gtm.js</strong></li>
</ul>

<p><strong>Phew!</strong></p>

<p>In this tag, you send an asynchronous HTTP POST request to the endpoint at hostip.info. The request returns a JSON script, which you parse for the node &ldquo;ip&rdquo;. The value stored in this node is then stored in the data layer variable <strong>ipaddress</strong>. Finally, as soon as the request is complete, you call a function called <strong>matchIP()</strong>, where the actual parsing takes place.</p>

<p>The parsing is identical to what we did in the PHP IP retrieval script, so you can either evaluate an exact match or a range of IP addresses. With small modifications you can check versus multiple addresses and ranges, if you so choose.</p>

<p>Again, the desired end result is a new data layer variable &ldquo;internal&rdquo;, which should have the value &ldquo;true&rdquo;, if traffic is internal. It should remain undefined if traffic is not internal, or if an error crops up in your AJAX request.</p>

<p>And again, there&rsquo;s the trigger event &ldquo;ipComplete&rdquo;, which is the firing rule for your page view, which will be the vessel for your custom dimension.</p>

<p>The firing rule for this Custom HTML Tag is <strong>{{event}} equals gtm.js</strong>, because you want to make sure that the script is run at the earliest possible moment to avoid delaying your page view call any more than necessary.</p>

<h3 id="send-custom-dimension-with-page-view-tag">Send custom dimension with page view tag</h3>

<p>And, finally, we are about to reach the end of this arduous journey. It&rsquo;s time to modify your page view tag, so that it includes information about the traffic type in a custom dimension.</p>

<p>First, create a Data Layer Variable Macro for your internal traffic.</p>

<ul>
<li><p>Macro Name: <strong>Internal IP</strong></p></li>

<li><p>Macro Type: <strong>Data Layer Variable</strong></p></li>

<li><p>Data Layer Variable Name: <strong>internal</strong></p></li>
</ul>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/internal-ip.png" title="Internal IP macro">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/internal-ip.png#ZgotmplZ" alt="Internal IP macro">
  
    </a>
  
  
</div>



<p>Now we&rsquo;re ready to edit the page view tag.</p>

<ol>
<li><p>Open your page view tag</p></li>

<li><p>Go to <strong>More Settings</strong> &gt;&gt; <strong>Custom Dimensions</strong></p></li>

<li><p>Add a new Custom Dimension, and give it the correct index number</p></li>

<li><p>In the <strong>Dimension</strong> slot, add your new data layer variable macro (<strong>{{Internal IP}}</strong>)</p></li>

<li><p>Add Firing Rule: <strong>{{event}} equals ipComplete</strong></p></li>
</ol>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/03/pageview-tag.png" title="Page view tag">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/03/pageview-tag.png#ZgotmplZ" alt="Page view tag">
  
    </a>
  
  
</div>



<p>That&rsquo;s it! Your page view tag obediently waits for the IP check to complete. Once the check is made, if traffic was internal, the value &ldquo;true&rdquo; is sent as a custom dimension with the page view tag.</p>

<p><strong>NOTE!</strong> Making your page view tag wait for any scripts (especially external API calls) is a bit dangerous, since if there&rsquo;s a significantly long load time, your page view might not get sent at all. You might want to leave your page view tag as it is, and send the <a href="https://www.simoahava.com/analytics/universal-analytics-send-custom-dimension-event/">custom dimension with a non-interaction event</a> instead.</p>

<h2 id="conclusions">Conclusions</h2>

<p>I didn&rsquo;t intend this post to be a be-all and end-all to All Internal Traffic Exclusion Guides on the web, so I&rsquo;m a bit confused why this ended up being such a long post.</p>

<p>Regardless of my verbosity, I hope this post served to highlight some of Google Tag Manager&rsquo;s amazing versatility. The combination of macros, tags, and defined / undefined custom dimensions creates opportunities for really complex tagging with a really simple setup.</p>

<p>With the help of this post, you can now segment (or filter) your internal traffic in Google Analytics by looking for &ldquo;true&rdquo; in your Internal Traffic custom dimension.</p>

<p>What other ways have you discovered to identify internal traffic (with or without GTM)? I&rsquo;d love to add a third method to this tutorial, even though then this will <strong>really</strong> be a bloated guide.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/api/">api</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/custom-html/">custom html</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/internal-traffic/">internal traffic</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/ip/">ip</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/macros/">macros</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/gtm-listener-firing-order-test/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Block%20Internal%20Traffic%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/block-internal-traffic-gtm/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <span id="disqus"></span>
<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2018 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/container-snippet-gtm-secrets-revealed/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/gtm-listener-firing-order-test/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Block%20Internal%20Traffic%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/block-internal-traffic-gtm/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/block-internal-traffic-gtm/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=%25!s%28BADINDEX%29">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fwww.simoahava.com%2Fanalytics%2Fblock-internal-traffic-gtm%2F%20%25!s%28BADINDEX%29%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=%25!s%28BADINDEX%29">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=%25!s%28BADINDEX%29">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://www.simoahava.com/js/script.js"></script>




  
    
      <script>
        





        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'simoahava';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

