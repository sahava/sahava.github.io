

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Google Optimize Anti-flicker Snippet Delay Test | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/05\/optimize-anti-flicker-snippet-test.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/optimize-anti-flicker-snippet-delay-test\/",
  "datePublished": "2020-05-29T12:43:16\u002b03:00",
  "dateModified": "2020-05-29T12:43:16\u002b03:00",
  "description": "How to test the average duration of the Google Optimize anti-flicker snippet hiding the page while waiting for experiment data to load.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Google Optimize Anti-flicker Snippet Delay Test | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/optimize-anti-flicker-snippet-delay-test/">
    
    <meta name="description" content="How to test the average duration of the Google Optimize anti-flicker snippet hiding the page while waiting for experiment data to load.">
    <meta property="og:description" content="How to test the average duration of the Google Optimize anti-flicker snippet hiding the page while waiting for experiment data to load.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Google Optimize Anti-flicker Snippet Delay Test">
    <meta property="og:url" content="https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Google Optimize Anti-flicker Snippet Delay Test">
    <meta name="twitter:description" content="How to test the average duration of the Google Optimize anti-flicker snippet hiding the page while waiting for experiment data to load.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" loading="lazy" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Google Optimize Anti-flicker Snippet Delay Test
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-05-29T12:43:16&#43;03:00">
        
  May 29, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>Recently <a href="https://www.simoahava.com/analytics/simple-way-measure-a-b-test-flicker-impact/">I published an article</a> on how to set up an <em>impact test</em> for the &ldquo;flicker effect&rdquo; omnipresent in client-side A/B-testing tools. Be sure to check out that article first to get some context to what we&rsquo;re going to be talking about here.</p>



<div style="aspect-ratio: 1018 / 506;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg" title="Optimize anti-flicker snippet test">
  
    <img class="fig-img" height="506" width="1018" loading="lazy" src="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg#ZgotmplZ" alt="Optimize anti-flicker snippet test">
  
    </a>
  
  
</div>


<p>In this short follow-up, I&rsquo;ll show you how to measure the average time of the <a href="https://support.google.com/optimize/answer/7100284">anti-flicker snippet</a> delaying page visibility, if you choose to deploy the snippet. The methodology is very similar.</p>
<p>If you recall, the anti-flicker snippet <strong>hides</strong> the entire page while waiting for the Optimize container to load. So we&rsquo;ll be measuring how long it took for the page to become unhidden. Visibility is restored if the Optimize container loads successfully, or if the load ends in a timeout (4 seconds by default).</p>
<p>The test below is run by splitting 50% of traffic to the <a href="https://support.google.com/optimize/answer/9692472?hl=en">asynchronous Optimize snippet</a> and 50% of the traffic to the <a href="https://support.google.com/optimize/answer/6314801">Google Tag Manager Optimize tag</a>.</p>
<p>We&rsquo;re using <a href="https://www.simoahava.com/analytics/getting-started-with-google-analytics-app-web/">Google Analytics: App + Web</a> with its wonderful <a href="https://www.simoahava.com/analytics/enable-bigquery-export-google-analytics-app-web/">BigQuery export</a> for the analysis. We&rsquo;ll be using Google Tag Manager to collect and send the data forward.</p>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="modify-the-page-template">Modify the page template</h2>
<p>You need to edit the <strong>page template</strong>. The anti-flicker snippet <strong>must</strong> be added directly to the page template, and we also need to write the logic that determines whether the user should see the Optimize snippet or whether Optimize should be loaded via Google Tag Manager.</p>
<p>At the very <strong>top</strong> of the <code>&lt;head&gt;</code> element on your experiment pages, add the following HTML block:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#aaa;font-style:italic">&lt;!-- The style declaration for the anti-flicker snippet --&gt;</span>
&lt;<span style="color:#1e90ff;font-weight:bold">style</span>&gt;.<span style="color:#0a0;text-decoration:underline">async-hide</span> { <span style="color:#00a">opacity</span>: <span style="color:#099">0</span> <span style="color:#4c8317">!important</span>} &lt;/<span style="color:#1e90ff;font-weight:bold">style</span>&gt;

&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
  (<span style="color:#00a">function</span>() {
    <span style="color:#aaa;font-style:italic">// Modify the optimizeId to match your Optimize container ID, gtmId
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// to match your GTM container ID, and dataLayerName to match the name
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic">// of the dataLayer array on your site.
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> optimizeId = <span style="color:#a50">&#39;GTM-NGM64B&#39;</span>,
        gtmId = <span style="color:#a50">&#39;GTM-PZ7GMV9&#39;</span>,
        dataLayerName = <span style="color:#a50">&#39;dataLayer&#39;</span>,
        hideObj = {},
        hideGTMId = <span style="color:#0aa">Math</span>.random() &lt; <span style="color:#099">0.5</span> ? optimizeId : gtmId;
    
    hideObj[hideGTMId] = <span style="color:#00a">true</span>;
    
    <span style="color:#aaa;font-style:italic">// Helper to handle the dataLayer.push()
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> dPush = <span style="color:#00a">function</span>(status) {
      <span style="color:#0aa">window</span>[dataLayerName].push({
        event: <span style="color:#a50">&#39;optimize_anti_flicker_test&#39;</span>,
        milestones: {
          antiFlickerStart: <span style="color:#0aa">window</span>[dataLayerName].hide.start,
          antiFlickerEnd: <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime(),
          testStatus: status
        }
      });
    };

    <span style="color:#aaa;font-style:italic">// MODIFIED anti-flicker snippet
</span><span style="color:#aaa;font-style:italic"></span>    (<span style="color:#00a">function</span>(a,s,y,n,c,h,i,d,e) {
      s.className + = <span style="color:#a50">&#39; &#39;</span> + y;
      h.start = <span style="color:#099">1</span> * <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>;
      h.end = i = <span style="color:#00a">function</span>(){
        clearTimeout(t); 
        s.className = s.className.replace(<span style="color:#0aa">RegExp</span>(<span style="color:#a50">&#39; ?&#39;</span> + y), <span style="color:#a50">&#39;&#39;</span>)
      };
      (a[n] = a[n] || []).hide = h;
      <span style="color:#00a">var</span> t = setTimeout(<span style="color:#00a">function</span>() {
        dPush(<span style="color:#a50">&#39;timeout&#39;</span>);
        i();
        h.end = <span style="color:#00a">null</span>;
      }, c);
      h.timeout = c;
    })(<span style="color:#0aa">window</span>, <span style="color:#0aa">document</span>.documentElement, <span style="color:#a50">&#39;async-hide&#39;</span>, dataLayerName, <span style="color:#099">4000</span>, hideObj);

    <span style="color:#aaa;font-style:italic">// Determine where to load Optimize from (inline vs. GTM)
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">if</span> (hideGTMId === optimizeId) {
      <span style="color:#00a">var</span> el = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;script&#39;</span>);
      el.src = <span style="color:#a50">&#39;https://www.googleoptimize.com/optimize.js?id=&#39;</span> + optimizeId;
      el.addEventListener(<span style="color:#a50">&#39;error&#39;</span>, <span style="color:#00a">function</span>() {
        dPush(<span style="color:#a50">&#39;optimizeSnippetError&#39;</span>);
        <span style="color:#0aa">window</span>[dataLayerName].hide.end &amp;&amp; <span style="color:#0aa">window</span>[dataLayerName].hide.end();
      });
      <span style="color:#0aa">document</span>.head.appendChild(el);
    } <span style="color:#00a">else</span> {
      <span style="color:#0aa">window</span>[dataLayerName].push({
        gtmOptimize: <span style="color:#00a">true</span>
      });
    }
    
    <span style="color:#aaa;font-style:italic">// Configure the Optimize callback
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">function</span> gtag() {dataLayer.push(arguments)};
    gtag(<span style="color:#a50">&#39;event&#39;</span>, <span style="color:#a50">&#39;optimize.callback&#39;</span>, {
      callback: <span style="color:#00a">function</span>() {
        dPush(hideGTMId === optimizeId ? <span style="color:#a50">&#39;optimizeSnippet&#39;</span> : <span style="color:#a50">&#39;gtmTag&#39;</span>);
      }
    });
  })();
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>You should only add this snippet on pages that are actually running the experiment, to make sure you don&rsquo;t accidentally collect measurements from pages that aren&rsquo;t actually running Optimize.</p>
<p>In the first block of variables, make sure you update <code>optimizeId</code>, <code>gtmId</code>, and <code>dataLayerName</code> to reflect your Optimize ID, Google Tag Manager container ID, and name of the <code>dataLayer</code> array, respectively.</p>
<p><code>var hideGTMId = Math.random() &lt; 0.5 ? optimizeId : gtmId;</code> chooses randomly (50% chance) whether to load Optimize using the asynchronous inline snippet or through a Google Tag Manager tag.</p>
<p>The <strong>anti-flicker snippet</strong> is <em>modified</em> in this version. The main change is that <strong>if</strong> the timeout happens (by default 4000 milliseconds after the page was hidden), a <code>dataLayer.push()</code> is called with this information. Because of this, another modification to the snippet is to <em>stop</em> the timeout counter in case the page is unhidden (to avoid the timeout being erroneously reported to <code>dataLayer</code>):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">h.end = i = <span style="color:#00a">function</span>() {
  clearTimeout(t);
  ...
}
<span style="color:#00a">var</span> t = setTimeout(<span style="color:#00a">function</span>() {
  dPush(<span style="color:#a50">&#39;timeout&#39;</span>);
  ...
}, c);
</code></pre></div>
<p>The following block checks if Optimize should be loaded via the snippet or via GTM.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#aaa;font-style:italic">// Determine where to load Optimize from (inline vs. GTM)
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">if</span> (hideGTMId === optimizeId) {
  <span style="color:#00a">var</span> el = <span style="color:#0aa">document</span>.createElement(<span style="color:#a50">&#39;script&#39;</span>);
  el.src = <span style="color:#a50">&#39;https://www.googleoptimize.com/optimize.js?id=&#39;</span> + optimizeId;
  el.addEventListener(<span style="color:#a50">&#39;error&#39;</span>, <span style="color:#00a">function</span>() {
  dPush(<span style="color:#a50">&#39;optimizeSnippetError&#39;</span>);
    <span style="color:#0aa">window</span>[dataLayerName].hide.end &amp;&amp; <span style="color:#0aa">window</span>[dataLayerName].hide.end();
  });
  <span style="color:#0aa">document</span>.head.appendChild(el);
} <span style="color:#00a">else</span> {
  <span style="color:#0aa">window</span>[dataLayerName].push({
    gtmOptimize: <span style="color:#00a">true</span>
  });
}
</code></pre></div>
<p>If the inline snippet wins the draw, the Optimize element is added to the page together with an <code>error</code> listener that unhides the page in case there&rsquo;s an error loading Optimize (e.g. user is blocking the script load).</p>
<p>If Optimize is loaded via Google Tag Manager, then the key <code>gtmOptimize</code> is pushed to <code>dataLayer</code> with the value <code>true</code>. This is then later used as a trigger condition for the Optimize tag.</p>
<p>As soon as the Optimize or Google Tag Manager container loads, or the anti-flicker snippet runs into its timeout, or there&rsquo;s an error in loading Optimize, a <code>dataLayer.push()</code> happens with the following content:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  event: <span style="color:#a50">&#39;optimize_anti_flicker_test&#39;</span>,
  milestones: {
    antiFlickerStart: <span style="color:#0aa">window</span>[dataLayerName].hide.start,
    antiFlickerEnd: <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime(),
    testStatus: status
  }
}
</code></pre></div>
<p>Here, <code>status</code> is one of <code>gtmTag</code> (if Optimize loaded via Google Tag Manager), <code>optimizeSnippet</code> (if loaded via Optimize), <code>timeout</code> (if the timeout is reached), or <code>optimizeSnippetError</code> (if the Optimize snippet ran into an error).</p>
<blockquote>
<p>One thing to note is that this setup does <strong>not</strong> test if Google Tag Manager is blocked. This is something you might want to test for as well, if you want to get an even more comprehensive idea of what&rsquo;s going on with your experiment implementations.</p>
</blockquote>

                
                  <h2 id="google-tag-manager-setup">Google Tag Manager setup</h2>
<p>In Google Tag Manager, we&rsquo;ll need to create an <strong>App + Web tag</strong> (because we want to do the analysis in <a href="https://www.simoahava.com/analytics/enable-bigquery-export-google-analytics-app-web/">BigQuery</a> again). We&rsquo;ll also need a <strong>Custom Event trigger</strong> and some <strong>Data Layer variables</strong>.</p>
<h3 id="the-trigger">The trigger</h3>
<p>This is what the Custom Event trigger looks like.</p>



<div style="aspect-ratio: 1844 / 934;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-test-trigger.jpg" title="Custom event trigger">
  
    <img class="fig-img" height="934" width="1844" loading="lazy" src="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-test-trigger.jpg#ZgotmplZ" alt="Custom event trigger">
  
    </a>
  
  
</div>


<p>This trigger will fire whenever the <code>dataLayer.push()</code> with the snippet test data is executed on the page. There&rsquo;s also a condition to only fire this tag on the homepage, <strong>which you can and should modify/remove if you&rsquo;re running experiments elsewhere as well!</strong>.</p>
<h3 id="the-variables">The variables</h3>
<p>You&rsquo;re going to need <strong>four</strong> <code>dataLayer</code> variables.</p>
<table>
<thead>
<tr>
<th>Variable name</th>
<th>Value of the &ldquo;Data Layer Variable Name&rdquo; field</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>DLV - milestones.testStatus</td>
<td><code>milestones.testStatus</code></td>
<td>One of <code>gtmTag</code>, <code>optimizeSnippet</code>, <code>timeout</code>, or <code>optimizeSnippetError</code>.</td>
</tr>
<tr>
<td>DLV - milestones.antiFlickerStart</td>
<td><code>milestones.antiFlickerStart</code></td>
<td>Timestamp of when page hiding began.</td>
</tr>
<tr>
<td>DLV - milestones.antiFlickerEnd</td>
<td><code>milestones.antiFlickerEnd</code></td>
<td>Timestamp of when page hiding ended.</td>
</tr>
<tr>
<td>DLV - gtmOptimize</td>
<td><code>gtmOptimize</code></td>
<td>Is <code>true</code> if Optimize should be loaded in a GTM tag.</td>
</tr>
</tbody>
</table>
<p>This is what a variable would look like, per the specification in the table above:</p>



<div style="aspect-ratio: 1764 / 1072;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/dlv-antiflickerend.jpg" title="Data Layer Variable">
  
    <img class="fig-img" height="1072" width="1764" loading="lazy" src="https://www.simoahava.com/images/2020/05/dlv-antiflickerend.jpg#ZgotmplZ" alt="Data Layer Variable">
  
    </a>
  
  
</div>


<h3 id="the-tags">The tags</h3>
<p>First, you&rsquo;ll need to create the <strong>App + Web Event tag</strong>. Make sure you have a <a href="https://www.simoahava.com/analytics/getting-started-with-google-analytics-app-web/#create-a-base-configuration-tag">base tag</a> as well!</p>



<div style="aspect-ratio: 1842 / 1962;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/app-web-anti-flicker-tag.jpg" title="App&#43;Web Anti-flicker event tag">
  
    <img class="fig-img" height="1962" width="1842" loading="lazy" src="https://www.simoahava.com/images/2020/05/app-web-anti-flicker-tag.jpg#ZgotmplZ" alt="App&#43;Web Anti-flicker event tag">
  
    </a>
  
  
</div>


<p>The tag is set to trigger with the Custom Event trigger we created <a href="#the-trigger">above</a>, and it sends the values of the three <code>milestones</code> variables to App + Web as custom parameters. Feel free to change the keys and event names as you wish.</p>
<p>Next, we need to fire the Google Optimize tag <strong>conditionally</strong>, depending on if the <code>gtmOptimize</code> key is in <code>dataLayer</code> with the value <code>true</code>.</p>
<p>Since Optimize needs to run in a <a href="https://www.simoahava.com/analytics/understanding-tag-sequencing-in-google-tag-manager/">tag sequence</a>, this is actually pretty convoluted to do. In addition to the Google Optimize tag itself, you need a new <strong>Universal Analytics Page View</strong> tag which only fires when <code>gtmOptimize</code> is <code>true</code>, and you need to block your <strong>regular Page View tag</strong> in this circumstance as well.</p>



<div style="aspect-ratio: 1852 / 1440;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/optimize-tag-anti-flicker.jpg" title="Optimize tag">
  
    <img class="fig-img" height="1440" width="1852" loading="lazy" src="https://www.simoahava.com/images/2020/05/optimize-tag-anti-flicker.jpg#ZgotmplZ" alt="Optimize tag">
  
    </a>
  
  
</div>


<p>Don&rsquo;t worry about the Tag Sequencing setting, you set it up in the new Page View tag that you&rsquo;ll also need to create:</p>



<div style="aspect-ratio: 2562 / 1388;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/optimize-pageview-tag.jpg" title="New Page View tag">
  
    <img class="fig-img" height="1388" width="2562" loading="lazy" src="https://www.simoahava.com/images/2020/05/optimize-pageview-tag.jpg#ZgotmplZ" alt="New Page View tag">
  
    </a>
  
  
</div>


<p>Take note of the new trigger: &ldquo;All Pages - Anti-flicker&rdquo; is a <strong>Page View</strong> trigger with a single condition: <code>{{DLV - gtmOptimize}} equals true</code>.</p>
<p>Finally, make sure you <strong>block</strong> your <em>regular</em> Page View tag to avoid double-counting on pages where the Optimize-specific Page View already fired:</p>



<div style="aspect-ratio: 1866 / 596;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/pv-blocked.jpg" title="Page View trigger">
  
    <img class="fig-img" height="596" width="1866" loading="lazy" src="https://www.simoahava.com/images/2020/05/pv-blocked.jpg#ZgotmplZ" alt="Page View trigger">
  
    </a>
  
  
</div>


<p>The blocking trigger is a Custom Event trigger that blocks any event if <code>gtmOptimize</code> is <code>true</code>:</p>



<div style="aspect-ratio: 1848 / 932;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/block-if-optimize.jpg" title="Block if Optimize">
  
    <img class="fig-img" height="932" width="1848" loading="lazy" src="https://www.simoahava.com/images/2020/05/block-if-optimize.jpg#ZgotmplZ" alt="Block if Optimize">
  
    </a>
  
  
</div>



                
                  <h2 id="test-the-setup">Test the setup</h2>
<p>Once you&rsquo;ve set everything up, try loading the page with the page template modification in Preview mode. Make sure you see a request to App + Web with your custom parameters in place.</p>



<div style="aspect-ratio: 3030 / 1152;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/app-web-hit-works.jpg" title="App&#43;Web hit works">
  
    <img class="fig-img" height="1152" width="3030" loading="lazy" src="https://www.simoahava.com/images/2020/05/app-web-hit-works.jpg#ZgotmplZ" alt="App&#43;Web hit works">
  
    </a>
  
  
</div>


<p>If it doesn&rsquo;t work, check the browser console for errors. Also, make sure that the Optimize container actually loads, and that you have an experiment running on the page where you are testing!</p>

                
                  <h2 id="dig-deep-with-bigquery">Dig deep with BigQuery</h2>
<p>Once the data starts flowing into BigQuery, you should find your events with a query like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#00a">SELECT</span>
  *
<span style="color:#00a">FROM</span> 
  `project.dataset.events_202006*`
<span style="color:#00a">WHERE</span>
  event_name = <span style="color:#a50">&#39;optimize_anti_flicker_snippet_test&#39;</span></code></pre></div>
<p>We&rsquo;re simply loading all the hits with the <code>optimize_anti_flicker_snippet_test</code> data to get an overview of what those hits look like.</p>



<div style="aspect-ratio: 3248 / 1370;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/sql-anti-flicker-events.jpg" title="Anti-flicker events">
  
    <img class="fig-img" height="1370" width="3248" loading="lazy" src="https://www.simoahava.com/images/2020/05/sql-anti-flicker-events.jpg#ZgotmplZ" alt="Anti-flicker events">
  
    </a>
  
  
</div>


<p>To get a count of different test types, you can run a query like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#00a">SELECT</span>
  (<span style="color:#00a">SELECT</span> value.string_value <span style="color:#00a">FROM</span> <span style="color:#00a">UNNEST</span>(event_params) <span style="color:#00a">WHERE</span> <span style="color:#00a">key</span> = <span style="color:#a50">&#39;test_status&#39;</span>) <span style="color:#00a">as</span> test_status,
  <span style="color:#00a">COUNT</span>(*) <span style="color:#00a">as</span> <span style="color:#00a">count</span>
<span style="color:#00a">FROM</span>
  `project.dataset.events_202006*`
<span style="color:#00a">WHERE</span>
  event_name = <span style="color:#a50">&#39;optimize_anti_flicker_snippet_test&#39;</span>
<span style="color:#00a">GROUP</span> <span style="color:#00a">BY</span> <span style="color:#099">1</span>
<span style="color:#00a">ORDER</span> <span style="color:#00a">BY</span> <span style="color:#099">2</span> <span style="color:#00a">DESC</span></code></pre></div>
<p>This query pulls in the value of <code>test_status</code> from the events, and does an aggregate count of each status. This is what the end result would look like:</p>



<div style="aspect-ratio: 1166 / 586;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/test-status-counts.jpg" title="Test status counts">
  
    <img class="fig-img" height="586" width="1166" loading="lazy" src="https://www.simoahava.com/images/2020/05/test-status-counts.jpg#ZgotmplZ" alt="Test status counts">
  
    </a>
  
  
</div>


<p>Finally, to get some averages in place, you can modify the query to look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">WITH</span> milestones <span style="color:#00a">AS</span> (
  <span style="color:#00a">SELECT</span> 
    (<span style="color:#00a">SELECT</span> value.string_value <span style="color:#00a">FROM</span> <span style="color:#00a">UNNEST</span>(event_params) <span style="color:#00a">WHERE</span> <span style="color:#00a">key</span> = <span style="color:#a50">&#39;test_status&#39;</span>) <span style="color:#00a">as</span> test_status,
    (<span style="color:#00a">SELECT</span> value.int_value <span style="color:#00a">FROM</span> <span style="color:#00a">UNNEST</span>(event_params) <span style="color:#00a">WHERE</span> <span style="color:#00a">key</span> = <span style="color:#a50">&#39;anti_flicker_start&#39;</span>) <span style="color:#00a">as</span> anti_flicker_start,
    (<span style="color:#00a">SELECT</span> value.int_value <span style="color:#00a">FROM</span> <span style="color:#00a">UNNEST</span>(event_params) <span style="color:#00a">WHERE</span> <span style="color:#00a">key</span> = <span style="color:#a50">&#39;anti_flicker_end&#39;</span>) <span style="color:#00a">as</span> anti_flicker_end
  <span style="color:#00a">FROM</span> 
    `project.dataset.events_202006*`
  <span style="color:#00a">WHERE</span>
    event_name = <span style="color:#a50">&#39;optimize_anti_flicker_snippet_test&#39;</span>
)
<span style="color:#00a">SELECT</span> 
  test_status,
  <span style="color:#00a">COUNT</span>(*) <span style="color:#00a">as</span> <span style="color:#00a">count</span>,
  ROUND(<span style="color:#00a">AVG</span>(anti_flicker_end - anti_flicker_start), <span style="color:#099">2</span>) <span style="color:#00a">as</span> average_delay_in_ms,
<span style="color:#00a">FROM</span> 
  milestones
<span style="color:#00a">WHERE</span> anti_flicker_end - anti_flicker_start &lt; <span style="color:#099">5000</span>
<span style="color:#00a">GROUP</span> <span style="color:#00a">BY</span> <span style="color:#099">1</span>
<span style="color:#00a">ORDER</span> <span style="color:#00a">BY</span> <span style="color:#099">3</span> <span style="color:#00a">DESC</span></code></pre></div>
<p>The <code>WITH...AS</code> block creates a source table with just the test status and the flicker start and end times in place. We can then query this common table expression (CTE) to get our counts and averages properly.</p>
<p>As you can see, I have a <code>WHERE</code> clause in place where I make sure the delta is no more than 5000 milliseconds. This is because sometimes the experiment resulted in abnormally high deltas, probably due to the Optimize container being <em>extremely</em> slow to load, and thus producing the end time much later than the timeout.</p>
<p>With the <code>WHERE</code> clause, we ignore such abnormal deltas. We can do that because we are only interested in how long the page was <em>hidden</em>, and if the page is hidden more than 4 seconds (and change), it&rsquo;s automatically revealed by the anti-flicker snippet itself.</p>
<p>Anyway, this query produces the following result for my dataset:</p>



<div style="aspect-ratio: 1018 / 506;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg" title="Anti-flicker snippet test">
  
    <img class="fig-img" height="506" width="1018" loading="lazy" src="https://www.simoahava.com/images/2020/05/optimize-anti-flicker-snippet-test.jpg#ZgotmplZ" alt="Anti-flicker snippet test">
  
    </a>
  
  
</div>


<p>The average time for the page to be hidden if the snippet runs into its timeout is 3.8 seconds. That&rsquo;s kinda weird as the timeout shouldn&rsquo;t happen before <code>4000</code> milliseconds have passed. I&rsquo;d dig deeper into it, but I can also just assume that all <code>timeout</code> occurrences were hidden the full 4 seconds nevertheless.</p>
<p>When Optimize is loaded using a Google Tag Manager tag, the page is hidden for an average of 964 milliseconds. When loaded with the asynchronous inline snippet, it&rsquo;s hidden for 581 milliseconds by average.</p>

                
                  <h2 id="summary">Summary</h2>
<p>It&rsquo;s a fairly convoluted setup, but the purpose isn&rsquo;t to do this for every single one of your experiments. It&rsquo;s to satisfy your curiosity about whether or not the anti-flicker snippet is degrading user experience or not, and this gives you just <em>one</em> variable to work with (average delay of page unhiding).</p>
<p>It&rsquo;s not without its flaws - the timer starts when the anti-flicker snippet is executed at the top of <code>&lt;head&gt;</code>, when realistically it should only start when the page <em>would normally</em> produce the <strong>first visible element</strong> (<a href="https://gtmetrix.com/blog/first-contentful-paint-explained/">First Contentful Paint</a>).</p>
<p>The analysis is also detached - just knowing the delay isn&rsquo;t that interesting. What would make it more significant is to see if the length of the anti-flicker effect had an impact on how the user interacts with the site. It&rsquo;s possible a lengthy delay in painting the page could result in the user bouncing back to the previous page, as they might assume the page does not work.</p>
<p>Just to belabor the point: this article showed you a methodology you could potentially employ to measure the effect of flicker mitigation efforts in client-side A/B-testing. The flicker <strong>is</strong> a problem, and knowing just how <em>much</em> of a problem is the first step in solving it.</p>
<p>Let me know in the comments if you have suggestions for improving the experiment!</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-optimize/">google optimize</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/app&#43;web/">app&#43;web</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/bigquery/">bigquery</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/google-cloud/cookie-audit-with-google-bigquery/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/simple-way-measure-a-b-test-flicker-impact/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Optimize%20Anti-flicker%20Snippet%20Delay%20Test%20https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/google-cloud/cookie-audit-with-google-bigquery/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/simple-way-measure-a-b-test-flicker-impact/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Optimize%20Anti-flicker%20Snippet%20Delay%20Test%20https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Google%20Optimize%20Anti-flicker%20Snippet%20Delay%20Test%20https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/optimize-anti-flicker-snippet-delay-test/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

