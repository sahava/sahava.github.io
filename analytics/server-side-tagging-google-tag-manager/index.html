

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Server-side Tagging In Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/07\/server-side-tagging-google-tag-manager.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/server-side-tagging-google-tag-manager\/",
  "datePublished": "2020-08-12T07:00:00\u002b03:00",
  "dateModified": "2020-08-12T07:00:00\u002b03:00",
  "description": "An introduction to Server-side tagging in Google Tag Manager. The article contains examples and walkthroughs for getting started with the new Server container.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Server-side Tagging In Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/server-side-tagging-google-tag-manager/">
    
    <meta name="description" content="An introduction to Server-side tagging in Google Tag Manager. The article contains examples and walkthroughs for getting started with the new Server container.">
    <meta property="og:description" content="An introduction to Server-side tagging in Google Tag Manager. The article contains examples and walkthroughs for getting started with the new Server container.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Server-side Tagging In Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Server-side Tagging In Google Tag Manager">
    <meta name="twitter:description" content="An introduction to Server-side tagging in Google Tag Manager. The article contains examples and walkthroughs for getting started with the new Server container.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/07/server-side-tagging-google-tag-manager.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/07/server-side-tagging-google-tag-manager.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Server-side Tagging In Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-08-12T07:00:00&#43;03:00">
        
  August 12, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/#commento">Comments</a>
      
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>Ever since <strong>Server-side tagging</strong> was <a href="https://twitter.com/SimoAhava/status/1222459714614841346?s=20">publicly announced</a> at <a href="https://superweek.hu/">SUPERWEEK 2020</a>, Google and the trusted tester community have been hard at work, building something that just might change the landscape of digital analytics for good.</p>
<p><a href="https://tagmanager.google.com/">Google Tag Manager</a> has now released Server-side tagging into <strong>public beta</strong>. In this lengthy article, we&rsquo;ll take a look at what Server-side tagging is, how it should (and should not) be used, and what its implications are on the broader digital analytics community.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/server-side-tagging-google-tag-manager.jpg" title="Server-side tagging">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/server-side-tagging-google-tag-manager.jpg#ZgotmplZ" alt="Server-side tagging" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2764 1390'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In short, <strong>Server-side tagging</strong> means running a <strong>Google Tag Manager container</strong> in a server-side environment (at the time of writing, the only available environment is the <a href="https://cloud.google.com/">Google Cloud Platform</a>, though I&rsquo;m certain more options will become available in good time).</p>
<p>Many of the <a href="#key-benefits">benefits</a> and <a href="#key-concerns">concerns</a> are tackled in their respective chapters. Even so, I want to emphasize that Server-side tagging has the potential to overturn the current dynamic of data collection and governance for an organization. You <a href="#full-control-and-ownership-of-the-data-collected-by-the-container"><strong>own</strong> and have <strong>full control</strong></a> over the server-side environment. You have access to <strong>tools</strong> and <strong>methods</strong> to thoroughly <a href="#clean-up-and-validate-payloads">vet and validate the traffic</a> between network sources and your advertising and analytics endpoints.</p>
<p>You can run a fully functional digital analytics and marketing setup without loading <em>any</em> third-party code in the user&rsquo;s browser or device. With appropriate monitoring in place, you can say <a href="#more-control-over-http-traffic">goodbye to PII and credential leaks</a>, cross-site tracking traps, and bloated third-party JavaScript <a href="#reduced-client-load">encumbering the client</a>.</p>
<p>Server-side tagging utilizes many of the concepts familiar to Google Tag Manager users:</p>
<ul>
<li>
<p>There are <strong>tags</strong> which fire on <strong>triggers</strong> and pull in data from <strong>variables</strong>.</p>
</li>
<li>
<p>New container <strong>versions</strong> can be <strong>previewed</strong> and <strong>published</strong>.</p>
</li>
<li>
<p>Users can create their own <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/"><strong>custom templates</strong></a>.</p>
</li>
</ul>
<p>However, there are new, fundamentally different features that introduce something of a <strong>paradigm shift</strong> to the type of dynamic tagging that Google Tag Manager promotes.</p>
<ul>
<li>
<p>The container itself is a new <a href="#server-container"><strong>Server</strong></a> type; different from the web, app, and AMP containers that precede it.</p>
</li>
<li>
<p>Instead of trigger events, processes are initialized by <strong>incoming HTTP requests</strong>.</p>
</li>
<li>
<p>These requests are digested by a new type of GTM entity: <strong>a <a href="#clients-and-tags">Client</a></strong>.</p>
</li>
<li>
<p>The Client parses the requests, generates an <strong>event data object</strong>, and feeds this into a <strong>virtual container</strong>, where tags can use this event object to map and send data to their endpoints.</p>
</li>
</ul>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/preview-example.jpg" title="Example from preview mode">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/preview-example.jpg#ZgotmplZ" alt="Example from preview mode" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1948 866'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This article <strong>will not be</strong> an exhaustive guide. I will walk you through the main concepts of Server-side tagging and there should be little you&rsquo;ll be left wanting, but to complement this article, I do recommend you consult Google&rsquo;s <a href="https://developers.google.com/tag-manager/serverside">own, official documentation</a>.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[â€“hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#how-to-follow-this-guide">How to follow this guide</a>
      <ul>
        <li><a href="#video-introduction-to-server-side-tagging">Video: Introduction to Server-side tagging</a></li>
        <li><a href="#video-create-a-client-template-in-a-server-container">Video: Create a Client template in a Server container</a></li>
      </ul>
    </li>
    <li><a href="#what-is-server-side-tagging">What is Server-side tagging?</a></li>
    <li><a href="#key-benefits">Key benefits</a>
      <ul>
        <li><a href="#reduced-client-load">Reduced client load</a></li>
        <li><a href="#keep-keys-and-secrets-safe">Keep keys and secrets safe</a></li>
        <li><a href="#more-control-over-what-endpoints-collect">More control over what endpoints collect</a></li>
        <li><a href="#more-control-over-http-traffic">More control over HTTP traffic</a></li>
        <li><a href="#content-security-policy">Content Security Policy</a></li>
        <li><a href="#clean-up-and-validate-payloads">Clean up and validate payloads</a></li>
        <li><a href="#full-control-and-ownership-of-the-data-collected-by-the-container">Full control and ownership of the data collected by the container</a></li>
        <li><a href="#limitless-possibilities">Limitless possibilities</a></li>
      </ul>
    </li>
    <li><a href="#key-concerns">Key concerns</a>
      <ul>
        <li><a href="#circumvent-content-blocking">Circumvent content blocking</a></li>
        <li><a href="#opaque-data-collection">Opaque data collection</a></li>
        <li><a href="#consent-management-is-up-to-the-admin">Consent management is up to the admin</a></li>
        <li><a href="#cost">Cost</a></li>
        <li><a href="#poor-availability-of-server-side-endpoints">Poor availability of server-side endpoints</a></li>
      </ul>
    </li>
    <li><a href="#technical-outline">Technical outline</a>
      <ul>
        <li><a href="#cost-1">Cost</a></li>
        <li><a href="#server-container">Server container</a>
          <ul>
            <li><a href="#tags">Tags</a></li>
            <li><a href="#triggers">Triggers</a></li>
            <li><a href="#variables">Variables</a></li>
          </ul>
        </li>
        <li><a href="#custom-domain">Custom domain</a></li>
        <li><a href="#requests-and-responses">Requests and responses</a></li>
        <li><a href="#clients-and-tags">Clients and tags</a></li>
        <li><a href="#event-model">Event model</a></li>
        <li><a href="#custom-templates">Custom templates</a></li>
        <li><a href="#preview-and-debug">Preview and debug</a>
          <ul>
            <li><a href="#request-tab">Request tab</a></li>
            <li><a href="#tags-tab">Tags tab</a></li>
            <li><a href="#variables-tab">Variables tab</a></li>
            <li><a href="#event-data-tab">Event Data tab</a></li>
            <li><a href="#errors-tab">Errors tab</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="how-to-follow-this-guide">How to follow this guide</h2>
<p>While I hope everyone would devour every last word of this article, I&rsquo;m aware that not all sections are relevant to all readers.</p>
<p>If you&rsquo;re looking for an overview of Server-side tagging, perhaps for getting buy-in within your organization, I recommend reading these chapters:</p>
<ul>
<li><a href="#what-is-server-side-tagging">What is Server-side tagging</a></li>
<li><a href="#reduced-client-load">Key benefits - Reduced client load</a></li>
<li><a href="#content-security-policy">Key benefits - Content Security Policy</a></li>
<li><a href="#full-control-and-ownership-of-the-data-collected-by-the-container">Key benefits - Full control and ownership of the data collected by the container</a></li>
<li><a href="#key-concerns">Key concerns - All chapters</a></li>
<li><a href="#cost-1">Technical outline - Cost</a></li>
<li><a href="#custom-domain">Technical outline - Custom domain</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<p>If you&rsquo;re a developer or working in IT, I&rsquo;d recommend focusing on these chapters:</p>
<ul>
<li><a href="#what-is-server-side-tagging">What is Server-side tagging</a></li>
<li><a href="#reduced-client-load">Key benefits - Reduced client load</a></li>
<li><a href="#keep-keys-and-secrets-safe">Key benefits - Keep keys and secrets safe</a></li>
<li><a href="#more-control-over-what-endpoints-collect">Key benefits - More control over what endpoints collect</a></li>
<li><a href="#content-security-policy">Key benefits - Content Security Policy</a></li>
<li><a href="#key-concerns">Key concerns - All chapters</a></li>
<li><a href="#server-container">Technical outline - Server container</a></li>
<li><a href="#custom-domain">Technical outline - Custom domain</a></li>
<li><a href="#clients-and-tags">Technical outline - Clients and tags</a></li>
<li><a href="#custom-templates">Technical outline - Custom templates</a></li>
<li><a href="#resources">Technical outline - Resources</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<p>Everything else is still important, but I&rsquo;ll forgive you if you gloss over them initially, only to return to them hungrily once you&rsquo;re hooked into all the awesomeness that Server-side tagging brings in its wake.</p>
<p>I recommend you watch the following two videos regardless.</p>
<p>The first one is a general introduction to <strong>Server-side tagging</strong>, focusing on deployment and getting started with your first Client and tag.</p>
<p>The second is a deep-dive into building your own Client template. It&rsquo;s a bit more specialized and can thus be skipped if you&rsquo;re not interested in customizing the container.</p>
<h3 id="video-introduction-to-server-side-tagging">Video: Introduction to Server-side tagging</h3>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/6OGbOh216mU?enablejsapi=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>If the video doesn&rsquo;t work, you can watch it <a href="https://youtu.be/6OGbOh216mU">here</a>.</p>
<h3 id="video-create-a-client-template-in-a-server-container">Video: Create a Client template in a Server container</h3>
<blockquote>
<p><strong>NOTE!</strong> The video below has one important omission. When creating the <strong>Client</strong> template, make sure to update the &ldquo;Sends HTTP Requests&rdquo; permission to include &ldquo;Allow Google Domains&rdquo;. Otherwise the proxying of analytics.js doesn&rsquo;t work.</p>
</blockquote>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/_c4JEfSkP6U?enablejsapi=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>If the video doesn&rsquo;t work, you can watch it <a href="https://youtu.be/_c4JEfSkP6U">here</a>.</p>

                
                  <h2 id="what-is-server-side-tagging">What is Server-side tagging?</h2>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/server-side-tagging-outline.jpg" title="Server-side tagging outline">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/server-side-tagging-outline.jpg#ZgotmplZ" alt="Server-side tagging outline" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2590 1472'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>With Server-side tagging, Google Tag Manager has introduced a new <strong>Server</strong> container type, which resides in a <a href="https://cloud.google.com/">Google Cloud</a> environment.</p>
<p>In a nutshell, the purpose of this setup is to create an endpoint in a server environment that <strong>you own</strong>. It will act as a sort of a <strong>proxy</strong> between the hits sent from browsers and devices and the actual endpoints to which the hits are collected. See the <a href="#key-benefits">next chapter</a> for more details on what this type of proxy can do.</p>
<p>The container itself operates as an HTTP API endpoint, to which any browser, device, or other sources that support the HTTP protocol can send requests.</p>
<p>Ideally, this endpoint would be mapped with a <strong>custom subdomain</strong> in the same domain hierarchy as the website sending the requests. That way the requests are considered to happen in <a href="https://www.cookiestatus.com/introduction/tracking-protection/#first-party-and-third-party-context">first-party context</a>, which has a significant impact on how cookies can be read and written, for example.</p>
<p>Within the Server container, workers known as <strong>Clients</strong> are configured to listen for these incoming HTTP requests, which they then parse into a <strong>unified event format</strong>. The Clients then run a <em>virtual container</em> with the <a href="#event-model">event data object</a>, where tags, triggers, and variables react to the event push similar to how they would with &ldquo;regular&rdquo; Google Tag Manager.</p>
<p>Tags take the information in these event data objects and compile them into HTTP requests to their respective endpoints. Finally, the Client sends an HTTP response back to the source of the initial request.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/ua-response.jpg" title="Example of a Universal Analytics client responding with a success status and setting the _ga cookie in the response.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/ua-response.jpg#ZgotmplZ" alt="Example of a Universal Analytics client responding with a success status and setting the _ga cookie in the response." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2760 738'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Example of a Universal Analytics client responding with a success status and setting the _ga cookie in the response.</span>
  
</div>


<p>All of the above happens within the confines of the Server-side tagging environment. The only way the browser or app sending the data can be made aware of what&rsquo;s going on is if the <strong>Client</strong> adds information into the HTTP response, which is fully configurable.</p>

                
                  <h2 id="key-benefits">Key benefits</h2>
<p>Here are some of the key benefits of using Server-side tagging.</p>
<h3 id="reduced-client-load">Reduced client load</h3>
<p>By running the logic of building and dispatching hits to the vendor endpoint in your server-side environment, you have a golden opportunity to reduce the amount of (especially third-party) JavaScript run in the user&rsquo;s browser.</p>
<p>Because you can configure the Server container to map <em>any</em> incoming HTTP request into the format required by the vendor, you can theoretically reduce your entire third-party pixel and JavaScript load to a single event stream directed into your Server container.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/all-javascript.jpg" title="Imagine if you could reduce the amount of JavaScript loaded and executed in the browser...">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/all-javascript.jpg#ZgotmplZ" alt="Imagine if you could reduce the amount of JavaScript loaded and executed in the browser..." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2014 940'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Imagine if you could reduce the amount of JavaScript loaded and executed in the browser...</span>
  
</div>


<p>This stream can then be intercepted by a Client which proceeds to map the stream into the <a href="#event-model">event model</a> expected by the vendor tags, also running in the Server container.</p>
<p>This is the <strong>ultimate benefit</strong> of a Server-side tagging setup. Even if you don&rsquo;t want to reduce everything to a single stream, you can build your own <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom template</a> in the web container, which builds the HTTP request to the Server container without having to load any third-party JavaScript at all (apart from the GTM library itself).</p>
<!--
Thus you could have a Facebook Pixel (facebook-pixel-server-side.md) template running in the web container which doesn't even load anything from Facebook's servers! All it does is gather [the information required](https://developers.facebook.com/docs/marketing-api/conversions-api) for the Server container to map this HTTP request (facebook-client.md) into Facebook's format.
-->
<h3 id="keep-keys-and-secrets-safe">Keep keys and secrets safe</h3>
<p>By transporting data processing logic away from the device, where it would be visible for anyone with debugging skills, you will also be able to run secured and credential-based transactions without having to worry about exposing sensitive information to the device.</p>
<p>For example, a plague on Google Analytics has been <a href="https://help.analyticsedge.com/article/definitive-guide-to-removing-google-analytics-spam/">Measurement Protocol spam</a>, where malicious parties crawl potential tracking IDs and then proceed to spam them with automated HTTP requests that masquerade as &ldquo;regular&rdquo; hits from the site. Alternatively, these hackers send spam hits to <strong>random tracking IDs</strong>, knowing that if they send enough hits, some of them will end up in real Universal Analytics accounts.</p>
<p>This type of spam is notoriously difficult to identify and prevent because it&rsquo;s built to resemble actual hits that are sent from the website itself.</p>
<p>Now that you have the server endpoint handy, you can add a new <strong>Custom Dimension</strong> within the Server container, which is then sent to Google Analytics. In Google Analytics, you can then create a filter for this Custom Dimension, allowing only traffic that matches it.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">event[<span style="color:#a50">&#39;x-ga-mp1-cd11&#39;</span>] = <span style="color:#a50">&#39;my_secret_key&#39;</span>;
</code></pre></div>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/custom-dimension-set.jpg" title="Secret key custom dimension">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/custom-dimension-set.jpg#ZgotmplZ" alt="Secret key custom dimension" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1676 1124'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>By adding this &ldquo;secret key&rdquo; in the Server container, there&rsquo;s no way that a random Measurement Protocol spammer can know it&rsquo;s there. Similarly, it won&rsquo;t help if the spammer crawls your site, looking at the requests sent to Google Analytics, because there are no such requests! There are only requests to your own server-side endpoint, and it would be odd if Measurement Protocol spammers would utilize those to fuel their spam algorithms.</p>
<p>Naturally, this isn&rsquo;t limited to just what you can do with Universal Analytics. Any third-party servers that identify your access with an <strong>API key</strong> or <strong>credential token</strong> can now be proxied through your Server container so that these keys are not exposed in the device!</p>
<h3 id="more-control-over-what-endpoints-collect">More control over what endpoints collect</h3>
<p>Because your proxy now resides between the user&rsquo;s device and the endpoint, you are in full control over what is shipped to the vendor.</p>
<p>Unless the Client <a href="https://developers.google.com/tag-manager/serverside/api#getremoteaddress">specifically overrides</a> things like the IP address and User-Agent in the outgoing HTTP request from the Server container (this is what the built-in Universal Analytics and App + Web Clients do by default), the IP and User-Agent string will be that of your Server container rather than the user. So this is a great way to concretely anonymize this aspect of the HTTP protocol that&rsquo;s proven to be problematic in terms of end-user privacy.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/override-ip.jpg" title="IP address and User-Agent string overridden in a Google Analytics request.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/override-ip.jpg#ZgotmplZ" alt="IP address and User-Agent string overridden in a Google Analytics request." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1552 436'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">IP address and User-Agent string overridden in a Google Analytics request.</span>
  
</div>


<p>Server-side tagging introduces extra control over privacy simply by existing.</p>
<p>Without manual overrides, the requests sent to the vendors are mapped to the App Engine virtual machine instead of the user&rsquo;s browser or device.</p>
<p>There are no <strong>data leaks</strong> with third-party cookies, there are no surprises with <strong>injected URL parameters</strong>, and the third-party service doesn&rsquo;t have <em>any</em> connection with the user&rsquo;s browser by default. They&rsquo;ll be communicating just with the cloud machine.</p>
<h3 id="more-control-over-http-traffic">More control over HTTP traffic</h3>
<p>To expand the features mentioned above, you will also have full control over what HTTP traffic is passed through the Server container.</p>
<p>Typically, the browser loads the vendor&rsquo;s JavaScript from their <strong>content distribution network</strong> (CDN).</p>
<p>This act already exposes the user&rsquo;s browser or device to the third party and can lead to things like personally identifiable information <strong>(PII) leaks</strong> in case the URL of the page has sensitive information.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/pii-referrer.jpg" title="It&#39;s better to leak this to your data store rather than a vendor&#39;s.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/pii-referrer.jpg#ZgotmplZ" alt="It&#39;s better to leak this to your data store rather than a vendor&#39;s." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1984 92'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">It&#39;s better to leak this to your data store rather than a vendor&#39;s.</span>
  
</div>


<p>Because you now have a proxy between the device and the endpoint, the only place where this information is leaked is into <strong>your</strong> cloud environment.</p>
<p>Sure, it&rsquo;s still not optimal - <strong>PII leaks should be eradicated</strong>.</p>
<p>But you have full control and ownership of all the data collected by the Server container, and you also have all the tools at your disposal to <a href="#clean-up-and-validate-payloads">clean up and validate the payloads</a>.</p>
<p>You can also cover your legal back by removing <strong>fingerprintable</strong> surfaces from the outgoing requests from the Server container. Similarly, you can use the <a href="https://developers.google.com/tag-manager/serverside/api#sha256">APIs available</a> to <strong>hash</strong> potentially sensitive data. You can also, of course, look for <strong>consent strings</strong> in the user&rsquo;s cookies (assuming the Server container is in first-party context with the source of the traffic) and act accordingly.</p>
<p>Finally, in the Client, you can modify the <strong>HTTP response</strong> back from the Server container to the browser or device. This is a pretty cool thing when considering <a href="https://www.cookiestatus.com/safari/">Apple&rsquo;s Intelligent Tracking Prevention</a>, for example. You can convert cookies written with JavaScript, and thus subject to an expiration limit of 7 days, into HTTP cookies written with a <code>Set-Cookie</code> header, thus extending their lifetime to whatever you choose:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> getCookie = require(<span style="color:#a50">&#39;getCookieValues&#39;</span>);
<span style="color:#00a">const</span> setCookie = require(<span style="color:#a50">&#39;setCookie&#39;</span>);

<span style="color:#aaa;font-style:italic">// Get cookie from the HTTP request
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">let</span> ga = getCookie(<span style="color:#a50">&#39;_ga&#39;</span>);

<span style="color:#aaa;font-style:italic">// If no cookie exists, generate a new Client ID
</span><span style="color:#aaa;font-style:italic"></span>ga = ga &amp;&amp; ga.length ? ga[<span style="color:#099">0</span>] : generateClientId();

<span style="color:#aaa;font-style:italic">// Write the _ga cookie in the HTTP response
</span><span style="color:#aaa;font-style:italic"></span>setCookie(<span style="color:#a50">&#39;_ga&#39;</span>, ga, {
  domain: <span style="color:#a50">&#39;auto&#39;</span>,
  <span style="color:#a50">&#39;max-age&#39;</span>: <span style="color:#099">63072000</span>,
  path: <span style="color:#a50">&#39;/&#39;</span>,
  secure: <span style="color:#00a">true</span>,
  sameSite: <span style="color:#a50">&#39;lax&#39;</span>
});
</code></pre></div>
<p><em>Ideally</em>, you&rsquo;ll want to set cookies with the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Security"><code>HttpOnly</code></a> flag. This prevents the web page from accessing the cookie with JavaScript (<code>document.cookie</code>). By allowing cookie access only for the webserver receiving the request, you&rsquo;re introducing a decent redundancy measure for mitigating <strong>cross-site scripting</strong> attacks and preventing cookie values from leaking into <a href="https://www.cookiestatus.com/introduction/tracking-protection/#cross-site-tracking">cross-site tracking</a> schemes.</p>
<p>The reason we&rsquo;re <em>not</em> using <code>HttpOnly</code> in the example above is because <a href="https://support.google.com/analytics/answer/1033876?hl=en">cross-domain linking</a> is something Universal Analytics still does client-side with JavaScript.</p>
<blockquote>
<p>Note! You might want to read <a href="https://www.simoahava.com/analytics/fpid-cookie-google-analytics-server-side-tagging/">this article on FPID</a> to see what Google is working on in terms of improving the security of the Google Analytics cookie.</p>
</blockquote>
<p>In any case, using the <code>Set-Cookie</code> header like this removes the need for <a href="https://www.simoahava.com/google-cloud/create-cookie-rewrite-web-service-google-cloud/">complicated APIs to do the cookie rewriting for you</a>, as you can just piggy-back the cookie rewrite on the data collection itself.</p>
<h3 id="content-security-policy">Content Security Policy</h3>
<p>Another benefit of reducing the number of HTTP endpoints with which the browser communicates concerns your site&rsquo;s <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a> (CSP). A CSP is what your site would use to restrict the HTTP traffic to and from the user&rsquo;s browser.</p>
<p>For example, if you add a JavaScript library that loads its content from Facebook to a site with a CSP, you&rsquo;ll need to petition the developers to relax that CSP so that Facebook&rsquo;s domains would be allowed to send and receive data from the user&rsquo;s browser.</p>
<p>Naturally, the more you relax the CSP, the less efficient it becomes.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/content-security-policy.jpg" title="CSPs tend to get really bloated and thus inefficient at doing what they&#39;re meant to do.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/content-security-policy.jpg#ZgotmplZ" alt="CSPs tend to get really bloated and thus inefficient at doing what they&#39;re meant to do." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4056 232'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">CSPs tend to get really bloated and thus inefficient at doing what they&#39;re meant to do.</span>
  
</div>


<p>By reducing the number of HTTP endpoints the browser needs to communicate with (because you&rsquo;ve replaced them with your own Server-side tagging endpoint), you&rsquo;re making the CSP more robust as a result.</p>
<h3 id="clean-up-and-validate-payloads">Clean up and validate payloads</h3>
<p>Even if you&rsquo;ve managed to clear the HTTP traffic itself of all potentially harmful information, you might still be left with <strong>URL parameters</strong> that the vendor requires you to populate. Sometimes, often even, these parameters contain PII, and you&rsquo;ll want to figure out a way to get rid of it.</p>
<p>I&rsquo;ve written a lot about PII purging, and my <a href="https://www.simoahava.com/analytics/customtask-the-guide/#4-remove-pii-from-ga-payloads">customTask solution</a> should be useful if you&rsquo;re sending data from the browser directly to Google Analytics.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/pii-purger.jpg" title="Clear PII from requests">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/pii-purger.jpg#ZgotmplZ" alt="Clear PII from requests" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1602 214'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>But now with a Server container, you can build a Client which parses <strong>all the request headers</strong> and the body looking for PII (so not just those related to Universal Analytics) and then proceeds to clean it up or obfuscate it.</p>
<p>You can also use the Server container to <strong>validate</strong> and <strong>fix</strong> requests.</p>
<p>For example, if you send a non-numeric value as the <strong>Event Value</strong> of a Universal Analytics request, that event will be <em>collected</em> by Google Analytics but <em>discarded</em> at processing. There&rsquo;s no warning in the browser - these hits just disappear.</p>
<p>You could fix this in a Client by looking specifically for a faulty Event Value and converting it into a number:</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/fix-event-value.jpg" title="Try to convert Event Value into a number, and default to 0 if conversion doesn&#39;t work.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/fix-event-value.jpg#ZgotmplZ" alt="Try to convert Event Value into a number, and default to 0 if conversion doesn&#39;t work." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1334 53'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Try to convert Event Value into a number, and default to 0 if conversion doesn&#39;t work.</span>
  
</div>


<p>You can see how this could dramatically improve your data quality once you start building Clients specifically designed for cleaning up your data streams.</p>
<h3 id="full-control-and-ownership-of-the-data-collected-by-the-container">Full control and ownership of the data collected by the container</h3>
<p>This has already been mentioned earlier in this article, but a significant part of building a server-side environment is <a href="https://developers.google.com/tag-manager/serverside/custom-domain">mapping a subdomain to the endpoint</a>. When the HTTP endpoint is able to respond to requests using a subdomain that&rsquo;s part of the same domain hierarchy as the website sending the requests, the website and the HTTP endpoint exist in <strong>same-site</strong> or <strong>first-party</strong> context. This has a significant impact on how <a href="https://www.cookiestatus.com/">browser tracking protections</a> treat the traffic.</p>
<blockquote>
<p>The custom domain <strong>should</strong> be mapped using A/AAAA DNS records rather than a CNAME alias. The latter is a less useful solution for cookie permanence due to <a href="https://bugs.webkit.org/show_bug.cgi?id=215201">browser tracking protections</a>.</p>
</blockquote>
<p>Other than the question of domain context, a very important aspect of ownership is what&rsquo;s promised by the platform you subscribe to (<a href="https://cloud.google.com">Google Cloud Platform</a> at the time of release).</p>
<p>You have <strong>full control</strong> and <strong>ownership</strong> of the data in your Google Cloud project. Yes - you need to trust Google on this promise. Here&rsquo;s what they guarantee in the <a href="https://cloud.google.com/security/privacy">relevant documentation</a>:</p>
<ul>
<li>
<p>Google Cloud only processes data that you instruct it to process.</p>
</li>
<li>
<p>You own your data. No data is processed by Google Cloud for advertising purposes.</p>
</li>
<li>
<p>You&rsquo;ll always be aware of where your data is regionally located.</p>
</li>
<li>
<p>Your data is secured by independently certified and audited security standards.</p>
</li>
</ul>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/google-cloud-privacy.jpg" title="Privacy Google Cloud">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/google-cloud-privacy.jpg#ZgotmplZ" alt="Privacy Google Cloud" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1984 1140'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This is pretty significant. Since you own and control the data collected by the Server container, its usage and data processing falls under the privacy policies, T&amp;Cs, and contracts your organization has with its customers and end-users.</p>
<p>If a data leak were to happen, for example, the first place it would &ldquo;leak&rdquo; to would be a data store that you own, and you can mitigate the fallout by making sure these leaks do not extend to the third parties to which you send the data from the Server container.</p>
<p>Naturally, as soon as your Server container <em>does</em> fire tags that send the data to third parties, you introduce additional data processors and controllers to the mix, but having the &ldquo;buffer&rdquo; of a data store and processor that you own in between should help a great deal in mitigating security/privacy risks and liabilities.</p>
<h3 id="limitless-possibilities">Limitless possibilities</h3>
<p>By shifting the processing of data to your Server-side endpoint you introduce a fairly inexpensive, scalable, and multi-functional proxy for processing data before it is wrapped up and sent to the vendors.</p>
<p>In addition to the benefits listed above, there are <strong>so many</strong> things you could do with a server-side setup like this:</p>
<ul>
<li>
<p>Only collect the bare essentials from the browser: content ID for content, session ID for session, and user ID for user. In the Server container, use other APIs and services at your disposal to enrich the data using these IDs as the keys.</p>
</li>
<li>
<p>Run expensive code in the scalable environment of the server rather than as a burden on the user&rsquo;s device. Things like IP lookups and cryptographic hashing could just as well be done in the Server container.</p>
</li>
<li>
<p>Maybe at some point we&rsquo;ll see native integrations to <strong>other</strong> Google Cloud products.</p>
<ul>
<li>
<p>Imagine being able to write directly to <a href="https://cloud.google.com/bigquery">Google BigQuery</a> from the Server container without having to worry about complicated authentication.</p>
</li>
<li>
<p>Imagine triggering <a href="https://cloud.google.com/functions">Cloud Functions</a> by using Pub/Sub rather than HTTP requests.</p>
</li>
<li>
<p>Imagine utilizing <a href="https://cloud.google.com/logging">Cloud logging</a> to build a real-time monitoring system for the integrity of your data pipeline.</p>
</li>
</ul>
</li>
</ul>
<p>Once the platform matures and once the library of available APIs and custom templates is extended, the reach of Server-side tagging is only limited by the imagination of its users.</p>

                
                  <h2 id="key-concerns">Key concerns</h2>
<p>Moving tracking away from the device to behind the veil of the server doesn&rsquo;t come without its concerns.</p>
<p>The paradigm shift that we can envision with GTM&rsquo;s Server-side tagging isn&rsquo;t just one of <em>improving</em> data collection; it&rsquo;s also one of <em>obfuscating</em> it.</p>
<h3 id="circumvent-content-blocking">Circumvent content blocking</h3>
<p>One of the first knee-jerk reactions many probably have to Server-side tagging has to do with <strong>content blocking</strong> and <a href="https://www.cookiestatus.com/"><strong>browser tracking protections</strong></a> in general.</p>
<p>A typical approach for privacy-friendly browsers is to restrict or downright block communications between the browser and <strong>known trackers</strong>. The list of <em>known trackers</em> is usually based on a blocklist such as <a href="https://disconnect.me/">Disconnect.Me</a>, but it could also be algorithmic and on-device, such as with <a href="https://www.cookiestatus.com/safari/">Intelligent Tracking Prevention</a>.</p>
<p>Indeed, an endpoint like <code>google-analytics.com</code> could well be targeted by the heuristics used in content blockers, but <code>my-server-side.domain.com</code> probably isn&rsquo;t.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/content-blocking.jpg" title="Direct hit to GA is blocked, but hit proxied via the Server container isn&#39;t.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/content-blocking.jpg#ZgotmplZ" alt="Direct hit to GA is blocked, but hit proxied via the Server container isn&#39;t." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4142 360'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Direct hit to GA is blocked, but hit proxied via the Server container isn&#39;t.</span>
  
</div>


<p>Can you use Server-side tagging to <strong>circumvent content blockers</strong>? Absolutely. Should you? Definitely not; at least if that&rsquo;s your primary reason.</p>
<p>However, this does raise an interesting paradox.</p>
<p><strong>It&rsquo;s not your fault that content blockers do not target your domains</strong>.</p>
<p>You are not obliged to exhaustively test if all the actual endpoints are blocked by the browser. That would be a huge waste of resources and counter-productive to what Server-side tagging first and foremost does: reduce client load.</p>
<p>Once server-side proxies become the norm (with a popular tool like Google Tag Manager likely to spearhead the transition), content blockers will adapt their heuristics to not just look at domains but also the information that is being sent.</p>
<p>The right course of action is to be <strong>transparent</strong> at what data is being collected on your site, placing behind <strong>consent</strong> that which is required by law, and giving <strong>opt-out mechanisms</strong> for the rest.</p>
<p>And if it just so happens that your endpoint gets blocked by content blockers or its URL string is stripped of all useful information, <strong>don&rsquo;t try to &ldquo;fix&rdquo; this</strong>.</p>
<p><strong>Always err on the side of maximum privacy.</strong></p>
<p>Always <em>assume</em> that the user knows exactly what they are doing when they <em>choose</em> to block your data collection. Don&rsquo;t defy their wishes.</p>
<h3 id="opaque-data-collection">Opaque data collection</h3>
<p>When there&rsquo;s a data leak or a security breach in a company, the party uncovering this is often not related to the company at all.</p>
<p>The web is full of companies and individuals who exhaustively audit the HTTP traffic in and out of websites, and their work has been instrumental in uncovering things like <a href="https://www.csoonline.com/article/3400381/what-is-magecart-how-this-hacker-group-steals-payment-card-data.html">Magecart attacks</a> and <a href="https://medium.com/@thezedwards/july-2020-compromised-paf-subdomains-mostly-via-microsoft-azure-5834ae22733a">domain takeovers</a>.</p>
<p>Cookie leaks, cross-site scripting injections, CSP workarounds, and all manner of nasty JavaScript hacks can typically be audited directly in the browser, because the vendor scripts are running right there under the watchful eyes of the auditors.</p>
<p>When you move to Server-side tagging, you are reducing the amount of third-party JavaScript running on the site, <em>which is good</em>. It&rsquo;s a great step to mitigating the issues listed above.</p>
<p>However, you are also removing all traces of what is actually done with the data bundled in the requests. Auditors will have a hard time deciphering just what the event stream to your endpoint actually does, and whether you are compromising the user&rsquo;s right to privacy and security behind the veil of the server, where client-side tools can&rsquo;t reach it.</p>
<p>This means that you <strong>must document carefully</strong> what type of data is being collected and processed on your site. You are already obliged to do so under legal frameworks like GDPR and CCPA/CPRAA, which require you to be upfront and transparent about data collection, storage, and processing.</p>
<p><strong>Always err on the side of maximum privacy.</strong></p>
<p>You should take preemptive and proactive measures to do transparency and compliance <strong>right</strong> in order to avoid litigation and potential brand damage when you get caught in the act.</p>
<h3 id="consent-management-is-up-to-the-admin">Consent management is up to the admin</h3>
<p>This isn&rsquo;t <em>that</em> far removed from what the situation is currently with client-side scripts, but it&rsquo;s still something you need to consider.</p>
<p><strong>Consent management</strong> is a hot topic, and rightfully so. Many sites implement client-side consent management tools, which require opt-in input from the user with regard to what data they allow to be collected from them.</p>
<p>Typically the consent string is stored in a cookie or <code>localStorage</code> entry, and many vendors can actually proactively react to consent frameworks such as IAB&rsquo;s <a href="https://iabeurope.eu/tcf-2-0/">Transparency &amp; Consent Framework 2.0</a>.</p>
<p>When you move to Server-side tagging, you might have just a single stream of events from the browser to the server. This single stream can be split into dozens and dozens of advertising, marketing, and analytics requests in the Server container.</p>
<p>The templates running in the Server container won&rsquo;t be able to leverage client-side consent APIs such as those suggested by TCF. Instead, you need to build the mechanism of interpreting and parsing user consent manually in the container itself.</p>
<p>Possibly, and hopefully, Google will introduce tools that make this process easier. However, until then you need to make sure that <strong>when</strong> consent is collected in the browser or device, it is respected in the server as well.</p>
<h3 id="cost">Cost</h3>
<p>The <strong>cost</strong> of running a Server-side tagging is large or small, depending on what you&rsquo;re comparing it to.</p>
<p>It&rsquo;s large compared to just running the scripts in the browser, thus accumulating zero extra cost.</p>
<p>It&rsquo;s small compared to all the <a href="#key-benefits">benefits</a> you&rsquo;ll get in return for setting up the container, at least I like to think so.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/forecasted-cost.jpg" title="Forecasted cost with a small throughput">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/forecasted-cost.jpg#ZgotmplZ" alt="Forecasted cost with a small throughput" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1848 482'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Forecasted cost with a small throughput</span>
  
</div>


<p>Running a three-instance App Engine setup for my <a href="https://www.simoahava.com/blog-statistics/">site of modest traffic</a> puts me back about 120â‚¬ per month. For me, this is acceptable considering I get more control over the data collection on my site.</p>
<h3 id="poor-availability-of-server-side-endpoints">Poor availability of server-side endpoints</h3>
<p>For the Server container to work as a replacement for your browser- or app-based tracking, the vendors you want to send data to need to be able to collect the HTTP requests sent by the Server container.</p>
<p>This isn&rsquo;t necessarily a big issue - vendors always have an HTTP endpoint to which their JavaScript library sends data, and many support simple image pixels for collecting the GET requests.</p>
<p>However, many vendors also stuff the browser with super complicated and heavy JavaScript. If you want to work towards reducing the amount of third-party crap loaded in the browser, the vendor should provide a means to build the payload manually, without having to load their bloated JavaScript libraries.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/fbevents-js.jpg" title="Facebook JavaScript">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/fbevents-js.jpg#ZgotmplZ" alt="Facebook JavaScript" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1042 522'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>For example, <strong>Facebook</strong> has a large and very complex set of client-side libraries they want you to download when working with their pixel. The purpose of the library is to let you communicate with Facebook&rsquo;s servers using the <code>fbq()</code> command queue.</p>
<p>Luckily, Facebook <em>also</em> offers the <a href="https://developers.facebook.com/docs/marketing-api/conversions-api">Conversions API</a>, which specifies a format for the HTTP request with the conversion information. By deciphering the Conversions API documentation, anyone can build their own event stream from the device to the Server container to Facebook without having to load <em>any</em> Facebook JavaScript at all.</p>
<p>Then there are services like <strong>HotJar</strong> that are so tightly coupled with client-side interactions that it is unlikely you can ever run HotJar without having to download their JavaScript. It will be interesting to see how vendors like HotJar adapt to a tagging environment that is run completely in the server.</p>

                
                  <h2 id="technical-outline">Technical outline</h2>
<p>When you follow <a href="https://developers.google.com/tag-manager/serverside#create_a_google_cloud_platform_gcp_server">the instructions</a> to <em>provision</em> a Google Tag Manager server-side environment, the scripts automatically create a <strong>single Standard App Engine instance</strong>.</p>
<blockquote>
<p><strong>NOTE!</strong> In early beta, there was also the option to load the Server container in a Kubernetes cluster of Compute Engine instances. This is a more advanced setup designed for users who already have a pipeline running in Google Cloud, and they want more control over it than what App Engine&rsquo;s managed environments can offer.</p>
</blockquote>
<p>App Engine is a managed virtual machine platform running in the Google Cloud. By using the Standard environment and a single instance, you can test-drive your Google Tag Manager setup most likely without even expending the <a href="https://cloud.google.com/appengine/quotas">free quota</a> you have available.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/app-engine-three-instances.jpg" title="App Engine with three instances">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/app-engine-three-instances.jpg#ZgotmplZ" alt="App Engine with three instances" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3076 652'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>However, as soon as you&rsquo;re ready to deploy the new Server container into a full production environment, you should guarantee best performance and uptime by transferring to a Flexible App Engine environment and increasing the number of instances to a minimum of three. By doing this, you increase the throughput and performance of your server-side endpoint, and you guarantee that it is able to shoulder the incoming load. Follow <a href="https://developers.google.com/tag-manager/serverside/script-user-guide#create_a_gcp_server">these instructions</a> for more details.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/custom-domain-mapped.jpg" title="Custom Domain mapped">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/custom-domain-mapped.jpg#ZgotmplZ" alt="Custom Domain mapped" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1774 812'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In addition to provisioning extra instances, you should also <a href="#custom-domain">map a custom domain</a> to the endpoint, preferably one that is a subdomain of your main site.</p>
<h3 id="cost-1">Cost</h3>
<p>It&rsquo;s difficult to say what the <em>exact</em> cost for your setup will be, but rest assured that there <em>will</em> be costs associated with production usage.</p>
<p>As an example, I&rsquo;m running App Engine in a Flexible environment, using three instances (the minimum recommended setup for production use). The cost associated with this setup is around <strong>4 euros per day</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/app-engine-cost.jpg" title="App Engine cost">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/app-engine-cost.jpg#ZgotmplZ" alt="App Engine cost" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3598 1994'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>I&rsquo;m only collecting Universal Analytics Page Views to this Server container. As you can see, the graph is pretty much steady regardless of the amount of hits coming in (my site averages just <strong>0.2 requests per second</strong>).</p>
<p>My site has a visible dip in pageviews over weekends, with around 8,000 pageviews sent over a typical weekday and just one fourth of that over a Saturday or a Sunday. However, these dips don&rsquo;t reflect in the cost of running my current Server container, which means I could probably scale the setup down a little, but on the other hand I fully intend to add additional measurements, so I&rsquo;d have to scale back up anyway.</p>
<p>When you compare the cost forecast above with a Server-side tagging setup that collects around <strong>60 requests per second</strong>, we&rsquo;re talking at around <strong>250â‚¬ per month</strong> instead.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/08/forecasted-large-cost.jpg" title="Forecasted cost with a larger throughput">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/forecasted-large-cost.jpg#ZgotmplZ" alt="Forecasted cost with a larger throughput" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3582 838'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Forecasted cost with a larger throughput</span>
  
</div>


<p>I hope at some point Google releases case studies and statistics, or even a tool, which allow you to estimate the cost and scale up or down accordingly.</p>
<h3 id="server-container">Server container</h3>
<p>The <strong>Server container</strong> itself is visually reminiscent of any Google Tag Manager container.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/server-container.jpg" title="Server container">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/server-container.jpg#ZgotmplZ" alt="Server container" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2548 1814'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The main difference is the new <strong>Client</strong> asset type you can see in the left-hand menu. I&rsquo;ll explain more about clients in the <a href="#clients-and-tags">associated chapter</a>.</p>
<blockquote>
<p>When using the term <strong>incoming HTTP request</strong>, I&rsquo;m referring to the HTTP request that is sent from a device or browser to the Server container. When using the term <strong>outgoing HTTP request</strong>, I&rsquo;m referring to the HTTP request built and dispatched by tags firing in the container.</p>
</blockquote>
<h4 id="tags">Tags</h4>
<p>Tag-wise there&rsquo;s not much there, yet.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/tags.jpg" title="Available tag templates">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/tags.jpg#ZgotmplZ" alt="Available tag templates" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1546 924'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>There&rsquo;s the native <strong>Universal Analytics</strong> and <strong>App + Web</strong> templates, both configured to digest data pushed by their respective Clients. The <strong>HTTP Request</strong> tag lets you create an outgoing HTTP request to any destination.</p>
<p>Then there are all the <a href="#custom-templates">custom tag templates</a> people can imagine creating. Almost any service that accepts HTTP requests can be configured into a custom tag template in the Server container.</p>
<h4 id="triggers">Triggers</h4>
<p>There&rsquo;s a noticeable lack of available triggers. In fact, there&rsquo;s just a single <strong>Custom</strong> trigger type.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/custom-trigger.jpg" title="Custom trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/custom-trigger.jpg#ZgotmplZ" alt="Custom trigger" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1852 728'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The fact is that a Server container would not be associated with arbitrary triggers such as &ldquo;Page View&rdquo;, &ldquo;Click&rdquo;, or &ldquo;Video&rdquo;. Instead, any tags triggering in a Server container would only trigger if a Client <a href="https://developers.google.com/tag-manager/serverside/api#runcontainer">instructed them to do so</a>.</p>
<p>A Server container is also unrelated to client-side labels such as a &ldquo;page load&rdquo; or a &ldquo;container load&rdquo;. It&rsquo;s running all the time - it&rsquo;s not reset when the page is refreshed. Thus there are no triggers related to the lifecycle of a Server container, though that doesn&rsquo;t mean there won&rsquo;t be at some point.</p>
<h4 id="variables">Variables</h4>
<p>The available <strong>Built-in variables</strong> are:</p>
<table>
<thead>
<tr>
<th>Variable name</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query String</td>
<td>Returns the query string of the incoming HTTP request.</td>
<td><code>v=1&amp;t=pageview&amp;tid=UA-12345-1...</code></td>
</tr>
<tr>
<td>Request Method</td>
<td>Returns the method of the incoming HTTP request.</td>
<td><code>GET</code></td>
</tr>
<tr>
<td>Request Path</td>
<td>Returns the path of the incoming HTTP request.</td>
<td><code>/collect</code></td>
</tr>
<tr>
<td>Client Name</td>
<td>Returns the name of the <a href="#clients-and-tags">Client</a> currently processing the request.</td>
<td><code>Facebook Client</code></td>
</tr>
<tr>
<td>Container ID</td>
<td>Returns the ID of your Server container.</td>
<td><code>GTM-XXXXXX</code></td>
</tr>
<tr>
<td>Container Version</td>
<td>Returns the current version of your Server container.</td>
<td><code>QUICK_PREVIEW</code></td>
</tr>
<tr>
<td>Debug Mode</td>
<td>Whether the container is in Preview mode or not.</td>
<td><code>true</code></td>
</tr>
<tr>
<td>Random Number</td>
<td>Returns a random positive integer.</td>
<td><code>12345</code></td>
</tr>
<tr>
<td>Event Name</td>
<td>Returns the value of the <code>event_name</code> field in the <a href="#event-model">event data object</a> that was passed to the container.</td>
<td><code>page_view</code></td>
</tr>
</tbody>
</table>
<p>These can be used to parse information about the <a href="#requests-and-responses">incoming request</a> and to retrieve metadata about the event that fired and the container itself.</p>
<p>Available <strong>User-defined variables</strong> are:</p>
<table>
<thead>
<tr>
<th>Variable name</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cookie Value</td>
<td>Set to the value of the first cookie that matches the name.</td>
<td><code>GA1.2.12345.12345</code></td>
</tr>
<tr>
<td>Query Parameter</td>
<td>Set to the value of the first query parameter in the <strong>incoming HTTP request</strong> that matches the name.</td>
<td><code>UA-12345-1</code></td>
</tr>
<tr>
<td>Query String</td>
<td>Returns the query string of the incoming HTTP request. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>v=1&amp;tid=UA-12345-1&amp;t=pageview...</code></td>
</tr>
<tr>
<td>Request Header</td>
<td>Returns the value(s) of the header name from the incoming HTTP request.</td>
<td><code>https://referrer-page.com/</code></td>
</tr>
<tr>
<td>Request Method</td>
<td>Returns the method of the incoming HTTP request. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>POST</code></td>
</tr>
<tr>
<td>Request Path</td>
<td>Returns the path of the incoming HTTP request. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>/j/collect</code></td>
</tr>
<tr>
<td>Client Name</td>
<td>Returns the name of the Client currently processing the request. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>Universal Analytics</code></td>
</tr>
<tr>
<td>Constant</td>
<td>Returns whatever string you type into the variable.</td>
<td><code>UA-12345-1</code></td>
</tr>
<tr>
<td>Event Data</td>
<td>Returns the value of the key in the <a href="#event-model">event data object</a>.</td>
<td><code>123.123.123.123</code></td>
</tr>
<tr>
<td>Event Name</td>
<td>Returns the value of the <code>event_name</code> field in the event data object that was passed to the container. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>page_view</code></td>
</tr>
<tr>
<td>Random Number</td>
<td>Returns a random positive integer. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>123123</code></td>
</tr>
<tr>
<td>Container ID</td>
<td>Returns the ID of your Server container. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>GTM-ABCDE</code></td>
</tr>
<tr>
<td>Container Version Number</td>
<td>Returns the current version of your Server container. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>13</code></td>
</tr>
<tr>
<td>Debug Mode</td>
<td>Whether the container is in Preview mode or not. <strong>Note! Use the Built-in variable instead.</strong></td>
<td><code>false</code></td>
</tr>
</tbody>
</table>
<p>You can, and should, utilize <a href="#custom-templates">custom templates</a> to build your own variable types.</p>
<h3 id="custom-domain">Custom domain</h3>
<p>You are <strong>strongly</strong> encouraged to map a <em>custom domain</em> to your Server container endpoint.</p>
<p>The main reason is that this way you can incorporate the server-side data collection endpoint <strong>that you own</strong> in your first-party domain namespace. For example, I&rsquo;m using <code>sgtm.simoahava.com</code> as the host of the Server container.</p>
<p>This becomes significant when you consider things like <a href="https://www.cookiestatus.com/safari/">Intelligent Tracking Prevention</a>. You might want to make use of cookies in the incoming requests, but if the Server container is hosted on a domain that is different from where the requests are sent (such as your site), these cookies will be considered <strong>third-party cookies</strong> and thus dropped by many browsers.</p>
<blockquote>
<p><strong>NOTE!</strong> Due to <a href="https://bugs.webkit.org/show_bug.cgi?id=215201">upcoming changes</a> in ITP, you should map the domain as a newly verified subdomain. This way you&rsquo;ll be instructed to use A/AAAA DNS records rather than the vulnerable CNAME alias.</p>
</blockquote>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/appengine-domains.jpg" title="App Engine domains">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/appengine-domains.jpg#ZgotmplZ" alt="App Engine domains" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1762 802'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Similarly, having the endpoint in your first-party domain namespace means you can do things like <a href="#server-side-universal-analytics-with-a-set-cookie-header">set first-party cookies with Set-Cookie headers</a> and thus avoid Safari expiring them within 7 days of being set.</p>
<blockquote>
<p>Note that technically you can have <strong>more than one domain pointing to your App Engine deployment</strong>. This is helpful in case you have a single server-side container responding to requests from multiple domains. The only &ldquo;catch&rdquo; is that some features of the Server container, such as for which domain the <a href="#preview-and-debug">Preview mode</a> is shown, are restricted to just one domain. It won&rsquo;t hamper the actual data collection, but it might make it difficult to use some of these features.</p>
</blockquote>
<h3 id="requests-and-responses">Requests and responses</h3>
<p>Server-side tagging revolves around <strong>incoming HTTP requests</strong> to the server container being mapped by a <a href="#clients-and-tags">Client</a>, passed to a tag, and then dispatched as an <strong>outgoing HTTP request</strong> to the tag vendor. Once all the tags have fired for a given Client, the Client sends an HTTP response back to the origin of the request, such as a browser, an app, or some other connected service.</p>
<p>This flow is <em>absolutely fundamental</em> to understanding how Server-side tagging works. A &ldquo;perfect&rdquo; end-to-end pipeline would be one where the requests are carefully sculpted to make use of as little client-side code as possible; The Clients are designed to handle both vendor-specific and vendor-agnostic requests; The tags are built to trigger off specific clients&rsquo; event data payloads, finally responding to the Client whether the outgoing HTTP request was a success or not.</p>
<p>The <em>easiest</em> way to map a Client to an incoming request is to observe the <strong>Request Path</strong>. The built-in Universal Analytics Client, for example, is primed to listen to requests that have the <code>/collect</code> path or any of its permutations (such as <code>/j/collect</code> or <code>/r/collect</code>). You could create a Facebook Client that listens for a custom path of <code>/fbook</code>, and a HotJar Client that listens for requests with the path of <code>/hotjar</code>.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/facebook-client.jpg" title="Client looks for a request to /fbq and if one is found, claims the request.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/facebook-client.jpg#ZgotmplZ" alt="Client looks for a request to /fbq and if one is found, claims the request." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1136 198'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Client looks for a request to /fbq and if one is found, claims the request.</span>
  
</div>


<p>Alternatively, you could approach a <em>single event stream</em> model, where all requests are sent to the same Client. In this case, they would have just a single path, such as <code>/events</code>, and you would configure the Client to parse the request body and turn it into event data objects that are passed to the container.</p>
<p>Whatever you choose, you need to remember that whatever origin sent the request is actually waiting for a <strong>response</strong> back from the Server container.</p>
<p>By default, the response is a fairly nondescript <code>text/html</code> response, but you can jazz things up using the following APIs.</p>
<ul>
<li><a href="https://developers.google.com/tag-manager/serverside/api#setcookie"><code>setCookie</code></a> lets you write cookies in the Set-Cookie header of the HTTP response.</li>
<li><a href="https://developers.google.com/tag-manager/serverside/api#setpixelresponse"><code>setPixelResponse</code></a> automatically configures the response to mimic a 1x1 GIF pixel with headers that prevent caching.</li>
<li><a href="https://developers.google.com/tag-manager/serverside/api#setresponseheader"><code>setResponseHeader</code></a> can be used to add <em>any</em> custom HTTP headers to the response. Consider headers like <code>Access-Control-Allow-Origin</code> and <code>Access-Control-Allow-Credentials</code>, which are useful for preflight requests, for example.</li>
</ul>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/request-with-headers.jpg" title="Request with setPixelResponse() and setCookie() APIs.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/request-with-headers.jpg#ZgotmplZ" alt="Request with setPixelResponse() and setCookie() APIs." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1890 740'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">Request with setPixelResponse() and setCookie() APIs.</span>
  
</div>


<p>Hopefully at some point we&rsquo;ll see more options for manipulating the <strong>request</strong> as well. We could envision Clients whose only purpose is to purge the incoming request from PII, before passing the request on to the next client that actually builds the event object for tags to dispatch, now cleared of all PII.</p>
<h3 id="clients-and-tags">Clients and tags</h3>
<p>We&rsquo;ve already talked a lot about <strong>Clients</strong> and <strong>tags</strong>, but it&rsquo;s good to reiterate as the concept might be a bit alien - especially if you&rsquo;re used to how GTM for the web works.</p>
<p>The purpose of a <strong>Client</strong> is to listen for <strong>incoming HTTP requests</strong>, parse them into a unified <a href="#event-model">event model</a>, and then run a virtual container with the event model, so that tags can use the details in these event objects to compile the requests to their endpoints.</p>
<p>Because Clients do all the legwork, you can start streamlining the event stream itself, moving away from vendor-specific request parsing (which might require vendor-specific JavaScript to run in the user&rsquo;s browser, for example), and leaning towards a more agnostic approach, where a single event stream can be distributed into multiple unrelated endpoints.</p>
<p>Clients operate on a <strong>Priority</strong> order. The higher the priority of a Client, the sooner it gets to check if the request is its to <strong>claim</strong>. To <strong>claim</strong> a request means calling the <a href="https://developers.google.com/tag-manager/serverside/api#claimrequest"><code>claimRequest</code> API</a>. This, in turn, means that the current Client tells all the other Clients that this request is <strong>MINE!</strong> and doesn&rsquo;t allow any other Client to parse the request anymore.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2020/07/client-priority.jpg" title="The Client with Priority 100 always has first dibs on the request.">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/client-priority.jpg#ZgotmplZ" alt="The Client with Priority 100 always has first dibs on the request." src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1960 686'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">The Client with Priority 100 always has first dibs on the request.</span>
  
</div>


<p>Once the Client has parsed the request and built an event object out of it, the event is passed to the <a href="https://developers.google.com/tag-manager/serverside/api#runcontainer"><code>runContainer</code> API</a>. With this API, the event is passed to the tags to evaluate and potentially trigger with.</p>
<p>Tags can be set to trigger on numerous different things, but most likely you will end up using a combination of <strong>Event Name</strong> and/or <strong>Client Name</strong>.</p>
<p>The Event Name is something that <a href="https://developers.google.com/analytics/devguides/collection/gtagjs/events">gtag.js</a>, <a href="https://firebase.google.com/docs/analytics">Firebase Analytics</a>, and more recently <a href="https://developers.google.com/analytics/devguides/collection/app-web/events">App + Web</a> iterated and introduced to the world of web analytics.</p>
<p>Basically, there&rsquo;s an inventory of <a href="https://developers.google.com/tag-manager/serverside/events"><strong>suggested</strong> or quasi-<strong>standardized</strong> Event Names</a>, such as <code>page_view</code>, <code>search</code>, and <code>login</code>. Then there is always the opportunity to use a custom Event Name such as <code>new_level_achieved</code>.</p>
<p>When the Client builds the event model, it <em>has</em> to provide an Event Name. This is what ends up showing up in the Preview screen when the request is claimed and mapped by a Client:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/event-name.jpg" title="Event name">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/event-name.jpg#ZgotmplZ" alt="Event name" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2016 1054'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>So if you wanted to fire a bunch of tags whenever a <code>page_view</code> is collected, regardless of Client, you&rsquo;d simply use a trigger that checks the Event Name. You&rsquo;d then just need to <em>assume</em> that the Client has correctly intercepted the incoming HTTP request, and has managed to parse and map it into an event object that can be understood by your tag (you can use Preview mode to analyze what the <strong>event data object</strong> contained).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/event-page-view.jpg" title="Event name page view">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/event-page-view.jpg#ZgotmplZ" alt="Event name page view" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1776 552'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Alternatively, perhaps you want your tag to fire only when the Facebook Client generated the event object. This is useful in case the tag requires a <em>lot</em> of custom information not available as standard parameters in the event object.</p>
<p>By referencing the Client Name, you can ensure that the tag only fires if the correct Client has claimed the incoming HTTP request, assuming the Client that executed <code>runContainer</code> also <em>claimed</em> the request (there might be some edge cases where this is not the case).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/facebook-client-trigger.jpg" title="Facebook Client trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/facebook-client-trigger.jpg#ZgotmplZ" alt="Facebook Client trigger" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 554'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>It might be difficult to wrap your head around Clients and tags, but once the inventory of templates for both multiplies in the <a href="https://tagmanager.google.com/gallery">community gallery</a>, it will become easier to just use the community templates rather than having to worry about how to build your own.</p>
<h3 id="event-model">Event model</h3>
<p>When the Client parses an incoming HTTP request it has claimed, it needs to map values in the request body (typically in a query string) and produce an <strong>event data object</strong>, which looks something like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  event_name: <span style="color:#a50">&#34;page_view&#34;</span>,
  event_parameter: <span style="color:#a50">&#34;some value&#34;</span>,
  event_parameter_object: {
    nested_event_parameter: <span style="color:#a50">&#34;some other value&#34;</span>
  }
}
</code></pre></div>
<p>This object is what gets passed to the container with the <a href="https://developers.google.com/tag-manager/serverside/api#runcontainer"><code>runContainer</code> API</a>. Tags will then be able to use these values in the trigger, e.g. firing a tag only when <code>event_name</code> is <code>page_view</code>, and they&rsquo;ll be able to map values in the event object to the outgoing HTTP request they dispatch to the vendor endpoint.</p>
<p>To keep things streamlined, Google <a href="https://developers.google.com/tag-manager/serverside/events">suggests a set of standard event names and parameters</a> that you should try to follow to make sure that the event data object passed to the container can be used with as little friction as possible. If the tags require parameters that are not available in the list of standard parameters, they should be prefixed with <code>x-vendor-</code>. Thus, for example, Facebook&rsquo;s <a href="https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/customer-information-parameters#subscription-id">Subscription ID</a> becomes <code>x-fb-subscription_id</code>.</p>
<p>Note also the preference of <code>snake_case</code> vs. <code>camelCase</code>. It&rsquo;s a syntactical format you should get accustomed to using when working with Server-side tagging.</p>
<p>You can always use the Server container&rsquo;s <a href="#preview-and-debug">Preview mode</a> to audit what&rsquo;s passed in the event data object by any given client. For example, when collecting a Universal Analytics Measurement Protocol hit, this is what you might see:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/ga-event-data-object.jpg" title="Event data object">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/ga-event-data-object.jpg#ZgotmplZ" alt="Event data object" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1740 2398'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In the example above, many <em>standard parameters</em> are populated, such as <code>client_id</code>, <code>ip_override</code>, <code>page_location</code>, and <code>user_agent</code>.</p>
<p>Additionally, Measurement Protocol uses a number of custom parameters that are (more or less) unique to Google Analytics, such as <code>x-ga-mp1-vp</code> (<a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#vp">viewport size</a>), <code>x-ga-measurement_id</code> (<a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#tid">web property ID</a> with Universal Analytics), and <code>x-ga-mp1-plt</code> (<a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#plt">page load time</a>).</p>
<p>This event object is then digested by the Universal Analytics tag, which will be able to take these items and compile the outgoing Measurement Protocol request to Google Analytics. If the event object is correctly compiled, the tag can even utilize the shorthand API <a href="https://developers.google.com/tag-manager/serverside/api#sendeventtogoogleanalytics"><code>sendEventToGoogleAnalytics</code></a>.</p>
<h3 id="custom-templates">Custom templates</h3>
<p>Server-side tagging relies heavily on <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom templates</a>. In addition to <strong>tag</strong> and <strong>variable</strong> templates, which are available in web containers as well, power users now have the opportunity to create <strong>Client</strong> templates as well.</p>
<p>The available APIs for these are listed <a href="https://developers.google.com/tag-manager/serverside/api">in the documentation</a>. Many APIs, such as <a href="https://developers.google.com/tag-manager/serverside/api#runcontainer"><code>runContainer</code></a> have a footnote saying:</p>
<blockquote>
<p>It is recommended that this API be used from a client template.</p>
</blockquote>
<p>Roughly, Clients should typically utilize APIs that <strong>claim, validate, and parse</strong> the incoming HTTP requests, <strong>run the container</strong> with the event data object, <strong>listen for messages</strong> from the tags fired in the container, and finally <strong>modify and return a response</strong> back to the source of the incoming request.</p>
<p>Here are some APIs that you&rsquo;d <em>typically</em> run exclusively from a Client:</p>
<table>
<thead>
<tr>
<th>Client API</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#claimRequest"><code>claimRequest</code></a></td>
<td>Claim the request for the Client.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#extracteventsfrommpv1"><code>extractEventsFromMpv1</code></a></td>
<td>Parse an incoming Measurement Protocol v1 request, and extract event data objects from it.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#extracteventsfrommpv2"><code>extractEventsFromMpv2</code></a></td>
<td>Parse an incoming Measurement Protocol v2 request, and extract event data objects from it.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#getcookievalues"><code>getCookieValues</code></a></td>
<td>Get the values of all cookies with the given name in the incoming HTTP request.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#getremoteaddress"><code>getRemoteAddress</code></a></td>
<td>Best-effort attempt to get the IP address of the incoming request.</td>
</tr>
<tr>
<td><code>getRequest*</code></td>
<td>All the <code>getRequest...</code> APIs are designed to parse some aspect of the incoming HTTP request.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#isrequestmpv1"><code>isRequestMpv1</code></a></td>
<td>Check if the incoming HTTP request is in Measurement Protocol v1 format.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#isrequestmpv2"><code>isRequestMpv2</code></a></td>
<td>Check if the incoming HTTP request is in Measurement Protocol v2 format.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#returnresponse"><code>returnResponse</code></a></td>
<td>Return the HTTP response with all the set headers back to the source of the incoming request.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#runcontainer"><code>runContainer</code></a></td>
<td>Run the container with the event data object.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#setcookie"><code>setCookie</code></a></td>
<td>Populate a Set-Cookie header in the response.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#setPixelResponse"><code>setPixelResponse</code></a></td>
<td>Automatically set response headers to mimic a 1x1 GIF pixel.</td>
</tr>
<tr>
<td><code>setResponse*</code></td>
<td>All the <code>setResponse...</code> headers modify some aspect of the HTTP response finally flushed by the <code>returnResponse</code> API.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note that you certainly <em>can</em> use some of these APIs in tags. For example, you could set aspects of the response directly in the tag itself. However, it might make sense to have tags communicate their status back to the Client with the <a href="https://developers.google.com/tag-manager/serverside/api#sendmessage"><code>sendMessage</code> API</a>, and use the Client to manage all aspects of the request-response flow.</p>
</blockquote>
<p>Tags should typically utilize APIs that <strong>parse the event data object</strong>, build an <strong>HTTP request</strong> to the tag endpoint, and <strong>message back to the container</strong> whatever metadata the outgoing request produced (such as a failed status code or success message).</p>
<p>Here are some APIs that you&rsquo;d <em>typically</em> run exclusively from a Tag:</p>
<table>
<thead>
<tr>
<th>Tag API</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#getalleventdata"><code>getAllEventData</code></a></td>
<td>Get the event data object passed to the container.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#getclientname"><code>getClientName</code></a></td>
<td>Get the name of the current Client.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#geteventdata"><code>getEventData</code></a></td>
<td>Get the value of a single key in the event data object.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#sendeventtogoogleanalytics"><code>sendEventToGoogleAnalytics</code></a></td>
<td>Automatically build and dispatch an outgoing Measurement Protocol request from an event data object formatted correctly.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#sendhttpget"><code>sendHttpGet</code></a></td>
<td>Send an HTTP GET request.</td>
</tr>
<tr>
<td><a href="https://developers.google.com/tag-manager/serverside/api#sendhttprequest"><code>sendHttpRequest</code></a></td>
<td>Send a fully customizable HTTP request.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note that you <em>could</em> run a Server container without a single tag. All the APIs designed to be used in tags could be run through a Client. But this is orthogonal to how Server-side tagging has been designed to work.</p>
</blockquote>
<p>Here&rsquo;s an example of a Client running some of the recommended APIs:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> addMessageListener = require(<span style="color:#a50">&#39;addMessageListener&#39;</span>);
<span style="color:#00a">const</span> claimRequest = require(<span style="color:#a50">&#39;claimRequest&#39;</span>);
<span style="color:#00a">const</span> extractEventsFromMpv1 = require(<span style="color:#a50">&#39;extractEventsFromMpv1&#39;</span>);
<span style="color:#00a">const</span> isRequestMpv1 = require(<span style="color:#a50">&#39;isRequestMpv1&#39;</span>);
<span style="color:#00a">const</span> returnResponse = require(<span style="color:#a50">&#39;returnResponse&#39;</span>);
<span style="color:#00a">const</span> runContainer = require(<span style="color:#a50">&#39;runContainer&#39;</span>);
<span style="color:#00a">const</span> setResponseBody = require(<span style="color:#a50">&#39;setResponseBody&#39;</span>);
<span style="color:#00a">const</span> setResponseHeader = require(<span style="color:#a50">&#39;setResponseHeader&#39;</span>);
<span style="color:#00a">const</span> setResponseStatus = require(<span style="color:#a50">&#39;setResponseStatus&#39;</span>);
<span style="color:#00a">const</span> setPixelResponse = require(<span style="color:#a50">&#39;setPixelResponse&#39;</span>);

<span style="color:#aaa;font-style:italic">// If Measurement Protocol request, claim and parse
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">if</span> (isRequestMpv1()) {
  claimRequest();
  <span style="color:#00a">const</span> events = extractEventsFromMpv1();
  
  <span style="color:#aaa;font-style:italic">// Listen for message from tag signalling completion,
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">// set response headers accordingly.
</span><span style="color:#aaa;font-style:italic"></span>  addMessageListener(<span style="color:#a50">&#39;ga_complete&#39;</span>, (messageType, message) =&gt; {
    <span style="color:#00a">if</span> (message.status === <span style="color:#a50">&#39;error&#39;</span>) {
      setResponseStatus(<span style="color:#099">500</span>);
      setResponseBody(message.body);
    } <span style="color:#00a">else</span> <span style="color:#00a">if</span> (message.status === <span style="color:#a50">&#39;redirect&#39;</span>) {
      setResponseStatus(<span style="color:#099">302</span>);
      setResponseHeader(<span style="color:#a50">&#39;location&#39;</span>, message.location);
    }Â <span style="color:#00a">else</span> {
      setPixelResponse();
    }
  });
  
  <span style="color:#aaa;font-style:italic">// Run the container with the parsed event object
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">let</span> eventsCompleted = <span style="color:#099">0</span>;
  events.forEach(event =&gt; {
    runContainer(event, () =&gt; {
      <span style="color:#aaa;font-style:italic">// If all the events in the incoming HTTP request have been completed
</span><span style="color:#aaa;font-style:italic"></span>      <span style="color:#00a">if</span> (events.length === ++eventsCompleted) {
        returnResponse();
      }
    });
  });
}
</code></pre></div>
<p>And here&rsquo;s what the corresponding tag might do:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">const</span> getAllEventData = require(<span style="color:#a50">&#39;getAllEventData&#39;</span>);
<span style="color:#00a">const</span> sendEventToGoogleAnalytics = require(<span style="color:#a50">&#39;sendEventToGoogleAnalytics&#39;</span>);
<span style="color:#00a">const</span> sendMessage = require(<span style="color:#a50">&#39;sendMessage&#39;</span>);

<span style="color:#aaa;font-style:italic">// Access the event data object
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> event = getAllEventData();

<span style="color:#aaa;font-style:italic">// Send the event to Google Analytics and parse the response
</span><span style="color:#aaa;font-style:italic"></span>sendEventToGoogleAnalytics(event, response =&gt; {
  <span style="color:#00a">if</span> (!response.success) {
    sendMessage(<span style="color:#a50">&#39;ga_complete&#39;</span>, {
      status: <span style="color:#a50">&#39;error&#39;</span>,
      body: <span style="color:#a50">&#39;Request to Google Analytics failed&#39;</span>
    });
    <span style="color:#00a">return</span> data.gtmOnFailure();
  }
  <span style="color:#00a">if</span> (response.location) {
    sendMessage(<span style="color:#a50">&#39;ga_complete&#39;</span>, {
      status: <span style="color:#a50">&#39;redirect&#39;</span>,
      location: response.location
    });
  } <span style="color:#00a">else</span> {
    sendMessage(<span style="color:#a50">&#39;ga_complete&#39;</span>, {
      status: <span style="color:#a50">&#39;success&#39;</span>
    });
  }
  data.gtmOnSuccess();
});
</code></pre></div>
<p>As you can see, the Client parses the incoming request and sends it as an event data object to the container. The container then triggers the tag(s), which map the event data object to a Measurement Protocol request.</p>
<p>Google Analytics is a bit special in this case, because both the incoming request parser (<code>extractEventsFromMpv1</code>) and the outgoing request dispatcher (<code>sendEventToGoogleAnalytics</code>) have their own, dedicated APIs built. If you use a custom vendor endpoint, you need to actually manually write the code that turns an incoming request query string into the event data object, and which takes the event data object and maps it to an outgoing HTTP request.</p>
<p>The <code>addMessageListener</code> and <code>sendMessage</code> APIs are very useful, as they allow tags and Clients to communicate with each other. This is very helpful, in case you want the Client to encode information about tag execution in the response back to the request source.</p>
<blockquote>
<p><strong>Note!</strong> The sample code above is a bit unwieldy, because it assumes <code>runContainer</code> to only trigger one tag. If there&rsquo;s more than one tag firing, the <code>addMessageListener</code> callback would react to each tag messaging back, which means only the message from the <em>last</em> tag that fired would be considered for the response the Client sends back to the source of the incoming request.</p>
</blockquote>
<h3 id="preview-and-debug">Preview and debug</h3>
<p>The Server container, just like a web container, has its own Preview and Debug mode. When you click the <strong>Preview</strong> button in the user interface, a <strong>new tab</strong> opens with the Preview interface.</p>
<blockquote>
<p>Just like with a web container, the Preview tab only shows hits that originate from <em>your</em> browser - and it has to be the same browser instance that started Preview mode.</p>
</blockquote>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/preview-panel.jpg" title="Preview panel">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/preview-panel.jpg#ZgotmplZ" alt="Preview panel" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2306 886'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In the left-hand side navigation, you see all the <strong>incoming HTTP requests</strong> and whether or not a Client has claimed and created an event data object from the request. In the screenshot, no event data object was created for the <code>favicon.ico</code> request, but both <code>collect</code> requests were claimed by a Client and turned into event data objects.</p>
<p>If you select a <strong>request</strong>, all the tabs in Preview mode will behave as if you&rsquo;d selected <strong>Summary</strong>. In other words, you&rsquo;ll be able to see <em>how many times</em> a tag would have fired for the request, but you wouldn&rsquo;t be able to look into <strong>Variables</strong> or <strong>Event Data</strong>.</p>
<p>For this reason, whenever you debug, you should choose the <strong>event data object</strong> (e.g. <code>page_view</code> in the example) if available.</p>
<h4 id="request-tab">Request tab</h4>
<p>The <strong>Request</strong> tab contains information about the incoming HTTP request and the response sent back by the Server container. It will also show you if a Client <em>claimed</em> the request.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/preview-request.jpg" title="Preview and Request tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/preview-request.jpg#ZgotmplZ" alt="Preview and Request tab" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1960 886'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The very first line contains a summary of the HTTP request itself. After that is the value of the <code>event_name</code> field, parsed by the Client from the incoming HTTP request.</p>
<p>The <strong>Client</strong> box tells you which Client claimed the request.</p>
<p>The <strong>Incoming HTTP Request</strong> box opens up a new overlay when clicked, with details about the request.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/request-details.jpg" title="Request details">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/request-details.jpg#ZgotmplZ" alt="Request details" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1880 2032'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The <strong>Request</strong> overview shows you the Request method (e.g. <code>GET</code> or <code>POST</code>), and the URL to which the request was sent.</p>
<p><strong>Request Headers</strong> list all the HTTP headers present in the request, and the <strong>Request Body</strong> card shows what was sent as the body of the request (typically just in <code>POST</code> requests).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/request-response.jpg" title="Response details">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/request-response.jpg#ZgotmplZ" alt="Response details" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1834 704'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The <strong>Response</strong> overview has details about what the Server container responded with back to whatever source sent the incoming HTTP request in the first place.</p>
<p><strong>Status Code</strong> indicates whether or not the request was a success (<code>200</code>).</p>
<p><strong>Response Headers</strong> typically include things like cache headers for preventing the browser from caching the request, and <code>Set-Cookie</code> headers which write a cookie on the domain running the Server container.</p>
<p>If the response has a body, it&rsquo;s displayed in the <strong>Response Body</strong> card.</p>
<h4 id="tags-tab">Tags tab</h4>
<p>The <strong>Tags</strong> tab is pretty self-explanatory. You&rsquo;ll see all the tags that fired (or did not fire) with this event data object. Similar to a web container, you can click open a tag to see what values it sent, and you can scroll down to its triggers to see why it didn&rsquo;t fire.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/tags-tab.jpg" title="The Tags tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/tags-tab.jpg#ZgotmplZ" alt="The Tags tab" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1752 1402'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>One cool addition is the <strong>Outgoing HTTP Requests</strong> box. When you click it, a new overlay opens with details about the HTTP requests <strong>sent by the tag</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/08/outgoing-http-request.jpg" title="Outgoing HTTP requests">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/08/outgoing-http-request.jpg#ZgotmplZ" alt="Outgoing HTTP requests" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1898 1844'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You can use this information to debug whether or not the hit to the vendor was dispatched correctly.</p>
<h4 id="variables-tab">Variables tab</h4>
<p>The <strong>Variables</strong> tab, similarly, tells you what the value of each configured variable in the container was when the container was executed with the event data object.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/variables-tab.jpg" title="Variables tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/variables-tab.jpg#ZgotmplZ" alt="Variables tab" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1686 1098'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This is a useful list of information, as you can use it to debug why a tag might not have sent the correct values to the endpoint.</p>
<h4 id="event-data-tab">Event Data tab</h4>
<p>This is a very important tab to familiarize yourself with because it shows you all the values parsed from the incoming HTTP request into an <a href="#event-model">event data object</a>. You can use this with the <strong>Request</strong> tab to see which parameters might be missing or which were parsed incorrectly.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/07/event-data-preview.jpg" title="Event Data in Preview">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/07/event-data-preview.jpg#ZgotmplZ" alt="Event Data in Preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1848 1746'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h4 id="errors-tab">Errors tab</h4>
<p>If any tag throws an error, this tab would have more information about it. You can read more about the <a href="https://www.simoahava.com/analytics/new-errors-tab-preview-mode/">errors tab</a>.</p>

                
                  <h2 id="resources">Resources</h2>
<p>Hopefully, this article will serve as a solid resource for you, especially when you&rsquo;re getting your feet wet with Server-side tagging.</p>
<p>In addition to this, I&rsquo;d like to direct you to the official documentation:</p>
<ul>
<li><a href="https://developers.google.com/tag-manager/serverside">Overview and deployment instructions</a></li>
<li><a href="https://developers.google.com/tag-manager/serverside/script-user-guide#create_a_gcp_server">Provision additional servers (minimum of three is recommended for production)</a></li>
<li><a href="https://developers.google.com/tag-manager/serverside/custom-domain">Setup a custom domain</a></li>
<li><a href="https://developers.google.com/tag-manager/serverside/api">API documentation for templates</a></li>
<li><a href="https://developers.google.com/tag-manager/serverside/events">Suggested <code>event_name</code> values and parameters in the event data object</a></li>
</ul>

                
                  <h2 id="summary">Summary</h2>
<p>I fully expect Google Tag Manager&rsquo;s Server-side tagging to change the landscape of digital analytics. They&rsquo;re not the first vendor to introduce a handy way of building server-side proxies, but they&rsquo;re Google, and this service doesn&rsquo;t come with a license cost.</p>
<p>There are obviously many <a href="#key-concerns">concerns</a> about Server-side tagging. Moving tracking behind the veil of the server will most certainly bristle some hairs. For this reason, I recommend you strive for absolute transparency when disclosing details about what tracking is going on either directly or indirectly in your digital assets and properties.</p>
<p>I&rsquo;m certain we&rsquo;ll see a proliferation of new custom templates introduced specifically for the Server container, and I also expect most vendors in the adtech and martech space to facilitate server-to-server communication for their pixels and data collection endpoints.</p>
<p>Please let me and other readers know in the comments what you think of Server-side tagging. Do let me know if there are things in this article that require clarification.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-cloud/">google cloud</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/send-google-analytics-requests-custom-endpoint/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/lookup-table-generator-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/send-google-analytics-requests-custom-endpoint/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/lookup-table-generator-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

