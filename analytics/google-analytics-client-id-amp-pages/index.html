

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Google Analytics Client ID In AMP Pages | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2016\/11\/amp_cookies.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/google-analytics-client-id-amp-pages\/",
  "datePublished": "2016-11-14T08:59:32\u002b00:00",
  "dateModified": "2016-11-14T08:59:32\u002b00:00",
  "description": "How to setup Google Analytics Client ID bridging across AMP and non-AMP pages. You can use Google Tag Manager to set it up.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Google Analytics Client ID In AMP Pages | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/google-analytics-client-id-amp-pages/">
    
    <meta name="description" content="How to setup Google Analytics Client ID bridging across AMP and non-AMP pages. You can use Google Tag Manager to set it up.">
    <meta property="og:description" content="How to setup Google Analytics Client ID bridging across AMP and non-AMP pages. You can use Google Tag Manager to set it up.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Google Analytics Client ID In AMP Pages">
    <meta property="og:url" content="https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Google Analytics Client ID In AMP Pages">
    <meta name="twitter:description" content="How to setup Google Analytics Client ID bridging across AMP and non-AMP pages. You can use Google Tag Manager to set it up.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2016/11/amp_cookies.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2016/11/amp_cookies.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Google Analytics Client ID In AMP Pages
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2016-11-14T08:59:32Z">
        
  November 14, 2016

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>This article is a collaboration between Simo and <a href="https://www.bounteous.com/insights/author/danwilkerson/">Dan Wilkerson</a>. Dan&rsquo;s one of the smartest analytics developers out there, and he&rsquo;s already contributed a great <a href="https://www.simoahava.com/gtm-tips/using-document-write-safely-gtm-tags/">#GTMTips guest post</a>. It&rsquo;s great to have him back here sharing his insight on working with <a href="https://www.ampproject.org/">Accelerated Mobile Pages</a> (AMP).</p>
<p>So, we&rsquo;re back on AMP! Simo wrote a long, sprawling <a href="https://www.simoahava.com/analytics/accelerated-mobile-pages-via-google-tag-manager/">AMP for Google Tag Manager guide</a> a while ago, and Dan has also contributed to the space with his guide for <a href="https://www.bounteous.com/insights/2015/12/08/google-analytics-using-amp/">AMP and Google Analytics</a>. Both of these guides touched upon a subject that might be one of the reasons to stay away from AMP for now: Client ID matching across AMP, your regular website, and any caches or CDNs that serve the AMP version.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2016/11/amp_cookies.jpg" title="AMP cookies">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2016/11/amp_cookies.jpg#ZgotmplZ" alt="AMP cookies" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2030 1074'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Not only does AMP have its own, unique syntax for the Client ID, it also stores it in different ways. For example, in the <a href="https://developers.google.com/amp/cache/">AMP Cache</a> (and thus via Google search, too), it&rsquo;s stored in <code>localStorage</code>. If someone visits your site directly and accesses AMP pages, the Client ID is stored in the <code>AMP_ECID_GOOGLE</code> cookie. And then if someone visits a regular page on your site, the Client ID can be found in the <code>_ga</code> cookie.</p>
<p>In this article, Dan and Simo tackle this issue by showing how to serve the Client ID <em>consistently</em> from the <code>_ga</code> cookie written on your website&rsquo;s actual domain. This way, AMP pages will use the same Client ID that regular Google Analytics uses, and you will be able to identify customer journeys that may pass through both your regular site as well as your AMP content.</p>
<p>The examples are provided in NodeJS and PHP (WordPress), but the methodology is universal and quite simple to do with any web server software.</p>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="overview">Overview</h2>
<p>To recap, <a href="https://analytics.google.com/">Google Analytics</a> stores a unique identifier for every user who visits your site within a first-party <a href="http://www.allaboutcookies.org/cookies/">cookie</a>. This value, in GA parlance, is called the <strong>Client ID</strong>, and the name of the cookie is <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookies-user-id"><code>_ga</code></a>. Here&rsquo;s what the entire cookie string looks like, with the actual Client ID bolded.</p>
<p>GA1.2.<strong>1789536866.1471440764</strong></p>
<p>The <strong>GA1</strong> value denotes this is version 1 of the <code>_ga</code> cookie. The <strong>2</strong> denotes the number of dot-separated components in the URL the cookie is stored at. For example, if GA were instructed to store the cookie at <strong>shop.example.com</strong>, the number would be 3, instead.</p>
<p>Because AMP pages can be cached and served on many different domains, users who might have had a single Client ID could wind up being split into several users instead.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2016/11/amp-client-ids.jpg" title="AMP Client IDs">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2016/11/amp-client-ids.jpg#ZgotmplZ" alt="AMP Client IDs" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1886 822'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This appears to be at least part of the reason behind why Google Analytics officially recommends <a href="https://analytics.googleblog.com/2016/01/announcing-ga-support-for-accelerated.html">using a separate GA Property for AMP data</a>.</p>
<p>However, there&rsquo;s a way to use <em>only</em> the <code>_ga</code> cookie for all sources that serve your web content. To do this, we&rsquo;ll need to customize our <code>amp-analytics</code> component.</p>
<h4 id="custom-amp-configuration">Custom AMP configuration</h4>
<p><code>amp-analytics</code> is the component that AMP uses for tracking user interactions. If you&rsquo;d like to learn more about all the features it supports, check out <a href="https://www.simoahava.com/analytics/accelerated-mobile-pages-via-google-tag-manager/">the AMP for GTM guide in this blog</a>; it should have all the information you need.</p>
<p>For our purposes, let&rsquo;s focus on the <code>config</code> attribute. It&rsquo;s an optional attribute that we can use to tell AMP: <em>&ldquo;Hey, we&rsquo;ve got some additional configurations that we need to you fetch from this location&rdquo;</em>. This attribute should be set to a URL where additional analytics configurations should be retrieved from. In other words, you need to specify an HTTP request endpoint which returns a valid, <a href="https://www.ampproject.org/docs/reference/components/amp-analytics">AMP-compliant JSON</a> configuration file.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">amp-analytics</span> <span style="color:#1e90ff">config</span>=<span style="color:#a50">&#34;//example.com/analytics.config.json&#34;</span>&gt;&lt;/<span style="color:#1e90ff;font-weight:bold">amp-analytics</span>&gt;</code></pre></div>
<p>Once the browser has loaded the AMP page, and the page is visible in the browser window, AMP will fetch this external configuration file and use it to supplement any configurations that might already be established on the page. Unlike other resources in your content, your <code>amp-analytics</code> config will always point to your server and the result isn&rsquo;t automatically cached. When the request to your server comes in, it will include all of the cookies set on the user&rsquo;s browser on your domain.</p>
<p><strong>NOTE!</strong> If, and when, your content is served through the Google AMP Cache, any external configuration <strong>must be downloaded from an HTTPS source</strong>. Thus if your web server is behind HTTP, you&rsquo;ll need to either only serve your custom configuration when visitors are on your domain OR use just the default configuration template instead. Or, you know, switch to HTTPS as soon as possible.</p>
<h4 id="grabbing-the-_ga-cookie">Grabbing the <code>_ga</code> cookie</h4>
<p>When the request for the custom AMP config is received by your web server, you can check the cookies in the HTTP request to see if a <code>_ga</code> cookie is already set for the user on the website domain. This would be the case if the user has visited your content before (and hasn&rsquo;t flushed cookies). If the cookie is found, you can use a specific HTTP header (see below) in the response to pass this cookie to the domain where the request originated from, e.g. Google&rsquo;s AMP cache.</p>
<p>If the cookie is <em>not</em> found, you can generate a new <code>_ga</code> cookie, following the same pattern <strong>analytics.js</strong> uses - a random unsigned 32-bit integer coupled with a timestamp rounded to the nearest second, like this:</p>
<p><strong>1789536866.1471440764</strong></p>
<p>You can then leverage the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie"><code>Set-Cookie</code></a> header in the HTTP Response, and instruct the browser to store the new Client ID in a <code>_ga</code> cookie, making sure to set the domain, path, and expiration date to match the domain the request originated from (e.g. <code>cdn.ampproject.org</code>), just like analytics.js does. You&rsquo;ll need to add the same <strong>GA1.X.</strong> prefix that GA uses, too. Furthermore, you&rsquo;ll need to do this on <em>every single</em> request, so that the lifetime of the <code>_ga</code> cookie continues to be extended on each page load. The <code>Set-Cookie</code> should end up looking something like this:</p>
<p><code>Set-Cookie:</code> _ga=GA1.1.18347199128.1478727498; Domain=example.com; Path=/; Expires=Sat, 10 Nov 2018 21:06:48 GMT;</p>
<p>Finally, you can return the Client ID in the JSON response as a custom AMP variable for use with our AMP requests:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#1e90ff;font-weight:bold">&#34;vars&#34;</span>: {
    <span style="color:#1e90ff;font-weight:bold">&#34;clientId&#34;</span>: <span style="color:#a50">&#34;18347199128.1478727498&#34;</span>
  }
}</code></pre></div>
<h4 id="checklist-for-setting-up-the-request-handler">Checklist for setting up the request handler</h4>
<p>Of course, it&rsquo;s not quite that simple. In addition to transposing our Client ID and setting it as a cookie, we need to ensure that we&rsquo;ve dotted a few i&rsquo;s. Here&rsquo;s a handy checklist of the configuration steps that need to be taken to ensure everything works in the wild.</p>
<ul>
<li>
<p>In the site HTML:</p>
<ul>
<li>
<p>Add the <code>amp-analytics</code> script tag and <code>amp-analytics</code> component to your AMP templates.</p>
</li>
<li>
<p>Configure component JSON for desired triggers and requests, using <code>${clientId}</code> for the <strong>&amp;cid;</strong> parameter. Alternatively, you can use the pre-built Google Analytics vendor template by adding <code>type=&quot;googleanalytics&quot;</code> to the component.</p>
</li>
<li>
<p>Point <code>config</code> attribute to an endpoint or API on your own server.</p>
</li>
<li>
<p>Set <code>data-credentials=&quot;include&quot;</code>.</p>
</li>
</ul>
</li>
<li>
<p>In your web server:</p>
<ul>
<li>
<p>In the request handler in your web server, extract the Client ID from the <code>_ga</code> cookie or generate a new one.</p>
</li>
<li>
<p>Add the <code>clientId</code> parameter to the <code>vars</code> object in the JSON configuration. Set it to the Client ID from the <code>_ga</code> cookie.</p>
</li>
<li>
<p>Add the <code>Set-Cookie</code> header with the <code>_ga</code> cookie, set to expire in two years.</p>
</li>
<li>
<p>Set the <code>Access-Control-Allow-Origin</code> header to <code>https://cdn.ampproject.org</code>. Note: Wildcards (*) are invalid in this context.</p>
</li>
<li>
<p>Set the <code>Access-Control-Expose-Headers</code> header to <code>AMP-Access-Control-Allow-Source-Origin</code>.</p>
</li>
<li>
<p>Set the <code>Access-Control-Allow-Credentials</code> header to <code>true</code>.</p>
</li>
<li>
<p>Set the header <code>AMP-Access-Control-Allow-Source-Origin</code> to the source domain of the document (e.g. <code>https://mysite.com</code>).</p>
</li>
<li>
<p>Return the JSON configuration in the response body.</p>
</li>
</ul>
</li>
</ul>
<p>For a full example, <a href="https://github.com/DanWilkerson/amp-config-example">check out this repository on GitHub</a>. If you&rsquo;re using the Google Analytics vendor configuration, this is all you need to do. If you&rsquo;d like to combine this concept with Google Tag Manager, read on!</p>

                
                  <h2 id="google-tag-manager-proxy-using-nodejs">Google Tag Manager proxy using NodeJS</h2>
<p>As Simo covered in his <a href="https://www.simoahava.com/analytics/accelerated-mobile-pages-via-google-tag-manager/">GTM/AMP guide</a>, Google Tag Manager allows us to build Tags and Triggers in a web UI, then compile those down into a JSON configuration in the format AMP expects. If we used the standard GTM implementation, however, the container request is done directly to GTM&rsquo;s server, which means our custom API wouldn&rsquo;t be able to serve the proper Client ID. That said, you can still combine both techniques. You&rsquo;ve just got to roll up your sleeves a little.</p>
<p>Here&rsquo;s a truncated example, using <a href="https://nodejs.org/en/">Node</a> and <a href="http://expressjs.com/">Express</a>. For the complete code, <a href="https://github.com/DanWilkerson/amp-config-example">visit this GitHub repository</a>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">app.get(<span style="color:#a50">&#39;/gtm-analytics.config.json&#39;</span>, (req, res) =&gt; {

  <span style="color:#00a">const</span> domain = req.headers.host.split(<span style="color:#a50">&#39;:&#39;</span>)[<span style="color:#099">0</span>]
  <span style="color:#00a">const</span> gaCookie = req.cookies._ga || generateGaCookie(domain)
  <span style="color:#00a">const</span> clientId = parseClientIdFromGaCookie(gaCookie)
  <span style="color:#00a">const</span> cookieString = generateCookieString({
    name: <span style="color:#a50">&#39;_ga&#39;</span>,
    value: gaCookie,
    domain: domain.replace(<span style="color:#a50">&#39;www.&#39;</span>, <span style="color:#a50">&#39;&#39;</span>),
    path: <span style="color:#a50">&#39;/&#39;</span>,
    expires: <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>(<span style="color:#099">1000</span> * <span style="color:#099">60</span> * <span style="color:#099">60</span> * <span style="color:#099">24</span> * <span style="color:#099">365</span> * <span style="color:#099">2</span> + (+<span style="color:#00a">new</span> <span style="color:#0aa">Date</span>)).toGMTString()
  })

  res.setHeader(<span style="color:#a50">&#39;Set-Cookie&#39;</span>, cookieString)
  res.setHeader(<span style="color:#a50">&#39;Access-Control-Allow-Origin&#39;</span>, <span style="color:#a50">&#39;https://cdn.ampproject.org&#39;</span>)
  res.setHeader(<span style="color:#a50">&#39;Access-Control-Expose-Headers&#39;</span>, <span style="color:#a50">&#39;AMP-Access-Control-Allow-Source-Origin&#39;</span>)
  res.setHeader(<span style="color:#a50">&#39;Access-Control-Allow-Credentials&#39;</span>, <span style="color:#a50">&#39;true&#39;</span>)
  <span style="color:#aaa;font-style:italic">// AMP-specific header, check your protocol
</span><span style="color:#aaa;font-style:italic"></span>  res.setHeader(<span style="color:#a50">&#39;AMP-Access-Control-Allow-Source-Origin&#39;</span>, <span style="color:#a50">&#39;https://&#39;</span> + domain)

  request.get({
    url: <span style="color:#a50">&#39;https://www.googletagmanager.com/amp.json&#39;</span>,
    qs: req.query,
    json: <span style="color:#00a">true</span>
  }, (err, response, data) =&gt; {

    <span style="color:#00a">if</span> (err) data = {<span style="color:#a50">&#34;vars&#34;</span>: {}}  <span style="color:#aaa;font-style:italic">// Add additional error handling here
</span><span style="color:#aaa;font-style:italic"></span>
    data.vars.clientId = clientId

    data.requests = <span style="color:#0aa">Object</span>.keys(data.requests)
      .reduce((map, key) =&gt; {
  
        map[key] = data.requests[key].replace(<span style="color:#099">/(&amp;cid=)[^&amp;]+/</span>, <span style="color:#a50">&#39;$1${clientId}&#39;</span>)
        <span style="color:#00a">return</span> map

      }, {})

    res.json(data)

  })

})
</code></pre></div>
<p>Here&rsquo;s another checklist, this time for combining your custom Client ID workaround with the Google Tag Manager AMP container. I&rsquo;ve bolded the new steps.</p>
<ul>
<li>
<p>In your page HTML:</p>
<ul>
<li>
<p>Add the <code>amp-analytics</code> script tag and <code>amp-analytics</code> component to your AMP templates.</p>
</li>
<li>
<p>Point <code>config</code> attribute to an endpoint or API on your own server.</p>
</li>
<li>
<p>Set <code>data-credentials</code> attribute to <code>include</code>.</p>
</li>
</ul>
</li>
<li>
<p>In your web server:</p>
<ul>
<li>
<p>In the request handler in your web server, extract the Client ID from the <code>_ga</code> cookie or generate a new one</p>
</li>
<li>
<p><strong>Request the container JSON from GTM, passing along all query parameters from the original <code>amp-analytics</code> request.</strong></p>
</li>
<li>
<p><strong>Replace all instances of &lsquo;CLIENT_ID(AMP_ECID_GOOGLE)&rsquo; in the request with &lsquo;${clientId}&rsquo;.</strong></p>
</li>
<li>
<p>Add the <code>clientId</code> parameter to the <code>vars</code> object in the JSON configuration. Set it to the Client ID from the <code>_ga</code> cookie.</p>
</li>
<li>
<p>Add the <code>Set-Cookie</code> header with the <code>_ga</code> cookie, set to expire in two years.</p>
</li>
<li>
<p>Set the <code>Access-Control-Allow-Origin</code> header to <code>https://cdn.ampproject.org</code>. Note: Wildcards (*) are invalid in this context.</p>
</li>
<li>
<p>Set the <code>Access-Control-Expose-Headers</code> header to <code>AMP-Access-Control-Allow-Source-Origin</code>.</p>
</li>
<li>
<p>Set the <code>Access-Control-Allow-Credentials</code> header to <code>true</code>.</p>
</li>
<li>
<p>Set the header <code>AMP-Access-Control-Allow-Source-Origin</code> to the source domain of the document (e.g. <code>https://mysite.com</code>).</p>
</li>
<li>
<p>Return the JSON configuration in the response body.</p>
</li>
</ul>
</li>
</ul>
<p>In your site code you&rsquo;ll need:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#aaa;font-style:italic">&lt;!-- Google Tag Manager --&gt;</span>
&lt;<span style="color:#1e90ff;font-weight:bold">amp-analytics</span> <span style="color:#1e90ff">config</span>=<span style="color:#a50">&#34;//www.yourdomain.com/gtm-analytics.config.json?id=GTM-XXXXX&amp;gtm.url=SOURCE_URL&#34;</span> <span style="color:#1e90ff">data-credentials</span>=<span style="color:#a50">&#34;include&#34;</span>&gt;&lt;/<span style="color:#1e90ff;font-weight:bold">amp-analytics</span>&gt;</code></pre></div>
<p>Congratulations, you have created a web proxy that fetches the Google Tag Manager container from Google&rsquo;s servers and modifies the JSON to leverage the value stored in the <code>_ga</code> cookie.</p>

                
                  <h2 id="google-tag-manager-proxy-with-wordpress">Google Tag Manager proxy with WordPress</h2>
<p>This blog is running on WordPress, so Simo wanted to see how trivial it would be to create the endpoint. As it turns out, it&rsquo;s very simple indeed.</p>
<p>WordPress provides the <a href="https://developer.wordpress.org/reference/hooks/rest_api_init/"><code>rest_api_init</code></a> hook, which lets you create an HTTP request endpoint on your web server:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">// REST API for GTM container
add_action( &#39;rest_api_init&#39;, function() {
    register_rest_route( 
        &#39;amp-gtm&#39;,
        &#39;/amp.json&#39;,
        array(
            &#39;methods&#39; =&gt; &#39;GET&#39;,
            &#39;callback&#39; =&gt; &#39;retrieve_gtm_json&#39;,
        )
    );
});</code></pre></div>
<p>That piece of code in your <strong>functions.php</strong> would create a GET request endpoint in your web domain path <code>/wp-json/amp-gtm/amp.json</code>. If a GET request to this endpoint is recorded, the callback function named <code>retrieve_gtm_json</code> is then invoked:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">// Generate random Client ID
function generate_ga_client_id() {
    return rand(100000000,999999999) . &#39;.&#39; . time();
}

// Set cookie to expire in 2 years
function getCookieExpirationDate() {
    return date(&#39;D, j F Y H:i:s&#39;, time() + 60*60*24*365*2);
}

// Callback for the GET request
function retrieve_gtm_json( $data ) {
    /* Get the hostname of the request origin, and parse it for the
     * pure domain name. */
    $domain = explode(&#39;:&#39;, $data-&gt;get_header(&#39;Host&#39;))[0];
    $domainName = str_replace(&#39;www.&#39;, &#39;&#39;, $domain);

    // Get the number of parts in the domain name
    $domainLength = count(explode(&#39;.&#39;, $domainName));

    /* Check if the browser already has the _ga cookie.
     * If not, generate a new cookie. */
    $cid = $_COOKIE[&#39;_ga&#39;];
    if (!isset($cid)) {
        $cid = &#34;GA1.{$domainLength}.&#34; . generate_ga_client_id();
    }

    /* Store the actual Client ID (last two numbers) of the
     * _ga cookie value in the $cidNumber variable */
    $cidNumber = preg_replace(&#39;/^GA.\.[^.]+\./&#39;,&#39;&#39;,$cid);
  
    // Get all HTTP request parameters
    $query = $_SERVER[&#39;QUERY_STRING&#39;];
    
    /* Fetch the actual GTM container, by passing the valid query parameters from
     * the original request. */
    $container = file_get_contents(&#34;https://www.googletagmanager.com/amp.json?{$query}&#34;);
    
    // Replace the <span style="color:#800;font-weight:bold">&amp;cid;</span> parameter value with ${clientId}
    $container = preg_replace(&#39;/(<span style="color:#f00;background-color:#faa">&amp;</span>cid=)[^<span style="color:#f00;background-color:#faa">&amp;</span>]+/&#39;,&#39;${1}${clientId}&#39;, $container);
  
    // Add the clientId to the &#34;vars&#34; object in the container JSON.
    $container = json_decode($container);
    $container-&gt;vars-&gt;clientId = $cidNumber;
    
    // Build a new HTTP response from the modified configuration file.
    $response = new WP_REST_RESPONSE( $container );
    
    // Add the required headers (Set-Cookie, most importantly) to the Request
    $response-&gt;header( &#39;Set-Cookie&#39;, &#34;_ga={$cid}; Path=/; Expires=&#34; . getcookieExpirationDate() . &#34; GMT; Domain={$domainName};&#34;);
    $response-&gt;header( &#39;Access-Control-Allow-Origin&#39;, &#39;https://cdn.ampproject.org&#39;);
    
    // Remember to check the protocol and change to http if that&#39;s where your domain is
    $response-&gt;header( &#39;AMP-Access-Control-Allow-Source-Origin&#39;, &#34;https://{$domain}&#34;);
    $response-&gt;header( &#39;Access-Control-Expose-Headers&#39;, &#39;AMP-Access-Control-Allow-Source-Origin&#39;);
    
    // Return the HTTP response.
    return $response;
}</code></pre></div>
<p>This is the API script that handles requests for the Google Tag Manager container. The proxy fetches the GTM container, and replaces the default Client ID with the AMP variable <code>${clientId}</code>. This, in turn, is added to the configuration JSON with the value retrieved from the <code>_ga</code> cookie. If the <code>_ga</code> cookie doesn&rsquo;t exist, a new one is generated.</p>
<p>In your site code, you&rsquo;ll need:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#aaa;font-style:italic">&lt;!-- Google Tag Manager --&gt;</span>
&lt;<span style="color:#1e90ff;font-weight:bold">amp-analytics</span> <span style="color:#1e90ff">config</span>=<span style="color:#a50">&#34;//www.yourdomain.com/wp-json/amp-gtm/amp.json?id=GTM-XXXXX&amp;gtm.url=SOURCE_URL&#34;</span> <span style="color:#1e90ff">data-credentials</span>=<span style="color:#a50">&#34;include&#34;</span>&gt;&lt;/<span style="color:#1e90ff;font-weight:bold">amp-analytics</span>&gt;</code></pre></div>
<p>This request is then passed to your endpoint, and the process described above will take place.</p>

                
                  <h2 id="google-analytics-setup">Google Analytics setup</h2>
<p>Not much has to be done in Google Analytics, but you will want to add <strong>ampproject.org</strong> into the <strong>Referral Exclusion List</strong> of your Google Analytics property settings. Otherwise, if the user follows any link from the cached AMP page to the rest of your site, the click will start a new session with a referral from ampproject.org.</p>
<p>Thanks to Adrian Vender for this tip!</p>

                
                  <h2 id="summary">Summary</h2>
<p>This is a fairly technical topic, but we, the authors, found it necessary to point out this potential flaw in how doing analytics in Accelerated Mobile Pages might be detrimental to your overall tracking plan.</p>
<p>The fact that AMP doesn&rsquo;t automatically leverage the <code>_ga</code> cookie if the request is to Google Analytics, for example, is a bit odd. Similarly, Google Tag Manager defaulting to <code>AMP_ECID_GOOGLE</code> is weird too, considering how much easier things would be if you could provide a cookie name or an AMP variable for the Client ID in the request.</p>
<p>Because Google&rsquo;s AMP cache is a different domain from your own, there&rsquo;s really no way around Client ID stitching that wouldn&rsquo;t involve the type of third-party cookie scheme as described in this guide. The request must be allowed to process the cookies written on your domain, so that the same <code>_ga</code> cookie value can be used on the pages in the external domain.</p>
<p>Luckily the technical solution to this dilemma is not too complicated. The proxy you create in your web server is simple, and should be easy to configure with any web server software. You might want to add some enhancements of your own, such as caching the Google Tag Manager container locally, and we&rsquo;d love to hear your tips and experiences in the comments below.</p>
<p>We hope this article gets your stAMP of approval, and that you&rsquo;ve learned an AMPle amount of new things. Sorry for the puns.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/amp/">amp</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/client-id/">client id</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/dan-wilkerson/">dan wilkerson</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-analytics/">google analytics</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/nodejs/">nodejs</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/guest-post/">guest post</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/log-failed-google-analytics-requests-google-analytics/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/accelerated-mobile-pages-via-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Analytics%20Client%20ID%20In%20AMP%20Pages%20https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/log-failed-google-analytics-requests-google-analytics/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/accelerated-mobile-pages-via-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Analytics%20Client%20ID%20In%20AMP%20Pages%20https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Google%20Analytics%20Client%20ID%20In%20AMP%20Pages%20https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

