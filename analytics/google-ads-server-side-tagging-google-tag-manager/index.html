

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Google Ads Conversion Tracking With Server-side Tagging In Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2021\/07\/google-ads-server-side-tagging-google-tag-manager.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/google-ads-server-side-tagging-google-tag-manager\/",
  "datePublished": "2021-07-16T07:00:00\u002b03:00",
  "dateModified": "2021-07-16T07:00:00\u002b03:00",
  "description": "How to run Google Ads Conversion Tracking in Google Tag Manager\u0027s Server-side Tagging environment.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Google Ads Conversion Tracking With Server-side Tagging In Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/google-ads-server-side-tagging-google-tag-manager/">
    
    <meta name="description" content="How to run Google Ads Conversion Tracking in Google Tag Manager&#39;s Server-side Tagging environment.">
    <meta property="og:description" content="How to run Google Ads Conversion Tracking in Google Tag Manager&#39;s Server-side Tagging environment.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Google Ads Conversion Tracking With Server-side Tagging In Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Google Ads Conversion Tracking With Server-side Tagging In Google Tag Manager">
    <meta name="twitter:description" content="How to run Google Ads Conversion Tracking in Google Tag Manager&#39;s Server-side Tagging environment.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
	  <meta property="og:image" content="https://www.simoahava.com/images/2021/06/google-ads-server-side-tagging-google-tag-manager.jpg">
      <meta name="twitter:image" content="https://www.simoahava.com/images/2021/06/google-ads-server-side-tagging-google-tag-manager.jpg">
    


    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
    <div class="figure nocaption">
      <img class="cover" src="https://www.simoahava.com/images/2021/06/google-ads-server-side-tagging-google-tag-manager.jpg">
    </div>
  
  

    <h1>
      Google Ads Conversion Tracking With Server-side Tagging In Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-07-16T07:00:00&#43;03:00">
        
  July 16, 2021

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>One of the biggest blockers for <a href="https://tagmanager.google.com/">Google Tag Manager&rsquo;s</a> <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">server-side tagging</a> to slip out of <em>beta</em> is <strong>Google Ads</strong>. Until server-side tagging supports a solution for both <strong>conversions</strong> and <strong>remarketing</strong> capabilities to be reproduced server-side, it&rsquo;s unlikely that Server containers will lose their beta label.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/07/google-ads-server-side-tagging-google-tag-manager.jpg" title="google-ads-server-side-tagging-google-tag-manager.jpg">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/07/google-ads-server-side-tagging-google-tag-manager.jpg#ZgotmplZ" alt="google-ads-server-side-tagging-google-tag-manager.jpg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1104 678'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>While I can&rsquo;t say what will happen to the beta label now, the fact is that Google Tag Manager <strong>has now released support for Conversion tracking</strong> using server-side tagging.</p>
<p>The whole thing is quite &hellip; interesting, as it involves not just <strong>server-to-vendor</strong> calls, but also <strong>browser-to-server-to-browser-to-vendor</strong> requests. Why? Maybe you guessed it: <em>third-party cookies</em>.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[–hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#the-components-youll-need">The components you&rsquo;ll need</a></li>
    <li><a href="#web-update-the-ga4-config-tag">Web: Update the GA4 Config tag</a>
      <ul>
        <li><a href="#how-it-works">How it works</a></li>
      </ul>
    </li>
    <li><a href="#server-create-a-conversion-linker-tag">Server: Create a Conversion Linker tag</a>
      <ul>
        <li><a href="#how-it-works-1">How it works</a></li>
      </ul>
    </li>
    <li><a href="#server-create-a-google-ads-conversion-tracking-tag">Server: Create a Google Ads Conversion Tracking tag</a>
      <ul>
        <li><a href="#how-it-works-2">How it works</a></li>
      </ul>
    </li>
    <li><a href="#interaction-with-consent-mode">Interaction with Consent Mode</a>
      <ul>
        <li><a href="#if-consent-is-denied">If consent is denied</a></li>
        <li><a href="#if-consent-changes-to-granted">If consent changes to granted</a></li>
      </ul>
    </li>
    <li><a href="#new-api">New API</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>
<p>In this article, I&rsquo;ll show you how to set things up (surprisingly simple), and I&rsquo;ll also try to shed some light on how the whole setup actually works (surprisingly difficult).</p>
<p>Here is the official documentation on Google Ads and Server-side Tagging: <a href="https://developers.google.com/tag-manager/serverside/ads-setup">Google Ads conversions (Google)</a>.</p>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="the-components-youll-need">The components you&rsquo;ll need</h2>
<p>In the <strong>web container</strong>, you need to reconfigure the <strong>Google Analytics 4</strong> Config tag to send the data to the Server container using the new <strong>Send to server container</strong> option. This replaces the <code>transport_url</code> setting you&rsquo;ll have used until now.</p>
<blockquote>
<p><strong>Note!</strong> Server-side tagging with Google Ads <em>only works with Google Analytics 4</em>. It will <strong>not</strong> work with Universal Analytics tags.</p>
</blockquote>
<p>The point here is that you&rsquo;ll use your GA4 web tag(s) to send the conversion events to the Server container, where they will then be mapped accordingly.</p>
<p>In the <strong>Server</strong> container, you&rsquo;ll need these two tags:</p>
<ul>
<li>A <strong>Conversion Linker</strong> tag for sending the landing page beacons to Google as well as for writing the first-party cookies with the ad click information.</li>
<li><strong>Google Ads Conversion Tracking</strong> tag(s) for tracking the conversions themselves.</li>
</ul>
<p>Both of these are new, built-in tag templates in all Server containers.</p>
<p>Let&rsquo;s start from the top.</p>

                
                  <h2 id="web-update-the-ga4-config-tag">Web: Update the GA4 Config tag</h2>
<p>For the Google Ads setup to work, you&rsquo;ll need to update the <strong>Google Analytics: GA4 Configuration</strong> tag to use the new <strong>Send to server container</strong> setting, and you&rsquo;ll need to <strong>remove</strong> the <code>transport_url</code> field.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/send-to-server-container.jpg" title="Send to server container">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/send-to-server-container.jpg#ZgotmplZ" alt="Send to server container" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1788 1254'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>You need to populate the <strong>Send to server container</strong> setting with the exact same value you populated <code>transport_url</code> with: the <em>origin</em> of the Server container, i.e. the URL up to the path selector. See the image above for an example.</p>
<h3 id="how-it-works">How it works</h3>
<p>When you set the new <strong>Send to server container</strong> setting, it does two things.</p>
<ol>
<li>It sets the <code>transport_url</code> to point to the Server container.</li>
<li>It sets the <code>first_party_collection</code> field to <code>true</code>.</li>
</ol>
<p>The second is quite important in this scenario. The purpose of the field is to tell GA4 (in the web) that the target machine is <strong>not</strong> a computer owned by Google Analytics. This means that it enables the protocol to share potentially sensitive data, as the Server container is something owned by the company running the website (hopefully) and not Google Analytics.</p>
<p>When <code>first_party_collection</code> is enabled, GA4 will use a new protocol that allows the Server container to communicate <em>back</em> to the browser.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/07/server-conversion-response.jpg" title="Response back from the server using the new protocol">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/07/server-conversion-response.jpg#ZgotmplZ" alt="Response back from the server using the new protocol" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2336 220'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This protocol is essentially a response message, which is then parsed by the GA4 web tags, and they will react accordingly (e.g. send the request to the <strong>DoubleClick domain</strong> as in the example above).</p>
<p>We&rsquo;ll return to this topic, but suffice to say this is done <em>because Conversion Tracking still makes use of <strong>third-party cookies</strong></em>.</p>

                
                  <h2 id="server-create-a-conversion-linker-tag">Server: Create a Conversion Linker tag</h2>
<p>In the <strong>Server container</strong>, create a new Conversion Linker tag. You&rsquo;ll find it in the list of built-in tag templates.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/conversion-linker.jpg" title="Conversion Linker">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/conversion-linker.jpg#ZgotmplZ" alt="Conversion Linker" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1846 1042'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>There&rsquo;s a new built-in trigger called <strong>All Pages</strong> in the Server container. Add that to the tag, as you&rsquo;ll want the Conversion Linker to activate on all pages.</p>
<p>The <strong>All Pages</strong> trigger fires whenever there&rsquo;s an event named <code>page_view</code> generated by a Server container Client.</p>
<h3 id="how-it-works-1">How it works</h3>
<p>The Conversion Linker tag does two things.</p>
<ol>
<li>It sends a <strong>landing page beacon</strong> to the Google Ads server.</li>
<li>If the page URL has the <code>gclid</code> parameter, or if there are Google Ads&rsquo; first-party cookies in the request, the tag will set the new <code>FPGCLAW</code> cookie in the response, writing the click ID to storage.</li>
</ol>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2021/06/landing-page-beacon.jpg" title="The landing page beacon sent to Google Ads servers">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/landing-page-beacon.jpg#ZgotmplZ" alt="The landing page beacon sent to Google Ads servers" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1806 586'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">The landing page beacon sent to Google Ads servers</span>
  
</div>


<p>The landing page beacon is very non-descript. It&rsquo;s just a ping to Google Ads with the current URL. Naturally, the URL might contain the <code>gclid</code> parameter, so I&rsquo;m guessing this is used to validate clicks on ads.</p>



<div class="figure " >
  
    <a href="https://www.simoahava.com/images/2021/06/fpgclaw-cookie.jpg" title="The FPGCLAW cookie written with a 3-month expiration">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/fpgclaw-cookie.jpg#ZgotmplZ" alt="The FPGCLAW cookie written with a 3-month expiration" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1924 70'%3E%3C/svg%3E">
  
    </a>
  
   
    <span class="caption">The FPGCLAW cookie written with a 3-month expiration</span>
  
</div>


<p>The <code>FPGCLAW</code> cookie seems to just replicate the pre-existing Google Ads cookies in that it writes the Google Ads Click ID into a first-party cookie. Naturally, as it&rsquo;s done in a <code>Set-Cookie</code> server response, it&rsquo;s better warded against <a href="https://www.cookiestatus.com/">tracking protections</a>.</p>

                
                  <h2 id="server-create-a-google-ads-conversion-tracking-tag">Server: Create a Google Ads Conversion Tracking tag</h2>
<p>Next, you can go ahead and create a <strong>Google Ads Conversion Tracking</strong> tag in the server. You configure it exactly as you would configure the same tag in a web container.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/google-ads-conversion-tag.jpg" title="Google Ads Conversion tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/google-ads-conversion-tag.jpg#ZgotmplZ" alt="Google Ads Conversion tag" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1862 2094'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Set it to fire on whatever trigger you want to use for this particular conversion. In the example above, I&rsquo;m using an <code>add_to_cart</code> event generated by the GA4 Client.</p>
<h3 id="how-it-works-2">How it works</h3>
<p>This is where things get interesting.</p>
<p>If there&rsquo;s a first-party click ID available, such as the one stored in <code>FPGCLAW</code> by the Conversion Linker tag, the Server container sends the conversion event directly to Google Ads servers.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/google-ads-conversion.jpg" title="Google Ads Conversion hit">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/google-ads-conversion.jpg#ZgotmplZ" alt="Google Ads Conversion hit" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1790 582'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>This is a &ldquo;normal&rdquo; Google Ads Conversion request. It contains the conversion ID, the conversion label, and the Click ID in the <code>gclaw</code> parameter, among other things.</p>
<p>But when you then look at the <em>response</em> back from the Google server, you&rsquo;ll see it&rsquo;s a 302 redirect to the DoubleClick domain.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/conversion-doubleclick.jpg" title="Conversion DoubleClick">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/conversion-doubleclick.jpg#ZgotmplZ" alt="Conversion DoubleClick" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1780 914'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Why? Because the Google Ads Conversion tag needs to communicate with the DoubleClick domain to stitch the conversion information with the user&rsquo;s identity, and this requires DoubleClick to read its cookies in third-party context.</p>
<p><strong>However</strong>, since the Server container can&rsquo;t work with third-party cookies, things get complicated.</p>
<p>What happens is that the <strong>HTTP response</strong> back from the Server (i.e. for the <code>add_to_cart</code> event) contains a message that instructs the GA4 library <strong>in the browser</strong> to compose the DoubleClick request instead.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/server-response-add-to-cart.jpg" title="Server response to add to cart">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/server-response-add-to-cart.jpg#ZgotmplZ" alt="Server response to add to cart" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2698 254'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>And sure enough, if you look at the network requests (in a browser that supports third-party cookies), you&rsquo;ll see the browser requests to Google servers:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/google-server-requests.jpg" title="Google server requests">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/google-server-requests.jpg#ZgotmplZ" alt="Google server requests" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3300 146'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In case the browser <strong>doesn&rsquo;t</strong> have first-party click ID information stored, the Server container <strong>doesn&rsquo;t</strong> send a direct request to Google servers. Instead, it just instructs the browser to send the requests, so that the third-party cookies can be picked up.</p>
<p>Please don&rsquo;t ask me what happens if the browser doesn&rsquo;t support third-party cookies. My guess is that if the Click ID is present, your conversion measurement will work just fine. However, there might be limitations on what type of audiences you can use or build for conversion tracking, because the click and the conversion can&rsquo;t be attributed to a generic Google user without third-party cookies.</p>
<p>Similarly, if the first-party Click ID is <em>not</em> available, I&rsquo;m guessing Google uses third-party cookies to see if the user has interacted with the ad nevertheless. So you&rsquo;ll lose that fallback if third-party cookies are not supported.</p>

                
                  <h2 id="interaction-with-consent-mode">Interaction with Consent Mode</h2>
<p>What about <a href="https://www.simoahava.com/analytics/consent-mode-google-tags/">Consent Mode</a>? What happens if <code>ad_storage</code> is denied? Or what if it&rsquo;s subsequently granted?</p>
<h3 id="if-consent-is-denied">If consent is denied</h3>
<p>First, the <strong>Conversion Linker</strong> tag sends the <em>landing beacon</em> ping to Google servers, but it <em>doesn&rsquo;t write the <code>FPGCLAW</code> cookie</em> in the HTTP response.</p>
<p>The landing page beacon includes parameters which state that Consent Mode is active. These instruct Google to ignore any identifiers in the request and only collect anonymous data for conversion modeling.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/consent-mode-linker-ping.jpg" title="Consent mode parameters in the linker ping">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/consent-mode-linker-ping.jpg#ZgotmplZ" alt="Consent mode parameters in the linker ping" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1794 598'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The <strong>Conversion Tracking tag</strong> sends the server-to-server request normally, whether a first-party click identifier is available or not:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/conversion-consent-mode.jpg" title="Conversion tracking without consent">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/conversion-consent-mode.jpg#ZgotmplZ" alt="Conversion tracking without consent" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1798 704'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>If the page URL has the <code>gclid</code> parameter, then that is sent to Google Ads (as in this scenario no Ads cookies are needed).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/conversion-ping-with-click-id-consent.jpg" title="Conversion ping with the Click ID">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/conversion-ping-with-click-id-consent.jpg#ZgotmplZ" alt="Conversion ping with the Click ID" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1810 714'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="if-consent-changes-to-granted">If consent changes to granted</h3>
<p>If, however, consent <em>changes</em> to <strong>granted</strong>, the GA4 web tag reacts.</p>
<p>The <code>page_view</code> hit is immediately resent to the Server container. This time it doesn&rsquo;t have the consent restrictions in place, so both GA4 tags and Google Ads tags will be able to benefit from the regular, cookies-enabled ping.</p>
<p>This means that the Conversion Linker (assuming it fired on All Pages) will fire again and this time rewrite the <code>FPGCLAW</code> cookie.</p>
<p>In addition to this, <strong>any other event you have <a href="https://support.google.com/analytics/answer/9267568?hl=en#zippy=%2Cin-this-article">marked as a conversion</a> in the Google Analytics 4 user interface</strong> will <em>also</em> get sent again.</p>
<p>In other words, if you want your <code>add_to_cart</code> Google Ads conversion event to be sent with cookies and full capabilities as soon as consent is granted, you need to go into the Google Analytics 4 UI and mark the <code>add_to_cart</code> event as a conversion.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2021/06/add_to_cart-conversion.jpg" title="add_to_cart as a conversion">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2021/06/add_to_cart-conversion.jpg#ZgotmplZ" alt="add_to_cart as a conversion" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2278 482'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The GA4 UI will instruct the <code>gtag.js</code> library to account for the <code>add_to_cart</code> conversion event when sending the hits again after consent is granted. You need to do this for <strong>all</strong> events that you want the library to send again once consent is granted!</p>
<blockquote>
<p>Note! Even though the hits are sent again, the Server container will prevent tags from triggering again unless they support <code>ad_storage</code>.</p>
</blockquote>
<p>By the way, this applies to <code>analytics_storage</code> as well (of course nothing is sent to Ads in this case). When <code>analytics_storage</code> is set to <code>'granted'</code>, GA4 collects the <code>page_view</code> and all previously sent, cookieless conversion events again automatically.</p>

                
                  <h2 id="new-api">New API</h2>
<p>Finally, there&rsquo;s a new <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">Custom Template</a> API: <code>sendPixelFromBrowser</code>. This API works together with a GA4 web tag. If the API is invoked and the request originated from a GA4 web tag, the API sends the pixel request back to the browser using the same protocol as the Google Ads tags above.</p>
<p>The GA4 web tag then picks up this instruction and sends the request via the browser.</p>
<p>This means that other vendors that require third-party cookies to run can utilize this API to engineer their templates to use the browser rather than direct server-to-server hits.</p>
<blockquote>
<p>Note! This <em>only</em> works with a GA4 web tag. If the request originates from some other dispatch source, the API will not work as intended.</p>
</blockquote>

                
                  <h2 id="summary">Summary</h2>
<p>As you can see, setting up Google Ads tracking is quite simple. But understanding the <em>flow</em> is another thing indeed.</p>
<p>I&rsquo;m actually somewhat disappointed at how the setup works. I&rsquo;m not saying I don&rsquo;t think it&rsquo;s a good piece of software – it is! I just dislike the fact that it relies on third-party cookies.</p>
<p>Forcing the browser to do all the legwork means that some of the most important security benefits of server-side tagging (reliance on first-party connections only, stricter Content-Security Policies) need to be abandoned in favor of getting more data.</p>
<p>I&rsquo;m wondering why Google isn&rsquo;t pushing more aggressively for a first-party-only approach such as <a href="https://support.google.com/google-ads/answer/10172785">Enhanced Conversions</a>. I&rsquo;m not really a big fan of this, either, but at least the website and server-side tagging setup would retain control, rather than having it relinquished to third-party requests that originate in the browser.</p>
<p>Maybe Google is waiting for a resolution on the <a href="https://privacysandbox.com/">Privacy Sandbox</a> initiative before making drastic changes to their data collection methods. Who knows?</p>
<p>Well, anyway. I think this setup for Google Ads is pretty neat simply because it&rsquo;s very <em>frictionless</em> (the above issues with security notwithstanding). Setting it up is just as &ldquo;easy&rdquo; as setting up the respective components in the web container.</p>
<p>I think the protocol for instructing the browser to do something is a genius piece of work, but I do worry about the increased reliance on GA4 and gtag.js for server-side tagging to work its magic. It&rsquo;s not a trend I&rsquo;d like to see more of in the future, but I have a hunch that Google will push for a tighter and tighter integration as time goes by.</p>
<p>Please let me know in the comments if you have any thoughts to share on this topic!</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side-tagging/">server-side tagging</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-ads/">google ads</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/cross-domain-tracking-server-side-fpid-cookie/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/deploy-server-side-google-tag-manager-aws/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Ads%20Conversion%20Tracking%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/cross-domain-tracking-server-side-fpid-cookie/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/deploy-server-side-google-tag-manager-aws/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Google%20Ads%20Conversion%20Tracking%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Google%20Ads%20Conversion%20Tracking%20With%20Server-side%20Tagging%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-ads-server-side-tagging-google-tag-manager/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
    
    <script>
      !function(){
  var baitPath = 'https://sgtm.simoahava.com/ads-min.js';
  var pixelPath = 'https://sgtm.simoahava.com/4dchk';
  var e=document.createElement("script");e.src=baitPath,document.body.appendChild(e);var t=!1;fetch("https://www.google-analytics.com/analytics.js",{method:"HEAD",mode:"no-cors"}).catch(function(){t=!0}),window.addEventListener("load",function(){var e={adb_blocked:!document.querySelector("#ECKckuBYwZaP"),gtm_blocked:!(window.google_tag_manager&&window.google_tag_manager.dataLayer),ga_blocked:t},o=document.createElement("img");o.style="width: 1; height: 1; display: none;",o.src=pixelPath+"?"+Object.keys(e).reduce(function(t,o){return t.concat(o+"="+e[o])},[]).join("&"),document.body.appendChild(o)})}();

</script>
      

    
  </body>
</html>

