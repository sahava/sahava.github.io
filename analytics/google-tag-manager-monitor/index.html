

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "How To Build A Google Tag Manager Monitor | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/07\/google-tag-manager-monitor.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/google-tag-manager-monitor\/",
  "datePublished": "2019-07-07T11:49:15\x2b03:00",
  "dateModified": "2019-07-07T11:49:15\x2b03:00",
  "description": "How to build a monitor system for Google Tag Manager, where the rate and success of tags firing on your website is logged into BigQuery for analysis and anomaly detection.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>How To Build A Google Tag Manager Monitor | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/google-tag-manager-monitor/">
    
    <meta name="description" content="How to build a monitor system for Google Tag Manager, where the rate and success of tags firing on your website is logged into BigQuery for analysis and anomaly detection.">
    <meta property="og:description" content="How to build a monitor system for Google Tag Manager, where the rate and success of tags firing on your website is logged into BigQuery for analysis and anomaly detection.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="How To Build A Google Tag Manager Monitor">
    <meta property="og:url" content="https://www.simoahava.com/analytics/google-tag-manager-monitor/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How To Build A Google Tag Manager Monitor">
    <meta name="twitter:description" content="How to build a monitor system for Google Tag Manager, where the rate and success of tags firing on your website is logged into BigQuery for analysis and anomaly detection.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/07/google-tag-manager-monitor.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/07/google-tag-manager-monitor.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      How To Build A Google Tag Manager Monitor
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-07-07T11:49:15&#43;03:00">
        
  July 7, 2019

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/google-tag-manager-monitor/#commento">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p><a href="https://tagmanager.google.com/">Google Tag Manager</a> is strictly a <em>tag delivery system</em>, and it's very careful <a href="https://support.google.com/tagmanager/answer/9323295#data">not to collect any analytics data</a> on its own. This is most likely a deliberate choice, because if GTM was to start collecting data, it would introduce additional barriers to adoption.</p>
<p>Nevertheless, being a tool that consolidates the design, development, deployment, and testing of all the marketing and analytics pixels, code snippets, and utilities running on a website or a mobile app, lacking the necessary features for auditing and monitoring has always seemed like an oversight.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/google-tag-manager-monitor.jpg" title="Google Tag Mangager Monitor">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/google-tag-manager-monitor.jpg#ZgotmplZ" alt="Google Tag Mangager Monitor">
  
    </a>
  
  
</div>


<p>Recently, Google Tag Manager introduced a new API for <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom templates</a>: <a href="https://developers.google.com/tag-manager/templates/api#addEventCallback"><code>addEventCallback</code></a>. This API lets you create your own monitoring system for your container. With community effort and support from Google, the new API will introduce a number of solutions around tag monitoring and auditing in the near future.</p>
<p>In this article, <strong>Mark Edmondson</strong> and I will help you get started. We’ll introduce how the new API works and how you can use it to build the necessary tags and triggers in GTM for monitoring purposes. We’ll also show you how to use powerful, cheap, and scalable features of the <a href="https://cloud.google.com/">Google Cloud Platform</a> to create the backend for the monitoring system, and finally we’ll give you some ideas for how to visualize the data in a <a href="https://datastudio.google.com/">Google Data Studio</a> report.</p>
<p>You can also check out <a href="https://youtu.be/OGvsFTEXFGc">this video</a>, where I go through (almost) the same steps in video format.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/OGvsFTEXFGc?enablejsapi=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
  <ul>
    <li><a href="#guest-author-mark-edmondson">Guest author: Mark Edmondson</a></li>
    <li><a href="#what-well-build-the-google-tag-manager-monitor">What we'll build: The Google Tag Manager Monitor</a></li>
    <li><a href="#why-do-we-need-a-monitor">Why do we need a monitor?</a></li>
    <li><a href="#step-1-build-the-custom-template">Step 1: Build the custom template</a>
      <ul>
        <li><a href="#11-fields">1.1. Fields</a>
          <ul>
            <li><a href="#111-endpoint-field">1.1.1. endPoint field</a></li>
            <li><a href="#112-batchhits-field">1.1.2. batchHits field</a></li>
            <li><a href="#113-maxtags-field">1.1.3. maxTags field</a></li>
          </ul>
        </li>
        <li><a href="#12-code">1.2. Code</a></li>
        <li><a href="#13-permissions">1.3. Permissions</a></li>
      </ul>
    </li>
    <li><a href="#step-2-tags-and-triggers">Step 2: Tags and triggers</a>
      <ul>
        <li><a href="#21-create-the-monitor-tag">2.1. Create the monitor tag</a></li>
        <li><a href="#22-the-additional-tag-metadata-setting">2.2. The Additional Tag Metadata setting</a></li>
        <li><a href="#23-update-all-your-tags">2.3. Update all your tags</a></li>
      </ul>
    </li>
    <li><a href="#step-3-creating-the-google-cloud-platform-endpoint">Step 3: Creating the Google Cloud Platform endpoint</a>
      <ul>
        <li><a href="#31-choosing-the-gcp-solution-for-the-endpoint">3.1. Choosing the GCP solution for the endpoint</a>
          <ul>
            <li><a href="#311-pixel-tracking-via-a-load-balancer">3.1.1. Pixel tracking via a load balancer</a></li>
            <li><a href="#312-app-engine">3.1.2. App Engine</a></li>
            <li><a href="#313-technology-of-choice-cloud-functions">3.1.3. Technology of choice: Cloud Functions</a></li>
          </ul>
        </li>
        <li><a href="#32-bigquery-setup">3.2. BigQuery setup</a></li>
        <li><a href="#33-the-cloud-function-code">3.3. The Cloud Function Code</a>
          <ul>
            <li><a href="#331-code-walkthrough">3.3.1. Code walkthrough</a></li>
            <li><a href="#332-create-and-deploy-the-cloud-function">3.3.2. Create and deploy the Cloud Function</a></li>
          </ul>
        </li>
        <li><a href="#34-update-the-google-tag-manager-monitor-tag">3.4. Update the Google Tag Manager Monitor tag</a></li>
        <li><a href="#35-parsing-bigquery-raw-data-into-a-view">3.5. Parsing BigQuery raw data into a view</a></li>
      </ul>
    </li>
    <li><a href="#step-4-visualize-the-data">Step 4: Visualize the data</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
<h2 id="guest-author-mark-edmondson">Guest author: Mark Edmondson</h2>
<p><a href="https://twitter.com/holomarked">Mark Edmondson</a> is a former colleague of mine, a fellow <a href="https://google-developers.appspot.com/community/experts/directory/profile/profile-mark_edmondson">Google Developer Expert</a> for Google Analytics, and the owner of one of the most versatile skill sets in our industry. He's currently working as a data engineer at <a href="https://iihnordic.com/">IIH Nordic</a> (a great company full of nice folks in its own right!).</p>
<p>Mark is fluent in bridging together the worlds of marketing and analytics, and his reach extends far beyond, as evidenced by his <a href="https://github.com/MarkEdmondson1234/">prolific contributions to the open-source space</a>. He’s the author of the popular <a href="https://github.com/MarkEdmondson1234/googleAnalyticsR">googleAnalyticsR</a> library for R, and <a href="https://www.markedmondson.me/">his blog</a> is full of great walkthroughs for data engineering, data science, web analytics, and software development.</p>
<p>Being one of the most humble people I’ve met, he’s probably royally embarrassed by this introduction. So I’ll just wrap up this introduction by making it clear how grateful I am for his contributions not just to this article but to our whole industry.</p>
<h2 id="what-well-build-the-google-tag-manager-monitor">What we'll build: The Google Tag Manager Monitor</h2>
<p>The <strong>key deliverable</strong> of this little project is a <a href="https://cloud.google.com/bigquery/">BigQuery</a> view that collects data from your website. This data will be sent by way of a new Google Tag Manager custom template, and it will comprise statistics of all the tags that have fired on your site for any given <code>dataLayer</code> event.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/bigquery-view.jpg" title="BigQuery view">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/bigquery-view.jpg#ZgotmplZ" alt="BigQuery view">
  
    </a>
  
  
</div>


<p>In this proof-of-concept, the metadata collected from each <code>dataLayer</code> event includes:</p>
<ul>
<li>
<p>Event name and timestamp (to uniquely distinguish events with the same name from each other).</p>
</li>
<li>
<p>Tag ID, name, firing status, and execution time for every tag that fired for that event (or <code>null</code> if no tags fired for the event).</p>
</li>
</ul>
<p>It's extremely easy to extend this solution to include things like Container ID or tag categorization information - we'll explore these later in the guide.</p>
<h2 id="why-do-we-need-a-monitor">Why do we need a monitor?</h2>
<p>There aren’t that many ways to monitor the consistency of tags firing in your containers. Obviously, you can run reports against the various endpoints, such as Google Analytics or Facebook, and detect anomalous data collection through their reporting interfaces.</p>
<p>But this has some problems:</p>
<ul>
<li>
<p>Not all endpoints have reports readily available.</p>
</li>
<li>
<p>With endpoints collecting data from multiple different sources, it’s difficult to identify those that come from GTM and those that do not.</p>
</li>
<li>
<p>It’s difficult to know if the data issues in the endpoints are due to data collection or something else (e.g. a broken filter in Google Analytics).</p>
</li>
</ul>
<p>In other words, if you want to be alerted to issues in data collection, the best way to do this is to monitor the data collection itself.</p>
<p>For this to be possible, the data collection mechanism requires the possibility to introduce a <strong>side effect</strong>. The side effect in this case is the <code>addEventCallback</code> API, and its purpose is to collect metadata about the data collection preferably to an endpoint that is <strong>separated from the tags that are being monitored</strong>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/process-flow.jpg" title="Process flow">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/process-flow.jpg#ZgotmplZ" alt="Process flow">
  
    </a>
  
  
</div>


<p>Why have a separate endpoint for monitoring? Well, it wouldn’t really make sense to collect data about Google Analytics’ data collection in Google Analytics itself (a custom reporting property, for example), because if the analytics data collection fails due to not being able to connect to the GA endpoint, then the monitoring data collection would fail as well.</p>
<p>That is why this article utilizes an endpoint in the Google Cloud Platform to collect the data. It’s not failsafe, either, since if the data collection fails due to a network outage, the collection to GCP would fail, too. Even though there are ways to tackle this problem as well, we’ll try to keep things at an MVP (minimum viable product) level, and you can then extend the solution to fit your more elaborate needs.</p>
<h2 id="step-1-build-the-custom-template">Step 1: Build the custom template</h2>
<p>The custom <strong>tag</strong> template will create a <strong>callback</strong> that is called every time a <code>dataLayer</code> event reaches conclusion. This is basically the same thing as the <a href="https://www.simoahava.com/gtm-tips/hitcallback-eventcallback/">eventCallback</a> of Google Tag Manager, just wrapped in a template API.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/data-object.jpg" title="The data object">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/data-object.jpg#ZgotmplZ" alt="The data object">
  
    </a>
  
  
</div>


<p>When the callback is invoked, an array of tags is passed to the callback in a data object. Each tag is reported with the following metadata:</p>
<ul>
<li>
<p><code>id</code>: Tag ID</p>
</li>
<li>
<p><code>status</code>: Firing status (e.g. success, failure)</p>
</li>
<li>
<p><code>executionTime</code>: Execution time in milliseconds</p>
</li>
</ul>
<p>We’ll augment this data set with these values:</p>
<ul>
<li>
<p><code>eventName</code> and <code>eventTimestamp</code> (to uniquely identify each event)</p>
</li>
<li>
<p><code>name</code>: Tag name</p>
</li>
</ul>
<p>It’s easiest to show by doing.</p>
<p>In Google Tag Manager, open up the <strong>Templates</strong> view, and create a new tag template.</p>
<p>You can also download the template from <a href="https://github.com/sahava/GoogleTagManagerTemplates/tree/master/tags/Utilities/GoogleTagManagerMonitor">here</a> and <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#importing-and-exporting">import</a> it directly into your container.</p>
<h3 id="11-fields">1.1. Fields</h3>
<p>Feel free to add whatever you want into the <strong>Info</strong> tab of template. We went with this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/info-tab.jpg" title="Info tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/info-tab.jpg#ZgotmplZ" alt="Info tab">
  
    </a>
  
  
</div>


<p>In the Fields tab, we’re going with two default fields. One for the <strong>endpoint URL</strong>, and one to let the user decide whether to <strong>batch</strong> the hits or not.</p>
<p>There is a third field as well, which becomes available if the user decided to batch the hits.</p>
<h4 id="111-endpoint-field">1.1.1. <code>endPoint</code> field</h4>
<p>The first field is a <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#text-input">Text input</a> field named <code>endPoint</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/endpoint-field.jpg" title="Endpoint field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/endpoint-field.jpg#ZgotmplZ" alt="Endpoint field">
  
    </a>
  
  
</div>


<p>It has the following <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#field-configuration">Field configurations</a> toggled on:</p>
<ul>
<li>
<p><strong>Value hint</strong>: <code>e.g. https://track.com/collect</code></p>
</li>
<li>
<p><strong>Display name</strong>: <code>GET request endpoint</code></p>
</li>
<li>
<p><strong>Help text</strong>: <code>Provide the URL to which the GET request with tag data is sent.</code></p>
</li>
<li>
<p><strong>Always in summary</strong>: checked</p>
</li>
<li>
<p><strong>Validation rules</strong></p>
</li>
</ul>
<p>There are two <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#validation-rules">validation rules</a>:</p>
<ul>
<li>
<p><strong>This value cannot be empty</strong></p>
</li>
<li>
<p><strong>This value must match a regular expression</strong>: <code>^https://.+</code></p>
</li>
</ul>
<p>If you want, you can add some customized error messages to these validation rules by opening the Advanced settings for each rule.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/validation-rules-advanced-settings.jpg" title="Validation rules advanced settings">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/validation-rules-advanced-settings.jpg#ZgotmplZ" alt="Validation rules advanced settings">
  
    </a>
  
  
</div>


<h4 id="112-batchhits-field">1.1.2. <code>batchHits</code> field</h4>
<p>The second field is a <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#radio-buttons">Radio button</a> field named <code>batchHits</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/batchhits.jpg" title="Batch hits field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/batchhits.jpg#ZgotmplZ" alt="Batch hits field">
  
    </a>
  
  
</div>


<p>It has the following Field configurations toggled on:</p>
<ul>
<li>
<p><strong>Display name</strong>: <code>Batch hits</code></p>
</li>
<li>
<p><strong>Help text</strong>: <code>If you select No, details of all the tags that fired for any given hit are sent in a single GET request. If you select Yes, you can choose the maximum number of tags per request, and the tag will automatically send multiple requests if necessary.</code></p>
</li>
</ul>
<p>There are two radio buttons.</p>
<p>The <strong>first</strong> one is named <code>No</code>, and has the value <code>no</code>.</p>
<p>The <strong>second</strong> one is named <code>Yes</code>, and has the value <code>yes</code>.</p>
<p>The Yes button has a nested field (found after showing advanced settings for the button), which is a <strong>Text input</strong> field named <code>maxTags</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/radio-yes-nested-field.jpg" title="Radio button nested field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/radio-yes-nested-field.jpg#ZgotmplZ" alt="Radio button nested field">
  
    </a>
  
  
</div>


<h4 id="113-maxtags-field">1.1.3. <code>maxTags</code> field</h4>
<p>The <em>nested</em> <code>maxTags</code> field is a <strong>Text input</strong> field where the user can set a limit of tags sent per request.</p>
<p>This is useful if you have tags with long names or <code>dataLayer</code> events that can fire dozens of tags at a time. Sending the requests in batches should reduce the effort required in the endpoint to parse the data into the BigQuery table.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/maxtags-field.jpg" title="maxTags field">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/maxtags-field.jpg#ZgotmplZ" alt="maxTags field">
  
    </a>
  
  
</div>


<p>The field has the following Field configurations toggled on:</p>
<ul>
<li>
<p><strong>Display name</strong>: <code>Maximum number of tags per request</code></p>
</li>
<li>
<p><strong>Help text</strong>: <code>Enter the maximum number of tags per request that will be dispatched to the endpoint. If necessary, multiple requests will be made.</code></p>
</li>
<li>
<p><strong>Default value</strong>: <code>10</code></p>
</li>
<li>
<p><strong>Validation rules</strong></p>
</li>
</ul>
<p>The sole validation rule is <strong>This value must be a positive integer</strong>.</p>
<h3 id="12-code">1.2. Code</h3>
<p>In the <strong>Code</strong> tab, add the following code:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#aaa;font-style:italic">// Require the necessary APIs
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> addEventCallback = require(<span style="color:#a50">&#39;addEventCallback&#39;</span>);
<span style="color:#00a">const</span> readFromDataLayer = require(<span style="color:#a50">&#39;copyFromDataLayer&#39;</span>);
<span style="color:#00a">const</span> sendPixel = require(<span style="color:#a50">&#39;sendPixel&#39;</span>);
<span style="color:#00a">const</span> getTimestamp = require(<span style="color:#a50">&#39;getTimestamp&#39;</span>);

<span style="color:#aaa;font-style:italic">// Get the dataLayer event that triggered the tag
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> event = readFromDataLayer(<span style="color:#a50">&#39;event&#39;</span>);

<span style="color:#aaa;font-style:italic">// Add a timestamp to separate events named the same way from each other
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> eventTimestamp = getTimestamp();

<span style="color:#00a">const</span> endPoint = data.endPoint;
<span style="color:#00a">const</span> batchHits = data.batchHits === <span style="color:#a50">&#39;yes&#39;</span>;
<span style="color:#00a">const</span> maxTags = data.maxTags;

<span style="color:#aaa;font-style:italic">// Utility for splitting an array into multiple arrays of given size
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">const</span> splitToBatches = (arr, size) =&gt; {
  <span style="color:#00a">const</span> newArr = [];
  <span style="color:#00a">for</span> (<span style="color:#00a">let</span> i = <span style="color:#099">0</span>, len = arr.length; i &lt; len; i += size) {
    newArr.push(arr.slice(i, i + size));
  }
  <span style="color:#00a">return</span> newArr;
};

<span style="color:#aaa;font-style:italic">// The addEventCallback gets two arguments: container ID and a data object with an array of tags that fired
</span><span style="color:#aaa;font-style:italic"></span>addEventCallback((ctid, eventData) =&gt; {

  <span style="color:#aaa;font-style:italic">// Filter out tags that have the &#34;exclude&#34; metadata set to true
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">const</span> tags = eventData.tags.filter(t =&gt; t.exclude !== <span style="color:#a50">&#39;true&#39;</span>);
  
  <span style="color:#aaa;font-style:italic">// If batching is enabled, split the tags into batches of the given size
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">const</span> batches = batchHits ? splitToBatches(tags, maxTags) : [tags];
  
  <span style="color:#aaa;font-style:italic">// For each batch, build a payload and dispatch to the endpoint as a GET request
</span><span style="color:#aaa;font-style:italic"></span>  batches.forEach(tags =&gt; {
    <span style="color:#00a">let</span> payload = <span style="color:#a50">&#39;?eventName=&#39;</span> + event + <span style="color:#a50">&#39;&amp;eventTimestamp=&#39;</span> + eventTimestamp;
    tags.forEach((tag, idx) =&gt; {
      <span style="color:#00a">const</span> tagPrefix = <span style="color:#a50">&#39;&amp;tag&#39;</span> + (idx + <span style="color:#099">1</span>);
      payload +=
        tagPrefix + <span style="color:#a50">&#39;id=&#39;</span> + tag.id +
        tagPrefix + <span style="color:#a50">&#39;nm=&#39;</span> + tag.name +
        tagPrefix + <span style="color:#a50">&#39;st=&#39;</span> + tag.status +
        tagPrefix + <span style="color:#a50">&#39;et=&#39;</span> + tag.executionTime;
    });
    sendPixel(endPoint + payload, <span style="color:#00a">null</span>, <span style="color:#00a">null</span>);
  });
});

<span style="color:#aaa;font-style:italic">// After adding the callback, signal tag completion
</span><span style="color:#aaa;font-style:italic"></span>data.gtmOnSuccess();
</code></pre></div>
<p>The functionally most significant part of this code is the <code>addEventCallback()</code> method. This invokes the API of the same name.</p>
<p>The API checks the <code>dataLayer</code> event that triggered the tag created from this template, and then updates the <code>dataLayer</code> <code>eventCallback</code> with the function defined in the template.</p>
<p>In other words, when whatever event that triggers this monitor tag is fully resolved (i.e. all tags have signalled completion), the callback function will execute with data about each of the tags that fired on the event.</p>
<p>There's a provision in place to exclude any tags from the monitoring based on a tag metadata field you can set (more on this below). For some, it might make sense to exclude the monitoring tag itself from being monitored, even though there might be value in measuring its execution time along with all the other tags&rsquo;.</p>
<p>By far the most significant code is run when the payload is built:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">batches.forEach(tags =&gt; {
   <span style="color:#00a">let</span> payload = <span style="color:#a50">&#39;?eventName=&#39;</span> + event + <span style="color:#a50">&#39;&amp;eventTimestamp=&#39;</span> + eventTimestamp;
   tags.forEach((tag, idx) =&gt; {
      <span style="color:#00a">const</span> tagPrefix = <span style="color:#a50">&#39;&amp;tag&#39;</span> + (idx + <span style="color:#099">1</span>);
      payload +=
       tagPrefix + <span style="color:#a50">&#39;id=&#39;</span> + tag.id +
       tagPrefix + <span style="color:#a50">&#39;nm=&#39;</span> + tag.name +
       tagPrefix + <span style="color:#a50">&#39;st=&#39;</span> + tag.status +
       tagPrefix + <span style="color:#a50">&#39;et=&#39;</span> + tag.executionTime;
   });
   sendPixel(endPoint + payload, <span style="color:#00a">null</span>, <span style="color:#00a">null</span>);
});
</code></pre></div>
<p>Here, every tag that fired on the event is parsed and concatenated into a URL query string payload. For example, a <code>dataLayer</code> event named <code>gtm.js</code> that fired two tags might have the following payload:</p>
<pre>
?eventName=gtm.js
&eventTimestamp=1562402273899
&tag1id=12
&tag1nm=GA-PageView
&tag1st=success
&tag1et=124
&tag2id=29
&tag2nm=Facebook
&tag2st=failure
&tag2et=422
</pre>
<p>This is then joined with the endpoint URL, and a GET request is dispatched.</p>
<p>This is the payload that is captured by the endpoint in the Google Cloud, which Mark will show <a href="#step-3-creating-the-google-cloud-platform-endpoint">later</a> how to create.</p>
<p>It's easy to extend this with additional metadata. Just update the <code>payload +=</code> concatenation with each additional metadata key you want to access from the tags.</p>
<h3 id="13-permissions">1.3. Permissions</h3>
<p>If you’ve added the code into the code editor without errors, you should see three permissions predefined in the <strong>Permissions</strong> tab.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/permissions-tab.jpg" title="Permissions tab">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/permissions-tab.jpg#ZgotmplZ" alt="Permissions tab">
  
    </a>
  
  
</div>


<ul>
<li>
<p><a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#reads-data-layer">Reads Data Layer</a>: Add the key <code>event</code> into the text area.</p>
</li>
<li>
<p><a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#reads-event-metadata">Reads Event Metadata</a>: No input necessary.</p>
</li>
<li>
<p><a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#sends-pixels">Sends Pixels</a>: Add the URL of the endpoint you will be sending the data to (you can use wildcards and partials matches, too).</p>
</li>
</ul>
<p>Naturally, you won’t know the endpoint until you’ve created it, so if you want to test the template before creating the endpoint, you can just a placeholder in the permissions such as <code>https://placeholder.com/collect</code>.</p>
<p>You can <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#testing-the-template"><strong>Test</strong></a> the template if you wish, but it won’t really do anything, as the callback requires an event to be pushed into <code>dataLayer</code> to trigger.</p>
<p><strong>Save</strong> the template once you’re done.</p>
<h2 id="step-2-tags-and-triggers">Step 2: Tags and triggers</h2>
<p>The first thing we’ll need to do is create the <strong>monitor tag</strong> itself.</p>
<h3 id="21-create-the-monitor-tag">2.1. Create the monitor tag</h3>
<p>In GTM, go to <strong>Tags</strong> and create a new tag. Select the template you just created from the tag type selector.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/choose-tag-type.jpg" title="Choose tag type">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/choose-tag-type.jpg#ZgotmplZ" alt="Choose tag type">
  
    </a>
  
  
</div>


<p>The GET request endpoint field takes the endpoint you’ll create in the next section, so you can just use the placeholder value of <code>https://placeholder.com/collect</code> there for now, we’ll return to this shortly.</p>
<p>If you want to send the hits in batches, choose the <strong>Yes</strong> radio button, but you might want to start without batches and just use the default settings.</p>
<p>Next, expand <strong>Advanced Settings</strong> and scroll down to a new setting named <strong>Additional Tag Metadata</strong>.</p>
<p>Click it open, and check the box named <strong>Include tag name</strong>. Set the <strong>Key for tag name</strong> value to <code>name</code>.</p>
<p>Add a new metadata by clicking the <strong>+ Add Metadata</strong> button, and set these values:</p>
<ul>
<li>
<p>Key: <code>exclude</code></p>
</li>
<li>
<p>Value: <code>true</code></p>
</li>
</ul>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/additional-tag-metadata.jpg" title="Additional tag metadata">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/additional-tag-metadata.jpg#ZgotmplZ" alt="Additional tag metadata">
  
    </a>
  
  
</div>


<p>Because this monitor should monitor every single event that fires in your container, add a new <strong>Custom Event Trigger</strong> to the tag that looks like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/all-events.jpg" title="Custom event trigger for all events">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/all-events.jpg#ZgotmplZ" alt="Custom event trigger for all events">
  
    </a>
  
  
</div>


<p>With that regular expression for the event name, the monitor tag will fire for every single <code>dataLayer</code> event.</p>
<p>Save the trigger and tag when ready.</p>
<h3 id="22-the-additional-tag-metadata-setting">2.2. The Additional Tag Metadata setting</h3>
<p>As you can see, there’s a <strong>new advanced setting</strong> for Google Tag Manager tags.</p>
<p>This <strong>Additional Tag Metadata</strong> setting lets you add metadata to every single tag in the container. This metadata is added to the tags passed to the <code>eventCallback</code> of the <code>dataLayer.push()</code> (such as the one added by the <code>addEventCallback</code> custom template API).</p>
<p>One predefined metadata is already given to you: the <strong>tag name</strong>. By checking the <strong>Include tag name</strong> box, the <code>eventCallback</code> data object will always include the <code>name</code> key (or whatever key you assign), automatically set to the tag’s name.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/other-metadata.jpg" title="Other metadata">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/other-metadata.jpg#ZgotmplZ" alt="Other metadata">
  
    </a>
  
  
</div>


<p>You can add additional metadata too, such as category or type of tag.</p>
<p>Just remember that the solution as established in this article only makes use of the tag <code>name</code> and <code>exclude</code> metadata keys. Any other metadata you add will require a code change in the template, as the new metadata will need to be concatenated into the payload string as well.</p>
<h3 id="23-update-all-your-tags">2.3. Update all your tags</h3>
<p>The last thing you’ll need to do in GTM (apart from updating the endpoint URL of the monitor tag when you have one), is to update <strong>every single one</strong> of your tags to include the tag <code>name</code> metadata. The tag name is easier to interpret than the tag ID when building your reports and visualizations.</p>
<p>For each tag, expand the <strong>Advanced Settings</strong> and check the <strong>Include tag name</strong> checkbox under <strong>Additional Tag Metadata</strong>. Remember to set the key name to <code>name</code> as well.</p>
<p>Hopefully, the tag name would be automatically included as a metadata in the future - it seems like a sensible feature to have always on. Or, at the very least, flip the checkbox around and require it to be checked if you want to <strong>exclude</strong> the tag name from the tag’s metadata.</p>
<p>At this point, you should have your monitor tag with almost all the settings in place, and you should have now edited all your tags to include the tag name. The monitor tag should have a Custom Event trigger that fires it for every single <code>dataLayer</code> event.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/preview-and-network.jpg" title="Preview and network requests">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/preview-and-network.jpg#ZgotmplZ" alt="Preview and network requests">
  
    </a>
  
  
</div>


<p>Feel free to test in Preview mode to see if the endpoint is invoked with a proper query string. You should see something like this in the Network logs of your browser, assuming you used the placeholder URL of <code>https://placeholder.com/collect</code>.</p>
<p>Next up, <strong>Mark</strong> will show us how to get the Google Cloud Platform endpoint up and running!</p>
<h2 id="step-3-creating-the-google-cloud-platform-endpoint">Step 3: Creating the Google Cloud Platform endpoint</h2>
<p>The GCP endpoint needs to process the <strong>GET requests</strong> sent from the site, insert them into a <strong>BigQuery table</strong>, parse them into columns and rows, and finally connect the data to <strong>Google Data Studio</strong>.</p>
<h3 id="31-choosing-the-gcp-solution-for-the-endpoint">3.1. Choosing the GCP solution for the endpoint</h3>
<p>Boiling down the use case requirements here, we are looking to turn an API call containing the GTM tag data into useful data for analysis. There are many ways to solve this particular use case on GCP - we'll go through some and show why we eventually went for <a href="https://cloud.google.com/functions/">Cloud Functions</a>.</p>
<p>The general solution requirements were:</p>
<ul>
<li>
<p><strong>Serverless</strong>: so we don't babysit a server but are able to deal with high traffic and/or scale down to <em>zero cost</em> when no data is collected.</p>
</li>
<li>
<p><strong>Low-code</strong>: easy to deploy and maintain.</p>
</li>
<li>
<p><strong>Low-config</strong>: minimal maintenance so it can be generalized and can deal with varying data schemas easily.</p>
</li>
</ul>
<p>The final output is to be a dashboard in Data Studio, so the natural choice for the eventual destination was BigQuery due to the ability to connect via its native Data Studio connector.</p>
<blockquote>
<p><strong>Quick aside</strong>: We are wary of dashboards being a final solution for data flows since they rely on a human being to react to give you ROI. It’s fine for a proof-of-concept, but for your own project consider your actual use case - perhaps you could instead implement <strong>automatic alerts</strong> if certain thresholds on data quality were broken or something similar.</p>
</blockquote>
<p>With the above requirements in mind, some solutions included:</p>
<h4 id="311-pixel-tracking-via-a-load-balancer">3.1.1. Pixel tracking via a load balancer</h4>
<p>We thought about a <a href="https://cloud.google.com/solutions/serverless-pixel-tracking">Pixel Tracking Solution</a> first, since in theory the only steps needed are to upload a pixel to Cloud Storage, make it publicly available, and then stream the access logs into BigQuery.</p>
<p>However the resulting API endpoint is an HTTP IP address (e.g. <code>http://111.222.333.444</code>) and the Google Tag Manager API requires communication over HTTPS. It’s absolutely possible to assign a custom domain and SSL certificate to the load balancer, but to make the demo more accessible for everyone we wanted to find a solution that provided its own domain and HTTPS endpoint.</p>
<p>However, if you do have a custom domain name at hand, the load balancer is probably the <strong>most robust solution</strong> to utilize, since it doesn’t require the overhead of running a programmed application.</p>
<h4 id="312-app-engine">3.1.2. App Engine</h4>
<p>The next stop was <a href="https://cloud.google.com/appengine/">App Engine</a>, which up to last year would have been the one we’d pursue. In fact, here is some code on how to set up <a href="https://github.com/MarkEdmondson1234/ga-bq-stream">streaming from GTM to BigQuery</a> that Mark wrote three years ago.</p>
<p>However, since then <strong>Cloud Functions</strong> have arrived which have even less configuration and code required to set up the service. You may still want to consider App Engine if you have more requirements such as integration with Cloud Endpoints or other GCP APIs, for which Cloud Functions do not have support yet.</p>
<h4 id="313-technology-of-choice-cloud-functions">3.1.3. Technology of choice: Cloud Functions</h4>
<p>This is the one we went for. For getting something quickly up and running, it is hard to beat. If using Python, you only need to write code, create a <code>requirements.txt</code> file, set the function to trigger with a public endpoint (via HTTP requests), and you have everything we need - HTTPS, scalable infrastructure and almost no configuration necessary.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/website-to-bigquery.jpg" title="Website to BigQuery">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/website-to-bigquery.jpg#ZgotmplZ" alt="Website to BigQuery">
  
    </a>
  
  
</div>


<p>It may cost more per call than the solutions above, but it scales down to zero meaning you can deploy and wait for traffic without incurring any costs for downtime.</p>
<p>Note that Cloud Functions can take <a href="https://cloud.google.com/functions/quotas">100 million calls per 100 seconds</a> in hits, but BigQuery itself accepts only (!) up to <a href="https://cloud.google.com/bigquery/quotas#streaming_inserts">100,000 rows per second</a> per project which equates to 10 million calls per 100 seconds. If this is a limitation you might find yourself struggling with, you'll need to start batching the data to BigQuery instead of streaming it.</p>
<h3 id="32-bigquery-setup">3.2. BigQuery setup</h3>
<p>With the API endpoint technology selected, we turn to configuring <a href="https://console.cloud.google.com/bigquery/"><strong>BigQuery</strong></a>.</p>
<p>Loading data into BigQuery requires a <strong>schema</strong> for the data (<code>STRING</code>, <code>INT</code>, <code>TIMESTAMP</code>, etc.) which can be tricky if you are sending in a lot of data with untidy types (most data, that is) - one mistake and the data won't load. We're accepting data from an open HTTP endpoint so we are almost certain to get messy data and thus want to be able to modify sent data without reconfiguring everything.</p>
<p>To account for the above, we favor loading data into BigQuery with as few restrictions as possible, but then use BigQuery's SQL to parse or transform the raw data into tidier forms. If you don't know SQL but are better with JavaScript, you may prefer to do that data tidying logic in the Google Tag Manager code sending the data, or if better at Python perhaps in the Cloud Function collecting it. We still recommend to do this kind of data cleaning in BigQuery since otherwise changes need code updates in harder-to-reach places.</p>
<p>To achieve this, the BigQuery table accepting the GTM data will have as simple a data schema as possible: it will accept the entire URL as a string and not try to parse out the tag names or GTM events quite yet. We shall then create a <a href="https://cloud.google.com/bigquery/docs/views">BigQuery View</a> on top of that data which will split the URL into a workable, tidy format.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/bigquery-schema.jpg" title="bigquery schema">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/bigquery-schema.jpg#ZgotmplZ" alt="bigquery schema">
  
    </a>
  
  
</div>


<p>The final raw data schema then is simply the <strong>URI</strong> and a <strong>timestamp</strong>. We consider a timestamp always useful to have, and we will stream the data into a <a href="https://cloud.google.com/bigquery/docs/partitioned-tables">partitioned table</a> which automatically aligns the datasets with the date of data ingestion to make time-based analysis easier.</p>
<p>To create the table, you need a Google Cloud Platform project with billing enabled. Once you have that in place, browse to <a href="https://console.cloud.google.com/bigquery">the BigQuery web UI</a> and create a dataset for your project.</p>
<p>With the dataset in place, you can then create a table in it.</p>
<p>Putting all of the above into place, the BigQuery table settings look like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/bigquery-table-settings.jpg" title="BigQuery table settings">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/bigquery-table-settings.jpg#ZgotmplZ" alt="BigQuery table settings">
  
    </a>
  
  
</div>


<p>The partition will put each hit's data into a partition of today's date, e.g. <code>20190703</code>, which you can use to query particular time periods via BigQuery's <code>_PARTITIONDATE</code> field.</p>
<p>Make note of the <strong>project</strong> name, <strong>dataset</strong> name, and <strong>table</strong> name. You are naturally free to choose whatever you want for these, but you need the values when configuring the Cloud Function code next.</p>
<h3 id="33-the-cloud-function-code">3.3. The Cloud Function Code</h3>
<p>Now let us get some data into the table. This is the Python code we'll use to update the Cloud Function with. You don't need to store any code locally - you can use the <a href="https://console.cloud.google.com/functions/add">web UI</a>. The code below is based on the examples given using the <a href="https://googlecloudplatform.github.io/google-cloud-python/latest/bigquery/index.html">Python SDK for BigQuery</a>.</p>
<p>See the next chapter for information on where to copy-paste this code.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">from</span> <span style="color:#0aa;text-decoration:underline">google.cloud</span> <span style="color:#00a">import</span> bigquery
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">datetime</span>
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">logging</span>

PROJECT=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">me-gtm-monitoring</span><span style="color:#a50">&#39;</span> <span style="color:#aaa;font-style:italic"># Update to match your project name</span>
DATASET=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">gtm_monitoring</span><span style="color:#a50">&#39;</span>    <span style="color:#aaa;font-style:italic"># Update to match your dataset name</span>
TABLE=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">raw_data</span><span style="color:#a50">&#39;</span>            <span style="color:#aaa;font-style:italic"># Update to match your table name</span>

<span style="color:#00a">def</span> <span style="color:#0a0">stream_bq</span>(uri):

    client = bigquery.Client()

    table_ref = client.dataset(DATASET).table(TABLE)
    table = client.get_table(table_ref)

    <span style="color:#aaa;font-style:italic"># Stream the URI of the request</span>
    errors = client.insert_rows(table, [{<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">URI</span><span style="color:#a50">&#39;</span>:uri, 
                                         <span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">timestamp</span><span style="color:#a50">&#39;</span>: datetime.datetime.now()}])

    <span style="color:#00a">if</span> errors:
        logging.error(errors)


<span style="color:#00a">def</span> <span style="color:#0a0">gtm_monitor</span>(request):

    <span style="color:#00a">if</span> request.url:
        stream_bq(request.url)</code></pre></div>
<h4 id="331-code-walkthrough">3.3.1. Code walkthrough</h4>
<p>We first import the libraries for connecting to BigQuery (<code>google.cloud.bigquery</code>), creating the timestamp (<code>datetime</code>), and logging errors (<code>logging</code>).</p>
<p>Then you need to alter the code to set the project, dataset, and table for the destination BigQuery data.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">from</span> <span style="color:#0aa;text-decoration:underline">google.cloud</span> <span style="color:#00a">import</span> bigquery
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">datetime</span>
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">logging</span>

PROJECT=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">your-project</span><span style="color:#a50">&#39;</span> <span style="color:#aaa;font-style:italic"># Update to match your project name</span>
DATASET=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">your_dataset</span><span style="color:#a50">&#39;</span> <span style="color:#aaa;font-style:italic"># Update to match your dataset name</span>
TABLE=<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">your_table</span><span style="color:#a50">&#39;</span>     <span style="color:#aaa;font-style:italic"># Update to match your table name</span></code></pre></div>
<p>As you can see, you actually need to create the table first - you can see the settings for the table in the previous chapter. Once you have the project, dataset, and table created, update the Cloud Function code above with the correct values.</p>
<p>Below is the function <code>stream_bq()</code> to stream data into BigQuery. As we are deploying the Cloud Function in the same project that hosts the BigQuery table, Cloud Functions will handle authentication for us. All we need is the <code>bigquery.Client()</code> call, and the Cloud Function will handle authentication and identity management using the default service account set for the project.</p>
<p>We then create the table object, and stream the data into the table using the <code>client.insert_rows()</code> method. This will return errors if it fails, in which case we’ll log them.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">def</span> <span style="color:#0a0">stream_bq</span>(uri):

    client = bigquery.Client()

    table_ref = client.dataset(DATASET).table(TABLE)
    table = client.get_table(table_ref)

    <span style="color:#aaa;font-style:italic"># Stream the URI of the request</span>
    errors = client.insert_rows(table, [{<span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">URI</span><span style="color:#a50">&#39;</span>:uri, 
                                         <span style="color:#a50"></span><span style="color:#a50">&#39;</span><span style="color:#a50">timestamp</span><span style="color:#a50">&#39;</span>: datetime.datetime.now()}])

    <span style="color:#00a">if</span> errors:
        logging.error(errors)</code></pre></div>
<p>Next, <code>gtm_monitor()</code> is the main function that will be the <strong>entry point</strong> to the Cloud Function. We define this in the web UI (see below). The function checks if the request had a URL, and if it did, it sends this to the <code>stream_bq()</code> method described above.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">def</span> <span style="color:#0a0">gtm_monitor</span>(request):

    <span style="color:#00a">if</span> request.url:
        stream_bq(request.url)</code></pre></div>
<p>Finally we also need to modify the <code>requirements.txt</code> file in the Cloud Function - we can do this in the web UI as well. Cloud Functions automatically parses this file to install any necessary python libraries through <code>pip</code>.</p>
<p>The only external dependency we need is the BigQuery SDK. The beauty of Cloud Functions is that you don't need to install this locally and then deploy the whole project at once - you can simply edit the <code>requirements.txt</code> file in the online editor to have the Cloud Function automatically install the dependency before running any code.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/requirements-txt.jpg" title="Requirements.txt">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/requirements-txt.jpg#ZgotmplZ" alt="Requirements.txt">
  
    </a>
  
  
</div>


<p>The line you need to add is this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">google-cloud-bigquery==1.5.1</code></pre></div>
<h4 id="332-create-and-deploy-the-cloud-function">3.3.2. Create and deploy the Cloud Function</h4>
<p>With all the theory out of the way, we can now look how to actually write and deploy the code in the Cloud Function.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/create-gcf-setting.jpg" title="Google Cloud Function creation">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/create-gcf-setting.jpg#ZgotmplZ" alt="Google Cloud Function creation">
  
    </a>
  
  
</div>


<ol>
<li>
<p>From a Google Cloud Project (with <strong>billing enabled</strong>) go to <a href="https://console.cloud.google.com/functions/list">https://console.cloud.google.com/functions/add</a>.</p>
</li>
<li>
<p>Give the function a descriptive name.</p>
</li>
<li>
<p>Select <strong>HTTP</strong> as the trigger.</p>
</li>
<li>
<p>Tick the <code>Allow unauthenticated invocations</code> box to make it accessible from anywhere.</p>
</li>
<li>
<p>Select the <code>Python 3.7</code> runtime.</p>
</li>
<li>
<p>Paste in the main function code from the previous chapter into <code>main.py</code>, and make the appropriate changes where required (the project, dataset, and table names).</p>
</li>
<li>
<p>Copy-paste the BigQuery dependency into the <code>requirements.txt</code> tab of the online editor.</p>
</li>
<li>
<p>Set the <strong>Function to execute</strong> field to <code>gtm_monitor</code>, as this is the entry point of the Cloud Function.</p>
</li>
<li>
<p>Hit <strong>Create</strong> at the bottom of the screen.</p>
</li>
</ol>
<p>Note that you can expand the <strong>More</strong> link to change the region from <code>us-central-1</code> to something closer to where most of your traffic comes from. This should improve performance and decrease latency.</p>
<p>After hitting <strong>Create</strong>, you should be able to see the URL the Cloud Function has assigned to your new function. This would be something like <code>https://us-central1-my-project.cloudfunctions.net/my-function</code>.</p>
<p>After all that you should have a function that looks a little like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/cloud-function-done-1.jpg" title="Cloud function done">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/cloud-function-done-1.jpg#ZgotmplZ" alt="Cloud function done">
  
    </a>
  
  
</div>





<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/cloud-function-done-2.jpg" title="Cloud function done">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/cloud-function-done-2.jpg#ZgotmplZ" alt="Cloud function done">
  
    </a>
  
  
</div>


<h3 id="34-update-the-google-tag-manager-monitor-tag">3.4. Update the Google Tag Manager Monitor tag</h3>
<p>With your cloud function deployed, you should now have a URL endpoint for your Google Tag Manager Monitor tag looking something like <code>https://us-central1-your-project.cloudfunctions.net/your-function</code>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/get-request-endpoint.jpg" title="Get request endpoint">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/get-request-endpoint.jpg#ZgotmplZ" alt="Get request endpoint">
  
    </a>
  
  
</div>


<p>In your Google Tag Manager Monitor tag, update the <strong>GET request endpoint</strong> to reflect the correct Cloud Function HTTP endpoint and save the tag. You'll then need to <strong>edit the Custom Template</strong> and open its <strong>Permissions</strong> tab. Update the <strong>Sends Pixels</strong> permission with the correct endpoint URL.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/update-permission.jpg" title="Update permission">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/update-permission.jpg#ZgotmplZ" alt="Update permission">
  
    </a>
  
  
</div>


<p>Make sure to add the <code>*</code> at the end of the permission URL to account for query parameters.</p>
<p>You can continue in <strong>Preview mode</strong> for a while to ensure that everything works before <strong>publishing</strong> the container for all your visitors.</p>
<p>If everything works, you should see GCP logs of your Cloud Function (accessible in the Cloud Function UI) showing HTTP calls are being triggered.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/view-gcp-logs.jpg" title="View GCP Logs">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/view-gcp-logs.jpg#ZgotmplZ" alt="View GCP Logs">
  
    </a>
  
  
</div>


<p>Within BigQuery, you should see data is being populated with the URI requested. Make sure to turn the <strong>cache</strong> off and query via <code>SELECT * FROM dataset.table_name</code> to test live data, as the Preview may show no data even when there is some. Nevertheless, after doing the <code>SELECT *</code> query, or after patiently waiting for the Preview to update, you should see your raw data being logged into BigQuery like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/bigquery-preview-raw.jpg" title="BigQuery Preview Raw">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/bigquery-preview-raw.jpg#ZgotmplZ" alt="BigQuery Preview Raw">
  
    </a>
  
  
</div>


<p>If you got this far, congratulations! You now have a live stream of data from your Google Tag Manager setup into BigQuery. Just imagine all the other use cases for this pipeline!</p>
<h3 id="35-parsing-bigquery-raw-data-into-a-view">3.5. Parsing BigQuery raw data into a view</h3>
<p>Now we do the parsing of this data into something useful. Simo took a jab at writing the necessary SQL for the proof-of-concept (M: Good job, Simo! S: Why, thank you!).</p>
<p>There is probably some more elegant way to do this with arrays, but this is what we went with in that it uses regular expressions to parse out the URI string into usable columns. It is here you can do adjustments to the output data to put it in a format you want.</p>
<p>Make sure to update the <code>FROM</code> statement to pull the data from the correct project/dataset/table combination.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">SELECT</span>
  <span style="color:#00a">timestamp</span>,
  eventName,
  eventTimestamp,
  (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(tagString, <span style="color:#a50">&#34;</span><span style="color:#a50">&amp;tag\\d+id=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> tagId,
  (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(tagString, <span style="color:#a50">&#34;</span><span style="color:#a50">&amp;tag\\d+nm=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> tagName,
  (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(tagString, <span style="color:#a50">&#34;</span><span style="color:#a50">&amp;tag\\d+st=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> tagStatus,
  (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(tagString, <span style="color:#a50">&#34;</span><span style="color:#a50">&amp;tag\\d+et=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> tagExecutionTime
<span style="color:#00a">FROM</span> (
  <span style="color:#00a">SELECT</span>
    <span style="color:#00a">timestamp</span>,
    eventName,
    eventTimestamp,
    tagStringUnnest <span style="color:#00a">as</span> tagString,
    pt
  <span style="color:#00a">FROM</span> (
    <span style="color:#00a">SELECT</span> 
      <span style="color:#00a">timestamp</span>,
      (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(URI, <span style="color:#a50">&#34;</span><span style="color:#a50">eventName=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> eventName,
      (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT(URI, <span style="color:#a50">&#34;</span><span style="color:#a50">eventTimestamp=([^&amp;]+)</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> eventTimestamp,
      (<span style="color:#00a">SELECT</span> REGEXP_EXTRACT_ALL(URI, <span style="color:#a50">&#34;</span><span style="color:#a50">&amp;tag\\d+id=[^&amp;]+&amp;tag\\d+nm=[^&amp;]+&amp;tag\\d+st=[^&amp;]+&amp;tag\\d+et=[^&amp;]+</span><span style="color:#a50">&#34;</span>)) <span style="color:#00a">as</span> tagStringRegex,
      <span style="color:#0aa">DATE</span>(_PARTITIONTIME) <span style="color:#00a">as</span> pt
    <span style="color:#00a">FROM</span>
      `your-project.gtm_monitoring.raw_data`
  )
  <span style="color:#00a">LEFT</span> <span style="color:#00a">JOIN</span> <span style="color:#00a">UNNEST</span>(tagStringRegex) <span style="color:#00a">as</span> tagStringUnnest
)</code></pre></div>
<p>Once you have the SQL you want running in the <a href="https://console.cloud.google.com/bigquery">BigQuery Web UI</a>, select <strong>Save View</strong> to save the query as a table that will be used day-to-day.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/save-query-view.jpg" title="Save query view">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/save-query-view.jpg#ZgotmplZ" alt="Save query view">
  
    </a>
  
  
</div>


<p>Here’s what the data looks like when parsed into the view.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/query-the-view.jpg" title="Query the view">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/query-the-view.jpg#ZgotmplZ" alt="Query the view">
  
    </a>
  
  
</div>


<h2 id="step-4-visualize-the-data">Step 4: Visualize the data</h2>
<p>For most use cases, having the data in a BigQuery view is already more than enough. That's the data set you can query for anomaly detection, or plug into a pipeline for automated alerts.</p>
<p>Nevertheless, we can see how useful a proper visualization of the data could potentially be. For this purpose, Google's <a href="https://datastudio.google.com/">Data Studio</a> is an excellent project for quickly delivering useful visualizations. Best of all, it already has a built-in <a href="https://support.google.com/datastudio/answer/6370296?hl=en">BigQuery connector</a> for querying your BQ data with.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/07/data-studio-dashboard.jpg" title="Data Studio Dashboard">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/07/data-studio-dashboard.jpg#ZgotmplZ" alt="Data Studio Dashboard">
  
    </a>
  
  
</div>


<p>As a demo, we've created a <strong>starter</strong> dashboard for you to check out. Feel free to copy it and modify it to suit your own purposes.</p>
<p><a href="https://datastudio.google.com/u/0/reporting/1qcyKjq_44_VIeIxL4BTQm6kKnBaH5a7p/page/xsws">Visit the dashboard here.</a></p>
<h2 id="summary">Summary</h2>
<p>Maybe we haven't said this enough yet, but this is a <strong>proof-of-concept</strong>. This article serves a number of purposes:</p>
<ul>
<li>
<p>You'll learn how to set up a pipeline of data collection from the website, via Google Tag Manager, to a data warehouse located in the Google Cloud.</p>
</li>
<li>
<p>You'll learn about the new <code>addEventCallback</code> API in Google Tag Manager's custom templates.</p>
</li>
<li>
<p>You'll learn about the new <strong>Additional Tag Metadata</strong> field in GTM's tags.</p>
</li>
<li>
<p>You'll learn how to efficiently monitor the success rates and execution times of your Google Tag Manager tags.</p>
</li>
</ul>
<p>We can only hope that others build much cooler and more useful solutions than this simple MVP. Some features we considered useful but not in the scope of this introductory article:</p>
<ol>
<li>
<p>Report that compares data from the respective end points with that of GTM's monitor system to see if tags are firing but not sending the correct data.</p>
</li>
<li>
<p>Utilize a pixel file stored in Google Cloud Storage, behind a load balancer, to achieve a zero-code setup with superior performance compared to a Cloud Function.</p>
</li>
<li>
<p>Training a machine learning model on the data set to identify anomalies and automatically alert to them when detected.</p>
</li>
</ol>
<p>Let us know in the comments what you think of this, and how you would improve it if you had the chance!</p>
<p><strong>Final note from Simo</strong>: I am truly grateful to get the great Mark Edmondson to co-author this article and design the monitor solution with me. As the editor, I take full responsibility for any errors and mistakes in the final draft of the article.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/custom-templates/">custom templates</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/monitor/">monitor</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-cloud-platform/">google cloud platform</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/bigquery/">bigquery</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/introducing-gtm-templates-library/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/enhanced-ecommerce-builder-custom-variable-template/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=How%20To%20Build%20A%20Google%20Tag%20Manager%20Monitor%20https://www.simoahava.com/analytics/google-tag-manager-monitor/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/introducing-gtm-templates-library/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/enhanced-ecommerce-builder-custom-variable-template/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=How%20To%20Build%20A%20Google%20Tag%20Manager%20Monitor%20https://www.simoahava.com/analytics/google-tag-manager-monitor/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=How%20To%20Build%20A%20Google%20Tag%20Manager%20Monitor%20https://www.simoahava.com/analytics/google-tag-manager-monitor/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/google-tag-manager-monitor/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

