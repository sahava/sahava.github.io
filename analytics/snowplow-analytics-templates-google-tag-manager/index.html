

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <script>
      function gtag() { window.dataLayer = window.dataLayer || []; window.dataLayer.push(arguments); }
      gtag('event', 'optimize.callback', {
	    callback: function(e) {
	      window.__flickerTestMilestones = window.__flickerTestMilestones || {};
          window.__flickerTestMilestones.experimentLoaded = new Date().getTime();
	    }
      });
    </script>
    <script async src="https://www.googleoptimize.com/optimize.js?id=GTM-NGM64B"></script>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Snowplow Analytics Templates For Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2020\/05\/snowplow-blog-logo.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/snowplow-analytics-templates-google-tag-manager\/",
  "datePublished": "2020-05-14T09:00:00\x2b03:00",
  "dateModified": "2020-05-14T09:00:00\x2b03:00",
  "description": "This blog post describes the recently released Snowplow Analytics custom templates for Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Snowplow Analytics Templates For Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/snowplow-analytics-templates-google-tag-manager/">
    
    <meta name="description" content="This blog post describes the recently released Snowplow Analytics custom templates for Google Tag Manager.">
    <meta property="og:description" content="This blog post describes the recently released Snowplow Analytics custom templates for Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Snowplow Analytics Templates For Google Tag Manager">
    <meta property="og:url" content="https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Snowplow Analytics Templates For Google Tag Manager">
    <meta name="twitter:description" content="This blog post describes the recently released Snowplow Analytics custom templates for Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2020/05/snowplow-blog-logo.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2020/05/snowplow-blog-logo.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Snowplow Analytics Templates For Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-05-14T09:00:00&#43;03:00">
        
  May 14, 2020

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/#commento">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>When <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom templates</a> were <a href="https://www.blog.google/products/marketingplatform/analytics/tag-manager-introducing-custom-templates/">released</a> for Google Tag Manager, I updated my workflow for working with GTM. Instead of rushing to the <a href="https://www.simoahava.com/analytics/custom-html-tag-guide-google-tag-manager/">Custom HTML tag</a> and the <a href="https://www.simoahava.com/analytics/variable-guide-google-tag-manager/#4-custom-javascript">Custom JavaScript variable</a>, I started considering whether the custom scripts could be transformed into custom template first.</p>
<p>While publishing <a href="https://tagmanager.google.com/gallery/#/?filter=gtm-templates-simo-ahava&amp;page=1">numerous templates</a> into the community gallery, I always spent some time over the past 12 months tinkering on an extremely complicated template translation: the <a href="https://github.com/snowplow/snowplow/wiki/javascript-tracker">Snowplow Analytics JavaScript tracker</a>.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/snowplow-blog-logo.jpg" title="Snowplow analytics logo">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/snowplow-blog-logo.jpg#ZgotmplZ" alt="Snowplow analytics logo">
  
    </a>
  
  
</div>


<p>I've written about Snowplow <a href="https://www.simoahava.com/tags/snowplow/">before</a>, and I have a soft spot in my heart for their wonderful DIY approach to the analytics pipeline.</p>
<p>In this article, I'll introduce the two templates I've created, and I'll share some of the design philosophy with you. It's been a strange ride, and I've found myself pushing the capabilities of custom templates to their limits.</p>
<blockquote>
<p>This article is <strong>not</strong> a manual for the templates. You should turn to the respective <em>technical documentation</em> linked in the table below.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Template</th>
<th>Type</th>
<th>Documentation</th>
<th>Gallery</th>
<th>GitHub</th>
</tr>
</thead>
<tbody>
<tr>
<td>Snowplow Analytics</td>
<td>Tag</td>
<td><a href="https://www.simoahava.com/custom-templates/snowplow-analytics/">Link</a></td>
<td><a href="https://tagmanager.google.com/gallery/#/owners/snowplow/templates/snowplow-gtm-custom-template">Link</a></td>
<td><a href="https://github.com/snowplow/snowplow-gtm-custom-template">Link</a></td>
</tr>
<tr>
<td>Snowplow Analytics Settings</td>
<td>Variable</td>
<td><a href="https://www.simoahava.com/custom-templates/snowplow-analytics-settings/">Link</a></td>
<td><a href="https://tagmanager.google.com/gallery/#/owners/snowplow/templates/snowplow-gtm-custom-template-settings">Link</a></td>
<td><a href="https://github.com/snowplow/snowplow-gtm-custom-template-settings">Link</a></td>
</tr>
</tbody>
</table>
<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
  <ul>
    <li><a href="#thank-you">Thank you</a></li>
    <li><a href="#the-tag-template">The tag template</a>
      <ul>
        <li><a href="#general-overview">General overview</a></li>
        <li><a href="#initializing-the-tag">Initializing the tag</a>
          <ul>
            <li><a href="#major-caveat-with-the-self-hosted-library">Major caveat with the self-hosted library</a></li>
            <li><a href="#the-tracker-configuration">The tracker configuration</a></li>
            <li><a href="#the-snowplow-analytics-settings-variable">The Snowplow Analytics Settings variable</a></li>
            <li><a href="#missing-pieces">Missing pieces</a></li>
          </ul>
        </li>
        <li><a href="#building-the-commands">Building the command(s)</a>
          <ul>
            <li><a href="#parameter-object">Parameter object</a></li>
            <li><a href="#special-commands">Special commands</a></li>
            <li><a href="#custom-commands">Custom commands</a></li>
          </ul>
        </li>
        <li><a href="#firing-the-commands">Firing the commands</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
<h2 id="thank-you">Thank you</h2>
<p>The preliminary, pre-release work on the templates was done by me, but the templates have been released for open-source development under <a href="https://github.com/snowplow/snowplow-gtm-custom-template">Snowplow's own GitHub organization</a>. I believe this to be vital for keeping them up-to-date and linked with the development of the JavaScript tracker.</p>
<p>I want to thank in advance anyone who contributes to the development of these templates, even if it's just in online discussions, blog comments, or via GitHub Issues.</p>
<p>Huge thanks to <strong>Paul Boocock</strong> from Snowplow. He walked through the template with me to spot any inconsistencies, and he also helped establish the setup for open-source development of the templates.</p>
<h2 id="the-tag-template">The tag template</h2>
<p>The <strong>Snowplow Analytics tag template</strong> is a fairly faithful implementation of the full Snowplow Analytics JavaScript tracker library.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/snowplow-pageview-tag-example.jpg" title="Snowplow Analytics Pageview tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/snowplow-pageview-tag-example.jpg#ZgotmplZ" alt="Snowplow Analytics Pageview tag">
  
    </a>
  
  
</div>


<p>The library itself is reminiscent of the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs">Universal Analytics library</a> and the <a href="https://developer.matomo.org/api-reference/tracking-javascript">Matomo (former Piwik) JavaScript SDK</a>. These similarities make it easier to translate it to a template, as we can use the native Universal Analytics tag template for inspiration.</p>
<h3 id="general-overview">General overview</h3>
<p>In general, when the tag is fired, it goes through the following motions:</p>
<ol>
<li>Loads the <strong>tracker library</strong> from a self-hosted URL.</li>
<li>Creates the <strong>global namespace</strong> for the method name (similar to how Universal Analytics generates the <code>ga</code> global object).</li>
<li>Initializes a new (or reuses an existing) <strong>tracker object</strong>.</li>
<li>Compiles the settings of the tag into a <strong>command</strong> that is then passed to the global method.</li>
<li>The library takes this command from the queue, builds it into a payload, and sends it to the <strong>collector endpoint</strong>.</li>
</ol>
<p>All in all, the process is fairly similar to how Universal Analytics works. The biggest difference on a superficial is the DIY nature of the pipeline. You need to <a href="https://github.com/snowplow/snowplow/wiki/Self-hosting-snowplow-js">self-host the JavaScript library</a>, and you need to <a href="https://github.com/snowplow/snowplow/wiki/Setting-up-a-Collector">build the collector</a> yourself.</p>
<h3 id="initializing-the-tag">Initializing the tag</h3>
<p>Converting a library into a template is a complicated task. A lot of time needs to be devoted to understanding how the library works, and then looking at the restrictions of custom templates.</p>
<p>Loading the library and initializing the global namespace was easy - the <a href="https://developers.google.com/tag-manager/templates/api#injectscript"><code>injectScript</code> API</a> handled the first, and a <a href="https://developers.google.com/tag-manager/templates/api#copyfromwindow"><code>copyFromWindow</code></a> / <a href="https://developers.google.com/tag-manager/templates/api#setinwindow"><code>setInWindow</code></a> combo the second.</p>
<p>If the global namespace isn't established, the script creates it, using a similar queue method that Universal Analytics uses.</p>
<p>Then, the first hiccup is faced: <strong>initializing a tracker</strong>.</p>
<p>The Snowplow global method doesn't have a function to check for the existence of a tracker. There are ways to drill into the object and seek this information, but because there's no official API for querying tracker status, I didn't want to start parsing the object without guarantee it will work in the future.</p>
<p>So, to persist information about trackers that have been created, I used a new global array, <code>window._snowplow_trackers</code>. This array stores all the trackers that have been initialized, and when the tag fires, the tracker name is checked against this list to verify whether a tracker already exists.</p>
<h4 id="major-caveat-with-the-self-hosted-library">Major caveat with the self-hosted library</h4>
<p>There is a major problem with using <code>injectScript</code>.</p>
<p>Because I, as the template author, have no idea about the URLs the template users might load the self-hosted script from, it falls on the template admin to make sure the <strong>template permissions are updated</strong> when the self-hosted library URL is changed.</p>
<p>There are instructions for this <a href="https://www.simoahava.com/custom-templates/snowplow-analytics/#advanced-configuration">here</a>.</p>
<p>Unfortunately, changing permissions <strong>breaks the gallery link</strong>, meaning you won't be notified about updates to the template.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/broken-link-warning.jpg" title="Broken link warning">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/broken-link-warning.jpg#ZgotmplZ" alt="Broken link warning">
  
    </a>
  
  
</div>


<blockquote>
<p>I have submitted a feature request to Google about this. Changes to permissions should be uncoupled from the gallery link.</p>
</blockquote>
<h4 id="the-tracker-configuration">The tracker configuration</h4>
<p>The tracker is created with an optional <strong>argument map</strong> of configuration settings.</p>
<p>At first, I considered adding all the tracker options as fields into the tag. However, this led to serious bloat, and I wanted to keep the tag as lean as possible (very difficult task, by the way).</p>
<p>So then I thought of just adding a table of parameters where the user can type the key-value pairs they want.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/tracker-parameter-table.jpg" title="Tracker parameter table">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/tracker-parameter-table.jpg#ZgotmplZ" alt="Tracker parameter table">
  
    </a>
  
  
</div>


<p>While this is very functional, it has some drawbacks. It's very unintuitive, and the user needs to browse the <a href="https://github.com/snowplow/snowplow/wiki/1-General-parameters-for-the-Javascript-tracker">Snowplow tracker</a> documentation to build the argument map correctly.</p>
<h4 id="the-snowplow-analytics-settings-variable">The Snowplow Analytics Settings variable</h4>
<p>Finally, I decided to follow what the <strong>Universal Analytics</strong> tag does with the <a href="https://www.simoahava.com/analytics/google-analytics-settings-variable-in-gtm/">Google Analytics Settings variable</a>. The settings variable is <strong>another template</strong>, where the user can utilize a nice user interface for setting individual settings.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/snowplow-settings-example.jpg" title="Snowplow Settings example">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/snowplow-settings-example.jpg#ZgotmplZ" alt="Snowplow Settings example">
  
    </a>
  
  
</div>


<p>Once the variable has been created, the user can add it to the Snowplow tag via the drop-down menu.</p>
<p>I decided to leave the parameter table as well. The user can check the <strong>Enable Overriding Settings For This Tag</strong> to add/modify individual parameter fields with the table. Anything added to the table overrides the corresponding parameter in the settings variable.</p>
<p>Though there's no clear way to use the table to <strong>delete</strong> a setting from the variable, setting a parameter name to <code>undefined</code> should work.</p>
<h4 id="missing-pieces">Missing pieces</h4>
<p>There's one thing missing from the tracker configuration process: <a href="https://github.com/snowplow/snowplow/wiki/1-General-parameters-for-the-Javascript-tracker#2219-configuring-cross-domain-tracking">cross-domain linking</a>. As this relies on parsing <strong>HTML elements</strong> in the callback, it couldn't be implemented in the custom template due to restrictions of the sandbox API.</p>
<p>You can still introduce cross-domain linking with a <strong>Custom HTML tag</strong>. I also submitted a feature request to Snowplow where cross-domain linking could be done by passing CSS selector strings or <code>href</code> patterns via the callback, rather than link elements themselves.</p>
<h3 id="building-the-commands">Building the command(s)</h3>
<p>Once the library is loaded and the tracker is initialized (if necessary), it's time to take the rest of the settings in the tag and bundle them into a command.</p>
<p>Building the command is split into three different types of user interfaces:</p>
<ol>
<li>Commands with a generic parameter object.</li>
<li>Commands with special conditions.</li>
<li>Custom commands.</li>
</ol>
<h4 id="parameter-object">Parameter object</h4>
<p>The Snowplow JavaScript tracker uses <strong>positional arguments</strong> to handle command logic. This means that the arguments need to be provided to the global method in a specific order, so that the values correspond with their correct, functional counterparts.</p>
<p>For example, <strong>ad tracking</strong> and impression requires the command to be compiled like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">snowplow_name_here(<span style="color:#a50">&#39;trackAdImpression&#39;</span>,
    <span style="color:#a50">&#39;67965967893&#39;</span>,             <span style="color:#aaa;font-style:italic">// impressionId
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;cpm&#39;</span>,                     <span style="color:#aaa;font-style:italic">// costModel - &#39;cpa&#39;, &#39;cpc&#39;, or &#39;cpm&#39;
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#099">5.5</span>,                      <span style="color:#aaa;font-style:italic">// cost
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;http://www.example.com&#39;</span>,  <span style="color:#aaa;font-style:italic">// targetUrl
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;23&#39;</span>,                      <span style="color:#aaa;font-style:italic">// bannerId
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;7&#39;</span>,                       <span style="color:#aaa;font-style:italic">// zoneId
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;201&#39;</span>,                     <span style="color:#aaa;font-style:italic">// advertiserId
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">&#39;12&#39;</span>                       <span style="color:#aaa;font-style:italic">// campaignId
</span><span style="color:#aaa;font-style:italic"></span>);
</code></pre></div>
<p>Having the architecture setup like this makes life difficult for this particular template author. Because of this, any named arguments need to be mapped into positional arguments. With parameter-based objects, it means that the user can create a parameter map either using a Google Tag Manager variable or the parameter table, and the object would look like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  impressionId: <span style="color:#a50">&#39;67965967893&#39;</span>,
  costModel: <span style="color:#a50">&#39;cpm&#39;</span>,
  cost: <span style="color:#099">5.5</span>
}
</code></pre></div>
<p>But because Snowplow uses positional arguments, I can't simply attach this object to the call. That would have been beautifully elegant and simple, <strong>and would have shortened the template codebase by about a half</strong>!</p>
<p>Instead, the code needs to map these named parameters to their correct positional counterparts:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#aaa;font-style:italic">// Pseudo-code
</span><span style="color:#aaa;font-style:italic"></span>snowplow_name_here(<span style="color:#a50">&#39;trackAdImpression&#39;</span>,
  data.argMap.impressionId,
  data.argMap.costModel,
  data.argMap.cost
);
</code></pre></div>
<p>I <em>could</em> have taken the easy way out and required the user to pass the positions themselves by returning an array instead of an object, but that would have made for a very clunky experience.</p>
<p>With named arguments, I can also do validation:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">if</span> ([<span style="color:#a50">&#39;cpa&#39;</span>, <span style="color:#a50">&#39;cpc&#39;</span>, <span style="color:#a50">&#39;cpm&#39;</span>].indexOf(data.argMap.costModel) === -<span style="color:#099">1</span>) <span style="color:#00a">return</span> fail(<span style="color:#a50">&#39;Invalid &#34;costModel&#34; argument provided in trackAdImpression call!&#39;</span>);
</code></pre></div>
<p>Unfortunately, as mentioned above, mapping the named parameters to their positional counterparts leads to a lot of extra code. I have submitted a feature request to Snowplow to support object arguments as well, as that would elegantly solve the whole problem (and converge with how Universal Analytics works, for example).</p>
<h4 id="special-commands">Special commands</h4>
<p>For commands with extra functionality, such as <strong>Page View</strong> and <strong>Link Tracking</strong>, I needed to create their own field groups. I <em>could</em> have gone forward with just an argument map again, but with e.g. <a href="https://github.com/snowplow/snowplow/wiki/2-Specific-event-tracking-with-the-Javascript-tracker#321-enableactivitytracking">page ping tracking</a> and <a href="https://github.com/snowplow/snowplow/wiki/2-Specific-event-tracking-with-the-Javascript-tracker#enableLinkClickTracking">automatic link tracking</a> the argument maps wouldn't suffice, as they needed to be executed as separate, additional commands.</p>
<p>Building these special groups wasn't problematic per se, but there were cases where I was pushing against the limitations of the custom template sandbox. For example, <em>automatic link tracking</em> lets you add element-based filters and contexts to the call. Because the sandbox doesn't let you interact with HTML elements, using these features is impossible.</p>
<p>That's why automatic link tracking and <a href="https://github.com/snowplow/snowplow/wiki/2-Specific-event-tracking-with-the-Javascript-tracker#3101-enableformtracking">form tracking</a> have been stripped to just the <strong>whitelist</strong> and <strong>blacklist</strong> features.</p>
<h4 id="custom-commands">Custom commands</h4>
<p>Finally, there are many commands in the Snowplow library that aren't directly related to an event. These are all grouped under <strong>Custom Commands</strong>.</p>
<p>Many of these are just plain commands without any arguments. In such instances, the <strong>Command argument</strong> field is not shown.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/flushbuffer-custom-command.jpg" title="flushBuffer custom command">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/flushbuffer-custom-command.jpg#ZgotmplZ" alt="flushBuffer custom command">
  
    </a>
  
  
</div>


<p>In other cases, there's a field where the user can add the argument(s).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/custom-command-global-contexts.jpg" title="Global Contexts command">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/custom-command-global-contexts.jpg#ZgotmplZ" alt="Global Contexts command">
  
    </a>
  
  
</div>


<p>There's only very little validation for these arguments. Typically it's making sure the parameter is in the correct format, and with e.g. <code>enableGdprContext</code> it turns a comma-separated string into an array.</p>
<p>However, the expectation is that when the template user adds custom commands, they either know exactly what they're doing, or they're reading documentation that explains how to set these things up.</p>
<p>In general, I'd recommend using Google Tag Manager variables instead of hard-coding the arguments. It makes it easier to switch on the fly if necessary.</p>
<h3 id="firing-the-commands">Firing the commands</h3>
<p>Finally, once the tracker is created and the commands have been built, they are all executed in order by invoking the global method.</p>
<p>For example, creating a new tracker, setting up page ping tracking, and sending a pageview would end up with the following items added to the global queue for execution (in order):</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2020/05/snowplow-queue.jpg" title="Snowplow Queue">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2020/05/snowplow-queue.jpg#ZgotmplZ" alt="Snowplow Queue">
  
    </a>
  
  
</div>


<h2 id="summary">Summary</h2>
<p>Building the template has been a very educational journey, and it also helped spawn a number of feature requests for Google Tag Manager and for Snowplow's JavaScript tracker, each of which I'm sure will make both solutions even stronger.</p>
<p>Early on I had an idea of creating a super smooth user interface, where every single parameter, event, and option was confined to its own field with full validation, value hints, help texts, and so forth.</p>
<p>This was a bad idea.</p>
<p>First of all, there's a limitation of something like <strong>100 fields</strong> in any given template. Before you shout in indignation, <strong>it makes perfect sense</strong>. Having a behemoth of a template forced upon the UI every single time a new tag or variable is created is not favorable to Google Tag Manager's performance.</p>
<p>Also, if you have a template that requires 100 fields, it's possible you should look into modularizing it.</p>
<p>The Snowplow template is <strong>big</strong>. It's close to the 100 field limit. I know this because I ran into the limit a couple of times and had to refactor. If it turns out to be a performance hog, I'll look into splitting it up into smaller parts (e.g. one template for most used events, another for the rest).</p>
<p>Separating the tracker configuration into its own variable template was a step towards modularity, and depending on the feedback we'll (Snowplow and I) see if there needs to be more of it.</p>
<p>I hope this article has been useful. I'm still a huge fan of custom templates and firmly believe they are the future of Google's tag management. I do hope that new APIs are consistently added to the sandbox, as some of the limitations are pretty jarring especially when methods you'd expect most JavaScript libraries to leverage are blocked (I'm looking at you, <code>JSON.parse</code>).</p>
<p>If you have feedback about the templates, be sure to raise them as <strong>issues</strong> in the respective repositories: <a href="https://github.com/snowplow/snowplow-gtm-custom-template/issues">Snowplow Analytics tag template</a> and <a href="https://github.com/snowplow/snowplow-gtm-custom-template-settings/issues">Snowplow Analytics Settings variable template</a>.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/custom-templates/">custom templates</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/tag-templates/">tag templates</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/variable-templates/">variable templates</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/snowplow/">snowplow</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Snowplow%20Analytics%20Templates%20For%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/track-interactions-in-shadow-dom-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Snowplow%20Analytics%20Templates%20For%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Snowplow%20Analytics%20Templates%20For%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/snowplow-analytics-templates-google-tag-manager/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

