

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "True View Ecommerce Impressions With Google Tag Manager | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/01\/true-view-impressions-google-tag-manager.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/true-view-impressions-google-tag-manager\/",
  "datePublished": "2019-01-21T11:36:08\x2b02:00",
  "dateModified": "2019-01-21T11:36:08\x2b02:00",
  "description": "Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.58.3 with theme Tranquilpeak 0.4.3-BETA">
    <title>True View Ecommerce Impressions With Google Tag Manager | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <script src="//simoahava.disqus.com/count.js" id="dsq-count-scr" async></script>
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/true-view-impressions-google-tag-manager/">
    
    <meta name="description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.">
    <meta property="og:description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="True View Ecommerce Impressions With Google Tag Manager">
    <meta property="og:url" content="/analytics/true-view-impressions-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="True View Ecommerce Impressions With Google Tag Manager">
    <meta name="twitter:description" content="Measure Enhanced Ecommerce impressions in batches of items that were actually viewed (i.e. scrolled into the viewport). The solution is for Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      True View Ecommerce Impressions With Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-01-21T11:36:08&#43;02:00">
        
  January 21, 2019

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/#disqus_thread">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              

<p>I&rsquo;m a big fan of <a href="https://www.simoahava.com/analytics/enhanced-ecommerce-guide-for-google-tag-manager/">Enhanced Ecommerce</a> in <a href="https://analytics.google.com/">Google Analytics</a>. In fact, I think it&rsquo;s the <strong>only</strong> valid way to deploy Ecommerce tracking today, especially when using <a href="https://tagmanager.google.com/">Google Tag Manager</a>. The ability to use a <a href="https://www.simoahava.com/analytics/enhanced-ecommerce-guide-for-google-tag-manager/#send-the-data-to-google-analytics-using-a-custom-javascript-variable">Custom JavaScript variable</a> and the possibility to tackle the <em>full</em> ecommerce funnel are some of the benefits of using Enhanced Ecommerce.</p>

<p>However, tracking certain view-based events, <strong>impressions</strong> in particular, has a significant problem when it comes to how Google Analytics processes events. In a nutshell, when implemented by the book, <strong>impressions are sent for all the product impressions on the page when the page is loaded</strong>. In other words, you are collecting hits from impressions the user <em>might not actually have seen</em>.</p>

<p>This also compounds into a number of problems:</p>

<ul>
<li><p>Google Analytics has a maximum <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/limits-quotas#universal_properties">hits per session</a> of 500. And this is a hard limit. Anything past 500 will simply <strong>not be recorded</strong> in the session (though if you&rsquo;re using the paid GA360 you&rsquo;ll still be billed for them!). If you send each impression separately, or even if you send them in batches but don&rsquo;t discard the ones the user never saw, you might be approaching or going past this quota limit.</p></li>

<li><p>The <a href="https://www.simoahava.com/analytics/automatically-reduce-google-analytics-payload-length/">maximum payload length</a> is <strong>8192 bytes</strong> for any GA request. This is easily surpassed if you&rsquo;re sending 50-60 impressions in a single hit.</p></li>
</ul>

<p>In this article, I want to tackle both of these problems by introducing a way of tracking <strong>only those impressions that were viewable in the browser viewport</strong>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg" title="true view impressions google tag manager">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/true-view-impressions-google-tag-manager.jpg#ZgotmplZ" alt="true view impressions google tag manager">
  
    </a>
  
  
</div>



<p>This solution is written for <strong>Google Tag Manager</strong>, as it utilizes a number of features that are built natively into the platform.</p>

<p>I&rsquo;m also going to use <a href="https://www.simoahava.com/analytics/customtask-the-guide/"><code>customTask</code></a>, because I want to write the whole solution <a href="https://www.simoahava.com/analytics/trigger-javascript-without-using-custom-html-tag/">without using a Custom HTML tag</a>.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#how-it-works">How it works</a></li>
<li><a href="#what-you-need">What you need</a></li>
<li><a href="#create-the-variables">Create the variables</a>
<ul>
<li><a href="#lookup-get-impression-label">{{Lookup - Get Impression Label}}</a></li>
<li><a href="#lookup-get-impression-interaction">{{Lookup - Get Impression Interaction}}</a></li>
<li><a href="#js-function-true-view-impression-handler">{{JS - Function - True view impression handler}}</a></li>
<li><a href="#js-get-true-view-object">{{JS - Get True View object}}</a></li>
</ul></li>
<li><a href="#create-the-triggers">Create the triggers</a>
<ul>
<li><a href="#the-element-visibility-trigger">The Element Visibility trigger</a></li>
<li><a href="#the-custom-event-trigger">The Custom Event trigger</a></li>
<li><a href="#the-timer-trigger">The Timer trigger</a></li>
<li><a href="#the-click-trigger">The Click trigger</a></li>
</ul></li>
<li><a href="#create-the-tag">Create the tag</a></li>
<li><a href="#how-to-test">How to test</a>
<ul>
<li><a href="#test-the-batch-queue-first">Test the batch queue first</a></li>
<li><a href="#test-with-a-timer">Test with a timer</a></li>
<li><a href="#test-a-product-click">Test a product click</a></li>
<li><a href="#test-the-beforeunload-listener">Test the <code>beforeunload</code> listener</a></li>
</ul></li>
<li><a href="#final-words">Final words</a></li>
</ul></li>
</ul>
</nav>

<h2 id="how-it-works">How it works</h2>

<p>The solution relies on the <a href="https://www.simoahava.com/analytics/element-visibility-trigger-google-tag-manager/"><strong>Element Visibility trigger</strong></a> to identify impressions in the viewport and push them into a <strong>batch queue</strong>. A <a href="https://www.simoahava.com/gtm-tips/timer-trigger/"><strong>Timer trigger</strong></a> is also used to purge the batch queue in case the user is inactive. Finally, if a user <strong>clicks</strong> on an impression, all the items in the batch queue are sent, as are they if the user leaves the page.</p>

<p>A <strong>batch queue</strong> is what we&rsquo;ll use to group the viewed impressions together into units of certain size, so that the request to GA is neither too crowded (risking going past the payload length limit) or too sparse (risking having too many hits in the session).</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/batched-impressions.jpg" title="Impressions in batches">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/batched-impressions.jpg#ZgotmplZ" alt="Impressions in batches">
  
    </a>
  
  
</div>



<p>Here&rsquo;s a simple flow of how the solution works:</p>

<ol>
<li><p>When the page is first loaded, an inventory of impression objects is built by identifying an <code>ecommerce.impressions</code> object in the <code>dataLayer</code>.</p></li>

<li><p>Every single product impression on the page itself will need to have an identifying attribute that links the product impression with the corresponding object in the <code>ecommerce.impressions</code> array in <code>dataLayer</code>. This should be something like <code>data-productid=&quot;impression1&quot;</code> where <code>impression1</code> is the ID of the impression.</p></li>

<li><p>The <strong>Element Visibility</strong> trigger waits for items with this <code>data-productid</code> to become visible on the page, adding each into a batch array of viewed impressions.</p></li>

<li><p>When the array length reaches the batch maximum you define, the impressions in the batch array are sent to GA and then deleted from the array (so that you don&rsquo;t end up sending them again).</p></li>

<li><p>If the user <strong>clicks</strong> a product impression on the page, a Product Click event is sent with that impression data together with <strong>all</strong> the items in the current batch queue.</p></li>

<li><p>Every 60 seconds (configurable), the batch queue is also emptied and sent to GA to avoid the impressions from being stuck in the queue for a long period of time if the user is inactive.</p></li>

<li><p>When the user leaves the current page, a custom <a href="https://www.simoahava.com/analytics/fire-trigger-when-user-about-to-leave-page/"><code>beforeunload</code> listener</a> will also send any impressions left in the batch queue.</p></li>
</ol>

<p>The end result is that as impressions are viewed by the visitor, items are added to the batch queue and sent whenever the queue fills up. There are safeguards (timer, <code>beforeunload</code>) which ensure that items are never forgotten in the queue.</p>

<p>It&rsquo;s not trivial to set up, so let&rsquo;s get to it.</p>

<h2 id="what-you-need">What you need</h2>

<p>First of all, you need a fairly solid understanding of what Enhanced Ecommerce impressions are, how they are (traditionally) tracked, and how they appear in your GA reports. This guide will <strong>not</strong> go over the basics. Check out my <a href="https://www.simoahava.com/analytics/enhanced-ecommerce-guide-for-google-tag-manager/">Enhanced Ecommerce guide</a>, as well as Google&rsquo;s <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/enhanced-ecommerce">official support documentation</a> for more information.</p>

<p>For the solution to work &ldquo;out-of-the-box&rdquo;, you will need a <strong>properly formatted</strong> <code>ecommerce.impressions</code> object in the <code>dataLayer</code> deployed into the page template preferably <strong>before the GTM container snippet</strong>. This is what you should already have if you&rsquo;ve implemented Enhanced Ecommerce impressions <a href="https://developers.google.com/tag-manager/enhanced-ecommerce#product-impressions">by the book</a>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/impressions-in-datalayer.jpg" title="Enhanced Ecommerce impressions in dataLayer">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/impressions-in-datalayer.jpg#ZgotmplZ" alt="Enhanced Ecommerce impressions in dataLayer">
  
    </a>
  
  
</div>



<p>It&rsquo;s possible to modify the code so it works with objects with a different composition, and it&rsquo;s also possible to modify it to work with impressions scraped from the page. However, this guide will not tackle these edge cases. If you want to make these modifications yourself, feel free to do so (let me know in the comments if you need help).</p>

<p>Another thing you&rsquo;ll need is a way to tag all the HTML elements that contain impressions with the custom attribute that will link the impression to the corresponding <code>dataLayer</code> object. For example, this is what the first seven products on the page would look like if using the <code>impressions</code> data from the screenshot above:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/data-productid-html.jpg" title="data-productid">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/data-productid-html.jpg#ZgotmplZ" alt="data-productid">
  
    </a>
  
  
</div>



<p>As you can see, the value in <code>data-productid</code> corresponds with the individual <code>id</code> values in the <code>ecommerce.impressions</code> object.</p>

<p>You could add these dynamically using a Custom HTML tag and some DOM manipulation magic, but I do recommend doing this <strong>correctly</strong> from the start. Adding the attributes directly into template code prevent any race conditions from emerging, such as the Element Visibility trigger not identifying the items to which you dynamically added the new attributes.</p>

<p>Once you have the <code>dataLayer</code> object and the data attributes in place, you can get to work on the Google Tag Manager tags, triggers, and variables.</p>

<h2 id="create-the-variables">Create the variables</h2>

<p>We&rsquo;re going to need a handful of variables. Two <strong>Lookup Table</strong> variables will handle some of the event tag logic. A <strong>Custom JavaScript</strong> variable for the <code>customTask</code> will be where most of the magic happens. Then, we&rsquo;ll also need a <strong>Custom JavaScript</strong> variable to handle the Enhanced Ecommerce object compilation.</p>

<p>There are many moving parts here, so let&rsquo;s get to work.</p>

<h3 id="lookup-get-impression-label">{{Lookup - Get Impression Label}}</h3>

<p>This <strong>Lookup Table variable</strong> will be used to populate the <strong>Event Label</strong> field of the tag we&rsquo;ll create label. As the label, i&rsquo;m using either &ldquo;Impression View&rdquo; or &ldquo;Impression Click&rdquo;, depending on what type of event caused the tag to fire. As you can guess, the tag will fire for both impressions views and clicks.</p>

<p>This is what the Lookup Table variable should look like:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/lookup-impression-label.jpg" title="Lookup - impression label">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/lookup-impression-label.jpg#ZgotmplZ" alt="Lookup - impression label">
  
    </a>
  
  
</div>



<h3 id="lookup-get-impression-interaction">{{Lookup - Get Impression Interaction}}</h3>

<p>This <strong>Lookup Table variable</strong> will return either <code>true</code> or <code>false</code>, depending on whether the hit was <em>non-interaction</em> or not. We&rsquo;ll create all <strong>impression views</strong> as non-interactive, and the <strong>product impression click</strong> will be interactive.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/lookup-impression-interaction.jpg" title="Lookup - impression noninteractive">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/lookup-impression-interaction.jpg#ZgotmplZ" alt="Lookup - impression noninteractive">
  
    </a>
  
  
</div>



<h3 id="js-function-true-view-impression-handler">{{JS - Function - True view impression handler}}</h3>

<p>This is the main driving force of the solution. It&rsquo;s a <a href="https://www.simoahava.com/analytics/customtask-the-guide/"><code>customTask</code></a> variable, designed to build the batch queue, to create the <code>beforeunload</code> handler, to allow hits to fire (when the batch queue is full or a product is clicked), and to block GA hits from being dispatched (if the impression was simply added to the queue).</p>

<p>Here&rsquo;s what the code in the <strong>Custom JavaScript</strong> variable should look like:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#75715e">// Configure the following
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">maxBatch</span>           <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
      <span style="color:#a6e22e">batchVariableName</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_impressions_batch&#39;</span>,
      <span style="color:#a6e22e">productIdAttribute</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data-productid&#39;</span>;
  
  <span style="color:#75715e">// Do not touch anything below this
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">targetElement</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Click</span> <span style="color:#a6e22e">Element</span>}},
      <span style="color:#a6e22e">event</span>         <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Event</span>}};

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) {
    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">tagName</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;BODY&#39;</span>) {
      <span style="color:#a6e22e">targetElement</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">parentElement</span>;
    }
  }

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">customModel</span>) {

    <span style="color:#75715e">// Set up the beforeunload listener only when the tag is first run.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
      window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;beforeunload&#39;</span>, <span style="color:#66d9ef">function</span>() {
		window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
          <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sendFinalBatch&#39;</span>
        });
      });
    }
    
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>,
        <span style="color:#a6e22e">batch</span>      <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">||</span> [],
        <span style="color:#a6e22e">impressionId</span>, 
        <span style="color:#a6e22e">ost</span>;
        
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.elementVisibility&#39;</span>) {
      <span style="color:#a6e22e">impressionId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>);
      <span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">impressionId</span>);
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">maxBatch</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
    }
    
    <span style="color:#66d9ef">if</span> ([<span style="color:#e6db74">&#39;sendFinalBatch&#39;</span>, <span style="color:#e6db74">&#39;gtm.timer&#39;</span>].<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">event</span>) <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
    
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
    
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">shouldFire</span>) {
      <span style="color:#a6e22e">ost</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;sendHitTask&#39;</span>);
      <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;sendHitTask&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">sendModel</span>) {
        <span style="color:#a6e22e">ost</span>(<span style="color:#a6e22e">sendModel</span>);
        window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">=</span> [];
      });
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">keys</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">key</span>) {
        <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">null</span>);
      });
    }
  };
}
</code></pre></div>

<p>First, modify the three variables in the beginning of the returned <code>function</code>.</p>

<ul>
<li><p>Set <code>maxBatch</code> to the maximum length of the batch queue. The default value of <code>10</code> is probably enough in most cases.</p></li>

<li><p>Set <code>batchVariableName</code> to what the global variable that stores the batch queue should be named. The default value is, again, probably OK, but you&rsquo;ll want to rename it in the rare case that a global variable named <code>_impressions_batch</code> already exists and is in use.</p></li>

<li><p>Set <code>productIdAttribute</code> to the HTML attribute name that stores the ID with each product HTML block on the page. The default value is <code>data-productid</code>, which means that the HTML structures that contain each product impression should have the attribute <code>data-productid=&quot;some_product_id&quot;</code> in one of the elements (preferably an element that wraps the entire impression).</p></li>
</ul>

<p>Let me tear this code apart and show you what each individual part does.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) {
  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">tagName</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;BODY&#39;</span>) {
    <span style="color:#a6e22e">targetElement</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">parentElement</span>;
  }
}
</code></pre></div>

<p>This is a simple iterator which climbs up the element tree from the clicked element until it finds the element with the aforementioned product ID attribute.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
  window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;beforeunload&#39;</span>, <span style="color:#66d9ef">function</span>() {
    window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
      <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sendFinalBatch&#39;</span>
    });
  });
}
</code></pre></div>

<p>When the <code>customTask</code> is fired for the first time on the page, a <code>beforeunload</code> listener is created. The idea is that when the user leaves the current page, the <code>beforeunload</code> event that is automatically dispatched triggers a <code>window.dataLayer.push()</code> call that we can then use to send the remaining items in the batch queue.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>,
    <span style="color:#a6e22e">batch</span>      <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">||</span> [],
    <span style="color:#a6e22e">impressionId</span>, 
    <span style="color:#a6e22e">ost</span>;
</code></pre></div>

<p>By default, the <code>customTask</code> blocks the Google Analytics request from firing (<code>shouldFire = false</code>). Also, here we create the batch queue if one doesn&rsquo;t already exist.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.elementVisibility&#39;</span>) {
  <span style="color:#a6e22e">impressionId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>);
  <span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">impressionId</span>);
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">maxBatch</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
}
</code></pre></div>

<p>If the tag was fired due to a visibility event, the product ID that triggered the event will be pushed into the batch queue. If the batch queue thus reaches its maximum length, <code>customTask</code> will allow the hit to fire.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span> ([<span style="color:#e6db74">&#39;sendFinalBatch&#39;</span>, <span style="color:#e6db74">&#39;gtm.timer&#39;</span>].<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">event</span>) <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
    
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) { <span style="color:#a6e22e">shouldFire</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
</code></pre></div>

<p>If the trigger event was <code>sendFinalBatch</code> (i.e. the user is trying to leave the page) or <code>gtm.timer</code> (i.e. 60 seconds have passed since the previous timer event or page load) AND if the batch queue has items in it, the hit will be allowed to fire, thus clearing the batch queue and sending all the items within to GA.</p>

<p>If the trigger event was a click, meaning the user clicked a product impression, the GA request will be allowed to complete as well.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">shouldFire</span>) {
  <span style="color:#a6e22e">ost</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;sendHitTask&#39;</span>);
  <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;sendHitTask&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">sendModel</span>) {
    <span style="color:#a6e22e">ost</span>(<span style="color:#a6e22e">sendModel</span>);
    window[<span style="color:#a6e22e">batchVariableName</span>] <span style="color:#f92672">=</span> [];
  });
} <span style="color:#66d9ef">else</span> {
  <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">keys</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">key</span>) {
    <span style="color:#a6e22e">customModel</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">null</span>);
  });
}
</code></pre></div>

<p>If the GA hit is allowed to fire, the first part of the <code>if</code> clause will do just that. After the hit has been sent, the batch queue is cleared of all items.</p>

<p>If the GA hit was blocked, then the <code>else</code> clause will clear the model object thus effectively preventing the Google Analytics hit from being dispatched.</p>

<h3 id="js-get-true-view-object">{{JS - Get True View object}}</h3>

<p>This variable builds the Enhanced Ecommerce object when the tag fires. It&rsquo;s used to build both the impression <strong>view</strong> object and the impression <strong>click</strong> object.</p>

<p>So, create a <strong>Custom JavaScript</strong> variable, and put the following code within:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#75715e">// Configure the following:
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">maxBatch</span>           <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
      <span style="color:#a6e22e">batchVariableName</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_impressions_batch&#39;</span>,
      <span style="color:#a6e22e">productIdAttribute</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data-productid&#39;</span>; 
  
  <span style="color:#75715e">// Do not touch anything below this
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">targetElement</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Click</span> <span style="color:#a6e22e">Element</span>}},
      <span style="color:#a6e22e">event</span>         <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Event</span>}},
      <span style="color:#a6e22e">batch</span>         <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">batchVariableName</span>],
      <span style="color:#a6e22e">impressions</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">google_tag_manager</span>[{{<span style="color:#a6e22e">Container</span> <span style="color:#a6e22e">ID</span>}}].<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;ecommerce.impressions&#39;</span>),
      <span style="color:#a6e22e">ecomObj</span>       <span style="color:#f92672">=</span> {<span style="color:#a6e22e">ecommerce</span><span style="color:#f92672">:</span> {}};

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) {
    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">tagName</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;BODY&#39;</span>) {
      <span style="color:#a6e22e">targetElement</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">parentElement</span>;
    }
  }

  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">latestImpression</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">impressions</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">impression</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">impression</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">targetElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">productIdAttribute</span>);
  }).<span style="color:#a6e22e">shift</span>();

  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">impressionsArr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">batch</span>.<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">id</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">impressions</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">impression</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">impression</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">id</span>;
    }).<span style="color:#a6e22e">shift</span>();
  });
  
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.elementVisibility&#39;</span>){
    <span style="color:#a6e22e">impressionsArr</span>[<span style="color:#a6e22e">maxBatch</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">latestImpression</span>;
  }

  <span style="color:#a6e22e">ecomObj</span>.<span style="color:#a6e22e">impressions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">impressionsArr</span>; 

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;gtm.click&#39;</span>) {
    <span style="color:#a6e22e">ecomObj</span>.<span style="color:#a6e22e">click</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">actionField</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">list</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">latestImpression</span>.<span style="color:#a6e22e">list</span>
      },
      <span style="color:#a6e22e">products</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">latestImpression</span>]
    };
  }
  <span style="color:#66d9ef">return</span> {
    <span style="color:#a6e22e">ecommerce</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ecomObj</span>
  };
}
</code></pre></div>

<p>As you can see, you&rsquo;ll need to configure the <strong>exact</strong> same settings (<code>maxBatch</code>, <code>batchVariableName</code>, <code>productIdAttribute</code>) in the beginning of this script as you had to in the <a href="https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/#js-function-true-view-impression-handler">previous Custom JavaScript variable</a>. It&rsquo;s important that these match <strong>exactly</strong> to the settings you configured earlier, so double-check to make sure they are the same.</p>

<p>Other than that, the purpose of the JavaScript is to compile the impression product IDs in the batch queue to the corresponding Enhanced Ecommerce objects. If the event was a click, then the impression that was clicked will be sent as the Product Click target.</p>

<h2 id="create-the-triggers">Create the triggers</h2>

<p>We&rsquo;ll need a whopping <strong>four</strong> triggers all attached to the tag.</p>

<p>An <strong>Element Visibility</strong> trigger will handle building the batch queue from product impression views.</p>

<p>A <strong>Custom Event</strong> trigger will fire the tag when the user is trying to leave the page.</p>

<p>A <strong>Timer</strong> trigger will send the items in the batch queue periodically.</p>

<p>A <strong>Click</strong> trigger will fire the tag when the user clicks a product impression.</p>

<h3 id="the-element-visibility-trigger">The Element Visibility trigger</h3>

<p>The Element Visibility trigger will fire whenever a <strong>new</strong> product impression becomes visible. It will only fire once per element, which ensures that those elements for which an impression hit has already been sent won&rsquo;t get another impression sent while the user is on the page.</p>

<p>The Element Visibility trigger will be set to fire when any element with the give <strong>product ID attribute</strong> becomes visible. It&rsquo;s important that you use the <strong>same attribute name</strong> you used in the two Custom JavaScript variables created above. If the attribute name was, for example, <code>data-productid</code>, the CSS selector you&rsquo;d need to configure in the Element Visibility trigger should be <code>[data-productid]</code>. Check <a href="https://www.simoahava.com/gtm-tips/10-useful-css-selectors/">this</a> if you need a refresher on CSS selectors.</p>

<p>Anyway, make sure the trigger looks like something like this (with the change in the CSS selector if needed):</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/visibility-trigger.jpg" title="Visibility trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/visibility-trigger.jpg#ZgotmplZ" alt="Visibility trigger">
  
    </a>
  
  
</div>



<p>You can change the percentage of the element that needs to be visible if you wish.</p>

<h3 id="the-custom-event-trigger">The Custom Event trigger</h3>

<p>The Custom Event trigger is simple. It fires whenever the <code>beforeunload</code> listener (created in <a href="https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/#js-function-true-view-impression-handler">the <code>customTask</code> variable</a>) is triggered by the user trying to leave the page.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/custom-event-trigger.jpg" title="Custom Event trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/custom-event-trigger.jpg#ZgotmplZ" alt="Custom Event trigger">
  
    </a>
  
  
</div>



<h3 id="the-timer-trigger">The Timer trigger</h3>

<p>The Timer trigger will dispatch the items in the queue when it goes off. It&rsquo;s a good backup to have, because otherwise you run the risk of items being left in the queue indefinitely, only to be dispatched when the user triggers another visibility event some time in the future. This might lead to hermit sessions, where the only hits are these impression view hits. Not very useful.</p>

<p>You can freely modify the settings of the trigger. Having it fire continuously isn&rsquo;t that big a deal. The Google Analytics tag will always fire, yes, but the <code>customTask</code> will make sure that no hit is actually built unless the batch queue actually has items in it.</p>

<p>As you can see, I also make sure that the timer trigger only fires on valid pages by checking if a Data Layer variable for the key <code>ecommerce.impressions</code> is not <code>undefined</code>. This way the trigger will only activate on pages where there&rsquo;s the possibility of viewing impressions. You can change the condition to something else if it makes more sense.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/timer-trigger.jpg" title="Timer trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/timer-trigger.jpg#ZgotmplZ" alt="Timer trigger">
  
    </a>
  
  
</div>



<h3 id="the-click-trigger">The Click trigger</h3>

<p>The Click trigger has a simple purpose. It fires when a product impression is clicked, thus sending a Product Click payload to Google Analytics (along with any impressions that might have been in the batch queue).</p>

<p>Remember to change the CSS selector to match the HTML attribute you use to encode the product ID for every product impression element on the page.</p>

<p>If you&rsquo;re curious about the <code>[data-productid], [data-productid] *</code> syntax, take a look at <a href="https://www.simoahava.com/analytics/use-wildcard-css-selectors-with-all-elements-triggers/">this article</a>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/click-trigger.jpg" title="Click trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/click-trigger.jpg#ZgotmplZ" alt="Click trigger">
  
    </a>
  
  
</div>



<h2 id="create-the-tag">Create the tag</h2>

<p>Finally, the tag itself. Now that you have all the necessary variables and triggers created, it&rsquo;s just a question of putting them all together in the tag.</p>

<p>Feel free to modify what you send with <strong>Event Category</strong>, <strong>Event Action</strong>, and <strong>Event Label</strong>.</p>

<p>Make sure you have the <code>transport</code> field set to <code>beacon</code>, since you&rsquo;ll want those <code>beforeunload</code> hits to be sent <a href="https://www.simoahava.com/analytics/fire-trigger-when-user-about-to-leave-page/#set-the-transport-field-in-google-analytics-tags">even if the page has already been unloaded</a>.</p>

<ul>
<li><p><strong>Tag Type</strong>: Universal Analytics</p></li>

<li><p><strong>Track Type</strong>: Event</p></li>

<li><p><strong>Category</strong>: Ecommerce</p></li>

<li><p><strong>Action</strong>: Impressions</p></li>

<li><p><strong>Label</strong>: {{Lookup - Get Impression Label}}</p></li>

<li><p><strong>Non-Interaction Hit</strong>: {{Lookup - Get Impression Interaction}}</p></li>

<li><p><strong>Enable overriding settings in this tag</strong>: Checked</p></li>

<li><p><strong>Tracking ID</strong>: UA-XXXXXX-Y</p></li>

<li><p><strong>Fields to Set</strong>:<br />
&ndash; <strong>Field Name</strong>: <code>customTask</code>, <strong>Value</strong>: {{JS - Function - True view impression handler}}<br />
&ndash; <strong>Field Name</strong>: <code>transport</code>, <strong>Value</strong>: <code>beacon</code></p></li>

<li><p><strong>Enable Enhanced Ecommerce Features</strong>: True<br />
&ndash; <strong>Read Data from Variable</strong>: {{JS - Get True View object}}</p></li>
</ul>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/impression-event-tag-1.jpg" title="Impression event tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/impression-event-tag-1.jpg#ZgotmplZ" alt="Impression event tag">
  
    </a>
  
  
</div>



<p>Finally, add all four triggers created in the previous chapter to this tag.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/impression-event-tag-2.jpg" title="Impression event tag 2">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/impression-event-tag-2.jpg#ZgotmplZ" alt="Impression event tag 2">
  
    </a>
  
  
</div>



<p>And you&rsquo;re all set! Then it&rsquo;s time to test things out.</p>

<h2 id="how-to-test">How to test</h2>

<p>It&rsquo;s important <strong>not</strong> to rely on Google Tag Manager&rsquo;s debug mode to test this out. Why? Because even if it says that a Google Analytics tag has fired, it&rsquo;s <code>customTask</code> that governs whether the request was completed or not.</p>

<p>So, I recommend you install David Vallejo&rsquo;s excellent <a href="https://chrome.google.com/webstore/detail/gtmga-debug/ilnpmccnfdjdjjikgkefkcegefikecdc?hl=en">GTM/GA Debug</a> extension. It shows you what hits are actually sent to Google Analytics, and it has an excellent Enhanced Ecommerce tab for seeing exactly what impressions are dispatched.</p>

<h3 id="test-the-batch-queue-first">Test the batch queue first</h3>

<p>When a page with impression loads, test how your batch queue works.</p>

<p>You should see one <code>gtm.elementVisibility</code> event in the Debug mode panel for every product impression you see in the viewport of the page. These events should not dispatch the hit to GA <strong>until you reach the same number of visibility events as the maximum queue size</strong>.</p>

<p>So if you&rsquo;ve configured the <code>maxBatch</code> in the Custom JavaScript variables to 10, then the first nine <code>gtm.elementVisibility</code> events should do nothing, but the tenth one should fire an Impressions hit with ten impressions within. And after that, every tenth visibility event should send another batch, etc.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/impression-views-test.jpg" title="Impression views test">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/impression-views-test.jpg#ZgotmplZ" alt="Impression views test">
  
    </a>
  
  
</div>



<h3 id="test-with-a-timer">Test with a timer</h3>

<p>Next, make sure you have some Element Visibility triggers fired after the previous batch has been sent, but not enough to send another batch. In other words, you want the queue to contain some impressions, but not enough to trigger a batch dispatch.</p>

<p>Then, wait for the Timer trigger to go off. It will fire as soon as the interval is reached. In this guide, I&rsquo;m using a 60 second interval, so within one minute of the page load the trigger should fire. When the trigger fires, it should send the items in the batch queue as an impression hit. The number of impressions should be less than what would be sent if the queue filled up.</p>

<p>For example, here the batch queue limit has been reached twice, sending two sets of three impressions to Google Analytics. The third impression hit with just one impression is due to the timer trigger sending the remaining impression.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/timer-test.jpg" title="Timer test">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/timer-test.jpg#ZgotmplZ" alt="Timer test">
  
    </a>
  
  
</div>



<h3 id="test-a-product-click">Test a product click</h3>

<p>Again, scroll until the queue has items but not enough to fill the queue up to its maximum length. Then, click one product impression. What you should see is an Enhanced Ecommerce hit with the Product Click details of the impression that was clicked, <strong>and a list of impression views that were in the queue</strong>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/click-test.jpg" title="Click trigger test">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/click-test.jpg#ZgotmplZ" alt="Click trigger test">
  
    </a>
  
  
</div>



<h3 id="test-the-beforeunload-listener">Test the <code>beforeunload</code> listener</h3>

<p>Finally, scroll until the queue has items but not enough to fill the queue. Then, click a link away from the current page (not a product impression!). Using the GTM/GA Debug extension, you should see the hits for the previous page including an impression view hit with some impressions (less than the maximum queue length):</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/beforeunload-test.jpg" title="Beforeunload test">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/beforeunload-test.jpg#ZgotmplZ" alt="Beforeunload test">
  
    </a>
  
  
</div>



<h2 id="final-words">Final words</h2>

<p>This is a fairly simple implementation. The &ldquo;catch&rdquo; is that it doesn&rsquo;t use a Custom HTML tag. Everything is handled through a single Universal Analytics tag, utilizing the power of <code>customTask</code> to get the work done.</p>

<p>It&rsquo;s not perfect. Without a Custom HTML tag, you&rsquo;ll need to use the default Timer trigger which leaves a lot to be desired. For example, optimally I&rsquo;d want to create a custom timer that would let me reset it whenever the batch queue is cleared and the first new item is added. That way the timer would not fire needlessly on the page. This isn&rsquo;t really doable in the <code>customTask</code> - you would need a Custom HTML tag to do it.</p>

<p>And why not use a Custom HTML tag? For one, this is a fun exercise to do. The other reason is that GTM has a fairly robust thing going on with the Element Visibility trigger, and I want to make use of it without polluting the page with numerous Custom HTML tags; one for every product impression found by the Element Visibility trigger.</p>

<p>Some might also consider the prerequisites unreasonable. Being forced to have an Enhanced Ecommerce <code>dataLayer</code> object AND the HTML elements decorated with custom data attributes might seem like too much work. It&rsquo;s a lot of work, but not <strong>too much</strong> work. Tracking impressions reliably by utilizing the Element Visibility trigger requires a strong link between the items on the page and those in the <code>dataLayer</code>. You could build your own custom system to support DOM scraping and custom <code>dataLayer</code> object compositions, but I&rsquo;ll leave that to your capable hands.</p>

<p>Anyway, I hope you found this guide inspiring. Let me know in the comments what you think!</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/customtask/">customtask</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/enhanced-ecommerce/">enhanced ecommerce</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/enhanced-ecommerce-facebook-pixel/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/trigger-javascript-without-using-custom-html-tag/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=True%20View%20Ecommerce%20Impressions%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <span id="disqus"></span>
<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/enhanced-ecommerce-facebook-pixel/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/trigger-javascript-without-using-custom-html-tag/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=True%20View%20Ecommerce%20Impressions%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=True%20View%20Ecommerce%20Impressions%20With%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/true-view-impressions-google-tag-manager/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




  
    
      <script>
        





        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'simoahava';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

