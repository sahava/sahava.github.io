<!doctype html><html lang=en-us><head><meta name=google-site-verification content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"#BigQueryTips: Query Guide To Google Analytics: App \u002b Web | Simo Ahava's blog","image":"https:\/\/www.simoahava.com\/images\/2019\/09\/bigquery-guide-app-web.jpg","editor":"Simo Ahava","publisher":{"@type":"Organization","name":"Simo Ahava's blog","logo":{"@type":"ImageObject","url":"https:\/\/www.simoahava.com\/images\/simo.png","height":"393","width":"407"}},"url":"https:\/\/www.simoahava.com\/analytics\/bigquery-query-guide-google-analytics-app-web\/","datePublished":"2019-10-15T08:00:00\u002b03:00","dateModified":"2019-10-15T08:00:00\u002b03:00","description":"This is a Getting Started guide to using BigQuery with the dataset pulled in from a Google Analytics App\u002bWeb view.","author":{"@type":"Person","name":"Simo Ahava"}}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>#BigQueryTips: Query Guide To Google Analytics: App + Web | Simo Ahava's blog</title>
<script>window.dataLayer=window.dataLayer||[],window.dataLayer.push({pageType:"article",environment:null})</script><script>(function(e,t,n,s){window[n]=window[n]||[],window[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=e.getElementsByTagName(t)[0],o=e.createElement(t),a=n!="dataLayer"?"&l="+n:"";o.async=!0,o.src="https://sgtm.simoahava.com/gtm.js?id="+s+a,i.parentNode.insertBefore(o,i)})(document,"script","dataLayer","GTM-PZ7GMV9")</script><meta name=author content="Simo Ahava"><meta name=keywords content><link rel=icon href=https://www.simoahava.com/images/favicon.ico><link rel=amphtml href=https://www.simoahava.com/amp/analytics/bigquery-query-guide-google-analytics-app-web/><meta name=description content="This is a Getting Started guide to using BigQuery with the dataset pulled in from a Google Analytics App+Web view."><meta property="og:description" content="This is a Getting Started guide to using BigQuery with the dataset pulled in from a Google Analytics App+Web view."><meta property="og:type" content="blog"><meta property="og:title" content="#BigQueryTips: Query Guide To Google Analytics: App + Web"><meta property="og:url" content="https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><meta property="og:site_name" content="Simo Ahava's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="#BigQueryTips: Query Guide To Google Analytics: App + Web"><meta name=twitter:description content="This is a Getting Started guide to using BigQuery with the dataset pulled in from a Google Analytics App+Web view."><meta name=twitter:creator content="@SimoAhava"><meta name=twitter:image content="https://www.simoahava.com/images/2019/09/bigquery-guide-app-web.jpg"><meta property="og:image" content="https://www.simoahava.com/images/2019/09/bigquery-guide-app-web.jpg"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/style.css></head><body><div id=_progress></div><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/>Simo Ahava's blog</a></div></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/><img class=sidebar-profile-picture loading=lazy src=https://www.simoahava.com/images/simo.png alt="Author's picture"></a><h4 class=sidebar-profile-name>Simo Ahava</h4><h5 class=sidebar-profile-bio>Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/><i class="sidebar-button-icon fa fa-lg fa-home"></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/categories/><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
<span class=sidebar-button-desc>Categories</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags/><i class="sidebar-button-icon fa fa-lg fa-tags"></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/categories/gtm-tips/><i class="sidebar-button-icon fa fa-lg fa-magic"></i>
<span class=sidebar-button-desc>GTM Tips</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/about-simo-ahava/><i class="sidebar-button-icon fa fa-lg fa-question"></i>
<span class=sidebar-button-desc>About</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/index.xml><i class="sidebar-button-icon fa fa-lg fa-rss"></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/tools/><i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
<span class=sidebar-button-desc>Tools</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/blog-statistics/><i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
<span class=sidebar-button-desc>Blog statistics</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/sahava target=_blank rel=noopener><i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/upcoming-talks/><i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
<span class=sidebar-button-desc>Upcoming talks</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/custom-templates/><i class="sidebar-button-icon fa fa-lg fa-tags"></i>
<span class=sidebar-button-desc>Templates</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/newsletter/><i class="sidebar-button-icon fa fa-lg fa-bell"></i>
<span class=sidebar-button-desc>Newsletter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://masto.measure.chat/@SimoAhava target=_blank rel="noopener me"><i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
<span class=sidebar-button-desc>Mastodon</span></a></li></ul><ul class=sidebar-buttons></ul></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post><form id=search action=/search/><input name=q type=text class="form-control input--xlarge" placeholder="Search blog..." autocomplete=off></form><div class="post-header main-content-wrap text-left"><h1>#BigQueryTips: Query Guide To Google Analytics: App + Web</h1><div class="postShorten-meta post-meta"><time datetime=2019-10-15T08:00:00+03:00>October 15, 2019
</time><span>in</span>
<a class=category-link href=/categories/analytics>Analytics</a>
| <a href=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/#commento><comentario-count path=/analytics/bigquery-query-guide-google-analytics-app-web/ placeholder=... error-text="N/A " zero-text="0 " prefix suffix=" "></comentario-count>Comments</a></div></div><div class="post-content markdown"><div class=main-content-wrap><p>I&rsquo;ve thoroughly enjoyed writing short (and sometimes a bit longer) bite-sized tips for my <a href=/categories/gtm-tips/>#GTMTips</a> topic. With the advent of <a href=https://www.blog.google/products/marketingplatform/analytics/new-way-unify-app-and-website-measurement-google-analytics/>Google Analytics: App + Web</a> and particularly the opportunity to <a href=/analytics/enable-bigquery-export-google-analytics-app-web/>access raw data through BigQuery</a>, I thought it was a good time to get started on a new tip topic: <strong>#BigQueryTips</strong>.</p><p>For Universal Analytics, getting access to the BigQuery export with Google Analytics 360 has been one of the major selling points for the expensive platform. The hybrid approach of getting access to <strong>raw</strong> data that has nevertheless been annotated with Google Analytics&rsquo; sessionization schema and any integrations (e.g. Google Ads) the user might have enabled is a powerful thing indeed.</p><p>With <strong>Google Analytics: App + Web</strong>, the platform is moving away from the data model that has existed since the days of Urchin, and is instead converging with <a href=https://firebase.google.com/docs/analytics>Firebase Analytics</a>, to which we have already had access with native Android and iOS applications.</p><div style=aspect-ratio:2806/1862 class="figure nocaption"><a href=/images/2019/09/bigquery-guide-app-web.jpg title="BigQuery Guide App+Web"><img class=fig-img height=1862 width=2806 loading=lazy src=/images/2019/09/bigquery-guide-app-web.jpg#ZgotmplZ alt="BigQuery Guide App+Web"></a></div><p>Fortunately, <a href=/analytics/enable-bigquery-export-google-analytics-app-web/>BigQuery export for App + Web properties</a> comes at no additional platform costs - you only pay for storage and queries just as you would if creating a BigQuery project by yourself in Google&rsquo;s cloud platform.</p><p>So, with data flowing into BigQuery, I thought it time to start writing about how to build queries against this columnar data store. One of the reasons is because I want to challenge myself, but the other reason is that there just isn&rsquo;t that much information available online when it comes to using SQL with Firebase Analytics&rsquo; BigQuery exports.</p><div style=aspect-ratio:256/256 class="figure nocaption right"><a href=/images/2019/10/pawel.jpg title=Pawel><img class=fig-img height=256 width=256 loading=lazy src=/images/2019/10/pawel.jpg#ZgotmplZ alt=Pawel></a></div><p>To get things started with this new topic, I&rsquo;ve enlisted the help of my favorite SQL wizard in <a href=https://www.measure.chat/>#measure</a>, <a href=https://twitter.com/AlienDeg><strong>Pawel Kapuscinski</strong></a>. He&rsquo;s never short of a solution when tricky BigQuery questions pop up in Measure Slack, so I thought it would be great to get him to contribute with some of his favorite tips for how to approach querying BigQuery data with SQL.</p><div id=toc-container><h1 id=table-of-contents>Table of Contents</h1><input type=checkbox id=show><label for=show id=showbtn><h1 id=table-of-contents-mobile>Table of Contents</h1><span class=show>&nbsp;[+show]</span><span class=hide>&nbsp;[â€“hide]</span></label><nav id=TableOfContents><ul><li><a href=#getting-started>Getting started</a></li><li><a href=#tip-1-case-and-group-by>Tip #1: CASE and GROUP BY</a><ul><li><a href=#case>CASE</a><ul><li><a href=#source-table>SOURCE TABLE</a></li><li><a href=#sql>SQL</a></li><li><a href=#query-result>QUERY RESULT</a></li></ul></li><li><a href=#group-by>GROUP BY</a><ul><li><a href=#source-table-1>SOURCE TABLE</a></li><li><a href=#sql-1>SQL</a></li><li><a href=#query-result-1>QUERY RESULT</a></li></ul></li><li><a href=#use-case-device-category-distribution-across-users>USE CASE: Device category distribution across users</a></li></ul></li><li><a href=#tip-2-distinct-and-having>Tip #2: DISTINCT and HAVING</a><ul><li><a href=#distinct>DISTINCT</a><ul><li><a href=#source-table-2>SOURCE TABLE</a></li><li><a href=#sql-2>SQL</a></li><li><a href=#query-result-2>QUERY RESULT</a></li></ul></li><li><a href=#having>HAVING</a><ul><li><a href=#source-table-3>SOURCE TABLE</a></li><li><a href=#sql-3>SQL</a></li><li><a href=#query-result-3>QUERY RESULT</a></li></ul></li><li><a href=#use-case-distinct-device-categories-per-user>USE CASE: Distinct device categories per user</a></li></ul></li><li><a href=#tip-3-where>Tip #3: WHERE</a><ul><li><a href=#where>WHERE</a><ul><li><a href=#source-table-4>SOURCE TABLE</a></li><li><a href=#sql-4>SQL</a></li><li><a href=#query-result-4>QUERY RESULT</a></li></ul></li><li><a href=#use-case-engaged-users>USE CASE: Engaged users</a></li></ul></li><li><a href=#tip-4-subqueries-and-analytic-functions>Tip #4: SUBQUERIES and ANALYTIC functions</a><ul><li><a href=#subquery>SUBQUERY</a><ul><li><a href=#source-table-5>SOURCE TABLE</a></li><li><a href=#sql-5>SQL</a></li><li><a href=#query-result-5>QUERY RESULT</a></li></ul></li><li><a href=#analytic-functions>ANALYTIC FUNCTIONS</a><ul><li><a href=#source-table-6>SOURCE TABLE</a></li><li><a href=#sql-6>SQL</a></li><li><a href=#query-result-6>QUERY RESULT</a></li></ul></li><li><a href=#use-case-first-interaction-per-event>USE CASE: First interaction per event</a></li></ul></li><li><a href=#tip-5-unnest-and-cross-join>Tip #5: UNNEST and CROSS JOIN</a><ul><li><a href=#unnest-and-cross-join>UNNEST and CROSS JOIN</a><ul><li><a href=#source-table-7>SOURCE TABLE</a></li><li><a href=#sql-7>SQL</a></li><li><a href=#query-result-7>QUERY RESULT</a></li></ul></li><li><a href=#use-case-pageviews-and-unique-pageviews-per-user>USE CASE: Pageviews and Unique Pageviews per user</a></li></ul></li><li><a href=#tip-6-withas-and-left-join>Tip #6: WITH&mldr;AS and LEFT JOIN</a><ul><li><a href=#withas>WITH&mldr;AS</a><ul><li><a href=#source-table-8>SOURCE TABLE</a></li><li><a href=#sql-8>SQL</a></li><li><a href=#query-result-8>QUERY RESULT</a></li></ul></li><li><a href=#left-join>LEFT JOIN</a><ul><li><a href=#source-table-9>SOURCE TABLE</a></li><li><a href=#sql-9>SQL</a></li><li><a href=#query-result-9>QUERY RESULT</a></li><li><a href=#use-case-simple-segmenting>USE CASE: Simple segmenting</a></li></ul></li></ul></li><li><a href=#summary>SUMMARY</a></li></ul></nav></div><p>Hopefully, <strong>#BigQueryTips</strong> will expand to more articles in the future. There certainly is a lot of ground to cover!</p><span class=simmer><span class=close>X</span><p><span class="fa fa-md fa-bell"></span>
<strong>The Simmer Newsletter</strong></p><p>Subscribe to the <a href=/newsletter/>Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!</p></span><h2 id=getting-started>Getting started</h2><p>First of all, you&rsquo;ll naturally need a <strong>Google Analytics: App + Web</strong> property. Here are some guides for getting started:</p><ul><li><a href=https://www.kristaseiden.com/step-by-step-setting-up-an-app-web-property/>Step by Step: Setting up an App + Web Property</a> (Krista Seiden)</li><li><a href=/analytics/getting-started-with-google-analytics-app-web/>Getting Started With Google Analytics: App + Web</a> (Simo)</li><li><a href=https://developers.google.cn/analytics/devguides/collection/app-web/tag-guide>App + Web Properties tag and instrumentation guide</a> (Google)</li></ul><div style=aspect-ratio:672/508 class="figure nocaption"><a href=/images/2019/08/link-toggle-on.jpg title="Link toggle on"><img class=fig-img height=508 width=672 loading=lazy src=/images/2019/08/link-toggle-on.jpg#ZgotmplZ alt="Link toggle on"></a></div><p>Next, you need to enable the BigQuery export for the new property, and for that you should follow <a href=/analytics/enable-bigquery-export-google-analytics-app-web/>this guide</a>.</p><div style=aspect-ratio:2290/856 class="figure nocaption"><a href=/images/2019/09/mode-sql-tutorial.jpg title="Mode SQL Tutorial"><img class=fig-img height=856 width=2290 loading=lazy src=/images/2019/09/mode-sql-tutorial.jpg#ZgotmplZ alt="Mode SQL Tutorial"></a></div><p>Once you have the export up-and-running, it&rsquo;s a good time to take a moment to learn and/or get a refresher on how SQL works. For that, there is no other tutorial online that comes even close to the <a href=https://mode.com/sql-tutorial/>free, interactive SQL tutorial at Mode Analytics</a>.</p><div style=aspect-ratio:1732/1128 class="figure nocaption"><a href=/images/2019/09/firebase-bigquery-sample.jpg title="Bigquery sample"><img class=fig-img height=1128 width=1732 loading=lazy src=/images/2019/09/firebase-bigquery-sample.jpg#ZgotmplZ alt="Bigquery sample"></a></div><p>And once you&rsquo;ve learned the difference between <code>LEFT JOIN</code> and <code>CROSS JOIN</code>, you can take a look at some of the sample data sets for <a href="https://bigquery.cloud.google.com/dataset/firebase-analytics-sample-data:ios_dataset?pli=1">iOS Firebase Analytics</a> and <a href=https://bigquery.cloud.google.com/dataset/firebase-analytics-sample-data:android_dataset>Android Firebase Analytics</a>. Play around with them, trying to figure out just how much querying a typical relational database differs from accessing data stored in columnar structure as BigQuery does.</p><p>At this point, you should have your BigQuery table collecting daily data dumps from the <strong>App + Web</strong> tags firing on your site, so let&rsquo;s work with Pawel and introduce some pretty useful <strong>BigQuery SQL queries</strong> to get started on that data analysis path!</p><h2 id=tip-1-case-and-group-by>Tip #1: CASE and GROUP BY</h2><p>Our first tip covers two extremely useful SQL statements: <code>CASE</code> and <code>GROUP BY</code>. Use these to aggregate and group your data!</p><h3 id=case>CASE</h3><div style=aspect-ratio:1367/616 class="figure nocaption"><a href=/images/2019/10/case-when.jpg title="CASE WHEN"><img class=fig-img height=616 width=1367 loading=lazy src=/images/2019/10/case-when.jpg#ZgotmplZ alt="CASE WHEN"></a></div><p><code>CASE</code> statements are similar to the <code>if...else</code> statements used in other languages. The condition is introduced with the <code>WHEN</code> keyword, and the first <code>WHEN</code> condition that matches will have its <code>THEN</code> value returned as the value for that column.</p><p>You can use the <code>ELSE</code> keyword at the end to specify a default value. If <code>ELSE</code> is not defined and no conditions are met, the column gets the value <code>null</code>.</p><h4 id=source-table>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>age</th></tr></thead><tbody><tr><td>12345</td><td>15</td></tr><tr><td>23456</td><td>54</td></tr></tbody></table><h4 id=sql>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb> </span><span style=color:#00a>user</span>,<span style=color:#bbb> </span>age,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>CASE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span>&gt;=<span style=color:#bbb> </span><span style=color:#099>90</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;90+&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span>&gt;=<span style=color:#bbb> </span><span style=color:#099>50</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;50-89&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span>&gt;=<span style=color:#bbb> </span><span style=color:#099>20</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;20-49&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>ELSE</span><span style=color:#bbb> </span><span style=color:#a50>&#34;0-19&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>END</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>age_bucket<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb> </span>some_table</span></span></code></pre></div><h4 id=query-result>QUERY RESULT</h4><table><thead><tr><th>user</th><th>age</th><th>age_bucket</th></tr></thead><tbody><tr><td>12345</td><td>15</td><td>0-19</td></tr><tr><td>23456</td><td>54</td><td>50-89</td></tr></tbody></table><p>The <code>CASE</code> statement is useful for quick transformations and for aggregating the data based on simple conditions.</p><h3 id=group-by>GROUP BY</h3><div style=aspect-ratio:1381/558 class="figure nocaption"><a href=/images/2019/10/group-by.jpg title="GROUP BY"><img class=fig-img height=558 width=1381 loading=lazy src=/images/2019/10/group-by.jpg#ZgotmplZ alt="GROUP BY"></a></div><p><code>GROUP BY</code> is required every time you want to <strong>summarize</strong> your data. For example, when you do calculations with <code>COUNT</code> (to return the number of instances) or <code>SUM</code> (to return the sum of instances), you need to indicate a column to group these calculations by (unless you&rsquo;re <em>only</em> retrieving the calculated column) . <code>GROUP BY</code> is thus most often used with <a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#aggregate-functions>aggregate functions</a> such as <code>COUNT</code>, <code>MAX</code>, <code>ANY_VALUE</code>, <code>SUM</code>, and <code>AVG</code>. It&rsquo;s also used with some string functions such as <code>STRING_AGG</code> when aggregating multiple rows into a single string.</p><h4 id=source-table-1>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>mobile_device_model</th></tr></thead><tbody><tr><td>12345</td><td>iPhone 5</td></tr><tr><td>12345</td><td>Nokia 3310</td></tr><tr><td>23456</td><td>iPhone 7</td></tr></tbody></table><h4 id=sql-1>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>user</span>,<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(mobile_device_model)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>device_count<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb> </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> </span><span style=color:#099>1</span></span></span></code></pre></div><h4 id=query-result-1>QUERY RESULT</h4><table><thead><tr><th>user</th><th>device_count</th></tr></thead><tbody><tr><td>12345</td><td>2</td></tr><tr><td>23456</td><td>1</td></tr></tbody></table><p>In the query above, we assume that a single user can have more than one device associated with them in the table that is being queried. As we do a <code>COUNT</code> of all the devices for a given user, we need to group the results by the <code>user</code> column for the query to work.</p><h3 id=use-case-device-category-distribution-across-users>USE CASE: Device category distribution across users</h3><p>Let&rsquo;s keep the theme of users and devices alive for a moment.</p><p><strong>Users</strong> and <strong>events</strong> are the key metrics for App + Web. This is fundamentally different to the <strong>session</strong>-centric approach of Google Analytics (even though there are reverberations of &ldquo;sessions&rdquo; in App + Web, too). It&rsquo;s much closer to a true <em>hit stream</em> model than before.</p><p>However, event counts alone tell as nothing without us drilling into <em>what kind of event happened</em>.</p><p>In this first tip, we&rsquo;ll learn to <strong>calculate the number of users per device category</strong>. As the concept of &ldquo;User&rdquo; is still bound to a unique browser client ID, if the same person visited the website on two different browser instances or devices, they would be counted as two users.</p><p>This is what the query looks like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>CASE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>device.category<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;desktop&#34;</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;desktop&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>device.category<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;tablet&#34;</span><span style=color:#bbb> </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>app_info.id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;tablet-web&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>device.category<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;mobile&#34;</span><span style=color:#bbb> </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>app_info.id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;mobile-web&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>device.category<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;tablet&#34;</span><span style=color:#bbb> </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>app_info.id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;tablet-app&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>device.category<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;mobile&#34;</span><span style=color:#bbb> </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>app_info.id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;mobile-app&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>END</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>device,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>user_pseudo_id)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>users<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>`dataset.analytics_accountId.events_2*`<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span></span></span></code></pre></div><div style=aspect-ratio:639/580 class="figure nocaption"><a href=/images/2019/09/group-by-case-output.jpg title="Group by and case output"><img class=fig-img height=580 width=639 loading=lazy src=/images/2019/09/group-by-case-output.jpg#ZgotmplZ alt="Group by and case output"></a></div><p>The query itself is simple, but it makes use of the two statements covered in this chapter effectively. <code>CASE</code> is used to segment &ldquo;mobile&rdquo; and &ldquo;tablet&rdquo; users further into web and app groups (something you&rsquo;ll find useful once you start collecting data from both websites and mobile apps), and <code>GROUP BY</code> displays the count of unique device IDs per device category.</p><h2 id=tip-2-distinct-and-having>Tip #2: DISTINCT and HAVING</h2><p>The next two keywords we&rsquo;ll cover are <code>HAVING</code> and <code>DISTINCT</code>. The first is great for filtering results based on aggregated values. The latter is used to deduplicate results to avoid calculating the same result multiple times.</p><h3 id=distinct>DISTINCT</h3><div style=aspect-ratio:1472/566 class="figure nocaption"><a href=/images/2019/10/distinct.jpg title=DISTINCT><img class=fig-img height=566 width=1472 loading=lazy src=/images/2019/10/distinct.jpg#ZgotmplZ alt=DISTINCT></a></div><p>The <code>DISTINCT</code> keyword is used to deduplicate results.</p><h4 id=source-table-2>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>device_category</th><th>session_id</th></tr></thead><tbody><tr><td>12345</td><td>desktop</td><td>abc123</td></tr><tr><td>12345</td><td>desktop</td><td>def234</td></tr><tr><td>12345</td><td>tablet</td><td>efg345</td></tr><tr><td>23456</td><td>mobile</td><td>fgh456</td></tr></tbody></table><h4 id=sql-2>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>user</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>device_category)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>device_category_count<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span></span></span></code></pre></div><h4 id=query-result-2>QUERY RESULT</h4><table><thead><tr><th>user</th><th>device_category_count</th></tr></thead><tbody><tr><td>12345</td><td>2</td></tr><tr><td>23456</td><td>1</td></tr></tbody></table><p>For example, if the user had three sessions with device categories <code>desktop</code>, <code>desktop</code>, and <code>tablet</code>, then a query for <code>COUNT(DISTINCT device.category)</code> would return <code>2</code>, as there are just two instances of <em>distinct</em> device categories.</p><h3 id=having>HAVING</h3><div style=aspect-ratio:1427/745 class="figure nocaption"><a href=/images/2019/10/having.jpg title=HAVING><img class=fig-img height=745 width=1427 loading=lazy src=/images/2019/10/having.jpg#ZgotmplZ alt=HAVING></a></div><p>The <code>HAVING</code> clause can be used at the end of the query, after all calculations have been done, to filter the results. All the rows selected for the query are still processed, even if the <code>HAVING</code> statement strips out some of them from the result table.</p><h4 id=source-table-3>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>device_category</th><th>session_id</th></tr></thead><tbody><tr><td>12345</td><td>desktop</td><td>abc123</td></tr><tr><td>12345</td><td>desktop</td><td>def234</td></tr><tr><td>12345</td><td>tablet</td><td>efg345</td></tr><tr><td>23456</td><td>mobile</td><td>fgh456</td></tr></tbody></table><h4 id=sql-3>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>user</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>device_category)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>device_category_count<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>HAVING</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>device_category_count<span style=color:#bbb> </span>&gt;<span style=color:#bbb> </span><span style=color:#099>1</span></span></span></code></pre></div><h4 id=query-result-3>QUERY RESULT</h4><table><thead><tr><th>user</th><th>device_category_count</th></tr></thead><tbody><tr><td>12345</td><td>2</td></tr></tbody></table><p>It&rsquo;s similar to <code>WHERE</code> (see next chapter), but unlike <code>WHERE</code> which is used to filter the actual records that are processed by the query, <code>HAVING</code> is used to filter on aggregated values. In the query above, <code>device_category_count</code> is an aggregated count of all the distinct device categories found in the data set.</p><h3 id=use-case-distinct-device-categories-per-user>USE CASE: Distinct device categories per user</h3><p>Since the very name, <strong>App + Web</strong>, implies cross-device measurement, exploring some ways of grouping and filtering data based on users with more than one device in use seems fruitful.</p><p>The query is similar to the one in the previous chapter, but this time instead of grouping by device category, we&rsquo;re grouping by user and counting the number of unique device categories each user has visited the site with. We&rsquo;re filtering the data to only include users with more than one device category in the data set.</p><p>This is an exploratory query. You can then extend it to actually detect different models instead of just using device category. Device category is a fickle dimension to use, as in the example dataset used for this article, many times a device labelled as &ldquo;Apple iPhone&rdquo; was actually counted as a Desktop device.</p><p>See <a href=https://medium.com/@optimiseordie/rapid-mining-for-ecommerce-conversion-53d1aab2e21>this article by Craig Sullivan</a> to understand how messed up device attribution in web analytics actually is.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>user_pseudo_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>device.category)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>used_devices_count,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>STRING_AGG(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>device.category)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>distinct_devices,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>STRING_AGG(device.category)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>devices<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>`dataset.analytics_accountId.events_2*`<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>HAVING</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>used_devices_count<span style=color:#bbb> </span>&gt;<span style=color:#bbb> </span><span style=color:#099>1</span></span></span></code></pre></div><div style=aspect-ratio:971/676 class="figure nocaption"><a href=/images/2019/09/cross-device-query.jpg title="cross-device query"><img class=fig-img height=676 width=971 loading=lazy src=/images/2019/09/cross-device-query.jpg#ZgotmplZ alt="cross-device query"></a></div><p>As a bonus, you can see how <code>STRING_AGG</code> can be used to concatenate multiple values into a single column. This is useful for identifying patterns that emerge across multiple rows of data!</p><h2 id=tip-3-where>Tip #3: WHERE</h2><h3 id=where>WHERE</h3><div style=aspect-ratio:1391/733 class="figure nocaption"><a href=/images/2019/10/where.jpg title=WHERE><img class=fig-img height=733 width=1391 loading=lazy src=/images/2019/10/where.jpg#ZgotmplZ alt=WHERE></a></div><p>If you want to filter the records against which you&rsquo;ll run your query, <code>WHERE</code> is your best friend. As it filters the records that are processed, it&rsquo;s also a great way to reduce the (performance and monetary) cost of your queries.</p><h4 id=source-table-4>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>session_id</th><th>landing_page_path</th></tr></thead><tbody><tr><td>12345</td><td>abc123</td><td>/home/</td></tr><tr><td>12345</td><td>bcd234</td><td>/purchase/</td></tr><tr><td>23456</td><td>cde345</td><td>/home/</td></tr><tr><td>34567</td><td>def456</td><td>/contact-us/</td></tr></tbody></table><h4 id=sql-4>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>user</span><span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#39;12345&#39;</span></span></span></code></pre></div><h4 id=query-result-4>QUERY RESULT</h4><table><thead><tr><th>user</th><th>session_id</th><th>landing_page_path</th></tr></thead><tbody><tr><td>12345</td><td>abc123</td><td>/home/</td></tr><tr><td>12345</td><td>bcd234</td><td>/purchase/</td></tr></tbody></table><p>The <code>WHERE</code> clause is used to filter the rows against which the rest of the query is made. It is introduced directly after the <code>FROM</code> statement, and it reads as &ldquo;return all the rows in the <code>FROM</code> table that match the condition of the <code>WHERE</code> clause&rdquo;.</p><p>Do note that <code>WHERE</code> <strong>can&rsquo;t be used with aggregate values</strong>. So if you&rsquo;ve done any calculations with the rows returned from the table, you need to use <code>HAVING</code> instead.</p><p>Due to this, <code>WHERE</code> is less expensive in terms of query processing than <code>HAVING</code>.</p><h3 id=use-case-engaged-users>USE CASE: Engaged users</h3><p>As mentioned before, <strong>App + Web</strong> is event-driven. With Firebase Analytics, Google introduced a number of <a href="https://support.google.com/firebase/answer/6317485?hl=en">automatically collected</a>, pre-defined events to help users gather useful data from their apps and websites without having to flex a single muscle.</p><p>One such event is <strong>user_engagement</strong>. This is fired when the user has engaged with the website or app for a specified period of time.</p><p>Since this is readily available as a custom event, we can create a simple query that uses the <code>WHERE</code> clause to return only those records where the user was engaged.</p><p>The key to <code>WHERE</code> is that it&rsquo;s executed after the <code>FROM</code> clause (which specifies the table to be queried). If a row doesn&rsquo;t match the condition in <code>WHERE</code>, it won&rsquo;t be used to match the rest of the query against.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>user_pseudo_id)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>engaged_users<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>`dataset.analytics_accountId.events_20190922`<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;user_engagement&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span></span></span></code></pre></div><div style=aspect-ratio:645/533 class="figure nocaption"><a href=/images/2019/09/engaged-users.jpg title="Engaged users"><img class=fig-img height=533 width=645 loading=lazy src=/images/2019/09/engaged-users.jpg#ZgotmplZ alt="Engaged users"></a></div><p>See how we&rsquo;re including data from just one date? We&rsquo;re also only including <code>DISTINCT</code> users, so if a user was engaged more than once during the day we&rsquo;re only counting them once.</p><h2 id=tip-4-subqueries-and-analytic-functions>Tip #4: SUBQUERIES and ANALYTIC functions</h2><p>A <strong>subquery</strong> in SQL means a query within a query. They can emerge in multiple different places, such as within <code>SELECT</code> clauses, <code>FROM</code> clauses, and <code>WHERE</code> clauses.</p><p><strong>Analytic</strong> functions let you do calculations that cover <em>other</em> rows than just the one that is being processed. It&rsquo;s similar to aggregations such as <code>SUM</code> and <code>AVG</code> except it doesn&rsquo;t result in rows getting grouped into a single result. That&rsquo;s why analytic functions are perfectly suited for things like <em>running totals/averages</em> or, in analytics contexts, determining session boundaries by looking at first and last timestamps, for example.</p><h3 id=subquery>SUBQUERY</h3><div style=aspect-ratio:1427/777 class="figure nocaption"><a href=/images/2019/10/subquery.jpg title=SUBQUERY><img class=fig-img height=777 width=1427 loading=lazy src=/images/2019/10/subquery.jpg#ZgotmplZ alt=SUBQUERY></a></div><p>The point of a subquery is to run calculations on table data, and return the result of those calculations to the enclosing query. This lets you logically organize your queries, and it makes it possible to do calculations on calculations, which would not be possible in a single query.</p><h4 id=source-table-5>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>event_name</th></tr></thead><tbody><tr><td>12345</td><td>session_start</td></tr><tr><td>23456</td><td>user_engagement</td></tr><tr><td>34567</td><td>user_engagement</td></tr><tr><td>45678</td><td>link_click</td></tr></tbody></table><h4 id=sql-5>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span><span style=color:#00a>user</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>all_users,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span><span style=color:#00a>user</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#39;user_engagement&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>engaged_users<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span></span></span></code></pre></div><h4 id=query-result-5>QUERY RESULT</h4><table><thead><tr><th>all_users</th><th>engaged_users</th></tr></thead><tbody><tr><td>4</td><td>2</td></tr></tbody></table><p>In this example, the subquery is within the <code>SELECT</code> statement, meaning the subquery result is bundled into a single column of the main query.</p><p>Here, the <code>engaged_users</code> column retrieves the count of all distinct user IDs from the table, where these users had an event named <code>user_engagement</code> collected at any time.</p><p>The main query then combines this with a count of all distinct user IDs without any restrictions, and thus you get both counts in the same table.</p><p>You couldn&rsquo;t have achieved with just the main query, since the <code>WHERE</code> statement applies to all <code>SELECT</code> columns in the table. That&rsquo;s why we needed the subquery - we had to use a <code>WHERE</code> statement that only applied to the <code>engaged_users</code> column.</p><h3 id=analytic-functions>ANALYTIC FUNCTIONS</h3><div style=aspect-ratio:1536/785 class="figure nocaption"><a href=/images/2019/10/analytic-function.jpg title="Analytic function"><img class=fig-img height=785 width=1536 loading=lazy src=/images/2019/10/analytic-function.jpg#ZgotmplZ alt="Analytic function"></a></div><p>Analytic functions can be really difficult to understand, since with SQL you&rsquo;re used to going over the table row-by-row, and comparing the query against each row one at a time.</p><p>With an analytic function, you stretch this logic a bit. The query still goes over the source table row-by-row, but this time you can reference other rows when doing calculations.</p><h4 id=source-table-6>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>event_name</th><th>event_timestamp</th></tr></thead><tbody><tr><td>12345</td><td>click</td><td>1001</td></tr><tr><td>12345</td><td>click</td><td>1002</td></tr><tr><td>23456</td><td>session_start</td><td>1012</td></tr><tr><td>23456</td><td>user_engagement</td><td>1009</td></tr><tr><td>34567</td><td>click</td><td>1000</td></tr></tbody></table><h4 id=sql-6>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>user</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_timestamp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>user</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_timestamp,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>RANK()<span style=color:#bbb> </span>OVER<span style=color:#bbb> </span>(PARTITION<span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> </span>event_timestamp)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>rank<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>rank<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#099>1</span></span></span></code></pre></div><h4 id=query-result-6>QUERY RESULT</h4><table><thead><tr><th>event_name</th><th>user</th><th>event_timestamp</th></tr></thead><tbody><tr><td>click</td><td>34567</td><td>1000</td></tr><tr><td>user_engagement</td><td>23456</td><td>1009</td></tr><tr><td>session_start</td><td>23456</td><td>1012</td></tr></tbody></table><p>In this query, we take each event and see which user sent the <em>first</em> such event in the table.</p><p>For each row in the table, the <code>RANK() OVER (PARTITION BY event_name ORDER BY event_timestamp) AS rank</code> is run. The <em>partition</em> is basically a &ldquo;reference&rdquo; table with all the event names matching the current row&rsquo;s event name, and their respective timestamps.</p><p>These timestamps are then ordered in ascending order (within the partition). The <code>RANK() OVER</code> part of the function returns the current event name&rsquo;s <em>rank</em> in this table.</p><p>To walk through an example, let&rsquo;s say the query engine encounters the first row of the table. The <code>RANK() OVER (PARTITION BY event_name ORDER BY event_timestamp)</code> creates the reference table that looks like this for the first row:</p><table><thead><tr><th>user</th><th>event_name</th><th>event_timestamp</th><th>rank</th></tr></thead><tbody><tr><td>12345</td><td>click</td><td>1000</td><td>1</td></tr><tr><td>12345</td><td>click</td><td>1001</td><td>2</td></tr><tr><td>12345</td><td>click</td><td>1002</td><td>3</td></tr></tbody></table><p>The query then checks how the current row matches against this partition, and returns <code>2</code> as the first row in the table was rank <code>2</code> of its partition.</p><p>This partition is ephemeral - it&rsquo;s <strong>only</strong> used to calculate the result of the analytic function.</p><p>For the purposes of this exercise, this analytic function is furthermore done in a subquery, so that the main query can filter the result using a <code>WHERE</code> for just those items that had rank <code>1</code> (first timestamp of any given event).</p><p>I recommend checking out the first paragraphs in <a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts>this</a> document - it explains how the partitioning works.</p><h3 id=use-case-first-interaction-per-event>USE CASE: First interaction per event</h3><p>Let&rsquo;s extend the example from above into the App + Web dataset.</p><p>We&rsquo;ll create a list of client IDs together with the event name, the timestamp, and the timestamp converted to a readable (date) format.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>user_pseudo_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_timestamp,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>DATETIME(TIMESTAMP_MICROS(event_timestamp),<span style=color:#bbb> </span><span style=color:#a50>&#34;Europe/Helsinki&#34;</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span><span style=color:#0aa>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_pseudo_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_timestamp,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>RANK()<span style=color:#bbb> </span>OVER<span style=color:#bbb> </span>(PARTITION<span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb> </span>event_timestamp)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>rank<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>`dataset.analytics_accountId.events_20190922`<span style=color:#bbb> </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>rank<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#099>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_timestamp</span></span></code></pre></div><div style=aspect-ratio:654/749 class="figure nocaption"><a href=/images/2019/10/first-interaction-timestamp.jpg title="First interaction timestamp"><img class=fig-img height=749 width=654 loading=lazy src=/images/2019/10/first-interaction-timestamp.jpg#ZgotmplZ alt="First interaction timestamp"></a></div><p>The logic is exactly the same as in the introduction to analytic functions above. The only difference is how we use the <code>DATETIME</code> and <code>TIMESTAMP_MICROS</code> to turn the UNIX timestamp (stored in BigQuery) into a readable date format.</p><p>Don&rsquo;t worry - analytic functions in particular are a tough concept to understand. Play around with the different analytic functions to get an idea of how they work with the source idea.</p><p>There are quite a few articles and videos online that explain the concept further, so I recommend checking out the web for more information. We will also return to analytic functions many, many times in future #BigQueryTips posts.</p><h2 id=tip-5-unnest-and-cross-join>Tip #5: UNNEST and CROSS JOIN</h2><p>The dataset exported by App + Web does not end up in a relational database where we could use the <code>JOIN</code> key to quickly pull in extra information about pages, sessions, and users.</p><p>Instead, BigQuery arranges data in nested and repeated fields - that&rsquo;s how it can have a single row represent all the hits of a session (as in the Google Analytics dataset).</p><p>The problem with this approach is that it&rsquo;s not too intuitive to access these nested values.</p><p>Enter <code>UNNEST</code>, particularly when coupled with <code>CROSS JOIN</code>.</p><p><code>UNNEST</code> means that the nested structure is actually expanded so that each item within can be joined with the rest of the columns in the row. This results in the single row becoming multiple rows, where each row corresponds to one value in the nested structure. This column-to-rows is achieved with a <code>CROSS JOIN</code>, where every item in the unnested structure is joined with each column in the rest of the table.</p><h3 id=unnest-and-cross-join>UNNEST and CROSS JOIN</h3><div style=aspect-ratio:1380/450 class="figure nocaption"><a href=/images/2019/10/unnest-cross-join.jpg title="UNNEST CROSS JOIN"><img class=fig-img height=450 width=1380 loading=lazy src=/images/2019/10/unnest-cross-join.jpg#ZgotmplZ alt="UNNEST CROSS JOIN"></a></div><p>The two keywords go intrinsically together, so we&rsquo;ll treat them as such.</p><h4 id=source-table-7>SOURCE TABLE</h4><table><thead><tr><th>timestamp</th><th>event</th><th>params.key</th><th>params.value</th></tr></thead><tbody><tr><td>1000</td><td>click</td><td>time<br>type<br>device</td><td>10<br>right-click<br>iPhone</td></tr></tbody></table><h4 id=sql-7>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>timestamp</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_params.<span style=color:#00a>key</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params_key<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>CROSS</span><span style=color:#bbb> </span><span style=color:#00a>JOIN</span><span style=color:#bbb> </span><span style=color:#00a>UNNEST</span><span style=color:#bbb> </span>(t.params)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params</span></span></code></pre></div><h4 id=query-result-7>QUERY RESULT</h4><table><thead><tr><th>timestamp</th><th>event</th><th>event_params_key</th></tr></thead><tbody><tr><td>1000</td><td>click</td><td>time</td></tr><tr><td>1000</td><td>click</td><td>type</td></tr><tr><td>1000</td><td>click</td><td>device</td></tr></tbody></table><p>See what happened? The nested structure within <code>params</code> was <em>unnested</em> so that each item was treated as a separate row in its own column. Then, this unnested structure was <strong>cross-joined</strong> with the table. A <code>CROSS JOIN</code> combines every row from <code>table</code> with every row from the unnested structure.</p><p>This is how you end up with a structure that you can then use for calculations in your main query.</p><p>It&rsquo;s a bit complicated since you always need to do the <code>UNNEST</code> - <code>CROSS JOIN</code> exercise, but once you&rsquo;ve done it a few times it should become second nature.</p><p>In fact, there&rsquo;s a shorthand for writing the <code>CROSS JOIN</code> that might make things easier to read (or not). You can replace the <code>CROSS JOIN</code> statement with a comma. This is what the example query would look like when thus modified.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>timestamp</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_params.<span style=color:#00a>key</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params_key<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>UNNEST</span><span style=color:#bbb> </span>(t.params)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params</span></span></code></pre></div><h3 id=use-case-pageviews-and-unique-pageviews-per-user>USE CASE: Pageviews and Unique Pageviews per user</h3><p>Let&rsquo;s look at a query for getting the count of pageviews and unique pageviews per user.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_params.value.string_value<span style=color:#bbb> </span><span style=color:#00a>as</span><span style=color:#bbb> </span>page_url,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(*)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>pageviews,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>COUNT</span>(<span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>user_pseudo_id)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>unique_pageviews<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>`dataset.analytics_accountId.events_20190922`<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>UNNEST</span>(t.event_params)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>event_params.<span style=color:#00a>key</span><span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;page_location&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;page_view&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>3</span><span style=color:#bbb> </span><span style=color:#00a>DESC</span></span></span></code></pre></div><div style=aspect-ratio:932/622 class="figure nocaption"><a href=/images/2019/09/pageviews.jpg title="Page views"><img class=fig-img height=622 width=932 loading=lazy src=/images/2019/09/pageviews.jpg#ZgotmplZ alt="Page views"></a></div><p>In the <code>FROM</code> statement we define the table as usual, and we give it an alias <code>t</code> (good practice, as it helps keep the queries lean).</p><p>The next step is to <code>UNNEST</code> one of those nested fields, and then <code>CROSS JOIN</code> it with the rest of our table. The <code>WHERE</code> clause is used to make sure only rows that have the <code>page_location</code> key and the <code>page_view</code> event type are included in the final table.</p><p>Finally, we <code>GROUP BY</code> the event date and page URL, and then we sort everything by the count of pageviews in descending order.</p><p>Conceptually, the <code>UNNEST</code> and <code>CROSS JOIN</code> create a new table that has a crazy number of rows, as every row in the original table is multiplied by the number of rows in the <code>event_params</code> nested structure. The <code>WHERE</code> clause is thus your friend in making sure you only analyze the data that answers the question you have.</p><h2 id=tip-6-withas-and-left-join>Tip #6: WITH&mldr;AS and LEFT JOIN</h2><p>The final keywords we&rsquo;ll go through are <code>WITH...AS</code> and <code>LEFT JOIN</code>. The first lets you create a type of subquery that you can reference in your other queries as a separate table. The second lets you join two datasets together while preserving rows that do not match against the join condition.</p><h3 id=withas>WITH&mldr;AS</h3><div style=aspect-ratio:1415/269 class="figure nocaption"><a href=/images/2019/10/with-as.jpg title=WITH...AS><img class=fig-img height=269 width=1415 loading=lazy src=/images/2019/10/with-as.jpg#ZgotmplZ alt=WITH...AS></a></div><p><code>WITH...AS</code> is very similar conceptually to a subquery. It allows you to build a table expression that can then be used by your queries. The main difference to a subquery is that the table gets an alias, and you can then use this alias wherever you want to refer to the table&rsquo;s data. A subquery would need to be repeated in all places where you want to reference it, so <code>WITH</code> makes custom queries more accessible.</p><h4 id=source-table-8>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>event_name</th><th>event_timestamp</th></tr></thead><tbody><tr><td>12345</td><td>click</td><td>1000</td></tr><tr><td>12345</td><td>user_engagement</td><td>1005</td></tr><tr><td>12345</td><td>click</td><td>1006</td></tr><tr><td>23456</td><td>session_start</td><td>1002</td></tr><tr><td>34567</td><td>session_start</td><td>1000</td></tr><tr><td>34567</td><td>click</td><td>1002</td></tr></tbody></table><h4 id=sql-8>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>WITH</span><span style=color:#bbb> </span>users_who_clicked<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span><span style=color:#00a>user</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>WHERE</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#39;click&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>users_who_clicked</span></span></code></pre></div><h4 id=query-result-8>QUERY RESULT</h4><table><thead><tr><th>user</th></tr></thead><tbody><tr><td>12345</td></tr><tr><td>34567</td></tr></tbody></table><p>It&rsquo;s not the most mind-blowing of examples, but it should illustrate how to use table aliases. After the <code>WITH...AS</code> clause, you can then reference the table in e.g. <code>FROM</code> statements and in joins.</p><p>See the next example where we make this more interesting.</p><h3 id=left-join>LEFT JOIN</h3><div style=aspect-ratio:1497/792 class="figure nocaption"><a href=/images/2019/10/left-join.jpg title="LEFT JOIN"><img class=fig-img height=792 width=1497 loading=lazy src=/images/2019/10/left-join.jpg#ZgotmplZ alt="LEFT JOIN"></a></div><p>A <code>LEFT JOIN</code> is one of the most useful data joins because it allows you to account for unmatched rows as well.</p><p>A <code>LEFT JOIN</code> takes <strong>all</strong> rows in the first table (&ldquo;left&rdquo; table), and the rows that <strong>match</strong> a specific join criterion in the second table (&ldquo;right&rdquo; table). For all the rows that did not have a match, the first table is populated with a <em>null</em> value. Rows in the <em>second</em> table that do not have a match in the first table are discarded.</p><h4 id=source-table-9>SOURCE TABLE</h4><table><thead><tr><th>user</th><th>event_name</th><th>event_timestamp</th></tr></thead><tbody><tr><td>12345</td><td>click</td><td>1000</td></tr><tr><td>12345</td><td>user_engagement</td><td>1005</td></tr><tr><td>12345</td><td>click</td><td>1006</td></tr><tr><td>23456</td><td>session_start</td><td>1002</td></tr><tr><td>34567</td><td>session_start</td><td>1000</td></tr><tr><td>34567</td><td>click</td><td>1002</td></tr></tbody></table><h4 id=sql-9>SQL</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>WITH</span><span style=color:#bbb> </span>users_who_clicked<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span><span style=color:#00a>user</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>table</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>WHERE</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#39;click&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.<span style=color:#00a>user</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>CASE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>WHEN</span><span style=color:#bbb> </span>t2.<span style=color:#00a>user</span><span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb> </span><span style=color:#00a>THEN</span><span style=color:#bbb> </span><span style=color:#a50>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>ELSE</span><span style=color:#bbb> </span><span style=color:#a50>&#34;false&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>END</span><span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>user_did_click<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>table</span><span style=color:#bbb> </span><span style=color:#00a>as</span><span style=color:#bbb> </span>t1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>LEFT</span><span style=color:#bbb> </span><span style=color:#00a>JOIN</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>users_who_clicked<span style=color:#bbb> </span><span style=color:#00a>as</span><span style=color:#bbb> </span>t2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ON</span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.<span style=color:#00a>user</span><span style=color:#bbb> </span>=<span style=color:#bbb> </span>t2.<span style=color:#00a>user</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span>,<span style=color:#bbb> </span><span style=color:#099>2</span></span></span></code></pre></div><h4 id=query-result-9>QUERY RESULT</h4><table><thead><tr><th>user</th><th>user_did_click</th></tr></thead><tbody><tr><td>12345</td><td>true</td></tr><tr><td>23456</td><td>false</td></tr><tr><td>34567</td><td>true</td></tr></tbody></table><p>With the <code>LEFT JOIN</code>, we take all the user IDs in the main table, and then we take all the rows in the <code>users_who_clicked</code> table (that we created in the <code>WITH...AS</code> tutorial above). For all the rows where the user ID from the main table has a match in the <code>users_who_clicked</code> table, we populate a new column named <code>user_did_click</code> with the value <strong>true</strong>.</p><p>For all the user IDs that do not have a match in the <code>users_who_clicked</code> table, the value <strong>false</strong> is used instead.</p><h4 id=use-case-simple-segmenting>USE CASE: Simple segmenting</h4><p>Let&rsquo;s put a bunch of things we&rsquo;ve now learned together, and replicate some simple segmenting functionality from Google Analytics in BigQuery.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>WITH</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>engaged_users_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_pseudo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>`dataset.analytics_accountId.events_20190922`<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>EVENT_NAME<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;user_engagement&#34;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>pageviews_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>DISTINCT</span><span style=color:#bbb> </span>event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_params.value.string_value<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>page_url,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_pseudo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>`simoahava-com.analytics_206575074.events_20190922`<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>UNNEST</span>(t.event_params)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>event_params<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>WHERE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>event_params.<span style=color:#00a>key</span><span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;page_location&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>AND</span><span style=color:#bbb> </span>event_name<span style=color:#bbb> </span>=<span style=color:#bbb> </span><span style=color:#a50>&#34;page_view&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>page_url,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>COUNTIF(t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>engaged_users_visited,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>COUNTIF(t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>not_engaged_users_visited<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>pageviews_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>LEFT</span><span style=color:#bbb> </span><span style=color:#00a>JOIN</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>engaged_users_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ON</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.user_pseudo_id<span style=color:#bbb> </span>=<span style=color:#bbb> </span>t2.user_pseudo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>3</span><span style=color:#bbb> </span><span style=color:#00a>DESC</span></span></span></code></pre></div><div style=aspect-ratio:981/678 class="figure nocaption"><a href=/images/2019/09/with-as-table.jpg title="With AS table"><img class=fig-img height=678 width=981 loading=lazy src=/images/2019/09/with-as-table.jpg#ZgotmplZ alt="With AS table"></a></div><p>Let&rsquo;s chop this down to pieces again.</p><p>In the query above, we have <strong>two</strong> table aliases created. The first one named <code>engaged_users_table</code> should be familiar - it&rsquo;s the query we built in <a href=#use-case-engaged-users>tip #3</a>.</p><p>The second one named <code>pageviews_table</code> should ring a bell as well. We built it in <a href=#use-case-pageviews-and-unique-pageviews-per-user>tip #5</a>.</p><p>We create these as table aliases so that we can use them in the subsequent join.</p><p>Now, let&rsquo;s look at the rest of the query:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#00a>SELECT</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.event_date,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>page_url,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>COUNTIF(t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>engaged_users_visited,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>COUNTIF(t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>not_engaged_users_visited<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>FROM</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>pageviews_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>LEFT</span><span style=color:#bbb> </span><span style=color:#00a>JOIN</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>engaged_users_table<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>t2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ON</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t1.user_pseudo_id<span style=color:#bbb> </span>=<span style=color:#bbb> </span>t2.user_pseudo_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>GROUP</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>1</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>ORDER</span><span style=color:#bbb> </span><span style=color:#00a>BY</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#099>3</span><span style=color:#bbb> </span><span style=color:#00a>DESC</span></span></span></code></pre></div><p>Focus on the part after the <code>FROM</code> clause. Here, we take the two tables, and we <code>LEFT JOIN</code> them. The <code>pageviews_table</code> is the &ldquo;left&rdquo; table, and <code>engaged_users</code> is the &ldquo;right&rdquo; table.</p><p><code>LEFT JOIN</code> takes <strong>all the rows</strong> in the &ldquo;left&rdquo; table and the <strong>matching rows</strong> from the &ldquo;right&rdquo; table. The matching criterion is established in the <code>ON</code> clause. Thus, a match is made if the <code>user_pseudo_id</code> is the same between the two tables.</p><p>To illustrate, this is what a simple <code>LEFT JOIN</code> without any calculations or aggregations would look like:</p><div style=aspect-ratio:774/347 class="figure nocaption"><a href=/images/2019/09/left-join-example.jpg title="LEFT JOIN example"><img class=fig-img height=347 width=774 loading=lazy src=/images/2019/09/left-join-example.jpg#ZgotmplZ alt="LEFT JOIN example"></a></div><p>Here you can see that on rows <strong>1</strong>, <strong>9</strong>, and <strong>10</strong> there was no match for the <code>user_pseudo_id</code> in the <code>engaged_users</code> table. This means that the user who dispatched this pageview was not considered &ldquo;engaged&rdquo; in the date range selected for analysis.</p><p>If you&rsquo;re wondering what <code>COUNTIF</code> does, then check out these two statements detail:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>COUNTIF(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NOT</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>engaged_users_visited,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>COUNTIF(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>t2.user_pseudo_id<span style=color:#bbb> </span><span style=color:#00a>IS</span><span style=color:#bbb> </span><span style=color:#00a>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#00a>AS</span><span style=color:#bbb> </span>not_engaged_users_visited</span></span></code></pre></div><p>The first one increments the <code>engaged_users_visited</code> counter by one for all the rows where the user visited the page AND had a row in the <code>engaged_users</code> table.</p><p>The second one increments the <code>not_engaged_users_visited</code> counter by one for all the rows where the user visited the page and DID NOT have a row in the <code>engaged_users</code> table.</p><p>We can do this because the <code>LEFT JOIN</code> leaves the <code>t2.*</code> columns <code>null</code> in case the user ID from the <code>pageviews_table</code> was not found in the <code>engaged_users_table</code>.</p><h2 id=summary>SUMMARY</h2><p>Phew!</p><p>That wasn&rsquo;t a quick foray into BigQuery after all.</p><p>However, if you already possess a rudimentary understanding of SQL (and if you don&rsquo;t, just take a look at the <a href=https://mode.com/sql-tutorial/>Mode Analytics</a> tutorial), then the most complex things you need to wrap your head around are the ways in which BigQuery leverages its unique columnar format.</p><p>It&rsquo;s quite different to a relational database, where joins are the most powerful tool in your kit for running analyses against different data structure.</p><p>In BigQuery, you need to understand the <a href=#tip-5-unnest-and-cross-join>nested structures and how to <code>UNNEST</code> them</a>. This, for many, is a difficult concept to grasp, but once you consider how <code>UNNEST</code> and <code>CROSS JOIN</code> simply populate the table as if it had been a flat structure all along, it should help you build the queries you want.</p><p><a href=#analytic-functions>Analytic functions</a> are arguably the coolest thing since Arnold Schwarzenegger played Mr. Freeze. They let you do aggregations and calculations without having to build a complicated mess of subqueries across all the rows you want to process. We&rsquo;ve only explored a very simple use case here, but in subsequent articles we&rsquo;ll definitely cover these in more detail.</p><p>Finally, huge thanks to Pawel for providing the SQL examples and walkthroughs. Simo contributed some enhancements to the queries, but his contribution is mainly editorial. Thus, direct all criticism and suggestions for improvement to him, and him alone.</p><p>If you&rsquo;re an analyst working with Google Analytics and thinking about what you should do to improve your skill set, we recommend learning SQL and then going to town on either any one of the copious BigQuery sample datasets out there, or on your very own <a href=/analytics/enable-bigquery-export-google-analytics-app-web/>App + Web export</a>.</p><p>Let us know in the comments if questions arose from this guide!</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/bigquery/>bigquery</a>
<a class="tag tag--primary tag--small" href=/tags/app+web/>app+web</a>
<a class="tag tag--primary tag--small" href=/tags/firebase/>firebase</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/improve-google-analytics-bot-detection-with-recaptcha/><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/introducing-tag-manager-template-gallery/><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-facebook"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=%23BigQueryTips:%20Query%20Guide%20To%20Google%20Analytics:%20App%20+%20Web%20https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-linkedin"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#commento><i class="fa-regular fa-comments"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-search"></i></a></li></ul></div><a name=commento></a><comentario-comments></comentario-comments></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2026 Simo Ahava. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/improve-google-analytics-bot-detection-with-recaptcha/><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/introducing-tag-manager-template-gallery/><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-facebook"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=%23BigQueryTips:%20Query%20Guide%20To%20Google%20Analytics:%20App%20+%20Web%20https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-linkedin"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#commento><i class="fa-regular fa-comments"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-search"></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-close"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=%23BigQueryTips:%20Query%20Guide%20To%20Google%20Analytics:%20App%20+%20Web%20https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/bigquery-query-guide-google-analytics-app-web/"><i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-remove"></i></div><img id=about-card-picture src=https://www.simoahava.com/images/simo.png alt="Author's picture"><h4 id=about-card-name>Simo Ahava</h4><div id=about-card-bio>Husband | Father | Analytics developer<br>simo (at) simoahava.com</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Senior Data Advocate at Reaktor</div><div id=about-card-location><i class="fa fa-map-marker"></i><br>Finland</div></div></div><div id=cover style=background-image:url(https://www.simoahava.com/images/maisema.jpg)></div><script defer src=https://comentario.simoahava.com/comentario.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script defer src=/js/script.js></script><script>!function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),n=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");e&&(n&&(e.style.display="none"),t&&t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"}))}()</script></body></html>