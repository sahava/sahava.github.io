

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Leverage useBeacon And beforeunload In Google Analytics | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2015\/02\/user-timings-bounced-sessions.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/leverage-usebeacon-beforeunload-google-analytics\/",
  "datePublished": "2015-02-17T08:25:08\u002b00:00",
  "dateModified": "2015-02-17T08:25:08\u002b00:00",
  "description": "Leverage useBeacon and beforeunload to fire Google Tag Manager events to Google Analytics just as the user is about to leave the page or close the browser.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Leverage useBeacon And beforeunload In Google Analytics | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/leverage-usebeacon-beforeunload-google-analytics/">
    
    <meta name="description" content="Leverage useBeacon and beforeunload to fire Google Tag Manager events to Google Analytics just as the user is about to leave the page or close the browser.">
    <meta property="og:description" content="Leverage useBeacon and beforeunload to fire Google Tag Manager events to Google Analytics just as the user is about to leave the page or close the browser.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Leverage useBeacon And beforeunload In Google Analytics">
    <meta property="og:url" content="https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Leverage useBeacon And beforeunload In Google Analytics">
    <meta name="twitter:description" content="Leverage useBeacon and beforeunload to fire Google Tag Manager events to Google Analytics just as the user is about to leave the page or close the browser.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2015/02/user-timings-bounced-sessions.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2015/02/user-timings-bounced-sessions.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Leverage useBeacon And beforeunload In Google Analytics
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2015-02-17T08:25:08Z">
        
  February 17, 2015

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/#commento">Comments</a>
      
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>This nifty little solution will let you calculate the time spent on pages that are not tracked in Google Analytics by default. These include both bounced landing pages and exit pages. Bounced pages and exit pages lack the necessary subsequent pageview, which Google Analytics uses to calculate time-based metrics.</p>
<p>Before you go on, read this excellent article by <a href="http://www.twitter.com/analyticsninja">Yehoshua Coren</a>:</p>
<p><a href="http://www.analytics-ninja.com/blog/2015/02/real-time-page-google-analytics.html">REAL Time On Page in Google Analytics</a></p>
<p>Yehoshua gives a very nice use case for the technical solution I&rsquo;m about to explore. He also leverages the <a href="https://www.simoahava.com/analytics/use-page-visibility-api-google-tag-manager/">Page Visibility API</a> to get an even more accurate overview of visitors who actually digest content, and how much of that time that content is visible on their screens. Fundamental stuff, read it!</p>
<p>So what we&rsquo;re actually doing here is this:</p>
<ol>
<li>
<p>On each page, use the default <strong>gtm.start</strong> Data Layer Variable to calculate the time when the document has started loading</p>
</li>
<li>
<p>When the user decides to leave the page, either by closing the browser or navigating to another page, first calculate the time when the <em><a href="https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload">beforeunload</a></em> event is dispatched. Then, use the <code>sendBeacon()</code> <a href="https://developer.mozilla.org/en-US/docs/Web/API/navigator.sendBeacon">API</a> to send a User Timing hit to Google Analytics without having to worry about the unload process cutting the request short.</p>
</li>
</ol>
<p>Hopefully, you&rsquo;ll end up with data like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/user-timings-bounced-sessions.jpg" title="User Timings for Bounced Sessions">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/user-timings-bounced-sessions.jpg#ZgotmplZ" alt="User Timings for Bounced Sessions" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 798 383'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Here you can see the User Timings recorded for pageviews of bounced sessions.</p>
<p>Here&rsquo;s another report:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/exit-page-time.jpg" title="Exit Page Time">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/exit-page-time.jpg#ZgotmplZ" alt="Exit Page Time" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 798 541'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>In this report, you can view Exit Pages with the time spent on each page as a secondary dimension.</p>
<p>Naturally, this data would be far more useful when extracted out of the GA interface into a spreadsheet, where you can actually make calculations with the Custom Dimension values, for example. Hopefully, at some point, we&rsquo;ll have the possibility to calculate our own Custom Metrics, at which point it will make more sense to send this information as a metric instead. Also, read Yehoshua&rsquo;s article I linked to in the beginning of the post. He uses Custom Metrics, which makes actually a lot more sense if you want to extract the data.</p>
<p>Nevertheless, until such a time that we can calculate on metrics, this is a useful method for obtaining a more accurate time on page across your sessions (so also for bounces and exit pages).</p>
<p>To get it working, you&rsquo;ll need the following components:</p>
<ol>
<li>
<p><strong>New Custom Dimension</strong>, session-scoped, to capture this information in GA</p>
</li>
<li>
<p><strong>Data Layer Variable</strong> to capture the value for <strong>gtm.start</strong></p>
</li>
<li>
<p><strong>Data Layer Variable</strong> to store the time on page</p>
</li>
<li>
<p><strong>Custom HTML Tag</strong>, which sets the <em>beforeunload</em> listener and does the <code>dataLayer.push()</code> when the page unload begins.</p>
</li>
<li>
<p><strong>Timing Tag</strong> which uses the quite new <strong>useBeacon</strong> field available in Universal Analytics. This field is basically a helper for setting up the <code>sendBeacon()</code> request.</p>
</li>
</ol>
<h3 id="1-custom-dimension">1. Custom Dimension</h3>
<p>Let&rsquo;s start with the Custom Dimension. We&rsquo;re using a session-scoped Custom Dimension for one simple reason: it will always have the last value sent during the session. This means that since we&rsquo;re sending the custom time on page on every single pageview, the session-scoped Custom Dimension should always have the exit page time for the session! Once we have this in place, we can add the custom dimension as a secondary dimension in the Exit Page report, giving us the dwell time for exit pages only.</p>
<p>Note that the session-scoped Custom Dimension fails if the user is inactive long enough for the session to expire (30 minutes by default). So it might actually be a good idea to modify the timing script to only allow values up to 1800000 milliseconds (30 minutes).</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/exit-page-custom-dimension.jpg" title="Custom Dimension for exit page time">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/exit-page-custom-dimension.jpg#ZgotmplZ" alt="Custom Dimension for exit page time" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 359 293'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Make note of the index the new Custom Dimension gets. This is important when you&rsquo;re setting up the Event Tag.</p>
<h3 id="2-data-layer-variable-for-gtmstart">2. Data Layer Variable for gtm.start</h3>
<p>The next step is to create the Data Layer Variable for <strong>gtm.start</strong>. You might wonder what this &ldquo;gtm.start&rdquo; is, but it&rsquo;s actually a property in the very first <code>dataLayer</code> object pushed into the Array by GTM, when the container snippet starts loading:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/gtm-start-datalayer.jpg" title="gtm.start in datalayer">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/gtm-start-datalayer.jpg#ZgotmplZ" alt="gtm.start in datalayer" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 490 241'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>The value for this variable is a timestamp in milliseconds of <a href="http://en.wikipedia.org/wiki/Unix_time">Epoch time</a>. You don&rsquo;t have to worry about what this means, since all we&rsquo;re going to use this for is to calculate the difference between page unload time and <strong>gtm.start</strong> to get an approximation of how long the user spent on the page.
The Data Layer Variable would look like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/dlv-gtm-start.jpg" title="Data Layer Variable gtm.start">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/dlv-gtm-start.jpg#ZgotmplZ" alt="Data Layer Variable gtm.start" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 456 551'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="3-data-layer-variable-for-timeonpage">3. Data Layer Variable for timeonpage</h3>
<p>You&rsquo;ll also need to create a Data Layer Variable for <strong>timeonpage</strong>, which is where we&rsquo;ll store the time on page, pushed in the <em>beforeunload</em> callback. So create another Data Layer Variable that looks like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/dlv-time-on-page.jpg" title="Data Layer Variable timeonpage">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/dlv-time-on-page.jpg#ZgotmplZ" alt="Data Layer Variable timeonpage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 444 553'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="4-custom-html-tag">4. Custom HTML Tag</h3>
<p>The next step is our custom <em>beforeunload</em> listener. Create a new Custom HTML Tag, and set it to fire with the <strong>All Pages</strong> Trigger. Add the following code within:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#1e90ff;font-weight:bold">script</span>&gt;
  <span style="color:#0aa">window</span>.addEventListener(<span style="color:#a50">&#39;beforeunload&#39;</span>, <span style="color:#00a">function</span>() {
    <span style="color:#0aa">window</span>.dataLayer.push({
      <span style="color:#a50">&#39;event&#39;</span> : <span style="color:#a50">&#39;unloadEvent&#39;</span>,
      <span style="color:#a50">&#39;timeonpage&#39;</span> : <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>().getTime() - {{DLV - gtm.start}}
    });
  });
&lt;/<span style="color:#1e90ff;font-weight:bold">script</span>&gt;</code></pre></div>
<p>This attaches the <em>beforeunload</em> listener to the global <code>window</code> object. When the unload process begins, i.e. when the user chooses to leave the page, the callback is invoked, and a <code>dataLayer.push()</code> is executed, with a custom &lsquo;event&rsquo; value and also a value for the &lsquo;timeonpage&rsquo; Variable we just created.</p>
<p>The time on page is calculated by getting the timestamp for the <em>beforeunload</em> event, and subtracting the <strong>gtm.start</strong> timestamp from it. The result is the time in milliseconds between these two events. If you want to have a safeguard for session expiration, cap this time at 1800000 milliseconds, which is 30 minutes.</p>
<p>Now all we need is the Timing Tag, which sends the <strong>timeonpage</strong> value both as a Timing value and as a Custom Dimension value.</p>
<h3 id="5-user-timing-tag">5. User Timing Tag</h3>
<p><em>User Timing</em> is a hit type that you can use to send your own timing events to Google Analytics. A common use case is to measure the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/user-timings#booya">load time of linked assets</a>, such as huge, bloated JavaScript libraries (I&rsquo;m looking at you, non-minified jQuery!).</p>
<p>But you can use User Timings for anything on the site that can be measured in milliseconds. So it works perfectly with page load time as well.</p>
<p>Before you create the Tag, you&rsquo;ll need the Trigger that makes the Tag fire. The Trigger is simply a Custom Event Trigger, that fires with event name <strong>unloadEvent</strong>:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/trigger-unloadevent.jpg" title="Trigger for unloadEvent">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/trigger-unloadevent.jpg#ZgotmplZ" alt="Trigger for unloadEvent" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 548 489'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Next, create a new Google Analytics / Universal Analytics Tag, attach the Trigger you just created to it, and set the Tag fields to look something like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/timing-tag.jpg" title="User Timing Tag">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/timing-tag.jpg#ZgotmplZ" alt="User Timing Tag" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 596 916'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>If you were to save this now and publish your container, the solution would be very unreliable. This is because the <em>beforeunload</em> event signals the browser to start the unload process, and the unload process is <strong>brutal</strong>. Any threads that are running once the browser reaches the <em>unload</em> stage are cut off, and all requests are cancelled. This is because the browser doesn&rsquo;t want to let anything impede the user&rsquo;s desire to leave the page.</p>
<p>Perfectly understandable.</p>
<p>It is for this reason that we&rsquo;ll leverage yet another little-known API: <code>navigator.sendBeacon()</code>. This API turns any request made in its scope into an asynchronous, uninterruptible call to whatever endpoint you choose. So, even if the browser window closes or you navigate from the site, the request is allowed to complete before the browser instance is unloaded from memory.</p>
<p>Google Analytics were quick to react to this API, and they published their own shorthand for it: <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#useBeacon">the <em>useBeacon</em> field</a>. Read <a href="http://www.twitter.com/thyng">David Vallejo</a>&rsquo;s <a href="https://www.thyngster.com/google-analytics-added-sendbeacon-functionality-universal-analytics-javascript-api/">nice review</a> about this new feature to get acquainted.</p>
<p>!!! <strong>UPDATE</strong> !!!
The <code>useBeacon</code> has been deprecated. Use the <code>transport</code> field name instead, and set its value to <code>beacon</code>. Read about the field <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#transport">here</a>.</p>
<p>Anyway, <strong>useBeacon</strong> turns the call into a POST request (instead of the usual GET), and passes it asynchronously to the GA endpoint using <code>navigator.sendBeacon()</code>.</p>
<p>To add this feature to the User Timing Tag, add <strong>useBeacon</strong> as a <em>Field To Set</em>, and set its value to <strong>true</strong>.</p>
<p>Also, add the <strong>{{DLV - timeonpage}}</strong> as a Custom Dimension, using the index number you got from Step 1.</p>
<p>So now the More Settings of your User Timing Tag should look like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2015/02/fields-to-set-timing.jpg" title="Fields To Set User Timing">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2015/02/fields-to-set-timing.jpg#ZgotmplZ" alt="Fields To Set User Timing" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 798 345'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>Save the Tag, Preview &amp; Debug the Tag, and Publish when you&rsquo;re ready.</p>
<p>Then read the caveats below. Or actually, it would be good if you read these before you publish.</p>
<h2 id="caveats">Caveats</h2>
<p>There is actually only one major caveat here. <code>navigator.sendBeacon()</code> has <strong>horrible</strong> browser support. Like, dismal. Basically, Internet Explorer and Safari do not support it all. This is a big setback, as IE is one of the most popular desktop browsers, and Safari is among the most popular mobile browsers.</p>
<p>The thing is, you don&rsquo;t really have to write any fallback functions for browsers that don&rsquo;t support the API. The Universal Analytics library detects if <code>navigator.sendBeacon()</code> is supported, and if it isn&rsquo;t, the hit is sent normally.</p>
<p>Depending on your site, there&rsquo;s still a good chance that the hit gets sent. This depends on how long it takes for the browser to unload your site.</p>
<p>If you want to play it safer, you could write your own click handler that intercepts external links, fires the Timing Tag, and only then lets the link redirect proceed. This would cover exits from your site to other sites nicely, but it wouldn&rsquo;t help with the most interesting use case of people closing browser windows and tabs.</p>
<p>This is a problem we&rsquo;ll just have to live with. However, as an eternal optimist, I see this as a solution that <strong>can only get better with time</strong>. Once <code>navigator.sendBeacon()</code> gets better support and once we get calculated Custom Metrics, this solution will be so awesome.</p>
<p>Right now it&rsquo;s more of a prototype, but as Yehoshua shows you, it can already have very interesting analytics applications.</p>
<p>Well, I&rsquo;d be remiss if I didn&rsquo;t mention one other, small caveat. Triggering code on <em>beforeunload</em> invalidates the back-forward cache (<a href="https://developer.mozilla.org/en-US/docs/Working_with_BFCache">BFCache</a>) in Firefox. This means that the page state of the page is no longer cached, and if you&rsquo;re trusting e.g. form field values to this cache, you&rsquo;ll need to make adjustments.</p>
<h2 id="summary">Summary</h2>
<p>In this quite simple solution we&rsquo;re leveraging some pretty cool APIs again. The point is partly to give you a tool to get better data out of Google Analytics, but at the same time we&rsquo;re doing what I love best: using JavaScript and Google Tag Manager to get data from unexpected places.</p>
<p>As I say in the previous chapter, this solution will only get better with time.</p>
<p>Hopefully, once <code>navigator.sendBeacon()</code> get better browser support, it will become the default request mechanism for all Google Analytics hits. It just makes so much sense. Also, it means that you won&rsquo;t need to protect your tags with <code>setTimeout()</code> calls or the <strong>Wait For Tags</strong> method in Google Tag Manager.</p>
<p>But from the look of things, this is still a long way off.</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/fields-to-set/">fields to set</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/guide/">Guide</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">JavaScript</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/matches-css-selector-operator-in-gtm-triggers/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/setting-google-analytics-fields-in-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Leverage%20useBeacon%20And%20beforeunload%20In%20Google%20Analytics%20https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://cdn.commento.io/js/commento.js"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/matches-css-selector-operator-in-gtm-triggers/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/setting-google-analytics-fields-in-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Leverage%20useBeacon%20And%20beforeunload%20In%20Google%20Analytics%20https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Leverage%20useBeacon%20And%20beforeunload%20In%20Google%20Analytics%20https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/leverage-usebeacon-beforeunload-google-analytics/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://cdn.commento.io/js/count.js"></script>


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

