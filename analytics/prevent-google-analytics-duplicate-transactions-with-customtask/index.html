

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Prevent Duplicate Transactions In Google Analytics With customTask | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/01\/duplicate-transactions.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/prevent-google-analytics-duplicate-transactions-with-customtask\/",
  "datePublished": "2019-01-04T10:46:43\u002b02:00",
  "dateModified": "2019-01-04T10:46:43\u002b02:00",
  "description": "Use customTask to prevent duplicate transactions from being recorded in Google Analytics.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Prevent Duplicate Transactions In Google Analytics With customTask | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    

    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
    
    <meta name="description" content="Use customTask to prevent duplicate transactions from being recorded in Google Analytics.">
    <meta property="og:description" content="Use customTask to prevent duplicate transactions from being recorded in Google Analytics.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Prevent Duplicate Transactions In Google Analytics With customTask">
    <meta property="og:url" content="https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Prevent Duplicate Transactions In Google Analytics With customTask">
    <meta name="twitter:description" content="Use customTask to prevent duplicate transactions from being recorded in Google Analytics.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/01/duplicate-transactions.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/01/duplicate-transactions.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://mastodon.social/@ahava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Prevent Duplicate Transactions In Google Analytics With customTask
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-01-04T10:46:43&#43;02:00">
        
  January 4, 2019

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>One of the big problems in <a href="https://analytics.google.com/">Google Analytics&rsquo;</a> data model is the immutability of historical data. Once a row of data is written into the data table, it is there practically for good. This is especially annoying in two cases: <a href="https://help.analyticsedge.com/article/definitive-guide-to-removing-google-analytics-spam/">spam</a> and bogus ecommerce hits. The first is a recognized issue with an <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/">open and public data collection protocol</a>, the latter is an annoyance that can explode into full-blown sabotage (you can use the Measurement Protocol to send hundreds of huge transactions to your competitor&rsquo;s GA property, for example).</p>
<p>In this article, I&rsquo;ll tackle a different symptom. I&rsquo;ve covered this <a href="https://www.simoahava.com/gtm-tips/prevent-repeat-transactions/">before</a>, and David Vallejo&rsquo;s written an <a href="https://www.thyngster.com/preventing-duplicate-transactions-in-universal-analytics-with-google-tag-manager/">excellent article</a> about this topic as well.</p>
<p>The problem is <strong>duplicate transactions</strong>. It&rsquo;s very common if your site has a receipt page that can be revisited via the browser cache or history. By revisiting the receipt page, it&rsquo;s often the case that the transaction details are written into <code>dataLayer</code> (or sent with the <code>ga()</code> method) again, resulting in the inflation of your ecommerce data.</p>
<p>A simpler way to confirm if this is an issue is to create <strong>custom report</strong> where you inspect Transaction IDs against the Transactions metric. Optimally, you&rsquo;d have one transaction per ID, unless you&rsquo;ve decided to enable transaction updates/upgrades in your data collection.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/duplicate-transactions.jpg" title="Duplicate transactions">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/duplicate-transactions.jpg#ZgotmplZ" alt="Duplicate transactions" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1686 704'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p>I&rsquo;ve decided to upgrade my solution to utilize <a href="https://www.simoahava.com/analytics/customtask-the-guide/">customTask</a>, since it lets you do without extra triggers or variable logic. We&rsquo;ll set things up with <a href="https://tagmanager.google.com/">Google Tag Manager</a>, but there&rsquo;s nothing stopping you from doing this with on-page analytics.js, too.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[â€“hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#how-it-works">How it works</a></li>
    <li><a href="#the-customtask-variable">The customTask variable</a></li>
    <li><a href="#triggers-and-variables-for-standard-ecommerce">Triggers and variables for Standard Ecommerce</a>
      <ul>
        <li><a href="#data-layer-variable-for-the-transaction-id">Data Layer variable for the Transaction ID</a></li>
        <li><a href="#1st-party-cookie-variable-for-the-transaction-id-list">1st Party Cookie variable for the transaction ID list</a></li>
        <li><a href="#custom-javascript-variable-to-check-if-the-id-is-within-the-list">Custom JavaScript variable to check if the ID is within the list</a></li>
        <li><a href="#the-exception-trigger">The exception trigger</a></li>
      </ul>
    </li>
    <li><a href="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="how-it-works">How it works</h2>
<p>When you add the <code>customTask</code> variable to your tags, it activates any time the tag tries to send a hit to Google Analytics.</p>
<p>During this activation, the method looks for the key <code>&amp;ti</code> in the hit model. This key corresponds to the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#ti"><strong>Transaction ID</strong></a> value.</p>
<p>Next, it looks into your browser storage for any transaction IDs already sent from the current browser.</p>
<p>If the transaction ID in the hit is found in browser storage, this <code>customTask</code> blocks the hit from ever being fired, this preventing the duplicated information from reaching Google Analytics.</p>
<p>If the transaction ID in the hit is <strong>not</strong> found in browser storage, the <code>customTask</code> sends the hit to GA normally, but it also stores the transaction ID in the list of transactions that has already been recorded. Thus, it blocks any <strong>future</strong> hits with this ID from being sent.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/duplicate-transaction-process.jpg" title="deduplication process">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/duplicate-transaction-process.jpg#ZgotmplZ" alt="deduplication process" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3128 2162'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<p><strong>NOTE!</strong> This auto-blocking feature only works with <a href="https://www.simoahava.com/analytics/enhanced-ecommerce-guide-for-google-tag-manager/">Enhanced Ecommerce</a>. With Standard Ecommerce, the <code>customTask</code> will only update browser storage but it won&rsquo;t block anything. You&rsquo;ll need to use triggers instead (read on for instructions how to do this).</p>

                
                  <h2 id="the-customtask-variable">The customTask variable</h2>
<p>You can use the <a href="https://www.simoahava.com/tools/customtask-builder/">customTask Builder tool</a> to generate the necessary variable, or you can simply copy-paste the code below into a <strong>Custom JavaScript variable</strong>, if you wish. The benefit of using the builder tool is that you can combine this <code>customTask</code> with all the other setups I&rsquo;ve added to the tool.</p>
<p>Anyway, this is what the Custom JavaScript variable should end up looking like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#aaa;font-style:italic">// customTask Builder by Simo Ahava
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">//
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">// More information about customTask: https://www.simoahava.com/analytics/customtask-the-guide/
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">//
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">// Change the default values for the settings below.
</span><span style="color:#aaa;font-style:italic"></span>
  <span style="color:#aaa;font-style:italic">// transactionDeduper: Configuration object for preventing duplicate transactions from being recorded.
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic">// https://bit.ly/2AvSZ2Y
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">var</span> transactionDeduper = {
    keyName: <span style="color:#a50">&#39;_transaction_ids&#39;</span>,
    cookieExpiresDays: <span style="color:#099">365</span>
  };

  <span style="color:#aaa;font-style:italic">// DO NOT EDIT ANYTHING BELOW THIS LINE
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">var</span> readFromStorage = <span style="color:#00a">function</span>(key) {
    <span style="color:#00a">if</span> (!<span style="color:#0aa">window</span>.Storage) {
      <span style="color:#aaa;font-style:italic">// From: https://stackoverflow.com/a/15724300/2367037
</span><span style="color:#aaa;font-style:italic"></span>      <span style="color:#00a">var</span> value = <span style="color:#a50">&#39;; &#39;</span> + <span style="color:#0aa">document</span>.cookie;
      <span style="color:#00a">var</span> parts = value.split(<span style="color:#a50">&#39;; &#39;</span> + key + <span style="color:#a50">&#39;=&#39;</span>);
      <span style="color:#00a">if</span> (parts.length === <span style="color:#099">2</span>) <span style="color:#00a">return</span> parts.pop().split(<span style="color:#a50">&#39;;&#39;</span>).shift();
    } <span style="color:#00a">else</span> {
      <span style="color:#00a">return</span> <span style="color:#0aa">window</span>.localStorage.getItem(key);
    }
  };

  <span style="color:#00a">var</span> writeToStorage = <span style="color:#00a">function</span>(key, value, expireDays) {
    <span style="color:#00a">if</span> (!<span style="color:#0aa">window</span>.Storage) {
      <span style="color:#00a">var</span> expiresDate = <span style="color:#00a">new</span> <span style="color:#0aa">Date</span>();
      expiresDate.setDate(expiresDate.getDate() + expireDays);
      <span style="color:#0aa">document</span>.cookie = key + <span style="color:#a50">&#39;=&#39;</span> + value + <span style="color:#a50">&#39;;expires=&#39;</span> + expiresDate.toUTCString();
    } <span style="color:#00a">else</span> {
      <span style="color:#0aa">window</span>.localStorage.setItem(key, value);
    }
  };

  <span style="color:#00a">var</span> globalSendHitTaskName   = <span style="color:#a50">&#39;_ga_originalSendHitTask&#39;</span>;

  <span style="color:#00a">return</span> <span style="color:#00a">function</span>(customTaskModel) {

    <span style="color:#0aa">window</span>[globalSendHitTaskName] = <span style="color:#0aa">window</span>[globalSendHitTaskName] || customTaskModel.get(<span style="color:#a50">&#39;sendHitTask&#39;</span>);
    <span style="color:#00a">var</span> tempFieldObject, dimensionIndex, count, ga, tracker, decorateTimer, decorateIframe, iframe;

    customTaskModel.set(<span style="color:#a50">&#39;sendHitTask&#39;</span>, <span style="color:#00a">function</span>(sendHitTaskModel) {

      <span style="color:#00a">var</span> originalSendHitTaskModel = sendHitTaskModel,
          originalSendHitTask      = <span style="color:#0aa">window</span>[globalSendHitTaskName],
          canSendHit               = <span style="color:#00a">true</span>;

      <span style="color:#00a">var</span> hitPayload, hitPayloadParts, param, val, regexI, trackingId, snowplowVendor, snowplowVersion, snowplowPath, request, originalTrackingId, hitType, nonInteraction, d, transactionId, storedIds;

      <span style="color:#00a">try</span> {

        <span style="color:#aaa;font-style:italic">// transactionDeduper
</span><span style="color:#aaa;font-style:italic"></span>        <span style="color:#00a">if</span> (<span style="color:#00a">typeof</span> transactionDeduper === <span style="color:#a50">&#39;object&#39;</span> &amp;&amp; transactionDeduper.hasOwnProperty(<span style="color:#a50">&#39;keyName&#39;</span>) &amp;&amp; transactionDeduper.hasOwnProperty(<span style="color:#a50">&#39;cookieExpiresDays&#39;</span>) &amp;&amp; <span style="color:#00a">typeof</span> sendHitTaskModel.get(<span style="color:#a50">&#39;&amp;ti&#39;</span>) !== <span style="color:#a50">&#39;undefined&#39;</span>) {
          transactionId = sendHitTaskModel.get(<span style="color:#a50">&#39;&amp;ti&#39;</span>);
          storedIds = JSON.parse(readFromStorage(transactionDeduper.keyName) || <span style="color:#a50">&#39;[]&#39;</span>);
          <span style="color:#00a">if</span> (storedIds.indexOf(transactionId) &gt; -<span style="color:#099">1</span> &amp;&amp; [<span style="color:#a50">&#39;transaction&#39;</span>, <span style="color:#a50">&#39;item&#39;</span>].indexOf(sendHitTaskModel.get(<span style="color:#a50">&#39;hitType&#39;</span>)) === -<span style="color:#099">1</span>) {
            canSendHit = <span style="color:#00a">false</span>;
          } <span style="color:#00a">else</span> <span style="color:#00a">if</span> (storedIds.indexOf(transactionId) === -<span style="color:#099">1</span>) {
            storedIds.push(transactionId);
            writeToStorage(transactionDeduper.keyName, JSON.stringify(storedIds), transactionDeduper.cookieExpiresDays);
          }
        }
        <span style="color:#aaa;font-style:italic">// /transactionDeduper
</span><span style="color:#aaa;font-style:italic"></span>
        <span style="color:#00a">if</span> (canSendHit) {
          originalSendHitTask(sendHitTaskModel);
        }

      } <span style="color:#00a">catch</span>(e) {
        originalSendHitTask(originalSendHitTaskModel);
      }

    });

  };
}
</code></pre></div>
<p>There&rsquo;s a configuration object in the variable <code>transactionDeduper</code> that you can modify, if you wish. The configuration object must have both <code>keyName</code> and <code>cookieExpiresDays</code>.</p>
<p>Set <code>keyName</code> to what you want the name of the cookie or the <code>localStorage</code> key to be. The default value is <code>_transaction_ids</code>.</p>
<p>Set <code>cookieExpiresDays</code> to the number of days the cookie should exist. A cookie is only used if the user&rsquo;s browser doesn&rsquo;t support <code>localStorage</code>. If <code>localStorage</code> is used, no expiration is set.</p>
<p>The main logic happens near the end of the code block, where I&rsquo;ve boxed the solution with <code>// transactionDeduper</code> and <code>// /transactionDeduper </code>.</p>
<p>It really is very simple, and it follows the process I outlined in the previous chapter.</p>
<p>If you&rsquo;re using <strong>Enhanced Ecommerce</strong>, then this <code>customTask</code> will take care of everything for you. In case the transaction ID is found in the list of stored IDs, it will simply block the hit from departing to Google Analytics.</p>
<p>If you&rsquo;re using <strong>Standard Ecommerce</strong>, the <code>customTask</code> will only write the ID into storage, and you&rsquo;ll need to handle the blocking logic yourself.</p>
<p>In any case, you need to add this <code>customTask</code> variable to all the Enhanced Ecommerce and/or Transaction tags that have the power to send purchase information to Google Analytics. For instructions how to add the <code>customTask</code> to your tags, see <a href="https://www.simoahava.com/analytics/customtask-the-guide/#how-to-add-customtask-to-your-hits">this guide</a> or follow the instructions in the <a href="https://www.simoahava.com/tools/customtask-builder/#general-deployment-instructions">customTask Builder tool</a>.</p>

                
                  <h2 id="triggers-and-variables-for-standard-ecommerce">Triggers and variables for Standard Ecommerce</h2>
<p>Due to how Standard Ecommerce is split into <code>transaction</code> and <code>item</code> hits, the blocking logic would be extremely difficult to automate in <code>customTask</code>. This is why you&rsquo;ll need to create an <strong>exception</strong> trigger for your Transaction tag, which blocks the tag from firing if the transaction ID is found in the list of stored IDs.</p>
<h3 id="data-layer-variable-for-the-transaction-id">Data Layer variable for the Transaction ID</h3>
<p>Create a <strong>Data Layer variable</strong> for <code>transactionId</code>, like this:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/dlv-transactionid.jpg" title="DLV - transcationId">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/dlv-transactionid.jpg#ZgotmplZ" alt="DLV - transcationId" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1256 874'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="1st-party-cookie-variable-for-the-transaction-id-list">1st Party Cookie variable for the transaction ID list</h3>
<p>Create a 1st Party Cookie variable for the transaction ID list, using the <code>keyName</code> you configured in the <code>customTask</code>. This is what a default setup would look like:</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/cookie-transaction-ids.jpg" title="Cookie - transcation IDs">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/cookie-transaction-ids.jpg#ZgotmplZ" alt="Cookie - transcation IDs" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1048 658'%3E%3C/svg%3E">
  
    </a>
  
  
</div>


<h3 id="custom-javascript-variable-to-check-if-the-id-is-within-the-list">Custom JavaScript variable to check if the ID is within the list</h3>
<p>Finally, create a Custom JavaScript variable which returns <code>true</code> if the transaction ID is found in the list.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#aaa;font-style:italic">// Change this to match the keyName you added to customTask:
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">var</span> keyName = <span style="color:#a50">&#39;_transaction_ids&#39;</span>;
  
  <span style="color:#00a">var</span> ids = JSON.parse((!!<span style="color:#0aa">window</span>.Storage ? <span style="color:#0aa">window</span>.localStorage.getItem(keyName) : {{Cookie - _transaction_ids}}) || <span style="color:#a50">&#39;[]&#39;</span>);
  <span style="color:#00a">return</span> ids.indexOf({{DLV - transactionId}}) &gt; -<span style="color:#099">1</span>;
}
</code></pre></div>
<p>Name the variable something like <strong>{{JS - transactionId sent}}</strong>.</p>
<h3 id="the-exception-trigger">The exception trigger</h3>
<p>The last step is to create a trigger which blocks your transaction tag from firing. It must use the same <strong>event</strong> as the transaction tag. So, if the transaction tag fires on a Page View trigger, the exception trigger must also be a Page View trigger (read more about exceptions <a href="https://www.simoahava.com/gtm-tips/block-your-tags-with-trigger-exceptions/">here</a>).</p>
<p>In the trigger conditions, check if {{JS - transactionId sent}} equals <code>true</code>. Thus, the exception will block the tag it is attached to if the transaction ID is found in the list of IDs already recorded.</p>
<p>Here&rsquo;s an example of what the exception looks like with a Custom Event trigger, and how the exception is added to the tag.</p>



<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/exception-trigger.jpg" title="Exception trigger">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/exception-trigger.jpg#ZgotmplZ" alt="Exception trigger" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2310 1060'%3E%3C/svg%3E">
  
    </a>
  
  
</div>





<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2019/01/tag-exception.jpg" title="Tag with exception">
  
    <img class="fig-img lazy" data-src="https://www.simoahava.com/images/2019/01/tag-exception.jpg#ZgotmplZ" alt="Tag with exception" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1944 926'%3E%3C/svg%3E">
  
    </a>
  
  
</div>



                
                  <h2 id="final-thoughts">Final thoughts</h2>
<p>My quest for improving Google Analytics&rsquo; data quality using <code>customTask</code> continues.</p>
<p>Preventing hits from being sent if certain conditions arise is nice and elegant to run through <code>customTask</code>, since you don&rsquo;t have to mess with complicated triggers cluttering your GTM interface.</p>
<p>However, every <code>customTask</code> used does increase the opaqueness of your setup, so the trade-off is that you won&rsquo;t know what individual tags do at a glance without drilling into their set fields (and understanding what <code>customTask</code> does in the first place).</p>
<p>As always, let me know what you think about this solution in the comments, and let me know also if you have suggestions for improving it! Thank you.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/customtask/">customtask</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/ecommerce/">ecommerce</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/enhanced-ecommerce/">enhanced ecommerce</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/obfuscate-and-duplicate-google-analytics-data/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/google-cloud/scrape-domain-and-write-results-to-bigquery/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Prevent%20Duplicate%20Transactions%20In%20Google%20Analytics%20With%20customTask%20https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/obfuscate-and-duplicate-google-analytics-data/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/google-cloud/scrape-domain-and-write-results-to-bigquery/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Prevent%20Duplicate%20Transactions%20In%20Google%20Analytics%20With%20customTask%20https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Prevent%20Duplicate%20Transactions%20In%20Google%20Analytics%20With%20customTask%20https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/prevent-google-analytics-duplicate-transactions-with-customtask/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

