

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Persist Campaign Data On The Landing Page | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2019\/12\/referrer-location.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/persist-campaign-data-landing-page\/",
  "datePublished": "2019-12-04T11:52:35\u002b02:00",
  "dateModified": "2019-12-04T11:52:35\u002b02:00",
  "description": "Persist landing page URLs with campaign parameters and external referrer strings in browser cookies (for e.g. post-consent campaign attribution).",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Persist Campaign Data On The Landing Page | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/persist-campaign-data-landing-page/">
    
    <meta name="description" content="Persist landing page URLs with campaign parameters and external referrer strings in browser cookies (for e.g. post-consent campaign attribution).">
    <meta property="og:description" content="Persist landing page URLs with campaign parameters and external referrer strings in browser cookies (for e.g. post-consent campaign attribution).">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Persist Campaign Data On The Landing Page">
    <meta property="og:url" content="https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Persist Campaign Data On The Landing Page">
    <meta name="twitter:description" content="Persist landing page URLs with campaign parameters and external referrer strings in browser cookies (for e.g. post-consent campaign attribution).">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2019/12/referrer-location.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2019/12/referrer-location.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" loading="lazy" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
  

    <h1>
      Persist Campaign Data On The Landing Page
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2019-12-04T11:52:35&#43;02:00">
        
  December 4, 2019

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/persist-campaign-data-landing-page/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p><a href="https://support.google.com/analytics/answer/2790010?hl=en">Universal Analytics</a> utilizes two components (by default) to attribute a browser session to a specific campaign: <strong>query parameters in the URL</strong> and the <strong>referrer string</strong>.</p>
<p>The page URL is sent with every hit to Google Analytics using the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#location">Document location</a> field, which also translates to the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#dl"><code>&amp;dl</code></a> parameter in the <em>Measurement Protocol</em>.</p>
<p>The referrer string is sent with a hit to Google Analytics using the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#referrer">Document referrer</a> field, as long as the referrer hostname does not exactly match that of the current page and the referrer string is not empty.</p>
<p>When attributing a hit to a campaign session, Google Analytics first checks the <strong>location</strong> value for the following parameters:</p>
<ul>
<li><code>gclid</code> - for attributing the session to <a href="https://support.google.com/analytics/answer/2938246?hl=en">Google Ads</a></li>
<li><code>utm_source</code> - for attributing the session to a custom campaign</li>
</ul>
<p>If these parameters are not found, Google Analytics looks at the <strong>referrer</strong> string.</p>



<div style="aspect-ratio: 930 / 175;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/referrer-location.jpg" title="location and referrer">
  
    <img class="fig-img" height="175" width="930" loading="lazy" src="https://www.simoahava.com/images/2019/12/referrer-location.jpg#ZgotmplZ" alt="location and referrer">
  
    </a>
  
  
</div>


<blockquote>
<p>Yes, there are additional steps to campaign attribution (see <a href="https://support.google.com/analytics/answer/6205762#flowchart">the flowchart</a>), but these two are relevant in the context of this article.</p>
</blockquote>
<p>There are two contexts where attributing campaigns based on URLs and referrer strings becomes complicated.</p>
<ol>
<li>If the site <strong>blocks Google Analytics on the landing page</strong> (due to missing consent), but then makes it available on subsequent pages (due to granted consent), the original campaign URL and referrer string are no longer available.</li>
<li>If the site is a <strong>single-page application</strong>, particularly <a href="https://tagmanager.google.com/">Google Tag Manager</a>-based tags become susceptible to the <a href="https://www.simoahava.com/gtm-tips/fix-rogue-referral-problem-single-page-sites/">rogue referral problem</a>.</li>
</ol>
<p>For this purpose, I have created a new <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/">custom template</a>: <strong>Persist Campaign Data</strong>.</p>



<div style="aspect-ratio: 499 / 403;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/persist-campaign-data.jpg" title="Persist campaign data template">
  
    <img class="fig-img" height="403" width="499" loading="lazy" src="https://www.simoahava.com/images/2019/12/persist-campaign-data.jpg#ZgotmplZ" alt="Persist campaign data template">
  
    </a>
  
  
</div>


<p>This template tackles both of the problems listed above. However, you will need to make additional changes to your Google Analytics settings before the solution is complete.</p>
<p>You can download the template from the <a href="https://tagmanager.google.com/gallery/#/owners/gtm-templates-simo-ahava/templates/persist-campaign-data">template gallery</a>.</p>
<div id="toc-container"><h1 id="table-of-contents">Table of Contents</h1> <input type="checkbox" id="show"><label for="show" id="showbtn"><h1 id="table-of-contents-mobile">Table of Contents</h1><span class="show">&nbsp;[+show]</span><span class="hide">&nbsp;[â€“hide]</span></label><nav id="TableOfContents">
  <ul>
    <li><a href="#1-store-campaign-data-in-a-session-cookie">1. Store campaign data in a session cookie</a>
      <ul>
        <li><a href="#setup-the-persist-campaign-data-tag">Setup the Persist Campaign Data tag</a></li>
        <li><a href="#create-the-cookie-variables">Create the cookie variables</a></li>
        <li><a href="#create-the-customtask">Create the <code>customTask</code></a></li>
        <li><a href="#add-the-customtask-to-your-google-analytics-tags">Add the <code>customTask</code> to your Google Analytics tags</a></li>
        <li><a href="#store-campaign-data---summary">Store campaign data - summary</a></li>
      </ul>
    </li>
    <li><a href="#2-push-original-location-in-datalayer">2. Push original location in dataLayer</a>
      <ul>
        <li><a href="#setup-the-persist-campaign-data-tag-1">Setup the Persist Campaign Data tag</a></li>
        <li><a href="#create-the-data-layer-variable">Create the Data Layer Variable</a></li>
        <li><a href="#update-your-google-analytics-tags">Update your Google Analytics tags</a></li>
        <li><a href="#how-it-works">How it works</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="1-store-campaign-data-in-a-session-cookie">1. Store campaign data in a session cookie</h2>
<p>The first problem is particularly bothersome on sites that utilize <strong>consent management systems</strong> to block Google Analytics if consent has not been granted.</p>
<p>If consent is granted on the landing page, then there should be no issues. The page is reloaded with the campaign parameters in the URL and the referral string intact, and Google Analytics tags can make use of these when attributing the session to a specific campaign.</p>
<p>However, if the user grants consent only <strong>after navigating deeper into the site</strong>, the tags that fire on these pages will no longer have access to the initial campaign that brought the user to the site, which leads to <strong>inflation of direct traffic</strong>.</p>
<p>To solve this problem, the template tag (assuming Google Tag Manager is not blocked, too) writes the URL of the current page in a cookie <em>if</em> it has campaign-setting parameters. Similarly, the referrer string is also written in a cookie <em>if</em> its hostname does not contain the current page hostname.</p>



<div style="aspect-ratio: 995 / 59;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/campaign-cookies.jpg" title="Campaign cookies">
  
    <img class="fig-img" height="59" width="995" loading="lazy" src="https://www.simoahava.com/images/2019/12/campaign-cookies.jpg#ZgotmplZ" alt="Campaign cookies">
  
    </a>
  
  
</div>


<p>Then, when the Google Analytics tags finally fire, they can take the original location and referrer from these cookies to attribute the session to its correct source.</p>
<h3 id="setup-the-persist-campaign-data-tag">Setup the Persist Campaign Data tag</h3>
<p>Create a new tag with the <strong>Persist Campaign Data</strong> template. Check the box next to <strong>Store campaign data in a browser cookie</strong> and check that the settings are OK.</p>



<div style="aspect-ratio: 558 / 384;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/store-campaign-cookie.jpg" title="Store campaign data in a browser cookie">
  
    <img class="fig-img" height="384" width="558" loading="lazy" src="https://www.simoahava.com/images/2019/12/store-campaign-cookie.jpg#ZgotmplZ" alt="Store campaign data in a browser cookie">
  
    </a>
  
  
</div>


<p>By default, the following URL parameters will cause the tag to set the campaign URL cookie:</p>
<ul>
<li><code>utm_source</code></li>
<li><code>utm_medium</code></li>
<li><code>utm_campaign</code></li>
<li><code>utm_term</code></li>
<li><code>utm_content</code></li>
<li><code>utm_id</code></li>
<li><code>gclid</code></li>
</ul>
<p>Naturally, you can add additional parameters to the list if you wish.</p>
<p>Not all of these parameters have the ability to start a new session (only <code>utm_source</code> and <code>gclid</code> do, in fact), but the assumption is that if you&rsquo;ve set any UTM parameters, you want to include them with your hits.</p>
<p>Next, you can change the default name of the URL cookie and the referrer cookie, if you wish.</p>
<blockquote>
<p><strong>NOTE!</strong> If you do change the name of either cookie, you <strong>must</strong> edit the <a href="https://www.simoahava.com/analytics/custom-templates-guide-for-google-tag-manager/#sets-a-cookie-value">template permissions</a> and allow the template to set the new cookie name(s).</p>
</blockquote>
<p>The tag will only write the cookies in specific conditions:</p>
<ol>
<li>The <strong>URL</strong> cookie is only written if the URL query string has any one of the listed trigger parameters. If such a parameter is found, the full URL is written into the campaign URL cookie.</li>
<li>The <strong>Referrer</strong> cookie is only written if the referrer hostname does not contain the current page hostname, and the referrer string is not empty. If both conditions are good, the full referrer string is written into the referrer cookie.</li>
</ol>
<p>Thus it&rsquo;s safe to set it on the <strong>All Pages</strong> trigger, as it doesn&rsquo;t matter if it fires on every single page.</p>
<p><strong>Note!</strong> You might want to actually set it on a trigger that fires once user consent has been established - if the user gives consent or has already given consent, the tag does not need to (and should not) fire, because then your Google Analytics tags would fire normally and your wouldn&rsquo;t need to save the URL and referrer data in cookies.</p>
<h3 id="create-the-cookie-variables">Create the cookie variables</h3>
<p>You&rsquo;ll need two new, user-defined <strong>1st Party Cookie</strong> variables.</p>
<p>The first, <strong>{{Cookie - __gtm_campaign_url}}</strong>. The second, <strong>{{Cookie - __gtm_referrer}}</strong>.</p>
<p>Make sure you check the <strong>URI-decode cookie</strong> box.</p>



<div style="aspect-ratio: 476 / 360;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/campaign-url-cookie.jpg" title="Campaign URL cookie">
  
    <img class="fig-img" height="360" width="476" loading="lazy" src="https://www.simoahava.com/images/2019/12/campaign-url-cookie.jpg#ZgotmplZ" alt="Campaign URL cookie">
  
    </a>
  
  
</div>





<div style="aspect-ratio: 424 / 359;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/referrer-cookie.jpg" title="referrer-cookie.jpg">
  
    <img class="fig-img" height="359" width="424" loading="lazy" src="https://www.simoahava.com/images/2019/12/referrer-cookie.jpg#ZgotmplZ" alt="referrer-cookie.jpg">
  
    </a>
  
  
</div>


<h3 id="create-the-customtask">Create the <code>customTask</code></h3>
<p>To update your Google Analytics tags, we&rsquo;ll be using a <a href="https://www.simoahava.com/analytics/customtask-the-guide/"><code>customTask</code></a>. This is an easy way to make sure the cookies are only used if they exist, and it&rsquo;s a great way to actually delete the cookies as soon as they&rsquo;ve been used, so that they don&rsquo;t persist needlessly.</p>
<blockquote>
<p><strong>NOTE!</strong> You don&rsquo;t <em>have</em> to use a <code>customTask</code>. You can set the <code>location</code>, <code>page</code>, and <code>referrer</code> fields manually on the tag, if you wish. You just need to add proper fallback values if the cookies do not exist, otherwise you risk corrupting your data with invalid <code>location</code> and <code>referrer</code> fields.</p>
</blockquote>
<p>If you need the cookies for something else as well, then you can set the <code>customTask</code> to <strong>not</strong> delete cookies after the values have been &ldquo;used&rdquo;.</p>
<p>Create a new <strong>Custom JavaScript variable</strong>, name it <strong>{{customTask - set location and referrer from cookie}}</strong>, and add the following code within:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">return</span> <span style="color:#00a">function</span>(customModel) {
    <span style="color:#aaa;font-style:italic">// Set to the cookie variables
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> storedLocation = {{Cookie - __gtm_campaign_url}};
    <span style="color:#00a">var</span> storedReferrer = {{Cookie - __gtm_referrer}};
    <span style="color:#aaa;font-style:italic">// Set to the cookie names
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> storedLocationCookieName = <span style="color:#a50">&#39;__gtm_campaign_url&#39;</span>;
    <span style="color:#00a">var</span> storedReferrerCookieName = <span style="color:#a50">&#39;__gtm_referrer&#39;</span>;
    <span style="color:#aaa;font-style:italic">// Set to the root domain of your site (e.g. domain name without any subdomain, &#34;mysite.com&#34;)
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> domainName = <span style="color:#a50">&#39;simoahava.com&#39;</span>;
    <span style="color:#aaa;font-style:italic">// Choose whether to delete a cookie after its value is used (true/false)
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">var</span> deleteCookieToggle = <span style="color:#00a">true</span>;

    <span style="color:#00a">var</span> deleteCookie = <span style="color:#00a">function</span>(name) {
      <span style="color:#0aa">document</span>.cookie = name + <span style="color:#a50">&#39;=; path=/; domain=&#39;</span> + domainName + <span style="color:#a50">&#39;; expires=Thu, 01 Jan 1970 00:00:00 GMT&#39;</span>;
    };
    
    <span style="color:#00a">if</span> (<span style="color:#00a">typeof</span> storedLocation !== <span style="color:#a50">&#39;undefined&#39;</span>) {
      customModel.set(<span style="color:#a50">&#39;location&#39;</span>, storedLocation);
      customModel.set(<span style="color:#a50">&#39;page&#39;</span>, <span style="color:#0aa">document</span>.location.pathname + <span style="color:#0aa">document</span>.location.search);
      <span style="color:#00a">if</span> (deleteCookieToggle === <span style="color:#00a">true</span>) { deleteCookie(storedLocationCookieName); }
    }
    <span style="color:#00a">if</span> (<span style="color:#00a">typeof</span> storedReferrer !== <span style="color:#a50">&#39;undefined&#39;</span>) {
      customModel.set(<span style="color:#a50">&#39;referrer&#39;</span>, storedReferrer);
      <span style="color:#00a">if</span> (deleteCookieToggle === <span style="color:#00a">true</span>) { deleteCookie(storedReferrerCookieName); }
    }
  };
}
</code></pre></div>
<p>There are some things you might need to edit.</p>
<p>Change the <code>storedLocation</code> and <code>storedReferrer</code> variables to point to the correct Google Tag Manager 1st Party Cookie variables you&rsquo;ve created, if you&rsquo;ve diverted from the default values used in this guide.</p>
<p>Change the <code>storedLocationCookieName</code> and <code>storedReferrerCookieName</code> to the correct cookie names, if you&rsquo;ve diverted from the default values used in this guide.</p>
<p>Set the <code>domainName</code> to the correct root domain (domain name without any subdomains included).</p>
<p>Set the <code>deleteCookieToggle</code> to <code>false</code> if you don&rsquo;t want the task to remove cookies once their values have been &ldquo;used&rdquo;.</p>
<p>This <code>customTask</code> sets the <code>location</code> and<code>referrer</code> fields if the respective cookies exist, and then (optionally) deletes the cookies for those fields that were set. If a cookie doesn&rsquo;t exist, its field is not set.</p>
<p>If the <code>location</code> is set, the <code>customTask</code> also sets the <code>page</code> field to the current page path and query string. If it didn&rsquo;t do this, then the tag would take the page path from the <code>location</code> as well, which would inflate the pageviews of the landing page rather than increment them for the page the user is actually on.</p>
<h3 id="add-the-customtask-to-your-google-analytics-tags">Add the <code>customTask</code> to your Google Analytics tags</h3>
<p>Finally, add the <code>customTask</code> variable you just created to your Google Analytics tags. You only need to have it fire on the first tag that fires on the page, but just to be safe it might make sense to add it to your <a href="https://www.simoahava.com/analytics/google-analytics-settings-variable-in-gtm/">Google Analytics Settings variable</a>, and then attach that to all your tags.</p>



<div style="aspect-ratio: 892 / 451;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/gas-variable.jpg" title="Google Analytics Settings variable">
  
    <img class="fig-img" height="451" width="892" loading="lazy" src="https://www.simoahava.com/images/2019/12/gas-variable.jpg#ZgotmplZ" alt="Google Analytics Settings variable">
  
    </a>
  
  
</div>


<p>The field name is <strong>customTask</strong> and the value is <strong>{{customTask - set location and referrer from cookie}}</strong>.</p>
<h3 id="store-campaign-data---summary">Store campaign data - summary</h3>
<p>If the user lands on your site with campaign parameters in the URL and/or a referrer that is external to your website&rsquo;s domain, the following happens:</p>
<ol>
<li>The <strong>Persist Campaign Data</strong> tag creates new cookies where necessary; one for the URL of the page (if it had campaign parameters) and one for the referrer string (if it&rsquo;s an external domain).</li>
<li>Once the user gives consent, your Google Analytics tags utilize a <code>customTask</code> which <strong>sets the <code>location</code> and <code>referrer</code> fields</strong> from the cookies, and subsequently deletes the cookies.</li>
<li>Thus the campaign URL and the referrer string are preserved for Google Analytics tags that might not fire until later in the site navigation, when the original URL parameters and referrer string are just a memory.</li>
</ol>
<p>There are some caveats to note.</p>
<ol>
<li>If you already have a <code>customTask</code> set, you need to <strong>modify</strong> it to include the <code>customTask</code> code from this guide. See <a href="https://www.simoahava.com/analytics/customtask-the-guide/#putting-it-all-together-literally">this</a> for inspiration.</li>
<li>There might be a <strong>race condition</strong> where the Persist Campaign Data tag completes <em>after</em> the Google Analytics tag has fired, leading to cookies being created but not utilized (and subsequently deleted). An easy way to avoid this problem is to make sure the Persist Campaign Data tag only fires if user has <strong>not</strong> given consent. That way it will only fire if the Google Analytics have been blocked.</li>
<li>The cookies are <strong>session cookies</strong> so if the user closes the browser and then re-opens it to continue navigation, the stored data is lost.</li>
<li><strong>Cross-domain tracking</strong> is something that is very likely lost if you delay firing your tags beyond the landing page - this solution will not help with this problem. You could take the Client ID from the linker parameter, but since you&rsquo;re not validating the linker parameter, the data would be vulnerable to link sharing (and any users who follow the shared link would be counted as the same user by Google Analytics).</li>
</ol>

                
                  <h2 id="2-push-original-location-in-datalayer">2. Push original location in dataLayer</h2>
<p>The <a href="https://www.simoahava.com/gtm-tips/fix-rogue-referral-problem-single-page-sites/">rogue referral problem</a> is a scenario where tags firing on a single-page app use the &ldquo;virtual&rdquo; location for campaign attribution (often missing the original campaign parameters) and thus Google Analytics reverts to the referrer instead. This results in sessions where hits sent on the first page are part of a <code>google / cpc</code> session, but as soon as the user navigates to other parts of the SPA, the campaign changes to the referral source, such as <code>google / organic</code>.</p>



<div style="aspect-ratio: 709 / 236;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/rogue-referral.jpg" title="Rogue referrer">
  
    <img class="fig-img" height="236" width="709" loading="lazy" src="https://www.simoahava.com/images/2019/12/rogue-referral.jpg#ZgotmplZ" alt="Rogue referrer">
  
    </a>
  
  
</div>


<blockquote>
<p><strong>NOTE!</strong> Please understand that these steps must only be taken if the site is a <strong>single-page app</strong> or has single-page app components. There&rsquo;s no harm in setting this up on a regular site, but it&rsquo;s just extra work and clutter in the container.</p>
</blockquote>
<p>To fix this, you need the following.</p>
<h3 id="setup-the-persist-campaign-data-tag-1">Setup the Persist Campaign Data tag</h3>
<p>Create a new <strong>tag</strong> with the <strong>Persist Campaign Data</strong> template. Check the box next to <strong>Push original location in dataLayer</strong> and check that the settings are OK.</p>



<div style="aspect-ratio: 906 / 567;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/push-original-location.jpg" title="Push original location in dataLayer">
  
    <img class="fig-img" height="567" width="906" loading="lazy" src="https://www.simoahava.com/images/2019/12/push-original-location.jpg#ZgotmplZ" alt="Push original location in dataLayer">
  
    </a>
  
  
</div>


<p>Set this tag to fire on the <strong>All Pages</strong> trigger.</p>
<p>This tag, when fires, does a very simple thing. It writes the current URL into the <code>dataLayer</code> using the key <code>originalLocation</code>.</p>
<p>It&rsquo;s important that this tag only fires <strong>once</strong> on the initial page load (hence the All Pages trigger).</p>
<h3 id="create-the-data-layer-variable">Create the Data Layer Variable</h3>
<p>Next, create a Data Layer variable named <strong>{{Original Location}}</strong>, and set it to point to the <code>originalLocation</code> key. Importantly, set its <strong>Default Value</strong> to {{Page URL}}.</p>



<div style="aspect-ratio: 594 / 513;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2019/12/original-location.jpg" title="Original Location">
  
    <img class="fig-img" height="513" width="594" loading="lazy" src="https://www.simoahava.com/images/2019/12/original-location.jpg#ZgotmplZ" alt="Original Location">
  
    </a>
  
  
</div>


<blockquote>
<p>The <strong>Default Value</strong> is very important. It&rsquo;s more than likely that a Google Analytics tag fires before <code>originalLocation</code> is pushed into <code>dataLayer</code>, so the variable simply returns the current page URL (which should be the same as <code>originalLocation</code>) in case such a race condition emerges.</p>
</blockquote>
<h3 id="update-your-google-analytics-tags">Update your Google Analytics tags</h3>
<p>Now that you have the template tag firing on the All Pages trigger, and you have the Data Layer variable ready, you need to edit <strong>every single one of your Google Analytics tags</strong>. Easiest way to do this is with the <a href="https://www.simoahava.com/analytics/google-analytics-settings-variable-in-gtm/">Google Analytics Settings variable</a>.</p>
<blockquote>
<p><strong>NOTE!</strong> It&rsquo;s vital that <em>every single Google Analytics tag</em> has this modification. If there&rsquo;s even a single tag that fires without the fixed <em>location</em>, it&rsquo;s possible that you campaign data will be broken.</p>
</blockquote>
<p>You need to add <a href="https://www.simoahava.com/analytics/edit-google-analytics-tag-settings/">two fields</a> to the variable:</p>
<p><strong>Field name</strong>: <code>location</code><br>
<strong>Value</strong>: <code>{{Original Location}}</code></p>
<p><strong>Field name</strong>: <code>page</code><br>
<strong>Value</strong>: <code>{{Page Path}}</code></p>
<p>The value of <code>page</code> should be whatever you currently use for your virtual pageviews on your single-page app. It could be a Data Layer variable, a history state variable, or it could simply be the current page URL or current page path, as in the example above.</p>
<p>Both of these fields are required to be set in your tags.</p>
<h3 id="how-it-works">How it works</h3>
<p>Once you&rsquo;ve set it up, here&rsquo;s what happens.</p>
<ol>
<li>When the user lands on the page, the page URL is stored in the <code>originalLocation</code> Data Layer variable.</li>
<li>When a Google Analytics tag fires, it takes the <em>location</em> field from this variable. This is because the <em>location</em> field is used for campaign attribution, and the landing page has all these parameters.</li>
<li>The <em>page</em> field is set so that a virtual page path could be set for your single-page app page views.</li>
</ol>
<p>Thus by always sending the URL of the initial page load as the value of the <em>location</em> field, the <a href="https://www.simoahava.com/gtm-tips/fix-rogue-referral-problem-single-page-sites/">rogue referral problem</a> is fixed.</p>

                
                  <h2 id="summary">Summary</h2>
<p>The <a href="https://tagmanager.google.com/gallery/#/owners/gtm-templates-simo-ahava/templates/persist-campaign-data">Persist Campaign Data</a> template addresses two problems with campaign tracking in Google Analytics.</p>
<ol>
<li>Delayed / deferred Google Analytics tracking, where the first hits of the session are sent <strong>after</strong> the user has navigated away from the landing page.</li>
<li>Single-page application tracking, where campaign sessions get incorrectly attributed to the referrer string rather than the parameters in the URL.</li>
</ol>
<p>You can, of course, utilize the features for other things as well. Persisting campaign parameters can have uses beyond Google Analytics tracking, and identifying the URL of the first page load of a SPA could similarly be used to understand navigation patterns better.</p>
<p>As always, I look forward to hearing from you in the comments. Do you see problems with either approach? Do you have suggestions for improving the template or the implementation thereof?</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/custom-templates/">custom templates</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/single-page-apps/">single-page apps</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/consent/">consent</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/chrome-samesite-warnings-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/tag-template-test-walkthrough/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Persist%20Campaign%20Data%20On%20The%20Landing%20Page%20https://www.simoahava.com/analytics/persist-campaign-data-landing-page/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/chrome-samesite-warnings-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/tag-template-test-walkthrough/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Persist%20Campaign%20Data%20On%20The%20Landing%20Page%20https://www.simoahava.com/analytics/persist-campaign-data-landing-page/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Persist%20Campaign%20Data%20On%20The%20Landing%20Page%20https://www.simoahava.com/analytics/persist-campaign-data-landing-page/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/persist-campaign-data-landing-page/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

