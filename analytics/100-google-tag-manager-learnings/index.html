

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "100&#43; Google Tag Manager Learnings | Simo Ahava's blog",
  "image": "https://www.simoahava.com/images/2017/02/100-tips.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.simoahava.com/images/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https://www.simoahava.com/analytics/100-google-tag-manager-learnings/",
  "datePublished": "2017-03-01T10:18:43+00:00",
  "dateModified": "2017-03-01T10:18:43+00:00",
  "description": "Over 100 tips and lessons learned after five years of using Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.48 with theme Tranquilpeak 0.4.3-BETA">
    <title>100&#43; Google Tag Manager Learnings | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article'});
    </script>
    

    <script src="https://www.simoahava.com/x-js/lazyload.iife.min.js"></script>

    <script src="//de.cdn-v3.conductrics.com/ac-GeQBKxGTiA/v3/agent-api/js/f-TNZdDPOknZ/dt-8BnrVvfJuB1PwktQxXXgVK2OikZ9WR?apikey=api-WDrqMnckreSqejZgDAMu" type="text/javascript"></script>

    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PZ7GMV9');</script>
    
    <script src="//simoahava.disqus.com/count.js" id="dsq-count-scr" async></script>
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/100-google-tag-manager-learnings/">
    
    <meta name="description" content="Over 100 tips and lessons learned after five years of using Google Tag Manager.">
    <meta property="og:description" content="Over 100 tips and lessons learned after five years of using Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="100&#43; Google Tag Manager Learnings">
    <meta property="og:url" content="/analytics/100-google-tag-manager-learnings/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="100&#43; Google Tag Manager Learnings">
    <meta name="twitter:description" content="Over 100 tips and lessons learned after five years of using Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2017/02/100-tips.jpg">  
      <meta property="og:image" content="https://www.simoahava.com/images/2017/02/100-tips.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      100&#43; Google Tag Manager Learnings
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2017-03-01T10:18:43Z">
        
  March 1, 2017

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/100-google-tag-manager-learnings/#disqus_thread">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              

<p>I&rsquo;ve always been proud to avoid the typical headline clickbait of &ldquo;Ultimate guide to pigeon care&rdquo;, &ldquo;All you need to know about the Great Vowel Shift&rdquo;, &ldquo;Did you know that you&rsquo;ve been smoking peyote wrong your whole life?&rdquo;. I&rsquo;m ready to make an exception now by adding a BIG WHOPPING NUMBER to the title. You see, the amount of knowledge one can accumulate about anything they do on a daily basis is mind-blowing. It helps if you write a blog about the topic, since creative output is a great way to organize your thoughts. It also helps to be active in community support, since problem-solving is an excellent way to accumulate new skills and to hone the edge of your existing talent.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/100-tips.jpg" title="Google Tag Manager lessons learned">
  
    <img class="fig-img lazy" data-src="/images/2017/02/100-tips.jpg#ZgotmplZ" alt="Google Tag Manager lessons learned">
  
    </a>
  
  
</div>



<p>Now, I already have 50+ <a href="https://www.simoahava.com/categories/gtm-tips/">GTM Tips</a> written, so it&rsquo;s not like this is a novel idea, even on this blog. But this time I just wanted to write short, byte-sized things I&rsquo;ve learned along the way, and I want to share them with you.</p>

<p>As you can read from the outrageously baiting title, there should be 100+ tips, but I only enumerated an even 100. That&rsquo;s because I want YOU to add your ideas to the end of this post, and let&rsquo;s see if we can keep it going. Yes, it&rsquo;s my shameful attempt to delegate content creation to the community. I am guilty of that, too, now.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#container-javascript-snippet">Container JavaScript Snippet</a>
<ul>
<li><a href="#1-initializes-the-datalayer">1. Initializes the <code>dataLayer</code></a></li>
<li><a href="#2-creates-the-script-loader-for-the-gtm-library">2. Creates the script loader for the GTM library</a></li>
<li><a href="#3-javascript-snippet-should-be-in-head-but-can-be-almost-anywhere">3. JavaScript snippet should be in <code>&lt;head&gt;</code> but can be (almost) anywhere</a></li>
<li><a href="#4-pushes-the-initial-event-gtm-js">4. Pushes the initial <code>event: 'gtm.js'</code></a></li>
<li><a href="#5-multiple-container-snippets-on-a-page-are-supported">5. Multiple container snippets on a page are supported</a></li>
</ul></li>
<li><a href="#container-noscript-snippet">Container <code>&lt;noscript&gt;</code> snippet</a>
<ul>
<li><a href="#6-the-noscript-block-should-be-at-the-very-beginning-of-body">6. The <code>&lt;noscript&gt;</code> block should be at the very beginning of <code>&lt;body&gt;</code></a></li>
<li><a href="#7-only-executed-by-browsers-with-javascript-disabled">7. Only executed by browsers with JavaScript disabled</a></li>
<li><a href="#8-loads-an-html-page-in-an-iframe">8. Loads an HTML page in an <code>&lt;iframe&gt;</code></a></li>
<li><a href="#9-only-the-page-view-trigger-works">9. Only the Page View trigger works</a></li>
<li><a href="#10-use-a-function-return-true-custom-javascript-variable-in-the-trigger">10. Use a <code>function() { return true; }</code> Custom JavaScript variable in the trigger</a></li>
<li><a href="#11-only-the-custom-image-tag-is-useful">11. Only the Custom Image tag is useful</a></li>
<li><a href="#12-can-utilize-data-layer-parameters-via-query-parameters">12. Can utilize &ldquo;Data Layer&rdquo; parameters via query parameters</a></li>
</ul></li>
<li><a href="#the-datalayer-structure">The <code>dataLayer</code> structure</a>
<ul>
<li><a href="#13-global-javascript-array">13. Global JavaScript array</a></li>
<li><a href="#14-you-can-use-a-different-name-than-datalayer">14. You can use a different name than <code>dataLayer</code></a></li>
<li><a href="#15-only-the-push-method-works-with-gtm">15. Only the <code>.push()</code> method works with GTM</a></li>
<li><a href="#16-typically-only-plain-objects-work-with-gtm">16. Typically only plain objects work with GTM</a></li>
<li><a href="#17-you-can-use-any-javascript-type-as-a-value-of-a-key">17. You can use any JavaScript type as a value of a key</a></li>
<li><a href="#18-only-event-key-can-trigger-tags">18. Only <code>event</code> key can trigger tags</a></li>
<li><a href="#19-you-can-also-push-a-command-array">19. You can also <code>.push()</code> a command array</a></li>
<li><a href="#20-never-overwrite-always-push">20. Never overwrite, always <code>.push()</code></a></li>
<li><a href="#21-the-array-is-capped-at-300">21. The array is capped at 300</a></li>
</ul></li>
<li><a href="#gtm-s-data-model">GTM&rsquo;s data model</a>
<ul>
<li><a href="#22-copies-messages-queued-via-datalayer-push">22. Copies messages queued via <code>dataLayer.push()</code></a></li>
<li><a href="#23-gtm-freezes-variable-values-when-a-trigger-fires">23. GTM freezes variable values when a trigger fires</a></li>
<li><a href="#24-objects-are-recursively-merged">24. Objects are recursively merged</a></li>
<li><a href="#25-arrays-are-recursively-merged">25. Arrays are recursively merged</a></li>
<li><a href="#26-you-can-run-javascript-methods-on-existing-data-layer-values-with-a-command-array">26. You can run JavaScript methods on existing Data Layer values with a command array</a></li>
<li><a href="#27-version-1-vs-version-2-of-the-data-layer-variable">27. Version 1 vs. Version 2 of the Data Layer Variable</a></li>
<li><a href="#28-google-tag-manager-gtm-xxxx-datalayer-methods">28. <code>google_tag_manager['GTM-XXXX'].dataLayer</code> methods</a></li>
</ul></li>
<li><a href="#preview-mode">Preview mode</a>
<ul>
<li><a href="#29-preview-mode-works-with-a-cookie-on-www-googletagmanager-com-in-the-preview-browser">29. Preview mode works with a cookie on www.googletagmanager.com in the preview browser</a></li>
<li><a href="#30-shows-the-state-of-tags-triggers-variables-and-data-layer-at-each-data-layer-message">30. Shows the state of tags, triggers, variables, and Data Layer at each Data Layer message</a></li>
<li><a href="#31-summary-shows-the-state-at-the-latest-message">31. Summary shows the state at the latest message</a></li>
<li><a href="#32-variables-are-resolved-multiple-times-at-least-once-per-message">32. Variables are resolved multiple times - at least once per message</a></li>
<li><a href="#33-preview-can-be-minimized">33. Preview can be minimized</a></li>
<li><a href="#34-to-quit-preview-you-need-to-exit-preview-mode-via-the-gtm-ui">34. To quit preview, you need to exit preview mode via the GTM UI</a></li>
<li><a href="#35-to-quit-a-shared-preview-you-need-to-follow-the-original-link">35. To quit a shared preview, you need to follow the original link</a></li>
<li><a href="#36-problems-with-the-preview-mode-not-showing-correctly-are-most-typically-due-to-css-conflicts">36. Problems with the preview mode not showing correctly are most typically due to CSS conflicts</a></li>
<li><a href="#37-you-can-also-preview-without-the-debug-panel">37. You can also preview without the debug panel</a></li>
<li><a href="#38-preview-must-be-refreshed-after-every-change">38. Preview must be refreshed after every change</a></li>
</ul></li>
<li><a href="#universal-analytics">Universal Analytics</a>
<ul>
<li><a href="#39-gtm-creates-a-new-tracker-with-every-tag-instance">39. GTM creates a new tracker with every tag instance</a></li>
<li><a href="#40-settings-are-not-shared-across-tags">40. Settings are not shared across tags</a></li>
<li><a href="#41-you-can-set-a-tracker-name-but-most-often-this-is-risky-and-unnecessary">41. You can set a tracker name, but most often this is risky and unnecessary</a></li>
<li><a href="#42-use-fields-to-set-for-setting-any-analytics-js-fields">42. Use Fields to Set for setting any analytics.js fields</a></li>
<li><a href="#43-if-a-field-has-the-variable-icon-you-can-use-variables-in-it">43. If a field has the variable icon, you can use variables in it</a></li>
</ul></li>
<li><a href="#enhanced-ecommerce">Enhanced Ecommerce</a>
<ul>
<li><a href="#44-use-data-layer-option-uses-version-1-of-the-data-layer-variable">44. Use Data Layer option uses Version 1 of the Data Layer Variable</a></li>
<li><a href="#45-requires-data-layer-object-to-be-syntactically-flawless">45. Requires Data Layer object to be syntactically flawless</a></li>
<li><a href="#46-the-currency-type-is-just-a-string-with-a-monetary-value">46. The Currency type is just a string with a monetary value</a></li>
<li><a href="#47-product-scoped-custom-dimensions-and-metrics-need-to-be-formatted-correctly">47. Product-scoped Custom Dimensions and Metrics need to be formatted correctly</a></li>
<li><a href="#48-custom-javascript-variable-method-is-more-flexible-than-use-data-layer">48. Custom JavaScript variable method is more flexible than Use Data Layer</a></li>
</ul></li>
<li><a href="#triggers">Triggers</a>
<ul>
<li><a href="#49-variables-can-only-be-used-to-check-against">49. Variables can only be used to check against</a></li>
<li><a href="#50-use-a-custom-javascript-variable-to-check-for-dynamic-values">50. Use a Custom JavaScript variable to check for dynamic values</a></li>
<li><a href="#51-event-is-implicit-in-all-but-the-custom-event-trigger">51. <code>'event'</code> is implicit in all but the Custom Event trigger</a></li>
<li><a href="#52-multiple-trigger-conditions-are-and-multiple-triggers-are-or">52. Multiple trigger conditions are AND, multiple triggers are OR</a></li>
<li><a href="#53-use-regular-expressions-or-custom-javascript-variables-to-add-optionality-in-a-single-trigger">53. Use regular expressions or Custom JavaScript variables to add optionality in a single trigger</a></li>
</ul></li>
<li><a href="#auto-event-trigger">Auto-event trigger</a>
<ul>
<li><a href="#54-just-links-listens-to-clicks-on-a-elements-and-their-descendants">54. Just Links listens to clicks on <code>&lt;a&gt;</code> elements and their descendants</a></li>
<li><a href="#55-all-elements-listens-to-all-clicks">55. All Elements listens to all clicks</a></li>
<li><a href="#56-form-listens-to-a-submit-event-dispatched-by-a-form-element">56. Form listens to a <code>submit</code> event dispatched by a <code>&lt;form&gt;</code> element</a></li>
<li><a href="#57-history-change-listens-to-interactions-with-the-browser-history-api">57. History Change listens to interactions with the browser history API</a></li>
<li><a href="#58-error-listens-to-uncaught-javascript-exceptions">58. Error listens to uncaught JavaScript exceptions</a></li>
<li><a href="#59-all-triggers-but-the-click-all-elements-trigger-require-that-the-original-event-bubble-up">59. All triggers but the Click / All Elements trigger require that the original event bubble up</a></li>
<li><a href="#60-check-validation-checks-for-event-preventdefault">60. Check Validation checks for <code>event.preventDefault()</code></a></li>
<li><a href="#61-wait-for-tags-pauses-the-original-event-but-be-careful">61. Wait for Tags pauses the original event, but be careful</a></li>
<li><a href="#62-enable-this-trigger-when-vs-this-trigger-fires-on">62. Enable this trigger when&hellip; vs. This trigger fires on&hellip;</a></li>
<li><a href="#63-data-layer-object-composition-of-an-auto-event">63. Data Layer object composition of an auto-event</a></li>
<li><a href="#64-auto-event-variable">64. Auto-event variable</a></li>
<li><a href="#65-matches-css-selector-with-the-click-form-element-built-in-variable">65. Matches CSS selector with the Click / Form Element built-in variable</a></li>
</ul></li>
<li><a href="#custom-html-tags">Custom HTML tags</a>
<ul>
<li><a href="#66-code-is-automatically-minified">66. Code is automatically minified</a></li>
<li><a href="#67-code-is-injected-to-the-end-of-body">67. Code is injected to the end of <code>&lt;body&gt;</code></a></li>
<li><a href="#68-can-be-used-to-add-any-html-elements">68. Can be used to add any HTML elements</a></li>
<li><a href="#69-the-document-write-option-is-fixed-to-prevent-the-site-from-breaking">69. The <code>document.write</code> option is fixed to prevent the site from breaking</a></li>
<li><a href="#70-variables-are-automatically-renamed-in-custom-html-tags-too">70. Variables are automatically renamed in Custom HTML tags, too</a></li>
</ul></li>
<li><a href="#built-in-variables">Built-in variables</a>
<ul>
<li><a href="#71-need-to-be-enabled">71. Need to be enabled</a></li>
<li><a href="#72-click-and-form-variables-are-copies-of-each-other">72. Click and Form variables are copies of each other</a></li>
</ul></li>
<li><a href="#custom-javascript-variables">Custom JavaScript variables</a>
<ul>
<li><a href="#73-must-be-anonymous-functions">73. Must be anonymous functions</a></li>
<li><a href="#74-must-have-a-return-statement">74. Must have a <code>return</code> statement</a></li>
<li><a href="#75-can-be-used-to-return-another-function">75. Can be used to return another function</a></li>
<li><a href="#76-should-avoid-side-effects">76. Should avoid side effects</a></li>
<li><a href="#77-can-refer-to-other-variables">77. Can refer to other variables</a></li>
</ul></li>
<li><a href="#tag-sequencing">Tag sequencing</a>
<ul>
<li><a href="#78-setup-and-cleanup-are-fired-with-the-main-tag-regardless-of-their-own-triggers">78. Setup and cleanup are fired with the main tag, regardless of their own triggers</a></li>
<li><a href="#79-use-onhtmlsuccess-and-onhtmlfailure-to-signal-that-the-sequence-can-continue">79. Use <code>onHtmlSuccess()</code> and <code>onHtmlFailure()</code> to signal that the sequence can continue</a></li>
<li><a href="#80-use-datalayer-set-to-change-data-layer-variable-values-mid-sequence">80. Use <code>dataLayer.set()</code> to change Data Layer variable values mid-sequence</a></li>
</ul></li>
<li><a href="#tag-settings">Tag settings</a>
<ul>
<li><a href="#81-once-per-page-is-once-per-page-load-once-per-event-is-once-per-gtm-event">81. Once per page is once per page load, once per event is once per GTM event</a></li>
<li><a href="#82-tag-priority-is-for-a-single-gtm-event-doesn-t-necessarily-mean-tags-are-completed-in-the-given-order">82. Tag priority is for a single GTM event - doesn&rsquo;t necessarily mean tags are completed in the given order</a></li>
</ul></li>
<li><a href="#workspaces">Workspaces</a>
<ul>
<li><a href="#83-you-will-always-have-at-least-one-workspace">83. You will always have at least one workspace</a></li>
<li><a href="#84-when-you-create-a-version-out-of-a-workspace-that-workspace-is-deleted">84. When you create a version out of a workspace, that workspace is deleted</a></li>
<li><a href="#85-you-don-t-have-to-update-your-workspace-until-you-are-ready-to-create-a-version">85. You don&rsquo;t have to update your workspace until you are ready to create a version</a></li>
</ul></li>
<li><a href="#amp-container">AMP container</a>
<ul>
<li><a href="#86-no-custom-javascript-or-custom-html">86. No Custom JavaScript or Custom HTML</a></li>
<li><a href="#87-amp-is-very-restricting">87. AMP is very restricting</a></li>
<li><a href="#88-client-id-is-currently-ambiguous">88. Client ID is (currently) ambiguous</a></li>
<li><a href="#89-new-triggers-e-g-scroll">89. New triggers, e.g. scroll</a></li>
<li><a href="#90-can-be-augmented-with-the-on-page-json-configuration">90. Can be augmented with the on-page JSON configuration</a></li>
</ul></li>
<li><a href="#gtm-for-mobile">GTM for mobile</a>
<ul>
<li><a href="#91-not-the-same-as-gtm-for-web">91. Not the same as GTM for web</a></li>
<li><a href="#92-an-sdk-you-need-to-download-and-add-to-the-project">92. An SDK you need to download and add to the project</a></li>
<li><a href="#93-ga-tracker-object-is-not-exposed">93. GA tracker object is not exposed</a></li>
<li><a href="#94-gtm-legacy-uses-datalayer">94. GTM legacy uses <code>dataLayer</code></a></li>
<li><a href="#95-latest-version-of-gtm-for-mobile-uses-firebase">95. Latest version of GTM for mobile uses Firebase</a></li>
<li><a href="#96-you-can-intercept-firebase-events-using-gtm">96. You can intercept Firebase events using GTM</a></li>
<li><a href="#97-firebase-gtm-has-imperfect-support-for-ga-enhanced-ecommerce">97. Firebase GTM has (imperfect) support for GA Enhanced Ecommerce</a></li>
</ul></li>
<li><a href="#other-stuff">Other stuff</a>
<ul>
<li><a href="#98-debugging-is-a-complex-process">98. Debugging is a complex process</a></li>
<li><a href="#99-load-sequence-of-gtm-s-default-events-is-important-to-understand">99. Load sequence of GTM&rsquo;s default events is important to understand</a></li>
<li><a href="#100-some-ad-and-content-blockers-block-gtm-from-loading">100. Some ad and content blockers block GTM from loading</a></li>
<li><a href="#101-use-undefined-to-clear-individual-keys-from-data-layer-upepo-mwindaji">101. Use <code>undefined</code> to clear individual keys from Data Layer (upepo mwindaji)</a></li>
<li><a href="#102-you-can-track-to-multiple-universal-analytics-properties-in-the-same-container">102. You can track to multiple Universal Analytics properties in the same container</a></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>

<h2 id="container-javascript-snippet">Container JavaScript Snippet</h2>

<h3 id="1-initializes-the-datalayer">1. Initializes the <code>dataLayer</code></h3>

<p>The JavaScript snippet part of the GTM container has one very important function (among others). It initializes the <code>window.dataLayer</code> array. Thus, if you haven&rsquo;t initialized a <code>dataLayer</code> object yourself, the container snippet will do this for you. This ensures that <code>dataLayer.push()</code> works within GTM.</p>

<h3 id="2-creates-the-script-loader-for-the-gtm-library">2. Creates the script loader for the GTM library</h3>

<p>Perhaps even more importantly, the JavaScript container snippet creates a <code>&lt;script&gt;</code> element, which loads the Google Tag Manager container library for your GTM container ID from Google&rsquo;s servers.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/script-loader.jpg" title="GTM container script loader">
  
    <img class="fig-img lazy" data-src="/images/2017/02/script-loader.jpg#ZgotmplZ" alt="GTM container script loader">
  
    </a>
  
  
</div>



<h3 id="3-javascript-snippet-should-be-in-head-but-can-be-almost-anywhere">3. JavaScript snippet should be in <code>&lt;head&gt;</code> but can be (almost) anywhere</h3>

<p>The latest (and best) <em>recommendation</em> for placing the JavaScript snippet is to put it in the <code>&lt;head&gt;</code> of the document. This helps GTM load as early as possible, resulting in greater tracking accuracy. However, you can execute the JavaScript snippet pretty much any time during the page load and anywhere in your site code where execution of JavaScript is possible. The sooner the library loads, though, the more accurate your data collection will be.</p>

<h3 id="4-pushes-the-initial-event-gtm-js">4. Pushes the initial <code>event: 'gtm.js'</code></h3>

<p>The JavaScript snippet also pushes the initial <code>event: 'gtm.js'</code> into <code>dataLayer</code>. This is an important GTM event. It is used by the All Pages and Page View triggers. Any Data Layer variables you want to use with these triggers must be added to <code>dataLayer</code> <em>before the JavaScript container snippet is executed</em>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/gtm-js-pushed.jpg" title="event: gtm.js pushed">
  
    <img class="fig-img lazy" data-src="/images/2017/02/gtm-js-pushed.jpg#ZgotmplZ" alt="event: gtm.js pushed">
  
    </a>
  
  
</div>



<h3 id="5-multiple-container-snippets-on-a-page-are-supported">5. Multiple container snippets on a page are supported</h3>

<p>You can add multiple JavaScript container snippets on a page. This is <a href="https://developers.google.com/tag-manager/devguide?hl=en#multiple-containers">officially supported</a>. The caveat is that they all need to use the same <code>dataLayer</code> name.</p>

<hr />

<h2 id="container-noscript-snippet">Container <code>&lt;noscript&gt;</code> snippet</h2>

<h3 id="6-the-noscript-block-should-be-at-the-very-beginning-of-body">6. The <code>&lt;noscript&gt;</code> block should be at the very beginning of <code>&lt;body&gt;</code></h3>

<p>At the time of writing, the <code>&lt;noscript&gt;</code> block should be added to the very beginning of <code>&lt;body&gt;</code>. This is the only way that <a href="https://support.google.com/webmasters/answer/35179?hl=en">Search Console Verification</a> using the Google Tag Manager method will work. Naturally, if you don&rsquo;t care about verifying the site using the GTM method, nor do you have any use for tracking non-JavaScript visits, you can leave the <code>&lt;noscript&gt;</code> block out altogether. Just don&rsquo;t place it in <code>&lt;head&gt;</code> as that would result in HTML validation issues.</p>

<h3 id="7-only-executed-by-browsers-with-javascript-disabled">7. Only executed by browsers with JavaScript disabled</h3>

<p>The <code>&lt;noscript&gt;</code> snippet is only executed by browsers with JavaScript disabled. If you want to test it, you can disable JavaScript using your browser&rsquo;s developer tools (e.g. <a href="http://stackoverflow.com/a/13405409">Chrome</a>).</p>

<h3 id="8-loads-an-html-page-in-an-iframe">8. Loads an HTML page in an <code>&lt;iframe&gt;</code></h3>

<p>The block loads an <code>&lt;iframe&gt;</code> element, which fetches its data as an HTML file from Google Tag Manager&rsquo;s servers. In essence, this HTML file is your container. The HTML will contain the image elements you have configured to fire for JavaScript-disabled visitors.</p>

<h3 id="9-only-the-page-view-trigger-works">9. Only the Page View trigger works</h3>

<p>Because the JavaScript-less GTM can&rsquo;t run JavaScript (d&rsquo;oh), only the Page View trigger is at your disposal. Thus, there&rsquo;s no dynamic triggers, and no way to wait for the page to load or anything like that. The Page View trigger is fired when the <code>&lt;iframe&gt;</code> contents are fetched.</p>

<h3 id="10-use-a-function-return-true-custom-javascript-variable-in-the-trigger">10. Use a <code>function() { return true; }</code> Custom JavaScript variable in the trigger</h3>

<p>A very handy way to fire tags only when executed in the <code>&lt;iframe&gt;</code> is to create a Custom JavaScript Variable with the following content:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
}
</code></pre></div>

<p>This variable will only return <code>true</code> if the browser executes it, i.e. executes JavaScript. By adding <strong>{{Variable}} does not equal true</strong> as a trigger condition fires the trigger only in browsers where JavaScript is disabled.</p>

<h3 id="11-only-the-custom-image-tag-is-useful">11. Only the Custom Image tag is useful</h3>

<p>Since the JavaScript-less container can&rsquo;t execute JavaScript, you are left with just the Custom Image tag. In other words, you can create image elements that are added directly into the container HTML. These image elements will then be rendered by the browser. In fact, you can even do some basic Google Analytics tracking using an image tag, since GA requests are basically image pixels. See <a href="https://www.bounteous.com/insights/2015/03/23/gtm-iframe-no-javascript/">this LunaMetric guide</a> for inspiration.</p>

<h3 id="12-can-utilize-data-layer-parameters-via-query-parameters">12. Can utilize &ldquo;Data Layer&rdquo; parameters via query parameters</h3>

<p>You can feed &ldquo;Data Layer&rdquo; values to the container HTML using query parameters in the <code>&lt;iframe&gt;</code> src attribute value. The query parameters need to be added as key-value pairs, and the keys that you add can then be used in Data Layer variables. For further details, see the Bounteous guide linked to in the previous paragraph, or check the <a href="https://www.simoahava.com/analytics/track-non-javascript-visits-google-analytics/">guide I&rsquo;ve written</a>.</p>

<hr />

<h2 id="the-datalayer-structure">The <code>dataLayer</code> structure</h2>

<h3 id="13-global-javascript-array">13. Global JavaScript array</h3>

<p>The <code>dataLayer</code> structure is a global JavaScript array, and can thus be accessed in any site code that can also access the <code>window</code> object. It&rsquo;s a good idea to always prefix the <code>dataLayer</code> name with <code>window.</code> to avoid conflicts with any locally scoped structures that use the same name.</p>

<h3 id="14-you-can-use-a-different-name-than-datalayer">14. You can use a different name than <code>dataLayer</code></h3>

<p>You can change the name of this global structure in the JavaScript container snippet. Just remember to always use this new name when adding messages to <code>dataLayer</code>!</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/rename-datalayer.jpg" title="Rename dataLayer">
  
    <img class="fig-img lazy" data-src="/images/2017/02/rename-datalayer.jpg#ZgotmplZ" alt="Rename dataLayer">
  
    </a>
  
  
</div>



<h3 id="15-only-the-push-method-works-with-gtm">15. Only the <code>.push()</code> method works with GTM</h3>

<p>Google Tag Manager only reacts to the <code>.push()</code> method. You can <code>.splice()</code>, <code>.slice()</code>, <code>.shift()</code> and <code>.pop()</code> all you like. GTM only listens for <code>.push()</code> commands.</p>

<h3 id="16-typically-only-plain-objects-work-with-gtm">16. Typically only plain objects work with GTM</h3>

<p>The most common way to feed data to Google Tag Manager is using plain objects. Each object contains one or more key-value pairs. These key-value pairs are then translated into Data Layer variables, which you can create in Google Tag Manager to fetch values from the Data Layer.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">plainObject</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">someKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;someValue&#39;</span>,
  <span style="color:#a6e22e">someOtherKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;someOtherValue&#39;</span>
};
window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">plainObject</span>);
</code></pre></div>

<h3 id="17-you-can-use-any-javascript-type-as-a-value-of-a-key">17. You can use any JavaScript type as a value of a key</h3>

<p>All JavaScript types are supported as values when you push your <code>dataLayer</code> messages. When you create a Data Layer variable in GTM, it will contain a reference to whatever the value of the key is, regardless of type.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
  <span style="color:#a6e22e">type_number</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>,
  <span style="color:#a6e22e">type_string</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hello&#39;</span>,
  <span style="color:#a6e22e">type_object</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">someKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;someValue&#39;</span> },
  <span style="color:#a6e22e">type_array</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>],
  <span style="color:#a6e22e">type_function</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;hello&#39;</span><span style="color:#f92672">!</span>; },
  <span style="color:#a6e22e">type_boolean</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
});
</code></pre></div>

<h3 id="18-only-event-key-can-trigger-tags">18. Only <code>event</code> key can trigger tags</h3>

<p>Only a message with an <code>event: 'someValue'</code> key-value pair can trigger tags. Any object without an <code>'event'</code> key is treated as just a &ldquo;message&rdquo;, and has no triggering power of its own.</p>

<h3 id="19-you-can-also-push-a-command-array">19. You can also <code>.push()</code> a command array</h3>

<p>There&rsquo;s a special <em>command array</em> you can <code>.push()</code> into <code>dataLayer</code> if you want to execute methods for values already in the data model. So technically it&rsquo;s not just plain objects that <code>dataLayer</code> digests. There&rsquo;s more about this in tip #26.</p>

<h3 id="20-never-overwrite-always-push">20. Never overwrite, always <code>.push()</code></h3>

<p>I usually hate to dole out best practices, so consider this a fact of life instead. Never, ever, ever, ever use this syntax:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">=</span> [{...}];
</code></pre></div>

<p>It&rsquo;s destructive. If this command is executed after the GTM container snippet or after you&rsquo;ve already established a <code>dataLayer</code> object, you will end up overwriting the existing object with this newly initialized structure. Worst-case scenario (surprisingly common) is that you&rsquo;ll end up breaking GTM, since you also overwrite the custom <code>.push()</code> listener added by the container library.</p>

<p>Prefer this syntax instead:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">||</span> [];
window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({...});
</code></pre></div>

<h3 id="21-the-array-is-capped-at-300">21. The array is capped at 300</h3>

<p>This is perhaps more obscure, but in addition to adding a <code>.push()</code> listener, the GTM container library also caps the length of the <code>dataLayer</code> structure at 300. This means that when you <code>.push()</code> the 301st item into <code>dataLayer</code>, the <em>first/oldest</em> item in <code>dataLayer</code> is removed. As you will learn in the next section, this has no impact on GTM&rsquo;s data model. It just caps the <code>dataLayer</code> structure itself.</p>

<hr />

<h2 id="gtm-s-data-model">GTM&rsquo;s data model</h2>

<h3 id="22-copies-messages-queued-via-datalayer-push">22. Copies messages queued via <code>dataLayer.push()</code></h3>

<p>When you use the Data Layer Variable, Google Tag Manager doesn&rsquo;t fetch the value from the <code>dataLayer</code> array. Instead, it polls its own <a href="https://www.simoahava.com/analytics/google-tag-manager-data-model/">internal data model</a> to see if any value has been pushed to the given key (or variable name). If a value is found, GTM returns it. This means that GTM&rsquo;s internal data model has access to the <strong>most recently pushed value for any given key</strong>.</p>

<h3 id="23-gtm-freezes-variable-values-when-a-trigger-fires">23. GTM freezes variable values when a trigger fires</h3>

<p>Triggers only fire when the key <code>'event'</code> is pushed into <code>dataLayer</code>. When this happens, GTM &ldquo;freezes&rdquo; the state of the container, and any tags that fire on this trigger will only have access to the current state of the internal data model. Thus, if you want to push values into <code>dataLayer</code> so that they become available to a tag that triggers on the site, these values need to be pushed before or in the same object as the <code>'event'</code> that triggers the tag.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/trigger-order.jpg" title="Order of dataLayer.pushes for triggers">
  
    <img class="fig-img lazy" data-src="/images/2017/02/trigger-order.jpg#ZgotmplZ" alt="Order of dataLayer.pushes for triggers">
  
    </a>
  
  
</div>



<h3 id="24-objects-are-recursively-merged">24. Objects are recursively merged</h3>

<p>Recursive merge is one of the more complex concepts to understand. When you work with primitive values (strings, numbers, booleans, for example), the internal data model of GTM only has access to whatever was most recently pushed into a key whose value is one of these primitive types. However, when you work with structured objects and arrays, it&rsquo;s more complicated.</p>

<p>When you push an object into <code>dataLayer</code>, GTM goes through each key in this object, and only overwrites those that have shared keys and primitive values (or where the type changes). New keys are simply added to the existing object value.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/recursive-merge.jpg" title="Recursive merge">
  
    <img class="fig-img lazy" data-src="/images/2017/02/recursive-merge.jpg#ZgotmplZ" alt="Recursive merge">
  
    </a>
  
  
</div>



<p>When pushing an object to a key that already contains an object with the same keys, only the keys that have primitive values or a different type are overwritten. All others are simply updated.</p>

<h3 id="25-arrays-are-recursively-merged">25. Arrays are recursively merged</h3>

<p>In JavaScript, arrays are structured objects, too, where the keys are index numbers that start from 0. So when you push an array into a key that already had an array, these two arrays are recursively merged starting from index 0, and any indices that are not modified remain the same.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/array-merge.jpg" title="Array recursive merge">
  
    <img class="fig-img lazy" data-src="/images/2017/02/array-merge.jpg#ZgotmplZ" alt="Array recursive merge">
  
    </a>
  
  
</div>



<h3 id="26-you-can-run-javascript-methods-on-existing-data-layer-values-with-a-command-array">26. You can run JavaScript methods on existing Data Layer values with a command array</h3>

<p>What if you already have an array in a key, but instead of merging or overwriting you want to add values to it, i.e. push items to the end of the array? You can use a special <em>command array</em> that you push into <code>dataLayer</code>. The first element in the array is a string that contains the key name and the command you want to execute, and all the other items are passed as arguments to the command.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/command-array.jpg" title="Command array">
  
    <img class="fig-img lazy" data-src="/images/2017/02/command-array.jpg#ZgotmplZ" alt="Command array">
  
    </a>
  
  
</div>



<h3 id="27-version-1-vs-version-2-of-the-data-layer-variable">27. Version 1 vs. Version 2 of the Data Layer Variable</h3>

<p>You&rsquo;ve probably noticed that you can <a href="https://www.simoahava.com/gtm-tips/data-layer-variable-versions-explained/">choose a <strong>version</strong> when using the Data Layer Variable</a>. There are some very important differences between the two.</p>

<p><strong>Version 2</strong> supports deep structures with dot notation. If you want to access array indices, you need to use dot notation too (<code>products.0.name</code> rather than <code>products[0].name</code>). Only Version 2 supports recursive merge.</p>

<p><strong>Version 1</strong> does not support dot notation, and it only fetches the most recently pushed value whether it&rsquo;s an object or not. Thus there&rsquo;s no recursive merge - what you push is what you get.</p>

<h3 id="28-google-tag-manager-gtm-xxxx-datalayer-methods">28. <code>google_tag_manager['GTM-XXXX'].dataLayer</code> methods</h3>

<p>If you want to access values stored in Google Tag Manager&rsquo;s data model from outside GTM or without using a Data Layer Variable, you can use the <code>google_tag_manager</code> interface.</p>

<p><code>google_tag_manager['GTM-XXXX'].dataLayer.get('keyName')</code> fetches the value stored in GTM&rsquo;s data model for variable name <strong>keyName</strong>.</p>

<p><code>google_tag_manager['GTM-XXXX'].dataLayer.set('keyName', 'someValue')</code> sets the value of <strong>keyName</strong> to <strong>someValue</strong> in GTM&rsquo;s data model. This is the equivalent to using <code>dataLayer.push({keyName: 'someValue'});</code></p>

<p><code>google_tag_manager['GTM-XXXX'].dataLayer.reset()</code> purges GTM&rsquo;s data model, removing all stored keys.</p>

<hr />

<h2 id="preview-mode">Preview mode</h2>

<h3 id="29-preview-mode-works-with-a-cookie-on-www-googletagmanager-com-in-the-preview-browser">29. Preview mode works with a cookie on www.googletagmanager.com in the preview browser</h3>

<p>When you enter GTM&rsquo;s Preview Mode, you are transported through the domain www.googletagmanager.com (the same domain that serves the gtm.js library), during which a cookie is written in your browser for that domain.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/preview-cookie.jpg" title="Preview mode cookie">
  
    <img class="fig-img lazy" data-src="/images/2017/02/preview-cookie.jpg#ZgotmplZ" alt="Preview mode cookie">
  
    </a>
  
  
</div>



<p>When you then visit your website, the request for the gtm.js library identifies that you have the Preview mode cookie written on www.googletagmanager.com, and the preview container library is returned instead. So what you&rsquo;re basically dealing with is a third-party cookie, even though the cookie isn&rsquo;t set while browsing the site itself.</p>

<h3 id="30-shows-the-state-of-tags-triggers-variables-and-data-layer-at-each-data-layer-message">30. Shows the state of tags, triggers, variables, and Data Layer at each Data Layer message</h3>

<p>Preview mode is a great way to understand how Google Tag Manager works. The navigation in the left column is a chronological (oldest at the bottom) list of messages that have been pushed into <code>dataLayer</code>. By selecting a message, you can see if any tags fired during that message, and you can see the state of tags, variables, and triggers at the time of the message.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/messages-state.jpg" title="Messages and state of data layer">
  
    <img class="fig-img lazy" data-src="/images/2017/02/messages-state.jpg#ZgotmplZ" alt="Messages and state of data layer">
  
    </a>
  
  
</div>



<p>What you see is what you get. If the variable does not have a value at the time of the message, it means that any tags that fire for that message will not have access to any value if using that variable. This is why it&rsquo;s important to understand that <strong>if you want to use a variable, it must have a value when the message that triggers the tag is pushed into <code>dataLayer</code></strong>.</p>

<h3 id="31-summary-shows-the-state-at-the-latest-message">31. Summary shows the state at the latest message</h3>

<p><strong>Summary</strong> is not a message itself. It&rsquo;s a recap of what the state of the container is after the latest message has fired. Note that if you have Summary (or any other message, for that matter) selected, and you select a tag that fired in an earlier message, the tag might have different values than what you&rsquo;d expect. That&rsquo;s because when you select a message (or Summary), the variables reflect what their values are <strong>at the time of the selected message</strong>. This way tags can show different values from those that were actually used.</p>

<p>That&rsquo;s why it&rsquo;s really important to start debugging by selecting the message that fired the tag. Any other message and you might see confusing data.</p>

<h3 id="32-variables-are-resolved-multiple-times-at-least-once-per-message">32. Variables are resolved multiple times - at least once per message</h3>

<p>If you&rsquo;ve ever created a variable with side effects and then gone to preview mode, you might have been surprised at what happens. For example, create a Custom JavaScript Variable with this:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  window.<span style="color:#a6e22e">_testCount</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">_testCount</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">return</span> window.<span style="color:#a6e22e">alert</span>(window.<span style="color:#a6e22e">_testCount</span><span style="color:#f92672">++</span>);
}
</code></pre></div>

<p>Now when you go to Preview mode, you&rsquo;ll see a bunch of alerts with a number that increments with each alert. Depending on how many messages are pushed into dataLayer and how many tags use this variable, you might see a huge number in the last alert box.</p>

<p>This is because GTM <strong>resolves variables in Preview mode multiple times</strong>. Preview mode needs to resolve the variables <em>at least</em> once per message pushed into dataLayer. Why? Because Preview mode must be able to tell you the value of each variable in each tag, trigger, variable, and message.</p>

<p>In a live container, variables won&rsquo;t be resolve this many times. Most likely they are only resolved when they are directly invoked, e.g. in triggers and tags upon injection.</p>

<h3 id="33-preview-can-be-minimized">33. Preview can be minimized</h3>

<p>The Preview mode panel can be visually obstructive, so it&rsquo;s a good thing the developers added a minimize button some time ago:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/minimize-preview.jpg" title="Minimize GTM preview">
  
    <img class="fig-img lazy" data-src="/images/2017/02/minimize-preview.jpg#ZgotmplZ" alt="Minimize GTM preview">
  
    </a>
  
  
</div>



<p>After clicking it, you can bring the panel back up by clicking the small <strong>DEBUG ^</strong> icon in the lower right corner of the window.</p>

<h3 id="34-to-quit-preview-you-need-to-exit-preview-mode-via-the-gtm-ui">34. To quit preview, you need to exit preview mode via the GTM UI</h3>

<p>The easiest way to quit Preview mode is to go to the Google Tag Manager user interface and click the &ldquo;Leave preview mode&rdquo; link:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/leave-preview-mode.jpg" title="Leave preview mode">
  
    <img class="fig-img lazy" data-src="/images/2017/02/leave-preview-mode.jpg#ZgotmplZ" alt="Leave preview mode">
  
    </a>
  
  
</div>



<p>You can also go to your browser&rsquo;s content settings, and delete all cookies written on the www.googletagmanager.com domain. This works with Shared Preview, too.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/remove-cookies.jpg" title="Exit preview and debug mode">
  
    <img class="fig-img lazy" data-src="/images/2017/02/remove-cookies.jpg#ZgotmplZ" alt="Exit preview and debug mode">
  
    </a>
  
  
</div>



<p>Wouldn&rsquo;t it be handy if you could just quit Preview mode from the panel itself on the site? Yes, I think so too.</p>

<h3 id="35-to-quit-a-shared-preview-you-need-to-follow-the-original-link">35. To quit a shared preview, you need to follow the original link</h3>

<p>If you want to quit Preview mode that has been shared with you, you should follow the original Share Preview link and click &ldquo;Exit preview and debug mode&rdquo;.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/exit-preview-debug.jpg" title="Exit preview and debug mode">
  
    <img class="fig-img lazy" data-src="/images/2017/02/exit-preview-debug.jpg#ZgotmplZ" alt="Exit preview and debug mode">
  
    </a>
  
  
</div>



<p>Note that you can also delete the cookies as described in the previous tip.</p>

<h3 id="36-problems-with-the-preview-mode-not-showing-correctly-are-most-typically-due-to-css-conflicts">36. Problems with the preview mode not showing correctly are most typically due to CSS conflicts</h3>

<p>Sometimes you might not see a Preview mode on a website at all. Other times the panel might be buggy, such as being partly transparent or completely white.</p>

<p>In these cases, it&rsquo;s most often a CSS conflict with the site code. GTM loads the panel on the website itself, so style conflicts can arise if they share the same namespace.</p>

<p>If this happens, your best bet is to contact the developer team via the Send Feedback link in the UI, or by posting the issue in the <a href="https://productforums.google.com/forum/#!forum/tag-manager">Product Forums</a>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/send-feedback.jpg" title="Send feedback link">
  
    <img class="fig-img lazy" data-src="/images/2017/02/send-feedback.jpg#ZgotmplZ" alt="Send feedback link">
  
    </a>
  
  
</div>



<h3 id="37-you-can-also-preview-without-the-debug-panel">37. You can also preview without the debug panel</h3>

<p>Note that you can also preview a container on the site without the benefit of the debug panel. Why you&rsquo;d want to do this when you can minimize the debug panel escapes me, but to do so you need to click the Share Preview link in the GTM UI, uncheck &ldquo;Turn on debugging when previewing&rdquo;, and then follow the link in your browser. This sets your browser into Preview mode without showing the debug panel.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/turn-off-debugging.jpg" title="Turn off debugging">
  
    <img class="fig-img lazy" data-src="/images/2017/02/turn-off-debugging.jpg#ZgotmplZ" alt="Turn off debugging">
  
    </a>
  
  
</div>



<h3 id="38-preview-must-be-refreshed-after-every-change">38. Preview must be refreshed after every change</h3>

<p>GTM doesn&rsquo;t auto-refresh the Preview mode when you save changes in your container. You need to click the &ldquo;Refresh&rdquo; link to update the preview mode for yourself and anyone with the preview link.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/refresh-preview.jpg" title="Refresh preview link">
  
    <img class="fig-img lazy" data-src="/images/2017/02/refresh-preview.jpg#ZgotmplZ" alt="Refresh preview link">
  
    </a>
  
  
</div>



<hr />

<h2 id="universal-analytics">Universal Analytics</h2>

<h3 id="39-gtm-creates-a-new-tracker-with-every-tag-instance">39. GTM creates a new tracker with every tag instance</h3>

<p>Unlike on-page Universal Analytics (analytics.js), Google Tag Manager creates a new, unique tracker object with every single tag that fires, even if they use the same template.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/multiple-trackers.jpg" title="Multiple trackers">
  
    <img class="fig-img lazy" data-src="/images/2017/02/multiple-trackers.jpg#ZgotmplZ" alt="Multiple trackers">
  
    </a>
  
  
</div>



<p>This might not be the most elegant technical design ever, but it&rsquo;s necessary in how GTM structures Universal Analytics tags. Basically each tag is its own sandbox, and settings are not shared from tag to tag.</p>

<h3 id="40-settings-are-not-shared-across-tags">40. Settings are not shared across tags</h3>

<p>Because each tag has a unique tracker, no settings are shared from tag to tag. This is very much unlike on-page Universal Analytics, where you create a single tracker and then invoke that tracker in commands like <code>ga('trackerName.send', 'pageview');</code>.</p>

<p>If you want to share settings of a single tag with other tags, currently you need to set the <strong>Tracker Name</strong> field in the tag settings. But before you do, read the next tip.</p>

<h3 id="41-you-can-set-a-tracker-name-but-most-often-this-is-risky-and-unnecessary">41. You can set a tracker name, but most often this is risky and unnecessary</h3>

<p>If you do set the Tracker Name, you are likely to run into a host of problems. First of all - ALL settings are shared across the two tags. This is because GTM sets all fields and Custom Dimension / Metrics on the tracker object itself rather than just the hit. So you&rsquo;ll need to take great care to reset any fields that you don&rsquo;t want values to leak into.</p>

<p>Until GTM introduces some type of shared tag settings feature, I suggest avoiding the tracker name setting and working with GTM variables instead. If you want a setting to apply across two or more tags, just replicate the setting in each tag and use a variable to populate the same value in all the tags.</p>

<h3 id="42-use-fields-to-set-for-setting-any-analytics-js-fields">42. Use Fields to Set for setting any analytics.js fields</h3>

<p>You can use Fields to Set to set any <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference">analytics.js</a> fields. These fields are set on the tracker object itself (see previous tip), but will work as if set on the hit itself.</p>

<p>You can also add <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters">Measurement Protocol parameters</a> to Fields to Set, but this is, in most cases, unnecessary.</p>

<h3 id="43-if-a-field-has-the-variable-icon-you-can-use-variables-in-it">43. If a field has the variable icon, you can use variables in it</h3>

<p>Fields in Google Tag Manager support adding a variable if the field has the variable icon next to it.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/variable-icon.jpg" title="variable icon in fields">
  
    <img class="fig-img lazy" data-src="/images/2017/02/variable-icon.jpg#ZgotmplZ" alt="variable icon in fields">
  
    </a>
  
  
</div>



<p>By clicking the icon, a list of all available variables pops up. You can also use the auto-complete feature by typing <code>{{</code> into the field, after which an auto-complete menu shows, and you can continue typing to find the variable you&rsquo;re looking for.</p>

<hr />

<h2 id="enhanced-ecommerce">Enhanced Ecommerce</h2>

<h3 id="44-use-data-layer-option-uses-version-1-of-the-data-layer-variable">44. Use Data Layer option uses Version 1 of the Data Layer Variable</h3>

<p>When you select the <strong>Use Data Layer</strong> option in your Enhanced Ecommerce enabled Universal Analytics tags, GTM uses the Version 1 of the Data Layer Variable to locate the most recently pushed <code>ecommerce</code> key from the Data Layer.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/use-data-layer.jpg" title="Use Data Layer">
  
    <img class="fig-img lazy" data-src="/images/2017/02/use-data-layer.jpg#ZgotmplZ" alt="Use Data Layer">
  
    </a>
  
  
</div>



<p>Read that again. GTM only has access to the <strong>most recently pushed</strong> Enhanced Ecommerce payload in <code>dataLayer</code>. This means that if you first push impressions, for example, but don&rsquo;t fire a tag, and then you push a Product Detail View which does fire a tag, that tag will only access the Product Detail View data. The impressions data is lost in cyberspace, due to no tag firing when it was pushed to <code>dataLayer</code>. To avert this, either make sure you always add an <code>event</code> to all your Enhanced Ecommerce pushes, and always use a Custom Event Trigger to fire an Enhanced Ecommerce enable tag.</p>

<p>Alternatively, you can use the far more flexible Custom JavaScript variable method.</p>

<h3 id="45-requires-data-layer-object-to-be-syntactically-flawless">45. Requires Data Layer object to be syntactically flawless</h3>

<p>Enhanced Ecommerce is a bit different from how Data Layer typically works. Generally, you can push any key-value pairs into Data Layer, because you can always transform and mutate them in the GTM UI later on. However, when working with Enhanced Ecommerce, either via &ldquo;Use Data Layer&rdquo; or the Custom JavaScript Variable method, the payload must be syntactically accurate. It <strong>must</strong> have all the required keys, it <strong>must</strong> be structured correctly, and it <strong>must</strong> obey certain limitations to the structure (<a href="https://www.simoahava.com/analytics/enhanced-ecommerce-tips-and-learnings/">more details about structure</a>).</p>

<p>You should always make sure you&rsquo;re following the official <a href="https://developers.google.com/tag-manager/enhanced-ecommerce">developer guide</a> to the letter.</p>

<h3 id="46-the-currency-type-is-just-a-string-with-a-monetary-value">46. The Currency type is just a string with a monetary value</h3>

<p>If you read the official <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/enhanced-ecommerce">Enhanced Ecommerce developer guide</a>, you might have noticed references to a type called &ldquo;currency&rdquo;.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/currency-type.jpg" title="Currency data type">
  
    <img class="fig-img lazy" data-src="/images/2017/02/currency-type.jpg#ZgotmplZ" alt="Currency data type">
  
    </a>
  
  
</div>



<p>Well, there&rsquo;s no such data type in JavaScript. What the guide means is a string that has a monetary value (without currency symbol). Don&rsquo;t use a thousand separator (e.g. &ldquo;1 045.99&rdquo;), and use the period as the decimal character.</p>

<p>A valid &ldquo;currency&rdquo; type would be <code>&quot;1045.99&quot;</code>. Invalid types would be <code>&quot;1 045.99&quot;</code> and <code>&quot;1045,99&quot;</code>. Due to loose typing in JavaScript, you could just as well pass it as a number <code>1045.99</code>, but that will definitely lead to problems if the number is incorrectly formatted.</p>

<h3 id="47-product-scoped-custom-dimensions-and-metrics-need-to-be-formatted-correctly">47. Product-scoped Custom Dimensions and Metrics need to be formatted correctly</h3>

<p><a href="https://www.simoahava.com/gtm-tips/product-scoped-custom-dimensions-and-metrics/">Product-scoped Custom Dimensions and Metrics</a> need to be formatted in a certain way to work. With regular Custom Dimensions and Metrics, all you need to do is add them to the tags under the respective tag settings.</p>

<p>However, in Enhanced Ecommerce, all the information must be in the payload. With Product-scoped Custom Dimensions and Metrics, this data must be in the <code>products</code> array, under each individual product you want to add the dimensions and metrics to. The dimensions and metrics must be named <code>dimensionX</code> and <code>metricX</code> where X is the index number for the given custom variable.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#a6e22e">ecommerce</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">purchase</span><span style="color:#f92672">:</span> {
      <span style="color:#a6e22e">actionField</span><span style="color:#f92672">:</span> {
        ...
      },
      <span style="color:#a6e22e">products</span><span style="color:#f92672">:</span> [{
        <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1&#39;</span>,
        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Shirt&#39;</span>,
        <span style="color:#a6e22e">dimension1</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Red&#39;</span>,
        <span style="color:#a6e22e">metric1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">132</span>,
        <span style="color:#a6e22e">quantity</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
        <span style="color:#a6e22e">price</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10.99&#39;</span>
      },{
        <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2&#39;</span>,
        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Pants&#39;</span>,
        <span style="color:#a6e22e">dimension1</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Black&#39;</span>,
        <span style="color:#a6e22e">dimension2</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Adidas&#39;</span>,
        <span style="color:#a6e22e">metric1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">133</span>,
        <span style="color:#a6e22e">quantity</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
        <span style="color:#a6e22e">price</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;13.99&#39;</span>
      }]
    }
  }
}
</code></pre></div>

<h3 id="48-custom-javascript-variable-method-is-more-flexible-than-use-data-layer">48. Custom JavaScript variable method is more flexible than Use Data Layer</h3>

<p>I always implement Enhanced Ecommerce using the <a href="https://www.simoahava.com/analytics/enhanced-ecommerce-with-a-custom-javascript-variable/">Custom JavaScript variable method</a>. It gives me so much more flexibility, as I can simply create the original <code>dataLayer</code> object as semantically unambiguous as possible, and then use the Custom JavaScript variable to mutate the object into the state the Enhanced Ecommerce requires. Why? Because I have plenty of other platforms that need the ecommerce data, too, and they might not be happy with the way that Google Tag Manager enforces a specific structure.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">order</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">DLV</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Order</span>}};
  <span style="color:#66d9ef">return</span> {
    <span style="color:#a6e22e">ecommerce</span><span style="color:#f92672">:</span> {
      <span style="color:#a6e22e">purchase</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">actionField</span><span style="color:#f92672">:</span> {
          <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">orderId</span>,
          <span style="color:#a6e22e">revenue</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">price</span>.<span style="color:#a6e22e">totalWithTax</span>,
          <span style="color:#a6e22e">tax</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">price</span>.<span style="color:#a6e22e">taxValue</span>,
          <span style="color:#a6e22e">affiliation</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">name</span>
        },
        <span style="color:#a6e22e">products</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">productsForGTM</span>]
      }
    }
  };
}
</code></pre></div>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/eec-custom-javascript-variable.jpg" title="Enhanced Ecommerce Custom JavaScript Variable">
  
    <img class="fig-img lazy" data-src="/images/2017/02/eec-custom-javascript-variable.jpg#ZgotmplZ" alt="Enhanced Ecommerce Custom JavaScript Variable">
  
    </a>
  
  
</div>



<p>The Custom JavaScript variable itself is simple. All you need to do is make sure it returns a valid Enhanced Ecommerce object as required by Google Tag Manager.</p>

<hr />

<h2 id="triggers">Triggers</h2>

<h3 id="49-variables-can-only-be-used-to-check-against">49. Variables can only be used to check against</h3>

<p>This is perhaps slightly oddly worded, but what I mean is that you can only use a variable as the thing in the trigger whose value you are checking. You can&rsquo;t use a variable as the condition value itself.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/variables-in-triggers.jpg" title="Variables in triggers">
  
    <img class="fig-img lazy" data-src="/images/2017/02/variables-in-triggers.jpg#ZgotmplZ" alt="Variables in triggers">
  
    </a>
  
  
</div>



<h3 id="50-use-a-custom-javascript-variable-to-check-for-dynamic-values">50. Use a Custom JavaScript variable to check for dynamic values</h3>

<p>If you DO want to check against dynamic values in your triggers, you can always use a Custom JavaScript variable. Let&rsquo;s say you want to check if the clicked URL contains the current page hostname. Why? Because you want a trigger that fires only for clicks on links that take the user away from the website. This is what the Custom JavaScript variable might look like:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">return</span> {{<span style="color:#a6e22e">Click</span> <span style="color:#a6e22e">URL</span>}}.<span style="color:#a6e22e">indexOf</span>({{<span style="color:#a6e22e">Page</span> <span style="color:#a6e22e">Hostname</span>}}) <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}
</code></pre></div>

<p>This variable returns <code>true</code> if the clicked URL contains the current page hostname, and <code>false</code> otherwise. Now you can use a trigger like this:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/dynamic-trigger-variable.jpg" title="Dynamic trigger with Custom JavaScript variable">
  
    <img class="fig-img lazy" data-src="/images/2017/02/dynamic-trigger-variable.jpg#ZgotmplZ" alt="Dynamic trigger with Custom JavaScript variable">
  
    </a>
  
  
</div>



<h3 id="51-event-is-implicit-in-all-but-the-custom-event-trigger">51. <code>'event'</code> is implicit in all but the Custom Event trigger</h3>

<p>All triggers require an <code>event</code> key in <code>dataLayer</code> to fire. Thus, when you create a trigger, they check for the value of <code>event</code>, and if there&rsquo;s a match the trigger fires. Only the Custom Event trigger requires you to explicitly state the value of <code>event</code> you want to fire against. Here are the basic trigger types and their implicit <code>event</code> values:</p>

<ul>
<li><p>DOM Ready - gtm.dom</p></li>

<li><p>Page View - gtm.js</p></li>

<li><p>Window Loaded - gtm.load</p></li>

<li><p>Click / All Elements - gtm.click</p></li>

<li><p>Click / Just Links - gtm.linkClick</p></li>

<li><p>Form submission - gtm.formSubmit</p></li>

<li><p>History Change - gtm.historyChange</p></li>

<li><p>JavaScript Error - gtm.pageError</p></li>

<li><p>Timer - gtm.timer</p></li>

<li><p>Scroll Depth - gtm.scrollDepth</p></li>

<li><p>YouTube Video - gtm.video</p></li>
</ul>

<h3 id="52-multiple-trigger-conditions-are-and-multiple-triggers-are-or">52. Multiple trigger conditions are AND, multiple triggers are OR</h3>

<p>Multiple conditions in a single trigger <strong>must ALL match</strong> for the trigger to fire. Thus a trigger like this should never work:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/multiple-conditions.jpg" title="Multiple trigger conditions">
  
    <img class="fig-img lazy" data-src="/images/2017/02/multiple-conditions.jpg#ZgotmplZ" alt="Multiple trigger conditions">
  
    </a>
  
  
</div>



<p>Why won&rsquo;t it work? Because the hostname of the current page can&rsquo;t be two things at once.</p>

<p>If you add multiple triggers to a tag, then <strong>any one of these will fire the tag</strong>. So, if you want your tag to fire when the page hostname is either www.domain.com or www.other-domain.com, you can create two triggers, one for each hostname, and add both to the tag.</p>

<h3 id="53-use-regular-expressions-or-custom-javascript-variables-to-add-optionality-in-a-single-trigger">53. Use regular expressions or Custom JavaScript variables to add optionality in a single trigger</h3>

<p>There&rsquo;s an easier way to introduce optionality, though. First, if it&rsquo;s a simple string check, you can always use <a href="http://www.regular-expressions.info/quickstart.html">regular expressions</a>.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/regex-trigger.jpg" title="Regex in triggers">
  
    <img class="fig-img lazy" data-src="/images/2017/02/regex-trigger.jpg#ZgotmplZ" alt="Regex in triggers">
  
    </a>
  
  
</div>



<p>If you have more complex logic, a Custom JavaScript variable is your best friend, again.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">hn</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Page</span> <span style="color:#a6e22e">Hostname</span>}},
      <span style="color:#a6e22e">ut</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">DLV</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">userType</span>}};
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hn</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;www.mydomain.com&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ut</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;visitor&#39;</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;visitor&#39;</span>;
  }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hn</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;www.mydomain.com&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ut</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;member&#39;</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;member&#39;</span>;
  }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hn</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;www.other-domain.com&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ut</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;loyal&#39;</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;loyal&#39;</span>;
  }
  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;other&#39;</span>;
}
</code></pre></div>

<hr />

<h2 id="auto-event-trigger">Auto-event trigger</h2>

<h3 id="54-just-links-listens-to-clicks-on-a-elements-and-their-descendants">54. Just Links listens to clicks on <code>&lt;a&gt;</code> elements and their descendants</h3>

<p>When you create a <strong>Just Links</strong> trigger, it listens to clicks on <code>&lt;a&gt;</code> elements and their descendants. When a click is registered, Google Tag Manager checks if there is a link node wrapping the clicked element, and if there is, GTM stores a reference to the link in the <code>dataLayer</code>.</p>

<p>For example, say the page HTML looks like this:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;content&#34;</span>&gt;
  &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://www.google.com/&#34;</span>&gt;
    &lt;<span style="color:#f92672">span</span>&gt;Google&lt;/<span style="color:#f92672">span</span>&gt;
  &lt;/<span style="color:#f92672">a</span>&gt;
&lt;/<span style="color:#f92672">div</span>&gt;</code></pre></div>

<p>If someone clicks on the link, the click actually falls on the <code>&lt;span&gt;</code> element, but the Just Links trigger propagates the click to the <code>&lt;a&gt;</code> element, and returns that for you to leverage with Auto-event variables.</p>

<h3 id="55-all-elements-listens-to-all-clicks">55. All Elements listens to all clicks</h3>

<p>All Elements, on the other hand, listens to all clicks and returns the element that was actually clicked. In the HTML example above, the All Elements trigger would return the <code>&lt;span&gt;</code> element because that&rsquo;s the element that was actually clicked.</p>

<h3 id="56-form-listens-to-a-submit-event-dispatched-by-a-form-element">56. Form listens to a <code>submit</code> event dispatched by a <code>&lt;form&gt;</code> element</h3>

<p>The Form trigger only works with an actual <code>&lt;form&gt;</code> element submitted with default HTML form functionality. This means that there actually needs to be a <code>submit</code> event dispatched by the form, and it must be allowed to bubble up.</p>

<p>Any custom server-side validation, suppressing of the <code>submit</code> event, or customized form handling will result in the Form trigger not working. Thus, the Form trigger is typically the trigger you&rsquo;ll have the most difficulties with due to the ridiculously diverse number of ways that forms can be handled with JavaScript.</p>

<h3 id="57-history-change-listens-to-interactions-with-the-browser-history-api">57. History Change listens to interactions with the browser history API</h3>

<p>The History Change trigger listens for the following browser history API events: <code>hashchange</code>, <code>pushState</code>, <code>replaceState</code> and <code>popstate</code>.</p>

<p>Typically these are used on single-page websites, where page transitions are done without a page refresh.</p>

<p>When creating History Change triggers, you&rsquo;ll typically want to work mainly with <code>pushState</code> and <code>replaceState</code>, as those are managed by the by the site code itself. <code>popstate</code> and <code>hashchange</code> can be triggered automatically by the web browser (and there are differences between browsers), which might lead to inaccuracies in your tracking.</p>

<h3 id="58-error-listens-to-uncaught-javascript-exceptions">58. Error listens to uncaught JavaScript exceptions</h3>

<p>The Error triggers listens to <strong>uncaught</strong> JavaScript errors that occur on the website. If there&rsquo;s a <code>try...catch</code> block anywhere in the error path, this trigger will not react to it.</p>

<p>Do note that Custom JavaScript variables automatically catch all exceptions, so this trigger will not help you debug errors in Custom JavaScript variables.</p>

<h3 id="59-all-triggers-but-the-click-all-elements-trigger-require-that-the-original-event-bubble-up">59. All triggers but the Click / All Elements trigger require that the original event bubble up</h3>

<p>Google Tag Manager attaches its auto-event listeners to the <code>document</code> element of the page. This is the highest node in the web document. The reason GTM does this is because it allows you to handle events that take place anywhere on the page, even for elements that don&rsquo;t exist when GTM first loads.</p>

<p>For this type of <em>event delegation</em> to work, the event must bubble up to the top of the document. It&rsquo;s surprising how often bubbling is cancelled, leading to GTM&rsquo;s events not working.</p>

<p>The only exception is the All Elements trigger, which uses the <em>capture</em> phase of the event path. This means that even if bubbling is stopped, the <em>capture</em> phase can still record the click. So if you find your Just Links trigger isn&rsquo;t working, you can recreate the same logic with an All Elements trigger and some clever CSS selector / Custom JavaScript variable work.</p>

<p>For more information, see e.g. this article on <a href="https://www.simoahava.com/gtm-tips/fix-problems-with-gtm-listeners/">GTM listener issues</a>, and this on <a href="https://www.simoahava.com/analytics/capturing-the-correct-element-in-google-tag-manager/">element capturing with the All Elements trigger</a>.</p>

<h3 id="60-check-validation-checks-for-event-preventdefault">60. Check Validation checks for <code>event.preventDefault()</code></h3>

<p>If you have <strong>Check Validation</strong> checked in your Just Links or Form trigger, the trigger will only fire if the event&rsquo;s default action is not cancelled.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/check-validation.jpg" title="Check Validation">
  
    <img class="fig-img lazy" data-src="/images/2017/02/check-validation.jpg#ZgotmplZ" alt="Check Validation">
  
    </a>
  
  
</div>



<p>This is a useful feature to leverage, since often the default action of a link (redirect) or a form (submit) is prevented due to the link simply changing a content tab, or the form being incorrectly filled, for example. In these cases, you&rsquo;ll want to have Check Validation checked, because you probably don&rsquo;t want to track clicks on links that don&rsquo;t redirect or submissions of forms that don&rsquo;t actually submit.</p>

<h3 id="61-wait-for-tags-pauses-the-original-event-but-be-careful">61. Wait for Tags pauses the original event, but be careful</h3>

<p>If you use the <strong>Wait for Tags</strong> option in the Just Links or Form triggers, Google Tag Manager halts the action of the link or form, respectively, to wait until all tags that use the trigger have fired. After tags signal completion, GTM allows the original event to continue.</p>

<p>This is a great feature. It mitigates the risk of losing data due to the link or form redirecting the user to a new page before the tags that use the trigger have fired.</p>

<p>However, there are many ways to do custom link redirects and form submissions. When GTM pauses the event, it&rsquo;s not 100% reliable GTM understands what the custom behavior was. Thus, when GTM then proceeds with the paused action, it might be a different action altogether that GTM resumes.</p>

<p>This is typical in single-page apps, where internal links have a lot of complex logic added to them to prevent links from redirecting the user to new URLs.</p>

<p>So, when you use the Wait for Tags option, <strong>always remember to test the pages where the trigger is active</strong>. Test links and forms, both, to make sure that their functionalities are not compromised. If you are in doubt, simply uncheck Wait for Tags and accept a certain level of inaccuracy in your tracking.</p>

<h3 id="62-enable-this-trigger-when-vs-this-trigger-fires-on">62. Enable this trigger when&hellip; vs. This trigger fires on&hellip;</h3>

<p>If you do check Wait for Tags or Check Validation, you&rsquo;ll see the &ldquo;Enable this trigger when&hellip;&rdquo; option appear in the trigger settings.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/enable-this-trigger.jpg" title="Enable this trigger vs. fire on">
  
    <img class="fig-img lazy" data-src="/images/2017/02/enable-this-trigger.jpg#ZgotmplZ" alt="Enable this trigger vs. fire on">
  
    </a>
  
  
</div>



<p>The &ldquo;Enable this trigger when&hellip;&rdquo; option is for determining <strong>on which pages the trigger should listen to actions</strong>. Thus you can use it to have the trigger listen only on pages where you have thoroughly tested the trigger doesn&rsquo;t mess with site functionality.</p>

<p>It&rsquo;s a good idea to start with a generic <strong>Page URL contains /</strong> condition here, as it will simply set the trigger to listen to user actions on all pages of the site. If you do run into trouble, you can modify this condition to only activate the trigger on a specific subset of pages.</p>

<p>The &ldquo;This trigger fires on&hellip;&rdquo; option is for determining what conditions OTHER than the trigger event itself need to exist for any tags which use the trigger to fire. This is where you&rsquo;ll add your &ldquo;Click URL&rdquo; and &ldquo;Form ID&rdquo; conditions, for example.</p>

<h3 id="63-data-layer-object-composition-of-an-auto-event">63. Data Layer object composition of an auto-event</h3>

<p>When an auto-event trigger fires, the following items are pushed into <code>dataLayer</code>:</p>

<ul>
<li><p><code>event</code> - gets the value of the trigger event that was registered.</p></li>

<li><p><code>gtm.element</code> - reference to the HTML element that was the target of the event.</p></li>

<li><p><code>gtm.elementClasses</code> - string with the value from the <code>class</code> attribute of the target element (if any).</p></li>

<li><p><code>gtm.elementId</code> - string with the value from the <code>id</code> attribute of the target element (if any).</p></li>

<li><p><code>gtm.elementTarget</code> - string with the value from the <code>target</code> attribute of the target element (if any).</p></li>

<li><p><code>gtm.elementUrl</code> - string with the value from the <code>href</code> or <code>action</code> attribute of the target element (if any).</p></li>

<li><p><code>gtm.triggers</code> - a regular expression which determines if the trigger that activated is enabled on the current page.</p></li>
</ul>

<p>In addition to these, you might see variables like <code>gtm.uniqueEventId</code>, <code>eventCallback</code>, <code>eventTimeout</code> and <code>eventReporter</code>. These are internal to GTM, but suffice to say that they govern how the Wait for Tags option works, among other things.</p>

<h3 id="64-auto-event-variable">64. Auto-event variable</h3>

<p>If you&rsquo;re not satisfied with the Built-in variables (Click / Form) for auto-events, you can create your own. Google Tag Manager has a user-defined variable type called Auto-Event Variable, which lets you analyse pretty much any part of the auto-event target element you want.</p>

<p>For example, if you&rsquo;ve added a custom data attribute <code>data-gtm-cta=&quot;Subscribe call to action&quot;</code>, and you want to check if the clicked link has this data attribute, you can create a new Auto-Event Variable that looks like this:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/auto-event-variable.jpg" title="Auto-event variable">
  
    <img class="fig-img lazy" data-src="/images/2017/02/auto-event-variable.jpg#ZgotmplZ" alt="Auto-event variable">
  
    </a>
  
  
</div>



<p>This comes in very handy, as you won&rsquo;t be limited to the rather small number of available built-in variables.</p>

<h3 id="65-matches-css-selector-with-the-click-form-element-built-in-variable">65. Matches CSS selector with the Click / Form Element built-in variable</h3>

<p>The <strong>matches CSS selector</strong> is <a href="https://www.simoahava.com/analytics/matches-css-selector-operator-in-gtm-triggers/">one of the most effective ways</a> you can create triggers in Google Tag Manager. When combined with the Click / Form Element Built-in variable, it gains a whole new level of awesomeness.</p>

<p>You can write complex CSS selectors to check whether the element that was the target of the auto-event matches what you expect. For example, let&rsquo;s say you have the following HTML structure:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;products&#34;</span>&gt;
  &lt;<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">div</span>&gt;
      &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;some-product.html&#34;</span>&gt;Product/a&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
  &lt;/<span style="color:#f92672">div</span>&gt;
&lt;/<span style="color:#f92672">div</span>&gt;
&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;services&#34;</span>&gt;
  &lt;<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">div</span>&gt;
      &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;some-service.html&#34;</span>&gt;Service&lt;/<span style="color:#f92672">a</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
  &lt;/<span style="color:#f92672">div</span>&gt;
&lt;/<span style="color:#f92672">div</span>&gt;</code></pre></div>

<p>Now, you only want your Just Links trigger to fire when the user clicks the &ldquo;Product&rdquo; link. However, as you can see, the HTML structures between &ldquo;Product&rdquo; and &ldquo;Service&rdquo; are almost identical, making it difficult to pinpoint the exact element without having to resort to suboptimal selection mechanisms. Well, CSS selectors to the rescue. The following Just Links trigger will only fire when the click is on a link that is the descendant of a <code>div</code> with the id <code>&quot;products&quot;</code>:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/matches-css-selector.jpg" title="Matches css selector">
  
    <img class="fig-img lazy" data-src="/images/2017/02/matches-css-selector.jpg#ZgotmplZ" alt="Matches css selector">
  
    </a>
  
  
</div>



<p>Just remember: <strong>matches CSS selector only works against an HTML element</strong>. So don&rsquo;t try to match a selector against the Click ID or Click URL variables, for example. Only Click / Form Element will do.</p>

<hr />

<h2 id="custom-html-tags">Custom HTML tags</h2>

<h3 id="66-code-is-automatically-minified">66. Code is automatically minified</h3>

<p>Custom HTML tags automatically minify / uglify the JavaScript, so no need to do so yourself.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/minified-custom-html-tag.jpg" title="Minified custom HTML tag">
  
    <img class="fig-img lazy" data-src="/images/2017/02/minified-custom-html-tag.jpg#ZgotmplZ" alt="Minified custom HTML tag">
  
    </a>
  
  
</div>



<h3 id="67-code-is-injected-to-the-end-of-body">67. Code is injected to the end of <code>&lt;body&gt;</code></h3>

<p>When you write HTML code in a Custom HTML tag, the entire code block is always injected to the end of <code>&lt;body&gt;</code> when the trigger fires for the tag.</p>

<p>If you want to place the HTML code somewhere else, you need to write JavaScript (within the Custom HTML tag) that creates a new HTML element with your specifications, and then uses DOM methods to place it wherever you like on the page.</p>

<h3 id="68-can-be-used-to-add-any-html-elements">68. Can be used to add any HTML elements</h3>

<p>You can use the Custom HTML tag to add any supported HTML5 code to the page. This means that tags such as these are all supported: <code>meta</code>, <code>link</code>, <code>style</code>, <code>video</code>, <code>script</code>, and so forth.</p>

<p>Naturally, with some JavaScript DOM magic, you can also <strong>modify</strong> existing elements or even remove them entirely from the page.</p>

<h3 id="69-the-document-write-option-is-fixed-to-prevent-the-site-from-breaking">69. The <code>document.write</code> option is fixed to prevent the site from breaking</h3>

<p>If you are adding a script which makes use of <code>document.write</code> to place elements on the page, you will need to check the &ldquo;Support document.write&rdquo; option in the Custom HTML tag editor.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/support-document-write.jpg" title="Support document.write">
  
    <img class="fig-img lazy" data-src="/images/2017/02/support-document-write.jpg#ZgotmplZ" alt="Support document.write">
  
    </a>
  
  
</div>



<p>If you don&rsquo;t check this option, you run the risk of the <code>document.write</code> command clearing the entire page of all contents because of how <code>document.write</code> works post-page-load.</p>

<p>Dan Wilkerson has written a great <a href="https://www.simoahava.com/gtm-tips/using-document-write-safely-gtm-tags/">guest post on this topic</a>, so remember to check it out for more information.</p>

<h3 id="70-variables-are-automatically-renamed-in-custom-html-tags-too">70. Variables are automatically renamed in Custom HTML tags, too</h3>

<p>Did you know that when you create a variable reference in GTM with <strong>{{Variable Name}}</strong> and you then change the variable name to <strong>{{Some Other Variable Name}}</strong>, all references are automatically updated?</p>

<p>Well this applies to Custom HTML tags, too, so you don&rsquo;t have to worry about syntax errors when renaming variables. The new name will be automatically applied to all places in the container where the variable is referred to.</p>

<hr />

<h2 id="built-in-variables">Built-in variables</h2>

<h3 id="71-need-to-be-enabled">71. Need to be enabled</h3>

<p>The only Built-in Variables enabled by default in your web container are <strong>Event</strong>, <strong>Page URL</strong>, <strong>Page Path</strong>, <strong>Page Hostname</strong> and <strong>Referrer</strong>.</p>

<p>To enable others, go to <strong>Variables</strong> and click the red <strong>CONFIGURE</strong> under the heading &ldquo;Built-In Variables&rdquo;.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/built-in-variables-enable.jpg" title="Enable built-in variables">
  
    <img class="fig-img lazy" data-src="/images/2017/02/built-in-variables-enable.jpg#ZgotmplZ" alt="Enable built-in variables">
  
    </a>
  
  
</div>



<p>In the overlay that flies out, check the box next to each Built-in variable you want to enable. Only after enabling the variables will they be available in variable selection drop-downs.</p>

<h3 id="72-click-and-form-variables-are-copies-of-each-other">72. Click and Form variables are copies of each other</h3>

<p>You might have noticed that there&rsquo;s a very similar set of six auto-event Built-in variables: Click/Form Element, Click/Form ID, Click/Form URL, Click/Form Target, Click/Form Classes, Click/Form Text.</p>

<p>These are identical in functionality, so you really only need to enable either Click or Form Built-in variables.</p>

<hr />

<h2 id="custom-javascript-variables">Custom JavaScript variables</h2>

<h3 id="73-must-be-anonymous-functions">73. Must be anonymous functions</h3>

<p>When you create a Custom JavaScript variable, it should be an anonymous function. Yes, you can name it, but it doesn&rsquo;t matter since there&rsquo;s no way to call the variable with its name, as it&rsquo;s locally scoped to whatever execution context invokes the variable when your container needs to do so.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Not ideal:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">clickTextLowercase</span>() {
  <span style="color:#66d9ef">return</span> {{<span style="color:#a6e22e">Click</span> <span style="color:#a6e22e">Text</span>}}.<span style="color:#a6e22e">toLowerCase</span>();
}

<span style="color:#75715e">// Use this:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">return</span> {{<span style="color:#a6e22e">Click</span> <span style="color:#a6e22e">Text</span>}}.<span style="color:#a6e22e">toLowerCase</span>();
}
</code></pre></div>

<p>To avoid any potential namespace conflicts, just use an anonymous function, since you call GTM&rsquo;s variables with the  syntax and not with whatever name you give the method itself.</p>

<h3 id="74-must-have-a-return-statement">74. Must have a <code>return</code> statement</h3>

<p>All Custom JavaScript variables must have a <code>return</code> statement or Google Tag Manager will throw an error when you try to create a version of the container.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Will not work:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">true</span>) {}
}

<span style="color:#75715e">// Works:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">true</span>) {}
  <span style="color:#66d9ef">return</span>;
}
</code></pre></div>

<h3 id="75-can-be-used-to-return-another-function">75. Can be used to return another function</h3>

<p>Remember that a Custom JavaScript variable is just regular JavaScript, and as such you can use it to return another function. This is also called returning a <strong>closure</strong>.</p>

<p>For example, let&rsquo;s say I want to create a utility function that takes a string as an argument and reverses all letters in it. First, I&rsquo;d create a Custom JavaScript variable like this:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">str</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">str</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">reverse</span>().<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;&#39;</span>);
  };
}
</code></pre></div>

<p>Then, when I want to use this utility in a Custom HTML tag or another variable, I can pass any string to the GTM variable as an attribute:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  (<span style="color:#66d9ef">function</span>() {
    <span style="color:#75715e">// Create a reference to the Custom JavaScript variable we just created
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">reverseString</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">JS</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">ReverseString</span>}}
    window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
      <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;reverseComplete&#39;</span>,
      <span style="color:#a6e22e">reversedString</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">reverseString</span>(<span style="color:#e6db74">&#34;Reverse me!&#34;</span>)
    });
  })();
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<p>This Custom HTML tag calls the function returned by the Custom JavaScript variable with the string &ldquo;Reverse me!&rdquo;, resulting in a <code>dataLayer.push()</code> where the key <code>reversedString</code> will have the value &ldquo;!em esreveR&rdquo;.</p>

<h3 id="76-should-avoid-side-effects">76. Should avoid side effects</h3>

<p>Custom JavaScript variables should avoid side effects. In other words, they shouldn&rsquo;t do anything except process an input and produce an output. Any transformations or mutations should happen in local scope alone.</p>

<p>If you don&rsquo;t respect this, you might run into all sorts of issues due to the fact that Google Tag Manager&rsquo;s resolution of variables is unpredictable and can&rsquo;t be counted on to only happen once per tag.</p>

<p>Here are some things to avoid:</p>

<ul>
<li><p>Modifying, creating, or deleting items in the global <code>window</code> namespace.</p></li>

<li><p>Creating or processing custom HTTP requests.</p></li>

<li><p>Setting or removing items in globally available APIs, such as <code>dataLayer</code>, <code>google_tag_manager</code>, <code>document.cookie</code> and <code>localStorage</code>.</p></li>
</ul>

<p>If you do want to modify global state, use Custom HTML tags or closures instead.</p>

<h3 id="77-can-refer-to-other-variables">77. Can refer to other variables</h3>

<p>This might seem like a no-brainer, but you can freely refer to other variables in Custom JavaScript variables, too.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">hostname</span> <span style="color:#f92672">=</span> {{<span style="color:#a6e22e">Page</span> <span style="color:#a6e22e">Hostname</span>}};
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hostname</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;www.domain.com&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;Main domain&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Other domain&#39;</span>;
}
</code></pre></div>

<hr />

<h2 id="tag-sequencing">Tag sequencing</h2>

<h3 id="78-setup-and-cleanup-are-fired-with-the-main-tag-regardless-of-their-own-triggers">78. Setup and cleanup are fired with the main tag, regardless of their own triggers</h3>

<p>When you add a Setup or Cleanup tag to a sequence with a main tag, the Setup and Cleanup will be fired with the main tag regardless of what triggers they might actually have themselves.</p>

<p>So here&rsquo;s a tip: When creating Setup and Cleanup tags, <strong>use them only for that purpose</strong> and do not add any triggers to them. This way you will never run the risk of these tags firing when they shouldn&rsquo;t, as they are strictly bound to whatever sequence they are in.</p>

<h3 id="79-use-onhtmlsuccess-and-onhtmlfailure-to-signal-that-the-sequence-can-continue">79. Use <code>onHtmlSuccess()</code> and <code>onHtmlFailure()</code> to signal that the sequence can continue</h3>

<p>When you have a Custom HTML tag as a Setup or Main tag, you can let Google Tag Manager know if the tag completed successfully or failed by using the <code>onHtmlSuccess()</code> and <code>onHtmlFailure()</code> methods.</p>

<p>For these to work, you first need to enable Built-in variables <strong>Container ID</strong> and <strong>HTML ID</strong>.</p>

<p>Here&rsquo;s an example of a Custom HTML Setup tag, where we wait for the asynchronous POST request to complete before telling GTM to continue to the main tag. If the asynchronous request fails, we tell GTM that the Setup tag was a failure.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  (<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">$</span>) {
    <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/test.php&#39;</span>)
      .<span style="color:#a6e22e">done</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">google_tag_manager</span>[{{<span style="color:#a6e22e">Container</span> <span style="color:#a6e22e">ID</span>}}].<span style="color:#a6e22e">onHtmlSuccess</span>({{<span style="color:#a6e22e">HTML</span> <span style="color:#a6e22e">ID</span>}});
      })
      .<span style="color:#a6e22e">fail</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">google_tag_manager</span>[{{<span style="color:#a6e22e">Container</span> <span style="color:#a6e22e">ID</span>}}].<span style="color:#a6e22e">onHtmlFailure</span>({{<span style="color:#a6e22e">HTML</span> <span style="color:#a6e22e">ID</span>}});
      });
  })(<span style="color:#a6e22e">jQuery</span>);
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<p>If you didn&rsquo;t have the <code>onHtmlSuccess/Failure()</code> methods there, Google Tag Manager would simply signal completion as soon as it reaches the last line of code in the tag. Thus the browser won&rsquo;t wait for any asynchronous requests to complete, and you might end up with a nasty race condition if you need the request to complete before proceeding with the Main tag.</p>

<h3 id="80-use-datalayer-set-to-change-data-layer-variable-values-mid-sequence">80. Use <code>dataLayer.set()</code> to change Data Layer variable values mid-sequence</h3>

<p>If you want to change some value in GTM&rsquo;s Data Layer while in the middle of a sequence, you can&rsquo;t use <code>dataLayer.push()</code>, because GTM freezes its state for the duration of each message that is pushed into <code>dataLayer</code>.</p>

<p>However, there&rsquo;s a workaround. You CAN update the value of GTM&rsquo;s Data Layer variables, even though the same <code>dataLayer</code> message is still being processed. To do this, you need to use the <code>google_tag_manager[{{Container ID}}].dataLayer.set('keyName', 'value')</code> interface you learned of here.</p>

<hr />

<h2 id="tag-settings">Tag settings</h2>

<h3 id="81-once-per-page-is-once-per-page-load-once-per-event-is-once-per-gtm-event">81. Once per page is once per page load, once per event is once per GTM event</h3>

<p>There are three options in the <strong>Tag firing options</strong> menu that you can find at the end of each tag&rsquo;s settings.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/tag-firing-options.jpg" title="Tag firing options">
  
    <img class="fig-img lazy" data-src="/images/2017/02/tag-firing-options.jpg#ZgotmplZ" alt="Tag firing options">
  
    </a>
  
  
</div>



<p><strong>Unlimited</strong> means the tag will fire whenever its triggers fire - no restrictions.</p>

<p><strong>Once per event</strong> means that the tag will fire just once per the trigger event that caused it to fire. Thus if you have, for example, multiple Click triggers attached to the tag, and there&rsquo;s a chance that some of these have overlapping trigger conditions, <strong>Once per event</strong> ensures that the tag fires just once per click.</p>

<p><strong>Once per page</strong> means that the tag will fire only once per page load. No matter what triggers you have attached to it - if the tag fires on the page, it will not fire again until the page is reloaded from the web server. Tag Sequencing respects this, too, so if a Setup or Cleanup tag are set to fire just once per page, they will not fire multiple times even if the main tag does.</p>

<h3 id="82-tag-priority-is-for-a-single-gtm-event-doesn-t-necessarily-mean-tags-are-completed-in-the-given-order">82. Tag priority is for a single GTM event - doesn&rsquo;t necessarily mean tags are completed in the given order</h3>

<p>The <strong>Tag priority</strong> field can be used to establish an order execution for tags that fire on the same trigger event. When a trigger event happens, Google Tag Manager executes tags in order of priority.</p>

<p>Note that Tag priority only establishes the order in which tags <strong>begin execution</strong>. It has no implications on when they <strong>complete</strong>. Thus, even if a tag starts its execution first, it might have a long, complex, asynchronous process involved, and it still ends up completing only after tags later in the priority order have already finished.</p>

<hr />

<h2 id="workspaces">Workspaces</h2>

<h3 id="83-you-will-always-have-at-least-one-workspace">83. You will always have at least one workspace</h3>

<p>Workspaces have come to stay, and it&rsquo;s impossible to use Google Tag Manager without a workspace.</p>

<p>Thus, even if you try to delete all workspaces, GTM will always leave you with one.</p>

<h3 id="84-when-you-create-a-version-out-of-a-workspace-that-workspace-is-deleted">84. When you create a version out of a workspace, that workspace is deleted</h3>

<p>Workspaces are ephemeral - they only exist until a version is created from them. Once you create a version, it&rsquo;s as if the workspace never existed. Thus workspaces shouldn&rsquo;t be used as permanent container subsets that you could, for example, delegate to a certain user group only. Instead, workspaces should be approached as branches of a version control system. When you start working on a new feature, create a workspace first so that any changes you make are contained until you choose to create a version and merge the changes to the latest container version.</p>

<h3 id="85-you-don-t-have-to-update-your-workspace-until-you-are-ready-to-create-a-version">85. You don&rsquo;t have to update your workspace until you are ready to create a version</h3>

<p>When someone else updates the latest container version, all the workspaces in the container need to be updated. You&rsquo;ll know this has happened when you see the following notice in the GTM UI:</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/update-workspace.jpg" title="Update workspace">
  
    <img class="fig-img lazy" data-src="/images/2017/02/update-workspace.jpg#ZgotmplZ" alt="Update workspace">
  
    </a>
  
  
</div>



<p>You don&rsquo;t <em>have</em> to update the workspace the minute you see this warning. You can bide your time, and only sync the changes once you are ready to create a version out of your workspace.</p>

<p>Nevertheless, the sooner you update the better. Why? Because once merges start piling up, you&rsquo;ll have a hard time resolving all the conflicts at once.</p>

<hr />

<h2 id="amp-container">AMP container</h2>

<h3 id="86-no-custom-javascript-or-custom-html">86. No Custom JavaScript or Custom HTML</h3>

<p>Accelerated Mobile Pages place some pretty strict restrictions on what you can use Google Tag Manager for. You can&rsquo;t execute arbitrary JavaScript code anymore, nor can you simply inject HTML via Google Tag Manager. In fact, all dynamic operations need to be handled server-side in GTM, because all that GTM returns is the AMP configuration JSON object, which has very limited capabilities for any advanced tracking.</p>

<p>So no Custom JavaScript variables or Custom HTML tags in the AMP container, unfortunately.</p>

<h3 id="87-amp-is-very-restricting">87. AMP is very restricting</h3>

<p>As said, AMP is very restricting. Only JavaScript sanctioned by AMP and provided as an AMP module can be executed. This means that the development of the GTM AMP container is bound very closely to the roadmap of AMP itself. Any attempts to deviate would result in an invalid configuration JSON, which would, in turn, lead to an invalid AMP page.</p>

<p>It&rsquo;s a good idea to closely follow the <a href="https://www.ampproject.org/docs/reference/components/amp-analytics">amp-analytics</a> project, as it contains the latest release details for the amp-analytics module. This is the module used by Google Tag Manager&rsquo;s AMP container.</p>

<h3 id="88-client-id-is-currently-ambiguous">88. Client ID is (currently) ambiguous</h3>

<p>Universal Analytics&rsquo; Client ID is problematic with AMP, especially when run through the GTM container. There are actually <a href="https://developers.google.com/analytics/devguides/collection/amp-analytics/client-id#client_id_scenarios">four</a> different Client ID scenarios for AMP analytics.</p>

<ol>
<li><p>When visiting the regular site (no AMP): <code>_ga</code> cookie stores the Universal Analytics Client ID.</p></li>

<li><p>When visiting the regular site (AMP): <code>AMP_ECID_GOOGLE</code> cookie stores a randomly generated AMP Client ID.</p></li>

<li><p>When visiting the site via the AMP cache: the AMP client ID is stored in <code>localStorage</code> on the ampproject.org domain.</p></li>

<li><p>When visiting the site via Google search: the AMP client ID is stored on google.com and ampproject.org in <code>localStorage</code>.</p></li>
</ol>

<p>In all of these scenarios, it&rsquo;s possible that the Client ID is different, which means that you&rsquo;ll have quite a bit of difficulty in tracking the same user across AMP and non-AMP sites, or between Google search and direct access to the site.</p>

<p>Some time ago, Dan Wilkerson and I <a href="https://www.simoahava.com/analytics/google-analytics-client-id-amp-pages/">wrote a hack around this</a>, which does require some web server muscle, but it will make sure that all the scenarios above use the same Universal Analytics client ID in the <code>_ga</code> cookie.</p>

<h3 id="89-new-triggers-e-g-scroll">89. New triggers, e.g. scroll</h3>

<p>AMP introduces a bunch of really useful triggers, which I hope we&rsquo;ll see in GTM for web soon, too.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/amp-triggers.jpg" title="AMP triggers">
  
    <img class="fig-img lazy" data-src="/images/2017/02/amp-triggers.jpg#ZgotmplZ" alt="AMP triggers">
  
    </a>
  
  
</div>



<p>Since you can&rsquo;t execute arbitrary JavaScript, AMP provides stuff like scroll and visibility tracking out-of-the-box with amp-analytics. Google Tag Manager gives you a way to easily configure the triggers, but it should be noted that there&rsquo;s not much room to configure the triggers. AMP is restricted in this way, too.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/scroll-trigger.jpg" title="Scroll trigger in AMP">
  
    <img class="fig-img lazy" data-src="/images/2017/02/scroll-trigger.jpg#ZgotmplZ" alt="Scroll trigger in AMP">
  
    </a>
  
  
</div>



<p>For example, I would like to configure the scroll trigger to track scroll-to-element rather than scroll-to-percentage. Unfortunately, this is not possible.</p>

<h3 id="90-can-be-augmented-with-the-on-page-json-configuration">90. Can be augmented with the on-page JSON configuration</h3>

<p>Remember that even if you use the AMP Google Tag Manager container, you can also add a JSON configuration block to the page. You can use this extra configuration to complement the tracking you setup via Google Tag Manager.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">  ...
  <span style="color:#75715e">&lt;!-- AMP Analytics --&gt;</span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">async</span> <span style="color:#a6e22e">custom-element</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amp-analytics&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdn.ampproject.org/v0/amp-analytics-0.1.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
  <span style="color:#75715e">&lt;!-- Google Tag Manager --&gt;</span>
  &lt;<span style="color:#f92672">amp-analytics</span> <span style="color:#a6e22e">config</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://www.googletagmanager.com/amp.json?id=GTM-XXXXX&amp;gtm.url=SOURCE_URL&#34;</span> <span style="color:#a6e22e">data-credentials</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;include&#34;</span>&gt;&lt;/<span style="color:#f92672">amp-analytics</span>&gt;
  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;application/json&#34;</span>&gt;
  {
    <span style="color:#e6db74">&#34;vars&#34;</span><span style="color:#f92672">:</span> {
      <span style="color:#e6db74">&#34;pageType&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;profile&#34;</span>,
      <span style="color:#e6db74">&#34;userType&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;member&#34;</span>
    }
  }
  &lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<p>This is a pretty simple way to add some web server logic to your GTM AMP container.</p>

<hr />

<h2 id="gtm-for-mobile">GTM for mobile</h2>

<h3 id="91-not-the-same-as-gtm-for-web">91. Not the same as GTM for web</h3>

<p>Let&rsquo;s address the elephant in the room first. If AMP was restricted, then GTM for mobile is doubly so. Why? Because you&rsquo;re no longer working with a website that self-corrects any JavaScript mistakes you happen to have in the site code. When working with mobile apps, the app needs to be well-formed without exceptions, and you can&rsquo;t add runtime code to it without it being sanctioned by the platform the app is running on.</p>

<p>Also, since this isn&rsquo;t the web anymore, there&rsquo;s no &ldquo;Custom HTML&rdquo; or &ldquo;Custom JavaScript&rdquo; here, either. Android apps use Java, and iOS relies on Swift and Objective-C.</p>

<p>Due to these restrictions, it&rsquo;s a valid concern to raise whether you need Google Tag Manager at all. It takes pretty much the same effort as simply using the analytics SDK directly.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/firebase-templates.jpg" title="Firebase templates">
  
    <img class="fig-img lazy" data-src="/images/2017/02/firebase-templates.jpg#ZgotmplZ" alt="Firebase templates">
  
    </a>
  
  
</div>



<p>The benefit of using GTM is that it will always leverage the latest analytics SDKs. Also, with the Firebase integration you have access to the entire Firebase suite of services, and most of them are really useful for app developers.</p>

<p>Finally, GTM is still GTM. You can implement tracking tags without having to worry too much about how the app itself works. Support for different tag templates isn&rsquo;t too impressive yet, but this will surely change in the future.</p>

<h3 id="92-an-sdk-you-need-to-download-and-add-to-the-project">92. An SDK you need to download and add to the project</h3>

<p>Google Tag Manager isn&rsquo;t a container file that is just fetched from the web and then everything works nicely. No, it&rsquo;s actually a combination of SDKs (software development kit) and container binaries / JSON files that you need to integrate into the app itself.</p>

<p>With the latest version of Google Tag Manager for mobile (Firebase), implementing GTM to a project is really simple. You basically need to include just two podfiles: Firebase/Core and GoogleTagManager. The rest is added automatically via dependencies.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/firebase-dependencies.jpg" title="Firebase dependencies">
  
    <img class="fig-img lazy" data-src="/images/2017/02/firebase-dependencies.jpg#ZgotmplZ" alt="Firebase dependencies">
  
    </a>
  
  
</div>



<p>The app fetches the latest container version if a &ldquo;fresh&rdquo; container is available. You can&rsquo;t always trust that a fresh container can be fetched, so it&rsquo;s a good idea to always keep a recent version of the container in the app assets. So,  when publishing a new release of the app, make sure to check if there&rsquo;s an updated container version that needs to be added to the project before going live.</p>

<h3 id="93-ga-tracker-object-is-not-exposed">93. GA tracker object is not exposed</h3>

<p>Google Tag Manager doesn&rsquo;t expose the GA tracker object in the same way that GTM for web does. In other words, if you want to check what the user&rsquo;s Client ID is, for example, there&rsquo;s no command that lets you dig that information from the available GTM interfaces.</p>

<p>A hacky but working solution in these cases is to create a dummy tracker using the regular Google Analytics SDK, and mining tracker-specific information from this to be used in your Google Tag Manager setup.</p>

<h3 id="94-gtm-legacy-uses-datalayer">94. GTM legacy uses <code>dataLayer</code></h3>

<p>GTM for mobile, before Firebase, is now called &ldquo;Legacy&rdquo;. If you&rsquo;re used to GTM for web, the legacy SDK should be quite familiar to you, since it also uses a <code>dataLayer</code> construct to pass messages to Google Tag Manager. As before, there is the <code>event</code> key you need to use to fire the triggers, and there are Data Layer Variables you can use to access values in this message queue.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/ios-analytics-module.jpg" title="iOS analytics module">
  
    <img class="fig-img lazy" data-src="/images/2017/02/ios-analytics-module.jpg#ZgotmplZ" alt="iOS analytics module">
  
    </a>
  
  
</div>



<p>Note that unlike with GTM for web, there is no differentiation between <code>dataLayer</code> the message queue and GTM&rsquo;s internal data model. The <code>dataLayer</code> structure acts as both.</p>

<h3 id="95-latest-version-of-gtm-for-mobile-uses-firebase">95. Latest version of GTM for mobile uses Firebase</h3>

<p>The most recent incarnation of GTM for mobile uses Firebase. Firebase is a cloud-based application framework that provides a number of services your apps can use, such as Firebase Analytics.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/firebase-analytics.jpg" title="Firebase Analytics via GTM">
  
    <img class="fig-img lazy" data-src="/images/2017/02/firebase-analytics.jpg#ZgotmplZ" alt="Firebase Analytics via GTM">
  
    </a>
  
  
</div>



<p>When you want to use GTM with Firebase, you need to actually <em>use Firebase</em>. You add tracking using regular Firebase Analytics tracking methods, which means that unless you use GTM to radically change the tracking, you will end up using Firebase Analytics in addition to the other analytics tools you want to track via Google Tag Manager.</p>

<h3 id="96-you-can-intercept-firebase-events-using-gtm">96. You can intercept Firebase events using GTM</h3>

<p>The way that Google Tag Manager works with Firebase is that it listens to all the events you log into Firebase. Once it detects an event, it goes through the triggers and tags you&rsquo;ve configured in the container, and if a tag is set to fire on a specific Firebase event, it will go off.</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2017/02/firebase-ga-tag.jpg" title="Firebase GA Tag">
  
    <img class="fig-img lazy" data-src="/images/2017/02/firebase-ga-tag.jpg#ZgotmplZ" alt="Firebase GA Tag">
  
    </a>
  
  
</div>



<p>And as with Google Tag Manager for web, the more tag endpoints you have, the more useful GTM becomes. You can use a single event stream (the logged Firebase events) to send data to multiple endpoints, such as Google Analytics, Firebase, and AppsFlyer.</p>

<h3 id="97-firebase-gtm-has-imperfect-support-for-ga-enhanced-ecommerce">97. Firebase GTM has (imperfect) support for GA Enhanced Ecommerce</h3>

<p>At the time of writing, you can&rsquo;t configure Universal Analytics Ecommerce tags via Firebase GTM. The reason is that GTM&rsquo;s data model does not support array structures, which is how you&rsquo;d need to send product data to Google Analytics.</p>

<p>Hopefully we&rsquo;ll see <a href="https://support.google.com/tagmanager/answer/7003315?hl=en">support for Ecommerce soon</a>. Until then, if you need to collect Ecommerce data to Google Analytics, you might want to use the GTM Legacy SDK or GA SDK.</p>

<p><strong>Update</strong>: Support for Enhanced Ecommerce has finally reached Firebase (<a href="https://developers.google.com/tag-manager/ios/v5/enhanced-ecommerce">iOS</a> and <a href="https://developers.google.com/tag-manager/android/v5/enhanced-ecommerce">Android</a>). Still missing product-scoped custom dimensions and metrics, though! (Thanks <strong>Yuhui</strong> for the tip in the comments).</p>

<hr />

<h2 id="other-stuff">Other stuff</h2>

<h3 id="98-debugging-is-a-complex-process">98. Debugging is a complex process</h3>

<p>End-to-end debugging with Google Tag Manager isn&rsquo;t just a case of opening up Preview mode and being satisfied with what you see. It&rsquo;s a complex process, involving not only front-end conflicts in your site code, but also things like race conditions, unresponsive tag endpoints, and <code>dataLayer</code> <a href="https://www.simoahava.com/analytics/automated-tests-for-google-tag-managers-datalayer/">automated tests</a>.</p>

<p>I recommend you take a look at this article: <a href="https://www.simoahava.com/gtm-tips/debugging-tag-execution-properly/">#GTMTips: Debugging Tag Execution Properly</a>. Make sure you familiarize yourself with the Network tab of your browser&rsquo;s developer tools. If Preview mode says that your tags fire but you don&rsquo;t see any evidence in the endpoint you are looking at (e.g. Google Analytics reports), take a look at the Network tab to see if you are dispatching hits to <code>/collect</code> correctly. <a href="https://support.google.com/analytics/answer/6277302?hl=en">Google Tag Assistant Recordings</a> is your friend, too, for all Google-related tagging issues.</p>

<p>Finally, I recommend adding <code>dataLayer</code> to your organization&rsquo;s quality assurance process. This would mean writing unit tests and browser tests that verify <code>dataLayer</code> has a predictable composition with each new release of the site or app. I&rsquo;ve written a simple framework for running automated tests against <code>dataLayer</code>, and you can read about it <a href="https://www.simoahava.com/analytics/automated-tests-for-google-tag-managers-datalayer/">here</a>.</p>

<h3 id="99-load-sequence-of-gtm-s-default-events-is-important-to-understand">99. Load sequence of GTM&rsquo;s default events is important to understand</h3>

<p>When Google Tag Manager loads on a site, it pushes three default events into <code>dataLayer</code>: <strong>gtm.js</strong>, <strong>gtm.dom</strong> and <strong>gtm.load</strong>.</p>

<p><strong>gtm.js</strong> is pushed in the container snippet itself. Thus it introduces a state which contains all the Data Layer variables pushed <em>before or at the time</em> when the container snippet runs. This event is used by the <strong>Page View</strong> trigger. In other words, if you have tags that fire on the Page View trigger (or All Pages), any Data Layer variables you want to use need to be pushed into <code>dataLayer</code> <em>before</em> the container snippet is executed by the browser. Typically this means to physically add your <code>dataLayer</code> initialization in the page template above the GTM container snippet.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#75715e">// Always use this syntax to initialize dataLayer
</span><span style="color:#75715e"></span>  window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">dataLayer</span> <span style="color:#f92672">||</span> [];
  window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
    <span style="color:#a6e22e">userType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;member&#39;</span>,
    <span style="color:#a6e22e">loyaltyLevel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;premium&#39;</span>
  });
&lt;/<span style="color:#f92672">script</span>&gt;
...
&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#75715e">// GTM container snippet here
</span><span style="color:#75715e"></span>&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<p><strong>gtm.dom</strong> is pushed into <code>dataLayer</code> when the browser signals the <code>DOMContentLoaded</code> event has taken place. This browser event happens when the browser has read the HTML template and built the Document Object Model (DOM) using the structure within. Thus, if you have tags which refer to DOM elements, you might want to make sure they don&rsquo;t fire before the <strong>gtm.dom</strong> event. The trigger which uses this event is <strong>DOM Ready</strong>, so any tags firing on this trigger will have access to any elements described in the page HTML.</p>

<p><strong>gtm.load</strong> is pushed into <code>dataLayer</code> when the browser signals the <code>load</code> event, which means that the entire page, and all linked assets such as images, scripts (both asynchronous and synchronous), and videos have completed downloading. This is the event you&rsquo;d need to use if you want your tags to access the result of some asynchronous process, such as the download of the <a href="https://jquery.org">jQuery</a> library (if downloaded asynchronously, as you should). The trigger which uses this event is <strong>Window Loaded</strong>.</p>

<p>It&rsquo;s important to understand how these three events work. They are not fired at <em>the exact time the underlying browser event takes place</em>. For example, <strong>gtm.js</strong> will fire triggers only after the GTM library has downloaded, and this might be seconds after the browser originally reads the event in the page template. Thus these events don&rsquo;t describe the <em>time</em> something happens but rather the <em>state</em>. <strong>gtm.js</strong> describes the state of GTM&rsquo;s data when the container snippet was first read by the browser, <strong>gtm.dom</strong> reflects GTM&rsquo;s state when the browser signalled <code>DOMContentLoaded</code>, and <strong>gtm.load</strong> is the state of GTM when the entire page had completed loading.</p>

<h3 id="100-some-ad-and-content-blockers-block-gtm-from-loading">100. Some ad and content blockers block GTM from loading</h3>

<p>Call it a feature or symptom of today&rsquo;s web browsing behavior, but ad and content blockers are making life for web analysts difficult. Firefox, for example, offers <a href="https://support.mozilla.org/t5/Protect-your-privacy/Tracking-Protection-in-Private-Browsing/ta-p/36899">Tracking Protection</a> out-of-the-box, and it blocks Google Analytics by default.</p>

<p>Popular browser extensions like <a href="https://www.ghostery.com/">Ghostery</a> and <a href="https://adblockplus.org/">AdBlock Plus</a> make it easy to block Google Tag Manager, too.</p>

<p>Whether you like this or not, it&rsquo;s a common practice and you should therefore accept a certain level of inaccuracy in your data.</p>

<p>With Google Tag Manager, however, you can actively modify and extend the site experience with Custom JavaScript. If the user&rsquo;s browser doesn&rsquo;t load Google Tag Manager, these modifications will not be executed.</p>

<p>Thus, <strong>be very wary of potential GTM blocking when running code via Google Tag Manager</strong>. Never rely on GTM to handle your link redirects or form submissions, and never use GTM to fix on-site issues that should be fixed in front-end code. You are depriving an ever-increasing subset of your visitors of a full experience, and at worst destroying the site user experience altogether for them.</p>

<hr />

<h3 id="101-use-undefined-to-clear-individual-keys-from-data-layer-upepo-mwindaji">101. Use <code>undefined</code> to clear individual keys from Data Layer (upepo mwindaji)</h3>

<p>The first guest tip comes from <strong>upepo mwindaji</strong>. You can clear individual values from GTM&rsquo;s data model by pushing the keys with the value <code>undefined</code>. This effectively resets the value of the key.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">window.<span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>({
  <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;userLoggedOut&#39;</span>,
  <span style="color:#a6e22e">loginStatus</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;loggedOut&#39;</span>,
  <span style="color:#a6e22e">userId</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">undefined</span>,
  <span style="color:#a6e22e">memberStatus</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">undefined</span>
});
</code></pre></div>

<p>The code above, for example, clears the values of <code>userId</code> and <code>memberStatus</code> from GTM&rsquo;s data model because the user logged out.</p>

<h3 id="102-you-can-track-to-multiple-universal-analytics-properties-in-the-same-container">102. You can track to multiple Universal Analytics properties in the same container</h3>

<p>This guest tip is from <strong>samgabell</strong>. Since GTM creates a unique tracker with every Universal Analytics tag, you can freely track to multiple Universal Analytics properties in the same container. There will be no interference between sets of tags tracking to different properties.</p>

<p>The only thing that will cause issues is if one set of tags is configured for cross-domain tracking with the <code>allowLinker</code> field set to <code>true</code>. In this case, a linker parameter in the URL will overwrite the Client ID stored in the <code>_ga</code> cookie, impacting all trackers on the site - even those that should ignore cross-domain tracking. You can read about a solution to this issue <a href="https://www.simoahava.com/gtm-tips/cross-domain-tracking-with-multiple-ga-trackers/">here</a>.</p>

<h2 id="summary">Summary</h2>

<p>So that was my 100 tips. Some of them were indeed very simple and obvious, but I&rsquo;ve run into enough people having issues with all of the things covered here to justify my adding them to the list.</p>

<p>Google Tag Manager turns 5 years old this year. It&rsquo;s been a colorful journey, and I&rsquo;m sure the popularity of the tool has changed the landscape for all tag management solutions for the better. Via GTM, so many new people have had the pleasure to (or have been forced to) get acquainted with the wonderful world of JavaScript, and have thus accumulated new skills to help them on their digital journeys.</p>

<p>Now is your turn - are there invaluable tips that you&rsquo;d want to share with the readers? I&rsquo;d love to add them to the end of the list. Thank you!</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">JavaScript</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/tips/">Tips</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/cross-domain-tracking-with-multiple-ga-trackers/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/mixcloud-player-integration-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=100&#43;%20Google%20Tag%20Manager%20Learnings%20https://www.simoahava.com/analytics/100-google-tag-manager-learnings/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <span id="disqus"></span>
<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/cross-domain-tracking-with-multiple-ga-trackers/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/mixcloud-player-integration-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=100&#43;%20Google%20Tag%20Manager%20Learnings%20https://www.simoahava.com/analytics/100-google-tag-manager-learnings/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=100&#43;%20Google%20Tag%20Manager%20Learnings%20https://www.simoahava.com/analytics/100-google-tag-manager-learnings/%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/100-google-tag-manager-learnings/">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://www.simoahava.com/js/script.js"></script>




  
    
      <script>
        





        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'simoahava';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  


    <script>
      var mylazyload = new LazyLoad({elements_selector: '.lazy'});
      </script>

    
  </body>
</html>

