

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Persist dataLayer In Google Tag Manager | Simo Ahava's blog",
  "image": "https://www.simoahava.com/images/2014/08/persist-datalayer.png",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.simoahava.com/images/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/",
  "datePublished": "2014-09-01T06:57:02+00:00",
  "dateModified": "2014-09-01T06:57:02+00:00",
  "description": "A script that lets you persist dataLayer variables from one page to the next when using Google Tag Manager.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.31 with theme Tranquilpeak 0.4.3-BETA">
    <title>Persist dataLayer In Google Tag Manager | Simo Ahava's blog</title>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PZ7GMV9');</script>
    
    <script src="//simoahava.disqus.com/count.js" id="dsq-count-scr" async></script>
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/persist-datalayer-google-tag-manager/">
    
    <meta name="description" content="A script that lets you persist dataLayer variables from one page to the next when using Google Tag Manager.">
    <meta property="og:description" content="A script that lets you persist dataLayer variables from one page to the next when using Google Tag Manager.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Persist dataLayer In Google Tag Manager">
    <meta property="og:url" content="/analytics/persist-datalayer-google-tag-manager/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Persist dataLayer In Google Tag Manager">
    <meta name="twitter:description" content="A script that lets you persist dataLayer variables from one page to the next when using Google Tag Manager.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
      <meta property="og:image" content="https://www.simoahava.com/images/simo.png">
    

    
      <meta name="twitter:image" content="https://www.simoahava.com/images/2014/08/persist-datalayer.png">  
      <meta property="og:image" content="https://www.simoahava.com/images/2014/08/persist-datalayer.png">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          
          
            <div class="post-header main-content-wrap text-left">

  

    <h1>
      Persist dataLayer In Google Tag Manager
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2014-09-01T06:57:02Z">
        
  September 1, 2014

      </time>
    
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


       | <a href="https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/#disqus_thread">Comments</a>
  </div>


</div>

          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              

<p>If you know your <a href="https://www.simoahava.com/analytics/javascript-101-gtm-part-1/">JavaScript</a>, you know that all variables, functions, objects, resources, and data in the document get rewritten with every page load. In other words, every single page refresh builds the page from scratch, and the state of the document before the page refresh is left drifting in the ocean of oblivion.</p>

<p><a href="http://www.google.com/tagmanager">Google Tag Manager</a>&rsquo;s dataLayer is also one such entity. It gets rewritten with every page load, so it&rsquo;s not possible to have a dataLayer variable <em>persist</em> from one page to the other without using cookies or, as I&rsquo;m going to show in this guide, the <a href="http://www.w3schools.com/html/html5_webstorage.asp">HTML5 Web Storage API</a>. For web analytics, this is a bit of a shame. It forces us to think of things in the scope of a single page, when rarely anything worth mentioning has a lifespan that short.</p>

<p>Before we begin, <a href="http://blog.intlock.com/google-tag-manager-persistent-data-layer-per-session-and-per-visitor/">take a look</a> at what Shay Sharon expertly wrote two years ago about the persistent dataLayer. In his solution, cookies are used to carry the dataLayer across page refreshes. It&rsquo;s a good patch, and it performs the task admirably. However, the thing with cookies is that they can be deleted (and usually are). Also, the length of the cookie string is limited (though 4KB is still plenty), and there&rsquo;s always the fact that cookies are resolved with every single page load (since they are part of the document object).</p>

<p>Data in browser storage, on the other hand, is actually pretty difficult to delete on a granular level, it has a huge quota, and it&rsquo;s only retrieved and stored on demand. Also, using <code>localStorage</code> (more about this soon), you have the data stored indefinitely, so <em>user-level</em> storage is very easy to implement.</p>

<p>(<strong>UPDATE</strong>: Remember that browser local storage should be treated the same as cookies when observing the <a href="http://www.cookielaw.org/">cookie laws</a> of your country. Thanks to Martijn Visser for pointing this out (he&rsquo;s from the Netherlands, and they have pretty much the strictest interpretation of the cookie law in place.))</p>




<div class="figure nocaption" >
  
    <a href="https://www.simoahava.com/images/2014/08/persist-datalayer.png" title="Persistent dataLayer stores variables across page loads">
  
    <img class="fig-img" src="https://www.simoahava.com/images/2014/08/persist-datalayer.png#ZgotmplZ" alt="Persistent dataLayer stores variables across page loads">
  
    </a>
  
  
</div>



<p>In this guide, I&rsquo;ll give you an API of sorts to save, load, replace, and delete items from the local storage. I use a 30 minute expiration for data in <code>localStorage</code> to mimic session-length storage.</p>

<h2 id="introducing-localstorage">Introducing localStorage</h2>

<p><code>localStorage</code> stores data indefinitely in your browser&rsquo;s own storage compartment. It has a larger-than-needed size limit (around 5MB), and data is handled more securely than with cookies. Cookies, you see, are written on the document every time you load a page, and this introduces potential security risks.</p>

<p>Items in <code>localStorage</code>, on the other hand, are retrieved only when called. This way all the data you store will be picked up on demand, and all you need to do is make sure your script handles the data correctly (which is what I&rsquo;ll do for you in this guide).</p>

<p>In <code>localStorage</code>, data is written as key-value pairs, but unlike with dataLayer, both the key and the value need to be of String type. This means that in order to save stuff from dataLayer, which can hold any types of values, to <code>localStorage</code>, some object serialization and type conversion needs to take place (Object =&gt; String). Similarly, the reverse needs to take place when loading data from <code>localStorage</code> and pushing it to dataLayer.</p>

<h2 id="the-persistent-datalayer-api">The Persistent dataLayer API</h2>

<p>Without further ado, allow me to introduce the Persistent dataLayer API. Copy the following code into a Custom HTML Tag, and read on.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
  (<span style="color:#66d9ef">function</span>() {
    <span style="color:#75715e">// Declare some utility variables
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>,
        <span style="color:#a6e22e">getDL</span> <span style="color:#f92672">=</span> {},
        <span style="color:#a6e22e">saveDL</span> <span style="color:#f92672">=</span> {},
        <span style="color:#a6e22e">persistEvent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^persist(Save|Replace)/</span>,
        <span style="color:#a6e22e">timeNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>(),
        <span style="color:#a6e22e">timeStorage</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>,
        <span style="color:#a6e22e">persistTime</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>; <span style="color:#75715e">// Expiration in milliseconds; set to null to never expire
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">// Only works if browser supports Storage API
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">typeof</span>(<span style="color:#a6e22e">Storage</span>)<span style="color:#f92672">!==</span><span style="color:#e6db74">&#39;undefined&#39;</span>) {
        
      <span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;persistDL&#39;</span>);
      <span style="color:#a6e22e">timeStorage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;persistTime&#39;</span>);
      
      <span style="color:#75715e">// Append current dL with objects from storage
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">loadDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">retrievedDL</span>) {
          <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">retrievedDL</span>));
          <span style="color:#75715e">// dataLayer.push({&#39;event&#39;: &#39;DLLoaded&#39;});
</span><span style="color:#75715e"></span>        }
      }
      
      <span style="color:#75715e">// Save specified object in storage
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">storeDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">persistEvent</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">dataLayer</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">event</span>)) {
            <span style="color:#a6e22e">saveDL</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataLayer</span>[<span style="color:#a6e22e">i</span>];
            <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">saveDL</span>.<span style="color:#a6e22e">event</span>;
            <span style="color:#a6e22e">getDL</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">retrievedDL</span>) <span style="color:#f92672">||</span> {};
            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">saveDL</span>) {
              <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">saveDL</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">key</span>)) {
                <span style="color:#a6e22e">getDL</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">saveDL</span>[<span style="color:#a6e22e">key</span>];
              }
            }
            <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;persistDL&#39;</span>, <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">getDL</span>));
          }
        }
      }
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deleteDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">removeItem</span>(<span style="color:#e6db74">&#39;persistDL&#39;</span>);
      }
      <span style="color:#66d9ef">switch</span> ({{<span style="color:#a6e22e">event</span>}}) {
        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;gtm.js&#39;</span><span style="color:#f92672">:</span>
          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">timeStorage</span>) {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">persistTime</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">timeNow</span> <span style="color:#f92672">&gt;</span> Number(<span style="color:#a6e22e">timeStorage</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">persistTime</span>) {
              <span style="color:#a6e22e">deleteDL</span>();
            } <span style="color:#66d9ef">else</span> {
              <span style="color:#a6e22e">loadDL</span>();
            }
          }
          <span style="color:#66d9ef">break</span>;
        <span style="color:#75715e">// Delete dataLayer variables
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;persistDelete&#39;</span><span style="color:#f92672">:</span>
          <span style="color:#a6e22e">deleteDL</span>();
          <span style="color:#66d9ef">break</span>;
        <span style="color:#75715e">// Replace dataLayer variables
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;persistReplace&#39;</span><span style="color:#f92672">:</span>
          <span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
        <span style="color:#75715e">// Save dataLayer variables
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;persistSave&#39;</span><span style="color:#f92672">:</span>
          <span style="color:#a6e22e">storeDL</span>();
          <span style="color:#66d9ef">break</span>;
      }
      
      <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;persistTime&#39;</span>, <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">timeNow</span>));
    }
  })();
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>

<p>The tag will need the following firing rule:</p>

<p><strong>{{event}} matches RegEx ^(gtm.js|persist(Save|Replace|Delete))</strong></p>

<p>Here&rsquo;s a rundown of how the API works, before I go into the technical stuff:</p>

<ol>
<li><p><strong>With every page load</strong>, dataLayer variables stored in <code>localStorage</code> are retrieved and pushed into dataLayer.</p></li>

<li><p><strong>When pushing an object with &lsquo;event&rsquo;: &lsquo;persistSave&rsquo;</strong>, all variables in the same push (e.g. &lsquo;pageCount&rsquo; and &lsquo;author&rsquo; in <code>dataLayer.push({'event': 'persistSave', 'pageCount': '5', 'author': 'Simo-Ahava'});</code>) are saved to <code>localStorage</code>. If a variable with the same name already exists in <code>localStorage</code>, it is updated with the new value.</p></li>

<li><p><strong>When pushing an object with &lsquo;event&rsquo;: &lsquo;persistDelete&rsquo;</strong>, all dataLayer variables in <code>localStorage</code> are deleted.</p></li>

<li><p><strong>When pushing an object with &lsquo;event&rsquo;: &lsquo;persistReplace&rsquo;</strong>, all existing dataLayer variables in <code>localstorage</code> are deleted, and all variables in the <code>dataLayer.push()</code> are saved.</p></li>
</ol>

<p>So remember the following commands:</p>

<p><code>dataLayer.push({'var1': 'value1', 'var2': 'value2', **'event': 'persistSave'**});</code> stores &lsquo;var1&rsquo; and &lsquo;var2&rsquo; (with values) to <code>localStorage</code>.</p>

<p><code>dataLayer.push({'var1': 'value1', 'var2': 'value2', **'event': 'persistDelete'**});</code> deletes all saved dataLayer variables in <code>localStorage</code>; doesn&rsquo;t store anything.</p>

<p><code>dataLayer.push({'var1': 'value1', 'var2': 'value2', **'event': 'persistReplace'**});</code> deletes all saved dataLayer variables in <code>localStorage</code>; stores &lsquo;var1&rsquo; and &lsquo;var2&rsquo; (with values) to localStorage.</p>

<p>A few additional details:</p>

<ul>
<li><p>With every page load, variables are loaded from <code>localStorage</code> and pushed to dataLayer. Even though the tag itself fires on <strong>{{event}} equals gtm.js</strong>, there&rsquo;s a slight delay when processing data through the Storage API. This means that usually the variables appear in dataLayer after <strong>gtm.dom</strong> but before <strong>gtm.load</strong>.</p></li>

<li><p>Every interaction with <code>localStorage</code>, resets the 30 minute expiration timer. If a page load occurs so that the last interaction was over 30 minutes ago, all saved dataLayer variables in <code>localStorage</code> are deleted.</p></li>

<li><p>Before saving the data, dataLayer variables are serialized into a String. When loading from <code>localStorage</code>, they are parsed from JSON back to their original types. Thus Arrays, objects, and primitive values are restored to their original types before pushed back into dataLayer.</p></li>
</ul>

<h2 id="technical-stuff">Technical stuff</h2>

<p>Let&rsquo;s go over the code (almost) line-by-line.</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">(<span style="color:#66d9ef">function</span>() {
...
})();</code></pre></div></p>

<p>The function is wrapped in an IIFE (immediately invoked function expression). This is because I want to avoid using the global scope when utilizing so many different variables. Scoping the variables to this function ensures that I don&rsquo;t mess with global variables of some other library, for example.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>,
<span style="color:#a6e22e">getDL</span> <span style="color:#f92672">=</span> {},
<span style="color:#a6e22e">saveDL</span> <span style="color:#f92672">=</span> {},
<span style="color:#a6e22e">persistEvent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^persist(Save|Replace)/</span>,
<span style="color:#a6e22e">timeNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>(),
<span style="color:#a6e22e">timeStorage</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>,
<span style="color:#a6e22e">persistTime</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>; <span style="color:#960050;background-color:#1e0010">// Expiration in milliseconds; set to null to never expire</span></code></pre></div>

<p>Here I introduce a bunch of utility variables. If you want to have the storage persist for ever and ever, set <code>persistTime = null;</code>.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">typeof</span>(<span style="color:#a6e22e">Storage</span>)<span style="color:#f92672">!==</span><span style="color:#e6db74">&#39;undefined&#39;</span>) {
  <span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;persistDL&#39;</span>);
  <span style="color:#a6e22e">timeStorage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;persistTime&#39;</span>);
  ...
}</code></pre></div>

<p>Only run the API if the browser supports HTML5 Web Storage. It&rsquo;s basically only a problem with IE versions older than 8. I saw no reason to provide an alternative for them, since if you&rsquo;re still using IE7 or older, you deserve a horrible browsing experience.</p>

<p>Check Shay Sharon&rsquo;s excellent post I linked to in the beginning for a cookie-solution to the persistent dataLayer. That should work with your crappy, out-of-date browser.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">loadDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">retrievedDL</span>) {
    <span style="color:#a6e22e">dataLayer</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">retrievedDL</span>));
    <span style="color:#75715e">// dataLayer.push({&#39;event&#39;: &#39;DLLoaded&#39;});
</span><span style="color:#75715e"></span>  }
}
...
<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;gtm.js&#39;</span><span style="color:#f92672">:</span>
  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">retrievedDL</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">timeStorage</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">persistTime</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">timeNow</span> <span style="color:#f92672">&gt;</span> Number(<span style="color:#a6e22e">timeStorage</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">persistTime</span>) {
      <span style="color:#a6e22e">deleteDL</span>();
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">loadDL</span>();
    }
  }
  <span style="color:#66d9ef">break</span>;</code></pre></div>

<p>With every page load, parse the dataLayer variables in <code>localStorage</code> back to their original types, and push them into dataLayer as a single object. If you want to set a trigger event to fire your tags after the variables have been loaded from <code>localStorage</code>, uncomment the line with &lsquo;event&rsquo;: &lsquo;DLLoaded&rsquo;. This way you can have your dependent tags fire on <strong>{{event}} equals DLLoaded</strong> to ensure that they have access to the stored variables.</p>

<p>Also, if the variables in storage expire (default is 30 minutes since last interaction), no data is loaded and the variables are deleted from <code>localStorage</code>. If you&rsquo;ve set <code>persistTime = null;</code>, then there&rsquo;s no expiration for the data in storage, and the variables are stored until they are manually deleted.</p>

<p>When a <code>dataLayer.push();</code> is made so that the object that is pushed contains the property &lsquo;event&rsquo;: &lsquo;persistSave&rsquo;, the function <code>storeDL()</code> is run.</p>

<p>First, the function removes the &lsquo;event&rsquo; property from the object that was pushed into dataLayer. This is done because you don&rsquo;t want to store the trigger event itself in <code>localStorage</code>. (Another possibility is to just skip the &lsquo;event&rsquo; property when storing properties into <code>localStorage</code>.)</p>

<p>Next, each property in this dataLayer object is pushed into the object that was found in <code>localStorage</code>. Thus, all variables that were already stored are updated with new values, and new variables are appended.</p>

<p>Finally, the object, now serialized into a string of keys and values, is stored in <code>localStorage</code>, waiting to be loaded with a new page refresh.</p>

<p>If the &lsquo;event&rsquo; was &lsquo;persistReplace&rsquo;, then this the <code>storeDL()</code> is run as well, but all dataLayer variables in storage are replaced with the new variables.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deleteDL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
  <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">removeItem</span>(<span style="color:#e6db74">&#39;persistDL&#39;</span>);
}
...
<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;persistDelete&#39;</span><span style="color:#f92672">:</span>
  <span style="color:#a6e22e">deleteDL</span>();
  <span style="color:#66d9ef">break</span>;</code></pre></div>

<p>If the trigger event was &lsquo;persistDelete&rsquo;, all dataLayer variables in <code>localStorage</code> are deleted.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;persistTime&#39;</span>, <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">timeNow</span>));</code></pre></div>

<p>Finally, every time the script is run, the current time is saved as a timestamp in <code>localStorage</code>.</p>

<h2 id="conclusions">Conclusions</h2>

<p>I&rsquo;ve noticed that many people have been aching for a persistent dataLayer. I&rsquo;m pretty sure this post will become obsolete as soon as the GTM team choose to deploy such a feature into the product itself, but until then, this should serve you well.</p>

<p>And if nothing else, at least you got to learn about yet another really cool JavaScript API!</p>

<p>Do you have suggestions for the API? Or maybe you have a sweet use case for persistent variables that you might want to share with others?</p>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/api/">api</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/datalayer/">datalayer</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">Google Tag Manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/guide/">Guide</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/javascript/">JavaScript</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/localstorage/">localstorage</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/save-gatc-constant-string-macro/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/node-relationships-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Persist%20dataLayer%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <span id="disqus"></span>
<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2018 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtm-tips/save-gatc-constant-string-macro/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/node-relationships-gtm/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Persist%20dataLayer%20In%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/%20via%20@SimoAhava">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/persist-datalayer-google-tag-manager/">
              <i class="fa fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=%25!s%28BADINDEX%29">
          <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fwww.simoahava.com%2Fanalytics%2Fpersist-datalayer-google-tag-manager%2F%20%25!s%28BADINDEX%29%20via%20@SimoAhava">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=%25!s%28BADINDEX%29">
          <i class="fa fa-google-plus"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=%25!s%28BADINDEX%29">
          <i class="fa fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://www.simoahava.com/js/script.js"></script>




  
    
      <script>
        





        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'simoahava';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

