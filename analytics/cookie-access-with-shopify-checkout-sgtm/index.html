

  
    
  


  





  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="google-site-verification" content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA" />


<script type="application/ld+json">
{
  "@context": "http://schema.org", 
  "@type": "BlogPosting",
  "headline": "Cookie Access With Shopify Checkout And SGTM | Simo Ahava's blog",
  "image": "https:\/\/www.simoahava.com\/images\/2024\/10\/shopify-cookies-problem.jpg",
  "editor": "Simo Ahava",
  "publisher": {
    "@type": "Organization",
    "name": "Simo Ahava's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/www.simoahava.com\/images\/simo.png",
      "height": "393",
      "width": "407"
    }
  },
  "url": "https:\/\/www.simoahava.com\/analytics\/cookie-access-with-shopify-checkout-sgtm\/",
  "datePublished": "2024-10-21T12:32:06\u002b03:00",
  "dateModified": "2024-10-21T12:32:06\u002b03:00",
  "description": "How to add cookie values to server-side Google Tag Manager requests when using Shopify\u0027s Checkout Extensibility.",
  "author": {
    "@type": "Person",
    "name": "Simo Ahava"
  }
}
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Cookie Access With Shopify Checkout And SGTM | Simo Ahava's blog</title>
    
    <script>
      window.dataLayer=window.dataLayer||[];window.dataLayer.push({pageType: 'article', environment:  null });
    </script>
    

    
    
    
    <script>
      (function(S,i,m,o){
        window[m]=window[m]||[];
        window[m].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=S.getElementsByTagName(i)[0],j=S.createElement(i),dl=m!='dataLayer'?'&l='+m:'';
        j.async=true;
        j.src='https://sgtm.simoahava.com/gtm.js?id='+o+dl;
        f.parentNode.insertBefore(j,f);
      })(document,'script','dataLayer','GTM-PZ7GMV9');
    </script>
    
    <meta name="author" content="Simo Ahava">
    <meta name="keywords" content="">

    <link rel="icon" href="https://www.simoahava.com/images/favicon.ico">
    
    <link rel="amphtml" href="https://www.simoahava.com/amp/analytics/cookie-access-with-shopify-checkout-sgtm/">
    
    <meta name="description" content="How to add cookie values to server-side Google Tag Manager requests when using Shopify&#39;s Checkout Extensibility.">
    <meta property="og:description" content="How to add cookie values to server-side Google Tag Manager requests when using Shopify&#39;s Checkout Extensibility.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Cookie Access With Shopify Checkout And SGTM">
    <meta property="og:url" content="https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
    <meta property="og:site_name" content="Simo Ahava&#39;s blog">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Cookie Access With Shopify Checkout And SGTM">
    <meta name="twitter:description" content="How to add cookie values to server-side Google Tag Manager requests when using Shopify&#39;s Checkout Extensibility.">
    
      <meta name="twitter:creator" content="@SimoAhava">
      
    

    
    

    
	  <meta property="og:image" content="https://www.simoahava.com/images/2024/10/cookie-access-shopify-sgtm.jpg">
      <meta name="twitter:image" content="https://www.simoahava.com/images/2024/10/cookie-access-shopify-sgtm.jpg">
    


    

      
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      
    
    <link rel="stylesheet" href="https://www.simoahava.com/css/style.css" />
    
    

    
      
    
    
  </head>

  <body>
    
    <div id="_progress"></div>
    
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://www.simoahava.com/">Simo Ahava&#39;s blog</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://www.simoahava.com/">
          <img class="sidebar-profile-picture" loading="lazy" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Simo Ahava</h4>
        
          <h5 class="sidebar-profile-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tags/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/categories/gtm-tips/">
    
      <i class="sidebar-button-icon fa fa-lg fa-magic"></i>
      
      <span class="sidebar-button-desc">GTM Tips</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/about-simo-ahava/">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/tools/">
    
      <i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
      
      <span class="sidebar-button-desc">Tools</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/blog-statistics/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
      
      <span class="sidebar-button-desc">Blog statistics</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/sahava" target="_blank" rel="noopener ">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/upcoming-talks/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
      
      <span class="sidebar-button-desc">Upcoming talks</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/custom-templates/">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Templates</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.simoahava.com/newsletter/">
    
      <i class="sidebar-button-icon fa fa-lg fa-bell"></i>
      
      <span class="sidebar-button-desc">Newsletter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://masto.measure.chat/@SimoAhava" target="_blank" rel="noopener me">
    
      <i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
      
      <span class="sidebar-button-desc">Mastodon</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
	  <form id="search" action="https://www.simoahava.com/search/">
  <input name="q" type="text" class="form-control input--xlarge" placeholder="Search blog..." autocomplete="off">
  </form>

          <div class="post-header main-content-wrap text-left">
  
    <div class="figure nocaption">
      <img class="cover" src="https://www.simoahava.com/images/2024/10/cookie-access-shopify-sgtm.jpg" width="750" height="422" alt="Cookie Access With Shopify Checkout And SGTM">
    </div>
  
  

    <h1>
      Cookie Access With Shopify Checkout And SGTM
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2024-10-21T12:32:06&#43;03:00">
        
  October 21, 2024

      </time>
      
      
  
  
    <span>in</span>
    
      <a class="category-link" href="https://www.simoahava.com/categories/analytics">Analytics</a>
    
  


      | <a href="https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/#commento">Comments</a>
      
  </div>


</div>

          <div class="post-content markdown">
            <div class="main-content-wrap">
	      
                
  	        <p>In this guide, I&rsquo;ll show you how to add first-party cookie values <strong>client-side</strong>, which your <a href="https://www.simoahava.com/analytics/server-side-tagging-google-tag-manager/">server-side Google Tag Manager</a> processes can then access.</p>
<p>You might be wondering: &ldquo;Why bother?&rdquo;. After all, if server-side GTM is running <em>same-site</em> with the website sending the requests, why can&rsquo;t it just read the cookies on its own, right?</p>
<p>Well, true. But there are cases where the website and web server <em>seem</em> to be same-site but are in fact not. One such case is Shopify&rsquo;s <a href="https://help.shopify.com/en/manual/checkout-settings/customize-checkout-configurations/checkout-extensibility">Checkout Extensibility</a>.</p>
<p>If your Shopify checkout pages are running in this sandbox, then requests sent from the checkout page to a web server will not carry any cookies. Similarly, if you try to set cookies in the server response, it will not work either. Zooming in on the response, you&rsquo;ll see a warning like this:</p>



<div style="aspect-ratio: 1392 / 420;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/shopify-cookies-problem.jpg" title="Shopify cookies problem">
  
    <img class="fig-img" height="420" width="1392" loading="lazy" src="https://www.simoahava.com/images/2024/10/shopify-cookies-problem.jpg#ZgotmplZ" alt="Shopify cookies problem">
  
    </a>
  
  
</div>


<p>The yellow background (in Chrome DevTools) indicates that the cookie was treated as a <strong>third-party cookie</strong>.</p>
<blockquote>
<p>If you check the info on the error, you&rsquo;ll see that it recommends setting the <code>SameSite</code> attribute correctly to allow handling third-party cookies. This is NOT the solution. You do not want to deal with third-party cookies as this is not (technically) a cross-site setup.</p>
</blockquote>
<p>So, if you want server-side Google Tag Manager to read first-party cookies for Google Ads and Meta Conversions API, you&rsquo;re out of luck.</p>
<p>However, there <strong>is</strong> a way to sort this out, and that is to &ldquo;fake&rdquo; cookies by sending the cookie values in the client-side request.</p>
<blockquote>
<p>Caveat: I&rsquo;m not a Shopify user or a Shopify expert. I know there are other approaches, such as using the parent page to handle the tracking or by adding dedicated apps directly to Shopify. The advice in this article pertains to the situation where you want to use server-side Google Tag Manager for your ad tech needs.</p>
</blockquote>

                <span class="simmer">
  <span class="close">X</span>
  <p>
    <span class="fa fa-md fa-bell"></span>
    <strong>The Simmer Newsletter</strong>
  </p>
  <p>
    Subscribe to the <a href="https://www.simoahava.com/newsletter/">Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!
  </p>
  </span>

                
                  <h2 id="how-it-works">How it works</h2>
<p>Since the sandbox restriction only applies to network requests between the site and the web server, you still have access to cookies <strong>set with JavaScript</strong> on the website itself.</p>
<p>The solution is then to grab the cookie values client-side, attach them to the network request as event parameters, and then map or transform them server-side into a format that the vendor tags can read.</p>



<div style="aspect-ratio: 2210 / 68;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/gcl-aw.jpg" title="gcl-aw cookie">
  
    <img class="fig-img" height="68" width="2210" loading="lazy" src="https://www.simoahava.com/images/2024/10/gcl-aw.jpg#ZgotmplZ" alt="gcl-aw cookie">
  
    </a>
  
  
</div>





<div style="aspect-ratio: 1988 / 48;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/_fbc.jpg" title="_fbc cookie">
  
    <img class="fig-img" height="48" width="1988" loading="lazy" src="https://www.simoahava.com/images/2024/10/_fbc.jpg#ZgotmplZ" alt="_fbc cookie">
  
    </a>
  
  
</div>


<p>In the examples of this article, we&rsquo;ll use the <code>_gcl_aw</code> and <code>_fbc</code> cookie values for the Google Ads click identifier and the Facebook click identifier, respectively.</p>
<p>The Google Ads Conversion tag in server-side Google Tag Manager reads the click identifier from either the URL (as the <code>gclid</code> parameter) or from the <code>_gcl_aw</code> cookie. Since we don&rsquo;t have access to cookies in server-side GTM, we&rsquo;ll need to manipulate the page URL to include the <code>gclid</code> by using a <a href="https://www.simoahava.com/analytics/transformations-server-side-google-tag-manager/">Transformation</a>.</p>
<p>The <a href="https://tagmanager.google.com/gallery/#/owners/stape-io/templates/facebook-tag">Facebook Conversions API tag</a> (we&rsquo;re using the Stape template) has multiple ways of sourcing the click identifier. We&rsquo;ll use a simple tag setting to attach it to the conversion events, and we&rsquo;ll also make sure a Transformation removes the parameter from any other tag types.</p>

                
                  <h2 id="what-about-google-analytics-4">What about Google Analytics 4?</h2>
<p>Google Analytics 4 relies on client-side processing for generating the event request. Thus server-side GTM doesn&rsquo;t actually need to access any cookies for GA4 hits to work.</p>
<p>One notable exception is if you&rsquo;ve configured your server-side GA4 <strong>Client</strong> to use the &ldquo;Server Managed&rdquo; identity setting, which enables the <a href="https://www.simoahava.com/analytics/fpid-cookie-google-analytics-server-side-tagging/">FPID cookie for GA4 hits</a>.</p>
<blockquote>
<p>You <strong>must</strong> revert this setting to &ldquo;JavaScript Managed&rdquo; if you want to do <strong>cross-domain tracking</strong> with your Shopify checkout properly. FPID relies on cookies read and written over the network, and due to Shopify&rsquo;s sandbox restrictions, this is not possible on your checkout page.</p>
</blockquote>



<div style="aspect-ratio: 864 / 308;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/server-managed-fpid.jpg" title="server-managed ">
  
    <img class="fig-img" height="308" width="864" loading="lazy" src="https://www.simoahava.com/images/2024/10/server-managed-fpid.jpg#ZgotmplZ" alt="server-managed ">
  
    </a>
  
  
</div>


<p>Make sure you switch this setting if you want cross-domain tracking to work properly.</p>
<p>In the examples of this article, we&rsquo;ll be using Google Analytics 4 as the incoming data stream to server-side Google Tag Manager, where it will then trigger the Google Ads and Facebook CAPI tags, too.</p>

                
                  <h2 id="google-ads-conversion-tracking">Google Ads Conversion tracking</h2>
<p>In this first section, you&rsquo;ll learn how to &ldquo;spoof&rdquo; first-party cookie access in SGTM, where that access is denied due to Shopify sandbox restrictions.</p>
<p>The setup has many moving parts, mainly because the Google Ads Conversion tracking tag is a bit of a black box.</p>
<blockquote>
<p>If you want to follow along, this guide assumes that you <strong>already have a Google Ads Conversion tracking tag running in SGTM</strong>, triggering on a conversion event generated by GA4.</p>
</blockquote>
<h3 id="summary-of-actions">Summary of actions</h3>
<p>Here&rsquo;s what you&rsquo;re going to build.</p>
<p>When the user comes to your web page from an ad click, the URL has the <code>gclid</code> parameter. This parameter contains information about the ad click, and it&rsquo;s a required part for Google Ads conversion tracking to work.</p>
<p>Google Tag writes this value into a first-party cookie, so that it&rsquo;s available on your conversion pages, too.</p>
<p>Because SGTM running with Shopify&rsquo;s sandbox can&rsquo;t access this cookie, you need to manipulate your client-side tags to grab the cookie value and pass it as a custom parameter to server-side GTM.</p>
<p>In SGTM, you then need to construct a &ldquo;fake&rdquo; URL that includes this <code>gclid</code> value, so that the server-side tags &ldquo;believe&rdquo; there was a <code>gclid</code> in the URL.</p>
<p>This way, when your Google Ads Conversion tags fire in server-side GTM, they can utilize this value, even if the page URL didn&rsquo;t have it.</p>
<h3 id="parse-and-transform-the-_gcl_aw-cookie">Parse and transform the _gcl_aw cookie</h3>
<p>In your <strong>web container</strong>, you&rsquo;re going to need to make three changes:</p>
<ol>
<li>Create a 1st Party Cookie variable for <code>_gcl_aw</code>.</li>
<li>Create a Custom JavaScript variable to parse the <code>gclid</code> value from the cookie.</li>
<li>Add the <code>gclid</code> value as an event parameter to the conversion event tag(s).</li>
</ol>
<p>Here&rsquo;s what the 1st Party Cookie variable looks like:</p>



<div style="aspect-ratio: 1020 / 610;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/1pc-gcl-aw.jpg" title="1pc-gcl-aw.jpg">
  
    <img class="fig-img" height="610" width="1020" loading="lazy" src="https://www.simoahava.com/images/2024/10/1pc-gcl-aw.jpg#ZgotmplZ" alt="1pc-gcl-aw.jpg">
  
    </a>
  
  
</div>


<p>The Custom JavaScript variable should have something like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a">function</span>() {
  <span style="color:#00a">if</span> (<span style="color:#099">/[?&amp;]gclid=/</span>.test(<span style="color:#0aa">document</span>.location.href)) <span style="color:#00a">return</span>;
  <span style="color:#00a">var</span> cookie = {{<span style="color:#099">1</span>pc - _gcl_aw}};
  <span style="color:#00a">return</span> cookie &amp;&amp; cookie.split(<span style="color:#a50">&#39;.&#39;</span>).pop();
}
</code></pre></div>
<p>The variable first checks if the page URL has the <code>gclid</code> parameter. If it doesn&rsquo;t, it then checks if the <code>_gcl_aw</code> cookie exists. If the cookie does exist, it grabs the string after the last <code>.</code> symbol, which would be the <code>gclid</code> value.</p>
<p>To wrap up the client-side configuration, the value is added as an event parameter to the GA4 conversion event (which you use to trigger your Google Ads Conversions server-side):</p>



<div style="aspect-ratio: 1684 / 214;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/custom-gclid.jpg" title="Custom GCLID">
  
    <img class="fig-img" height="214" width="1684" loading="lazy" src="https://www.simoahava.com/images/2024/10/custom-gclid.jpg#ZgotmplZ" alt="Custom GCLID">
  
    </a>
  
  
</div>


<p>I&rsquo;m using a custom namespace (<code>custom_</code>) so that it&rsquo;s easier to spot it in the server-side event data and prevent other tags from accessing it.</p>
<h3 id="configure-the-server-side-setup">Configure the server-side setup</h3>
<p>Right now, if the <code>gclid</code> is available in the <code>_gcl_aw</code> cookie, your client-side tag will send it to server-side GTM using the parameter <code>custom_gclid</code>.</p>
<p>Now you need to create a <strong>Transformation</strong> that makes the Google Ads Conversion tag <em>believe</em> the page URL has the <code>gclid</code> parameter, even if it actually didn&rsquo;t have it. Here are the steps to take:</p>
<ol>
<li>Create a new event data variable for <code>custom_gclid</code>.</li>
<li>Create (or use) a new event data variable for <code>page_location</code>.</li>
<li>Use Stape&rsquo;s URL Builder template to construct a URL variable that appends the <code>custom_gclid</code> value to the <code>page_location</code> URL as the <code>&amp;gclid</code> URL parameter.</li>
<li>Create a Transformation that augments <code>page_location</code> with this new URL string.</li>
</ol>
<p>The event data variable for <code>custom_gclid</code> should look like this:</p>



<div style="aspect-ratio: 1082 / 922;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/custom-gclid-sgtm.jpg" title="Custom gclid SGTM">
  
    <img class="fig-img" height="922" width="1082" loading="lazy" src="https://www.simoahava.com/images/2024/10/custom-gclid-sgtm.jpg#ZgotmplZ" alt="Custom gclid SGTM">
  
    </a>
  
  
</div>


<p>The event data variable for <code>page_location</code> should look like this:</p>



<div style="aspect-ratio: 1100 / 922;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/page_location.jpg" title="Page location">
  
    <img class="fig-img" height="922" width="1100" loading="lazy" src="https://www.simoahava.com/images/2024/10/page_location.jpg#ZgotmplZ" alt="Page location">
  
    </a>
  
  
</div>


<p>Next, install the <a href="https://tagmanager.google.com/gallery/#/owners/stape-io/templates/url-builder-variable">URL Builder variable template</a> by Stape. This lets you construct a custom URL string in server-side Google Tag Manager.</p>
<p>Once the template is installed, create a new variable using that template. Configure the variable like this:</p>



<div style="aspect-ratio: 1466 / 1120;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/page-with-gclid.jpg" title="Page with gclid">
  
    <img class="fig-img" height="1120" width="1466" loading="lazy" src="https://www.simoahava.com/images/2024/10/page-with-gclid.jpg#ZgotmplZ" alt="Page with gclid">
  
    </a>
  
  
</div>


<p>Finally, create a new <strong>Augment Event</strong> transformation that looks like this:</p>



<div style="aspect-ratio: 1752 / 1544;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/gclid-transformation.jpg" title="gclid transformation">
  
    <img class="fig-img" height="1544" width="1752" loading="lazy" src="https://www.simoahava.com/images/2024/10/gclid-transformation.jpg#ZgotmplZ" alt="gclid transformation">
  
    </a>
  
  
</div>


<p>Make sure you set <code>page_location</code> to the value of the URL Builder variable that constructed the &ldquo;fake&rdquo; page URL with the <code>gclid</code> value grabbed from the event data.</p>
<p>It&rsquo;s a good precaution to activate this transformation only when <code>custom_gclid</code> actually has a valid value.</p>
<p>It&rsquo;s also sensible to apply this transformation only to your Google Ads Conversion tracking tags.</p>
<h3 id="test-the-setup">Test the setup</h3>
<p>Once you have all these in place, you can test the setup.</p>
<ol>
<li>Browse to your website using a dummy <code>gclid</code> value, such as <code>https://www.simoahava.com/?gclid=just-testing-gclid</code>.</li>
<li>Do whatever it takes to fire the conversion event.</li>
<li>In server-side GTM, inspect the outgoing requests for the conversion event, and find the request generated by the Google Ads Conversion tag.</li>
<li>You should see <code>&amp;gclaw=just-testing-gclid</code> among the parameters of the request.</li>
</ol>



<div style="aspect-ratio: 1796 / 702;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/test-gclaw.jpg" title="Test gclaw">
  
    <img class="fig-img" height="702" width="1796" loading="lazy" src="https://www.simoahava.com/images/2024/10/test-gclaw.jpg#ZgotmplZ" alt="Test gclaw">
  
    </a>
  
  
</div>


<p>Now, repeat the steps above, except <strong>make sure the URL does NOT have <code>gclid</code> this time</strong>.</p>
<p>Again, you should see <code>&amp;gclaw=just-testing-gclid</code>, because the Transformation &ldquo;faked&rdquo; the URL with the parsed cookie value in the client-side request.</p>



<div style="aspect-ratio: 1804 / 468;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/testing-again-gclid.jpg" title="Testing again GCLID">
  
    <img class="fig-img" height="468" width="1804" loading="lazy" src="https://www.simoahava.com/images/2024/10/testing-again-gclid.jpg#ZgotmplZ" alt="Testing again GCLID">
  
    </a>
  
  
</div>


<p>Nice, you&rsquo;ve got your conversion tracking up and running even while using Shopify&rsquo;s sandbox!</p>

                
                  <h2 id="facebook-conversions-api">Facebook Conversions API</h2>
<p>The Facebook setup is much easier, because you don&rsquo;t have to construct any fake URLs and you don&rsquo;t have to parse the <code>_fbc</code> cookie value either.</p>
<p>This is thanks to Stape&rsquo;s <strong>excellent</strong> <a href="https://tagmanager.google.com/gallery/#/owners/stape-io/templates/facebook-tag">Facebook Conversions API</a> template, which I recommend to <strong>anyone</strong> working with Facebook&rsquo;s CAPI in SGTM.</p>
<h3 id="summary-of-actions-1">Summary of actions</h3>
<p>Similar to Google Ads, when someone clicks your ad in Facebook, they land on your site with the <code>fbclid</code> value in the page URL.</p>
<p>This is then written into a first-party cookie by the Facebook pixel.</p>
<blockquote>
<p>This setup assumes that you have Facebook pixel running on the page, too. If you don&rsquo;t, then you need to use a custom client-side solution (such as a Custom HTML tag) to generate the <code>_fbc</code> cookie.</p>
</blockquote>
<p>Because SGTM can&rsquo;t read this cookie, you need to grab the <code>_fbc</code> cookie value and attach it to your GA4 conversion tags as a custom parameter.</p>
<p>In SGTM, you&rsquo;ll then grab this value from the event parameters and attach it to the Facebook Conversions API tag. You can (and should) use a Transformation to remove it from other tag types.</p>
<h3 id="parse-and-send-the-_fbc-cookie-value-as-an-event-parameter">Parse and send the _fbc cookie value as an event parameter</h3>
<p>In your web container, you&rsquo;ll need to do the following:</p>
<ol>
<li>Create a 1st Party Cookie variable for the <code>_fbc</code> cookie.</li>
<li>Add it to your GA4 conversion event tag as an event parameter.</li>
</ol>
<p>Here&rsquo;s what the 1st Party Cookie variable looks like:</p>



<div style="aspect-ratio: 1240 / 892;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/1pc-fbc.jpg" title="1pc _fbc">
  
    <img class="fig-img" height="892" width="1240" loading="lazy" src="https://www.simoahava.com/images/2024/10/1pc-fbc.jpg#ZgotmplZ" alt="1pc _fbc">
  
    </a>
  
  
</div>


<p>All you need to do next is add it as a custom parameter to your GA4 conversion tags (the ones that fire the Facebook Conversions API tag in SGTM):</p>



<div style="aspect-ratio: 1716 / 590;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/custom-fbc-parameter.jpg" title="Custom _fbc parameter">
  
    <img class="fig-img" height="590" width="1716" loading="lazy" src="https://www.simoahava.com/images/2024/10/custom-fbc-parameter.jpg#ZgotmplZ" alt="Custom _fbc parameter">
  
    </a>
  
  
</div>


<h3 id="send-the-value-to-facebook">Send the value to Facebook</h3>
<p>In server-side Google Tag Manager, you&rsquo;ll need to do these things:</p>
<ol>
<li>Create a new event data variable for <code>custom_fbc</code>.</li>
<li>Edit your Facebook Conversions API tags to include this value as the <strong>Click ID</strong>.</li>
<li>Create a new Transformation to exclude this parameter from your other tags.</li>
</ol>
<p>Here&rsquo;s what the event data variable looks like:</p>



<div style="aspect-ratio: 1072 / 762;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/event-data-fbc.jpg" title="Event data _fbc">
  
    <img class="fig-img" height="762" width="1072" loading="lazy" src="https://www.simoahava.com/images/2024/10/event-data-fbc.jpg#ZgotmplZ" alt="Event data _fbc">
  
    </a>
  
  
</div>


<p>Here&rsquo;s how you add it to Stape&rsquo;s Facebook Conversions API tag:</p>



<div style="aspect-ratio: 1768 / 622;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/stape-click-id.jpg" title="Stape Click ID">
  
    <img class="fig-img" height="622" width="1768" loading="lazy" src="https://www.simoahava.com/images/2024/10/stape-click-id.jpg#ZgotmplZ" alt="Stape Click ID">
  
    </a>
  
  
</div>


<p>And finally, here&rsquo;s what an <strong>Exclude Parameters</strong> Transformation looks like, where you remove the parameter from other tag types:</p>



<div style="aspect-ratio: 1520 / 1286;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/exclude-facebook-transformation.jpg" title="Exclude facebook transformation">
  
    <img class="fig-img" height="1286" width="1520" loading="lazy" src="https://www.simoahava.com/images/2024/10/exclude-facebook-transformation.jpg#ZgotmplZ" alt="Exclude facebook transformation">
  
    </a>
  
  
</div>


<p>This makes sure that only the Facebook Conversions API tag type can &ldquo;see&rdquo; the event parameter.</p>
<h3 id="test-the-setup-1">Test the setup</h3>
<p>Now visit your site with a custom <code>fbclid</code> value in the URL, for example <code>https://www.simoahava.com/?fbclid=just-testing-fbclid</code>.</p>
<p>In SGTM, you can then select the conversion event and open the <strong>Console</strong> tab in Preview mode. Stape&rsquo;s template has an extensive log trace, and you should find your custom Click ID in the outgoing request:</p>



<div style="aspect-ratio: 2222 / 370;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/testing-fbclid-workaround.jpg" title="Testing the fbclid in the URL">
  
    <img class="fig-img" height="370" width="2222" loading="lazy" src="https://www.simoahava.com/images/2024/10/testing-fbclid-workaround.jpg#ZgotmplZ" alt="Testing the fbclid in the URL">
  
    </a>
  
  
</div>


<p>Next, visit the URL again **but without <code>fbclid</code> as a parameter.</p>
<p>You should still see <code>fbc</code> in the outgoing Facebook request server-side, with the correct value sourced from the event data object:</p>



<div style="aspect-ratio: 2204 / 372;" class="figure nocaption">
  
    <a href="https://www.simoahava.com/images/2024/10/test-fbc-without-fbclid.jpg" title="Test _fbc without fbclid">
  
    <img class="fig-img" height="372" width="2204" loading="lazy" src="https://www.simoahava.com/images/2024/10/test-fbc-without-fbclid.jpg#ZgotmplZ" alt="Test _fbc without fbclid">
  
    </a>
  
  
</div>



                
                  <h2 id="summary">Summary</h2>
<p>This is a convoluted approach to a sticky problem.</p>
<p>Shopify has improved its security parameters quite a bit with Checkout Extensibility. The sandbox they&rsquo;ve introduced makes it difficult to do any custom setups, and Shopify probably wants to funnel users towards dedicated apps for advertising measurement, for example.</p>
<p>However, as I&rsquo;ve always said, the power of server-side Google Tag Manager is in <strong>control</strong>. By routing your traffic through SGTM, you can assume full control over the data streams that flow through it.</p>
<p>For this reason, I don&rsquo;t consider this article a <em>workaround</em> in the &ldquo;black hat&rdquo; sense. It&rsquo;s more a way to work <em>with</em> Shopify&rsquo;s restrictions without compromising the control that server-side Google Tag Manager grants you.</p>
<p>Mind you, this approach is useful for any scenario where the server is not in a <strong>same-site</strong> context with the website sending requests to it. By accessing cookies client-side and leveraging request parameters, you can &ldquo;fake&rdquo; server-side cookie reads.</p>
<p>The one thing you can&rsquo;t do, though, is <strong>write</strong> cookies in the server response. There&rsquo;s no way to fake that.</p>
<p>Let me know in the comments if this approach raised any questions! I&rsquo;m sure readers would also appreciate other approaches you have in mind for getting server-side GTM to work with Shopify&rsquo;s checkout.</p>

                
              
              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/google-tag-manager/">google tag manager</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/sgtm/">sgtm</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/shopify/">shopify</a>

  <a class="tag tag--primary tag--small" href="https://www.simoahava.com/tags/server-side/">server-side</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtmtips/quickly-duplicate-tags-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Cookie%20Access%20With%20Shopify%20Checkout%20And%20SGTM%20https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


            
              <span id="commento_thread"></span>
<div id="commento"></div>
<script defer src="https://commento.simoahava.com/js/commento.js" data-no-livereload="true"></script>

            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2025 Simo Ahava. All Rights Reserved
  </span>
</footer>

      </div>
      
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/gtmtips/quickly-duplicate-tags-google-tag-manager/">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default" href="https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
              <i class="fa fa-brands fa-facebook"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Cookie%20Access%20With%20Shopify%20Checkout%20And%20SGTM%20https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/%20via%20@SimoAhava">
              <i class="fa fa-brands fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
              <i class="fa fa-brands fa-linkedin"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#commento_thread">
            <i class="fa-regular fa-comments"></i>
          </a>
        </li>
      
      <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#">
          <i class="fa fa-search"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
          <i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Cookie%20Access%20With%20Shopify%20Checkout%20And%20SGTM%20https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/%20via%20@SimoAhava">
          <i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/cookie-access-with-shopify-checkout-sgtm/">
          <i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.simoahava.com/images/simo.png" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Simo Ahava</h4>
    
      <div id="about-card-bio">Husband | Father | Analytics developer<br>simo (at) simoahava.com</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Senior Data Advocate at Reaktor
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Finland
      </div>
    
  </div>
</div>

    
  
    
    <div id="cover" style="background-image:url('https://www.simoahava.com/images/maisema.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>




<script src="https://www.simoahava.com/js/script.js"></script>




<script src="https://commento.simoahava.com/js/count.js"></script>

    <script>
      !function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),o=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");if(e){if(o){e.style.display="none"}t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"})}}();
    </script>
    <style>
      .ads {
	  width: 1px;
      }
      </style>
         

    
  </body>
</html>

