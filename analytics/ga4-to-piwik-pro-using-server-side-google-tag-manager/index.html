<!doctype html><html lang=en-us><head><meta name=google-site-verification content="xQwWI2KUfP9LbFKhw2CVLFtrMY6Czrla7L3PD2aBolA"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"GA4 to Piwik PRO Using Server-side Google Tag Manager | Simo Ahava's blog","image":"https:\/\/www.simoahava.com\/images\/2024\/07\/ga4-client-to-tags.jpg","editor":"Simo Ahava","publisher":{"@type":"Organization","name":"Simo Ahava's blog","logo":{"@type":"ImageObject","url":"https:\/\/www.simoahava.com\/images\/simo.png","height":"393","width":"407"}},"url":"https:\/\/www.simoahava.com\/analytics\/ga4-to-piwik-pro-using-server-side-google-tag-manager\/","datePublished":"2024-07-24T07:01:00\u002b03:00","dateModified":"2024-07-24T07:01:00\u002b03:00","description":"A guide for configuring a GA4 data stream to map to Piwik PRO events using server-side Google Tag Manager.","author":{"@type":"Person","name":"Simo Ahava"}}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>GA4 to Piwik PRO Using Server-side Google Tag Manager | Simo Ahava's blog</title>
<script>window.dataLayer=window.dataLayer||[],window.dataLayer.push({pageType:"article",environment:null})</script><script>(function(e,t,n,s){window[n]=window[n]||[],window[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=e.getElementsByTagName(t)[0],o=e.createElement(t),a=n!="dataLayer"?"&l="+n:"";o.async=!0,o.src="https://sgtm.simoahava.com/gtm.js?id="+s+a,i.parentNode.insertBefore(o,i)})(document,"script","dataLayer","GTM-PZ7GMV9")</script><meta name=author content="Simo Ahava"><meta name=keywords content><link rel=icon href=https://www.simoahava.com/images/favicon.ico><link rel=amphtml href=https://www.simoahava.com/amp/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/><meta name=description content="A guide for configuring a GA4 data stream to map to Piwik PRO events using server-side Google Tag Manager."><meta property="og:description" content="A guide for configuring a GA4 data stream to map to Piwik PRO events using server-side Google Tag Manager."><meta property="og:type" content="blog"><meta property="og:title" content="GA4 to Piwik PRO Using Server-side Google Tag Manager"><meta property="og:url" content="https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><meta property="og:site_name" content="Simo Ahava's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="GA4 to Piwik PRO Using Server-side Google Tag Manager"><meta name=twitter:description content="A guide for configuring a GA4 data stream to map to Piwik PRO events using server-side Google Tag Manager."><meta name=twitter:creator content="@SimoAhava"><meta property="og:image" content="https://www.simoahava.com/images/2024/07/ga4-to-piwik-pro-using-server-side-google-tag-manager.jpg"><meta name=twitter:image content="https://www.simoahava.com/images/2024/07/ga4-to-piwik-pro-using-server-side-google-tag-manager.jpg"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/style.css></head><body><div id=_progress></div><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/>Simo Ahava's blog</a></div></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/><img class=sidebar-profile-picture loading=lazy src=https://www.simoahava.com/images/simo.png alt="Author's picture"></a><h4 class=sidebar-profile-name>Simo Ahava</h4><h5 class=sidebar-profile-bio>Husband | Father | Analytics developer<br>simo (at) simoahava.com</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/><i class="sidebar-button-icon fa fa-lg fa-home"></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/categories/><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
<span class=sidebar-button-desc>Categories</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags/><i class="sidebar-button-icon fa fa-lg fa-tags"></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/categories/gtm-tips/><i class="sidebar-button-icon fa fa-lg fa-magic"></i>
<span class=sidebar-button-desc>GTM Tips</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/about-simo-ahava/><i class="sidebar-button-icon fa fa-lg fa-question"></i>
<span class=sidebar-button-desc>About</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/index.xml><i class="sidebar-button-icon fa fa-lg fa-rss"></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/tools/><i class="sidebar-button-icon fa fa-lg fa-wrench"></i>
<span class=sidebar-button-desc>Tools</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/blog-statistics/><i class="sidebar-button-icon fa fa-lg fa-bar-chart"></i>
<span class=sidebar-button-desc>Blog statistics</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/sahava target=_blank rel=noopener><i class="sidebar-button-icon fa fa-lg fa-brands fa-github"></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/upcoming-talks/><i class="sidebar-button-icon fa fa-lg fa-bullhorn"></i>
<span class=sidebar-button-desc>Upcoming talks</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/custom-templates/><i class="sidebar-button-icon fa fa-lg fa-tags"></i>
<span class=sidebar-button-desc>Templates</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/newsletter/><i class="sidebar-button-icon fa fa-lg fa-bell"></i>
<span class=sidebar-button-desc>Newsletter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://masto.measure.chat/@SimoAhava target=_blank rel="noopener me"><i class="sidebar-button-icon fa fa-lg fa-brands fa-mastodon"></i>
<span class=sidebar-button-desc>Mastodon</span></a></li></ul><ul class=sidebar-buttons></ul></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post><form id=search action=/search/><input name=q type=text class="form-control input--xlarge" placeholder="Search blog..." autocomplete=off></form><div class="post-header main-content-wrap text-left"><div class="figure nocaption"><img class=cover src=/images/2024/07/ga4-to-piwik-pro-using-server-side-google-tag-manager.jpg width=750 height=422 alt="GA4 to Piwik PRO Using Server-side Google Tag Manager"></div><h1>GA4 to Piwik PRO Using Server-side Google Tag Manager</h1><div class="postShorten-meta post-meta"><time datetime=2024-07-24T07:01:00+03:00>July 24, 2024
</time><span>in</span>
<a class=category-link href=/categories/analytics>Analytics</a>
| <a href=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/#commento><comentario-count path=/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/ placeholder=... error-text="N/A " zero-text="0 " prefix suffix=" "></comentario-count>Comments</a></div></div><div class="post-content markdown"><div class=main-content-wrap><p>There are <strong>two</strong> new <a href=/analytics/custom-templates-guide-for-google-tag-manager/>custom templates</a> available in <strong>server-side Google Tag Manager</strong>. These templates have been designed to facilitate <a href=https://piwik.pro/>Piwik PRO</a> tracking in a server-side container.</p><ol><li><strong>Piwik PRO Client</strong> -> This <em>Client</em> template interacts with the <a href=https://developers.piwik.pro/en/latest/data_collection/web/javascript_tracking_client/index.html>Piwik PRO JavaScript tracker</a> and lets you route Piwik PRO tracking through a server-side GTM container. <a href=https://github.com/PiwikPRO/server-side-template-for-gtm-v2-client>GitHub repo</a>.</li><li><strong>Piwik PRO</strong> -> The <em>tag</em> template works in unison with the Piwik PRO Client, forwarding the hits to the Piwik PRO endpoint. <a href=https://github.com/PiwikPRO/server-side-template-for-gtm-v2>GitHub repo</a>.</li></ol><p><a href=/analytics/new-piwik-pro-templates-server-side-google-tag-manager/><em>Read this article to learn more about how these templates work.</em></a></p><p>However, both templates have been built with a universal application in mind. The <strong>Client</strong> template produces event data that can be consumed by other vendors&rsquo; tags, too. Similarly, the <strong>tag</strong> template has been designed so that it can work with other Clients.</p><p>In this article, I&rsquo;ll show you how to <em>quite</em> easily take an incoming <strong>Google Analytics 4</strong> stream in server-side Google Tag Manager (claimed by the built-in GA4 Client) and map that to a format that can be utilized by the Piwik PRO tag.</p><div style=aspect-ratio:1920/1080 class="figure nocaption"><a href=/images/2024/07/ga4-client-to-tags.jpg title="First approach, GA4 client to tags"><img class=fig-img height=1080 width=1920 loading=lazy src=/images/2024/07/ga4-client-to-tags.jpg#ZgotmplZ alt="First approach, GA4 client to tags"></a></div><p>As the lousy illustration above shows, we&rsquo;ll use the <strong>GA4 Client</strong> to handle the incoming stream, but we&rsquo;ll then create a <strong>Piwik PRO tag</strong> to take the data generated by the GA4 Client and forward it to Piwik PRO servers (in the correct format, of course).</p><div id=toc-container><h1 id=table-of-contents>Table of Contents</h1><input type=checkbox id=show><label for=show id=showbtn><h1 id=table-of-contents-mobile>Table of Contents</h1><span class=show>&nbsp;[+show]</span><span class=hide>&nbsp;[–hide]</span></label><nav id=TableOfContents><ul><li><a href=#getting-started>Getting started</a></li><li><a href=#how-the-tag-template-works>How the tag template works</a><ul><li><a href=#ga4-event-data-mapped-to-piwik-pro-parameters>GA4 Event Data mapped to Piwik PRO parameters</a></li><li><a href=#the-rec-parameter>The &ldquo;rec&rdquo; parameter</a></li><li><a href=#the-_id-parameter>The &ldquo;_id&rdquo; parameter</a></li></ul></li><li><a href=#the-page_view-event>The page_view event</a><ul><li><a href=#preview-and-test>Preview and test</a></li></ul></li><li><a href=#the-product-detail-view-event>The product-detail-view event</a><ul><li><a href=#the-event-type-parameter>The Event Type parameter</a></li><li><a href=#preview-and-test-1>Preview and test</a></li></ul></li><li><a href=#the-add-to-cart-event>The add-to-cart event</a><ul><li><a href=#preview-and-test-2>Preview and test</a></li></ul></li><li><a href=#the-order-event>The order event</a><ul><li><a href=#preview-and-test-3>Preview and test</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div><span class=simmer><span class=close>X</span><p><span class="fa fa-md fa-bell"></span>
<strong>The Simmer Newsletter</strong></p><p>Subscribe to the <a href=/newsletter/>Simmer newsletter</a> to get the latest news and content from Simo Ahava into your email inbox!</p></span><h2 id=getting-started>Getting started</h2><p>To start with, we already have an established data stream for proxying Google Analytics 4 hits through a server-side Google Tag Manager container.</p><div style=aspect-ratio:1654/1376 class="figure nocaption"><a href=/images/2024/07/sgtm-setup.jpg title="SGTM starting point"><img class=fig-img height=1376 width=1654 loading=lazy src=/images/2024/07/sgtm-setup.jpg#ZgotmplZ alt="SGTM starting point"></a></div><p>The property collects a variety of Google Analytics 4 data, but we&rsquo;re going to focus on the following four events in our mapping to Piwik PRO:</p><ol><li>The <code>page_view</code> event is sent whenever a page is loaded in the browser.</li><li>The <code>view_item</code> event is sent whenever a product is viewed.</li><li>The <code>add_to_cart</code> event is sent whenever a product is added to the cart.</li><li>The <code>purchase</code> event is sent whenever a purchase is completed.</li></ol><p>This is a very typical <em>business-critical</em> event list. To keep things concise in this article, we&rsquo;ll focus on just these four and ignore the rest when building the mapping to Piwik PRO.</p><h2 id=how-the-tag-template-works>How the tag template works</h2><p>First of all, remember to <a href=/analytics/new-piwik-pro-templates-server-side-google-tag-manager/>read this article</a> for a more in-depth exploration of the new Piwik PRO templates.</p><p>To get started with the tag template, you need to fill in the <strong>Account Name</strong> and the <strong>Site or App ID</strong> fields. The values for these fields can be found in your Piwik PRO settings.</p><div style=aspect-ratio:1348/734 class="figure nocaption"><a href=/images/2024/07/instance-and-id.jpg title="Account naem and site or app id"><img class=fig-img height=734 width=1348 loading=lazy src=/images/2024/07/instance-and-id.jpg#ZgotmplZ alt="Account naem and site or app id"></a></div><p>If you then scroll down the tag template, you&rsquo;ll find that almost all the fields have a default value of <strong>Inherit from Client</strong>.</p><p>This means that the field automatically grabs the value from what the server-side Client produced <em>as long as it&rsquo;s in the correct format</em>.</p><p>The Piwik PRO Client has of course been built so that it generates the values correctly for the tag, but the <strong>GA4 Client</strong> understandably doesn&rsquo;t consider Piwik Pro&rsquo;s idiosyncracies in its output.</p><h3 id=ga4-event-data-mapped-to-piwik-pro-parameters>GA4 Event Data mapped to Piwik PRO parameters</h3><p>Here is the list of fields that the Piwik PRO tag template can read <strong>automatically</strong> from the GA4 Client:</p><table><thead><tr><th>GA4 Event Data key</th><th>Maps to Piwik PRO parameter</th><th>Field name in the tag UI</th><th>Description</th></tr></thead><tbody><tr><td><code>page_location</code></td><td><code>url</code></td><td>Event URL</td><td>The URL of the page where the event happened.</td></tr><tr><td><code>page_referrer</code></td><td><code>urlref</code></td><td>Referrer URL</td><td>The referrer of the page where the event happened.</td></tr><tr><td><code>user_id</code></td><td><code>uid</code></td><td>User ID</td><td>User ID for logged-in users.</td></tr><tr><td><code>ip_override</code></td><td><code>cip</code></td><td>Override User IP</td><td>IP address of the visitor.</td></tr><tr><td><code>value</code></td><td><code>revenue</code></td><td>Revenue</td><td>Value of the event (for e-commerce).</td></tr><tr><td><code>user_agent</code></td><td><code>ua</code></td><td>-</td><td>User-Agent string of the user&rsquo;s browser.</td></tr><tr><td><code>language</code></td><td><code>lang</code></td><td>-</td><td>Browser language.</td></tr><tr><td><code>screen_resolution</code></td><td><code>res</code></td><td>-</td><td>Screen resolution of the visitor&rsquo;s browser.</td></tr><tr><td><code>client_id</code></td><td><code>_id</code></td><td>Visitor ID</td><td>The tag automatically converts the GA4 Client ID to the correct Piwik PRO format (16-character hexadecimal hash).</td></tr><tr><td><code>page_title</code></td><td><code>action_name</code></td><td>Event (Action) Name</td><td>With page view hits, the <code>page_title</code> is automatically used as <code>action_name</code>.</td></tr><tr><td><code>transaction_id</code></td><td><code>ec_id</code></td><td>Order ID</td><td>The ID of the transaction.</td></tr><tr><td><code>items</code></td><td><code>ec_products</code></td><td>Products</td><td>The GA4 <code>items</code> array is automatically converted to the correct <code>ec_products</code> format.</td></tr></tbody></table><p>These keys are accounted for by the GA4 Client and the Piwik PRO tag template, so you can leave them with the <strong>Inherit from Client</strong> option enabled.</p><p>The rest of the parameters that you need to map or generate depend on the event you are collecting. The full inventory of parameters supported by the Piwik PRO servers can be found in their <a href=https://developers.piwik.pro/en/latest/data_collection/api/http_api.html>HTTP API documentation</a>.</p><p>You can add the missing parameters by editing the Piwik PRO tag fields or by using a <a href=/analytics/transformations-server-side-google-tag-manager/>Transformation in SGTM</a>.</p><h3 id=the-rec-parameter>The &ldquo;rec&rdquo; parameter</h3><p>The tag template sets the <code>rec</code> parameter to <code>1</code> by default. This means that the request is recorded in your Piwik PRO instance.</p><p>If, for some reason, you <em>don&rsquo;t</em> want the hit to be registered in Piwik PRO, you can set <code>rec</code> to <code>0</code> using the <strong>Additional Parameters</strong> field in the tag UI. Any parameters you enter here will override any previous values registered by the tag.</p><div style=aspect-ratio:1750/328 class="figure nocaption"><a href=/images/2024/07/additional-parameter.jpg title="Additional parameter"><img class=fig-img height=328 width=1750 loading=lazy src=/images/2024/07/additional-parameter.jpg#ZgotmplZ alt="Additional parameter"></a></div><h3 id=the-_id-parameter>The &ldquo;_id&rdquo; parameter</h3><p>Piwik PRO uses a <strong>16-character-long hexadecimal hash</strong> as the value of the Visitor ID. This is collected with the parameter <code>_id</code>.</p><p>The tag template automatically uses the <code>client_id</code> value stored in the Event Data object when creating the <code>_id</code> value.</p><p>To collect the ID in the correct format, the Client ID is first hashed with the SHA256 algorithm and then the first 16 characters are used for the Visitor ID.</p><div style=aspect-ratio:1218/518 class="figure nocaption"><a href=/images/2024/07/ga4-client-id-hash.jpg title="GA4 Client ID hash"><img class=fig-img height=518 width=1218 loading=lazy src=/images/2024/07/ga4-client-id-hash.jpg#ZgotmplZ alt="GA4 Client ID hash"></a></div><p>Of course, you can use your own value for the Visitor ID, but remember that it <strong>must</strong> be in the correct format for Piwik PRO to accept it.</p><h2 id=the-page_view-event>The page_view event</h2><p>We&rsquo;ll build the mapping event by event, starting with <code>page_view</code>.</p><p>Create a new Piwik PRO tag in server-side Google Tag Manager, and set the <strong>Account Name</strong> and <strong>Site or App ID</strong> fields.</p><div style=aspect-ratio:824/330 class="figure nocaption"><a href=/images/2024/07/instance-and-id-real-case.jpg title="Account name and ID"><img class=fig-img height=330 width=824 loading=lazy src=/images/2024/07/instance-and-id-real-case.jpg#ZgotmplZ alt="Account name and ID"></a></div><p>Next, under <strong>Event Configuration</strong>, choose <strong>Page / App View</strong> as the Event Type.</p><blockquote><p>This is an optional step, because the tag template sees the <code>page_view</code> event and deduces the event type from that. But sometimes the event name doesn&rsquo;t match the event type, so it&rsquo;s good to be explicit.</p></blockquote><div style=aspect-ratio:1018/714 class="figure nocaption"><a href=/images/2024/07/page-app-view.jpg title="Page / App View"><img class=fig-img height=714 width=1018 loading=lazy src=/images/2024/07/page-app-view.jpg#ZgotmplZ alt="Page / App View"></a></div><p>Finally, add a trigger to the tag. Focus on the <code>page_view</code> event, and for good measure only fire the tag if the <strong>Client Name</strong> built-in variable is <code>GA4</code>.</p><div style=aspect-ratio:1848/488 class="figure nocaption"><a href=/images/2024/07/page-view-trigger.jpg title="Page view trigger"><img class=fig-img height=488 width=1848 loading=lazy src=/images/2024/07/page-view-trigger.jpg#ZgotmplZ alt="Page view trigger"></a></div><p>Finally, save the tag and go to Preview mode in server-side Google Tag Manager.</p><h3 id=preview-and-test>Preview and test</h3><p>The first thing we&rsquo;ll do is send a <code>page_view</code> event to server-side Google Tag Manager, select it, and open the Console tab.</p><div style=aspect-ratio:2402/752 class="figure nocaption"><a href=/images/2024/07/compiled-body.jpg title="Compiled request body"><img class=fig-img height=752 width=2402 loading=lazy src=/images/2024/07/compiled-body.jpg#ZgotmplZ alt="Compiled request body"></a></div><p>The Piwik PRO tag outputs this information into the console.</p><p>In the <strong>Compiled request body</strong>, you should see the <code>action_name</code> with the page title. This is important, because this distinguishes the hit as a <strong>page view</strong> request.</p><p>Check also that you see the <code>_id</code> parameter in the request. Copy the value of <code>_id</code> to the clipboard.</p><p>Next, open the <a href=https://help.piwik.pro/support/collecting-data/tracker-debugger/>Tracker Debugger</a> in Piwik PRO. Filter the results for the Visitor ID you copied to the clipboard. This is what you should see:</p><div style=aspect-ratio:1232/234 class="figure nocaption"><a href=/images/2024/07/tracker-debugger-pageview.jpg title="Tracker debugger and page view"><img class=fig-img height=234 width=1232 loading=lazy src=/images/2024/07/tracker-debugger-pageview.jpg#ZgotmplZ alt="Tracker debugger and page view"></a></div><p>Everything just &mldr; works! Your Page View hit has all the necessary data included.</p><p>You can click the little <code>&lt;/></code> button next to the <strong>Page view</strong> event name to view more details about what was collected. The raw data should match what you saw in the Console tab of server-side Google Tag Manager.</p><p>And <strong>that&rsquo;s it</strong> for the page view event! It works! Here&rsquo;s a recap of what was done:</p><ol><li>Create a new Piwik PRO tag.</li><li>Fill in the <em>Account Name</em> and <em>Site or App ID</em> fields correctly.</li><li>Trigger the tag on the <code>page_view</code> event collected by the GA4 client.</li></ol><p>Next, let&rsquo;s do the same for the three e-commerce events.</p><h2 id=the-product-detail-view-event>The product-detail-view event</h2><p>The GA4 analogy to Piwik PRO&rsquo;s <code>product-detail-view</code> is the <code>view_item</code> event.</p><p>Let&rsquo;s follow the same process as above to map this event correctly.</p><p>First, we&rsquo;ll create a new Piwik PRO tag with the <strong>Account Name</strong> and <strong>Site or App ID</strong> populated.</p><p>Now, let&rsquo;s choose <strong>Ecommerce</strong> as the Event Type.</p><div style=aspect-ratio:964/560 class="figure nocaption"><a href=/images/2024/07/event-type-ecommerce.jpg title="Ecommerce event type"><img class=fig-img height=560 width=964 loading=lazy src=/images/2024/07/event-type-ecommerce.jpg#ZgotmplZ alt="Ecommerce event type"></a></div><p>When you choose this, a new section titled <strong>Ecommerce</strong> appears.</p><p>Here, the key field is <strong>Ecommerce Event Type</strong>. We&rsquo;ll keep that as <strong>Inherit from Client</strong>, but it won&rsquo;t work properly until we add the relevant field into the Event Data object using a Transformation. We&rsquo;ll get to this in a bit.</p><p>Create a <strong>Custom Event</strong> trigger with <code>^(view_item)$</code> as the value of the <strong>Event name</strong> field, and check <strong>Use regex matching</strong>. Add a condition to check for the GA4 Client, same as you did with the Page View tag.</p><p>Once ready, save the trigger and add it to the tag.</p><div style=aspect-ratio:1764/874 class="figure nocaption"><a href=/images/2024/07/ecommerce-trigger.jpg title="Ecommerce trigger"><img class=fig-img height=874 width=1764 loading=lazy src=/images/2024/07/ecommerce-trigger.jpg#ZgotmplZ alt="Ecommerce trigger"></a></div><p>We&rsquo;re using a regex match for the event name, because we&rsquo;ll expand this trigger soon with other Ecommerce events.</p><p>Finally, save the tag.</p><h3 id=the-event-type-parameter>The Event Type parameter</h3><p>The Event Type parameter in the Piwik PRO request is <code>e_t</code>, and so the name of the field we need to add with a Transformation is <code>x-pp-e_t</code> (remember that <code>x-pp-</code> is the prefix for all Piwik PRO-specific parameters).</p><p>Piwik PRO accepts one of these as the value: <code>order</code>, <code>product-detail-view</code>, <code>add-to-cart</code>, <code>cart-update</code>, <code>remove-from-cart</code>. In this article, we&rsquo;ll focus just on the first three.</p><p>To make things easier to manage, start by creating a new <strong>Lookup Table</strong> variable, where the Input variable is the built-in <code>{{Event Name}}</code> variable. Add just one row, which maps <code>view_item</code> in the input (the value of <code>{{Event Name}}</code>) to <code>product-detail-view</code> in the output:</p><div style=aspect-ratio:2334/826 class="figure nocaption"><a href=/images/2024/07/event-name-transformation-ecommerce.jpg title="Event name transformation for ecommerce"><img class=fig-img height=826 width=2334 loading=lazy src=/images/2024/07/event-name-transformation-ecommerce.jpg#ZgotmplZ alt="Event name transformation for ecommerce"></a></div><p>Next, create a new <strong>Augment Event Transformation</strong> for Piwik PRO.</p><p>Go to <strong>Transformations</strong> in the container UI, and click to create a new Augment Event Transformation.</p><p>Here, add a new row with <code>x-pp-e_t</code> as the Name. Set the Lookup Table variable you just created as the Value.</p><div style=aspect-ratio:2130/1512 class="figure nocaption"><a href=/images/2024/07/ecommerce-transformation.jpg title="Ecommerce transformation"><img class=fig-img height=1512 width=2130 loading=lazy src=/images/2024/07/ecommerce-transformation.jpg#ZgotmplZ alt="Ecommerce transformation"></a></div><p>This Transformation populates the <code>x-pp-e_t</code> field with the correct Ecommerce event name <em>if</em> the event name is mapped in the Lookup Table.</p><h3 id=preview-and-test-1>Preview and test</h3><p>Once you&rsquo;ve created the tag and the trigger and you&rsquo;ve updated the Transformation, you can go into Preview mode and do whatever it takes to fire a standard <code>view_item</code> event to your GA4 Client.</p><p>The Piwik PRO tag should fire with the <code>view_item</code> event, and you should see something like this in the Console tab with the event selected:</p><div style=aspect-ratio:2404/398 class="figure nocaption"><a href=/images/2024/07/product-detail-view-almost.jpg title=product-detail-view><img class=fig-img height=398 width=2404 loading=lazy src=/images/2024/07/product-detail-view-almost.jpg#ZgotmplZ alt=product-detail-view></a></div><p>When you open <strong>Tracker Debugger</strong> in Piwik PRO, you should see this:</p><div style=aspect-ratio:1214/724 class="figure nocaption"><a href=/images/2024/07/product-detail-view-debugger.jpg title="product detail view"><img class=fig-img height=724 width=1214 loading=lazy src=/images/2024/07/product-detail-view-debugger.jpg#ZgotmplZ alt="product detail view"></a></div><p>The tag template <em>automatically</em> mapped the <code>items</code> array that the GA4 Client produced into the correct format digested by the Piwik PRO tag (<code>ec_products</code>).</p><p>Nice, <code>product-detail-view</code> works now, too. Here&rsquo;s what we did:</p><ol><li>Create a new Lookup Table that maps GA4 event names to their Piwik PRO counterparts.</li><li>Create a new the Augment Event Transformation with Event Type (<code>x-pp-e_t</code>), derived from the built-in <code>{{Event Name}}</code> variable using the Lookup Table.</li><li>Add a trigger to the tag that only fires it when an Ecommerce event occurs (<code>view_item</code> in this case).</li></ol><p>This is getting easier by the event!</p><p>Next, <code>add-to-cart</code>.</p><h2 id=the-add-to-cart-event>The add-to-cart event</h2><p>Because we&rsquo;ve laid all the groundwork, getting the <code>add-to-cart</code> event working is as easy as editing the Lookup Table variable for the <code>x-pp-e_t</code> Transformation and modifying the trigger to also fire on the <code>add_to_cart</code> event.</p><p>Here&rsquo;s what the modified Lookup Table variable looks like:</p><div style=aspect-ratio:1784/690 class="figure nocaption"><a href=/images/2024/07/add-to-cart-lookup.jpg title="add-to-cart lookup"><img class=fig-img height=690 width=1784 loading=lazy src=/images/2024/07/add-to-cart-lookup.jpg#ZgotmplZ alt="add-to-cart lookup"></a></div><blockquote><p>Please note that the <strong>Input</strong> has <code>add_to_cart</code> with underscores (this is the event name as GA4 uses it) and the <strong>Output</strong> has <code>add-to-cart</code> with hyphens (this is the Event Type for Piwik PRO).</p></blockquote><p>Here&rsquo;s what the updated trigger should be – as you can see, the regular expression is now <code>^(view_item|add_to_cart)$</code>.</p><div style=aspect-ratio:1852/938 class="figure nocaption"><a href=/images/2024/07/add-to-cart-trigger.jpg title="Add to cart trigger"><img class=fig-img height=938 width=1852 loading=lazy src=/images/2024/07/add-to-cart-trigger.jpg#ZgotmplZ alt="Add to cart trigger"></a></div><blockquote><p>Again, make sure the trigger looks for the GA4 <code>add_to_cart</code> event name and not the Piwik PRO <code>add-to-cart</code>.</p></blockquote><p>Save everything.</p><h3 id=preview-and-test-2>Preview and test</h3><p>This should be easy – go to Preview mode, send a GA4 <code>add_to_cart</code> event to your Server container, and check the Console tab with the <code>add_to_cart</code> event selected:</p><div style=aspect-ratio:2380/726 class="figure nocaption"><a href=/images/2024/07/add-to-cart-console-tab.jpg title="Add to cart in the console tab"><img class=fig-img height=726 width=2380 loading=lazy src=/images/2024/07/add-to-cart-console-tab.jpg#ZgotmplZ alt="Add to cart in the console tab"></a></div><p>Wow, that looks good right away! The Tracker Debugger confirms our success:</p><div style=aspect-ratio:1250/690 class="figure nocaption"><a href=/images/2024/07/tracker-debugger-add-to-cart.jpg title="Tracker Debugger and add-to-cart"><img class=fig-img height=690 width=1250 loading=lazy src=/images/2024/07/tracker-debugger-add-to-cart.jpg#ZgotmplZ alt="Tracker Debugger and add-to-cart"></a></div><p>Excellent, it&rsquo;s all good!</p><p>Here&rsquo;s what we did this time:</p><ol><li>Modify the Lookup Table to process the mapping of <code>add_to_cart</code> (GA4) to <code>add-to-cart</code> (Piwik PRO).</li><li>Update the trigger to also fire with the <code>add_to_cart</code> event.</li></ol><p>The final event we&rsquo;ll cover in this article is <code>order</code>.</p><h2 id=the-order-event>The order event</h2><p>The <code>order</code> event in Piwik PRO maps to the <code>purchase</code> event of GA4.</p><p>Let&rsquo;s see if everything is as easy as in the previous section with <code>add-to-cart</code>.</p><p>First, update the Lookup Table to account for the <code>purchase</code> > <code>order</code> mapping.</p><div style=aspect-ratio:1768/778 class="figure nocaption"><a href=/images/2024/07/purchase-order-lookup.jpg title="Purchase order lookup"><img class=fig-img height=778 width=1768 loading=lazy src=/images/2024/07/purchase-order-lookup.jpg#ZgotmplZ alt="Purchase order lookup"></a></div><p>Then, update the trigger to listen for the <code>purchase</code> event, too, by changing the regular expression to <code>^(view_item|add_to_cart|purchase)$</code>.</p><div style=aspect-ratio:1766/878 class="figure nocaption"><a href=/images/2024/07/purchase-trigger.jpg title="Purchase trigger"><img class=fig-img height=878 width=1766 loading=lazy src=/images/2024/07/purchase-trigger.jpg#ZgotmplZ alt="Purchase trigger"></a></div><p>Finally, save everything.</p><h3 id=preview-and-test-3>Preview and test</h3><p>Refresh Preview mode, and do something to generate a <code>purchase</code> event to your SGTM endpoint. This is what the Console tab should include:</p><div style=aspect-ratio:2404/422 class="figure nocaption"><a href=/images/2024/07/purchase-console.jpg title="purchase event in console"><img class=fig-img height=422 width=2404 loading=lazy src=/images/2024/07/purchase-console.jpg#ZgotmplZ alt="purchase event in console"></a></div><p>OK, ok! It looks good. The Event Type (<code>order</code>) is there, we&rsquo;ve got <code>revenue</code> (mapped from GA4&rsquo;s <code>value</code> automatically), <code>ec_id</code> is there with the Order ID, and <code>ec_products</code> is populated as well. What about the <strong>Tracker Debugger</strong>?</p><div style=aspect-ratio:1258/978 class="figure nocaption"><a href=/images/2024/07/order-tracker-debugger.jpg title="Order in tracker debugger"><img class=fig-img height=978 width=1258 loading=lazy src=/images/2024/07/order-tracker-debugger.jpg#ZgotmplZ alt="Order in tracker debugger"></a></div><p>It&rsquo;s good!</p><p>Thanks to the automatic mapping of <code>transaction_id</code> to <code>ec_id</code> and <code>value</code> to <code>revenue</code>, we didn&rsquo;t have to make any changes to the tag.</p><h2 id=summary>Summary</h2><p>In this article, we started with a GA4 data stream collecting the following events:</p><ul><li><code>page_view</code></li><li><code>view_item</code></li><li><code>add_to_cart</code></li><li><code>purchase</code></li></ul><p>To make things easier, we created a Transformation that generates some critical Piwik PRO-specific keys into the Event Data object:</p><div style=aspect-ratio:1846/1262 class="figure nocaption"><a href=/images/2024/07/ecommerce-transformation.jpg title="Transformation for Piwik PRO"><img class=fig-img height=1262 width=1846 loading=lazy src=/images/2024/07/ecommerce-transformation.jpg#ZgotmplZ alt="Transformation for Piwik PRO"></a></div><p>We didn&rsquo;t have to make any tag-specific changes. The template handles the most critical mappings automatically.</p><p>We <em>did</em> create a separate tag for ecommerce. I&rsquo;m a huge fan of separating concerns, and this gives us room to maneuver in case we want to make ecommerce-specific adjustments to the data flow (which is very often the case!).</p><p>This is by no means an exhaustive setup. Remember that Piwik PRO and GA4 have vastly different data models. You can check the Piwik PRO <a href=https://developers.piwik.pro/en/latest/data_collection/api/http_api.html>HTTP API documentation</a> to see the wide variety of signals that Piwik PRO can consume.</p><p>Ideas for further development could include:</p><ul><li>Parse the GA4 session cookie for the session counter and map that to the <code>_idvc</code> (Visit Counter) parameter in the tag.</li><li>Parse the GA4 Client ID cookie for the first visit timestamp and map that to the <code>_idts</code> (Time of First Visit) parameter in the tag.</li><li>Add page timing metrics to the <strong>Page View</strong> tag.</li><li>Create Goal Conversion events from the ecommerce hits.</li><li>Map the Piwik PRO <code>ping</code> event to GA4&rsquo;s <code>user_engagement</code> hits.</li></ul><p>I hope this guide was useful! Let me know in the comments if you have questions about mapping GA4 requests to Piwik PRO events using server-side Google Tag Manager.</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/google-tag-manager/>google tag manager</a>
<a class="tag tag--primary tag--small" href=/tags/piwik-pro/>piwik pro</a>
<a class="tag tag--primary tag--small" href=/tags/server-side/>server-side</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/cookie-access-with-shopify-checkout-sgtm/><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/new-piwik-pro-templates-server-side-google-tag-manager/><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-facebook"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=GA4%20to%20Piwik%20PRO%20Using%20Server-side%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-linkedin"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#commento><i class="fa-regular fa-comments"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-search"></i></a></li></ul></div><a name=commento></a><comentario-comments></comentario-comments></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2026 Simo Ahava. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/cookie-access-with-shopify-checkout-sgtm/><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=/analytics/new-piwik-pro-templates-server-side-google-tag-manager/><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-facebook"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=GA4%20to%20Piwik%20PRO%20Using%20Server-side%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-linkedin"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#commento><i class="fa-regular fa-comments"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-search"></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-close"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-facebook"></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=GA4%20to%20Piwik%20PRO%20Using%20Server-side%20Google%20Tag%20Manager%20https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/%20via%20@SimoAhava"><i class="fa fa-brands fa-twitter"></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/cws/share?url=https://www.simoahava.com/analytics/ga4-to-piwik-pro-using-server-side-google-tag-manager/"><i class="fa fa-brands fa-linkedin"></i><span>Share on LinkedIn</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-remove"></i></div><img id=about-card-picture src=https://www.simoahava.com/images/simo.png alt="Author's picture"><h4 id=about-card-name>Simo Ahava</h4><div id=about-card-bio>Husband | Father | Analytics developer<br>simo (at) simoahava.com</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Senior Data Advocate at Reaktor</div><div id=about-card-location><i class="fa fa-map-marker"></i><br>Finland</div></div></div><div id=cover style=background-image:url(https://www.simoahava.com/images/maisema.jpg)></div><script defer src=https://comentario.simoahava.com/comentario.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script defer src=/js/script.js></script><script>!function(){var e=document.querySelector(".simmer"),t=document.querySelector(".simmer .close"),n=window.sessionStorage&&window.sessionStorage.getItem("nosimmer");e&&(n&&(e.style.display="none"),t&&t.addEventListener("click",function(){window.sessionStorage.setItem("nosimmer","true"),e.style.display="none"}))}()</script></body></html>